<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Designer & Quote Tool | Surprise Granite</title>
  <link rel="icon" href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Fabric.js for canvas manipulation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <style>
    :root {
      --gold: #f9cb00;
      --gold-dark: #d4ab00;
      --dark: #1a1a2e;
      --dark-surface: #252538;
      --dark-elevated: #2d2d44;
      --text: #ffffff;
      --text-muted: rgba(255,255,255,0.6);
      --border: rgba(255,255,255,0.1);
      --success: #22c55e;
      --error: #ef4444;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .header {
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      height: 60px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: var(--text);
    }

    .logo img {
      height: 32px;
    }

    .logo-text {
      font-weight: 700;
      font-size: 14px;
      color: var(--gold);
    }

    .project-name {
      padding: 6px 12px;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
      min-width: 200px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
    }

    .btn-secondary {
      background: var(--dark-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--dark-surface);
    }

    .btn-primary {
      background: var(--gold);
      color: var(--dark);
    }

    .btn-primary:hover {
      background: var(--gold-dark);
    }

    /* Main Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 60px);
      margin-top: 60px;
    }

    /* Left Sidebar - Tools */
    .sidebar-left {
      width: 260px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-section {
      border-bottom: 1px solid var(--border);
    }

    .sidebar-section-header {
      padding: 12px 16px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: var(--dark-elevated);
    }

    .sidebar-section-content {
      padding: 12px;
    }

    /* Element Palette */
    .element-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .element-item {
      aspect-ratio: 1;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: grab;
      transition: all 0.2s;
      padding: 8px;
    }

    .element-item:hover {
      border-color: var(--gold);
      transform: translateY(-2px);
    }

    .element-item.active {
      border-color: var(--gold);
      background: rgba(249, 203, 0, 0.1);
    }

    .element-item svg {
      width: 24px;
      height: 24px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .element-item:hover svg {
      color: var(--gold);
    }

    .element-item span {
      font-size: 9px;
      color: var(--text-muted);
      text-align: center;
    }

    /* Room Type Selector */
    .room-types {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .room-type-btn {
      padding: 6px 12px;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .room-type-btn:hover, .room-type-btn.active {
      border-color: var(--gold);
      color: var(--gold);
    }

    /* Dimension Inputs */
    .dimension-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .dimension-input {
      flex: 1;
    }

    .dimension-input label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .dimension-input input {
      width: 100%;
      padding: 8px;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 14px;
    }

    .dimension-input input:focus {
      outline: none;
      border-color: var(--gold);
    }

    /* Canvas Area */
    .canvas-container {
      flex: 1;
      background: #1a1a24;
      position: relative;
      overflow: hidden;
    }

    .canvas-wrapper {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #designer-canvas {
      background: #2a2a3a;
      box-shadow: 0 0 40px rgba(0,0,0,0.5);
    }

    /* Canvas Toolbar */
    .canvas-toolbar {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px;
      display: flex;
      gap: 4px;
      z-index: 10;
    }

    .toolbar-btn {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: var(--dark-elevated);
      color: var(--text);
    }

    .toolbar-btn.active {
      background: var(--gold);
      color: var(--dark);
    }

    .toolbar-divider {
      width: 1px;
      background: var(--border);
      margin: 0 4px;
    }

    /* Zoom Controls */
    .zoom-controls {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .zoom-btn {
      width: 32px;
      height: 32px;
      border-radius: 4px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .zoom-btn:hover {
      background: var(--dark-elevated);
      color: var(--text);
    }

    .zoom-level {
      text-align: center;
      font-size: 11px;
      color: var(--text-muted);
      padding: 4px;
    }

    /* Right Sidebar - Properties */
    .sidebar-right {
      width: 300px;
      background: var(--dark-surface);
      border-left: 1px solid var(--border);
      overflow-y: auto;
      flex-shrink: 0;
    }

    /* Properties Panel */
    .properties-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .properties-empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .property-group {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .property-group h4 {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
    }

    .property-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .property-row label {
      width: 80px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .property-row input, .property-row select {
      flex: 1;
      padding: 8px;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 13px;
    }

    .property-row input:focus, .property-row select:focus {
      outline: none;
      border-color: var(--gold);
    }

    /* Material Picker */
    .material-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }

    .material-swatch {
      aspect-ratio: 1;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      background-size: cover;
      background-position: center;
      transition: all 0.2s;
    }

    .material-swatch:hover {
      transform: scale(1.1);
    }

    .material-swatch.selected {
      border-color: var(--gold);
      box-shadow: 0 0 0 2px rgba(249, 203, 0, 0.3);
    }

    /* Color Picker */
    .color-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 6px;
    }

    .color-swatch {
      aspect-ratio: 1;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.selected {
      border-color: var(--text);
    }

    /* Quote Summary */
    .quote-summary {
      background: var(--dark-elevated);
      border-radius: 8px;
      padding: 16px;
      margin: 16px;
    }

    .quote-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
    }

    .quote-row:last-child {
      border-bottom: none;
    }

    .quote-row.total {
      font-weight: 700;
      font-size: 16px;
      color: var(--gold);
      padding-top: 12px;
      margin-top: 8px;
      border-top: 2px solid var(--border);
    }

    /* Measurement Display on Canvas */
    .measurement-label {
      position: absolute;
      background: var(--dark);
      color: var(--gold);
      padding: 2px 8px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 4px;
      pointer-events: none;
    }

    /* Templates Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--dark-surface);
      border-radius: 16px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow: hidden;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: 60vh;
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .template-card {
      background: var(--dark-elevated);
      border: 2px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-card:hover {
      border-color: var(--gold);
      transform: translateY(-4px);
    }

    .template-preview {
      height: 120px;
      background: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .template-preview svg {
      width: 60px;
      height: 60px;
      color: var(--text-muted);
    }

    .template-info {
      padding: 12px;
    }

    .template-info h4 {
      font-size: 14px;
      margin-bottom: 4px;
    }

    .template-info p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .sidebar-left { width: 220px; }
      .sidebar-right { width: 260px; }
    }

    @media (max-width: 992px) {
      .sidebar-left, .sidebar-right {
        position: fixed;
        top: 60px;
        bottom: 0;
        z-index: 50;
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      .sidebar-left.open { transform: translateX(0); }
      .sidebar-right {
        right: 0;
        left: auto;
        transform: translateX(100%);
      }
      .sidebar-right.open { transform: translateX(0); }
    }

    /* Tooltip */
    .tooltip {
      position: absolute;
      background: var(--dark);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
      white-space: nowrap;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="/" class="logo">
        <img src="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" alt="Logo">
        <span class="logo-text">Room Designer</span>
      </a>
      <input type="text" class="project-name" id="project-name" placeholder="Untitled Project" value="Kitchen Remodel">
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="openTemplates()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="10" height="10" rx="2"/><path d="M14 7v6a2 2 0 01-2 2H6"/></svg>
        Templates
      </button>
      <button class="btn btn-secondary" onclick="saveProject()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg>
        Save
      </button>
      <button class="btn btn-primary" onclick="generateQuote()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Generate Quote
      </button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="main-container">

    <!-- Left Sidebar - Elements -->
    <aside class="sidebar-left" id="sidebar-left">

      <!-- Room Settings -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Room Settings</div>
        <div class="sidebar-section-content">
          <div class="room-types" id="room-types">
            <button class="room-type-btn active" data-room="kitchen">Kitchen</button>
            <button class="room-type-btn" data-room="bathroom">Bathroom</button>
            <button class="room-type-btn" data-room="laundry">Laundry</button>
            <button class="room-type-btn" data-room="office">Office</button>
            <button class="room-type-btn" data-room="commercial">Commercial</button>
          </div>
          <div class="dimension-row" style="margin-top: 12px;">
            <div class="dimension-input">
              <label>Width (ft)</label>
              <input type="number" id="room-width" value="12" min="1" max="100" onchange="updateRoomSize()">
            </div>
            <div class="dimension-input">
              <label>Depth (ft)</label>
              <input type="number" id="room-depth" value="10" min="1" max="100" onchange="updateRoomSize()">
            </div>
          </div>
        </div>
      </div>

      <!-- Structure Elements -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Structure</div>
        <div class="sidebar-section-content">
          <div class="element-grid">
            <div class="element-item" data-element="wall" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="1"/></svg>
              <span>Wall</span>
            </div>
            <div class="element-item" data-element="door" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 21V3h18v18H3z"/><path d="M9 21V9h6v12"/></svg>
              <span>Door</span>
            </div>
            <div class="element-item" data-element="window" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="1"/><line x1="12" y1="3" x2="12" y2="21"/><line x1="3" y1="12" x2="21" y2="12"/></svg>
              <span>Window</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Cabinets -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Cabinets</div>
        <div class="sidebar-section-content">
          <div class="element-grid">
            <div class="element-item" data-element="base-cabinet" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="8" width="20" height="12" rx="1"/><line x1="12" y1="8" x2="12" y2="20"/></svg>
              <span>Base</span>
            </div>
            <div class="element-item" data-element="wall-cabinet" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="10" rx="1"/><line x1="12" y1="4" x2="12" y2="14"/></svg>
              <span>Wall</span>
            </div>
            <div class="element-item" data-element="tall-cabinet" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="6" y="2" width="12" height="20" rx="1"/></svg>
              <span>Tall</span>
            </div>
            <div class="element-item" data-element="corner-cabinet" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 20V4h8v8h8v8H4z"/></svg>
              <span>Corner</span>
            </div>
            <div class="element-item" data-element="island" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="8" width="18" height="8" rx="1"/></svg>
              <span>Island</span>
            </div>
            <div class="element-item" data-element="peninsula" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 8h12v8H3V8zM15 12h6"/></svg>
              <span>Peninsula</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Countertops -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Countertops</div>
        <div class="sidebar-section-content">
          <div class="element-grid">
            <div class="element-item" data-element="countertop-straight" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="4" rx="1"/></svg>
              <span>Straight</span>
            </div>
            <div class="element-item" data-element="countertop-l" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v16h16v-8H12V4H4z"/></svg>
              <span>L-Shape</span>
            </div>
            <div class="element-item" data-element="countertop-u" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4v16h16V4h-4v8H8V4H4z"/></svg>
              <span>U-Shape</span>
            </div>
            <div class="element-item" data-element="backsplash" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12"/><line x1="2" y1="12" x2="22" y2="12"/></svg>
              <span>Backsplash</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Appliances -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Appliances</div>
        <div class="sidebar-section-content">
          <div class="element-grid">
            <div class="element-item" data-element="sink" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="8" ry="4"/><path d="M12 16v4"/></svg>
              <span>Sink</span>
            </div>
            <div class="element-item" data-element="stove" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="1"/><circle cx="8" cy="8" r="2"/><circle cx="16" cy="8" r="2"/><circle cx="8" cy="16" r="2"/><circle cx="16" cy="16" r="2"/></svg>
              <span>Stove</span>
            </div>
            <div class="element-item" data-element="refrigerator" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="1"/><line x1="5" y1="10" x2="19" y2="10"/></svg>
              <span>Fridge</span>
            </div>
            <div class="element-item" data-element="dishwasher" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="1"/><line x1="4" y1="8" x2="20" y2="8"/></svg>
              <span>Dishwasher</span>
            </div>
            <div class="element-item" data-element="toilet" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><ellipse cx="12" cy="16" rx="6" ry="4"/><rect x="8" y="6" width="8" height="6" rx="1"/></svg>
              <span>Toilet</span>
            </div>
            <div class="element-item" data-element="bathtub" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" rx="2"/><path d="M6 10V6a2 2 0 012-2h0a2 2 0 012 2v4"/></svg>
              <span>Bathtub</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Flooring -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Flooring & Tile</div>
        <div class="sidebar-section-content">
          <div class="element-grid">
            <div class="element-item" data-element="flooring-area" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>
              <span>Floor Area</span>
            </div>
            <div class="element-item" data-element="tile-area" draggable="true">
              <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="8" height="8"/><rect x="13" y="3" width="8" height="8"/><rect x="3" y="13" width="8" height="8"/><rect x="13" y="13" width="8" height="8"/></svg>
              <span>Tile Area</span>
            </div>
          </div>
        </div>
      </div>

    </aside>

    <!-- Canvas Area -->
    <main class="canvas-container">
      <!-- Canvas Toolbar -->
      <div class="canvas-toolbar">
        <button class="toolbar-btn active" id="tool-select" title="Select (V)" onclick="setTool('select')">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/></svg>
        </button>
        <button class="toolbar-btn" id="tool-draw" title="Draw Wall (W)" onclick="setTool('draw')">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg>
        </button>
        <button class="toolbar-btn" id="tool-measure" title="Measure (M)" onclick="setTool('measure')">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h20M2 12l4-4M2 12l4 4M22 12l-4-4M22 12l-4 4"/></svg>
        </button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn" title="Undo (Ctrl+Z)" onclick="undo()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v6h6"/><path d="M3 13a9 9 0 1018 0 9 9 0 00-18 0z"/></svg>
        </button>
        <button class="toolbar-btn" title="Redo (Ctrl+Y)" onclick="redo()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 7v6h-6"/><path d="M21 13a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn" title="Delete Selected" onclick="deleteSelected()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
        </button>
        <button class="toolbar-btn" title="Clear All" onclick="clearCanvas()">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg>
        </button>
      </div>

      <!-- Canvas -->
      <div class="canvas-wrapper">
        <canvas id="designer-canvas"></canvas>
      </div>

      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        </button>
        <div class="zoom-level" id="zoom-level">100%</div>
        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
        </button>
        <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
        </button>
      </div>
    </main>

    <!-- Right Sidebar - Properties -->
    <aside class="sidebar-right" id="sidebar-right">

      <!-- Selected Element Properties -->
      <div id="properties-panel">
        <div class="properties-empty">
          <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg>
          <p>Select an element to edit its properties</p>
        </div>
      </div>

      <!-- Quote Summary -->
      <div class="sidebar-section">
        <div class="sidebar-section-header">Quote Summary</div>
        <div class="quote-summary" id="quote-summary">
          <div class="quote-row">
            <span>Cabinets</span>
            <span id="quote-cabinets">0 LF</span>
          </div>
          <div class="quote-row">
            <span>Countertops</span>
            <span id="quote-countertops">0 SF</span>
          </div>
          <div class="quote-row">
            <span>Backsplash</span>
            <span id="quote-backsplash">0 SF</span>
          </div>
          <div class="quote-row">
            <span>Flooring</span>
            <span id="quote-flooring">0 SF</span>
          </div>
          <div class="quote-row total">
            <span>Estimated Total</span>
            <span id="quote-total">$0.00</span>
          </div>
        </div>
        <div style="padding: 0 16px 16px;">
          <button class="btn btn-primary" style="width: 100%;" onclick="generateQuote()">
            Generate Detailed Quote
          </button>
        </div>
      </div>

    </aside>

  </div>

  <!-- Templates Modal -->
  <div class="modal-overlay" id="templates-modal">
    <div class="modal">
      <div class="modal-header">
        <h3>Choose a Template</h3>
        <button class="modal-close" onclick="closeTemplates()">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="template-grid">
          <div class="template-card" onclick="loadTemplate('galley-kitchen')">
            <div class="template-preview">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="4"/><rect x="2" y="14" width="20" height="4"/></svg>
            </div>
            <div class="template-info">
              <h4>Galley Kitchen</h4>
              <p>10' x 8' parallel counters</p>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('l-shaped-kitchen')">
            <div class="template-preview">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 4v16h8V12h8V4H4z"/></svg>
            </div>
            <div class="template-info">
              <h4>L-Shaped Kitchen</h4>
              <p>12' x 10' with island</p>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('u-shaped-kitchen')">
            <div class="template-preview">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M4 4v16h16V4h-4v10H8V4H4z"/></svg>
            </div>
            <div class="template-info">
              <h4>U-Shaped Kitchen</h4>
              <p>14' x 12' wraparound</p>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('master-bathroom')">
            <div class="template-preview">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" rx="1"/><ellipse cx="8" cy="10" rx="2" ry="3"/><rect x="14" y="14" width="4" height="4"/></svg>
            </div>
            <div class="template-info">
              <h4>Master Bathroom</h4>
              <p>10' x 8' with tub & vanity</p>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('commercial-restroom')">
            <div class="template-preview">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20"/><circle cx="6" cy="8" r="2"/><circle cx="12" cy="8" r="2"/><circle cx="18" cy="8" r="2"/></svg>
            </div>
            <div class="template-info">
              <h4>Commercial Restroom</h4>
              <p>Multi-stall layout</p>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('blank')">
            <div class="template-preview">
              <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke-dasharray="4"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            </div>
            <div class="template-info">
              <h4>Blank Canvas</h4>
              <p>Start from scratch</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quote Modal -->
  <div class="modal-overlay" id="quote-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3>Project Quote</h3>
        <button class="modal-close" onclick="closeQuoteModal()">
          <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="quote-modal-body">
        <!-- Quote content populated by JS -->
      </div>
      <div style="padding: 16px; display: flex; gap: 12px; justify-content: flex-end; border-top: 1px solid var(--border);">
        <button class="btn btn-secondary" onclick="printQuote()">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 6,2 18,2 18,9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Print
        </button>
        <button class="btn btn-primary" onclick="sendQuote()">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22,2 15,22 11,13 2,9 22,2"/></svg>
          Send to Customer
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== ROOM DESIGNER APPLICATION =====

    // Configuration
    const CONFIG = {
      pixelsPerFoot: 40, // Scale: 40 pixels = 1 foot
      gridSize: 10, // Grid snap in pixels
      canvasWidth: 800,
      canvasHeight: 600,

      // Pricing (per unit)
      pricing: {
        cabinets: { base: 150, wall: 120, tall: 300, corner: 200, island: 400 }, // per LF
        countertops: { granite: 65, quartz: 75, marble: 85, quartzite: 95 }, // per SF
        backsplash: { tile: 25, stone: 45 }, // per SF
        flooring: { lvp: 8, tile: 15, hardwood: 12 }, // per SF
        appliances: { sink: 350, stove: 800, refrigerator: 1500, dishwasher: 600 }
      },

      // Element dimensions (in feet)
      elementSizes: {
        'base-cabinet': { width: 3, height: 2 },
        'wall-cabinet': { width: 3, height: 1.5 },
        'tall-cabinet': { width: 2, height: 7 },
        'corner-cabinet': { width: 3, height: 3 },
        'island': { width: 6, height: 3 },
        'peninsula': { width: 4, height: 2 },
        'countertop-straight': { width: 8, height: 2 },
        'countertop-l': { width: 6, height: 6 },
        'countertop-u': { width: 8, height: 8 },
        'sink': { width: 2.5, height: 1.5 },
        'stove': { width: 2.5, height: 2 },
        'refrigerator': { width: 3, height: 2.5 },
        'dishwasher': { width: 2, height: 2 },
        'door': { width: 3, height: 0.5 },
        'window': { width: 3, height: 0.5 },
        'toilet': { width: 1.5, height: 2.5 },
        'bathtub': { width: 5, height: 2.5 },
        'flooring-area': { width: 4, height: 4 },
        'tile-area': { width: 3, height: 3 },
        'backsplash': { width: 6, height: 1.5 }
      },

      // Element colors
      colors: {
        'base-cabinet': '#8B4513',
        'wall-cabinet': '#A0522D',
        'tall-cabinet': '#8B4513',
        'corner-cabinet': '#8B4513',
        'island': '#654321',
        'peninsula': '#654321',
        'countertop-straight': '#708090',
        'countertop-l': '#708090',
        'countertop-u': '#708090',
        'backsplash': '#B8860B',
        'sink': '#C0C0C0',
        'stove': '#2F2F2F',
        'refrigerator': '#C0C0C0',
        'dishwasher': '#A9A9A9',
        'door': '#DEB887',
        'window': '#87CEEB',
        'wall': '#4A4A4A',
        'toilet': '#F5F5F5',
        'bathtub': '#F5F5F5',
        'flooring-area': '#D2691E',
        'tile-area': '#DDD'
      }
    };

    // State
    let canvas;
    let currentTool = 'select';
    let selectedElement = null;
    let roomType = 'kitchen';
    let zoomLevel = 1;
    let projectData = {
      name: 'Kitchen Remodel',
      roomWidth: 12,
      roomDepth: 10,
      elements: []
    };
    let history = [];
    let historyIndex = -1;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initCanvas();
      initEventListeners();
      drawGrid();
      drawRoom();
      updateQuoteSummary();
    });

    // Initialize Fabric.js canvas
    function initCanvas() {
      canvas = new fabric.Canvas('designer-canvas', {
        width: CONFIG.canvasWidth,
        height: CONFIG.canvasHeight,
        backgroundColor: '#2a2a3a',
        selection: true,
        preserveObjectStacking: true
      });

      // Selection events
      canvas.on('selection:created', onObjectSelected);
      canvas.on('selection:updated', onObjectSelected);
      canvas.on('selection:cleared', onObjectDeselected);
      canvas.on('object:modified', onObjectModified);
      canvas.on('object:moving', onObjectMoving);

      // Enable snapping
      canvas.on('object:moving', snapToGrid);
    }

    // Event Listeners
    function initEventListeners() {
      // Room type buttons
      document.querySelectorAll('.room-type-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.room-type-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          roomType = btn.dataset.room;
        });
      });

      // Draggable elements
      document.querySelectorAll('.element-item[draggable="true"]').forEach(el => {
        el.addEventListener('dragstart', onDragStart);
        el.addEventListener('click', () => addElement(el.dataset.element));
      });

      // Canvas drop zone
      const canvasWrapper = document.querySelector('.canvas-wrapper');
      canvasWrapper.addEventListener('dragover', (e) => e.preventDefault());
      canvasWrapper.addEventListener('drop', onDrop);

      // Keyboard shortcuts
      document.addEventListener('keydown', handleKeyboard);
    }

    // Draw grid
    function drawGrid() {
      const gridGroup = [];
      const gridColor = 'rgba(255,255,255,0.05)';

      // Vertical lines
      for (let x = 0; x <= CONFIG.canvasWidth; x += CONFIG.pixelsPerFoot) {
        gridGroup.push(new fabric.Line([x, 0, x, CONFIG.canvasHeight], {
          stroke: gridColor,
          strokeWidth: 1,
          selectable: false,
          evented: false
        }));
      }

      // Horizontal lines
      for (let y = 0; y <= CONFIG.canvasHeight; y += CONFIG.pixelsPerFoot) {
        gridGroup.push(new fabric.Line([0, y, CONFIG.canvasWidth, y], {
          stroke: gridColor,
          strokeWidth: 1,
          selectable: false,
          evented: false
        }));
      }

      const grid = new fabric.Group(gridGroup, {
        selectable: false,
        evented: false
      });

      canvas.add(grid);
      canvas.sendToBack(grid);
    }

    // Draw room outline
    function drawRoom() {
      const width = projectData.roomWidth * CONFIG.pixelsPerFoot;
      const height = projectData.roomDepth * CONFIG.pixelsPerFoot;
      const offsetX = (CONFIG.canvasWidth - width) / 2;
      const offsetY = (CONFIG.canvasHeight - height) / 2;

      // Remove existing room outline
      canvas.getObjects().forEach(obj => {
        if (obj.isRoomOutline) canvas.remove(obj);
      });

      // Room floor
      const floor = new fabric.Rect({
        left: offsetX,
        top: offsetY,
        width: width,
        height: height,
        fill: 'rgba(60, 60, 80, 0.3)',
        stroke: '#f9cb00',
        strokeWidth: 3,
        selectable: false,
        evented: false,
        isRoomOutline: true
      });

      // Dimension labels
      const widthLabel = new fabric.Text(`${projectData.roomWidth}'`, {
        left: offsetX + width / 2,
        top: offsetY - 25,
        fontSize: 14,
        fill: '#f9cb00',
        fontFamily: 'Inter',
        fontWeight: '600',
        originX: 'center',
        selectable: false,
        evented: false,
        isRoomOutline: true
      });

      const heightLabel = new fabric.Text(`${projectData.roomDepth}'`, {
        left: offsetX - 25,
        top: offsetY + height / 2,
        fontSize: 14,
        fill: '#f9cb00',
        fontFamily: 'Inter',
        fontWeight: '600',
        originY: 'center',
        angle: -90,
        selectable: false,
        evented: false,
        isRoomOutline: true
      });

      canvas.add(floor, widthLabel, heightLabel);
      canvas.sendToBack(floor);
    }

    // Update room size
    function updateRoomSize() {
      projectData.roomWidth = parseFloat(document.getElementById('room-width').value) || 12;
      projectData.roomDepth = parseFloat(document.getElementById('room-depth').value) || 10;
      drawRoom();
      updateQuoteSummary();
    }

    // Add element to canvas
    function addElement(type, x, y) {
      const size = CONFIG.elementSizes[type] || { width: 2, height: 2 };
      const color = CONFIG.colors[type] || '#666';

      const width = size.width * CONFIG.pixelsPerFoot;
      const height = size.height * CONFIG.pixelsPerFoot;

      // Default position (center of canvas)
      const posX = x || (CONFIG.canvasWidth - width) / 2;
      const posY = y || (CONFIG.canvasHeight - height) / 2;

      // Create element based on type
      let element;

      if (type.includes('countertop') || type === 'backsplash') {
        element = createCountertop(type, posX, posY, width, height, color);
      } else if (type.includes('cabinet') || type === 'island' || type === 'peninsula') {
        element = createCabinet(type, posX, posY, width, height, color);
      } else if (type === 'flooring-area' || type === 'tile-area') {
        element = createFlooringArea(type, posX, posY, width, height);
      } else {
        element = createAppliance(type, posX, posY, width, height, color);
      }

      element.elementType = type;
      element.elementData = {
        type: type,
        width: size.width,
        height: size.height,
        material: 'default',
        color: color
      };

      canvas.add(element);
      canvas.setActiveObject(element);
      saveState();
      updateQuoteSummary();

      return element;
    }

    // Create cabinet element
    function createCabinet(type, x, y, width, height, color) {
      const rect = new fabric.Rect({
        width: width - 4,
        height: height - 4,
        fill: color,
        stroke: '#333',
        strokeWidth: 2,
        rx: 4,
        ry: 4
      });

      const label = new fabric.Text(type.replace('-', '\n').toUpperCase(), {
        fontSize: 10,
        fill: '#fff',
        fontFamily: 'Inter',
        textAlign: 'center',
        originX: 'center',
        originY: 'center'
      });

      const group = new fabric.Group([rect, label], {
        left: x,
        top: y,
        hasControls: true,
        hasBorders: true,
        lockRotation: false
      });

      return group;
    }

    // Create countertop element
    function createCountertop(type, x, y, width, height, color) {
      let shape;

      if (type === 'countertop-l') {
        // L-shaped countertop
        const path = new fabric.Path(`M 0 0 L ${width} 0 L ${width} ${height * 0.4} L ${width * 0.4} ${height * 0.4} L ${width * 0.4} ${height} L 0 ${height} Z`, {
          fill: color,
          stroke: '#222',
          strokeWidth: 2
        });
        shape = path;
      } else if (type === 'countertop-u') {
        // U-shaped countertop
        const path = new fabric.Path(`M 0 0 L ${width} 0 L ${width} ${height} L ${width * 0.7} ${height} L ${width * 0.7} ${height * 0.3} L ${width * 0.3} ${height * 0.3} L ${width * 0.3} ${height} L 0 ${height} Z`, {
          fill: color,
          stroke: '#222',
          strokeWidth: 2
        });
        shape = path;
      } else {
        // Straight countertop
        shape = new fabric.Rect({
          width: width,
          height: height,
          fill: color,
          stroke: '#222',
          strokeWidth: 2,
          rx: 2,
          ry: 2
        });
      }

      const label = new fabric.Text(`${(width / CONFIG.pixelsPerFoot).toFixed(1)}' x ${(height / CONFIG.pixelsPerFoot).toFixed(1)}'`, {
        fontSize: 11,
        fill: '#fff',
        fontFamily: 'Inter',
        fontWeight: '600',
        originX: 'center',
        originY: 'center',
        left: width / 2,
        top: height / 2
      });

      const group = new fabric.Group([shape, label], {
        left: x,
        top: y
      });

      return group;
    }

    // Create appliance element
    function createAppliance(type, x, y, width, height, color) {
      const rect = new fabric.Rect({
        width: width,
        height: height,
        fill: color,
        stroke: '#333',
        strokeWidth: 2,
        rx: 4,
        ry: 4
      });

      const displayName = type.charAt(0).toUpperCase() + type.slice(1);
      const label = new fabric.Text(displayName, {
        fontSize: 11,
        fill: type === 'stove' ? '#fff' : '#333',
        fontFamily: 'Inter',
        fontWeight: '500',
        originX: 'center',
        originY: 'center',
        left: width / 2,
        top: height / 2
      });

      return new fabric.Group([rect, label], {
        left: x,
        top: y
      });
    }

    // Create flooring area
    function createFlooringArea(type, x, y, width, height) {
      const pattern = type === 'tile-area' ? createTilePattern() : createWoodPattern();

      const rect = new fabric.Rect({
        width: width,
        height: height,
        fill: pattern || (type === 'tile-area' ? '#ccc' : '#a0826d'),
        stroke: '#f9cb00',
        strokeWidth: 2,
        strokeDashArray: [5, 5],
        rx: 0,
        ry: 0
      });

      const sqft = ((width / CONFIG.pixelsPerFoot) * (height / CONFIG.pixelsPerFoot)).toFixed(1);
      const label = new fabric.Text(`${sqft} SF`, {
        fontSize: 14,
        fill: '#fff',
        fontFamily: 'Inter',
        fontWeight: '700',
        originX: 'center',
        originY: 'center',
        left: width / 2,
        top: height / 2,
        shadow: '0 0 4px rgba(0,0,0,0.8)'
      });

      return new fabric.Group([rect, label], {
        left: x,
        top: y
      });
    }

    function createTilePattern() {
      // Simple tile-like color
      return '#c9c9c9';
    }

    function createWoodPattern() {
      // Wood-like color
      return '#a0826d';
    }

    // Drag and drop handlers
    function onDragStart(e) {
      e.dataTransfer.setData('element-type', e.target.dataset.element);
    }

    function onDrop(e) {
      e.preventDefault();
      const type = e.dataTransfer.getData('element-type');
      if (!type) return;

      const rect = canvas.getElement().getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoomLevel;
      const y = (e.clientY - rect.top) / zoomLevel;

      addElement(type, x, y);
    }

    // Tool selection
    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('.toolbar-btn').forEach(btn => {
        btn.classList.toggle('active', btn.id === `tool-${tool}`);
      });

      if (tool === 'select') {
        canvas.selection = true;
        canvas.defaultCursor = 'default';
      } else if (tool === 'draw') {
        canvas.selection = false;
        canvas.defaultCursor = 'crosshair';
      } else if (tool === 'measure') {
        canvas.selection = false;
        canvas.defaultCursor = 'crosshair';
      }
    }

    // Object selection handlers
    function onObjectSelected(e) {
      selectedElement = e.selected[0];
      showProperties(selectedElement);
    }

    function onObjectDeselected() {
      selectedElement = null;
      hideProperties();
    }

    function onObjectModified(e) {
      updateQuoteSummary();
      saveState();
    }

    function onObjectMoving(e) {
      // Update dimension labels if needed
    }

    // Snap to grid
    function snapToGrid(e) {
      const obj = e.target;
      obj.set({
        left: Math.round(obj.left / CONFIG.gridSize) * CONFIG.gridSize,
        top: Math.round(obj.top / CONFIG.gridSize) * CONFIG.gridSize
      });
    }

    // Properties panel
    function showProperties(obj) {
      if (!obj || !obj.elementData) {
        hideProperties();
        return;
      }

      const data = obj.elementData;
      const panel = document.getElementById('properties-panel');

      panel.innerHTML = `
        <div class="property-group">
          <h4>${data.type.replace('-', ' ').toUpperCase()}</h4>
          <div class="property-row">
            <label>Width (ft)</label>
            <input type="number" id="prop-width" value="${data.width}" step="0.5" min="0.5" onchange="updateElementSize()">
          </div>
          <div class="property-row">
            <label>Depth (ft)</label>
            <input type="number" id="prop-height" value="${data.height}" step="0.5" min="0.5" onchange="updateElementSize()">
          </div>
        </div>

        <div class="property-group">
          <h4>Material</h4>
          <div class="property-row">
            <label>Type</label>
            <select id="prop-material" onchange="updateElementMaterial()">
              ${getMaterialOptions(data.type)}
            </select>
          </div>
          <div style="margin-top: 12px;">
            <div class="material-grid" id="material-swatches">
              ${getMaterialSwatches(data.type)}
            </div>
          </div>
        </div>

        <div class="property-group">
          <h4>Actions</h4>
          <button class="btn btn-secondary" style="width: 100%; margin-bottom: 8px;" onclick="duplicateElement()">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
            Duplicate
          </button>
          <button class="btn btn-secondary" style="width: 100%; color: #ef4444;" onclick="deleteSelected()">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
            Delete
          </button>
        </div>
      `;
    }

    function hideProperties() {
      document.getElementById('properties-panel').innerHTML = `
        <div class="properties-empty">
          <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/></svg>
          <p>Select an element to edit its properties</p>
        </div>
      `;
    }

    function getMaterialOptions(type) {
      if (type.includes('countertop')) {
        return `
          <option value="granite">Granite</option>
          <option value="quartz">Quartz</option>
          <option value="marble">Marble</option>
          <option value="quartzite">Quartzite</option>
        `;
      } else if (type.includes('cabinet')) {
        return `
          <option value="oak">Oak</option>
          <option value="maple">Maple</option>
          <option value="cherry">Cherry</option>
          <option value="white">White Shaker</option>
          <option value="gray">Gray Shaker</option>
        `;
      } else if (type.includes('flooring') || type.includes('tile')) {
        return `
          <option value="lvp">Luxury Vinyl Plank</option>
          <option value="tile">Ceramic Tile</option>
          <option value="porcelain">Porcelain Tile</option>
          <option value="hardwood">Hardwood</option>
        `;
      }
      return '<option value="default">Standard</option>';
    }

    function getMaterialSwatches(type) {
      const swatches = {
        countertop: [
          { color: '#4a4a4a', name: 'Steel Gray' },
          { color: '#f5f5dc', name: 'Calacatta' },
          { color: '#2f2f2f', name: 'Absolute Black' },
          { color: '#d4a574', name: 'Santa Cecilia' },
          { color: '#c9c9c9', name: 'White Ice' },
          { color: '#8b7355', name: 'Giallo Ornamental' },
          { color: '#5c4033', name: 'Tan Brown' },
          { color: '#e8e4d9', name: 'Bianco Romano' }
        ],
        cabinet: [
          { color: '#f5f5f5', name: 'White' },
          { color: '#4a4a4a', name: 'Charcoal' },
          { color: '#d4a574', name: 'Natural Oak' },
          { color: '#8b4513', name: 'Cherry' },
          { color: '#2f2f2f', name: 'Espresso' },
          { color: '#a0a0a0', name: 'Gray' }
        ],
        default: [
          { color: '#c9c9c9', name: 'Light' },
          { color: '#808080', name: 'Medium' },
          { color: '#4a4a4a', name: 'Dark' }
        ]
      };

      let category = 'default';
      if (type.includes('countertop')) category = 'countertop';
      else if (type.includes('cabinet')) category = 'cabinet';

      return swatches[category].map(s =>
        `<div class="material-swatch" style="background: ${s.color};" title="${s.name}" onclick="applyMaterialColor('${s.color}')"></div>`
      ).join('');
    }

    function applyMaterialColor(color) {
      if (!selectedElement) return;

      // Update the fill color of the element
      if (selectedElement.type === 'group') {
        const rect = selectedElement.getObjects()[0];
        if (rect) rect.set('fill', color);
      } else {
        selectedElement.set('fill', color);
      }

      selectedElement.elementData.color = color;
      canvas.renderAll();
      saveState();

      // Update selected state
      document.querySelectorAll('.material-swatch').forEach(s => s.classList.remove('selected'));
      event.target.classList.add('selected');
    }

    function updateElementSize() {
      if (!selectedElement) return;

      const newWidth = parseFloat(document.getElementById('prop-width').value) * CONFIG.pixelsPerFoot;
      const newHeight = parseFloat(document.getElementById('prop-height').value) * CONFIG.pixelsPerFoot;

      selectedElement.scaleX = newWidth / (selectedElement.width * selectedElement.scaleX) * selectedElement.scaleX;
      selectedElement.scaleY = newHeight / (selectedElement.height * selectedElement.scaleY) * selectedElement.scaleY;

      selectedElement.elementData.width = parseFloat(document.getElementById('prop-width').value);
      selectedElement.elementData.height = parseFloat(document.getElementById('prop-height').value);

      canvas.renderAll();
      updateQuoteSummary();
      saveState();
    }

    function updateElementMaterial() {
      if (!selectedElement) return;
      selectedElement.elementData.material = document.getElementById('prop-material').value;
      updateQuoteSummary();
    }

    // Element actions
    function duplicateElement() {
      if (!selectedElement) return;

      selectedElement.clone((cloned) => {
        cloned.set({
          left: selectedElement.left + 20,
          top: selectedElement.top + 20
        });
        cloned.elementType = selectedElement.elementType;
        cloned.elementData = { ...selectedElement.elementData };
        canvas.add(cloned);
        canvas.setActiveObject(cloned);
        saveState();
        updateQuoteSummary();
      });
    }

    function deleteSelected() {
      const active = canvas.getActiveObject();
      if (active) {
        canvas.remove(active);
        hideProperties();
        saveState();
        updateQuoteSummary();
      }
    }

    function clearCanvas() {
      if (!confirm('Clear all elements? This cannot be undone.')) return;

      canvas.getObjects().forEach(obj => {
        if (!obj.isRoomOutline && obj.selectable !== false) {
          canvas.remove(obj);
        }
      });

      saveState();
      updateQuoteSummary();
    }

    // Zoom controls
    function zoomIn() {
      zoomLevel = Math.min(zoomLevel + 0.1, 2);
      applyZoom();
    }

    function zoomOut() {
      zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
      applyZoom();
    }

    function resetZoom() {
      zoomLevel = 1;
      applyZoom();
    }

    function applyZoom() {
      canvas.setZoom(zoomLevel);
      canvas.setWidth(CONFIG.canvasWidth * zoomLevel);
      canvas.setHeight(CONFIG.canvasHeight * zoomLevel);
      document.getElementById('zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
    }

    // History (undo/redo)
    function saveState() {
      const state = JSON.stringify(canvas.toJSON(['elementType', 'elementData', 'isRoomOutline']));
      history = history.slice(0, historyIndex + 1);
      history.push(state);
      historyIndex++;
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        loadState(history[historyIndex]);
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        loadState(history[historyIndex]);
      }
    }

    function loadState(state) {
      canvas.loadFromJSON(state, () => {
        canvas.renderAll();
        updateQuoteSummary();
      });
    }

    // Keyboard shortcuts
    function handleKeyboard(e) {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      if (e.key === 'Delete' || e.key === 'Backspace') {
        deleteSelected();
      } else if (e.key === 'v') {
        setTool('select');
      } else if (e.key === 'w') {
        setTool('draw');
      } else if (e.key === 'm') {
        setTool('measure');
      } else if (e.ctrlKey && e.key === 'z') {
        undo();
      } else if (e.ctrlKey && e.key === 'y') {
        redo();
      }
    }

    // Quote calculations
    function updateQuoteSummary() {
      let cabinetsLF = 0;
      let countertopsSF = 0;
      let backsplashSF = 0;
      let flooringSF = 0;

      canvas.getObjects().forEach(obj => {
        if (!obj.elementData) return;

        const data = obj.elementData;
        const actualWidth = data.width * (obj.scaleX || 1);
        const actualHeight = data.height * (obj.scaleY || 1);

        if (data.type.includes('cabinet') || data.type === 'island' || data.type === 'peninsula') {
          cabinetsLF += actualWidth;
        } else if (data.type.includes('countertop')) {
          countertopsSF += actualWidth * actualHeight;
        } else if (data.type === 'backsplash') {
          backsplashSF += actualWidth * actualHeight;
        } else if (data.type.includes('flooring') || data.type.includes('tile-area')) {
          flooringSF += actualWidth * actualHeight;
        }
      });

      document.getElementById('quote-cabinets').textContent = cabinetsLF.toFixed(1) + ' LF';
      document.getElementById('quote-countertops').textContent = countertopsSF.toFixed(1) + ' SF';
      document.getElementById('quote-backsplash').textContent = backsplashSF.toFixed(1) + ' SF';
      document.getElementById('quote-flooring').textContent = flooringSF.toFixed(1) + ' SF';

      // Calculate estimated total
      const cabinetCost = cabinetsLF * CONFIG.pricing.cabinets.base;
      const countertopCost = countertopsSF * CONFIG.pricing.countertops.granite;
      const backsplashCost = backsplashSF * CONFIG.pricing.backsplash.tile;
      const flooringCost = flooringSF * CONFIG.pricing.flooring.tile;

      const total = cabinetCost + countertopCost + backsplashCost + flooringCost;
      document.getElementById('quote-total').textContent = '$' + total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Templates
    function openTemplates() {
      document.getElementById('templates-modal').classList.add('active');
    }

    function closeTemplates() {
      document.getElementById('templates-modal').classList.remove('active');
    }

    function loadTemplate(template) {
      clearCanvas();
      closeTemplates();

      const templates = {
        'galley-kitchen': () => {
          projectData.roomWidth = 10;
          projectData.roomDepth = 8;
          document.getElementById('room-width').value = 10;
          document.getElementById('room-depth').value = 8;
          drawRoom();

          // Add elements
          addElement('base-cabinet', 80, 120);
          addElement('base-cabinet', 200, 120);
          addElement('countertop-straight', 80, 100);
          addElement('sink', 140, 100);
          addElement('base-cabinet', 80, 340);
          addElement('base-cabinet', 200, 340);
          addElement('stove', 240, 340);
        },
        'l-shaped-kitchen': () => {
          projectData.roomWidth = 12;
          projectData.roomDepth = 10;
          document.getElementById('room-width').value = 12;
          document.getElementById('room-depth').value = 10;
          drawRoom();

          addElement('countertop-l', 100, 100);
          addElement('base-cabinet', 100, 180);
          addElement('base-cabinet', 220, 180);
          addElement('island', 250, 300);
          addElement('sink', 160, 100);
          addElement('stove', 360, 180);
          addElement('refrigerator', 100, 380);
        },
        'u-shaped-kitchen': () => {
          projectData.roomWidth = 14;
          projectData.roomDepth = 12;
          document.getElementById('room-width').value = 14;
          document.getElementById('room-depth').value = 12;
          drawRoom();

          addElement('countertop-u', 80, 80);
          addElement('base-cabinet', 80, 200);
          addElement('base-cabinet', 200, 200);
          addElement('base-cabinet', 400, 200);
          addElement('sink', 240, 80);
          addElement('stove', 320, 200);
        },
        'master-bathroom': () => {
          projectData.roomWidth = 10;
          projectData.roomDepth = 8;
          document.getElementById('room-width').value = 10;
          document.getElementById('room-depth').value = 8;
          drawRoom();

          addElement('bathtub', 100, 100);
          addElement('toilet', 350, 100);
          addElement('base-cabinet', 100, 340);
          addElement('sink', 140, 300);
          addElement('tile-area', 200, 200);
        },
        'commercial-restroom': () => {
          projectData.roomWidth = 20;
          projectData.roomDepth = 15;
          document.getElementById('room-width').value = 20;
          document.getElementById('room-depth').value = 15;
          drawRoom();

          addElement('toilet', 100, 100);
          addElement('toilet', 200, 100);
          addElement('toilet', 300, 100);
          addElement('sink', 500, 100);
          addElement('sink', 600, 100);
          addElement('tile-area', 100, 300);
        },
        'blank': () => {
          // Already cleared
        }
      };

      if (templates[template]) {
        templates[template]();
      }

      updateQuoteSummary();
      saveState();
    }

    // Quote generation
    function generateQuote() {
      const projectName = document.getElementById('project-name').value || 'Untitled Project';

      let items = [];
      let total = 0;

      canvas.getObjects().forEach(obj => {
        if (!obj.elementData) return;

        const data = obj.elementData;
        const actualWidth = data.width * (obj.scaleX || 1);
        const actualHeight = data.height * (obj.scaleY || 1);
        const area = actualWidth * actualHeight;

        let price = 0;
        let unit = '';
        let quantity = 0;

        if (data.type.includes('cabinet') || data.type === 'island' || data.type === 'peninsula') {
          price = CONFIG.pricing.cabinets.base * actualWidth;
          unit = 'LF';
          quantity = actualWidth;
        } else if (data.type.includes('countertop')) {
          price = CONFIG.pricing.countertops.granite * area;
          unit = 'SF';
          quantity = area;
        } else if (data.type === 'backsplash') {
          price = CONFIG.pricing.backsplash.tile * area;
          unit = 'SF';
          quantity = area;
        } else if (data.type.includes('flooring') || data.type.includes('tile')) {
          price = CONFIG.pricing.flooring.tile * area;
          unit = 'SF';
          quantity = area;
        } else if (CONFIG.pricing.appliances[data.type]) {
          price = CONFIG.pricing.appliances[data.type];
          unit = 'ea';
          quantity = 1;
        }

        if (price > 0) {
          items.push({
            name: data.type.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            quantity: quantity.toFixed(1),
            unit: unit,
            price: price
          });
          total += price;
        }
      });

      // Group similar items
      const grouped = {};
      items.forEach(item => {
        if (grouped[item.name]) {
          grouped[item.name].quantity = (parseFloat(grouped[item.name].quantity) + parseFloat(item.quantity)).toFixed(1);
          grouped[item.name].price += item.price;
        } else {
          grouped[item.name] = { ...item };
        }
      });

      const modalBody = document.getElementById('quote-modal-body');
      modalBody.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h4 style="color: var(--gold); margin-bottom: 8px;">${projectName}</h4>
          <p style="color: var(--text-muted); font-size: 13px;">Room: ${projectData.roomWidth}' x ${projectData.roomDepth}' ${roomType}</p>
          <p style="color: var(--text-muted); font-size: 13px;">Generated: ${new Date().toLocaleDateString()}</p>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid var(--border);">
              <th style="text-align: left; padding: 10px 0; color: var(--text-muted); font-size: 12px;">Item</th>
              <th style="text-align: right; padding: 10px 0; color: var(--text-muted); font-size: 12px;">Qty</th>
              <th style="text-align: right; padding: 10px 0; color: var(--text-muted); font-size: 12px;">Price</th>
            </tr>
          </thead>
          <tbody>
            ${Object.values(grouped).map(item => `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 12px 0;">${item.name}</td>
                <td style="text-align: right; padding: 12px 0; color: var(--text-muted);">${item.quantity} ${item.unit}</td>
                <td style="text-align: right; padding: 12px 0; font-weight: 600;">$${item.price.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr style="border-top: 2px solid var(--gold);">
              <td colspan="2" style="padding: 16px 0; font-weight: 700; font-size: 16px;">Estimated Total</td>
              <td style="text-align: right; padding: 16px 0; font-weight: 700; font-size: 18px; color: var(--gold);">$${total.toLocaleString('en-US', { minimumFractionDigits: 2 })}</td>
            </tr>
          </tfoot>
        </table>

        <div style="margin-top: 20px; padding: 16px; background: var(--dark-elevated); border-radius: 8px;">
          <p style="font-size: 12px; color: var(--text-muted); margin: 0;">
            * This is an estimate based on standard pricing. Final quote may vary based on material selection, site conditions, and labor requirements.
          </p>
        </div>
      `;

      document.getElementById('quote-modal').classList.add('active');
    }

    function closeQuoteModal() {
      document.getElementById('quote-modal').classList.remove('active');
    }

    function printQuote() {
      window.print();
    }

    function sendQuote() {
      // Would integrate with your API to send quote
      alert('Quote sending would integrate with your email/estimate system.');
    }

    // Save/Load project
    function saveProject() {
      const data = {
        name: document.getElementById('project-name').value,
        roomType: roomType,
        roomWidth: projectData.roomWidth,
        roomDepth: projectData.roomDepth,
        canvas: canvas.toJSON(['elementType', 'elementData', 'isRoomOutline']),
        savedAt: new Date().toISOString()
      };

      localStorage.setItem('roomDesignerProject', JSON.stringify(data));
      alert('Project saved!');
    }

    function loadProject() {
      const saved = localStorage.getItem('roomDesignerProject');
      if (saved) {
        const data = JSON.parse(saved);
        document.getElementById('project-name').value = data.name;
        projectData.roomWidth = data.roomWidth;
        projectData.roomDepth = data.roomDepth;
        document.getElementById('room-width').value = data.roomWidth;
        document.getElementById('room-depth').value = data.roomDepth;

        canvas.loadFromJSON(data.canvas, () => {
          canvas.renderAll();
          updateQuoteSummary();
        });
      }
    }

    // Load saved project on startup
    setTimeout(() => {
      const saved = localStorage.getItem('roomDesignerProject');
      if (saved && confirm('Load previously saved project?')) {
        loadProject();
      }
    }, 500);
  </script>

</body>
</html>
