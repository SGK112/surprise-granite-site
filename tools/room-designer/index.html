<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Designer Pro | Powered by Remodely.ai | Surprise Granite</title>
  <link rel="icon" href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Fabric.js for Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

  <!-- Three.js for 3D -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --gold: #f9cb00;
      --gold-dark: #d4ab00;
      --dark: #0f0f1a;
      --dark-surface: #1a1a2e;
      --dark-elevated: #252540;
      --dark-hover: #2d2d4a;
      --text: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      --border: rgba(255,255,255,0.1);
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --remodely-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--dark);
      color: var(--text);
      min-height: 100vh;
      overflow: hidden;
    }

    .app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 56px;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .logo img {
      height: 28px;
    }

    .logo-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    .powered-by {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .powered-by .remodely-badge {
      background: var(--remodely-gradient);
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 10px;
      color: white;
    }

    .project-input {
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 12px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      min-width: 200px;
    }

    .project-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .header-center {
      display: flex;
      gap: 4px;
      background: var(--dark-elevated);
      padding: 4px;
      border-radius: 8px;
    }

    .view-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .view-btn:hover {
      color: var(--text);
    }

    .view-btn.active {
      background: var(--primary);
      color: white;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      border: none;
    }

    .btn-secondary {
      background: var(--dark-elevated);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--dark-hover);
    }

    .btn-primary {
      background: var(--gold);
      color: #000;
    }

    .btn-primary:hover {
      background: var(--gold-dark);
    }

    /* Main Layout */
    .main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tool-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      padding: 12px;
    }

    .tool-btn {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--dark-elevated);
      border: 1px solid transparent;
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px;
    }

    .tool-btn:hover {
      background: var(--dark-hover);
      color: var(--text);
    }

    .tool-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .tool-btn svg {
      width: 20px;
      height: 20px;
      margin-bottom: 4px;
    }

    .tool-btn span {
      font-size: 9px;
      font-weight: 500;
    }

    .element-section {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .element-category {
      margin-bottom: 16px;
    }

    .category-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
      padding: 0 4px;
    }

    .element-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .element-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      cursor: grab;
      transition: all 0.2s;
      text-align: center;
    }

    .element-item:hover {
      background: var(--dark-hover);
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .element-item:active {
      cursor: grabbing;
    }

    .element-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 8px;
      border-radius: 6px;
    }

    .element-name {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    /* Canvas Area */
    .canvas-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--dark);
      position: relative;
    }

    .canvas-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border);
    }

    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .zoom-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .zoom-btn:hover {
      background: var(--dark-hover);
    }

    .zoom-level {
      font-size: 13px;
      color: var(--text-secondary);
      min-width: 50px;
      text-align: center;
    }

    .canvas-info {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .canvas-wrapper {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: hidden;
    }

    .canvas-container {
      background: #1e1e2e;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.3);
      position: relative;
    }

    #canvas {
      border-radius: 8px;
    }

    /* 3D View */
    #three-container {
      width: 100%;
      height: 100%;
      display: none;
    }

    #three-container.active {
      display: block;
    }

    .canvas-wrapper.hidden {
      display: none;
    }

    /* Right Panel */
    .right-panel {
      width: 280px;
      background: var(--dark-surface);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .panel-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .panel-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .room-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .input-field {
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      color: var(--text);
      font-size: 13px;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary);
    }

    select.input-field {
      cursor: pointer;
    }

    /* Properties Panel */
    .properties-empty {
      text-align: center;
      padding: 24px;
      color: var(--text-muted);
      font-size: 13px;
    }

    .property-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .property-label {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .property-value {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
    }

    .property-input {
      width: 80px;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 8px;
      color: var(--text);
      font-size: 12px;
      text-align: right;
    }

    .property-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .color-picker {
      width: 80px;
      height: 30px;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
    }

    /* Quote Panel */
    .quote-section {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .quote-items {
      flex: 1;
      overflow-y: auto;
      padding: 0 16px;
    }

    .quote-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .quote-item-name {
      color: var(--text-secondary);
    }

    .quote-item-value {
      color: var(--text);
      font-weight: 500;
    }

    .quote-total {
      padding: 16px;
      background: var(--dark-elevated);
      border-top: 1px solid var(--border);
    }

    .quote-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quote-total-label {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .quote-total-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold);
    }

    /* Context Menu */
    .context-menu {
      position: fixed;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 0;
      min-width: 180px;
      z-index: 1000;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .context-menu-item {
      padding: 10px 16px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.15s;
    }

    .context-menu-item:hover {
      background: var(--dark-hover);
      color: var(--text);
    }

    .context-menu-item.danger {
      color: var(--error);
    }

    .context-menu-item.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .context-menu-item svg {
      width: 16px;
      height: 16px;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border);
      margin: 8px 0;
    }

    .context-menu-label {
      padding: 8px 16px;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      font-weight: 600;
    }

    /* Share Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 480px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-elevated);
      border: none;
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .modal-close:hover {
      background: var(--dark-hover);
      color: var(--text);
    }

    .share-link-box {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .share-link-input {
      flex: 1;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 13px;
    }

    .share-permission {
      margin-bottom: 16px;
    }

    .permission-options {
      display: flex;
      gap: 8px;
    }

    .permission-btn {
      flex: 1;
      padding: 12px;
      background: var(--dark-elevated);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .permission-btn:hover {
      border-color: var(--primary);
    }

    .permission-btn.active {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
      color: var(--text);
    }

    .permission-btn-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .permission-btn-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    .collab-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .collab-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .collab-invite {
      display: flex;
      gap: 8px;
    }

    .collab-input {
      flex: 1;
      background: var(--dark-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 13px;
    }

    /* Upload overlay */
    .upload-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1002;
    }

    .upload-overlay.active {
      display: flex;
    }

    .upload-box {
      background: var(--dark-surface);
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 48px;
      text-align: center;
      cursor: pointer;
    }

    .upload-box:hover {
      border-color: var(--primary);
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .upload-text {
      font-size: 16px;
      color: var(--text);
      margin-bottom: 8px;
    }

    .upload-hint {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Keyboard shortcuts hint */
    .shortcuts-hint {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .shortcut {
      display: flex;
      gap: 8px;
      margin-bottom: 4px;
    }

    .shortcut:last-child {
      margin-bottom: 0;
    }

    .shortcut kbd {
      background: var(--dark-elevated);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 10px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        width: 200px;
      }
      .right-panel {
        width: 240px;
      }
    }

    @media (max-width: 768px) {
      .sidebar, .right-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="logo-group">
          <a href="/" class="logo">
            <img src="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" alt="Surprise Granite">
          </a>
          <div class="logo-divider"></div>
          <div class="powered-by">
            <span>Powered by</span>
            <span class="remodely-badge">Remodely.ai</span>
          </div>
        </div>
        <input type="text" class="project-input" id="projectName" value="Untitled Project" placeholder="Project name">
      </div>

      <div class="header-center">
        <button class="view-btn active" id="view2D" onclick="setView('2d')">2D Plan</button>
        <button class="view-btn" id="view3D" onclick="setView('3d')">3D View</button>
      </div>

      <div class="header-right">
        <button class="btn btn-secondary" onclick="openShareModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
            <polyline points="16,6 12,2 8,6"/>
            <line x1="12" y1="2" x2="12" y2="15"/>
          </svg>
          Share
        </button>
        <button class="btn btn-primary" onclick="generateQuote()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
          </svg>
          Get Quote
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main">
      <!-- Left Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">Tools</div>
        </div>
        <div class="tool-grid">
          <button class="tool-btn active" id="toolSelect" onclick="setTool('select')" title="Select (V)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
            </svg>
            <span>Select</span>
          </button>
          <button class="tool-btn" id="toolPan" onclick="setTool('pan')" title="Pan (H)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/>
              <path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/>
              <path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/>
              <path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/>
            </svg>
            <span>Pan</span>
          </button>
          <button class="tool-btn" id="toolDraw" onclick="setTool('draw')" title="Draw (D)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 19l7-7 3 3-7 7-3-3z"/>
              <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
              <path d="M2 2l7.586 7.586"/>
            </svg>
            <span>Draw</span>
          </button>
          <button class="tool-btn" id="toolMeasure" onclick="setTool('measure')" title="Measure (M)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21.3 8.7 8.7 21.3c-1 1-2.5 1-3.4 0l-2.6-2.6c-1-1-1-2.5 0-3.4L15.3 2.7c1-1 2.5-1 3.4 0l2.6 2.6c1 1 1 2.5 0 3.4Z"/>
              <path d="m7.5 10.5 2 2"/>
              <path d="m10.5 7.5 2 2"/>
              <path d="m13.5 4.5 2 2"/>
              <path d="m4.5 13.5 2 2"/>
            </svg>
            <span>Measure</span>
          </button>
        </div>

        <div class="element-section">
          <div class="element-category">
            <div class="category-title">Cabinets</div>
            <div class="element-grid">
              <div class="element-item" draggable="true" data-type="base-cabinet">
                <div class="element-icon" style="background: #8B4513;"></div>
                <div class="element-name">Base Cabinet</div>
              </div>
              <div class="element-item" draggable="true" data-type="wall-cabinet">
                <div class="element-icon" style="background: #A0522D;"></div>
                <div class="element-name">Wall Cabinet</div>
              </div>
              <div class="element-item" draggable="true" data-type="tall-cabinet">
                <div class="element-icon" style="background: #8B4513;"></div>
                <div class="element-name">Tall Cabinet</div>
              </div>
              <div class="element-item" draggable="true" data-type="island">
                <div class="element-icon" style="background: #654321;"></div>
                <div class="element-name">Island</div>
              </div>
            </div>
          </div>

          <div class="element-category">
            <div class="category-title">Surfaces</div>
            <div class="element-grid">
              <div class="element-item" draggable="true" data-type="countertop">
                <div class="element-icon" style="background: #708090;"></div>
                <div class="element-name">Countertop</div>
              </div>
              <div class="element-item" draggable="true" data-type="backsplash">
                <div class="element-icon" style="background: #B8860B;"></div>
                <div class="element-name">Backsplash</div>
              </div>
              <div class="element-item" draggable="true" data-type="flooring">
                <div class="element-icon" style="background: #D2691E;"></div>
                <div class="element-name">Flooring</div>
              </div>
              <div class="element-item" draggable="true" data-type="tile">
                <div class="element-icon" style="background: #CCC;"></div>
                <div class="element-name">Tile Area</div>
              </div>
            </div>
          </div>

          <div class="element-category">
            <div class="category-title">Appliances</div>
            <div class="element-grid">
              <div class="element-item" draggable="true" data-type="sink">
                <div class="element-icon" style="background: #C0C0C0;"></div>
                <div class="element-name">Sink</div>
              </div>
              <div class="element-item" draggable="true" data-type="stove">
                <div class="element-icon" style="background: #2F2F2F;"></div>
                <div class="element-name">Stove</div>
              </div>
              <div class="element-item" draggable="true" data-type="refrigerator">
                <div class="element-icon" style="background: #A9A9A9;"></div>
                <div class="element-name">Refrigerator</div>
              </div>
              <div class="element-item" draggable="true" data-type="dishwasher">
                <div class="element-icon" style="background: #808080;"></div>
                <div class="element-name">Dishwasher</div>
              </div>
            </div>
          </div>

          <div class="element-category">
            <div class="category-title">Structure</div>
            <div class="element-grid">
              <div class="element-item" draggable="true" data-type="door">
                <div class="element-icon" style="background: #DEB887;"></div>
                <div class="element-name">Door</div>
              </div>
              <div class="element-item" draggable="true" data-type="window">
                <div class="element-icon" style="background: #87CEEB;"></div>
                <div class="element-name">Window</div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Canvas Area -->
      <div class="canvas-area">
        <div class="canvas-toolbar">
          <div class="zoom-controls">
            <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
            <span class="zoom-level" id="zoomLevel">100%</span>
            <button class="zoom-btn" onclick="zoomIn()">+</button>
            <button class="zoom-btn" onclick="resetZoom()" title="Reset zoom">âŸ²</button>
          </div>
          <div class="canvas-info">
            <span id="canvasSize">12' Ã— 10'</span>
            <span id="elementCount">0 elements</span>
          </div>
        </div>
        <div class="canvas-wrapper" id="canvasWrapper">
          <div class="canvas-container" id="canvasContainer">
            <canvas id="canvas"></canvas>
          </div>
        </div>
        <div id="three-container"></div>
      </div>

      <!-- Right Panel -->
      <aside class="right-panel">
        <div class="panel-section">
          <div class="panel-title">Room Settings</div>
          <div class="room-grid">
            <div class="input-group">
              <label class="input-label">Room Type</label>
              <select class="input-field" id="roomType" onchange="updateRoom()">
                <option value="kitchen">Kitchen</option>
                <option value="bathroom">Bathroom</option>
                <option value="laundry">Laundry</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="input-group">
              <label class="input-label">Width (ft)</label>
              <input type="number" class="input-field" id="roomWidth" value="12" min="4" max="50" onchange="updateRoom()">
            </div>
            <div class="input-group">
              <label class="input-label">Depth (ft)</label>
              <input type="number" class="input-field" id="roomDepth" value="10" min="4" max="50" onchange="updateRoom()">
            </div>
          </div>
        </div>

        <div class="panel-section" id="propertiesPanel">
          <div class="panel-title">Properties</div>
          <div class="properties-empty" id="propertiesEmpty">
            Select an element to edit its properties
          </div>
          <div id="propertiesContent" style="display: none;">
            <div class="property-row">
              <span class="property-label">Type</span>
              <span class="property-value" id="propType">-</span>
            </div>
            <div class="property-row">
              <span class="property-label">Width (ft)</span>
              <input type="number" class="property-input" id="propWidth" step="0.5" min="0.5" max="20" onchange="updateSelectedElement()">
            </div>
            <div class="property-row">
              <span class="property-label">Height (ft)</span>
              <input type="number" class="property-input" id="propHeight" step="0.5" min="0.5" max="20" onchange="updateSelectedElement()">
            </div>
            <div class="property-row">
              <span class="property-label">Color</span>
              <input type="color" class="color-picker" id="propColor" onchange="updateSelectedElement()">
            </div>
            <div class="property-row">
              <span class="property-label">Rotation</span>
              <span class="property-value" id="propRotation">0Â°</span>
            </div>
          </div>
        </div>

        <div class="quote-section">
          <div class="panel-section">
            <div class="panel-title">Quote Summary</div>
          </div>
          <div class="quote-items" id="quoteItems">
            <div class="quote-item">
              <span class="quote-item-name">No items yet</span>
              <span class="quote-item-value">$0</span>
            </div>
          </div>
          <div class="quote-total">
            <div class="quote-total-row">
              <span class="quote-total-label">Estimated Total</span>
              <span class="quote-total-value" id="quoteTotal">$0</span>
            </div>
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Context Menu -->
  <div class="context-menu" id="contextMenu" style="display: none;">
    <div class="context-menu-label" id="contextMenuLabel">Element</div>
    <div class="context-menu-item" onclick="contextAction('rotate')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 2v6h-6"/>
        <path d="M3 12a9 9 0 0 1 15-6.7L21 8"/>
      </svg>
      Rotate 90Â°
    </div>
    <div class="context-menu-item" onclick="contextAction('duplicate')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="9" y="9" width="13" height="13" rx="2"/>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
      </svg>
      Duplicate
    </div>
    <div class="context-menu-item" onclick="contextAction('upload')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <circle cx="8.5" cy="8.5" r="1.5"/>
        <path d="M21 15l-5-5L5 21"/>
      </svg>
      Upload Image
    </div>
    <div class="context-menu-item" onclick="contextAction('lock')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="lockIcon">
        <rect x="3" y="11" width="18" height="11" rx="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <span id="lockText">Lock</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="contextAction('front')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="8" y="8" width="12" height="12" rx="2"/>
        <path d="M4 16V4h12"/>
      </svg>
      Bring to Front
    </div>
    <div class="context-menu-item" onclick="contextAction('back')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="4" y="4" width="12" height="12" rx="2"/>
        <path d="M8 20h12V8"/>
      </svg>
      Send to Back
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="contextAction('delete')">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="3 6 5 6 21 6"/>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      </svg>
      Delete
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal-overlay" id="shareModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Share Project</h3>
        <button class="modal-close" onclick="closeShareModal()">Ã—</button>
      </div>
      <div class="share-link-box">
        <input type="text" class="share-link-input" id="shareLink" value="https://surprisegranite.com/tools/room-designer?p=abc123" readonly>
        <button class="btn btn-primary" onclick="copyShareLink()">Copy</button>
      </div>
      <div class="share-permission">
        <div class="permission-options">
          <div class="permission-btn active" onclick="setSharePermission('view')">
            <div class="permission-btn-title">View Only</div>
            <div class="permission-btn-desc">Can view but not edit</div>
          </div>
          <div class="permission-btn" onclick="setSharePermission('edit')">
            <div class="permission-btn-title">Can Edit</div>
            <div class="permission-btn-desc">Full editing access</div>
          </div>
        </div>
      </div>
      <div class="collab-section">
        <div class="collab-title">Invite Collaborators</div>
        <div class="collab-invite">
          <input type="email" class="collab-input" placeholder="Enter email address">
          <button class="btn btn-secondary" onclick="inviteCollaborator()">Invite</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Overlay -->
  <div class="upload-overlay" id="uploadOverlay">
    <div class="upload-box" onclick="triggerUpload()">
      <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      <div class="upload-text">Upload Image</div>
      <div class="upload-hint">Click to select or drag and drop</div>
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display: none" onchange="handleImageUpload(event)">
  </div>

  <!-- Keyboard Shortcuts -->
  <div class="shortcuts-hint">
    <div class="shortcut"><kbd>V</kbd> Select</div>
    <div class="shortcut"><kbd>Del</kbd> Delete</div>
    <div class="shortcut"><kbd>R</kbd> Rotate</div>
    <div class="shortcut"><kbd>D</kbd> Duplicate</div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const CONFIG = {
      PIXELS_PER_FOOT: 40,
      GRID_SIZE: 20,
      PRICING: {
        'base-cabinet': 150,
        'wall-cabinet': 120,
        'tall-cabinet': 300,
        'corner-cabinet': 200,
        'island': 400,
        'countertop': 65, // per sqft
        'backsplash': 25, // per sqft
        'flooring': 8, // per sqft
        'tile': 15, // per sqft
        'sink': 350,
        'stove': 800,
        'refrigerator': 1200,
        'dishwasher': 600,
        'door': 200,
        'window': 300
      },
      ELEMENT_DEFAULTS: {
        'base-cabinet': { width: 3, height: 2, color: '#8B4513', label: 'Base Cabinet' },
        'wall-cabinet': { width: 3, height: 1.5, color: '#A0522D', label: 'Wall Cabinet' },
        'tall-cabinet': { width: 2, height: 6, color: '#8B4513', label: 'Tall Cabinet' },
        'corner-cabinet': { width: 3, height: 3, color: '#8B4513', label: 'Corner Cabinet' },
        'island': { width: 6, height: 3, color: '#654321', label: 'Island' },
        'countertop': { width: 8, height: 2, color: '#708090', label: 'Countertop' },
        'backsplash': { width: 6, height: 1.5, color: '#B8860B', label: 'Backsplash' },
        'sink': { width: 2.5, height: 1.5, color: '#C0C0C0', label: 'Sink' },
        'stove': { width: 2.5, height: 2, color: '#2F2F2F', label: 'Stove' },
        'refrigerator': { width: 3, height: 2.5, color: '#A9A9A9', label: 'Refrigerator' },
        'dishwasher': { width: 2, height: 2, color: '#808080', label: 'Dishwasher' },
        'flooring': { width: 4, height: 4, color: '#D2691E', label: 'Flooring' },
        'tile': { width: 3, height: 3, color: '#CCC', label: 'Tile Area' },
        'door': { width: 3, height: 0.5, color: '#DEB887', label: 'Door' },
        'window': { width: 4, height: 0.5, color: '#87CEEB', label: 'Window' }
      }
    };

    // ===== STATE =====
    let canvas, ctx;
    let currentTool = 'select';
    let currentView = '2d';
    let zoom = 1;
    let elements = [];
    let selectedElement = null;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let roomWidth = 12;
    let roomDepth = 10;
    let contextMenuElement = null;
    let sharePermission = 'view';

    // Three.js
    let scene, camera, renderer, controls;

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');

      updateCanvasSize();
      setupEventListeners();
      setupDragDrop();
      draw();
    }

    function updateCanvasSize() {
      const canvasWidth = roomWidth * CONFIG.PIXELS_PER_FOOT;
      const canvasHeight = roomDepth * CONFIG.PIXELS_PER_FOOT;

      canvas.width = canvasWidth;
      canvas.height = canvasHeight;

      document.getElementById('canvasSize').textContent = `${roomWidth}' Ã— ${roomDepth}'`;

      draw();
    }

    function setupEventListeners() {
      // Canvas events
      canvas.addEventListener('mousedown', onMouseDown);
      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
      canvas.addEventListener('contextmenu', onContextMenu);
      canvas.addEventListener('dblclick', onDoubleClick);

      // Keyboard
      document.addEventListener('keydown', onKeyDown);

      // Close context menu
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.context-menu')) {
          hideContextMenu();
        }
      });
    }

    function setupDragDrop() {
      const items = document.querySelectorAll('.element-item');
      items.forEach(item => {
        item.addEventListener('dragstart', onDragStart);
        item.addEventListener('dragend', onDragEnd);
      });

      const canvasContainer = document.getElementById('canvasContainer');
      canvasContainer.addEventListener('dragover', onDragOver);
      canvasContainer.addEventListener('drop', onDrop);
    }

    // ===== DRAWING =====
    function draw() {
      if (!ctx) return;

      // Clear
      ctx.fillStyle = '#1e1e2e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw grid
      drawGrid();

      // Draw room border
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 2;
      ctx.strokeRect(0, 0, canvas.width, canvas.height);

      // Draw elements
      elements.forEach((el, index) => {
        drawElement(el, el === selectedElement);
      });

      // Update element count
      document.getElementById('elementCount').textContent = `${elements.length} element${elements.length !== 1 ? 's' : ''}`;

      // Update quote
      calculateQuote();
    }

    function drawGrid() {
      ctx.strokeStyle = 'rgba(255,255,255,0.05)';
      ctx.lineWidth = 1;

      // Vertical lines
      for (let x = 0; x <= canvas.width; x += CONFIG.GRID_SIZE) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }

      // Horizontal lines
      for (let y = 0; y <= canvas.height; y += CONFIG.GRID_SIZE) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }

      // Foot markers
      ctx.fillStyle = 'rgba(255,255,255,0.3)';
      ctx.font = '10px Inter';
      for (let x = CONFIG.PIXELS_PER_FOOT; x < canvas.width; x += CONFIG.PIXELS_PER_FOOT) {
        ctx.fillText(`${x / CONFIG.PIXELS_PER_FOOT}'`, x - 8, 12);
      }
      for (let y = CONFIG.PIXELS_PER_FOOT; y < canvas.height; y += CONFIG.PIXELS_PER_FOOT) {
        ctx.fillText(`${y / CONFIG.PIXELS_PER_FOOT}'`, 4, y + 4);
      }
    }

    function drawElement(el, isSelected) {
      const x = el.x;
      const y = el.y;
      const w = el.width * CONFIG.PIXELS_PER_FOOT;
      const h = el.height * CONFIG.PIXELS_PER_FOOT;

      ctx.save();

      // Apply rotation
      ctx.translate(x + w/2, y + h/2);
      ctx.rotate((el.rotation || 0) * Math.PI / 180);
      ctx.translate(-(x + w/2), -(y + h/2));

      // Draw element background
      if (el.image) {
        ctx.drawImage(el.image, x, y, w, h);
      } else {
        ctx.fillStyle = el.color;
        ctx.fillRect(x, y, w, h);
      }

      // Draw border
      ctx.strokeStyle = isSelected ? '#6366f1' : 'rgba(255,255,255,0.2)';
      ctx.lineWidth = isSelected ? 2 : 1;
      ctx.strokeRect(x, y, w, h);

      // Draw label
      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      ctx.font = '11px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(el.label, x + w/2, y + h/2 + 4);

      // Draw dimensions
      ctx.fillStyle = 'rgba(255,255,255,0.5)';
      ctx.font = '9px Inter';
      ctx.fillText(`${el.width}' Ã— ${el.height}'`, x + w/2, y + h/2 + 16);

      // Draw selection handles
      if (isSelected) {
        const handleSize = 8;
        ctx.fillStyle = '#6366f1';

        // Corner handles
        ctx.fillRect(x - handleSize/2, y - handleSize/2, handleSize, handleSize);
        ctx.fillRect(x + w - handleSize/2, y - handleSize/2, handleSize, handleSize);
        ctx.fillRect(x - handleSize/2, y + h - handleSize/2, handleSize, handleSize);
        ctx.fillRect(x + w - handleSize/2, y + h - handleSize/2, handleSize, handleSize);

        // Lock indicator
        if (el.locked) {
          ctx.fillStyle = 'rgba(239, 68, 68, 0.8)';
          ctx.fillRect(x + w - 20, y + 4, 16, 16);
          ctx.fillStyle = '#fff';
          ctx.font = '10px Inter';
          ctx.fillText('ðŸ”’', x + w - 12, y + 15);
        }
      }

      ctx.restore();
    }

    // ===== MOUSE EVENTS =====
    function onMouseDown(e) {
      if (currentTool !== 'select') return;

      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoom;
      const y = (e.clientY - rect.top) / zoom;

      // Find clicked element (reverse order for top elements first)
      const clicked = [...elements].reverse().find(el => isPointInElement(x, y, el));

      if (clicked) {
        if (clicked.locked) {
          selectedElement = clicked;
          updateProperties();
          draw();
          return;
        }

        selectedElement = clicked;
        isDragging = true;
        dragOffset = { x: x - clicked.x, y: y - clicked.y };
        updateProperties();
      } else {
        selectedElement = null;
        updateProperties();
      }

      draw();
    }

    function onMouseMove(e) {
      if (!isDragging || !selectedElement || selectedElement.locked) return;

      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoom;
      const y = (e.clientY - rect.top) / zoom;

      // Snap to grid
      const snapX = Math.round((x - dragOffset.x) / CONFIG.GRID_SIZE) * CONFIG.GRID_SIZE;
      const snapY = Math.round((y - dragOffset.y) / CONFIG.GRID_SIZE) * CONFIG.GRID_SIZE;

      selectedElement.x = snapX;
      selectedElement.y = snapY;

      draw();
    }

    function onMouseUp() {
      isDragging = false;
    }

    function onContextMenu(e) {
      e.preventDefault();

      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoom;
      const y = (e.clientY - rect.top) / zoom;

      const clicked = [...elements].reverse().find(el => isPointInElement(x, y, el));

      if (clicked) {
        selectedElement = clicked;
        contextMenuElement = clicked;
        showContextMenu(e.clientX, e.clientY, clicked);
        draw();
      }
    }

    function onDoubleClick(e) {
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoom;
      const y = (e.clientY - rect.top) / zoom;

      const clicked = [...elements].reverse().find(el => isPointInElement(x, y, el));

      if (clicked) {
        const newLabel = prompt('Enter label:', clicked.label);
        if (newLabel) {
          clicked.label = newLabel;
          draw();
        }
      }
    }

    function isPointInElement(x, y, el) {
      const w = el.width * CONFIG.PIXELS_PER_FOOT;
      const h = el.height * CONFIG.PIXELS_PER_FOOT;
      return x >= el.x && x <= el.x + w && y >= el.y && y <= el.y + h;
    }

    // ===== KEYBOARD EVENTS =====
    function onKeyDown(e) {
      if (e.target.tagName === 'INPUT') return;

      switch(e.key.toLowerCase()) {
        case 'v':
          setTool('select');
          break;
        case 'delete':
        case 'backspace':
          if (selectedElement && !selectedElement.locked) {
            elements = elements.filter(el => el !== selectedElement);
            selectedElement = null;
            updateProperties();
            draw();
          }
          break;
        case 'r':
          if (selectedElement && !selectedElement.locked) {
            selectedElement.rotation = ((selectedElement.rotation || 0) + 90) % 360;
            updateProperties();
            draw();
          }
          break;
        case 'd':
          if (e.ctrlKey || e.metaKey) {
            e.preventDefault();
            if (selectedElement) {
              duplicateElement(selectedElement);
            }
          } else {
            setTool('draw');
          }
          break;
        case 'escape':
          selectedElement = null;
          hideContextMenu();
          updateProperties();
          draw();
          break;
      }
    }

    // ===== DRAG & DROP =====
    function onDragStart(e) {
      e.dataTransfer.setData('element-type', e.target.dataset.type);
      e.target.style.opacity = '0.5';
    }

    function onDragEnd(e) {
      e.target.style.opacity = '1';
    }

    function onDragOver(e) {
      e.preventDefault();
    }

    function onDrop(e) {
      e.preventDefault();

      const type = e.dataTransfer.getData('element-type');
      if (!type) return;

      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) / zoom;
      const y = (e.clientY - rect.top) / zoom;

      createElement(type, x, y);
    }

    function createElement(type, x, y) {
      const defaults = CONFIG.ELEMENT_DEFAULTS[type];
      if (!defaults) return;

      const element = {
        id: Date.now() + Math.random(),
        type: type,
        x: Math.round(x / CONFIG.GRID_SIZE) * CONFIG.GRID_SIZE,
        y: Math.round(y / CONFIG.GRID_SIZE) * CONFIG.GRID_SIZE,
        width: defaults.width,
        height: defaults.height,
        color: defaults.color,
        label: defaults.label,
        rotation: 0,
        locked: false,
        image: null
      };

      elements.push(element);
      selectedElement = element;
      updateProperties();
      draw();
    }

    function duplicateElement(el) {
      const newEl = {
        ...el,
        id: Date.now() + Math.random(),
        x: el.x + CONFIG.GRID_SIZE * 2,
        y: el.y + CONFIG.GRID_SIZE * 2,
        locked: false
      };
      elements.push(newEl);
      selectedElement = newEl;
      updateProperties();
      draw();
    }

    // ===== CONTEXT MENU =====
    function showContextMenu(x, y, element) {
      const menu = document.getElementById('contextMenu');
      menu.style.display = 'block';
      menu.style.left = x + 'px';
      menu.style.top = y + 'px';

      document.getElementById('contextMenuLabel').textContent = element.label;
      document.getElementById('lockText').textContent = element.locked ? 'Unlock' : 'Lock';
    }

    function hideContextMenu() {
      document.getElementById('contextMenu').style.display = 'none';
      contextMenuElement = null;
    }

    function contextAction(action) {
      if (!contextMenuElement) return;

      switch(action) {
        case 'rotate':
          if (!contextMenuElement.locked) {
            contextMenuElement.rotation = ((contextMenuElement.rotation || 0) + 90) % 360;
          }
          break;
        case 'duplicate':
          duplicateElement(contextMenuElement);
          break;
        case 'upload':
          openUploadOverlay();
          break;
        case 'lock':
          contextMenuElement.locked = !contextMenuElement.locked;
          break;
        case 'front':
          elements = elements.filter(el => el !== contextMenuElement);
          elements.push(contextMenuElement);
          break;
        case 'back':
          elements = elements.filter(el => el !== contextMenuElement);
          elements.unshift(contextMenuElement);
          break;
        case 'delete':
          if (!contextMenuElement.locked) {
            elements = elements.filter(el => el !== contextMenuElement);
            if (selectedElement === contextMenuElement) {
              selectedElement = null;
              updateProperties();
            }
          }
          break;
      }

      hideContextMenu();
      draw();
    }

    // ===== TOOLS =====
    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById('tool' + tool.charAt(0).toUpperCase() + tool.slice(1))?.classList.add('active');

      canvas.style.cursor = tool === 'pan' ? 'grab' : (tool === 'draw' ? 'crosshair' : 'default');
    }

    // ===== VIEW TOGGLE =====
    function setView(view) {
      currentView = view;

      document.getElementById('view2D').classList.toggle('active', view === '2d');
      document.getElementById('view3D').classList.toggle('active', view === '3d');

      const canvasWrapper = document.getElementById('canvasWrapper');
      const threeContainer = document.getElementById('three-container');

      if (view === '3d') {
        canvasWrapper.classList.add('hidden');
        threeContainer.classList.add('active');
        init3D();
        render3D();
      } else {
        canvasWrapper.classList.remove('hidden');
        threeContainer.classList.remove('active');
      }
    }

    // ===== 3D VIEW =====
    function init3D() {
      if (scene) return; // Already initialized

      const container = document.getElementById('three-container');
      const width = container.clientWidth;
      const height = container.clientHeight;

      // Scene
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1e1e2e);

      // Camera
      camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
      camera.position.set(roomWidth * 0.8, roomDepth * 0.8, roomWidth * 0.8);
      camera.lookAt(0, 0, 0);

      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(width, height);
      renderer.shadowMap.enabled = true;
      container.appendChild(renderer.domElement);

      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambient);

      const directional = new THREE.DirectionalLight(0xffffff, 0.8);
      directional.position.set(10, 20, 10);
      directional.castShadow = true;
      scene.add(directional);

      // Floor
      const floorGeom = new THREE.PlaneGeometry(roomWidth, roomDepth);
      const floorMat = new THREE.MeshStandardMaterial({ color: 0x2a2a3a, side: THREE.DoubleSide });
      const floor = new THREE.Mesh(floorGeom, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.receiveShadow = true;
      scene.add(floor);

      // Grid
      const grid = new THREE.GridHelper(Math.max(roomWidth, roomDepth), Math.max(roomWidth, roomDepth), 0x444444, 0x333333);
      scene.add(grid);

      // Walls (wireframe)
      const wallMat = new THREE.MeshBasicMaterial({ color: 0x444444, wireframe: true });

      // Back wall
      const backWall = new THREE.Mesh(new THREE.PlaneGeometry(roomWidth, 8), wallMat);
      backWall.position.set(0, 4, -roomDepth/2);
      scene.add(backWall);

      // Left wall
      const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(roomDepth, 8), wallMat);
      leftWall.position.set(-roomWidth/2, 4, 0);
      leftWall.rotation.y = Math.PI / 2;
      scene.add(leftWall);

      // Handle resize
      window.addEventListener('resize', () => {
        const w = container.clientWidth;
        const h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });
    }

    function render3D() {
      if (!scene || currentView !== '3d') return;

      // Clear existing element meshes (keep floor, grid, walls, lights)
      scene.children = scene.children.filter(child =>
        child.type === 'AmbientLight' ||
        child.type === 'DirectionalLight' ||
        child.type === 'GridHelper' ||
        child.userData.isStatic
      );

      // Add floor back
      const floorGeom = new THREE.PlaneGeometry(roomWidth, roomDepth);
      const floorMat = new THREE.MeshStandardMaterial({ color: 0x2a2a3a, side: THREE.DoubleSide });
      const floor = new THREE.Mesh(floorGeom, floorMat);
      floor.rotation.x = -Math.PI / 2;
      floor.receiveShadow = true;
      floor.userData.isStatic = true;
      scene.add(floor);

      // Add elements as 3D boxes
      elements.forEach(el => {
        const w = el.width;
        const d = el.height;
        const h = el.type.includes('cabinet') ? (el.type === 'tall-cabinet' ? 6 : 3) : 1;

        const geometry = new THREE.BoxGeometry(w, h, d);
        const material = new THREE.MeshStandardMaterial({ color: el.color });
        const mesh = new THREE.Mesh(geometry, material);

        // Convert 2D position to 3D
        const posX = (el.x / CONFIG.PIXELS_PER_FOOT) - roomWidth/2 + w/2;
        const posZ = (el.y / CONFIG.PIXELS_PER_FOOT) - roomDepth/2 + d/2;
        const posY = h/2;

        mesh.position.set(posX, posY, posZ);
        mesh.rotation.y = (el.rotation || 0) * Math.PI / 180;
        mesh.castShadow = true;
        mesh.receiveShadow = true;

        scene.add(mesh);
      });

      // Animate
      function animate() {
        if (currentView !== '3d') return;
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
    }

    // ===== ZOOM =====
    function zoomIn() {
      zoom = Math.min(zoom + 0.1, 2);
      updateZoom();
    }

    function zoomOut() {
      zoom = Math.max(zoom - 0.1, 0.5);
      updateZoom();
    }

    function resetZoom() {
      zoom = 1;
      updateZoom();
    }

    function updateZoom() {
      document.getElementById('zoomLevel').textContent = Math.round(zoom * 100) + '%';
      document.getElementById('canvasContainer').style.transform = `scale(${zoom})`;
    }

    // ===== ROOM SETTINGS =====
    function updateRoom() {
      roomWidth = parseInt(document.getElementById('roomWidth').value) || 12;
      roomDepth = parseInt(document.getElementById('roomDepth').value) || 10;
      updateCanvasSize();

      if (currentView === '3d') {
        scene = null;
        document.getElementById('three-container').innerHTML = '';
        init3D();
        render3D();
      }
    }

    // ===== PROPERTIES PANEL =====
    function updateProperties() {
      const empty = document.getElementById('propertiesEmpty');
      const content = document.getElementById('propertiesContent');

      if (selectedElement) {
        empty.style.display = 'none';
        content.style.display = 'block';

        document.getElementById('propType').textContent = selectedElement.label;
        document.getElementById('propWidth').value = selectedElement.width;
        document.getElementById('propHeight').value = selectedElement.height;
        document.getElementById('propColor').value = selectedElement.color;
        document.getElementById('propRotation').textContent = (selectedElement.rotation || 0) + 'Â°';
      } else {
        empty.style.display = 'block';
        content.style.display = 'none';
      }
    }

    function updateSelectedElement() {
      if (!selectedElement || selectedElement.locked) return;

      selectedElement.width = parseFloat(document.getElementById('propWidth').value) || 1;
      selectedElement.height = parseFloat(document.getElementById('propHeight').value) || 1;
      selectedElement.color = document.getElementById('propColor').value;

      draw();
    }

    // ===== QUOTE CALCULATION =====
    function calculateQuote() {
      const items = {};
      let total = 0;

      elements.forEach(el => {
        const price = CONFIG.PRICING[el.type] || 0;
        let cost = 0;

        if (['countertop', 'backsplash', 'flooring', 'tile'].includes(el.type)) {
          // Price per sqft
          const sqft = el.width * el.height;
          cost = sqft * price;
        } else {
          // Fixed price per unit
          cost = price;
        }

        if (!items[el.type]) {
          items[el.type] = { count: 0, total: 0, label: el.label };
        }
        items[el.type].count++;
        items[el.type].total += cost;
        total += cost;
      });

      // Update quote display
      const quoteItems = document.getElementById('quoteItems');
      if (Object.keys(items).length === 0) {
        quoteItems.innerHTML = '<div class="quote-item"><span class="quote-item-name">No items yet</span><span class="quote-item-value">$0</span></div>';
      } else {
        quoteItems.innerHTML = Object.entries(items).map(([type, data]) => `
          <div class="quote-item">
            <span class="quote-item-name">${data.label} (${data.count})</span>
            <span class="quote-item-value">$${data.total.toLocaleString()}</span>
          </div>
        `).join('');
      }

      document.getElementById('quoteTotal').textContent = '$' + total.toLocaleString();
    }

    function generateQuote() {
      const projectName = document.getElementById('projectName').value;
      const roomType = document.getElementById('roomType').value;

      let quoteText = `QUOTE: ${projectName}\n`;
      quoteText += `Room: ${roomType} (${roomWidth}' Ã— ${roomDepth}')\n`;
      quoteText += `========================\n\n`;

      elements.forEach(el => {
        quoteText += `${el.label}: ${el.width}' Ã— ${el.height}'\n`;
      });

      quoteText += `\n========================\n`;
      quoteText += `Total: ${document.getElementById('quoteTotal').textContent}\n`;

      alert(quoteText);
    }

    // ===== SHARE MODAL =====
    function openShareModal() {
      document.getElementById('shareModal').classList.add('active');

      // Generate share link
      const token = Math.random().toString(36).substring(2, 14);
      document.getElementById('shareLink').value = `https://surprisegranite.com/tools/room-designer?p=${token}`;
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('active');
    }

    function copyShareLink() {
      const input = document.getElementById('shareLink');
      input.select();
      document.execCommand('copy');
      alert('Link copied!');
    }

    function setSharePermission(perm) {
      sharePermission = perm;
      document.querySelectorAll('.permission-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(perm));
      });
    }

    function inviteCollaborator() {
      const email = document.querySelector('.collab-input').value;
      if (email) {
        alert(`Invitation sent to ${email}`);
        document.querySelector('.collab-input').value = '';
      }
    }

    // ===== IMAGE UPLOAD =====
    function openUploadOverlay() {
      document.getElementById('uploadOverlay').classList.add('active');
    }

    function closeUploadOverlay() {
      document.getElementById('uploadOverlay').classList.remove('active');
    }

    function triggerUpload() {
      document.getElementById('fileInput').click();
    }

    function handleImageUpload(e) {
      const file = e.target.files[0];
      if (!file || !contextMenuElement) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          contextMenuElement.image = img;
          draw();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);

      closeUploadOverlay();
      e.target.value = '';
    }

    // Close upload overlay on click outside
    document.getElementById('uploadOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closeUploadOverlay();
      }
    });
  </script>
</body>
</html>
