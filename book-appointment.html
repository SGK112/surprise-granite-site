<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Book an Appointment | Free Estimates | Surprise Granite Phoenix AZ</title>
  <link rel="canonical" href="https://www.surprisegranite.com/book-appointment"/>
  <meta name="description" content="Book your free countertop consultation - in-home estimate, showroom visit, or phone consultation. Easy online scheduling with instant confirmation."/>
  <meta name="keywords" content="book appointment countertops Phoenix, schedule estimate Arizona, free consultation granite, showroom visit Surprise"/>
  <meta name="robots" content="index, follow"/>
  <meta name="author" content="Surprise Granite"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Book an Appointment | Surprise Granite"/>
  <meta property="og:description" content="Schedule your free countertop consultation - in-home, showroom, or phone."/>
  <meta property="og:url" content="https://www.surprisegranite.com/book-appointment"/>
  <meta property="og:site_name" content="Surprise Granite"/>
  <meta name="twitter:card" content="summary"/>

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Service",
    "serviceType": "Appointment Booking",
    "name": "Free Consultation Booking",
    "description": "Book a free consultation for countertops and remodeling - in-home estimates, showroom visits, or phone consultations.",
    "url": "https://www.surprisegranite.com/book-appointment",
    "provider": {
      "@type": "LocalBusiness",
      "name": "Surprise Granite",
      "telephone": "+1-602-833-3189",
      "priceRange": "Free"
    },
    "areaServed": ["Phoenix", "Scottsdale", "Surprise", "Glendale", "Peoria", "Mesa"],
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "description": "Free consultation and estimate"
    }
  }
  </script>

  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Unified Navigation -->
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260131">
  <script defer src="/js/unified-nav.js?v=20260131"></script>

  <style>
    :root {
      --gold: #f9cb00;
      --gold-dark: #cca600;
      --dark: #0f0f1a;
      --dark-elevated: #1a1a2e;
      --surface: #16213e;
      --surface-elevated: #1f2b47;
      --border: rgba(255,255,255,0.1);
      --border-gold: rgba(249, 203, 0, 0.3);
      --text: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-muted: rgba(255,255,255,0.5);
      --success: #22c55e;
      --success-light: rgba(34, 197, 94, 0.15);
      --error: #ef4444;
      --nav-height: 155px;
    }

    @media (max-width: 991px) {
      :root { --nav-height: 64px; }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: linear-gradient(135deg, var(--dark) 0%, var(--dark-elevated) 50%, var(--surface) 100%);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      padding-top: var(--nav-height);
      -webkit-font-smoothing: antialiased;
    }

    /* Page Container */
    .booking-page {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 24px 100px;
    }

    /* Header Section */
    .booking-header {
      text-align: center;
      margin-bottom: 48px;
    }

    .booking-header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #fff, #e0e0e0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .booking-header p {
      font-size: 1.1rem;
      color: var(--text-secondary);
      max-width: 500px;
      margin: 0 auto;
    }

    /* Progress Stepper */
    .progress-stepper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0;
      margin-bottom: 48px;
      padding: 0 20px;
    }

    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .progress-step-circle {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--surface);
      border: 3px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      color: var(--text-muted);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .progress-step.active .progress-step-circle {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border-color: var(--gold);
      color: var(--dark);
      transform: scale(1.1);
      box-shadow: 0 0 30px rgba(249, 203, 0, 0.4);
    }

    .progress-step.completed .progress-step-circle {
      background: var(--success);
      border-color: var(--success);
      color: #fff;
    }

    .progress-step.completed .progress-step-circle svg {
      width: 24px;
      height: 24px;
    }

    .progress-step-label {
      margin-top: 12px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      transition: color 0.3s;
    }

    .progress-step.active .progress-step-label,
    .progress-step.completed .progress-step-label {
      color: var(--text);
    }

    .progress-connector {
      width: 60px;
      height: 4px;
      background: var(--border);
      margin: 0 8px;
      margin-bottom: 32px;
      border-radius: 2px;
      transition: background 0.4s;
    }

    .progress-connector.active {
      background: linear-gradient(90deg, var(--gold), var(--gold-dark));
    }

    /* Form Card */
    .booking-card {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 40px;
      position: relative;
      overflow: hidden;
    }

    .booking-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--gold), var(--gold-dark), var(--gold));
    }

    /* Sections */
    .booking-section {
      display: none;
      animation: fadeSlideIn 0.5s ease;
    }

    .booking-section.active {
      display: block;
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .section-title {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--text);
    }

    .section-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    /* Service Type Cards */
    .service-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    @media (max-width: 600px) {
      .service-grid { grid-template-columns: 1fr; }
    }

    .service-card {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .service-card:hover {
      border-color: var(--border-gold);
      background: rgba(249, 203, 0, 0.05);
      transform: translateY(-4px);
    }

    .service-card.selected {
      border-color: var(--gold);
      background: rgba(249, 203, 0, 0.1);
      box-shadow: 0 0 30px rgba(249, 203, 0, 0.2);
    }

    .service-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      background: rgba(249, 203, 0, 0.1);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s;
    }

    .service-card.selected .service-icon {
      transform: scale(1.1);
      background: rgba(249, 203, 0, 0.2);
    }

    .service-icon svg {
      width: 32px;
      height: 32px;
      stroke: var(--gold);
    }

    .service-name {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--text);
    }

    .service-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Calendar Styles */
    .calendar-wrapper {
      background: var(--surface);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 32px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .calendar-month-year {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .calendar-nav {
      display: flex;
      gap: 8px;
    }

    .calendar-nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .calendar-nav-btn:hover:not(:disabled) {
      background: var(--surface-elevated);
      border-color: var(--gold);
    }

    .calendar-nav-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekday {
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px;
      text-transform: uppercase;
    }

    .calendar-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .calendar-day {
      aspect-ratio: 1;
      min-height: 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface-elevated);
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .calendar-day:hover:not(:disabled):not(.selected) {
      background: rgba(249, 203, 0, 0.15);
      border-color: var(--gold);
    }

    .calendar-day.today {
      border: 2px solid var(--gold);
      background: rgba(249, 203, 0, 0.1);
    }

    .calendar-day.selected {
      background: var(--gold);
      color: var(--dark);
      font-weight: 700;
      border-color: var(--gold);
    }

    .calendar-day:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: var(--surface);
    }

    .calendar-day.other-month {
      opacity: 0.2;
      background: transparent;
      border-color: transparent;
      cursor: default;
    }

    .calendar-day .availability-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--success);
      position: absolute;
      bottom: 6px;
    }

    .calendar-day.limited .availability-dot {
      background: #f59e0b;
    }

    .calendar-day.busy .availability-dot {
      background: var(--error);
    }

    .calendar-legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      margin-top: 16px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .legend-dot.available { background: var(--success); }
    .legend-dot.limited { background: #f59e0b; }

    /* Time Slots */
    .time-section {
      display: none;
      margin-top: 32px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }

    .time-section.visible {
      display: block;
    }

    .time-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .time-section-title span {
      color: var(--gold);
    }

    .time-period {
      margin-bottom: 24px;
    }

    .time-period-label {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .time-period-label svg {
      width: 16px;
      height: 16px;
      stroke: var(--gold);
    }

    .time-slots-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }

    .time-slot {
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .time-slot:hover:not(.selected):not(:disabled) {
      border-color: var(--gold);
      background: rgba(249, 203, 0, 0.1);
    }

    .time-slot.selected {
      background: var(--gold);
      color: var(--dark);
      border-color: var(--gold);
      font-weight: 600;
    }

    .time-slot:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Contact Form */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .form-label .required {
      color: var(--error);
    }

    .form-input,
    .form-select,
    .form-textarea {
      padding: 16px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.3s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--gold);
      background: rgba(249, 203, 0, 0.05);
      box-shadow: 0 0 0 4px rgba(249, 203, 0, 0.15);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' fill='none' stroke='%23cca600' stroke-width='2'%3E%3Cpath d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
    }

    .form-select option {
      background: var(--dark);
      color: var(--text);
    }

    /* Summary Section */
    .summary-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .summary-header {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    .summary-header svg {
      color: var(--gold);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .summary-value {
      font-weight: 600;
      text-align: right;
    }

    /* Navigation Buttons */
    .booking-buttons {
      display: flex;
      gap: 16px;
      margin-top: 32px;
    }

    .btn {
      flex: 1;
      padding: 18px 32px;
      font-size: 1rem;
      font-weight: 700;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      color: var(--dark);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(249, 203, 0, 0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    /* Success Screen */
    .success-section {
      text-align: center;
      padding: 40px 20px;
    }

    .success-icon-wrapper {
      width: 100px;
      height: 100px;
      background: linear-gradient(135deg, var(--success), #16a34a);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 28px;
      animation: successPop 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes successPop {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); opacity: 1; }
    }

    .success-icon-wrapper svg {
      width: 50px;
      height: 50px;
      stroke: #fff;
      stroke-width: 3;
    }

    .success-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 12px;
      background: linear-gradient(135deg, var(--success), #4ade80);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .success-message {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 32px;
      max-width: 450px;
      margin-left: auto;
      margin-right: auto;
    }

    .success-details {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      max-width: 450px;
      margin: 0 auto 32px;
      text-align: left;
    }

    .success-detail-row {
      display: flex;
      gap: 16px;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
      align-items: flex-start;
    }

    .success-detail-row:last-child {
      border-bottom: none;
    }

    .success-detail-icon {
      width: 44px;
      height: 44px;
      background: rgba(249, 203, 0, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .success-detail-icon svg {
      width: 22px;
      height: 22px;
      stroke: var(--gold);
    }

    .success-detail-text {
      flex: 1;
    }

    .success-detail-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .success-detail-value {
      font-weight: 600;
      font-size: 0.95rem;
    }

    /* Add to Calendar */
    .calendar-links {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 32px;
    }

    .calendar-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .calendar-link:hover {
      background: var(--surface-elevated);
      border-color: var(--gold);
    }

    .calendar-link svg {
      width: 18px;
      height: 18px;
    }

    .success-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .success-actions .btn {
      flex: 0 1 auto;
      padding: 16px 32px;
      text-decoration: none;
    }

    /* Loading Spinner */
    .spinner {
      width: 22px;
      height: 22px;
      border: 3px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Availability Loading */
    .availability-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
      color: var(--text-muted);
    }

    /* Responsive */
    @media (max-width: 600px) {
      .booking-page { padding: 24px 16px 80px; }
      .booking-card { padding: 24px 20px; }
      .booking-header h1 { font-size: 1.8rem; }
      .section-title { font-size: 1.4rem; }
      .progress-step-label { font-size: 0.7rem; }
      .progress-connector { width: 30px; }
      .calendar-legend { gap: 16px; font-size: 0.7rem; }
    }

    /* Footer spacing */
    .booking-footer {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .booking-footer a {
      color: var(--gold);
      text-decoration: none;
    }
  </style>
</head>
<body>
  <main class="booking-page">
    <!-- Header -->
    <header class="booking-header">
      <h1>Book Your Appointment</h1>
      <p>Schedule a free consultation with our countertop experts. Choose your preferred service type, date, and time.</p>
    </header>

    <!-- Progress Stepper -->
    <div class="progress-stepper">
      <div class="progress-step active" data-step="1">
        <div class="progress-step-circle">1</div>
        <span class="progress-step-label">Service</span>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step" data-step="2">
        <div class="progress-step-circle">2</div>
        <span class="progress-step-label">Date</span>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step" data-step="3">
        <div class="progress-step-circle">3</div>
        <span class="progress-step-label">Time</span>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step" data-step="4">
        <div class="progress-step-circle">4</div>
        <span class="progress-step-label">Details</span>
      </div>
      <div class="progress-connector"></div>
      <div class="progress-step" data-step="5">
        <div class="progress-step-circle">5</div>
        <span class="progress-step-label">Confirm</span>
      </div>
    </div>

    <!-- Booking Card -->
    <div class="booking-card">
      <!-- Step 1: Service Type -->
      <section class="booking-section active" id="step1">
        <h2 class="section-title">Choose Your Service</h2>
        <p class="section-subtitle">Select the type of consultation that works best for you</p>

        <div class="service-grid">
          <div class="service-card" data-service="in-home">
            <div class="service-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
              </svg>
            </div>
            <div class="service-name">In-Home Estimate</div>
            <div class="service-desc">We come to you for precise measurements and personalized recommendations</div>
          </div>

          <div class="service-card" data-service="phone">
            <div class="service-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
              </svg>
            </div>
            <div class="service-name">Phone Consultation</div>
            <div class="service-desc">Quick answers to your questions and preliminary pricing discussion</div>
          </div>
        </div>

        <input type="hidden" id="selectedService" value="">

        <div class="booking-buttons">
          <button class="btn btn-primary" id="toStep2" disabled>
            Continue
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </section>

      <!-- Step 2: Date Selection -->
      <section class="booking-section" id="step2">
        <h2 class="section-title">Pick a Date</h2>
        <p class="section-subtitle">Select an available date for your <span id="serviceTypeText">appointment</span></p>

        <div class="calendar-wrapper">
          <div class="calendar-header">
            <span class="calendar-month-year" id="calendarMonthYear"></span>
            <div class="calendar-nav">
              <button class="calendar-nav-btn" id="prevMonth" aria-label="Previous month">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M15 18l-6-6 6-6"/>
                </svg>
              </button>
              <button class="calendar-nav-btn" id="nextMonth" aria-label="Next month">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M9 18l6-6-6-6"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="calendar-weekdays">
            <div class="calendar-weekday">Sun</div>
            <div class="calendar-weekday">Mon</div>
            <div class="calendar-weekday">Tue</div>
            <div class="calendar-weekday">Wed</div>
            <div class="calendar-weekday">Thu</div>
            <div class="calendar-weekday">Fri</div>
            <div class="calendar-weekday">Sat</div>
          </div>
          <div class="calendar-days" id="calendarDays"></div>
          <div class="calendar-legend">
            <div class="legend-item"><div class="legend-dot available"></div> Available</div>
            <div class="legend-item"><div class="legend-dot limited"></div> Limited</div>
          </div>
        </div>

        <input type="hidden" id="selectedDate" value="">

        <div class="booking-buttons">
          <button class="btn btn-secondary" id="backToStep1">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
          <button class="btn btn-primary" id="toStep3" disabled>
            Continue
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </section>

      <!-- Step 3: Time Selection -->
      <section class="booking-section" id="step3">
        <h2 class="section-title">Choose a Time</h2>
        <p class="section-subtitle">Available times for <span id="selectedDateText">your selected date</span></p>

        <div class="time-period">
          <div class="time-period-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            Morning (8:00 AM - 12:00 PM)
          </div>
          <div class="time-slots-grid" id="morningSlots"></div>
        </div>

        <div class="time-period">
          <div class="time-period-label">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="4"/>
              <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
            </svg>
            Afternoon (12:00 PM - 5:00 PM)
          </div>
          <div class="time-slots-grid" id="afternoonSlots"></div>
        </div>

        <input type="hidden" id="selectedTime" value="">

        <div class="booking-buttons">
          <button class="btn btn-secondary" id="backToStep2">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
          <button class="btn btn-primary" id="toStep4" disabled>
            Continue
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </section>

      <!-- Step 4: Contact Info -->
      <section class="booking-section" id="step4">
        <h2 class="section-title">Your Information</h2>
        <p class="section-subtitle">Please provide your contact details so we can confirm your appointment</p>

        <div class="summary-card">
          <div class="summary-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Appointment Details
          </div>
          <div class="summary-row">
            <span class="summary-label">Service</span>
            <span class="summary-value" id="summaryService">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Date</span>
            <span class="summary-value" id="summaryDate">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Time</span>
            <span class="summary-value" id="summaryTime">-</span>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Full Name <span class="required">*</span></label>
            <input type="text" class="form-input" id="inputName" placeholder="John Smith" required>
          </div>
          <div class="form-group">
            <label class="form-label">Phone Number <span class="required">*</span></label>
            <input type="tel" class="form-input" id="inputPhone" placeholder="(602) 555-1234" required>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Email Address <span class="required">*</span></label>
            <input type="email" class="form-input" id="inputEmail" placeholder="john@example.com" required>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Street Address <span class="required">*</span></label>
            <input type="text" class="form-input" id="inputAddress" placeholder="123 Main St, Surprise, AZ 85374" required>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Project Details <span style="color: var(--text-muted);">(optional)</span></label>
            <textarea class="form-textarea" id="inputDetails" placeholder="Tell us about your project - material preferences, approximate size, special requirements..."></textarea>
          </div>
        </div>

        <div class="booking-buttons">
          <button class="btn btn-secondary" id="backToStep3">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
          <button class="btn btn-primary" id="toStep5">
            Review & Confirm
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M5 12h14M12 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </section>

      <!-- Step 5: Confirmation -->
      <section class="booking-section" id="step5">
        <h2 class="section-title">Confirm Your Booking</h2>
        <p class="section-subtitle">Please review your appointment details before confirming</p>

        <div class="summary-card">
          <div class="summary-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            Booking Summary
          </div>
          <div class="summary-row">
            <span class="summary-label">Service Type</span>
            <span class="summary-value" id="confirmService">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Date</span>
            <span class="summary-value" id="confirmDate">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Time</span>
            <span class="summary-value" id="confirmTime">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Name</span>
            <span class="summary-value" id="confirmName">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Phone</span>
            <span class="summary-value" id="confirmPhone">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Email</span>
            <span class="summary-value" id="confirmEmail">-</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Address</span>
            <span class="summary-value" id="confirmAddress">-</span>
          </div>
        </div>

        <div class="booking-buttons">
          <button class="btn btn-secondary" id="backToStep4">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
          </button>
          <button class="btn btn-primary" id="submitBooking">
            <span id="submitText">Confirm Appointment</span>
            <div class="spinner" id="submitSpinner" style="display:none;"></div>
          </button>
        </div>
      </section>

      <!-- Success Screen -->
      <section class="booking-section" id="stepSuccess">
        <div class="success-section">
          <div class="success-icon-wrapper">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
          </div>
          <h2 class="success-title">Appointment Booked!</h2>
          <p class="success-message">Your appointment has been confirmed. We've sent a confirmation email with all the details.</p>

          <div class="success-details">
            <div class="success-detail-row">
              <div class="success-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2"/>
                  <line x1="16" y1="2" x2="16" y2="6"/>
                  <line x1="8" y1="2" x2="8" y2="6"/>
                  <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
              </div>
              <div class="success-detail-text">
                <div class="success-detail-label">Date & Time</div>
                <div class="success-detail-value" id="successDateTime">-</div>
              </div>
            </div>
            <div class="success-detail-row">
              <div class="success-detail-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                  <circle cx="12" cy="10" r="3"/>
                </svg>
              </div>
              <div class="success-detail-text">
                <div class="success-detail-label">Service Type</div>
                <div class="success-detail-value" id="successService">-</div>
              </div>
            </div>
          </div>

          <!-- Add to Calendar Links -->
          <div class="calendar-links" id="calendarLinks">
            <a href="#" class="calendar-link" id="googleCalLink" target="_blank">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.5 3h-15A2.5 2.5 0 0 0 2 5.5v15A2.5 2.5 0 0 0 4.5 23h15a2.5 2.5 0 0 0 2.5-2.5v-15A2.5 2.5 0 0 0 19.5 3zM19 9H5V7h14v2zm0 4H5v-2h14v2zm-7 4H5v-2h7v2z"/>
              </svg>
              Add to Google Calendar
            </a>
            <a href="#" class="calendar-link" id="icsCalLink" download="appointment.ics">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              Download .ics File
            </a>
          </div>

          <div class="success-actions">
            <a href="/" class="btn btn-primary">
              Return to Home
            </a>
            <a href="tel:+16028333189" class="btn btn-secondary">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/>
              </svg>
              Call (602) 833-3189
            </a>
          </div>
        </div>
      </section>
    </div>

    <!-- Footer -->
    <footer class="booking-footer">
      <p>Your information is secure and will never be shared. <a href="/legal/privacy-policy">Privacy Policy</a></p>
      <p style="margin-top: 8px;">Questions? Call us at <a href="tel:+16028333189">(602) 833-3189</a></p>
    </footer>
  </main>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/js/state-manager.js"></script>

  <script>
  (function() {
    'use strict';

    // ======================
    // CONFIGURATION
    // ======================
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';

    const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    const SERVICE_LABELS = {
      'in-home': 'In-Home Estimate',
      'phone': 'Phone Consultation'
    };

    const MORNING_SLOTS = ['8:00 AM', '9:00 AM', '10:00 AM', '11:00 AM'];
    const AFTERNOON_SLOTS = ['12:00 PM', '1:00 PM', '2:00 PM', '3:00 PM', '4:00 PM'];

    // ======================
    // STATE
    // ======================
    let currentStep = 1;
    let currentMonth = new Date();
    let selectedService = '';
    let selectedDate = null;
    let selectedTime = '';
    let bookedSlots = {}; // Date -> array of booked times

    // ======================
    // SUPABASE CLIENT
    // ======================
    let supabaseClient = null;

    function getSupabase() {
      if (!supabaseClient && window.supabase) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
      return supabaseClient;
    }

    // ======================
    // AVAILABILITY CHECK
    // ======================
    async function fetchAvailability(year, month) {
      const sb = getSupabase();
      if (!sb) return;

      const startDate = new Date(year, month, 1).toISOString().split('T')[0];
      const endDate = new Date(year, month + 1, 0).toISOString().split('T')[0];

      try {
        // Check calendar_events table for existing appointments
        const { data, error } = await sb
          .from('calendar_events')
          .select('start_time, end_time')
          .gte('start_time', startDate)
          .lte('start_time', endDate + 'T23:59:59');

        if (error) {
          console.log('Availability check error:', error);
          return;
        }

        // Process booked slots
        bookedSlots = {};
        if (data) {
          data.forEach(event => {
            const date = event.start_time.split('T')[0];
            const time = new Date(event.start_time).toLocaleTimeString('en-US', {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true
            });
            if (!bookedSlots[date]) bookedSlots[date] = [];
            bookedSlots[date].push(time);
          });
        }

        renderCalendar();
      } catch (e) {
        console.log('Fetch availability error:', e);
      }
    }

    function getDateAvailability(date) {
      const dateStr = date.toISOString().split('T')[0];
      const booked = bookedSlots[dateStr] || [];
      const totalSlots = MORNING_SLOTS.length + AFTERNOON_SLOTS.length;
      const bookedCount = booked.length;

      if (bookedCount >= totalSlots - 1) return 'busy';
      if (bookedCount >= totalSlots / 2) return 'limited';
      return 'available';
    }

    // ======================
    // CALENDAR
    // ======================
    function renderCalendar() {
      const calendarDays = document.getElementById('calendarDays');
      const calendarMonthYear = document.getElementById('calendarMonthYear');
      const prevBtn = document.getElementById('prevMonth');

      if (!calendarDays || !calendarMonthYear) return;

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      calendarMonthYear.textContent = `${MONTH_NAMES[month]} ${year}`;

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      calendarDays.innerHTML = '';

      // Empty cells for days before first day
      for (let i = 0; i < firstDay; i++) {
        const emptyCell = document.createElement('button');
        emptyCell.className = 'calendar-day other-month';
        emptyCell.disabled = true;
        calendarDays.appendChild(emptyCell);
      }

      // Days of the month
      for (let day = 1; day <= daysInMonth; day++) {
        const dateBtn = document.createElement('button');
        dateBtn.className = 'calendar-day';
        dateBtn.innerHTML = `<span>${day}</span>`;

        const thisDate = new Date(year, month, day);
        thisDate.setHours(0, 0, 0, 0);

        // Disable past dates and Sundays
        if (thisDate < today || thisDate.getDay() === 0) {
          dateBtn.disabled = true;
        } else {
          // Add availability indicator
          const availability = getDateAvailability(thisDate);
          if (availability !== 'busy') {
            const dot = document.createElement('div');
            dot.className = 'availability-dot';
            dateBtn.appendChild(dot);
            if (availability === 'limited') dateBtn.classList.add('limited');
          } else {
            dateBtn.disabled = true;
          }
        }

        // Mark today
        if (thisDate.getTime() === today.getTime()) {
          dateBtn.classList.add('today');
        }

        // Mark selected
        if (selectedDate && thisDate.getTime() === selectedDate.getTime()) {
          dateBtn.classList.add('selected');
        }

        dateBtn.addEventListener('click', () => selectDate(thisDate));
        calendarDays.appendChild(dateBtn);
      }

      // Disable prev button if current month
      const thisMonth = new Date();
      thisMonth.setDate(1);
      thisMonth.setHours(0, 0, 0, 0);
      const currentMonthStart = new Date(year, month, 1);
      if (prevBtn) prevBtn.disabled = currentMonthStart <= thisMonth;
    }

    function selectDate(date) {
      selectedDate = date;
      selectedTime = '';
      document.getElementById('selectedDate').value = date.toISOString().split('T')[0];
      document.getElementById('toStep3').disabled = true;
      renderCalendar();
      updateStep2Button();
    }

    function updateStep2Button() {
      document.getElementById('toStep3').disabled = !selectedDate;
    }

    // ======================
    // TIME SLOTS
    // ======================
    function renderTimeSlots() {
      const morningGrid = document.getElementById('morningSlots');
      const afternoonGrid = document.getElementById('afternoonSlots');

      if (!morningGrid || !afternoonGrid) return;

      const dateStr = selectedDate ? selectedDate.toISOString().split('T')[0] : '';
      const booked = bookedSlots[dateStr] || [];

      morningGrid.innerHTML = '';
      afternoonGrid.innerHTML = '';

      MORNING_SLOTS.forEach(time => {
        const btn = createTimeSlotButton(time, booked.includes(time));
        morningGrid.appendChild(btn);
      });

      AFTERNOON_SLOTS.forEach(time => {
        const btn = createTimeSlotButton(time, booked.includes(time));
        afternoonGrid.appendChild(btn);
      });
    }

    function createTimeSlotButton(time, isBooked) {
      const btn = document.createElement('button');
      btn.className = 'time-slot';
      btn.textContent = time;
      btn.disabled = isBooked;

      if (selectedTime === time) btn.classList.add('selected');

      btn.addEventListener('click', () => {
        selectedTime = time;
        document.getElementById('selectedTime').value = time;
        renderTimeSlots();
        updateStep3Button();
      });

      return btn;
    }

    function updateStep3Button() {
      document.getElementById('toStep4').disabled = !selectedTime;
    }

    // ======================
    // NAVIGATION
    // ======================
    function showStep(stepNum) {
      currentStep = stepNum;

      document.querySelectorAll('.booking-section').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${stepNum}`).classList.add('active');

      // Update progress stepper
      document.querySelectorAll('.progress-step').forEach((step, i) => {
        step.classList.remove('active', 'completed');
        const stepIndex = i + 1;
        if (stepIndex < stepNum) {
          step.classList.add('completed');
          step.querySelector('.progress-step-circle').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
        } else if (stepIndex === stepNum) {
          step.classList.add('active');
          step.querySelector('.progress-step-circle').textContent = stepIndex;
        } else {
          step.querySelector('.progress-step-circle').textContent = stepIndex;
        }
      });

      // Update connectors
      document.querySelectorAll('.progress-connector').forEach((conn, i) => {
        conn.classList.toggle('active', i < stepNum - 1);
      });

      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function showSuccess() {
      document.querySelectorAll('.booking-section').forEach(s => s.classList.remove('active'));
      document.getElementById('stepSuccess').classList.add('active');

      document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.add('completed');
        step.querySelector('.progress-step-circle').innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>';
      });

      document.querySelectorAll('.progress-connector').forEach(conn => conn.classList.add('active'));

      // Clear pending booking state - booking is complete
      if (typeof StateManager !== 'undefined') {
        StateManager.clearPendingBooking();
      }
    }

    // ======================
    // FORM HELPERS
    // ======================
    function formatDateLong(date) {
      const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function formatPhone(value) {
      const digits = value.replace(/\D/g, '');
      if (digits.length >= 6) {
        return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6,10)}`;
      } else if (digits.length >= 3) {
        return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
      }
      return digits;
    }

    // ======================
    // CALENDAR LINK GENERATORS
    // ======================
    function generateGoogleCalendarLink(date, time, service, address) {
      const [hours, minutes, period] = time.match(/(\d+):(\d+)\s*(AM|PM)/i).slice(1);
      let hour = parseInt(hours);
      if (period.toUpperCase() === 'PM' && hour !== 12) hour += 12;
      if (period.toUpperCase() === 'AM' && hour === 12) hour = 0;

      const startDate = new Date(date);
      startDate.setHours(hour, parseInt(minutes), 0);

      const endDate = new Date(startDate);
      endDate.setHours(endDate.getHours() + 1);

      const formatForGoogle = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

      const title = encodeURIComponent(`Surprise Granite - ${SERVICE_LABELS[service]}`);
      const details = encodeURIComponent(`Your ${SERVICE_LABELS[service]} appointment with Surprise Granite.\n\nAddress: ${address}\n\nCall (602) 833-3189 with any questions.`);
      const location = encodeURIComponent(address);

      return `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${formatForGoogle(startDate)}/${formatForGoogle(endDate)}&details=${details}&location=${location}`;
    }

    function generateICSFile(date, time, service, address, name) {
      const [hours, minutes, period] = time.match(/(\d+):(\d+)\s*(AM|PM)/i).slice(1);
      let hour = parseInt(hours);
      if (period.toUpperCase() === 'PM' && hour !== 12) hour += 12;
      if (period.toUpperCase() === 'AM' && hour === 12) hour = 0;

      const startDate = new Date(date);
      startDate.setHours(hour, parseInt(minutes), 0);

      const endDate = new Date(startDate);
      endDate.setHours(endDate.getHours() + 1);

      const formatForICS = (d) => d.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';

      const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Surprise Granite//Appointment Booking//EN
BEGIN:VEVENT
DTSTART:${formatForICS(startDate)}
DTEND:${formatForICS(endDate)}
SUMMARY:Surprise Granite - ${SERVICE_LABELS[service]}
DESCRIPTION:Your ${SERVICE_LABELS[service]} appointment with Surprise Granite.\\n\\nCall (602) 833-3189 with any questions.
LOCATION:${address}
STATUS:CONFIRMED
END:VEVENT
END:VCALENDAR`;

      return 'data:text/calendar;charset=utf-8,' + encodeURIComponent(ics);
    }

    // ======================
    // SUBMIT BOOKING
    // ======================
    async function submitBooking() {
      const submitBtn = document.getElementById('submitBooking');
      const submitText = document.getElementById('submitText');
      const submitSpinner = document.getElementById('submitSpinner');

      submitBtn.disabled = true;
      submitText.style.display = 'none';
      submitSpinner.style.display = 'block';

      try {
        const name = document.getElementById('inputName').value.trim();
        const phone = document.getElementById('inputPhone').value.trim();
        const email = document.getElementById('inputEmail').value.trim();
        const address = document.getElementById('inputAddress').value.trim();
        const details = document.getElementById('inputDetails').value.trim();

        const nameParts = name.split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';

        const appointmentDate = selectedDate.toISOString().split('T')[0];

        const leadData = {
          first_name: firstName,
          last_name: lastName,
          full_name: name,
          email: email,
          phone: phone,
          project_type: SERVICE_LABELS[selectedService],
          message: `APPOINTMENT BOOKING\nService: ${SERVICE_LABELS[selectedService]}\nDate: ${formatDateLong(selectedDate)}\nTime: ${selectedTime}\nAddress: ${address}\n\n${details}`,
          source: 'Appointment Booking Page',
          form_name: 'book-appointment',
          page_url: window.location.href,
          status: 'new',
          raw_data: {
            appointment_type: selectedService,
            appointment_date: appointmentDate,
            appointment_time: selectedTime,
            project_address: address,
            project_details: details
          }
        };

        // Submit to Supabase leads table
        const sb = getSupabase();
        if (sb) {
          const { error } = await sb.from('leads').insert([leadData]);
          if (error) console.log('Supabase insert error:', error);
        }

        // Also submit to /api/leads endpoint
        try {
          await fetch('https://surprise-granite-email-api.onrender.com/api/leads', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              homeowner_name: name,
              homeowner_email: email,
              homeowner_phone: phone,
              project_type: SERVICE_LABELS[selectedService],
              project_address: address,
              message: leadData.message,
              source: 'Appointment Booking Page',
              appointment_date: appointmentDate,
              appointment_time: selectedTime
            })
          });
        } catch (e) {
          console.log('API submit error:', e);
        }

        // Submit to CRM webhook
        try {
          await fetch('https://voiceflow-crm.onrender.com/api/webhooks/website-lead', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              email: email,
              phone: phone,
              project_type: SERVICE_LABELS[selectedService],
              source: 'Appointment Booking Page',
              message: leadData.message,
              appointment_date: appointmentDate,
              appointment_time: selectedTime
            })
          });
        } catch (e) {
          console.log('CRM webhook error:', e);
        }

        // Create calendar event via local API
        try {
          const timeMatch = selectedTime.match(/(\d+):(\d+)\s*(AM|PM)/i);
          let hours = parseInt(timeMatch[1]);
          const minutes = timeMatch[2];
          const ampm = timeMatch[3].toUpperCase();
          if (ampm === 'PM' && hours !== 12) hours += 12;
          if (ampm === 'AM' && hours === 12) hours = 0;
          const time24 = `${hours.toString().padStart(2, '0')}:${minutes}`;

          await fetch('/api/calendar/book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: name,
              email: email,
              phone: phone,
              date: appointmentDate,
              time: time24,
              event_type: selectedService === 'phone' ? 'consultation' : selectedService === 'showroom' ? 'site_visit' : 'appointment',
              project_type: SERVICE_LABELS[selectedService],
              address: address,
              notes: details
            })
          });
        } catch (e) {
          console.log('Local calendar booking error:', e);
        }

        // Update success screen
        document.getElementById('successDateTime').textContent = `${formatDateLong(selectedDate)} at ${selectedTime}`;
        document.getElementById('successService').textContent = SERVICE_LABELS[selectedService];

        // Generate calendar links
        const googleLink = generateGoogleCalendarLink(selectedDate, selectedTime, selectedService, address);
        const icsLink = generateICSFile(selectedDate, selectedTime, selectedService, address, name);

        document.getElementById('googleCalLink').href = googleLink;
        document.getElementById('icsCalLink').href = icsLink;

        showSuccess();

      } catch (error) {
        console.error('Booking error:', error);
        alert('Something went wrong. Please try again or call us at (602) 833-3189.');
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        submitSpinner.style.display = 'none';
      }
    }

    // ======================
    // STATE PERSISTENCE
    // ======================
    function saveBookingState() {
      if (typeof StateManager !== 'undefined') {
        StateManager.setPendingBooking({
          step: currentStep,
          service: selectedService,
          date: selectedDate ? selectedDate.toISOString() : null,
          time: selectedTime,
          name: document.getElementById('inputName')?.value || '',
          phone: document.getElementById('inputPhone')?.value || '',
          email: document.getElementById('inputEmail')?.value || '',
          address: document.getElementById('inputAddress')?.value || '',
          notes: document.getElementById('inputNotes')?.value || ''
        });
      }
    }

    function restoreBookingState() {
      if (typeof StateManager === 'undefined') return;

      const pending = StateManager.getPendingBooking();
      if (!pending || pending.step < 2) return;

      // Restore state
      selectedService = pending.service || '';
      if (pending.date) selectedDate = new Date(pending.date);
      selectedTime = pending.time || '';

      // Restore form fields
      if (pending.name) document.getElementById('inputName').value = pending.name;
      if (pending.phone) document.getElementById('inputPhone').value = pending.phone;
      if (pending.email) document.getElementById('inputEmail').value = pending.email;
      if (pending.address) document.getElementById('inputAddress').value = pending.address;
      if (pending.notes) document.getElementById('inputNotes').value = pending.notes;

      // Restore service selection UI
      if (selectedService) {
        document.getElementById('selectedService').value = selectedService;
        const serviceCard = document.querySelector(`.service-card[data-service="${selectedService}"]`);
        if (serviceCard) serviceCard.classList.add('selected');
        document.getElementById('toStep2').disabled = false;
      }

      // Show prompt to continue
      if (pending.step >= 2) {
        const restored = confirm('You have an unfinished booking. Would you like to continue where you left off?');
        if (restored) {
          showStep(pending.step);
          if (pending.step >= 2) {
            document.getElementById('serviceTypeText').textContent = SERVICE_LABELS[selectedService]?.toLowerCase() || 'appointment';
            fetchAvailability(currentMonth.getFullYear(), currentMonth.getMonth());
          }
        } else {
          StateManager.clearPendingBooking();
        }
      }
    }

    // ======================
    // INITIALIZATION
    // ======================
    document.addEventListener('DOMContentLoaded', function() {
      // Restore any pending booking
      setTimeout(restoreBookingState, 500);

      // Service card selection
      document.querySelectorAll('.service-card').forEach(card => {
        card.addEventListener('click', function() {
          document.querySelectorAll('.service-card').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          selectedService = this.dataset.service;
          document.getElementById('selectedService').value = selectedService;
          document.getElementById('toStep2').disabled = false;
          saveBookingState();
        });
      });

      // Step navigation
      document.getElementById('toStep2').addEventListener('click', () => {
        document.getElementById('serviceTypeText').textContent = SERVICE_LABELS[selectedService].toLowerCase();
        showStep(2);
        fetchAvailability(currentMonth.getFullYear(), currentMonth.getMonth());
        saveBookingState();
      });

      document.getElementById('backToStep1').addEventListener('click', () => { showStep(1); saveBookingState(); });

      document.getElementById('toStep3').addEventListener('click', () => {
        document.getElementById('selectedDateText').textContent = formatDateLong(selectedDate);
        renderTimeSlots();
        showStep(3);
        saveBookingState();
      });

      document.getElementById('backToStep2').addEventListener('click', () => { showStep(2); saveBookingState(); });

      document.getElementById('toStep4').addEventListener('click', () => {
        document.getElementById('summaryService').textContent = SERVICE_LABELS[selectedService];
        document.getElementById('summaryDate').textContent = formatDateLong(selectedDate);
        document.getElementById('summaryTime').textContent = selectedTime;
        showStep(4);
        saveBookingState();
      });

      document.getElementById('backToStep3').addEventListener('click', () => { showStep(3); saveBookingState(); });

      document.getElementById('toStep5').addEventListener('click', () => {
        const name = document.getElementById('inputName').value.trim();
        const phone = document.getElementById('inputPhone').value.trim();
        const email = document.getElementById('inputEmail').value.trim();
        const address = document.getElementById('inputAddress').value.trim();

        if (!name || !phone || !email || !address) {
          alert('Please fill in all required fields.');
          return;
        }

        document.getElementById('confirmService').textContent = SERVICE_LABELS[selectedService];
        document.getElementById('confirmDate').textContent = formatDateLong(selectedDate);
        document.getElementById('confirmTime').textContent = selectedTime;
        document.getElementById('confirmName').textContent = name;
        document.getElementById('confirmPhone').textContent = phone;
        document.getElementById('confirmEmail').textContent = email;
        document.getElementById('confirmAddress').textContent = address;

        showStep(5);
      });

      document.getElementById('backToStep4').addEventListener('click', () => showStep(4));

      document.getElementById('submitBooking').addEventListener('click', submitBooking);

      // Calendar navigation
      document.getElementById('prevMonth').addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() - 1);
        fetchAvailability(currentMonth.getFullYear(), currentMonth.getMonth());
      });

      document.getElementById('nextMonth').addEventListener('click', () => {
        currentMonth.setMonth(currentMonth.getMonth() + 1);
        fetchAvailability(currentMonth.getFullYear(), currentMonth.getMonth());
      });

      // Phone formatting
      document.getElementById('inputPhone').addEventListener('input', function(e) {
        e.target.value = formatPhone(e.target.value);
      });

      // Initialize calendar
      renderCalendar();
    });
  })();
  </script>

  <!-- Remodely AI Widgets -->
  <script defer src="/js/remodely-widgets.js?v=20260131"></script>
  <script defer src="/js/remodely-hub.js?v=20260131"></script>
</body>
</html>
