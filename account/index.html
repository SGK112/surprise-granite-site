<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Account | Surprise Granite</title>
  <meta name="description" content="Manage your Surprise Granite account, view leads, and access your dashboard."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-light: rgba(255, 255, 255, 0.15);
      --success: #4dff82;
      --warning: #ffb84d;
      --error: #ff6b6b;
      --info: #4da6ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: 260px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 24px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-primary);
    }

    .sidebar-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: var(--dark-primary);
    }

    .sidebar-logo-text {
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-logo-sub {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-nav {
      flex: 1;
      padding: 0 12px;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(249, 203, 0, 0.1);
      color: var(--gold-primary);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    .nav-badge {
      margin-left: auto;
      background: var(--gold-primary);
      color: var(--dark-primary);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--dark-primary);
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    /* Main Content */
    .main-content {
      margin-left: 260px;
      min-height: 100vh;
    }

    .topbar {
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
      padding: 16px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .topbar-title {
      font-size: 20px;
      font-weight: 700;
    }

    .topbar-actions {
      display: flex;
      gap: 12px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      padding: 8px;
      cursor: pointer;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .content-area {
      padding: 32px;
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
    }

    /* Cards */
    .card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
    }

    .card-body {
      padding: 24px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .action-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 20px;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .action-card:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: var(--gold-primary);
      transform: translateY(-2px);
    }

    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
    }

    .action-icon svg {
      width: 24px;
      height: 24px;
    }

    .action-text h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Profile Form */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    /* Leads Table */
    .table-container {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .table-title {
      font-size: 16px;
      font-weight: 700;
    }

    .table-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-secondary);
    }

    .filter-btn:hover {
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 8px 16px;
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 14px;
      width: 200px;
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 24px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid var(--border-subtle);
    }

    td {
      padding: 16px 24px;
      font-size: 14px;
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: middle;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .lead-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .lead-email {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-project {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-new { background: rgba(77, 166, 255, 0.15); color: var(--info); }
    .status-new::before { background: var(--info); }

    .status-contacted { background: rgba(255, 184, 77, 0.15); color: var(--warning); }
    .status-contacted::before { background: var(--warning); }

    .status-qualified { background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); }
    .status-qualified::before { background: var(--gold-primary); }

    .status-quoted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .status-quoted::before { background: #a855f7; }

    .status-won { background: rgba(77, 255, 130, 0.15); color: var(--success); }
    .status-won::before { background: var(--success); }

    .status-lost { background: rgba(255, 107, 107, 0.15); color: var(--error); }
    .status-lost::before { background: var(--error); }

    .lead-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      text-decoration: none;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Coming Soon */
    .coming-soon {
      text-align: center;
      padding: 80px 24px;
    }

    .coming-soon-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 20px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
    }

    .coming-soon-icon svg {
      width: 40px;
      height: 40px;
    }

    .coming-soon h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .coming-soon p {
      color: var(--text-muted);
      max-width: 400px;
      margin: 0 auto;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    .modal-body {
      padding: 24px;
    }

    .detail-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .status-select {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .status-select:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    /* Auth Screens */
    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-deep);
      padding: 20px;
    }

    .auth-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 48px 40px;
      width: 100%;
      max-width: 440px;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-weight: 800;
      font-size: 24px;
      color: var(--dark-primary);
    }

    .auth-header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: var(--text-muted);
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 24px;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
    }

    .auth-message {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .auth-message.visible {
      display: block;
    }

    .auth-message.error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--error);
    }

    .auth-message.success {
      background: rgba(77, 255, 130, 0.1);
      border: 1px solid rgba(77, 255, 130, 0.3);
      color: var(--success);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      color: var(--dark-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .auth-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Loading */
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Product Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .product-image {
      height: 180px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .product-placeholder svg {
      width: 48px;
      height: 48px;
    }

    .product-info {
      padding: 16px;
    }

    .product-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .product-status.status-active {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .product-status.status-draft {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .product-status.status-sold {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .product-category {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .product-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold-primary);
    }

    .product-dims {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .product-actions {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.02);
    }

    /* Wallet Balance Cards */
    .wallet-balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .balance-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .balance-card.available::before {
      background: linear-gradient(90deg, var(--success), #2dd4bf);
    }

    .balance-card.pending::before {
      background: linear-gradient(90deg, var(--warning), #fb923c);
    }

    .balance-card.total::before {
      background: linear-gradient(90deg, var(--gold-primary), var(--gold-dark));
    }

    .balance-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .balance-card.available .balance-amount {
      color: var(--success);
    }

    .balance-card.pending .balance-amount {
      color: var(--warning);
    }

    .balance-card.total .balance-amount {
      color: var(--gold-primary);
    }

    .balance-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .transaction-row:last-child {
      border-bottom: none;
    }

    .transaction-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .transaction-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .transaction-icon.income {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .transaction-icon.payout {
      background: rgba(77, 166, 255, 0.15);
      color: var(--info);
    }

    .transaction-icon.fee {
      background: rgba(255, 107, 107, 0.15);
      color: var(--error);
    }

    .transaction-details h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .transaction-details p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-amount {
      text-align: right;
    }

    .transaction-amount .amount {
      font-size: 16px;
      font-weight: 600;
    }

    .transaction-amount .amount.positive {
      color: var(--success);
    }

    .transaction-amount .amount.negative {
      color: var(--error);
    }

    .transaction-amount .date {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Fees Grid */
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .fee-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
    }

    .fee-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .fee-header svg {
      color: var(--gold-primary);
    }

    .fee-rate {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .fee-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .fee-note {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: rgba(249, 203, 0, 0.05);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .fee-note svg {
      flex-shrink: 0;
      color: var(--gold-primary);
      margin-top: 2px;
    }

    .fee-note strong {
      color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: block;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .sidebar-overlay.active {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .content-area {
        padding: 20px;
      }

      .topbar {
        padding: 16px 20px;
      }

      .auth-card {
        padding: 32px 24px;
      }

      th, td {
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="spinner"></div>
    <p style="color: var(--text-muted);">Loading your account...</p>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen" style="display: none;">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">SG</div>
        <h1 id="auth-title">Welcome Back</h1>
        <p id="auth-subtitle">Sign in to access your account</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showAuthTab('signup')">Create Account</button>
      </div>

      <div id="auth-message" class="auth-message"></div>

      <!-- Login Form -->
      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required placeholder="you@example.com"/>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required placeholder="Enter your password"/>
        </div>
        <button type="submit" class="auth-submit" id="login-btn">Sign In</button>
      </form>

      <!-- Signup Form -->
      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="signup-name" required placeholder="John Smith"/>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signup-email" required placeholder="you@example.com"/>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signup-password" required minlength="6" placeholder="At least 6 characters"/>
        </div>
        <div class="form-group">
          <label>Phone (Optional)</label>
          <input type="tel" id="signup-phone" placeholder="(555) 123-4567"/>
        </div>
        <button type="submit" class="auth-submit" id="signup-btn">Create Account</button>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-app" style="display: none;">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub">Account</div>
          </div>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Menu</div>
          <a class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            Dashboard
          </a>
          <a class="nav-item" data-page="profile" onclick="showPage('profile')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            My Profile
          </a>
        </div>

        <div class="nav-section" id="admin-nav" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a class="nav-item" data-page="leads" onclick="showPage('leads')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Leads
            <span class="nav-badge" id="leads-count">0</span>
          </a>
          <a class="nav-item" data-page="invoices" onclick="showPage('invoices')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Invoices
          </a>
          <a class="nav-item" data-page="wallet" onclick="showPage('wallet')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
            Wallet
          </a>
          <a class="nav-item" data-page="admin-users" onclick="showPage('admin-users')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            Manage Admins
          </a>
        </div>

        <div class="nav-section" id="vendor-nav" style="display: none;">
          <div class="nav-section-title">Store</div>
          <a class="nav-item" data-page="products" onclick="showPage('products')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            Products
          </a>
          <a class="nav-item" data-page="orders" onclick="showPage('orders')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            Orders
          </a>
          <a class="nav-item" data-page="messages" onclick="showPage('messages')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            Messages
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Quick Links</div>
          <a class="nav-item" href="/" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            View Website
          </a>
          <a class="nav-item" href="/get-a-free-estimate/">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            Get Estimate
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-menu">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">User</div>
            <div class="user-role" id="user-role">Member</div>
          </div>
          <button class="logout-btn" onclick="handleLogout()" title="Sign Out">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="topbar">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <h1 class="topbar-title" id="page-title">Dashboard</h1>
        <div class="topbar-actions">
          <a href="/get-a-free-estimate/" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Get Quote
          </a>
        </div>
      </div>

      <div class="content-area">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page-section active">
          <div class="stats-grid" id="dashboard-stats">
            <!-- Filled by JS based on role -->
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="quick-actions" id="quick-actions">
                <!-- Filled by JS based on role -->
              </div>
            </div>
          </div>
        </section>

        <!-- Profile Page -->
        <section id="page-profile" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Profile Information</h3>
              <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
            <div class="card-body">
              <form id="profile-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profile-name" placeholder="Your name"/>
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profile-email" readonly style="opacity: 0.6;"/>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="profile-phone" placeholder="(555) 123-4567"/>
                  </div>
                  <div class="form-group">
                    <label>Company (Optional)</label>
                    <input type="text" id="profile-company" placeholder="Your company"/>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- Leads Page (Admin Only) -->
        <section id="page-leads" class="page-section">
          <div class="table-container">
            <div class="table-header">
              <h2 class="table-title">All Leads</h2>
              <div class="table-filters">
                <button class="filter-btn active" data-status="all">All</button>
                <button class="filter-btn" data-status="new">New</button>
                <button class="filter-btn" data-status="contacted">Contacted</button>
                <button class="filter-btn" data-status="qualified">Qualified</button>
                <button class="filter-btn" data-status="won">Won</button>
              </div>
              <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="leads-search" placeholder="Search leads...">
              </div>
            </div>
            <div id="leads-table">
              <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading leads...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Invoices Page (Admin Only) -->
        <section id="page-invoices" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Invoices</h3>
              <button class="btn btn-primary" onclick="openInvoiceModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Create Invoice
              </button>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-invoice-status="all" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn" data-invoice-status="draft" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn" data-invoice-status="open" onclick="filterInvoices('open')">Open</button>
                <button class="filter-btn" data-invoice-status="paid" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn" data-invoice-status="void" onclick="filterInvoices('void')">Voided</button>
              </div>
              <div id="invoices-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Wallet Page (Admin Only) -->
        <section id="page-wallet" class="page-section">
          <!-- Balance Cards -->
          <div class="wallet-balance-grid">
            <div class="balance-card available">
              <div class="balance-label">Available Balance</div>
              <div class="balance-amount" id="available-balance">$0.00</div>
              <div class="balance-sub">Ready to withdraw</div>
            </div>
            <div class="balance-card pending">
              <div class="balance-label">Pending Balance</div>
              <div class="balance-amount" id="pending-balance">$0.00</div>
              <div class="balance-sub">Processing payments</div>
            </div>
            <div class="balance-card total">
              <div class="balance-label">Total Revenue</div>
              <div class="balance-amount" id="total-revenue">$0.00</div>
              <div class="balance-sub">All time</div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body" style="display: flex; gap: 12px; flex-wrap: wrap;">
              <a href="https://dashboard.stripe.com" target="_blank" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                Open Stripe Dashboard
              </a>
              <button class="btn btn-secondary" onclick="loadWalletData()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
            </div>
          </div>

          <!-- Recent Transactions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Transactions</h3>
            </div>
            <div class="card-body">
              <div id="transactions-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Recent Payouts -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Payouts to Your Bank</h3>
            </div>
            <div class="card-body">
              <div id="payouts-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Fees & Rates Disclosure -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Processing Fees & Rates</h3>
            </div>
            <div class="card-body">
              <div class="fees-grid">
                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    <span>Credit/Debit Cards</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">Per successful transaction</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span>Invoices (Card Payment)</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">When customer pays by card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
                    <span>ACH Bank Transfer</span>
                  </div>
                  <div class="fee-rate">0.8% (max $5)</div>
                  <div class="fee-desc">Direct bank payments</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>Payouts to Bank</span>
                  </div>
                  <div class="fee-rate">Free</div>
                  <div class="fee-desc">Standard 2-day transfer</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span>Instant Payouts</span>
                  </div>
                  <div class="fee-rate">1.5% (min $0.50)</div>
                  <div class="fee-desc">Funds in minutes to debit card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Vendor Payouts</span>
                  </div>
                  <div class="fee-rate">0.25% + $0.25</div>
                  <div class="fee-desc">Per transfer to vendor accounts</div>
                </div>
              </div>

              <div class="fee-note">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div>
                  <strong>How Vendor Payouts Work:</strong>
                  All customer payments are collected through Surprise Granite's Stripe account. Vendors receive payouts after their sales are processed, minus applicable platform and processing fees. Payouts are processed weekly or upon request.
                </div>
              </div>

              <div class="fee-note" style="margin-top: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                <div>
                  <strong>Secure Payments:</strong>
                  All transactions are processed securely through Stripe. We never store credit card numbers on our servers.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin Users Page -->
        <section id="page-admin-users" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Manage Admin Users</h3>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">Add or remove admin access for users. Super admins (joshb@surprisegranite.com, info@surprisegranite.com) always have access.</p>
              <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <input type="email" id="new-admin-email" placeholder="Enter email address" style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <button class="btn btn-primary" onclick="addAdminUser()">Add Admin</button>
              </div>
              <div id="admin-users-list">
                <div class="spinner" style="margin: 20px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Products Page -->
        <section id="page-products" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Products</h3>
              <button class="btn btn-primary" onclick="openProductModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Add Product
              </button>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-product-status="all" onclick="filterProducts('all')">All</button>
                <button class="filter-btn" data-product-status="active" onclick="filterProducts('active')">Active</button>
                <button class="filter-btn" data-product-status="draft" onclick="filterProducts('draft')">Draft</button>
                <button class="filter-btn" data-product-status="sold" onclick="filterProducts('sold')">Sold</button>
              </div>
              <div id="products-grid" class="products-grid">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Orders Page (Coming Soon) -->
        <section id="page-orders" class="page-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            </div>
            <h2>Order Management Coming Soon</h2>
            <p>Track and manage customer orders, quotes, and project timelines all in one place.</p>
          </div>
        </section>

        <!-- Messages Page (Coming Soon) -->
        <section id="page-messages" class="page-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            </div>
            <h2>Messaging Coming Soon</h2>
            <p>Stay connected with customers, vendors, and the Surprise Granite team through our upcoming messaging feature.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Lead Detail Modal -->
  <div class="modal-overlay" id="lead-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Lead Details</h2>
        <button class="modal-close" onclick="closeLeadModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="lead-details"></div>
      <div class="modal-footer">
        <select class="status-select" id="lead-status-select">
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="quoted">Quoted</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
        <button class="btn btn-secondary" onclick="closeLeadModal()">Close</button>
        <button class="btn btn-primary" onclick="updateLeadStatus()">Update Status</button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal-overlay" id="product-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="product-modal-title">Add New Product</h2>
        <button class="modal-close" onclick="closeProductModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="product-form" onsubmit="saveProduct(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="product-name" required placeholder="e.g., Calacatta Gold Marble Slab"/>
            </div>
            <div class="form-group">
              <label>Category</label>
              <select id="product-category">
                <option value="">Select Category</option>
                <option value="granite">Granite</option>
                <option value="marble">Marble</option>
                <option value="quartz">Quartz</option>
                <option value="quartzite">Quartzite</option>
                <option value="porcelain">Porcelain</option>
                <option value="soapstone">Soapstone</option>
                <option value="remnant">Remnant</option>
                <option value="tile">Tile</option>
                <option value="sink">Sink</option>
                <option value="faucet">Faucet</option>
                <option value="accessory">Accessory</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="product-description" rows="3" placeholder="Describe your product..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price ($) *</label>
              <input type="number" id="product-price" required min="0" step="0.01" placeholder="0.00"/>
            </div>
            <div class="form-group">
              <label>Dimensions</label>
              <input type="text" id="product-dimensions" placeholder='e.g., 120" x 60" x 3cm'/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Material Type</label>
              <input type="text" id="product-material" placeholder="e.g., Natural Stone"/>
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="text" id="product-color" placeholder="e.g., White with Gold Veining"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Stock Quantity</label>
              <input type="number" id="product-stock" min="0" value="1" placeholder="1"/>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="product-status">
                <option value="draft">Draft (Not Listed)</option>
                <option value="active">Active (Listed for Sale)</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="product-image-url" placeholder="https://example.com/image.jpg"/>
            <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
              Paste a direct link to your product image. Tip: Upload images to Imgur or similar service.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="product-save-btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal-overlay" id="invoice-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Invoice</h2>
        <button class="modal-close" onclick="closeInvoiceModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="invoice-form" onsubmit="createInvoice(event)">
        <div class="modal-body">
          <h4 style="margin-bottom: 16px; color: var(--text-secondary);">Customer Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Customer Email *</label>
              <input type="email" id="invoice-email" required placeholder="customer@example.com"/>
            </div>
            <div class="form-group">
              <label>Customer Name</label>
              <input type="text" id="invoice-name" placeholder="John Smith"/>
            </div>
          </div>
          <div class="form-group">
            <label>Customer Phone</label>
            <input type="tel" id="invoice-phone" placeholder="(555) 123-4567"/>
          </div>

          <h4 style="margin: 24px 0 16px; color: var(--text-secondary);">Invoice Items</h4>
          <div id="invoice-items">
            <div class="invoice-item" data-index="0">
              <div class="form-row" style="align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                  <label>Description *</label>
                  <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Qty</label>
                  <input type="number" class="item-qty" value="1" min="1"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Amount ($) *</label>
                  <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00"/>
                </div>
                <button type="button" class="btn btn-secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-secondary" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Line Item
          </button>

          <div class="form-row">
            <div class="form-group">
              <label>Due In (Days)</label>
              <select id="invoice-due-days">
                <option value="7">7 days</option>
                <option value="14">14 days</option>
                <option value="30" selected>30 days</option>
                <option value="60">60 days</option>
              </select>
            </div>
            <div class="form-group">
              <label>Invoice Total</label>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary); padding: 10px 0;" id="invoice-total">$0.00</div>
            </div>
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea id="invoice-notes" rows="2" placeholder="Add any additional notes for the customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="invoice-send-btn">Create & Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';

    const SUPER_ADMIN_EMAILS = ['joshb@surprisegranite.com', 'info@surprisegranite.com'];

    let supabaseClient;
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let allLeads = [];
    let currentFilter = 'all';
    let selectedLead = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const { createClient } = window.supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { data: { session } } = await supabaseClient.auth.getSession();

        if (session) {
          currentUser = session.user;
          await loadUserProfile();
          showDashboard();
        } else {
          showAuth();
        }
      } catch (err) {
        console.error('Init error:', err);
        showAuth();
      }
    });

    function showAuth() {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('dashboard-app').style.display = 'none';
    }

    function showDashboard() {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-app').style.display = 'block';
      setupDashboard();
    }

    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

      document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tab}-form`).classList.add('active');

      document.getElementById('auth-title').textContent = tab === 'login' ? 'Welcome Back' : 'Create Account';
      document.getElementById('auth-subtitle').textContent = tab === 'login' ? 'Sign in to access your account' : 'Join us to get started';
      hideAuthMessage();
    }

    function showAuthMessage(msg, type) {
      const el = document.getElementById('auth-message');
      el.textContent = msg;
      el.className = `auth-message visible ${type}`;
    }

    function hideAuthMessage() {
      document.getElementById('auth-message').classList.remove('visible');
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();
        showDashboard();
      } catch (err) {
        showAuthMessage(err.message || 'Failed to sign in', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      try {
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const phone = document.getElementById('signup-phone').value;

        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: { data: { full_name: name, phone } }
        });

        if (error) throw error;

        // Store in sg_users
        await supabaseClient.from('sg_users').insert([{
          id: data.user.id,
          email,
          full_name: name,
          phone: phone || null,
          account_type: 'homeowner'
        }]);

        showAuthMessage('Account created! Check your email to verify, then sign in.', 'success');
        showAuthTab('login');
      } catch (err) {
        showAuthMessage(err.message || 'Failed to create account', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return;

      try {
        const { data: profile } = await supabaseClient
          .from('sg_users')
          .select('*')
          .eq('id', currentUser.id)
          .single();

        userProfile = profile;

        const meta = currentUser.user_metadata || {};
        const name = profile?.full_name || meta.full_name || currentUser.email.split('@')[0];
        const accountType = profile?.account_type || 'homeowner';

        // Check admin status
        isSuperAdmin = SUPER_ADMIN_EMAILS.includes(currentUser.email.toLowerCase());
        isAdmin = isSuperAdmin || ['admin', 'super_admin'].includes(accountType);

        // Update sidebar user info
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        document.getElementById('user-name').textContent = name;
        document.getElementById('user-role').textContent = isSuperAdmin ? 'Super Admin' : (isAdmin ? 'Admin' : (accountType === 'homeowner' ? 'Member' : accountType.replace('pro_', 'Pro ')));

        // Update profile form
        document.getElementById('profile-name').value = name;
        document.getElementById('profile-email').value = currentUser.email;
        document.getElementById('profile-phone').value = profile?.phone || meta.phone || '';
        document.getElementById('profile-company').value = profile?.company_name || '';

        // Show admin nav if admin
        if (isAdmin) {
          document.getElementById('admin-nav').style.display = 'block';
        }

        // Show store/vendor nav for admins and pro accounts
        if (isAdmin || accountType.startsWith('pro_')) {
          document.getElementById('vendor-nav').style.display = 'block';
        }

      } catch (err) {
        console.warn('Profile load error:', err);
      }
    }

    function setupDashboard() {
      // Setup stats and quick actions based on role
      const statsEl = document.getElementById('dashboard-stats');
      const actionsEl = document.getElementById('quick-actions');

      if (isAdmin) {
        loadLeads();
        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Leads</div>
            <div class="stat-value" id="stat-new">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Contacted</div>
            <div class="stat-value" id="stat-contacted">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Won</div>
            <div class="stat-value" id="stat-won">-</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="#" class="action-card" onclick="showPage('leads'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>View Leads</h4>
              <p>Manage incoming leads from the website</p>
            </div>
          </a>
          <a href="/get-a-free-estimate/" class="action-card" target="_blank">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            </div>
            <div class="action-text">
              <h4>Quote Form</h4>
              <p>View the customer quote request form</p>
            </div>
          </a>
          <a href="/" class="action-card" target="_blank">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            </div>
            <div class="action-text">
              <h4>View Website</h4>
              <p>Open the main website in a new tab</p>
            </div>
          </a>
        `;
      } else {
        statsEl.innerHTML = '';
        actionsEl.innerHTML = `
          <a href="/get-a-free-estimate/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Get Free Estimate</h4>
              <p>Request a quote for your project</p>
            </div>
          </a>
          <a href="/tools/countertop-calculator/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Countertop Calculator</h4>
              <p>Calculate costs for your countertops</p>
            </div>
          </a>
          <a href="/materials/all-countertops/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Materials</h4>
              <p>Explore our countertop selection</p>
            </div>
          </a>
          <a href="/contact-us/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Contact Us</h4>
              <p>Get in touch with our team</p>
            </div>
          </a>
        `;
      }

      // Setup filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          renderLeads();
        });
      });

      // Setup search
      document.getElementById('leads-search')?.addEventListener('input', () => {
        renderLeads();
      });

      // Load admin users if admin
      if (isSuperAdmin) {
        loadAdminUsers();
      }
    }

    function showPage(page) {
      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update page sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === `page-${page}`);
      });

      // Update title
      const titles = {
        'dashboard': 'Dashboard',
        'profile': 'My Profile',
        'leads': 'Leads',
        'invoices': 'Invoices',
        'wallet': 'Wallet',
        'admin-users': 'Manage Admins',
        'products': 'Products',
        'orders': 'Orders',
        'messages': 'Messages'
      };
      document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('open');
      document.querySelector('.sidebar-overlay').classList.remove('active');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('active');
    }

    async function saveProfile() {
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;
      const company = document.getElementById('profile-company').value;

      try {
        const { error } = await supabaseClient
          .from('sg_users')
          .update({
            full_name: name,
            phone: phone || null,
            company_name: company || null,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentUser.id);

        if (error) throw error;

        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        alert('Profile saved successfully!');
      } catch (err) {
        alert('Error saving profile: ' + err.message);
      }
    }

    async function handleLogout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      userProfile = null;
      showAuth();
    }

    // Leads Functions
    async function loadLeads() {
      try {
        const { data, error } = await supabaseClient
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allLeads = data || [];
        updateStats();
        renderLeads();
      } catch (err) {
        console.error('Error loading leads:', err);
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <h3>Error loading leads</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function updateStats() {
      const stats = {
        total: allLeads.length,
        new: allLeads.filter(l => l.status === 'new').length,
        contacted: allLeads.filter(l => l.status === 'contacted').length,
        won: allLeads.filter(l => l.status === 'won').length
      };

      if (document.getElementById('stat-total')) {
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-new').textContent = stats.new;
        document.getElementById('stat-contacted').textContent = stats.contacted;
        document.getElementById('stat-won').textContent = stats.won;
      }
      document.getElementById('leads-count').textContent = stats.new;
    }

    function renderLeads() {
      const searchTerm = document.getElementById('leads-search')?.value.toLowerCase() || '';

      let filtered = allLeads;

      if (currentFilter !== 'all') {
        filtered = filtered.filter(l => l.status === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(l =>
          (l.full_name || '').toLowerCase().includes(searchTerm) ||
          (l.email || '').toLowerCase().includes(searchTerm) ||
          (l.phone || '').toLowerCase().includes(searchTerm)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <h3>No leads found</h3>
            <p>${currentFilter !== 'all' ? 'No leads with this status.' : 'Leads from your website forms will appear here.'}</p>
          </div>
        `;
        return;
      }

      document.getElementById('leads-table').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Contact</th>
              <th>Project</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(lead => `
              <tr>
                <td>
                  <div class="lead-name">${lead.full_name || 'Unknown'}</div>
                  <div class="lead-email">${lead.email || lead.phone || 'No contact'}</div>
                </td>
                <td><span class="lead-project">${lead.project_type || 'General'}</span></td>
                <td><span class="status-badge status-${lead.status}">${lead.status}</span></td>
                <td><div class="lead-date">${formatDate(lead.created_at)}</div></td>
                <td>
                  <div class="lead-actions">
                    <button class="action-btn" onclick="viewLead('${lead.id}')" title="View">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </button>
                    ${lead.email ? `<a class="action-btn" href="mailto:${lead.email}" title="Email"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></a>` : ''}
                    ${lead.phone ? `<a class="action-btn" href="tel:${lead.phone}" title="Call"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg></a>` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) return 'Just now';
        return `${hours}h ago`;
      } else if (days === 1) return 'Yesterday';
      else if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function viewLead(id) {
      selectedLead = allLeads.find(l => l.id === id);
      if (!selectedLead) return;

      document.getElementById('lead-details').innerHTML = `
        <div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">${selectedLead.full_name || 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${selectedLead.email ? `<a href="mailto:${selectedLead.email}" style="color: var(--gold-primary);">${selectedLead.email}</a>` : 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">${selectedLead.phone ? `<a href="tel:${selectedLead.phone}" style="color: var(--gold-primary);">${selectedLead.phone}</a>` : 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Project</div><div class="detail-value">${selectedLead.project_type || 'Not specified'}</div></div>
        <div class="detail-row"><div class="detail-label">Message</div><div class="detail-value">${selectedLead.message || 'No message'}</div></div>
        <div class="detail-row"><div class="detail-label">Source</div><div class="detail-value">${selectedLead.form_name || 'Website'}</div></div>
        <div class="detail-row"><div class="detail-label">Submitted</div><div class="detail-value">${new Date(selectedLead.created_at).toLocaleString()}</div></div>
      `;

      document.getElementById('lead-status-select').value = selectedLead.status;
      document.getElementById('lead-modal').classList.add('active');
    }

    function closeLeadModal() {
      document.getElementById('lead-modal').classList.remove('active');
      selectedLead = null;
    }

    async function updateLeadStatus() {
      if (!selectedLead) return;

      const newStatus = document.getElementById('lead-status-select').value;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = newStatus;

        updateStats();
        renderLeads();
        closeLeadModal();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Admin Users Functions
    let adminUsers = [];

    async function loadAdminUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .or('account_type.eq.admin,account_type.eq.super_admin')
          .order('created_at', { ascending: false });

        if (error) throw error;
        adminUsers = data || [];
        renderAdminUsers();
      } catch (err) {
        document.getElementById('admin-users-list').innerHTML = `<p style="color: var(--error);">Error: ${err.message}</p>`;
      }
    }

    function renderAdminUsers() {
      const allAdmins = [
        ...SUPER_ADMIN_EMAILS.map(email => ({ email, full_name: email.split('@')[0], isSuperAdmin: true })),
        ...adminUsers.filter(u => !SUPER_ADMIN_EMAILS.includes(u.email?.toLowerCase()))
      ];

      document.getElementById('admin-users-list').innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allAdmins.map(user => `
              <tr>
                <td>${user.email}</td>
                <td>${user.full_name || '-'}</td>
                <td><span class="status-badge ${user.isSuperAdmin ? 'status-won' : 'status-qualified'}">${user.isSuperAdmin ? 'Super Admin' : 'Admin'}</span></td>
                <td style="text-align: right;">
                  ${user.isSuperAdmin ? '<span style="color: var(--text-muted); font-size: 12px;">Protected</span>' :
                    `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeAdminUser('${user.id}', '${user.email}')">Remove</button>`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function addAdminUser() {
      const email = document.getElementById('new-admin-email').value.trim().toLowerCase();
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
      }

      if (SUPER_ADMIN_EMAILS.includes(email)) {
        alert('Already a super admin');
        return;
      }

      try {
        const { data: existing } = await supabaseClient.from('sg_users').select('*').eq('email', email).single();

        if (existing) {
          await supabaseClient.from('sg_users').update({ account_type: 'admin' }).eq('id', existing.id);
        } else {
          await supabaseClient.from('sg_users').insert([{ email, account_type: 'admin', full_name: email.split('@')[0] }]);
        }

        document.getElementById('new-admin-email').value = '';
        loadAdminUsers();
        alert(`Admin access granted to ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeAdminUser(userId, email) {
      if (!confirm(`Remove admin access for ${email}?`)) return;

      try {
        await supabaseClient.from('sg_users').update({ account_type: 'homeowner' }).eq('id', userId);
        loadAdminUsers();
        alert(`Admin removed: ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLeadModal();
        closeProductModal();
        closeInvoiceModal();
      }
    });

    document.getElementById('lead-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeLeadModal();
    });

    // ============ PRODUCT MANAGEMENT ============
    let allProducts = [];
    let productFilter = 'all';
    let editingProduct = null;

    async function loadProducts() {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      try {
        let query = supabaseClient
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });

        // Non-super admins only see their own products
        if (!isSuperAdmin) {
          query = query.eq('vendor_id', currentUser.id);
        }

        const { data, error } = await query;

        if (error) {
          // Table might not exist yet
          if (error.code === '42P01') {
            productsGrid.innerHTML = `
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <h3>Products Table Not Set Up</h3>
                <p>The products table needs to be created in Supabase. Contact your administrator.</p>
              </div>
            `;
            return;
          }
          throw error;
        }

        allProducts = data || [];
        renderProducts();
      } catch (err) {
        console.error('Error loading products:', err);
        productsGrid.innerHTML = `
          <div class="empty-state">
            <h3>Error loading products</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function filterProducts(status) {
      productFilter = status;
      document.querySelectorAll('[data-product-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.productStatus === status);
      });
      renderProducts();
    }

    function renderProducts() {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      let filtered = allProducts;
      if (productFilter !== 'all') {
        filtered = filtered.filter(p => p.status === productFilter);
      }

      if (filtered.length === 0) {
        productsGrid.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <h3>No products found</h3>
            <p>${productFilter !== 'all' ? 'No products with this status.' : 'Add your first product to get started.'}</p>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductModal()">Add Product</button>
          </div>
        `;
        return;
      }

      productsGrid.innerHTML = filtered.map(product => `
        <div class="product-card" data-id="${product.id}">
          <div class="product-image">
            ${product.image_url ?
              `<img src="${product.image_url}" alt="${product.name}" onerror="this.style.display='none';this.parentElement.querySelector('.product-placeholder').style.display='flex';">
               <div class="product-placeholder" style="display:none;">` :
              `<div class="product-placeholder">`}
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
          </div>
          <div class="product-info">
            <div class="product-status status-${product.status}">${product.status}</div>
            <h4 class="product-name">${product.name}</h4>
            <p class="product-category">${product.category || 'Uncategorized'}</p>
            <div class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
            ${product.dimensions ? `<p class="product-dims">${product.dimensions}</p>` : ''}
          </div>
          <div class="product-actions">
            <button class="action-btn" onclick="editProduct('${product.id}')" title="Edit">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
            <button class="action-btn" onclick="deleteProduct('${product.id}')" title="Delete" style="color: var(--error);">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    function openProductModal(product = null) {
      editingProduct = product;
      const modal = document.getElementById('product-modal');
      const title = document.getElementById('product-modal-title');
      const form = document.getElementById('product-form');

      title.textContent = product ? 'Edit Product' : 'Add New Product';
      form.reset();

      if (product) {
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('product-category').value = product.category || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-dimensions').value = product.dimensions || '';
        document.getElementById('product-image-url').value = product.image_url || '';
        document.getElementById('product-status').value = product.status || 'draft';
        document.getElementById('product-material').value = product.material_type || '';
        document.getElementById('product-color').value = product.color || '';
        document.getElementById('product-stock').value = product.stock_quantity || 1;
      }

      modal.classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('active');
      editingProduct = null;
    }

    async function editProduct(id) {
      const product = allProducts.find(p => p.id === id);
      if (product) {
        openProductModal(product);
      }
    }

    async function saveProduct(e) {
      e.preventDefault();
      const btn = document.getElementById('product-save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const productData = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        category: document.getElementById('product-category').value,
        price: parseFloat(document.getElementById('product-price').value) || 0,
        dimensions: document.getElementById('product-dimensions').value,
        image_url: document.getElementById('product-image-url').value,
        status: document.getElementById('product-status').value,
        material_type: document.getElementById('product-material').value,
        color: document.getElementById('product-color').value,
        stock_quantity: parseInt(document.getElementById('product-stock').value) || 1,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingProduct) {
          // Update existing
          const { error } = await supabaseClient
            .from('products')
            .update(productData)
            .eq('id', editingProduct.id);
          if (error) throw error;
        } else {
          // Create new
          productData.vendor_id = currentUser.id;
          productData.vendor_email = currentUser.email;
          productData.created_at = new Date().toISOString();

          const { error } = await supabaseClient
            .from('products')
            .insert([productData]);
          if (error) throw error;
        }

        closeProductModal();
        loadProducts();
        alert(editingProduct ? 'Product updated!' : 'Product added!');
      } catch (err) {
        alert('Error saving product: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Product';
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const { error } = await supabaseClient
          .from('products')
          .delete()
          .eq('id', id);
        if (error) throw error;

        allProducts = allProducts.filter(p => p.id !== id);
        renderProducts();
        alert('Product deleted.');
      } catch (err) {
        alert('Error deleting product: ' + err.message);
      }
    }

    // Load products when showing products page
    const originalShowPage = showPage;
    showPage = function(page) {
      originalShowPage(page);
      if (page === 'products' && (isAdmin || userProfile?.account_type?.startsWith('pro_'))) {
        loadProducts();
      }
    };

    // Product modal click-outside to close
    document.getElementById('product-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeProductModal();
    });

    // ============ INVOICE MANAGEMENT ============
    const API_URL = 'https://surprise-granite-email-api.onrender.com';

    let allInvoices = [];
    let invoiceFilter = 'all';
    let invoiceItemCount = 1;

    async function loadInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      try {
        const response = await fetch(`${API_URL}/api/invoices?limit=50`);

        if (!response.ok) {
          throw new Error('API not available. Please deploy the Stripe API backend first.');
        }

        const data = await response.json();
        allInvoices = data.invoices || [];
        renderInvoices();
      } catch (err) {
        console.error('Error loading invoices:', err);
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>Invoice API Not Connected</h3>
            <p>The Stripe invoice API needs to be deployed. See /api folder for setup instructions.</p>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice Anyway</button>
          </div>
        `;
      }
    }

    function filterInvoices(status) {
      invoiceFilter = status;
      document.querySelectorAll('[data-invoice-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.invoiceStatus === status);
      });
      renderInvoices();
    }

    function renderInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      let filtered = allInvoices;
      if (invoiceFilter !== 'all') {
        filtered = filtered.filter(inv => inv.status === invoiceFilter);
      }

      if (filtered.length === 0) {
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>No invoices found</h3>
            <p>${invoiceFilter !== 'all' ? 'No invoices with this status.' : 'Create your first invoice to get started.'}</p>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
        return;
      }

      invoicesList.innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Due Date</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(inv => `
              <tr>
                <td><strong>${inv.number || inv.id.slice(-8)}</strong></td>
                <td>
                  <div>${inv.customer_name || 'N/A'}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">${inv.customer_email}</div>
                </td>
                <td style="font-weight: 600; color: var(--gold-primary);">$${inv.amount_due.toFixed(2)}</td>
                <td><span class="status-badge status-${inv.status === 'paid' ? 'won' : inv.status === 'open' ? 'new' : inv.status === 'void' ? 'lost' : 'qualified'}">${inv.status}</span></td>
                <td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'N/A'}</td>
                <td style="text-align: right;">
                  <div class="lead-actions" style="justify-content: flex-end;">
                    ${inv.hosted_invoice_url ? `<a class="action-btn" href="${inv.hosted_invoice_url}" target="_blank" title="View Invoice"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>` : ''}
                    ${inv.pdf ? `<a class="action-btn" href="${inv.pdf}" target="_blank" title="Download PDF"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></a>` : ''}
                    ${inv.status === 'open' ? `<button class="action-btn" onclick="sendReminder('${inv.id}')" title="Send Reminder"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></button>` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function openInvoiceModal() {
      document.getElementById('invoice-modal').classList.add('active');
      document.getElementById('invoice-form').reset();
      document.getElementById('invoice-items').innerHTML = `
        <div class="invoice-item" data-index="0">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn btn-secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      invoiceItemCount = 1;
      updateInvoiceTotal();
    }

    function closeInvoiceModal() {
      document.getElementById('invoice-modal').classList.remove('active');
    }

    function addInvoiceItem() {
      const container = document.getElementById('invoice-items');
      const itemHTML = `
        <div class="invoice-item" data-index="${invoiceItemCount}">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Installation Labor"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn btn-secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', itemHTML);
      invoiceItemCount++;
    }

    function removeInvoiceItem(btn) {
      const items = document.querySelectorAll('.invoice-item');
      if (items.length > 1) {
        btn.closest('.invoice-item').remove();
        updateInvoiceTotal();
      }
    }

    function updateInvoiceTotal() {
      const items = document.querySelectorAll('.invoice-item');
      let total = 0;
      items.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
        const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
        total += qty * amount;
      });
      document.getElementById('invoice-total').textContent = `$${total.toFixed(2)}`;
    }

    async function createInvoice(e) {
      e.preventDefault();
      const btn = document.getElementById('invoice-send-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      const items = [];
      document.querySelectorAll('.invoice-item').forEach(item => {
        items.push({
          description: item.querySelector('.item-description').value,
          quantity: parseInt(item.querySelector('.item-qty').value) || 1,
          amount: parseFloat(item.querySelector('.item-amount').value) || 0
        });
      });

      const invoiceData = {
        customer_email: document.getElementById('invoice-email').value,
        customer_name: document.getElementById('invoice-name').value,
        customer_phone: document.getElementById('invoice-phone').value,
        items,
        due_days: parseInt(document.getElementById('invoice-due-days').value),
        notes: document.getElementById('invoice-notes').value,
        auto_send: true
      };

      try {
        const response = await fetch(`${API_URL}/api/invoices`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create invoice');
        }

        closeInvoiceModal();
        loadInvoices();
        alert(`Invoice #${data.invoice.number} created and sent to ${invoiceData.customer_email}!`);
      } catch (err) {
        alert('Error creating invoice: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create & Send Invoice';
      }
    }

    async function sendReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        const response = await fetch(`${API_URL}/api/invoices/${invoiceId}/remind`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to send reminder');
        }

        alert('Payment reminder sent!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Invoice modal click-outside to close
    document.getElementById('invoice-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeInvoiceModal();
    });

    // Update showPage to load invoices and wallet
    const _originalShowPage = showPage;
    showPage = function(page) {
      _originalShowPage(page);
      if (page === 'invoices' && isAdmin) {
        loadInvoices();
      }
      if (page === 'wallet' && isAdmin) {
        loadWalletData();
      }
    };

    // ============ WALLET MANAGEMENT ============
    let totalRevenue = 0;

    async function loadWalletData() {
      await Promise.all([
        loadBalance(),
        loadTransactions(),
        loadPayouts()
      ]);
    }

    async function loadBalance() {
      try {
        const response = await fetch(`${API_URL}/api/balance`);
        if (!response.ok) throw new Error('Failed to load balance');

        const data = await response.json();

        document.getElementById('available-balance').textContent = `$${data.total_available.toFixed(2)}`;
        document.getElementById('pending-balance').textContent = `$${data.total_pending.toFixed(2)}`;

      } catch (err) {
        console.error('Balance error:', err);
        document.getElementById('available-balance').textContent = '$--.--';
        document.getElementById('pending-balance').textContent = '$--.--';
      }
    }

    async function loadTransactions() {
      const container = document.getElementById('transactions-list');
      if (!container) return;

      try {
        const response = await fetch(`${API_URL}/api/balance-transactions?limit=15`);
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();

        if (data.transactions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No transactions yet</p>
            </div>
          `;
          return;
        }

        // Calculate total revenue from charges
        totalRevenue = data.transactions
          .filter(t => t.type === 'charge' && t.amount > 0)
          .reduce((sum, t) => sum + t.amount, 0);

        document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;

        container.innerHTML = data.transactions.map(t => {
          const isPositive = t.amount > 0 && t.type !== 'payout' && t.type !== 'stripe_fee';
          const iconClass = t.type === 'payout' ? 'payout' : (t.type === 'stripe_fee' ? 'fee' : 'income');
          const icon = t.type === 'payout'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>'
            : t.type === 'stripe_fee'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>';

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon ${iconClass}">${icon}</div>
                <div class="transaction-details">
                  <h4>${t.description || t.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                  <p>${t.type} ${t.fee > 0 ? ` Fee: $${t.fee.toFixed(2)}` : ''}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                <div class="date">${new Date(t.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Transactions error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load transactions</p>
          </div>
        `;
      }
    }

    async function loadPayouts() {
      const container = document.getElementById('payouts-list');
      if (!container) return;

      try {
        const response = await fetch(`${API_URL}/api/payouts?limit=10`);
        if (!response.ok) throw new Error('Failed to load payouts');

        const data = await response.json();

        if (data.payouts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No payouts yet. Funds are automatically transferred to your bank account.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = data.payouts.map(p => {
          const statusColor = p.status === 'paid' ? 'var(--success)' : (p.status === 'pending' ? 'var(--warning)' : 'var(--text-muted)');

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon payout">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <div class="transaction-details">
                  <h4>Bank Transfer</h4>
                  <p style="color: ${statusColor};">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}  Arrives ${new Date(p.arrival_date).toLocaleDateString()}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount">$${p.amount.toFixed(2)}</div>
                <div class="date">${new Date(p.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Payouts error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load payouts</p>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
