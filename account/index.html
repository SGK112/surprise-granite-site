<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Account | Surprise Granite</title>
  <meta name="description" content="Manage your Surprise Granite account, view leads, and access your dashboard."/>
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
  <link href="/css/account/mobile-nav.css?v=20260119" rel="stylesheet"/>
  <!-- Google Maps API with Places library for address autocomplete and maps -->
  <script>
    // Stub for Google Maps callback - will be replaced/enhanced by main script
    var googleMapsReady = false;
    function initGoogleMaps() {
      console.log('[GoogleMaps] API loaded via callback');
      googleMapsReady = true;
      // Dispatch event for main script to initialize components
      document.dispatchEvent(new CustomEvent('googlemaps-ready'));
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxOFaHXjn5lKZ4DKueRWdH0W-Cb9TOJZE&libraries=places&callback=initGoogleMaps" async defer></script>
  <script src="/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3"></script>
  <script src="/js/supabase-init.js"></script>
  <script src="/js/sg-auth.js"></script>
  <script src="/js/auth-state.js"></script>
  <script src="/js/state-manager.js"></script>
  <script src="/js/shopify-cart.js"></script>
  <!-- Shepherd.js Tour Library -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@13.0.3/dist/css/shepherd.css"/>
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@13.0.3/dist/js/shepherd.min.js"></script>
  <style>
    :root {
      /* Primary brand colors */
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --gold: #f9cb00; /* Alias for --gold-primary */
      --primary: #f9cb00; /* Alias for --gold-primary */
      --primary-hover: #e6b800; /* Darker gold for hover states */
      --accent: #f9cb00; /* Alias for primary accent */
      --accent-hover: #e6b800;

      /* Dark theme colors */
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --dark: #1a1a2e; /* Alias for --dark-primary */
      --surface: #1e1e2d; /* Alias for --dark-elevated */

      /* Text colors */
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);

      /* Border colors */
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-light: rgba(255, 255, 255, 0.15);

      /* Status colors */
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;

      /* Legacy compatibility */
      --success-old: #4dff82;
      --warning-old: #ffb84d;
      --error-old: #ff6b6b;
      --info-old: #4da6ff;

      /* Background aliases (for components) */
      --dark-bg: #0a0a12;
      --bg-primary: #0a0a12;
      --bg-secondary: #12121a;
      --bg-card: #1a1a24;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Global micro-interactions */
    button, .btn, .btn-modern, .toolbar-btn, .nav-item, .filter-pill, .view-btn {
      transition: all 0.2s ease;
    }

    /* Smooth scroll behavior */
    html {
      scroll-behavior: smooth;
    }

    /* Focus visible styling for accessibility */
    :focus-visible {
      outline: 2px solid var(--gold-primary);
      outline-offset: 2px;
    }

    /* Remove focus outline for mouse users */
    :focus:not(:focus-visible) {
      outline: none;
    }

    /* Selection styling */
    ::selection {
      background: rgba(249, 203, 0, 0.3);
      color: var(--text-primary);
    }

    /* Subtle pulse animation for important elements */
    @keyframes subtlePulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* Loading shimmer effect */
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .loading-shimmer {
      background: linear-gradient(90deg, var(--dark-elevated) 25%, var(--dark-surface) 50%, var(--dark-elevated) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    /* Loading spinner component */
    .loading-spinner {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .loading-spinner::before {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-light);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-spinner.large::before {
      width: 32px;
      height: 32px;
      border-width: 3px;
    }

    .loading-spinner.small::before {
      width: 14px;
      height: 14px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Full page loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 16px;
      z-index: 99999;
    }

    .loading-overlay .loading-spinner::before {
      width: 40px;
      height: 40px;
      border-width: 3px;
    }

    /* Unified Nav Offset - account for fixed header */
    :root {
      --unified-nav-height: 140px; /* Match unified-nav.css --nav-height-desktop */
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 72px;
    }

    @media (max-width: 991px) {
      :root {
        --unified-nav-height: 64px; /* Match unified-nav.css --nav-height-mobile */
      }
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text-primary);
      padding-top: var(--unified-nav-height); /* Space for fixed unified nav */
    }

    /* Custom scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--dark-deep);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Firefox scrollbar */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--border-light) var(--dark-deep);
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: var(--unified-nav-height);
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: width 0.3s ease, transform 0.3s ease;
      /* Position context for toggle button */
      isolation: isolate;
    }

    /* Collapsed Sidebar State */
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
    }

    .sidebar.collapsed .sidebar-header {
      padding: 0 12px 24px;
    }

    .sidebar.collapsed .sidebar-logo-text,
    .sidebar.collapsed .sidebar-logo-sub {
      display: none;
    }

    .sidebar.collapsed .nav-section-title {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 12px;
    }

    .sidebar.collapsed .nav-item-text {
      display: none;
    }

    .sidebar.collapsed .nav-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 16px;
      padding: 2px 5px;
      font-size: 9px;
    }

    .sidebar.collapsed .nav-item {
      position: relative;
    }

    .sidebar.collapsed .sidebar-footer {
      padding: 16px 12px;
    }

    .sidebar.collapsed .user-info,
    .sidebar.collapsed .logout-btn {
      display: none;
    }

    .sidebar.collapsed .user-menu {
      justify-content: center;
    }

    /* Hide zero badges */
    .nav-badge.empty,
    .nav-badge[data-count="0"] {
      display: none;
    }

    .sidebar-header {
      padding: 20px 24px 24px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-primary);
      flex: 1;
      min-width: 0;
    }

    /* Sidebar Collapse Button */
    .sidebar-collapse-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .sidebar-collapse-btn:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: var(--gold-primary);
      color: var(--gold-primary);
    }

    .sidebar.collapsed .sidebar-collapse-btn {
      transform: rotate(180deg);
    }

    .sidebar.collapsed .sidebar-header {
      justify-content: center;
    }

    .sidebar.collapsed .sidebar-logo {
      display: none;
    }

    .sidebar-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: var(--dark-primary);
    }

    .sidebar-logo-text {
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-logo-sub {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* FORCE SIDEBAR NAV VISIBILITY - Override any interference */
    .sidebar-nav,
    nav.sidebar-nav,
    .sidebar .sidebar-nav,
    #sidebar .sidebar-nav {
      flex: 1;
      padding: 0 12px;
      overflow-y: auto;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      max-height: none !important;
      position: relative !important;
      transform: none !important;
      left: auto !important;
      top: auto !important;
    }

    .nav-section,
    .sidebar-nav .nav-section {
      margin-bottom: 24px;
    }

    .nav-section.hidden,
    .sidebar-nav .nav-section.hidden {
      display: none !important;
    }

    .nav-item,
    .sidebar-nav .nav-item {
      display: flex;
    }

    .nav-item.hidden,
    .sidebar-nav .nav-item.hidden {
      display: none !important;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(249, 203, 0, 0.1);
      color: var(--gold-primary);
      position: relative;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 24px;
      background: var(--gold-primary);
      border-radius: 0 2px 2px 0;
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    .nav-badge {
      margin-left: auto;
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      font-size: 11px;
      font-weight: 800;
      padding: 3px 10px;
      border-radius: 100px;
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 20px;
      text-align: center;
    }

    .nav-badge.empty {
      background: var(--border-subtle);
      color: var(--text-muted);
      box-shadow: none;
      border: none;
    }

    /* NEW Feature Badge */
    .new-feature-badge {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      animation: pulse-new 2s ease-in-out infinite;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
      margin-left: 8px;
    }

    @keyframes pulse-new {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .nav-section-title .new-feature-badge {
      margin-left: 8px;
      font-size: 8px;
      padding: 2px 5px;
    }

    /* Shepherd.js Tour Theme Overrides */
    .shepherd-element {
      background: #1e293b !important;
      border: 1px solid var(--gold-primary) !important;
      border-radius: 12px !important;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5) !important;
      max-width: 380px !important;
    }
    .shepherd-arrow:before {
      background: #1e293b !important;
      border-color: var(--gold-primary) !important;
    }
    .shepherd-content { padding: 0 !important; }
    .shepherd-header {
      background: transparent !important;
      padding: 16px 20px 8px !important;
      border-bottom: none !important;
    }
    .shepherd-title {
      color: #fff !important;
      font-size: 16px !important;
      font-weight: 700 !important;
      font-family: 'Inter', sans-serif !important;
    }
    .shepherd-cancel-icon { color: rgba(255,255,255,0.5) !important; }
    .shepherd-cancel-icon:hover { color: #fff !important; }
    .shepherd-text {
      color: rgba(255,255,255,0.75) !important;
      font-size: 14px !important;
      line-height: 1.6 !important;
      padding: 0 20px 16px !important;
      font-family: 'Inter', sans-serif !important;
    }
    .shepherd-footer {
      padding: 12px 20px 16px !important;
      border-top: 1px solid rgba(255,255,255,0.1) !important;
    }
    .shepherd-button {
      background: transparent !important;
      border: 1px solid rgba(255,255,255,0.2) !important;
      color: rgba(255,255,255,0.75) !important;
      border-radius: 8px !important;
      padding: 8px 16px !important;
      font-size: 13px !important;
      font-weight: 600 !important;
      font-family: 'Inter', sans-serif !important;
      transition: all 0.2s !important;
    }
    .shepherd-button:hover {
      background: rgba(255,255,255,0.1) !important;
      color: #fff !important;
    }
    .shepherd-button.shepherd-button-primary {
      background: linear-gradient(135deg, #f9cb00 0%, #cca600 100%) !important;
      border: none !important;
      color: #1a1a2e !important;
    }
    .shepherd-button.shepherd-button-primary:hover {
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 12px rgba(249, 203, 0, 0.4) !important;
    }
    .shepherd-modal-overlay-container { fill: rgba(0, 0, 0, 0.75) !important; }

    /* Enhanced Navigation Section Styles */
    .nav-section:first-child {
      margin-top: 0;
    }

    .nav-section:first-child .nav-item {
      background: rgba(249, 203, 0, 0.05);
      border: 1px solid var(--border-subtle);
      margin-bottom: 4px;
    }

    .nav-section:first-child .nav-item.active {
      background: rgba(249, 203, 0, 0.15);
      border-color: var(--gold-primary);
    }

    .nav-section-title {
      position: relative;
      padding-left: 12px;
    }

    .nav-section-title::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 12px;
      background: var(--gold-primary);
      border-radius: 2px;
      opacity: 0.6;
    }

    /* Quick Links section styling */
    .nav-section-links {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid var(--border-subtle);
    }

    .nav-section-links .nav-item-link {
      color: var(--text-muted);
      font-size: 13px;
      padding: 10px 16px;
    }

    .nav-section-links .nav-item-link:hover {
      color: var(--gold-primary);
    }

    .nav-section-links .nav-item-link svg {
      width: 18px;
      height: 18px;
    }

    /* Business sections visual grouping */
    #sales-nav,
    #operations-nav,
    #finance-nav {
      position: relative;
    }

    #sales-nav .nav-section-title::before {
      background: #3b82f6;
    }

    #operations-nav .nav-section-title::before {
      background: #8b5cf6;
    }

    #finance-nav .nav-section-title::before {
      background: #22c55e;
    }

    #admin-nav .nav-section-title::before {
      background: #ef4444;
    }

    #vendor-nav .nav-section-title::before {
      background: #f59e0b;
    }

    /* GOD MODE section - ensure items are visible */
    #god-mode-nav .nav-item {
      display: flex !important;
      opacity: 1 !important;
      visibility: visible !important;
      height: auto !important;
      padding: 10px 12px;
      margin: 2px 0;
      border-radius: 6px;
      color: var(--text-primary);
    }

    #god-mode-nav .nav-item:hover {
      background: rgba(139, 92, 246, 0.2);
    }

    #god-mode-nav .nav-item.active {
      background: rgba(139, 92, 246, 0.3);
      color: #a855f7;
    }

    #god-mode-nav .nav-item svg {
      width: 18px;
      height: 18px;
      margin-right: 10px;
      flex-shrink: 0;
    }

    #god-mode-nav .nav-item-text {
      display: inline !important;
      opacity: 1 !important;
    }

    /* ==================== GOD MODE MOBILE RESPONSIVE ==================== */

    /* GOD MODE page headers */
    [id^="page-god-"] .page-header {
      flex-direction: column;
      align-items: stretch !important;
      gap: 16px;
    }

    [id^="page-god-"] .page-header > div:last-child {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    /* GOD MODE stat cards grid */
    [id^="page-god-"] .stat-card-mini {
      min-width: 120px;
    }

    /* GOD MODE tabs - horizontal scroll on mobile */
    .tabs-modern {
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      gap: 4px;
      padding-bottom: 8px;
    }

    .tabs-modern::-webkit-scrollbar {
      display: none;
    }

    .tabs-modern .tab-modern {
      flex-shrink: 0;
      white-space: nowrap;
      padding: 10px 16px;
      font-size: 13px;
    }

    /* GOD MODE tables - responsive wrapper */
    [id^="page-god-"] .card-body table {
      min-width: 600px;
    }

    [id^="page-god-"] .card-body {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Mobile-specific GOD MODE styles */
    @media (max-width: 768px) {
      /* GOD MODE nav section on mobile */
      #god-mode-nav {
        margin: 4px !important;
        padding: 6px !important;
      }

      #god-mode-nav .nav-item {
        padding: 12px 10px;
        font-size: 14px;
        min-height: 44px; /* Touch target */
      }

      #god-mode-nav .nav-item svg {
        width: 20px;
        height: 20px;
      }

      #god-mode-nav .nav-section-title {
        font-size: 12px;
        padding: 8px 10px;
      }
    }

    /* GOD Mode View Links */
    .god-view-link:hover {
      border-color: rgba(139, 92, 246, 0.5) !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
    }

    @media (max-width: 768px) {
      /* GOD MODE page titles */
      [id^="page-god-"] .page-title {
        font-size: 20px !important;
      }

      [id^="page-god-"] .page-subtitle {
        font-size: 13px !important;
      }

      /* GOD MODE stat cards - 2 columns on mobile */
      [id^="page-god-"] > div[style*="grid-template-columns"] {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }

      .stat-card-mini {
        padding: 12px !important;
      }

      .stat-card-mini .stat-card-value {
        font-size: 20px !important;
      }

      .stat-card-mini .stat-card-label {
        font-size: 11px !important;
      }

      /* GOD MODE buttons */
      [id^="page-god-"] .btn-modern {
        padding: 10px 14px !important;
        font-size: 13px !important;
        min-height: 44px;
      }

      /* GOD MODE cards */
      [id^="page-god-"] .card {
        border-radius: 12px;
      }

      [id^="page-god-"] .card-header {
        padding: 12px 16px;
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      [id^="page-god-"] .card-header .card-title {
        font-size: 15px;
      }

      /* GOD MODE tables on mobile */
      [id^="page-god-"] table th,
      [id^="page-god-"] table td {
        padding: 10px 12px !important;
        font-size: 12px !important;
      }

      [id^="page-god-"] table th {
        font-size: 11px !important;
      }

      /* GOD MODE search/filter inputs */
      [id^="page-god-"] input[type="text"],
      [id^="page-god-"] select {
        font-size: 16px !important; /* Prevents zoom on iOS */
        padding: 12px !important;
        min-height: 44px;
      }

      /* GOD MODE Analytics specific */
      #page-god-analytics .tabs-modern {
        margin: 0 -16px 16px;
        padding: 0 16px 8px;
      }

      #page-god-analytics [style*="grid-template-columns: repeat(auto-fit, minmax(400px"] {
        grid-template-columns: 1fr !important;
      }

      #page-god-analytics [style*="grid-template-columns: repeat(auto-fit, minmax(180px"] {
        grid-template-columns: repeat(3, 1fr) !important;
      }

      /* GOD MODE Customer Hub tabs */
      .god-customer-tab .card {
        margin-bottom: 16px;
      }

      /* GOD MODE Database textarea */
      #god-sql-query {
        font-size: 14px !important;
        min-height: 100px !important;
      }

      /* GOD MODE API Tester */
      #god-api-body {
        font-size: 14px !important;
      }

      /* GOD MODE Config page */
      #page-god-config [style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }

      /* GOD MODE Site Manager */
      #page-god-site [style*="grid-template-columns: repeat(auto-fit, minmax(280px"] {
        grid-template-columns: 1fr !important;
      }

      /* GA Status indicator */
      #god-ga-status {
        font-size: 11px !important;
        padding: 6px 10px !important;
      }

      #god-ga-connect-btn {
        font-size: 12px !important;
        padding: 8px 12px !important;
      }
    }

    /* Small mobile (< 480px) */
    @media (max-width: 480px) {
      [id^="page-god-"] > div[style*="grid-template-columns"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      #page-god-analytics [style*="grid-template-columns: repeat(auto-fit, minmax(180px"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }

      .tabs-modern .tab-modern {
        padding: 8px 12px;
        font-size: 12px;
      }

      [id^="page-god-"] .page-header > div:last-child {
        flex-direction: column;
      }

      [id^="page-god-"] .page-header > div:last-child > * {
        width: 100%;
      }
    }

    /* ==================== END GOD MODE MOBILE ==================== */

    /* Account type badges */
    .account-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .account-badge.homeowner {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .account-badge.pro {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.3);
    }

    .account-badge.pro::before {
      content: '\2605';
      font-size: 10px;
    }

    .account-badge.admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .account-badge.admin::before {
      content: '\2699';
      font-size: 10px;
    }

    /* Stat value styling */
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-primary);
      text-shadow: 0 0 20px rgba(249, 203, 0, 0.3);
    }

    .stat-card:hover .stat-value {
      text-shadow: 0 0 30px rgba(249, 203, 0, 0.5);
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--dark-primary);
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
    }

    /* Page Toolbar (Quick Actions) */
    .page-toolbar {
      position: fixed;
      left: var(--sidebar-width);
      top: var(--unified-nav-height);
      bottom: 0;
      width: 56px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      padding: 16px 8px;
      gap: 8px;
      z-index: 99;
      transition: left 0.3s ease;
    }

    body.sidebar-collapsed .page-toolbar {
      left: var(--sidebar-collapsed-width);
    }

    .toolbar-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .toolbar-divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 8px 0;
    }

    .toolbar-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      position: relative;
    }

    .toolbar-btn:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: rgba(249, 203, 0, 0.3);
      color: var(--gold-primary);
      transform: scale(1.05);
    }

    .toolbar-btn:active {
      transform: scale(0.95);
    }

    .toolbar-btn.active {
      background: rgba(249, 203, 0, 0.15);
      border-color: var(--gold-primary);
      color: var(--gold-primary);
    }

    .toolbar-btn.active::before {
      content: '';
      position: absolute;
      left: -1px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 24px;
      background: var(--gold-primary);
      border-radius: 0 2px 2px 0;
    }

    /* Tooltip on hover */
    .toolbar-btn::after {
      content: attr(title);
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 8px;
      padding: 6px 10px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      pointer-events: none;
      z-index: 1000;
    }

    .toolbar-btn:hover::after {
      opacity: 1;
      visibility: visible;
    }

    /* General purpose tooltip utility */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      margin-bottom: 6px;
      padding: 6px 10px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      pointer-events: none;
      z-index: 1000;
    }

    [data-tooltip]:hover::after {
      opacity: 1;
      visibility: visible;
    }

    [data-tooltip-pos="right"]::after {
      bottom: auto;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      margin-bottom: 0;
      margin-left: 8px;
    }

    [data-tooltip-pos="left"]::after {
      bottom: auto;
      left: auto;
      right: 100%;
      top: 50%;
      transform: translateY(-50%);
      margin-bottom: 0;
      margin-right: 8px;
    }

    [data-tooltip-pos="bottom"]::after {
      bottom: auto;
      top: 100%;
      margin-bottom: 0;
      margin-top: 6px;
    }

    /* Adjust main content for toolbar */
    .main-content {
      margin-left: calc(var(--sidebar-width) + 56px) !important;
      transition: margin-left 0.3s ease;
    }

    body.sidebar-collapsed .main-content {
      margin-left: calc(var(--sidebar-collapsed-width) + 56px) !important;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
      padding-top: 24px; /* Slight offset below sidebar logo */
    }

    body.sidebar-collapsed .main-content {
      margin-left: var(--sidebar-collapsed-width);
    }

    .topbar {
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 40px; /* Increased padding for better spacing */
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: var(--unified-nav-height); /* Stick below unified nav */
      z-index: 50;
    }

    .topbar-title {
      font-size: 20px;
      font-weight: 700;
    }

    .topbar-actions {
      display: flex;
      gap: 12px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      padding: 8px;
      cursor: pointer;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Modern Button System */
    .btn-modern {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
      min-height: 44px; /* Touch-friendly */
    }

    .btn-modern:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-modern.primary {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    .btn-modern.primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(249, 203, 0, 0.3);
    }

    .btn-modern.primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(249, 203, 0, 0.2);
    }

    .btn-modern.secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-modern.secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .btn-modern.secondary:active:not(:disabled) {
      background: rgba(255, 255, 255, 0.15);
    }

    .btn-modern.success {
      background: var(--success);
      color: white;
    }

    .btn-modern.success:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    .btn-modern.danger {
      background: var(--error);
      color: white;
    }

    .btn-modern.danger:hover:not(:disabled) {
      filter: brightness(1.1);
    }

    .btn-modern.small {
      padding: 8px 12px;
      font-size: 13px;
      min-height: 36px;
    }

    .btn-modern.large {
      padding: 16px 28px;
      font-size: 16px;
      min-height: 52px;
    }

    .btn-modern.ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-modern.ghost:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .btn-modern.outline {
      background: transparent;
      color: var(--gold-primary);
      border: 1px solid var(--gold-primary);
    }

    .btn-modern.outline:hover:not(:disabled) {
      background: rgba(249, 203, 0, 0.1);
    }

    .btn-modern.loading {
      pointer-events: none;
      position: relative;
      color: transparent;
    }

    .btn-modern.loading::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border: 2px solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: btnSpin 0.6s linear infinite;
    }

    @keyframes btnSpin {
      to { transform: rotate(360deg); }
    }

    /* Notification Panel Styles */
    .notification-item:hover {
      background: rgba(255, 255, 255, 0.05) !important;
    }

    .notification-item.unread {
      background: rgba(59, 130, 246, 0.08);
      border-left: 3px solid var(--info);
    }

    .notification-badge {
      animation: pulse-badge 2s infinite;
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .notification-panel {
      animation: slideIn 0.2s ease-out;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Filter Pills */
    .filter-pills {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      padding: 4px 0;
    }

    .filter-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .filter-pill:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .filter-pill.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .filter-pill:active {
      transform: scale(0.98);
    }

    .filter-pill span {
      font-size: 11px;
      padding: 2px 6px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    .filter-pill.active span {
      background: rgba(0, 0, 0, 0.15);
    }

    .content-area {
      padding: 32px 40px; /* Match topbar horizontal padding */
      max-width: none; /* Use full width */
      width: 100%;
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
      animation: pageIn 0.25s ease-out;
    }

    @keyframes pageIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Stats Grid */
    /* Accessibility - Focus States */
    :focus-visible {
      outline: 2px solid var(--gold-primary);
      outline-offset: 2px;
    }

    .btn-modern:focus-visible,
    .btn-primary:focus-visible,
    .btn-secondary:focus-visible,
    .filter-pill:focus-visible,
    .filter-btn:focus-visible,
    .nav-item:focus-visible {
      outline: 2px solid var(--gold-primary);
      outline-offset: 2px;
    }

    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: none;
      border-color: var(--gold-primary);
      box-shadow: 0 0 0 3px rgba(249, 203, 0, 0.2);
    }

    /* Skip to main content link (accessibility) */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold-primary);
      color: var(--dark-primary);
      padding: 8px 16px;
      z-index: 10000;
      transition: top 0.3s;
    }

    .skip-link:focus {
      top: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .stat-card.clickable {
      cursor: pointer;
    }

    .stat-card.clickable:hover {
      border-color: rgba(249, 203, 0, 0.3);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
    }

    /* Cards - Standardized (14px radius, 24px padding) */
    .card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      border-color: var(--border-light);
    }

    .card.highlight {
      border-left: 3px solid var(--gold-primary);
    }

    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
    }

    .card-body {
      padding: 24px;
    }

    /* Leads Grid Spacing */
    #leads-table {
      margin-top: 16px;
    }

    #leads-table .leads-grid {
      padding: 4px;
    }

    #leads-table .lead-card {
      margin-bottom: 0;
    }

    /* Calendar Events Container Spacing */
    .calendar-events {
      margin-top: 4px;
      padding-bottom: 4px;
    }

    /* Vendor Onboarding Banner */
    .vendor-onboarding-banner {
      background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 12px;
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .vendor-onboarding-banner .banner-text h3 { margin: 0 0 4px; font-size: 16px; color: var(--text-primary); }
    .vendor-onboarding-banner .banner-text p { margin: 0; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
    .vendor-onboarding-banner .banner-dismiss { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; padding: 4px 8px; line-height: 1; align-self: flex-start; }
    .vendor-onboarding-banner .banner-dismiss:hover { color: var(--text-primary); }
    @media (max-width: 600px) {
      .vendor-onboarding-banner { flex-direction: column; text-align: center; padding: 16px; }
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .action-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      padding: 20px;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .action-card:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: var(--gold-primary);
      transform: translateY(-2px);
    }

    /* Highlighted Action Card */
    .action-card.action-highlight {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.15) 0%, rgba(249, 203, 0, 0.08) 100%);
      border-color: var(--gold-primary);
    }

    .action-card.action-highlight:hover {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.25) 0%, rgba(249, 203, 0, 0.15) 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(249, 203, 0, 0.2);
    }

    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
      flex-shrink: 0;
    }

    .action-icon.action-icon-gold {
      background: var(--gold-primary);
      color: #1a1a2e;
    }

    .action-icon svg {
      width: 24px;
      height: 24px;
    }

    .action-text h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Stat Cards with icons */
    .stat-card {
      position: relative;
    }

    .stat-card.clickable {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-card.clickable:hover {
      transform: translateY(-2px);
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.08);
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .stat-icon svg {
      width: 24px;
      height: 24px;
    }

    /* Profile Form */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 18px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
      background: var(--dark-elevated);
      box-shadow: 0 0 0 3px rgba(249, 203, 0, 0.1);
    }

    .form-group input.error,
    .form-group select.error,
    .form-group textarea.error {
      border-color: var(--error);
    }

    .form-group input.error:focus,
    .form-group select.error:focus,
    .form-group textarea.error:focus {
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
    }

    .form-error {
      color: var(--error);
      font-size: 12px;
      margin-top: 6px;
    }

    .form-hint {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 6px;
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    /* Fix select dropdowns to be visible and match input styling */
    select,
    .form-section select,
    .estimate-line-item select,
    #create-estimate-modal select {
      background: var(--dark-elevated) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--border-subtle) !important;
      border-radius: 10px !important;
      padding: 14px 18px !important;
      font-size: 15px !important;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23f9cb00' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 14px center !important;
      padding-right: 40px !important;
      transition: all 0.3s;
    }

    select option,
    .form-section select option,
    #create-estimate-modal select option {
      background: #1e1e2d !important;
      color: #ffffff !important;
      padding: 12px !important;
    }

    select:focus {
      outline: none;
      border-color: var(--gold-primary) !important;
      box-shadow: 0 0 0 2px rgba(249, 203, 0, 0.2);
    }

    /* Estimate form specific input styling */
    #create-estimate-modal input,
    #create-estimate-modal textarea {
      background: var(--dark-elevated) !important;
      border: 1px solid var(--border-subtle) !important;
      color: var(--text-primary) !important;
    }

    #create-estimate-modal input:focus,
    #create-estimate-modal textarea:focus {
      border-color: var(--gold-primary) !important;
      box-shadow: 0 0 0 2px rgba(249, 203, 0, 0.2);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .form-row.cols-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .form-row.cols-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    .form-inline {
      display: flex;
      align-items: flex-end;
      gap: 12px;
    }

    .form-inline .form-group {
      flex: 1;
      margin-bottom: 0;
    }

    .form-inline .btn-modern {
      flex-shrink: 0;
    }

    /* Required field indicator */
    .form-group label.required::after {
      content: ' *';
      color: var(--error);
    }

    /* Saved Floors Grid */
    .saved-floors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .saved-floor-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .saved-floor-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .saved-floor-image {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .saved-floor-content {
      padding: 12px;
    }

    .saved-floor-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .saved-floor-material {
      font-size: 11px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .saved-floor-specs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .saved-floor-spec {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .saved-floor-actions {
      display: flex;
      gap: 8px;
    }

    .saved-floor-actions a,
    .saved-floor-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .saved-floor-view {
      background: var(--primary);
      color: var(--dark);
    }

    .saved-floor-remove {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    .saved-floor-remove:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    /* My Designs Grid */
    .designs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .design-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .design-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .design-preview {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .design-preview svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      opacity: 0.5;
    }

    .design-preview-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .design-preview-badge.shared {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .design-preview-badge.private {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .design-message-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      min-width: 22px;
      height: 22px;
      padding: 0 6px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      border-radius: 11px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s infinite;
    }

    .design-customer {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--gold-primary);
      margin-bottom: 8px;
      padding: 6px 10px;
      background: rgba(249, 203, 0, 0.1);
      border-radius: 6px;
      border-left: 3px solid var(--gold-primary);
    }

    .design-customer svg {
      flex-shrink: 0;
    }

    .design-customer span {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .design-btn-messages {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(239, 68, 68, 0.15) !important;
      color: #ef4444 !important;
      border-color: rgba(239, 68, 68, 0.3) !important;
    }

    .design-btn-messages .btn-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      background: #ef4444;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
      color: white;
    }

    .design-content {
      padding: 16px;
    }

    .design-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .design-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .design-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .design-actions {
      display: flex;
      gap: 8px;
    }

    .design-actions button,
    .design-actions a {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .design-btn-open {
      background: var(--primary);
      color: var(--dark);
    }

    .design-btn-open:hover {
      background: var(--primary-hover);
    }

    .design-btn-share {
      background: transparent;
      border: 1px solid var(--primary) !important;
      color: var(--primary);
    }

    .design-btn-share:hover {
      background: rgba(249, 203, 0, 0.1);
    }

    .design-btn-delete {
      background: transparent;
      border: 1px solid var(--border-subtle) !important;
      color: var(--text-secondary);
      flex: 0 0 auto;
      padding: 10px 12px;
    }

    .design-btn-delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444 !important;
      color: #ef4444;
    }

    /* Quote Request Modal */
    .quote-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .quote-modal-content {
      background: var(--dark-elevated);
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .quote-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quote-modal-body {
      padding: 20px;
    }

    .quote-items-list {
      margin-bottom: 20px;
    }

    .quote-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .quote-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }

    .quote-item-info {
      flex: 1;
    }

    .quote-item-title {
      font-size: 14px;
      font-weight: 600;
    }

    .quote-item-material {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Leads Table */
    .table-container {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .table-title {
      font-size: 16px;
      font-weight: 700;
    }

    .table-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-secondary);
    }

    .filter-btn:hover {
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--gold-primary);
      border-bottom-color: var(--gold-primary);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 8px 16px;
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 14px;
      width: 200px;
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 24px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid var(--border-subtle);
    }

    td {
      padding: 16px 24px;
      font-size: 14px;
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: middle;
      transition: background-color 0.15s ease;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.03);
    }

    tr.clickable {
      cursor: pointer;
    }

    tr.clickable:hover td {
      background: rgba(249, 203, 0, 0.05);
    }

    tr.selected {
      background: rgba(249, 203, 0, 0.05);
    }

    tr.selected td {
      background: rgba(249, 203, 0, 0.1);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .lead-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .lead-email {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-project {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
      letter-spacing: 0.3px;
      line-height: 1.2;
      vertical-align: middle;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Job Status Styles */
    .status-badge.job-new { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-badge.job-new::before { background: #f59e0b; }

    .status-badge.job-reviewing { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-badge.job-reviewing::before { background: #f59e0b; }

    .status-badge.job-material_ordered { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .status-badge.job-material_ordered::before { background: #06b6d4; }

    .status-badge.job-material_received { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .status-badge.job-material_received::before { background: #06b6d4; }

    .status-badge.job-assigned { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-badge.job-assigned::before { background: #3b82f6; }

    .status-badge.job-scheduled { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-badge.job-scheduled::before { background: #3b82f6; }

    .status-badge.job-measured { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .status-badge.job-measured::before { background: #8b5cf6; }

    .status-badge.job-in_production { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .status-badge.job-in_production::before { background: #8b5cf6; }

    .status-badge.job-ready { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-badge.job-ready::before { background: #10b981; }

    .status-badge.job-installing { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-badge.job-installing::before { background: #10b981; }

    .status-badge.job-completed { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-badge.job-completed::before { background: #22c55e; }

    .status-badge.job-on_hold { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-badge.job-on_hold::before { background: #6b7280; }

    .status-badge.job-cancelled { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-badge.job-cancelled::before { background: #ef4444; }

    .status-new { background: rgba(77, 166, 255, 0.15); color: var(--info); }
    .status-new::before { background: var(--info); }

    .status-contacted { background: rgba(255, 184, 77, 0.15); color: var(--warning); }
    .status-contacted::before { background: var(--warning); }

    .status-qualified { background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); }
    .status-qualified::before { background: var(--gold-primary); }

    .status-quoted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .status-quoted::before { background: #a855f7; }

    .status-won { background: rgba(77, 255, 130, 0.15); color: var(--success); }
    .status-won::before { background: var(--success); }

    .status-lost { background: rgba(255, 107, 107, 0.15); color: var(--error); }
    .status-lost::before { background: var(--error); }

    .status-archived { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-archived::before { background: #6b7280; }

    /* Estimate statuses */
    .status-draft { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }
    .status-draft::before { background: #9ca3af; }

    .status-sent { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-sent::before { background: #3b82f6; }

    .status-approved { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-approved::before { background: #22c55e; }

    .status-rejected { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-rejected::before { background: #ef4444; }

    .status-converted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .status-converted::before { background: #a855f7; }

    /* Invoice/Payment statuses */
    .status-open { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-open::before { background: #3b82f6; }

    .status-viewed { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .status-viewed::before { background: #8b5cf6; }

    .status-paid { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-paid::before { background: #22c55e; }

    .status-void { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-void::before { background: #6b7280; }

    .status-partial { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-partial::before { background: #f59e0b; }

    .status-overdue { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-overdue::before { background: #ef4444; }

    .status-refunded { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-refunded::before { background: #6b7280; }

    .status-pending { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-pending::before { background: #f59e0b; }

    .status-fulfilled { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-fulfilled::before { background: #22c55e; }

    .status-unfulfilled { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-unfulfilled::before { background: #f59e0b; }

    .status-partial_fulfillment { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .status-partial_fulfillment::before { background: #06b6d4; }

    .status-scheduled { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-scheduled::before { background: #3b82f6; }

    .status-in_progress { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .status-in_progress::before { background: #06b6d4; }

    .status-completed { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-completed::before { background: #22c55e; }

    .status-cancelled { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-cancelled::before { background: #ef4444; }

    .lead-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      text-decoration: none;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
      background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.1) 100%);
      border-radius: 12px;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
      color: var(--gold-primary);
    }

    .empty-state h3 {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state p {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 320px;
      margin: 0 auto;
      line-height: 1.5;
    }

    /* Coming Soon */
    .coming-soon {
      text-align: center;
      padding: 80px 24px;
    }

    .coming-soon-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 20px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
    }

    .coming-soon-icon svg {
      width: 40px;
      height: 40px;
    }

    .coming-soon h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .coming-soon p {
      color: var(--text-muted);
      max-width: 400px;
      margin: 0 auto;
    }

    /* Modal - base styles, visibility controlled by .active class */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    /* Modal Modern Styles - Base (Desktop) */
    .modal-modern-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-modern-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-modern {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .modal-modern-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--dark-surface);
      position: sticky;
      top: 0;
      z-index: 5;
    }

    .modal-modern-header h2 {
      font-size: 18px;
      font-weight: 700;
      margin: 0;
    }

    .modal-modern-body {
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
      min-height: 300px;
      max-height: 50vh;
    }

    .modal-modern-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: var(--dark-surface);
      position: sticky;
      bottom: 0;
      z-index: 5;
    }

    .modal-drag-handle {
      display: none;
    }

    .detail-section {
      margin-bottom: 8px;
    }

    .detail-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    .modal-body {
      padding: 24px;
    }

    .detail-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    /* Invoice Template Selector */
    .template-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .template-option {
      cursor: pointer;
    }

    .template-option input {
      display: none;
    }

    .template-preview {
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s;
      background: var(--dark-surface);
    }

    .template-option input:checked + .template-preview {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.1);
    }

    .template-preview:hover {
      border-color: var(--border-light);
    }

    .template-header-preview {
      height: 24px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .template-body-preview {
      height: 40px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .classic-preview .template-header-preview {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
    }
    .classic-preview .template-body-preview {
      background: #f4f4f4;
    }

    .modern-preview .template-header-preview {
      background: linear-gradient(90deg, #000, #333);
    }
    .modern-preview .template-body-preview {
      background: #ffffff;
      border: 1px solid #eee;
    }

    .premium-preview .template-header-preview {
      background: linear-gradient(135deg, #0a0a12, #12121a);
    }
    .premium-preview .template-body-preview {
      background: linear-gradient(135deg, #f9cb00, #d4a800);
    }

    .template-name {
      display: block;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .template-desc {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .template-selector {
        grid-template-columns: 1fr;
      }
    }

    /* Template Preview Modal */
    .template-tabs {
      display: flex;
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
    }

    .template-tab {
      flex: 1;
      padding: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .template-tab:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .template-tab.active {
      background: rgba(249, 203, 0, 0.1);
      border-bottom-color: var(--gold-primary);
    }

    .template-tab .tab-icon {
      display: block;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .template-tab .tab-label {
      display: block;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .template-tab .tab-desc {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
    }

    .template-tab.active .tab-label {
      color: var(--gold-primary);
    }

    .template-preview-container {
      background: #888;
      height: 500px;
      overflow: hidden;
    }

    .template-preview-frame {
      width: 100%;
      height: 100%;
    }

    .template-preview-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #f4f4f4;
    }

    @media (max-width: 768px) {
      .template-tabs {
        flex-direction: column;
      }

      .template-tab {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .template-tab .tab-icon {
        margin-bottom: 0;
        font-size: 20px;
      }

      .template-preview-container {
        height: 400px;
      }
    }

    .status-select {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .status-select:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    /* Auth Screens */
    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-deep);
      padding: 20px;
    }

    .auth-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 48px 40px;
      width: 100%;
      max-width: 440px;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-weight: 800;
      font-size: 24px;
      color: var(--dark-primary);
    }

    .auth-header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: var(--text-muted);
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 24px;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
    }

    .auth-message {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .auth-message.visible {
      display: block;
    }

    .auth-message.error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--error);
    }

    .auth-message.success {
      background: rgba(77, 255, 130, 0.1);
      border: 1px solid rgba(77, 255, 130, 0.3);
      color: var(--success);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      color: var(--dark-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .auth-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .auth-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-subtle);
    }

    .auth-divider span {
      padding: 0 12px;
    }

    .btn-google {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      color: #3c4043;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-google:hover {
      background: #f8f9fa;
      border-color: #c6c6c6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn-google:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-google svg {
      flex-shrink: 0;
    }

    /* Signup Steps */
    .signup-step {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeSlideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastSlideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes toastSlideOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-20px); }
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .step-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .step-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .step-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
    }

    .step-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 16px;
      transition: color 0.2s;
    }

    .step-back:hover {
      color: var(--gold-primary);
    }

    .step-back svg {
      color: inherit;
    }

    /* Account Type Cards */
    .account-type-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .account-type-card {
      position: relative;
      background: var(--dark-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .account-type-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .account-type-card.selected {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .account-type-card.selected::before {
      content: '';
      position: absolute;
      top: 12px;
      right: 70px;
      width: 24px;
      height: 24px;
      background: var(--gold-primary);
      border-radius: 50%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%231a1a2e'%3E%3Cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-size: 16px;
      background-position: center;
      background-repeat: no-repeat;
    }

    .type-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .type-icon svg {
      width: 28px;
      height: 28px;
      color: var(--text-secondary);
    }

    .type-icon.pro {
      background: rgba(249, 203, 0, 0.1);
    }

    .type-icon.pro svg {
      color: var(--gold-primary);
    }

    .type-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .type-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .type-features {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .type-features li {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .type-features .check-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--success);
    }

    .type-features .check-icon.gold {
      color: var(--gold-primary);
    }

    .type-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-badge.free {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .type-badge.pro {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
    }

    /* Signup Terms */
    .signup-terms {
      margin-bottom: 20px;
    }

    .checkbox-label {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      cursor: pointer;
      font-size: 14px !important;
      color: var(--text-secondary) !important;
      line-height: 1.5;
      text-transform: none !important;
      margin-bottom: 0 !important;
    }

    .checkbox-label input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
      accent-color: var(--gold-primary);
      flex-shrink: 0;
      cursor: pointer;
    }

    .checkbox-label span {
      text-transform: none !important;
      font-weight: 400 !important;
    }

    .checkbox-label a {
      color: var(--gold-primary);
      text-decoration: none;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    /* Pro Note */
    .pro-note {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: rgba(249, 203, 0, 0.1);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .pro-note svg {
      color: var(--gold-primary);
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* Responsive adjustments */
    @media (min-width: 600px) {
      .account-type-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .account-type-card {
        padding: 24px 20px;
      }
    }

    /* Loading */
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    .spinner-modern {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Product Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .product-image {
      height: 180px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .product-placeholder svg {
      width: 48px;
      height: 48px;
    }

    .product-info {
      padding: 16px;
    }

    .product-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .product-status.status-active {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .product-status.status-draft {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .product-status.status-sold {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .product-category {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .product-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold-primary);
    }

    .product-dims {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .product-actions {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.02);
    }

    /* Calendar Styles */
    .calendar-container {
      background: var(--dark-elevated);
      border-radius: 0 0 12px 12px;
      overflow: visible;
    }

    .calendar-header-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
    }

    .calendar-header-cell {
      padding: 16px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-day {
      min-height: 120px;
      padding: 10px;
      border-right: 1px solid rgba(255, 255, 255, 0.08);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      background: linear-gradient(180deg, rgba(30, 30, 45, 0.8) 0%, rgba(26, 26, 46, 0.9) 100%);
      transition: all 0.2s;
      cursor: pointer;
      position: relative;
    }

    .calendar-day:nth-child(7n) {
      border-right: none;
    }

    .calendar-day:hover {
      background: linear-gradient(180deg, rgba(40, 40, 60, 0.9) 0%, rgba(35, 35, 55, 1) 100%);
      box-shadow: inset 0 0 0 1px rgba(249, 203, 0, 0.2);
    }

    .calendar-day.other-month {
      background: rgba(15, 15, 25, 0.6);
    }

    .calendar-day.other-month .calendar-day-number {
      opacity: 0.4;
    }

    .calendar-day.today {
      background: linear-gradient(180deg, rgba(249, 203, 0, 0.12) 0%, rgba(249, 203, 0, 0.06) 100%);
      box-shadow: inset 0 0 0 2px rgba(249, 203, 0, 0.3);
    }

    .calendar-day.today .calendar-day-number {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.4);
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .calendar-events {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .calendar-event {
      position: relative;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: grab;
      user-select: none;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
    }

    .calendar-event:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .calendar-event:active {
      cursor: grabbing;
    }

    .calendar-event.job {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.35) 0%, rgba(59, 130, 246, 0.2) 100%);
      color: #93c5fd;
      border-left: 3px solid #3b82f6;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.3);
    }

    .calendar-event.install {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.35) 0%, rgba(16, 185, 129, 0.2) 100%);
      color: #6ee7b7;
      border-left: 3px solid #10b981;
      box-shadow: inset 0 0 0 1px rgba(16, 185, 129, 0.3);
    }

    .calendar-event.measure {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.35) 0%, rgba(245, 158, 11, 0.2) 100%);
      color: #fcd34d;
      border-left: 3px solid #f59e0b;
      box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.3);
    }

    .calendar-event.production {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.35) 0%, rgba(139, 92, 246, 0.2) 100%);
      color: #c4b5fd;
      border-left: 3px solid #8b5cf6;
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.3);
    }

    .calendar-event.appointment {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.35) 0%, rgba(249, 203, 0, 0.2) 100%);
      color: #fde047;
      border-left: 3px solid #f9cb00;
      box-shadow: inset 0 0 0 1px rgba(249, 203, 0, 0.3);
    }

    .calendar-event.consultation {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.35) 0%, rgba(99, 102, 241, 0.2) 100%);
      color: #a5b4fc;
      border-left: 3px solid #6366f1;
      box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.3);
    }

    .calendar-event.followup {
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.35) 0%, rgba(236, 72, 153, 0.2) 100%);
      color: #f9a8d4;
      border-left: 3px solid #ec4899;
      box-shadow: inset 0 0 0 1px rgba(236, 72, 153, 0.3);
    }

    .calendar-event.delivery {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.35) 0%, rgba(6, 182, 212, 0.2) 100%);
      color: #67e8f9;
      border-left: 3px solid #06b6d4;
      box-shadow: inset 0 0 0 1px rgba(6, 182, 212, 0.3);
    }

    .calendar-event.other {
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.35) 0%, rgba(107, 114, 128, 0.2) 100%);
      color: #d1d5db;
      border-left: 3px solid #6b7280;
      box-shadow: inset 0 0 0 1px rgba(107, 114, 128, 0.3);
    }

    /* Calendar Drag & Drop Styles */
    .calendar-event {
      will-change: transform, opacity;
    }

    .calendar-event.dragging {
      opacity: 0.5;
      transform: scale(0.95);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      pointer-events: none;
    }

    .calendar-day {
      transition: background-color 0.1s ease-out, border-color 0.1s ease-out;
      will-change: background-color, border-color;
    }

    .calendar-day.drop-target-ready {
      background: rgba(249, 203, 0, 0.03);
    }

    .calendar-day.drag-over {
      background: rgba(249, 203, 0, 0.12) !important;
      border: 2px dashed var(--gold-primary) !important;
      border-radius: 6px;
      transform: scale(1.01);
    }

    .calendar-day.drag-over .calendar-day-number {
      color: var(--gold-primary);
      font-weight: 700;
    }

    /* Ensure child elements don't intercept drop events during drag */
    .calendar-day.drop-target-ready > *,
    .calendar-day.drag-over > * {
      pointer-events: none;
    }

    /* Ensure calendar allows drag and drop - override mobile styles during drag */
    body.dragging-active .calendar-container,
    body.dragging-active .calendar-grid,
    body.dragging-active .card:has(.calendar-grid) {
      overflow: visible !important;
    }

    /* Quick Add Toolbar */
    .quick-add-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
    }

    .quick-add-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 6px;
      cursor: grab;
      user-select: none;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      background: color-mix(in srgb, var(--item-color) 15%, transparent);
      border-left: 3px solid var(--item-color);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      will-change: transform;
    }

    .quick-add-item i {
      font-size: 14px;
      color: var(--item-color);
      width: 18px;
      text-align: center;
    }

    .quick-add-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      background: color-mix(in srgb, var(--item-color) 22%, transparent);
    }

    .quick-add-item:active,
    .quick-add-item.dragging {
      cursor: grabbing;
      transform: scale(0.98);
      opacity: 0.7;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    /* Smooth drag ghost */
    .quick-add-item[draggable="true"] {
      -webkit-user-drag: element;
    }

    /* Fix: Allow drag overflow for Quick Add container */
    .card:has(.quick-add-grid) {
      overflow: visible;
    }

    /* Also fix calendar event dragging */
    .card:has(.calendar-grid),
    .calendar-grid {
      overflow: visible;
    }

    .calendar-event-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    /* Context Menu Styles */
    .context-menu {
      position: fixed;
      z-index: 10000;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 8px 0;
      min-width: 200px;
      max-width: 280px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: none;
    }

    .context-menu.visible {
      display: block;
    }

    .context-menu-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      background: transparent;
    }

    .context-menu-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 8px;
    }

    .context-menu-header .title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .context-menu-header .subtitle {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      font-size: 13px;
      color: var(--text-primary);
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s;
    }

    .context-menu-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .context-menu-item i {
      width: 18px;
      font-size: 14px;
      color: var(--text-secondary);
      text-align: center;
    }

    .context-menu-item svg {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    .context-menu-item.primary {
      color: var(--gold-primary);
    }

    .context-menu-item.primary i,
    .context-menu-item.primary svg {
      color: var(--gold-primary);
    }

    .context-menu-item.success {
      color: #10b981;
    }

    .context-menu-item.success i,
    .context-menu-item.success svg {
      color: #10b981;
    }

    .context-menu-item.warning {
      color: #f59e0b;
    }

    .context-menu-item.warning i,
    .context-menu-item.warning svg {
      color: #f59e0b;
    }

    .context-menu-item.danger {
      color: #ef4444;
    }

    .context-menu-item.danger i,
    .context-menu-item.danger svg {
      color: #ef4444;
    }

    .context-menu-divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 8px 0;
    }

    .context-menu-item.has-submenu {
      position: relative;
    }

    .context-submenu {
      display: none;
      position: absolute;
      left: 100%;
      top: 0;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 8px 0;
      min-width: 160px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .context-menu-item.has-submenu:hover .context-submenu {
      display: block;
    }

    .context-active {
      background: rgba(249, 203, 0, 0.1) !important;
    }

    /* Trust Score Badge */
    .trust-score-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--dark-elevated) 0%, var(--dark-surface) 100%);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      min-width: 80px;
    }

    .trust-score-badge.verified {
      border-color: var(--gold-primary);
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, var(--dark-surface) 100%);
    }

    .trust-score-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-primary);
      line-height: 1;
    }

    .trust-score-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* Verification Checklist Item */
    .verification-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--dark-elevated);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }

    .verification-item.completed {
      border-color: rgba(34, 197, 94, 0.3);
      background: rgba(34, 197, 94, 0.05);
    }

    .verification-item.pending {
      border-color: rgba(245, 158, 11, 0.3);
      background: rgba(245, 158, 11, 0.05);
    }

    .verification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .verification-icon.completed {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .verification-icon.pending {
      background: rgba(107, 114, 128, 0.2);
      color: #6b7280;
    }

    .verification-item-text {
      flex: 1;
    }

    .verification-item-title {
      font-weight: 500;
      font-size: 13px;
    }

    .verification-item-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .verification-item-points {
      font-size: 11px;
      font-weight: 600;
      color: var(--gold-primary);
    }

    /* Document Card */
    .document-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--dark-elevated);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 8px;
    }

    .document-card .doc-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--dark-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .document-card .doc-info {
      flex: 1;
      min-width: 0;
    }

    .document-card .doc-name {
      font-weight: 500;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .document-card .doc-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .document-card .doc-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }

    .document-card .doc-status.approved {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .document-card .doc-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .document-card .doc-status.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .calendar-event-more {
      font-size: 10px;
      color: var(--text-muted);
      padding: 2px 4px;
      cursor: pointer;
    }

    .calendar-event-more:hover {
      color: var(--gold-primary);
    }

    /* Upcoming Events List */
    .upcoming-event-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.2s;
      cursor: pointer;
    }

    .upcoming-event-item:last-child {
      border-bottom: none;
    }

    .upcoming-event-item:hover {
      background: var(--dark-surface);
    }

    .upcoming-event-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 60px;
      padding: 8px 12px;
      background: var(--dark-surface);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }

    .upcoming-event-date .day {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold-primary);
      line-height: 1;
    }

    .upcoming-event-date .month {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .upcoming-event-info {
      flex: 1;
    }

    .upcoming-event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .upcoming-event-details {
      font-size: 13px;
      color: var(--text-muted);
    }

    .upcoming-event-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Wallet Balance Cards */
    .wallet-balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .balance-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .balance-card.available::before {
      background: linear-gradient(90deg, var(--success), #2dd4bf);
    }

    .balance-card.pending::before {
      background: linear-gradient(90deg, var(--warning), #fb923c);
    }

    .balance-card.total::before {
      background: linear-gradient(90deg, var(--gold-primary), var(--gold-dark));
    }

    .balance-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .balance-card.available .balance-amount {
      color: var(--success);
    }

    .balance-card.pending .balance-amount {
      color: var(--warning);
    }

    .balance-card.total .balance-amount {
      color: var(--gold-primary);
    }

    .balance-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .transaction-row:last-child {
      border-bottom: none;
    }

    .transaction-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .transaction-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .transaction-icon.income {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .transaction-icon.payout {
      background: rgba(77, 166, 255, 0.15);
      color: var(--info);
    }

    .transaction-icon.fee {
      background: rgba(255, 107, 107, 0.15);
      color: var(--error);
    }

    .transaction-details h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .transaction-details p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-amount {
      text-align: right;
    }

    .transaction-amount .amount {
      font-size: 16px;
      font-weight: 600;
    }

    .transaction-amount .amount.positive {
      color: var(--success);
    }

    .transaction-amount .amount.negative {
      color: var(--error);
    }

    .transaction-amount .date {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Fees Grid */
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .fee-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
    }

    .fee-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .fee-header svg {
      color: var(--gold-primary);
    }

    .fee-rate {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .fee-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .fee-note {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: rgba(249, 203, 0, 0.05);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .fee-note svg {
      flex-shrink: 0;
      color: var(--gold-primary);
      margin-top: 2px;
    }

    .fee-note strong {
      color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 991px) {
      .sidebar {
        transform: translateX(-100%);
        top: var(--unified-nav-height);
        width: 85%;
        max-width: 320px;
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      /* Make nav items larger for touch */
      .sidebar .nav-item {
        padding: 14px 20px;
        min-height: 48px;
        font-size: 15px;
      }

      .sidebar .nav-item svg {
        width: 22px;
        height: 22px;
      }

      /* Section titles */
      .sidebar .nav-section-title {
        padding: 12px 20px 8px;
        font-size: 11px;
      }

      /* User menu at bottom */
      .sidebar .sidebar-footer {
        padding: 16px 20px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }

      .sidebar .user-menu {
        padding: 12px;
      }

      /* Disable collapsed state on mobile */
      .sidebar.collapsed {
        width: 85%;
        max-width: 320px;
      }

      .sidebar.collapsed .sidebar-logo-text,
      .sidebar.collapsed .sidebar-logo-sub,
      .sidebar.collapsed .nav-section-title,
      .sidebar.collapsed .nav-item-text,
      .sidebar.collapsed .user-info,
      .sidebar.collapsed .logout-btn {
        display: block;
        opacity: 1;
        height: auto;
      }

      .sidebar.collapsed .nav-item {
        justify-content: flex-start;
        padding: 14px 20px;
      }

      .sidebar.collapsed .nav-badge {
        position: static;
        min-width: 20px;
        padding: 3px 10px;
        font-size: 11px;
      }

      /* Hide page toolbar on tablet/mobile */
      .page-toolbar {
        display: none;
      }

      /* Reset main content margin without toolbar */
      .main-content {
        margin-left: 0 !important;
      }

      /* Hide sidebar collapse button on mobile */
      .sidebar-collapse-btn {
        display: none;
      }

      /* Enhanced mobile navigation */
      .sidebar .nav-section {
        margin-bottom: 16px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-subtle);
      }

      .sidebar .nav-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
      }

      .sidebar .nav-section-title {
        font-size: 10px;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: var(--text-muted);
        margin-bottom: 10px;
        padding-left: 20px;
      }

      .sidebar .nav-section-title::before {
        left: 8px;
      }

      /* Dashboard item prominent on mobile */
      .sidebar .nav-section:first-child .nav-item {
        background: linear-gradient(135deg, rgba(249, 203, 0, 0.1) 0%, rgba(249, 203, 0, 0.05) 100%);
        border: 1px solid rgba(249, 203, 0, 0.2);
        border-radius: 12px;
        margin: 0 8px 8px;
        padding: 16px 16px;
      }

      .sidebar .nav-section:first-child .nav-item.active {
        background: linear-gradient(135deg, rgba(249, 203, 0, 0.2) 0%, rgba(249, 203, 0, 0.1) 100%);
        border-color: var(--gold-primary);
      }

      /* Quick Links compact on mobile */
      .sidebar .nav-section-links {
        padding-top: 12px;
        margin-top: auto;
      }

      .sidebar .nav-section-links .nav-item {
        padding: 12px 20px;
        min-height: 44px;
        font-size: 13px;
        color: var(--text-muted);
      }

      /* Smooth scroll for nav */
      .sidebar .sidebar-nav {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
      }

      /* Active state visual feedback */
      .sidebar .nav-item:active {
        transform: scale(0.98);
        opacity: 0.9;
      }

      .main-content {
        margin-left: 0;
      }

      body.sidebar-collapsed .main-content {
        margin-left: 0;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: var(--unified-nav-height);
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .sidebar-overlay.active {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .content-area {
        padding: 20px;
      }

      .topbar {
        padding: 16px 20px;
      }

      .auth-card {
        padding: 32px 24px;
      }

      th, td {
        padding: 12px 16px;
      }

      /* Estimate Modal Mobile Optimization */
      #create-estimate-modal .modal-content {
        max-width: 100%;
        max-height: 100vh;
        max-height: 100dvh;
        border-radius: 0;
        margin: 0;
      }

      #create-estimate-modal .modal-content > div[style*="grid-template-columns: 1fr 1fr"] {
        display: flex !important;
        flex-direction: column !important;
      }

      #create-estimate-modal .form-section {
        border-right: none !important;
        border-bottom: 1px solid var(--border-subtle);
        padding: 16px !important;
      }

      #create-estimate-modal .form-section:last-child {
        border-bottom: none;
      }

      #create-estimate-modal .modal-header {
        padding: 16px !important;
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--dark-surface);
      }

      #create-estimate-modal .modal-header > div {
        gap: 12px !important;
      }

      #create-estimate-modal .modal-header > div > div:first-child {
        width: 40px !important;
        height: 40px !important;
      }

      #create-estimate-modal .modal-title {
        font-size: 18px !important;
      }

      #create-estimate-modal .modal-footer {
        position: sticky;
        bottom: 0;
        background: var(--dark-surface);
        padding: 16px !important;
        border-top: 1px solid var(--border-subtle);
        flex-direction: column;
        gap: 8px !important;
      }

      #create-estimate-modal .modal-footer .btn {
        width: 100%;
        justify-content: center;
        padding: 14px !important;
      }

      /* Line items table mobile */
      #estimate-line-items {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .estimate-line-item {
        flex-wrap: wrap !important;
        gap: 8px !important;
        padding: 12px !important;
      }

      .estimate-line-item > div {
        flex: 1 1 45% !important;
        min-width: 100px !important;
      }

      .estimate-line-item > div:first-child {
        flex: 1 1 100% !important;
      }

      /* Invoice modal mobile */
      #invoice-modal .invoice-item .form-row {
        flex-direction: column;
      }

      #invoice-modal .invoice-item .form-group {
        flex: 1 1 100% !important;
      }

      /* General modal mobile improvements */
      .modal-overlay .modal,
      .modal-overlay .modal-content {
        max-width: 100% !important;
        max-height: 100vh !important;
        max-height: 100dvh !important;
        border-radius: 16px 16px 0 0 !important;
        margin: 0 !important;
        margin-top: auto !important;
      }

      .modal-overlay {
        align-items: flex-end !important;
      }

      .modal-overlay .modal-header {
        position: sticky;
        top: 0;
        background: var(--dark-surface);
        z-index: 5;
        padding: 16px 20px !important;
      }

      .modal-overlay .modal-footer {
        position: sticky;
        bottom: 0;
        background: var(--dark-surface);
        z-index: 5;
        padding: 16px 20px !important;
        padding-bottom: calc(16px + env(safe-area-inset-bottom)) !important;
      }

      .modal-overlay .modal-body {
        padding: 16px 20px !important;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Touch-friendly inputs */
      .modal-overlay input,
      .modal-overlay select,
      .modal-overlay textarea {
        min-height: 48px;
        font-size: 16px !important;
      }

      .modal-overlay .btn {
        min-height: 48px;
        font-size: 15px;
      }

      /* Modal Modern styles for mobile */
      .modal-modern-overlay {
        align-items: flex-end !important;
      }

      .modal-modern {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 90vh !important;
        max-height: 90dvh !important;
        border-radius: 20px 20px 0 0 !important;
        margin: 0 !important;
      }

      .modal-modern-header {
        position: sticky;
        top: 0;
        background: var(--dark-surface);
        z-index: 5;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-subtle);
      }

      .modal-modern-body {
        padding: 16px 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modal-modern-footer {
        position: sticky;
        bottom: 0;
        background: var(--dark-surface);
        z-index: 5;
        padding: 16px 20px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        border-top: 1px solid var(--border-subtle);
      }

      .modal-modern-footer .btn,
      .modal-modern-footer .btn-modern {
        flex: 1;
        justify-content: center;
      }

      /* Drag handle for modals */
      .modal-drag-handle {
        width: 40px;
        height: 4px;
        background: var(--border-light);
        border-radius: 2px;
        margin: 8px auto 0;
      }

      /* Keep Add Lead modal centered/floating instead of bottom-anchored */
      #add-lead-modal.modal-overlay {
        align-items: center !important;
        padding: 20px !important;
      }

      #add-lead-modal .modal {
        max-width: 600px !important;
        max-height: 85vh !important;
        border-radius: 16px !important;
        margin: auto !important;
      }
    }

    /* ============================================
       ENHANCED MOBILE OPTIMIZATION
       ============================================ */

    /* Mobile-specific: 480px and below */
    @media (max-width: 480px) {
      /* Stats grid single column on small phones */
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 16px;
      }

      .stat-value {
        font-size: 24px;
      }

      /* Topbar mobile adjustments - clean single row */
      .topbar {
        padding: 12px 16px;
        gap: 12px;
      }

      .topbar-title {
        font-size: 18px;
        flex: 1;
      }

      .topbar-actions {
        flex-shrink: 0;
      }

      /* Compact button on mobile - icon only */
      .topbar-actions .btn-modern {
        padding: 12px;
        min-width: 44px;
        min-height: 44px;
      }

      .topbar-actions .btn-modern .btn-text {
        display: none;
      }

      .topbar-actions .btn-modern svg {
        width: 20px;
        height: 20px;
      }

      /* Content area tighter padding */
      .content-area {
        padding: 16px;
      }

      /* Card headers stack on mobile */
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .card-header .btn-modern,
      .card-header button {
        width: 100%;
        justify-content: center;
      }
    }

    /* Touch-friendly targets for all mobile */
    @media (max-width: 991px) {
      /* Minimum touch target sizes (44x44px per Apple/Google guidelines) */
      .btn,
      .btn-modern,
      .filter-btn,
      .filter-pill,
      .tab-btn,
      .nav-item {
        min-height: 44px;
        min-width: 44px;
      }

      /* Filter buttons larger on mobile */
      .filter-btn,
      .filter-pill {
        padding: 12px 18px;
        font-size: 14px;
      }

      .table-filters {
        gap: 8px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
        flex-wrap: nowrap;
      }

      .table-filters::-webkit-scrollbar {
        display: none;
      }

      /* Mobile hamburger menu button */
      .mobile-menu-btn {
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        background: var(--dark-elevated);
        border: 1px solid var(--border-subtle);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
      }

      .mobile-menu-btn:hover {
        background: var(--dark-surface);
        border-color: var(--gold-primary);
      }

      .mobile-menu-btn:active {
        background: var(--gold-primary);
        color: var(--dark-primary);
        transform: scale(0.95);
      }

      .mobile-menu-btn svg {
        width: 22px;
        height: 22px;
      }

      /* Table horizontal scroll */
      .table-container {
        overflow: visible;
      }

      .table-container table,
      table.data-table,
      .leads-table,
      .customers-table,
      .estimates-table,
      .invoices-table {
        display: block;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
      }

      /* Table cell minimum widths for readability */
      th, td {
        min-width: 100px;
        padding: 14px 16px;
      }

      th:first-child, td:first-child {
        min-width: 150px;
        position: sticky;
        left: 0;
        background: var(--dark-elevated);
        z-index: 1;
      }

      /* Lead/Customer cards as stacked cards on mobile */
      .lead-row,
      .customer-row,
      .estimate-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 16px;
        border-bottom: 1px solid var(--border-subtle);
      }

      .lead-row > *,
      .customer-row > *,
      .estimate-row > * {
        white-space: normal;
      }

      /* Mobile Form Inputs - Touch Optimized */
      input[type="text"],
      input[type="email"],
      input[type="tel"],
      input[type="number"],
      input[type="password"],
      input[type="date"],
      input[type="datetime-local"],
      select,
      textarea {
        min-height: 48px;
        font-size: 16px !important; /* Prevents iOS zoom on focus */
        padding: 12px 16px;
        border-radius: 10px;
      }

      textarea {
        min-height: 100px;
      }

      /* Form groups spacing */
      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        font-size: 14px;
        margin-bottom: 8px;
        display: block;
      }

      /* Form rows stack on mobile */
      .form-row {
        flex-direction: column;
        gap: 16px;
      }

      .form-row .form-group {
        width: 100%;
        margin-bottom: 0;
      }

      /* Checkbox and radio touch targets */
      input[type="checkbox"],
      input[type="radio"] {
        width: 24px;
        height: 24px;
        margin-right: 12px;
      }

      /* Select dropdown */
      select {
        background-position: right 16px center;
        padding-right: 44px;
      }

      /* Search inputs */
      .search-box {
        width: 100%;
      }

      .search-box input {
        width: 100%;
        font-size: 16px;
      }

      /* Calendar & Collaboration - Extra Small Mobile */
      #calendar-event-modal .modal-body,
      #invite-to-network-modal .modal-body {
        padding: 16px !important;
      }

      .collab-tabs {
        gap: 6px !important;
      }

      .collab-tab {
        padding: 10px 12px !important;
        font-size: 13px !important;
      }

      /* Event participants compact view */
      #event-participants-list {
        max-height: 150px !important;
      }

      .participant-item {
        flex-wrap: wrap !important;
      }

      .participant-item > * {
        flex: 1 1 45% !important;
        min-width: 120px !important;
      }

      /* Modal footer buttons stack */
      .modal-footer {
        flex-direction: column-reverse !important;
        gap: 10px !important;
      }

      .modal-footer button {
        width: 100% !important;
      }
    }

    /* Calendar Mobile Optimization */
    @media (max-width: 768px) {
      /* Calendar switches to agenda/list view on mobile */
      .calendar-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .calendar-header-row,
      .calendar-grid {
        min-width: 700px; /* Force horizontal scroll */
      }

      .calendar-day {
        min-height: 80px;
        padding: 6px;
      }

      .calendar-day-number {
        font-size: 12px;
      }

      .calendar-event {
        font-size: 10px;
        padding: 3px 6px;
      }

      /* Alternative: Mobile calendar agenda view */
      .calendar-mobile-view {
        display: block;
      }

      .calendar-desktop-view {
        display: none;
      }

      /* Calendar Event Modal - Mobile */
      #calendar-event-modal .modal-content {
        max-width: 100% !important;
        max-height: 100vh !important;
        max-height: 100dvh !important;
        border-radius: 0 !important;
        margin: 0 !important;
      }

      /* Form rows stack on mobile */
      .form-row-modern {
        flex-direction: column !important;
        gap: 12px !important;
      }

      .form-row-modern .form-group {
        width: 100% !important;
      }

      /* Collaboration tabs - horizontal scroll */
      .collab-tabs {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        flex-wrap: nowrap !important;
        padding-bottom: 8px;
        margin-bottom: 16px !important;
      }

      .collab-tabs::-webkit-scrollbar {
        display: none;
      }

      .collab-tab {
        white-space: nowrap;
        flex-shrink: 0;
        padding: 12px 16px !important;
        font-size: 14px !important;
      }

      /* Network/Invite modals - full screen on mobile */
      #invite-to-network-modal .modal-content,
      #calendar-event-detail-modal .modal-content {
        max-width: 100% !important;
        max-height: 100vh !important;
        max-height: 100dvh !important;
        border-radius: 0 !important;
        margin: 0 !important;
      }

      /* Participant list items - more touch friendly */
      .participant-item {
        padding: 12px !important;
        gap: 12px !important;
      }

      .participant-item input,
      .participant-item select {
        min-height: 44px !important;
        font-size: 16px !important;
      }

      /* Network cards - stack content */
      .network-card,
      .collaborator-card {
        padding: 16px !important;
      }

      .network-card .card-actions,
      .collaborator-card .card-actions {
        flex-direction: column !important;
        gap: 8px !important;
      }

      .network-card .card-actions button,
      .collaborator-card .card-actions button {
        width: 100% !important;
        justify-content: center !important;
      }
    }

    @media (min-width: 769px) {
      .calendar-mobile-view {
        display: none;
      }

      .calendar-desktop-view {
        display: block;
      }
    }

    /* Quick Actions mobile grid */
    @media (max-width: 600px) {
      .quick-actions {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }

      .quick-action-card {
        padding: 16px !important;
      }

      .quick-action-card svg {
        width: 28px !important;
        height: 28px !important;
      }

      .quick-action-card span {
        font-size: 12px !important;
      }
    }

    /* Estimate/Invoice Card Mobile Optimizations */
    @media (max-width: 768px) {
      .estimate-card,
      .invoice-card,
      .job-card {
        padding: 16px !important;
      }

      /* Stack card header on mobile */
      .estimate-card > div:first-child,
      .invoice-card > div:first-child,
      .job-card > div:first-child {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 12px !important;
      }

      /* Full width price/meta on mobile */
      .estimate-card > div:first-child > div:last-child,
      .invoice-card > div:first-child > div:last-child,
      .job-card > div:first-child > div:last-child {
        text-align: left !important;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 8px;
        border-top: 1px solid var(--border-subtle);
      }

      /* Action buttons wrap and fill width */
      .estimate-card > div:last-child,
      .invoice-card > div:last-child,
      .job-card > div:last-child {
        flex-wrap: wrap !important;
      }

      .estimate-card .btn-modern,
      .invoice-card .btn-modern,
      .job-card .btn-modern {
        flex: 1 1 auto !important;
        min-width: 80px;
        justify-content: center;
      }

      /* Button text wrap */
      .estimate-card .btn-modern.small,
      .invoice-card .btn-modern.small,
      .job-card .btn-modern.small {
        padding: 10px 14px !important;
        font-size: 13px !important;
      }

      /* Filter pills scroll horizontally */
      .filter-pills {
        display: flex;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        gap: 8px;
        padding-bottom: 8px;
        flex-wrap: nowrap;
      }

      .filter-pills::-webkit-scrollbar {
        display: none;
      }

      .filter-pill {
        flex-shrink: 0;
        white-space: nowrap;
      }

      /* Stat grid responsive */
      .stat-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }

      .stat-grid .stat-card {
        padding: 14px !important;
      }

      .stat-grid .stat-value {
        font-size: 20px !important;
      }

      .stat-grid .stat-label {
        font-size: 11px !important;
      }
    }

    /* Small phones - single column cards */
    @media (max-width: 480px) {
      .stat-grid {
        grid-template-columns: 1fr 1fr !important;
      }

      /* Estimate card buttons stack */
      .estimate-card > div:last-child {
        flex-direction: column !important;
      }

      .estimate-card .btn-modern {
        width: 100% !important;
      }

      /* Sync button full width */
      #sync-stripe-btn {
        width: 100%;
        justify-content: center;
      }

      /* Card header button groups stack on small screens */
      .card-header > div[style*="display: flex"],
      .card-header > div[style*="flex"] {
        width: 100%;
      }

      .card-header .btn-modern,
      .card-header button.btn-modern {
        flex: 1 1 100%;
        width: 100%;
        justify-content: center;
      }

      /* Invoice page specific */
      #page-invoices .card-header > div {
        width: 100%;
      }

      #page-invoices .card-header .btn-modern {
        flex: 1;
        min-width: 0;
      }

      /* Table filters scroll */
      .table-filters {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
        margin-bottom: 16px;
      }

      .table-filters .filter-btn {
        flex-shrink: 0;
        white-space: nowrap;
      }
    }

    /* Ensure good tap targets on all mobile */
    @media (max-width: 768px) {
      /* All clickable elements should have proper tap targets */
      .clickable,
      [onclick],
      button,
      a,
      .btn,
      .btn-modern,
      .filter-btn,
      .filter-pill,
      .nav-item {
        -webkit-tap-highlight-color: rgba(249, 203, 0, 0.2);
      }

      /* Prevent text selection on tap */
      button,
      .btn,
      .btn-modern,
      .filter-btn,
      .filter-pill {
        -webkit-user-select: none;
        user-select: none;
      }

      /* Add active state feedback */
      button:active,
      .btn:active,
      .btn-modern:active,
      .filter-btn:active,
      .filter-pill:active {
        opacity: 0.8;
        transform: scale(0.98);
      }

      /* Empty state mobile improvements */
      .empty-state {
        padding: 40px 20px;
        text-align: center;
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state h3 {
        font-size: 18px;
        margin-bottom: 8px;
      }

      .empty-state p {
        font-size: 14px;
        line-height: 1.5;
      }

      .empty-state .btn-modern {
        margin-top: 16px;
      }
    }

    /* Lead detail panel mobile */
    @media (max-width: 768px) {
      .lead-detail-panel,
      .estimate-detail-panel,
      .customer-detail-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100% !important;
        max-width: 100% !important;
        border-radius: 0 !important;
        z-index: 200;
      }

      .panel-header {
        position: sticky;
        top: 0;
        z-index: 5;
        background: var(--dark-surface);
      }

      .panel-content {
        padding-bottom: 100px;
      }

      .panel-actions {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        background: var(--dark-surface);
        border-top: 1px solid var(--border-subtle);
        display: flex;
        gap: 12px;
      }

      .panel-actions .btn {
        flex: 1;
        justify-content: center;
      }
    }

    /* Search box mobile */
    @media (max-width: 600px) {
      .search-box {
        width: 100%;
      }

      .search-box input {
        width: 100%;
      }

      .table-header {
        padding: 16px;
      }
    }

    /* ============================================
       COMPREHENSIVE MOBILE SCREEN OPTIMIZATIONS
       ============================================ */

    /* === DASHBOARD PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-dashboard .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      #page-dashboard .stat-card {
        padding: 16px;
      }

      #page-dashboard .stat-card.clickable {
        min-height: 100px;
      }

      #page-dashboard .stat-icon {
        width: 40px;
        height: 40px;
        margin-bottom: 8px;
      }

      #page-dashboard .stat-icon svg {
        width: 20px;
        height: 20px;
      }

      #page-dashboard .stat-value {
        font-size: 22px;
      }

      #page-dashboard .stat-label {
        font-size: 12px;
      }

      /* Quick actions grid */
      #page-dashboard .quick-actions {
        grid-template-columns: 1fr !important;
        gap: 12px;
      }

      #page-dashboard .action-card {
        padding: 16px;
        flex-direction: row;
        align-items: center;
        gap: 16px;
      }

      #page-dashboard .action-card .action-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
      }

      #page-dashboard .action-card .action-text h4 {
        font-size: 15px;
        margin-bottom: 4px;
      }

      #page-dashboard .action-card .action-text p {
        font-size: 13px;
      }
    }

    @media (max-width: 480px) {
      #page-dashboard .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      #page-dashboard .stat-card {
        padding: 14px;
      }

      #page-dashboard .stat-value {
        font-size: 20px;
      }
    }

    /* === PROFILE PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-profile .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-profile .card-header .btn-modern {
        width: 100%;
        justify-content: center;
      }

      #page-profile .form-row {
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      #page-profile .form-group {
        margin-bottom: 16px;
      }

      #page-profile input,
      #page-profile select,
      #page-profile textarea {
        width: 100%;
      }
    }

    /* === FAVORITES & DESIGNS PAGES MOBILE === */
    @media (max-width: 768px) {
      #page-favorites .favorites-grid,
      #page-my-designs .designs-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px;
      }

      .favorite-card,
      .design-card {
        border-radius: 10px;
      }

      .favorite-card img,
      .design-card img {
        height: 120px;
      }

      .favorite-card-body,
      .design-card-body {
        padding: 12px;
      }

      .favorite-card-title,
      .design-card-title {
        font-size: 14px;
        line-height: 1.3;
      }

      .favorite-card-actions,
      .design-card-actions {
        padding: 8px 12px;
      }
    }

    @media (max-width: 480px) {
      #page-favorites .favorites-grid,
      #page-my-designs .designs-grid {
        grid-template-columns: 1fr !important;
      }

      .favorite-card img,
      .design-card img {
        height: 160px;
      }
    }

    /* === LISTINGS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-listings .listings-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px;
      }

      .listing-card {
        border-radius: 10px;
      }

      .listing-image {
        height: 140px;
      }

      .listing-details {
        padding: 12px;
      }

      .listing-price {
        font-size: 16px;
      }

      .listing-actions {
        flex-direction: column;
        gap: 8px;
      }

      .listing-actions .btn-modern {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      #page-listings .listings-grid {
        grid-template-columns: 1fr !important;
      }
    }

    /* === TOOLS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-tools .tools-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px;
      }

      .tool-card {
        padding: 16px;
        text-align: center;
      }

      .tool-card-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 12px;
      }

      .tool-card-title {
        font-size: 14px;
      }

      .tool-card-desc {
        font-size: 12px;
        display: none;
      }
    }

    @media (max-width: 480px) {
      #page-tools .tools-grid {
        grid-template-columns: 1fr 1fr !important;
      }
    }

    /* === LEADS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-leads .table-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-leads .table-header > div {
        width: 100%;
      }

      #page-leads .search-bar-modern {
        max-width: 100% !important;
        margin: 0 !important;
      }

      #page-leads .filter-pills {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
      }

      #page-leads .filter-pill {
        flex-shrink: 0;
      }

      /* Lead cards instead of table rows */
      #leads-table .lead-row {
        display: flex;
        flex-direction: column;
        background: var(--dark-elevated);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid var(--border-subtle);
      }

      #leads-table .lead-row > * {
        padding: 4px 0;
      }
    }

    /* === CUSTOMERS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-customers .table-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-customers .table-header > div {
        width: 100%;
        flex-direction: column !important;
        align-items: stretch !important;
      }

      #page-customers .search-bar-modern {
        max-width: 100% !important;
      }

      #page-customers .btn-modern {
        width: 100%;
        justify-content: center;
      }

      /* Customers list as cards */
      #customers-list .customer-card {
        display: flex;
        flex-direction: column;
        padding: 16px;
        background: var(--dark-elevated);
        border-radius: 12px;
        margin-bottom: 12px;
        border: 1px solid var(--border-subtle);
      }
    }

    /* === ESTIMATES PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-estimates .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-estimates .card-header > div {
        width: 100%;
      }

      #page-estimates .btn-modern {
        width: 100%;
        justify-content: center;
      }

      /* Stat row for estimates */
      #page-estimates .estimates-stats {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px;
      }

      #page-estimates .stat-mini {
        padding: 12px;
        text-align: center;
      }

      /* Estimate cards mobile */
      .estimate-card {
        padding: 14px !important;
      }

      .estimate-card > div:first-child {
        flex-direction: column !important;
        gap: 10px !important;
      }

      .estimate-card .status-badge {
        align-self: flex-start;
      }

      .estimate-card > div:last-child {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
      }

      .estimate-card .btn-modern.small {
        padding: 10px 12px !important;
        font-size: 12px !important;
        flex: 1;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .estimate-card > div:last-child {
        flex-direction: column !important;
      }

      .estimate-card .btn-modern.small {
        width: 100% !important;
      }
    }

    /* === INVOICES PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-invoices .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-invoices .card-header > div {
        width: 100%;
        flex-direction: column !important;
      }

      #page-invoices .btn-modern {
        width: 100%;
        justify-content: center;
      }

      #page-invoices .table-filters {
        overflow-x: auto;
        flex-wrap: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      #page-invoices .filter-btn {
        flex-shrink: 0;
        white-space: nowrap;
      }
    }

    /* === JOBS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-jobs .stat-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px;
      }

      #page-jobs .stat-card {
        padding: 14px !important;
      }

      #page-jobs .stat-value {
        font-size: 18px !important;
      }

      #page-jobs .stat-label {
        font-size: 11px !important;
      }

      #page-jobs .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-jobs .card-header > div {
        width: 100%;
        flex-direction: column !important;
        gap: 10px !important;
      }

      /* View toggle full width */
      #page-jobs .view-toggle {
        width: 100%;
        justify-content: center;
      }

      #page-jobs .view-toggle .view-btn {
        flex: 1;
        justify-content: center;
      }

      #page-jobs .btn-modern {
        width: 100%;
        justify-content: center;
      }

      /* Kanban board horizontal scroll */
      #page-jobs .kanban-board {
        padding: 0 0 16px 0 !important;
        margin: 0 -16px;
        padding-left: 16px !important;
      }

      #page-jobs .kanban-column {
        min-width: 280px !important;
        padding: 12px !important;
      }

      #page-jobs .kanban-column:last-child {
        margin-right: 16px;
      }

      /* Job cards */
      .job-card {
        padding: 14px !important;
      }
    }

    /* === PROJECTS PAGE STYLES === */
    #page-projects .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    #page-projects .stat-card {
      background: var(--dark-card);
      border: 1px solid var(--dark-border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    #page-projects .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold-primary);
    }
    #page-projects .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* === PROJECTS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-projects .stat-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px;
      }
      #page-projects .stat-card {
        padding: 14px !important;
      }
      #page-projects .stat-value {
        font-size: 18px !important;
      }
      #page-projects .stat-label {
        font-size: 11px !important;
      }
      #page-projects .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      #page-projects .card-header > div {
        width: 100%;
        flex-direction: column !important;
        gap: 10px !important;
      }
      #page-projects .view-toggle {
        width: 100%;
        justify-content: center;
      }
      #page-projects .view-toggle .view-btn {
        flex: 1;
        justify-content: center;
      }
      #page-projects .btn-modern {
        width: 100%;
        justify-content: center;
      }
      #page-projects .kanban-board {
        padding: 0 0 16px 0 !important;
        margin: 0 -16px;
        padding-left: 16px !important;
      }
      #page-projects .kanban-column {
        min-width: 280px !important;
        padding: 12px !important;
      }
      #page-projects .kanban-column:last-child {
        margin-right: 16px;
      }
    }

    /* === DESIGN HANDOFF STYLES === */
    .handoff-stage-tracker {
      display: flex;
      gap: 2px;
      margin: 16px 0;
      overflow-x: auto;
      padding: 4px 0;
      -webkit-overflow-scrolling: touch;
    }
    .handoff-stage {
      flex: 1;
      min-width: 58px;
      text-align: center;
      padding: 6px 3px;
      border-radius: 6px;
      font-size: 9px;
      line-height: 1.3;
      white-space: nowrap;
      transition: all 0.2s;
    }
    .handoff-stage.completed { background: rgba(34,197,94,0.15); color: #22c55e; }
    .handoff-stage.current { background: rgba(212,175,55,0.2); color: var(--gold-primary); font-weight: 700; border: 1px solid var(--gold-primary); }
    .handoff-stage.future { background: var(--dark-elevated); color: var(--text-muted); }
    .handoff-participant {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--dark-elevated);
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .handoff-participant-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gold-primary);
      color: #000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 13px;
    }
    @media (max-width: 768px) {
      .handoff-stage-tracker { padding-bottom: 8px; }
      .handoff-stage { min-width: 50px; font-size: 8px; }
    }

    /* === CONTRACTORS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-collaborators .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-collaborators .btn-modern {
        width: 100%;
        justify-content: center;
      }

      /* Contractor cards */
      .contractor-card {
        padding: 16px;
        flex-direction: column;
        gap: 12px;
      }

      .contractor-card .contractor-avatar {
        align-self: center;
      }

      .contractor-card .contractor-info {
        text-align: center;
      }

      .contractor-card .contractor-actions {
        width: 100%;
        justify-content: center;
      }
    }

    /* === CALENDAR PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-calendar .card-header {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      #page-calendar .card-header > div {
        width: 100%;
        justify-content: center;
      }

      /* Calendar navigation */
      #page-calendar #calendar-month-year {
        min-width: 120px !important;
        font-size: 15px;
      }

      /* Calendar grid scrollable */
      #page-calendar .calendar-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
      }

      #page-calendar .calendar-header-row,
      #page-calendar .calendar-grid {
        min-width: 560px;
      }

      #page-calendar .calendar-header-cell {
        padding: 8px 4px;
        font-size: 11px;
      }

      #page-calendar .calendar-day {
        min-height: 70px;
        padding: 4px;
      }

      #page-calendar .calendar-day-number {
        font-size: 12px;
      }

      #page-calendar .calendar-event {
        font-size: 9px;
        padding: 2px 4px;
        margin-bottom: 2px;
      }

      /* Legend inline */
      #page-calendar .card-body > div {
        flex-direction: row !important;
        flex-wrap: wrap;
        gap: 12px !important;
      }

      .calendar-event-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }
    }

    @media (max-width: 480px) {
      /* On very small phones, make upcoming events more prominent */
      #page-calendar > .card:first-child {
        margin-bottom: 16px;
      }

      /* Smaller calendar grid for very small phones */
      #page-calendar .calendar-header-row,
      #page-calendar .calendar-grid {
        min-width: 480px;
      }

      #page-calendar .calendar-day {
        min-height: 60px;
        padding: 2px;
      }

      #page-calendar .calendar-event {
        font-size: 8px;
        padding: 1px 3px;
      }

      /* Make upcoming events more visible as primary view */
      #page-calendar > .card:last-child {
        order: -1;
        margin-top: 0;
        margin-bottom: 16px;
        border: 2px solid var(--gold-primary);
      }
    }

    /* === WALLET PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-wallet .wallet-balance-grid {
        grid-template-columns: 1fr !important;
        gap: 12px;
      }

      #page-wallet .balance-card {
        padding: 20px;
        text-align: center;
      }

      #page-wallet .balance-amount {
        font-size: 28px;
      }

      /* Transaction list */
      #page-wallet .transaction-list {
        padding: 0;
      }

      #page-wallet .transaction-item {
        padding: 14px;
        flex-wrap: wrap;
        gap: 8px;
      }

      #page-wallet .transaction-item > div:last-child {
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding-top: 8px;
        border-top: 1px solid var(--border-subtle);
      }

      /* Payout card */
      #page-wallet .payout-card {
        flex-direction: column;
        text-align: center;
        gap: 12px;
      }
    }

    /* === ADMIN USERS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-admin-users .admin-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .admin-user-card {
        display: flex;
        flex-direction: column;
        padding: 16px;
        background: var(--dark-elevated);
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        gap: 12px;
      }

      .admin-user-card .user-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .admin-user-card .btn-modern {
        flex: 1;
        justify-content: center;
      }
    }

    /* === PRODUCTS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-products .products-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px;
      }

      .product-card {
        border-radius: 10px;
      }

      .product-card-image {
        height: 120px;
      }

      .product-card-body {
        padding: 12px;
      }

      .product-card-title {
        font-size: 14px;
      }

      .product-card-price {
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      #page-products .products-grid {
        grid-template-columns: 1fr !important;
      }

      .product-card-image {
        height: 160px;
      }
    }

    /* === ORDERS PAGE === */
    .orders-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .order-card {
      background: var(--dark-elevated);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      transition: border-color 0.2s ease;
    }

    .order-card:hover {
      border-color: var(--border-light);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
      gap: 16px;
      flex-wrap: wrap;
    }

    .order-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .order-number {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .order-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .order-status {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: capitalize;
    }

    .status-badge.paid {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .status-badge.pending {
      background: rgba(255, 184, 77, 0.15);
      color: var(--warning);
    }

    .status-badge.refunded {
      background: rgba(255, 107, 107, 0.15);
      color: var(--error);
    }

    .status-badge.fulfilled {
      background: rgba(77, 166, 255, 0.15);
      color: var(--info);
    }

    .status-badge.unfulfilled {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-secondary);
    }

    .order-items {
      padding: 16px 20px;
    }

    .order-item {
      display: flex;
      gap: 12px;
      padding: 8px 0;
      align-items: flex-start;
    }

    .order-item + .order-item {
      border-top: 1px solid var(--border-subtle);
    }

    .order-item-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      background: var(--dark-surface);
      overflow: hidden;
      flex-shrink: 0;
    }

    .order-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .order-item-details {
      flex: 1;
      min-width: 0;
    }

    .order-item-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .order-item-meta {
      font-size: 13px;
      color: var(--text-muted);
    }

    .order-item-price {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
    }

    .order-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-top: 1px solid var(--border-subtle);
      background: var(--dark-surface);
    }

    .order-total {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-primary);
    }

    .order-total-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .stat-card-mini {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-card-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-card-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* === PRODUCTS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-products .page-header {
        flex-direction: column;
        align-items: stretch;
      }

      #page-products .page-header > div:last-child {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      #page-products .page-header .btn-modern {
        padding: 10px 12px;
        font-size: 13px;
        justify-content: center;
      }

      #page-products .stats-row {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 8px !important;
      }

      #page-products .stat-card-mini {
        padding: 12px;
      }

      #page-products .stat-card-value {
        font-size: 20px;
      }

      #page-products .stat-card-label {
        font-size: 10px;
      }

      /* Mobile filters */
      #page-products .table-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      #page-products .filter-btn {
        padding: 8px 12px;
        font-size: 12px;
        flex: 1;
        min-width: calc(50% - 6px);
        text-align: center;
        justify-content: center;
      }

      /* Hide table on mobile, show cards */
      #page-products #products-table-container table {
        display: none;
      }

      #page-products #products-table-container {
        background: transparent;
        border: none;
      }

      #page-products #products-table-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* Bulk actions mobile */
      #page-products #products-bulk-actions {
        flex-wrap: wrap;
        padding: 12px;
        gap: 8px;
      }

      #page-products #products-bulk-actions .btn-modern {
        flex: 1;
        min-width: calc(50% - 8px);
        justify-content: center;
      }

      /* Pagination mobile */
      #page-products #products-pagination {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }

      #page-products #products-pagination > div:last-child {
        display: flex;
        width: 100%;
      }

      #page-products #products-pagination .btn-modern {
        flex: 1;
      }
    }

    /* Product card mobile view */
    .product-card-mobile {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      display: none;
    }

    @media (max-width: 768px) {
      .product-card-mobile {
        display: block;
      }
    }

    .product-card-mobile-header {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .product-card-mobile-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: var(--dark-surface);
      flex-shrink: 0;
    }

    .product-card-mobile-info {
      flex: 1;
      min-width: 0;
    }

    .product-card-mobile-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .product-card-mobile-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .product-card-mobile-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-top: 1px solid var(--border-subtle);
    }

    .product-card-mobile-row:first-of-type {
      margin-top: 8px;
    }

    .product-card-mobile-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .product-card-mobile-value {
      font-size: 14px;
      font-weight: 500;
    }

    .product-card-mobile-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .product-card-mobile-actions button {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: var(--dark-surface);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .product-card-mobile-actions button.danger {
      color: var(--error);
      border-color: rgba(239, 68, 68, 0.3);
    }

    /* Import modal mobile */
    @media (max-width: 768px) {
      #import-modal .modal {
        max-width: 100%;
        margin: 10px;
        max-height: calc(100vh - 20px);
      }

      #import-modal .modal-body {
        padding: 16px;
      }

      #import-dropzone {
        padding: 24px 16px;
      }

      #import-dropzone h3 {
        font-size: 16px;
      }

      #import-mapping-grid {
        grid-template-columns: 1fr !important;
      }

      #import-preview-table {
        font-size: 11px;
      }

      #import-preview-table th,
      #import-preview-table td {
        padding: 6px 8px;
      }

      /* Product modal mobile */
      #product-modal .modal {
        max-width: 100%;
        margin: 10px;
        max-height: calc(100vh - 20px);
      }

      #product-modal .modal-body {
        padding: 16px;
        max-height: calc(100vh - 180px);
        overflow-y: auto;
      }

      #product-modal .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0;
      }

      #product-modal .form-group {
        margin-bottom: 16px;
      }

      #product-modal .form-group label {
        font-size: 13px;
      }

      #product-modal .form-group input,
      #product-modal .form-group select,
      #product-modal .form-group textarea {
        font-size: 16px; /* Prevents zoom on iOS */
        padding: 12px;
      }

      #product-modal .modal-footer {
        padding: 12px 16px;
        flex-direction: column;
        gap: 8px;
      }

      #product-modal .modal-footer .btn-modern {
        width: 100%;
        justify-content: center;
      }
    }

    /* === ORDERS PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-orders .orders-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .order-card {
        display: flex;
        flex-direction: column;
        padding: 16px;
        background: var(--dark-elevated);
        border-radius: 12px;
        border: 1px solid var(--border-subtle);
        gap: 12px;
      }

      .order-card .order-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .order-card .order-items {
        border-top: 1px solid var(--border-subtle);
        padding-top: 12px;
      }

      .order-card .order-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding-top: 12px;
        border-top: 1px solid var(--border-subtle);
      }

      .order-card .btn-modern {
        flex: 1;
        justify-content: center;
      }
    }

    /* === MESSAGES PAGE STYLES === */
    .messages-container {
      display: flex;
      height: calc(100vh - 200px);
      min-height: 500px;
      background: var(--surface-elevated);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
    }

    .conversations-list {
      width: 320px;
      min-width: 280px;
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      background: var(--surface);
    }

    .conversations-header {
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .search-input-modern {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      background: var(--surface-elevated);
      color: var(--text);
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .search-input-modern:focus {
      outline: none;
      border-color: var(--gold);
      box-shadow: 0 0 0 3px rgba(249, 203, 0, 0.1);
    }

    .search-input-modern::placeholder {
      color: var(--text-muted);
    }

    .conversations-items {
      flex: 1;
      overflow-y: auto;
    }

    .conversation-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s;
    }

    .conversation-item:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .conversation-item.active {
      background: rgba(249, 203, 0, 0.08);
      border-left: 3px solid var(--gold);
    }

    .conversation-item .avatar-modern {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
    }

    .conversation-details {
      flex: 1;
      min-width: 0;
    }

    .conversation-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-preview {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conversation-meta {
      text-align: right;
      flex-shrink: 0;
    }

    .conversation-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .conversation-unread {
      background: var(--gold);
      color: var(--dark);
      font-size: 11px;
      font-weight: 700;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: auto;
    }

    .message-thread {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .thread-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--surface);
    }

    .thread-contact {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .thread-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .thread-status {
      font-size: 12px;
      color: var(--text-muted);
    }

    .thread-actions {
      display: flex;
      gap: 8px;
    }

    .thread-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .empty-thread {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }

    .empty-thread svg {
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-thread h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text);
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 14px;
      line-height: 1.5;
      position: relative;
    }

    .message-bubble.outbound {
      background: var(--gold);
      color: var(--dark);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.inbound {
      background: var(--surface-elevated);
      border: 1px solid var(--border-subtle);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      display: block;
    }

    .message-bubble.outbound .message-time {
      color: rgba(0, 0, 0, 0.5);
      text-align: right;
    }

    .message-channel-badge {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.1);
      margin-left: 8px;
    }

    .message-bubble.outbound .message-channel-badge {
      background: rgba(0, 0, 0, 0.1);
    }

    .message-input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--border-subtle);
      background: var(--surface);
    }

    .message-input-wrapper {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      background: var(--surface-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 8px 12px;
    }

    .message-input {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 14px;
      resize: none;
      min-height: 24px;
      max-height: 120px;
      font-family: inherit;
      padding: 4px 0;
    }

    .message-input:focus {
      outline: none;
    }

    .message-input::placeholder {
      color: var(--text-muted);
    }

    .attachment-btn {
      color: var(--text-muted);
    }

    .send-btn {
      padding: 8px 16px !important;
      border-radius: 8px !important;
    }

    .message-channel-selector {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-left: 4px;
    }

    .channel-option {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .channel-option input[type="radio"] {
      accent-color: var(--gold);
    }

    .channel-option:has(input:checked) {
      color: var(--gold);
    }

    .date-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      color: var(--text-muted);
      font-size: 12px;
      margin: 16px 0;
    }

    .date-divider::before,
    .date-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-subtle);
    }

    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 40px;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Filter Chips */
    .filter-chips {
      display: flex;
      gap: 6px;
      margin-top: 10px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 2px;
    }

    .filter-chip {
      padding: 6px 12px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .filter-chip.active {
      background: var(--gold);
      color: var(--dark);
      border-color: var(--gold);
    }

    .filter-chip:hover:not(.active) {
      border-color: var(--gold);
      color: var(--text);
    }

    /* Notification Avatar */
    .notif-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notif-avatar.gold { background: rgba(249, 203, 0, 0.15); color: var(--gold); }
    .notif-avatar.green { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .notif-avatar.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .notif-avatar.purple { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .notif-avatar.pink { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    .notif-avatar.gray { background: rgba(255, 255, 255, 0.1); color: var(--text-muted); }

    .notif-unread-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      background: var(--gold);
      border-radius: 50%;
      margin-right: 6px;
    }

    .conversation-item.unread .conversation-name {
      font-weight: 700;
    }

    .conversation-item.unread .conversation-preview {
      color: var(--text);
    }

    /* Notification Detail Card */
    .notif-detail-card {
      background: var(--surface-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      margin: 20px;
      overflow: hidden;
    }

    .notif-detail-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notif-detail-header h3 {
      font-size: 16px;
      margin: 0;
    }

    .notif-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .notif-detail-body {
      padding: 20px;
    }

    .notif-detail-body p {
      margin: 0;
      line-height: 1.6;
      white-space: pre-wrap;
    }

    .notif-detail-body .detail-row {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .notif-detail-body .detail-row:last-child {
      border-bottom: none;
    }

    .notif-detail-contact {
      padding: 16px 20px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .contact-link {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--gold);
      text-decoration: none;
      font-size: 14px;
    }

    .contact-link:hover {
      text-decoration: underline;
    }

    .notif-detail-actions {
      padding: 16px 20px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
    }

    .notif-detail-actions .btn-modern {
      flex: 1;
      justify-content: center;
    }

    /* === COMPOSE MESSAGE MODAL === */
    .compose-modal {
      max-width: 500px;
      width: 100%;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
    }

    .compose-section {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .compose-section:last-of-type {
      border-bottom: none;
    }

    .compose-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .compose-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: var(--surface-elevated);
      color: var(--text);
      font-size: 15px;
    }

    .compose-input:focus {
      outline: none;
      border-color: var(--gold);
    }

    .compose-textarea {
      width: 100%;
      padding: 14px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: var(--surface-elevated);
      color: var(--text);
      font-size: 15px;
      resize: none;
      min-height: 120px;
      font-family: inherit;
    }

    .compose-textarea:focus {
      outline: none;
      border-color: var(--gold);
    }

    /* Chip/Tag component */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .chip.primary {
      background: rgba(249, 203, 0, 0.15);
      color: var(--gold-primary);
    }

    .chip.success {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .chip.warning {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .chip.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .chip.info {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    .chip .chip-close {
      background: none;
      border: none;
      color: inherit;
      opacity: 0.7;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    .chip .chip-close:hover {
      opacity: 1;
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .compose-recipient-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--gold);
      color: var(--dark);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      width: fit-content;
    }

    .chip-remove {
      background: none;
      border: none;
      color: var(--dark);
      font-size: 18px;
      cursor: pointer;
      line-height: 1;
      opacity: 0.7;
    }

    .chip-remove:hover {
      opacity: 1;
    }

    .compose-suggestions {
      background: var(--surface-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      margin-top: 8px;
      max-height: 240px;
      overflow-y: auto;
      display: none;
    }

    .suggestion-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s;
    }

    .suggestion-item:last-child {
      border-bottom: none;
    }

    .suggestion-item:hover, .suggestion-item:active {
      background: rgba(255, 255, 255, 0.05);
    }

    .suggestion-item.manual {
      background: rgba(249, 203, 0, 0.05);
    }

    .suggestion-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--gold);
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .suggestion-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--surface);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
    }

    .suggestion-details {
      flex: 1;
      min-width: 0;
    }

    .suggestion-name {
      font-weight: 500;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .suggestion-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .suggestion-badge {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      text-transform: uppercase;
    }

    .suggestion-empty {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    .compose-channels {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .channel-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 20px;
      border: 1px solid var(--border-subtle);
      background: var(--surface-elevated);
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .channel-chip input {
      display: none;
    }

    .channel-chip.selected {
      background: var(--gold);
      color: var(--dark);
      border-color: var(--gold);
    }

    .channel-chip:hover:not(.selected) {
      border-color: var(--gold);
      color: var(--text);
    }

    .quick-templates {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .template-chip {
      padding: 8px 14px;
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-chip:hover {
      border-color: var(--gold);
      color: var(--gold);
    }

    .compose-footer {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid var(--border-subtle);
      background: var(--surface);
    }

    .compose-footer .btn-modern {
      flex: 1;
      justify-content: center;
    }

    /* === MESSAGES PAGE MOBILE === */
    @media (max-width: 768px) {
      #page-messages .messages-container {
        flex-direction: column;
        height: calc(100vh - 160px);
      }

      #page-messages .conversations-list {
        width: 100%;
        max-height: none;
        border-right: none;
        border-bottom: 1px solid var(--border-subtle);
        transition: max-height 0.3s ease;
      }

      #page-messages .conversations-list.collapsed {
        max-height: 70px;
        overflow: hidden;
      }

      #page-messages .conversations-list.collapsed .conversations-items {
        display: none;
      }

      #page-messages .message-thread {
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
      }

      #page-messages .thread-messages {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding: 16px;
        padding-bottom: 8px;
      }

      #page-messages .message-input-area {
        position: sticky;
        bottom: 0;
        padding: 12px 16px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        background: var(--surface);
        border-top: 1px solid var(--border-subtle);
      }

      .message-bubble {
        max-width: 85%;
      }

      /* Better touch targets on mobile */
      .conversation-item {
        padding: 16px;
        min-height: 72px;
      }

      .conversation-item .avatar-modern {
        width: 48px;
        height: 48px;
      }

      .thread-actions button {
        min-width: 44px;
        min-height: 44px;
      }

      /* Mobile conversation toggle */
      .conversations-toggle {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--surface-elevated);
        cursor: pointer;
        border-bottom: 1px solid var(--border-subtle);
      }

      .conversations-toggle h4 {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .conversations-toggle .toggle-icon {
        transition: transform 0.2s;
      }

      .conversations-toggle.collapsed .toggle-icon {
        transform: rotate(180deg);
      }
    }

    /* Message Bubble Actions */
    .message-bubble-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      max-width: 70%;
    }

    .message-bubble-wrapper.outbound {
      margin-left: auto;
      align-items: flex-end;
    }

    .message-bubble-wrapper.inbound {
      margin-right: auto;
      align-items: flex-start;
    }

    .message-bubble-wrapper:hover .message-actions {
      opacity: 1;
      visibility: visible;
    }

    .message-actions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }

    .message-bubble-wrapper.outbound .message-actions {
      justify-content: flex-end;
    }

    .message-action-btn {
      background: rgba(255, 255, 255, 0.05);
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .message-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
    }

    .message-action-btn.delete:hover {
      background: rgba(244, 67, 54, 0.15);
      color: var(--error);
    }

    .message-action-btn svg {
      width: 12px;
      height: 12px;
    }

    /* Mobile: always show actions */
    @media (max-width: 768px) {
      .message-actions {
        opacity: 1;
        visibility: visible;
      }

      .message-action-btn {
        padding: 6px 10px;
        font-size: 12px;
        min-height: 32px;
      }
    }

    /* Message status indicator */
    .message-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-left: 6px;
    }

    .message-status svg {
      width: 12px;
      height: 12px;
    }

    .message-status.sent { color: var(--text-muted); }
    .message-status.delivered { color: var(--info); }
    .message-status.read { color: var(--success); }

    /* Notification detail card improvements */
    .notif-detail-card {
      background: var(--surface-elevated);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      margin: 20px;
    }

    .notif-detail-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notif-detail-header h3 {
      font-size: 18px;
      font-weight: 600;
    }

    .notif-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    .notif-detail-body {
      padding: 20px;
    }

    .notif-detail-body p {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .detail-row {
      padding: 8px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 14px;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-row strong {
      color: var(--text-muted);
      min-width: 80px;
      display: inline-block;
    }

    .notif-detail-contact {
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .contact-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--gold);
      text-decoration: none;
      font-size: 13px;
      padding: 8px 12px;
      background: rgba(249, 203, 0, 0.1);
      border-radius: 8px;
      transition: all 0.2s;
    }

    .contact-link:hover {
      background: rgba(249, 203, 0, 0.2);
    }

    .notif-detail-actions {
      padding: 16px 20px;
      display: flex;
      gap: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .notif-detail-actions .btn-modern {
      flex: 1;
      justify-content: center;
    }

    /* Unread dot indicator */
    .notif-unread-dot {
      width: 8px;
      height: 8px;
      background: var(--gold);
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      animation: pulse-dot 2s infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .conversation-item.unread .conversation-name {
      font-weight: 700;
    }

    .conversation-item.unread .conversation-preview {
      color: var(--text-secondary);
    }

    /* Notif avatar colors */
    .notif-avatar {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
    }

    .notif-avatar.gold { background: rgba(249, 203, 0, 0.15); color: var(--gold); }
    .notif-avatar.green { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
    .notif-avatar.blue { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
    .notif-avatar.purple { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }
    .notif-avatar.pink { background: rgba(233, 30, 99, 0.15); color: #e91e63; }
    .notif-avatar.gray { background: rgba(158, 158, 158, 0.15); color: #9e9e9e; }

    /* Message content styling */
    .message-content {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.5;
    }

    .message-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .message-bubble.outbound .message-meta {
      justify-content: flex-end;
    }

    /* Show mobile toggle only on small screens */
    @media (max-width: 768px) {
      .conversations-toggle {
        display: flex !important;
      }

      .conversations-list.collapsed .conversations-header,
      .conversations-list.collapsed .conversations-items {
        display: none;
      }
    }

    @media (min-width: 769px) {
      .conversations-toggle {
        display: none !important;
      }
    }

      /* Compose Modal - Bottom Sheet on Mobile */
      #compose-message-modal {
        align-items: flex-end;
        padding: 0;
      }

      .compose-modal {
        max-width: 100%;
        max-height: 95vh;
        border-radius: 20px 20px 0 0;
        margin: 0;
      }

      .compose-modal .modal-header {
        position: sticky;
        top: 0;
        background: var(--surface-elevated);
        z-index: 5;
        border-radius: 20px 20px 0 0;
      }

      .compose-modal .modal-header::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 36px;
        height: 4px;
        background: var(--border-subtle);
        border-radius: 2px;
      }

      .compose-section {
        padding: 14px 16px;
      }

      .compose-input,
      .compose-textarea {
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 14px;
      }

      .compose-channels {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
      }

      .channel-chip {
        justify-content: center;
        padding: 12px 8px;
        font-size: 12px;
      }

      .quick-templates {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding-bottom: 4px;
        -webkit-overflow-scrolling: touch;
      }

      .template-chip {
        flex-shrink: 0;
        white-space: nowrap;
      }

      .compose-footer {
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }

      .compose-suggestions {
        max-height: 200px;
      }
    }

    /* === GLOBAL SEARCH BAR MOBILE STYLES === */
    @media (max-width: 768px) {
      .search-bar-modern {
        max-width: 100% !important;
        width: 100% !important;
        margin: 0 !important;
      }

      .search-bar-modern input {
        width: 100%;
        min-height: 44px;
        font-size: 16px !important;
      }

      /* Input groups full width */
      .input-group,
      .form-group {
        width: 100%;
      }

      /* Button groups stack on mobile */
      .btn-group,
      .button-group {
        flex-direction: column;
        width: 100%;
      }

      .btn-group .btn,
      .btn-group .btn-modern,
      .button-group .btn,
      .button-group .btn-modern {
        width: 100%;
        justify-content: center;
      }

      /* Table header layouts */
      .table-header {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 12px !important;
      }

      .table-header > div {
        width: 100%;
      }

      .table-header .btn-modern {
        width: 100%;
        justify-content: center;
      }

      .table-title {
        margin-bottom: 8px;
      }
    }

    /* === GLOBAL MOBILE MODAL IMPROVEMENTS === */
    @media (max-width: 768px) {
      /* All modals bottom sheet style */
      .modal-overlay,
      .modal-modern-overlay {
        align-items: flex-end !important;
      }

      .modal,
      .modal-modern,
      .modal-content {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 90vh !important;
        max-height: 90dvh !important;
        margin: 0 !important;
        border-radius: 20px 20px 0 0 !important;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      /* Modal drag handle indicator */
      .modal-header::before,
      .modal-modern-header::before {
        content: '';
        display: block;
        width: 40px;
        height: 4px;
        background: var(--border-light);
        border-radius: 2px;
        margin: 0 auto 12px;
      }

      /* Sticky headers and footers */
      .modal-header,
      .modal-modern-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--dark-surface);
      }

      .modal-footer,
      .modal-modern-footer {
        position: sticky;
        bottom: 0;
        z-index: 10;
        background: var(--dark-surface);
        padding-bottom: calc(16px + env(safe-area-inset-bottom)) !important;
      }

      .modal-footer .btn,
      .modal-footer .btn-modern,
      .modal-modern-footer .btn,
      .modal-modern-footer .btn-modern {
        flex: 1;
        justify-content: center;
        min-height: 48px;
      }
    }

    /* === GLOBAL TABLE MOBILE STYLES === */
    @media (max-width: 768px) {
      /* Convert tables to card-like rows */
      table.data-table,
      .table-container table {
        display: block;
      }

      table.data-table thead,
      .table-container thead {
        display: none;
      }

      table.data-table tbody,
      .table-container tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      table.data-table tr,
      .table-container tr {
        display: flex;
        flex-direction: column;
        background: var(--dark-elevated);
        border-radius: 12px;
        padding: 16px;
        border: 1px solid var(--border-subtle);
      }

      table.data-table td,
      .table-container td {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid var(--border-subtle);
      }

      table.data-table td:last-child,
      .table-container td:last-child {
        border-bottom: none;
      }

      table.data-table td::before,
      .table-container td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--text-muted);
        font-size: 12px;
        text-transform: uppercase;
      }
    }

    /* === MOBILE FLOATING ACTION BUTTON === */
    @media (max-width: 768px) {
      .fab-modern {
        position: fixed;
        bottom: calc(20px + env(safe-area-inset-bottom));
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: var(--gold-primary);
        color: var(--dark-primary);
        border: none;
        box-shadow: 0 4px 16px rgba(249, 203, 0, 0.4);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .fab-modern:active {
        transform: scale(0.95);
      }

      .fab-modern svg {
        width: 24px;
        height: 24px;
      }
    }

    /* === GLOBAL MOBILE POLISH === */
    @media (max-width: 991px) {
      /* Smooth scrolling for all scrollable areas */
      html, body {
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
      }

      /* Prevent horizontal overflow */
      body {
        overflow-x: hidden;
      }

      /* Better focus states for accessibility */
      input:focus,
      select:focus,
      textarea:focus,
      button:focus,
      .btn:focus,
      .btn-modern:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(249, 203, 0, 0.3);
      }

      /* Prevent text selection on interactive elements */
      button,
      .btn,
      .btn-modern,
      .nav-item,
      .filter-btn,
      .filter-pill,
      .tab-btn {
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }

      /* Loading states */
      .loading,
      .skeleton {
        background: linear-gradient(90deg, var(--dark-elevated) 25%, var(--dark-surface) 50%, var(--dark-elevated) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
      }

      @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
      }

      /* Better spacing for content areas */
      .content-area {
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }

      /* Card spacing on mobile */
      .card {
        margin-bottom: 16px;
        border-radius: 12px;
      }

      .card-header {
        padding: 14px 16px;
      }

      .card-body {
        padding: 16px;
      }

      /* Pull to refresh indicator area */
      .main-content {
        padding-top: 0;
      }

      /* Toast notifications mobile positioning */
      .toast,
      .toast-notification {
        left: 16px !important;
        right: 16px !important;
        bottom: calc(20px + env(safe-area-inset-bottom)) !important;
        max-width: none !important;
        border-radius: 12px !important;
      }

      /* Context menu mobile */
      .context-menu {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        top: auto !important;
        max-width: 100% !important;
        border-radius: 20px 20px 0 0 !important;
        padding-bottom: env(safe-area-inset-bottom);
        animation: slideUp 0.2s ease;
      }

      .context-menu-item {
        padding: 16px 20px;
        min-height: 52px;
        font-size: 15px;
      }

      /* Dropdown menus mobile */
      .dropdown-menu {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        top: auto !important;
        max-width: 100% !important;
        max-height: 60vh !important;
        border-radius: 20px 20px 0 0 !important;
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* Spinner sizing */
      .spinner,
      .loading-spinner {
        width: 32px;
        height: 32px;
        border-width: 3px;
      }

      /* Status badges */
      .status-badge,
      .badge-modern {
        padding: 5px 10px;
        font-size: 11px;
        border-radius: 20px;
      }

      /* Action buttons consistent sizing */
      .actions-row,
      .action-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .actions-row .btn-modern,
      .action-buttons .btn-modern {
        flex: 1 1 auto;
        min-width: 80px;
        justify-content: center;
      }

      /* Transitions for smoother animations */
      * {
        -webkit-tap-highlight-color: transparent;
      }

      /* Safe area padding for fixed elements */
      .fixed-bottom {
        padding-bottom: env(safe-area-inset-bottom);
      }

      .fixed-top {
        padding-top: env(safe-area-inset-top);
      }
    }

    /* Very small phones adjustments */
    @media (max-width: 360px) {
      .content-area {
        padding: 12px;
      }

      .card-header,
      .card-body {
        padding: 12px;
      }

      .btn-modern {
        padding: 10px 14px;
        font-size: 13px;
      }

      .stats-grid {
        gap: 8px;
      }

      .stat-card {
        padding: 12px;
      }

      .stat-value {
        font-size: 18px;
      }

      .stat-label {
        font-size: 11px;
      }
    }

    /* ============================================
       SKELETON LOADING STATES
       ============================================ */
    .skeleton {
      background: linear-gradient(90deg,
        var(--dark-elevated) 0%,
        rgba(255, 255, 255, 0.08) 50%,
        var(--dark-elevated) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 6px;
    }

    .skeleton-text {
      height: 14px;
      margin-bottom: 8px;
    }

    .skeleton-text.short { width: 40%; }
    .skeleton-text.medium { width: 70%; }
    .skeleton-text.long { width: 100%; }

    .skeleton-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
    }

    .skeleton-card {
      padding: 16px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
    }

    .skeleton-row {
      display: flex;
      gap: 16px;
      align-items: center;
      padding: 16px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      margin-bottom: 8px;
    }

    .skeleton-row .skeleton-content {
      flex: 1;
    }

    .skeleton-badge {
      width: 80px;
      height: 24px;
      border-radius: 20px;
    }

    .skeleton-stat {
      height: 32px;
      width: 60px;
      margin-bottom: 8px;
    }

    /* Mobile horizontal scroll for filter pills */
    @media (max-width: 480px) {
      .filter-pills {
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        padding-bottom: 8px;
        margin: 0 -16px;
        padding-left: 16px;
        padding-right: 16px;
      }

      .filter-pills::-webkit-scrollbar {
        display: none;
      }

      .filter-pill {
        flex-shrink: 0;
      }

      /* Search filters stack vertically on mobile */
      .search-filters-row {
        flex-direction: column !important;
      }

      .search-filters-row > * {
        width: 100% !important;
        min-width: unset !important;
      }

      /* Selects take full width on small screens */
      select {
        min-width: unset !important;
        width: 100%;
      }
    }

    /* ============================================
       MODERN LIST STYLES
       ============================================ */
    .list-modern {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .list-item-modern {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .list-item-modern:hover {
      background: var(--dark-surface);
      border-color: var(--border-light);
      transform: translateX(4px);
    }

    .list-item-modern:active {
      transform: scale(0.98);
    }

    .list-item-icon {
      width: 44px;
      height: 44px;
      min-width: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(249, 203, 0, 0.1);
    }

    .list-item-content {
      flex: 1;
      min-width: 0;
    }

    .list-item-title {
      font-weight: 600;
      font-size: 15px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-item-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .list-item-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      flex-shrink: 0;
    }

    .list-item-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Badge Modern Styles - Enhanced for dark mode */
    .badge-modern {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-modern.badge-new,
    .badge-new {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.25) 0%, rgba(249, 203, 0, 0.12) 100%);
      color: #fcd34d;
      box-shadow: inset 0 0 0 1px rgba(249, 203, 0, 0.35);
    }

    .badge-modern.badge-contacted,
    .badge-contacted {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 100%);
      color: #93c5fd;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.35);
    }

    .badge-modern.badge-qualified,
    .badge-qualified {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.25) 0%, rgba(139, 92, 246, 0.12) 100%);
      color: #c4b5fd;
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.35);
    }

    .badge-modern.badge-quoted,
    .badge-quoted {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.25) 0%, rgba(6, 182, 212, 0.12) 100%);
      color: #67e8f9;
      box-shadow: inset 0 0 0 1px rgba(6, 182, 212, 0.35);
    }

    .badge-modern.badge-won,
    .badge-modern.badge-approved,
    .badge-modern.badge-paid,
    .badge-modern.badge-completed,
    .badge-won, .badge-approved, .badge-paid, .badge-completed {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.25) 0%, rgba(34, 197, 94, 0.12) 100%);
      color: #86efac;
      box-shadow: inset 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    .badge-modern.badge-lost,
    .badge-modern.badge-cancelled,
    .badge-modern.badge-overdue,
    .badge-lost, .badge-cancelled, .badge-overdue {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(239, 68, 68, 0.12) 100%);
      color: #fca5a5;
      box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.35);
    }

    .badge-modern.badge-archived,
    .badge-modern.badge-draft,
    .badge-archived, .badge-draft {
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.25) 0%, rgba(107, 114, 128, 0.12) 100%);
      color: #d1d5db;
      box-shadow: inset 0 0 0 1px rgba(107, 114, 128, 0.35);
    }

    .badge-modern.badge-sent,
    .badge-sent {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.25) 0%, rgba(59, 130, 246, 0.12) 100%);
      color: #93c5fd;
      box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.35);
    }

    .badge-modern.badge-scheduled,
    .badge-scheduled {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.25) 0%, rgba(139, 92, 246, 0.12) 100%);
      color: #c4b5fd;
      box-shadow: inset 0 0 0 1px rgba(139, 92, 246, 0.35);
    }

    .badge-modern.badge-in_progress,
    .badge-in_progress {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.25) 0%, rgba(6, 182, 212, 0.12) 100%);
      color: #67e8f9;
      box-shadow: inset 0 0 0 1px rgba(6, 182, 212, 0.35);
    }

    .badge-modern.badge-lead,
    .badge-lead {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.25) 0%, rgba(245, 158, 11, 0.12) 100%);
      color: #fcd34d;
      box-shadow: inset 0 0 0 1px rgba(245, 158, 11, 0.35);
    }

    .badge-modern.badge-on_hold,
    .badge-on_hold {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.25) 0%, rgba(239, 68, 68, 0.12) 100%);
      color: #fca5a5;
      box-shadow: inset 0 0 0 1px rgba(239, 68, 68, 0.35);
    }

    /* Button Modern Styles */
    .btn-modern {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      text-decoration: none;
      white-space: nowrap;
    }

    .btn-modern.primary {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    .btn-modern.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(249, 203, 0, 0.3);
    }

    .btn-modern.secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-modern.secondary:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--gold-primary);
    }

    .btn-modern.ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-modern.ghost:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .btn-modern.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .btn-modern.danger:hover {
      background: rgba(239, 68, 68, 0.25);
    }

    .btn-modern:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* List Item Mobile Responsive */
    @media (max-width: 480px) {
      .list-item-modern {
        flex-wrap: wrap;
        gap: 12px;
      }

      .list-item-content {
        flex: 1 1 calc(100% - 60px);
      }

      .list-item-meta {
        flex: 1 1 100%;
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding-top: 8px;
        border-top: 1px solid var(--border-subtle);
      }
    }

    /* ============================================
       LISTINGS GRID & CARDS
       ============================================ */
    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .listing-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .listing-image {
      position: relative;
      width: 100%;
      height: 160px;
      background: var(--dark-surface);
    }

    .listing-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .listing-status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .listing-status-badge.active {
      background: rgba(77, 255, 130, 0.2);
      color: var(--success);
    }

    .listing-status-badge.sold {
      background: rgba(255, 71, 87, 0.2);
      color: var(--error);
    }

    /* ============================================
       ENHANCED PROJECT MANAGEMENT UI
       ============================================ */

    /* Dashboard Stats - Enhanced */
    .stats-dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card-enhanced {
      background: linear-gradient(145deg, var(--dark-elevated), var(--dark-surface));
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .stat-card-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold-primary), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card-enhanced:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
      border-color: var(--gold-primary);
    }

    .stat-card-enhanced:hover::before {
      opacity: 1;
    }

    .stat-card-enhanced .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-card-enhanced .stat-icon-wrapper {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-card-enhanced .stat-icon-wrapper.gold { background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); }
    .stat-card-enhanced .stat-icon-wrapper.blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .stat-card-enhanced .stat-icon-wrapper.green { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .stat-card-enhanced .stat-icon-wrapper.purple { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .stat-card-enhanced .stat-icon-wrapper.red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

    .stat-card-enhanced .stat-trend {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .stat-card-enhanced .stat-trend.up { color: #10b981; }
    .stat-card-enhanced .stat-trend.down { color: #ef4444; }

    .stat-card-enhanced .stat-value-large {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.1;
      margin-bottom: 4px;
    }

    .stat-card-enhanced .stat-label-enhanced {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Project Card - Enhanced */
    .project-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .project-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
      border-color: rgba(249, 203, 0, 0.3);
    }

    .project-card-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .project-avatar {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: var(--dark-primary);
      flex-shrink: 0;
    }

    .project-info {
      flex: 1;
      min-width: 0;
    }

    .project-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .project-client {
      font-size: 14px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .project-card-body {
      padding: 20px;
    }

    .project-meta-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .project-meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .project-meta-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .project-meta-value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Progress Bar - Enhanced */
    .progress-bar-container {
      margin-top: 16px;
    }

    .progress-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-bar-label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .progress-bar-percent {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold-primary);
    }

    .progress-bar-track {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold-primary), var(--gold-dark));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Kanban Board - Enhanced */
    .kanban-board {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 0 24px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .kanban-board::-webkit-scrollbar {
      height: 8px;
    }

    .kanban-board::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .kanban-board::-webkit-scrollbar-thumb {
      background: var(--gold-primary);
      border-radius: 4px;
    }

    .kanban-column {
      flex: 0 0 280px;
      min-width: 280px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .kanban-column-header {
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .kanban-column-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 14px;
    }

    .kanban-column-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .kanban-column-dot.lead { background: #f59e0b; }
    .kanban-column-dot.approved { background: #3b82f6; }
    .kanban-column-dot.scheduled { background: #8b5cf6; }
    .kanban-column-dot.in-progress { background: #06b6d4; }
    .kanban-column-dot.completed { background: #10b981; }

    .kanban-column-count {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .kanban-cards {
      padding: 16px;
      max-height: 500px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .kanban-cards::-webkit-scrollbar {
      width: 4px;
    }

    .kanban-cards::-webkit-scrollbar-track {
      background: transparent;
    }

    .kanban-cards::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    .kanban-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .kanban-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-color: var(--gold-primary);
    }

    .kanban-card-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .kanban-card-client {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .kanban-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .kanban-card-amount {
      font-weight: 700;
      font-size: 15px;
      color: var(--gold-primary);
    }

    .kanban-card-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Workflow Timeline */
    .workflow-timeline {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px;
      background: var(--dark-elevated);
      border-radius: 16px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 24px;
      position: relative;
    }

    .workflow-timeline::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 80px;
      right: 80px;
      height: 2px;
      background: var(--border-subtle);
      transform: translateY(-50%);
      z-index: 0;
    }

    .workflow-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .workflow-step-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-surface);
      border: 2px solid var(--border-subtle);
      transition: all 0.3s;
    }

    .workflow-step.active .workflow-step-icon {
      background: var(--gold-primary);
      border-color: var(--gold-primary);
      color: var(--dark-primary);
      box-shadow: 0 0 20px rgba(249, 203, 0, 0.4);
    }

    .workflow-step.completed .workflow-step-icon {
      background: #10b981;
      border-color: #10b981;
      color: white;
    }

    .workflow-step-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .workflow-step.active .workflow-step-label {
      color: var(--gold-primary);
    }

    .workflow-step.completed .workflow-step-label {
      color: #10b981;
    }

    /* Quick Action Bar */
    .quick-action-bar {
      display: flex;
      gap: 12px;
      padding: 16px 24px;
      background: var(--dark-elevated);
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-action-btn:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: var(--gold-primary);
      color: var(--gold-primary);
    }

    .quick-action-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Lead card quick action buttons - compact version */
    .lead-quick-actions {
      display: flex;
      gap: 8px;
      border-top: 1px solid var(--border-subtle);
      padding-top: 12px;
      margin-top: auto;
    }

    .lead-quick-actions .btn-action {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 8px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .lead-quick-actions .btn-action:hover {
      transform: translateY(-1px);
    }

    .lead-quick-actions .btn-action.call:hover {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border-color: rgba(34, 197, 94, 0.4);
    }

    .lead-quick-actions .btn-action.email:hover {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border-color: rgba(59, 130, 246, 0.4);
    }

    .lead-quick-actions .btn-action.status:hover {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
      border-color: rgba(245, 158, 11, 0.4);
    }

    .lead-quick-actions .btn-action.project:hover {
      background: rgba(139, 92, 246, 0.15);
      color: #8b5cf6;
      border-color: rgba(139, 92, 246, 0.4);
    }

    .lead-quick-actions .btn-action.archive:hover {
      background: rgba(107, 114, 128, 0.15);
      color: #9ca3af;
      border-color: rgba(107, 114, 128, 0.4);
    }

    .lead-quick-actions .btn-action.delete:hover {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.4);
    }

    /* Project quick actions on list items */
    .project-quick-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .list-item-modern:hover .project-quick-actions {
      opacity: 1;
    }

    .project-quick-actions button {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      background: var(--dark-surface);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: all 0.15s;
    }

    .project-quick-actions button:hover {
      transform: scale(1.1);
    }

    .project-quick-actions button.status:hover {
      background: var(--gold-primary);
      color: var(--dark-primary);
    }

    .project-quick-actions button.schedule:hover {
      background: #3b82f6;
      color: #fff;
    }

    .project-quick-actions button.task:hover {
      background: #22c55e;
      color: #fff;
    }

    /* Kanban card quick actions */
    .kanban-quick-actions {
      display: none;
      gap: 4px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--dark-border);
    }

    .kanban-card:hover .kanban-quick-actions {
      display: flex;
    }

    .kanban-quick-actions button {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.15s;
    }

    .kanban-quick-actions button.schedule {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
    }

    .kanban-quick-actions button.task {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .kanban-quick-actions button:hover {
      transform: scale(1.02);
      filter: brightness(1.1);
    }

    /* Empty State - Enhanced */
    .empty-state-enhanced {
      text-align: center;
      padding: 60px 40px;
      background: var(--dark-elevated);
      border: 2px dashed var(--border-subtle);
      border-radius: 20px;
      margin: 24px 0;
    }

    .empty-state-enhanced svg {
      width: 80px;
      height: 80px;
      color: var(--text-muted);
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .empty-state-enhanced h3 {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state-enhanced p {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 400px;
      margin: 0 auto 24px;
      line-height: 1.6;
    }

    /* Data Table - Enhanced */
    .data-table-wrapper {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid var(--border-subtle);
    }

    .data-table td {
      padding: 16px 20px;
      font-size: 14px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-subtle);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Priority Indicators */
    .priority-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .priority-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .priority-high .priority-dot { background: #ef4444; }
    .priority-medium .priority-dot { background: #f59e0b; }
    .priority-low .priority-dot { background: #10b981; }

    .priority-high { color: #ef4444; }
    .priority-medium { color: #f59e0b; }
    .priority-low { color: #10b981; }

    /* Due Date Styling */
    .due-date {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .due-date.overdue {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .due-date.due-soon {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .due-date.on-track {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }

    /* Activity Feed */
    .activity-feed {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .activity-item {
      display: flex;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .activity-icon.create { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .activity-icon.update { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .activity-icon.delete { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .activity-icon.payment { background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); }
    .activity-icon.message { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

    .activity-content {
      flex: 1;
      min-width: 0;
    }

    .activity-text {
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .activity-text strong {
      font-weight: 600;
      color: var(--gold-primary);
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Filter Tabs - Enhanced */
    .filter-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .filter-tab {
      flex: 1;
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-muted);
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .filter-tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
    }

    .filter-tab.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      font-weight: 600;
    }

    /* Responsive Grid Utilities */
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }

    @media (max-width: 1024px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 640px) {
      .grid-4, .grid-3, .grid-2 { grid-template-columns: 1fr; }
      .workflow-timeline { flex-direction: column; gap: 16px; padding: 20px; }
      .workflow-timeline::before { display: none; }
      .kanban-column { flex: 0 0 280px; min-width: 280px; }
    }

    .listing-status-badge.expired {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .listing-content {
      padding: 16px;
    }

    .listing-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .listing-stone {
      font-size: 12px;
      color: var(--gold-primary);
      margin-bottom: 10px;
    }

    .listing-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .listing-meta-item {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .listing-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-primary);
      margin-bottom: 12px;
    }

    .listing-price.contact {
      font-size: 13px;
      color: var(--text-muted);
    }

    .listing-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .listing-actions {
      display: flex;
      gap: 8px;
    }

    .listing-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .listing-actions .btn-edit {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
    }

    .listing-actions .btn-edit:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .listing-actions .btn-delete {
      background: transparent;
      border: 1px solid var(--error);
      color: var(--error);
    }

    .listing-actions .btn-delete:hover {
      background: rgba(255, 71, 87, 0.1);
    }

    /* Listing Category Grid */
    .listing-category-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 8px;
    }

    @media (max-width: 600px) {
      .listing-category-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .listing-category-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
      background: var(--dark-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      gap: 6px;
    }

    .listing-category-option:hover {
      border-color: var(--text-muted);
      background: var(--dark-surface);
    }

    .listing-category-option.selected {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.1);
    }

    .listing-category-option svg {
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .listing-category-option.selected svg {
      color: var(--gold-primary);
    }

    .listing-category-option span {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .listing-category-option small {
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.2;
    }

    .listing-category-option.selected span {
      color: var(--gold-primary);
    }

    /* Category badge on listing cards */
    .listing-category-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.7);
      color: var(--text-primary);
      backdrop-filter: blur(4px);
    }

    .listing-category-badge.countertops { color: #60a5fa; }
    .listing-category-badge.tile { color: #f472b6; }
    .listing-category-badge.flooring { color: #4ade80; }
    .listing-category-badge.cabinets { color: #fb923c; }
    .listing-category-badge.supplies { color: #a78bfa; }
    .listing-category-badge.other { color: #94a3b8; }

    /* ============================================
       DESIGN TOOLS GRID
       ============================================ */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .tools-grid.calculators-grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }

    .tool-card {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 20px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .tool-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-color: var(--border-light);
    }

    .tool-card.featured {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.1) 0%, rgba(249, 203, 0, 0.05) 100%);
      border-color: rgba(249, 203, 0, 0.3);
    }

    .tool-card.featured:hover {
      border-color: var(--gold-primary);
      box-shadow: 0 8px 24px rgba(249, 203, 0, 0.15);
    }

    .tool-card.calculator {
      padding: 16px;
    }

    .tool-icon {
      width: 48px;
      height: 48px;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }

    .tool-icon.small {
      width: 40px;
      height: 40px;
      min-width: 40px;
    }

    .tool-icon svg {
      width: 26px;
      height: 26px;
      color: var(--gold-primary);
    }

    .tool-icon.small svg {
      width: 22px;
      height: 22px;
      color: var(--text-secondary);
    }

    .tool-card.featured .tool-icon {
      background: rgba(249, 203, 0, 0.15);
    }

    .tool-info {
      flex: 1;
      min-width: 0;
    }

    .tool-info h4 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px 0;
    }

    .tool-info p {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.4;
    }

    .tool-badge {
      display: inline-block;
      margin-top: 8px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tool-badge.featured {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    @media (max-width: 600px) {
      .tools-grid {
        grid-template-columns: 1fr;
      }
      .tools-grid.calculators-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Inquiry Items */
    .inquiry-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: background 0.2s;
    }

    .inquiry-item.unread {
      border-left: 3px solid var(--gold-primary);
    }

    .inquiry-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .inquiry-listing {
      font-size: 13px;
      color: var(--gold-primary);
      margin-bottom: 4px;
    }

    .inquiry-sender {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .inquiry-contact {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .inquiry-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .inquiry-message {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .inquiry-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .inquiry-actions .btn {
      padding: 8px 14px;
      font-size: 12px;
    }

    .inquiry-actions .btn-email {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .inquiry-actions .btn-email:hover {
      background: rgba(59, 130, 246, 0.25);
    }

    .inquiry-actions .btn-payment {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .inquiry-actions .btn-payment:hover {
      background: rgba(16, 185, 129, 0.25);
    }

    /* Payment Request Modal */
    .payment-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .payment-modal-content {
      background: var(--dark-surface);
      border-radius: 16px;
      max-width: 420px;
      width: 100%;
      overflow: hidden;
    }

    .payment-modal-header {
      background: linear-gradient(135deg, var(--dark-primary) 0%, #16213e 100%);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payment-modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .payment-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 24px;
      padding: 4px;
    }

    .payment-modal-body {
      padding: 24px;
    }

    .payment-modal-body .form-group {
      margin-bottom: 16px;
    }

    .payment-modal-body label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .payment-modal-body input,
    .payment-modal-body textarea {
      width: 100%;
      padding: 12px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .payment-modal-body input:focus,
    .payment-modal-body textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    .payment-modal-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
    }

    .payment-modal-info p {
      margin: 0;
      font-size: 12px;
      color: #60a5fa;
    }

    .payment-modal-footer {
      padding: 16px 24px;
      background: var(--dark-elevated);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Create Listing Modal - Standardized styles */
    .modal-content {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    /* Workflow Schedule Modal Styles */
    .workflow-event-toggle:has(input:checked) {
      border-color: var(--primary);
      background: rgba(99, 102, 241, 0.1);
    }

    .workflow-event-toggle:hover {
      border-color: var(--primary);
    }

    #workflow-dates-container input[type="date"],
    #workflow-dates-container input[type="time"] {
      background: var(--dark-tertiary);
      border: 1px solid var(--border-color);
    }

    #workflow-contractors-list::-webkit-scrollbar {
      width: 6px;
    }

    #workflow-contractors-list::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      background: var(--dark-surface);
      z-index: 1;
      gap: 12px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .modal-body {
      padding: 24px;
    }

    .form-section {
      margin-bottom: 24px;
    }

    /* Contact Preferences Checkboxes */
    .contact-pref-item {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      gap: 12px !important;
      margin-bottom: 12px !important;
      cursor: pointer !important;
    }
    .contact-pref-item input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      min-width: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
      accent-color: var(--gold-primary) !important;
      flex-shrink: 0 !important;
    }
    .contact-pref-item span {
      font-size: 14px !important;
      color: #ccc !important;
      text-transform: none !important;
      font-weight: 400 !important;
      display: inline !important;
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold-primary);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Stone Autocomplete */
    .stone-autocomplete {
      position: relative;
    }

    .stone-autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .stone-autocomplete-results.active {
      display: block;
    }

    .stone-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .stone-result-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .stone-result-thumb {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
    }

    .stone-result-info {
      flex: 1;
    }

    .stone-result-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .stone-result-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Image Upload Grid */
    .image-upload-section {
      margin-top: 8px;
    }

    .image-upload-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .image-upload-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .image-upload-slot {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      background: var(--dark-elevated);
      border: 2px dashed var(--border-light);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .image-upload-slot:first-child {
      aspect-ratio: 4/3;
    }

    @media (max-width: 600px) {
      .image-upload-slot:first-child {
        grid-column: span 2;
      }
    }

    .image-upload-slot:hover {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .image-upload-slot.has-image {
      border-style: solid;
      border-color: var(--gold-primary);
    }

    .upload-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-muted);
    }

    .upload-placeholder svg {
      color: var(--gold-primary);
      opacity: 0.7;
    }

    .upload-placeholder span {
      font-size: 12px;
      font-weight: 500;
    }

    .upload-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-image-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.95);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      z-index: 10;
    }

    .remove-image-btn:hover {
      background: #ff4747;
      transform: scale(1.1);
    }

    .upload-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(0, 0, 0, 0.5);
    }

    .upload-progress-bar {
      height: 100%;
      background: var(--gold-primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Legacy image preview for backward compatibility */
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .image-preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: var(--dark-elevated);
      border: 1px dashed var(--border-light);
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-item .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.9);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* ============================================
       COMPREHENSIVE MOBILE OPTIMIZATIONS
       All screens optimized for mobile users
       ============================================ */

    /* Mobile-first touch targets (44x44px minimum) */
    @media (max-width: 768px) {
      /* Global touch-friendly sizing */
      .btn-modern, .filter-pill, .tab-btn, .nav-item {
        min-height: 44px;
        min-width: 44px;
      }

      /* Sidebar - Full screen overlay on mobile */
      .sidebar {
        position: fixed;
        left: -280px;
        top: 0;
        bottom: 0;
        width: 280px;
        z-index: 1000;
        transition: left 0.3s ease;
        box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
      }

      .sidebar.open {
        left: 0;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }

      .sidebar.open + .sidebar-overlay,
      body.sidebar-open .sidebar-overlay {
        display: block;
      }

      /* Main content full width */
      .main-content {
        margin-left: 0 !important;
        width: 100% !important;
        padding: 16px !important;
        padding-bottom: 80px !important; /* Space for FAB */
      }

      /* Mobile header with hamburger */
      .topbar {
        padding: 12px 16px;
        gap: 12px;
      }

      .mobile-menu-toggle {
        display: flex !important;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        background: var(--dark-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: 8px;
        color: var(--text-primary);
        cursor: pointer;
      }

      .page-title {
        font-size: 18px !important;
      }

      /* Cards - Full width, reduced padding */
      .card, .table-container {
        border-radius: 12px;
        padding: 0;
      }

      .card-header, .table-header {
        padding: 16px;
        flex-direction: column;
        align-items: stretch !important;
        gap: 12px;
      }

      .card-body {
        padding: 16px;
      }

      /* Stat cards - 2 column grid */
      .stat-grid, .dashboard-stats, #dashboard-stats {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }

      .stat-card {
        padding: 16px 12px !important;
        min-height: auto;
      }

      .stat-value {
        font-size: 24px !important;
      }

      .stat-label {
        font-size: 11px !important;
      }

      /* Filter pills - horizontal scroll */
      .filter-pills {
        display: flex;
        overflow-x: auto;
        gap: 8px;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }

      .filter-pills::-webkit-scrollbar {
        display: none;
      }

      .filter-pill {
        flex-shrink: 0;
        padding: 10px 16px;
        font-size: 13px;
      }

      /* Tables - Card-based layout */
      table {
        display: block;
        width: 100%;
      }

      table thead {
        display: none;
      }

      table tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      table tr {
        display: flex;
        flex-direction: column;
        background: var(--dark-elevated);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 16px;
        gap: 8px;
      }

      table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border: none !important;
        font-size: 14px;
      }

      table td::before {
        content: attr(data-label);
        font-weight: 600;
        color: var(--text-muted);
        font-size: 12px;
        text-transform: uppercase;
      }

      /* Buttons - Stack vertically */
      .btn-group, .modal-footer, .card-actions {
        flex-direction: column;
        gap: 8px;
      }

      .btn-modern {
        width: 100%;
        justify-content: center;
        padding: 14px 20px;
        font-size: 15px;
      }

      /* Forms - Full width inputs */
      .form-group, .input-group {
        width: 100%;
      }

      input, select, textarea {
        width: 100%;
        padding: 14px 16px;
        font-size: 16px; /* Prevents iOS zoom */
        border-radius: 10px;
      }

      /* Search bar */
      .search-bar-modern {
        width: 100% !important;
        max-width: none !important;
      }

      .search-bar-modern input {
        padding: 14px 16px 14px 44px;
      }

      /* Modals - Bottom sheet style */
      .modal-overlay {
        align-items: flex-end;
        padding: 0;
      }

      .modal {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        margin: 0;
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 20px 16px 16px;
        position: relative;
      }

      .modal-header::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background: var(--border-light);
        border-radius: 2px;
      }

      .modal-body {
        padding: 16px;
        max-height: 60vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .modal-footer {
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }

      /* Keep Add Lead modal floating/centered */
      #add-lead-modal.modal-overlay {
        align-items: center !important;
        padding: 16px !important;
      }

      #add-lead-modal .modal {
        max-width: 100% !important;
        width: calc(100% - 32px) !important;
        max-height: 80vh !important;
        border-radius: 16px !important;
        margin: auto !important;
        animation: modalFadeIn 0.3s ease !important;
      }

      @keyframes modalFadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
      }

      /* Customer tabs - scrollable */
      .customer-tabs {
        overflow-x: auto;
        flex-wrap: nowrap !important;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }

      .customer-tabs .tab-btn {
        flex-shrink: 0;
        white-space: nowrap;
        padding: 12px 16px;
      }

      /* Lead/Customer cards */
      .lead-card, .customer-card, .estimate-card, .invoice-card, .job-card {
        padding: 16px;
      }

      .lead-header, .customer-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      /* Quick actions - 2 column grid */
      .quick-actions, #quick-actions {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }

      .action-card {
        flex-direction: column;
        padding: 16px;
        text-align: center;
        gap: 8px;
      }

      .action-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto;
      }

      .action-text h4 {
        font-size: 13px;
      }

      .action-text p {
        font-size: 11px;
        display: none; /* Hide description on mobile */
      }

      /* Listings grid - single column */
      .listings-grid {
        grid-template-columns: 1fr !important;
        gap: 16px;
      }

      /* Favorites grid - 2 columns */
      .favorites-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px;
      }

      .favorite-card {
        padding: 12px;
      }

      .favorite-card img {
        height: 100px;
      }

      /* Calendar mobile */
      .calendar-grid {
        font-size: 12px;
      }

      .calendar-day {
        min-height: 60px;
        padding: 4px;
      }

      /* Detail rows - stack */
      .detail-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      .detail-label {
        font-size: 11px;
      }

      .detail-value {
        font-size: 14px;
      }

      /* Topbar actions */
      .topbar-actions {
        gap: 8px;
      }

      .topbar-actions .btn-modern .btn-text {
        display: none;
      }

      .topbar-actions .btn-modern {
        width: 44px;
        height: 44px;
        padding: 0;
        min-width: 44px;
      }

      /* Role switcher */
      #role-switcher {
        display: none !important; /* Hide on mobile - use settings instead */
      }

      /* User menu in sidebar footer */
      .sidebar-footer {
        padding: 16px;
      }

      .user-menu {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }

      /* Estimate/Invoice items */
      .line-item {
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      .line-item-details {
        width: 100%;
      }

      .line-item-actions {
        width: 100%;
        justify-content: flex-end;
      }

      /* Empty states */
      .empty-state {
        padding: 40px 20px;
      }

      .empty-state svg {
        width: 48px;
        height: 48px;
      }

      .empty-state h3 {
        font-size: 16px;
      }

      .empty-state p {
        font-size: 13px;
      }
    }

    /* Extra small screens (phones in portrait) */
    @media (max-width: 480px) {
      /* Even smaller text */
      .page-title {
        font-size: 16px !important;
      }

      /* Single column stats on very small screens */
      .stat-grid, .dashboard-stats, #dashboard-stats {
        grid-template-columns: 1fr !important;
      }

      /* Quick actions single column */
      .quick-actions, #quick-actions {
        grid-template-columns: 1fr !important;
      }

      .action-card {
        flex-direction: row;
        text-align: left;
        padding: 14px;
      }

      .action-icon {
        width: 40px;
        height: 40px;
        margin: 0;
      }

      .action-text p {
        display: block;
      }

      /* Favorites single column */
      .favorites-grid {
        grid-template-columns: 1fr !important;
      }

      /* Modal even more compact */
      .modal-header {
        padding: 16px 12px 12px;
      }

      .modal-title {
        font-size: 18px;
      }

      .modal-body {
        padding: 12px;
      }

      /* Smaller buttons */
      .btn-modern {
        padding: 12px 16px;
        font-size: 14px;
      }

      /* Table cards more compact */
      table tr {
        padding: 12px;
      }

      table td {
        font-size: 13px;
      }
    }

    /* Mobile FAB (Floating Action Button) */
    .mobile-fab {
      display: none;
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
      border: none;
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.4);
      cursor: pointer;
      z-index: 100;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .mobile-fab:active {
      transform: scale(0.95);
    }

    .mobile-fab svg {
      width: 24px;
      height: 24px;
    }

    @media (max-width: 768px) {
      .mobile-fab {
        display: flex;
      }
    }

    /* Pull to refresh indicator */
    .pull-indicator {
      display: none;
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 24px;
      background: var(--dark-elevated);
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      color: var(--text-secondary);
      font-size: 13px;
    }

    /* Swipe actions hint */
    .swipe-hint {
      display: none;
      text-align: center;
      padding: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 768px) {
      .swipe-hint {
        display: block;
      }
    }

    /* Safe area padding for notched phones */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      @media (max-width: 768px) {
        .main-content {
          padding-bottom: calc(80px + env(safe-area-inset-bottom)) !important;
        }

        .modal-footer {
          padding-bottom: calc(16px + env(safe-area-inset-bottom));
        }

        .sidebar {
          padding-bottom: env(safe-area-inset-bottom);
        }
      }
    }

    /* Smooth scrolling on iOS */
    @media (max-width: 768px) {
      .modal-body,
      .sidebar-nav,
      .table-container,
      .card-body {
        -webkit-overflow-scrolling: touch;
      }

      /* Prevent body scroll when modal open */
      body.modal-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
      }

      /* Disable hover effects on touch */
      @media (hover: none) {
        .btn-modern:hover,
        .nav-item:hover,
        .filter-pill:hover,
        .card:hover,
        .listing-card:hover {
          transform: none;
          box-shadow: none;
        }
      }
    }

    /* Landscape phone adjustments */
    @media (max-width: 768px) and (orientation: landscape) {
      .modal {
        max-height: 85vh;
      }

      .modal-body {
        max-height: 50vh;
      }

      .stat-grid, .dashboard-stats, #dashboard-stats {
        grid-template-columns: repeat(4, 1fr) !important;
      }
    }

    /* Kanban Drag-and-Drop */
    .kanban-card[draggable="true"] { cursor: grab; }
    .kanban-card[draggable="true"]:active { cursor: grabbing; }
    .kanban-column.drag-over { outline: 2px solid var(--gold-primary) !important; }

    /* =============================================
       PROFILE SLIDE-OVER PANEL - ENHANCED
       ============================================= */
    .profile-panel-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(12px);
      z-index: 99999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .profile-panel-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .profile-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 100%;
      max-width: 900px;
      height: 100vh;
      height: 100dvh;
      background: #0a0a12;
      box-shadow: -8px 0 50px rgba(0, 0, 0, 0.5);
      transform: translateX(100%);
      transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      z-index: 100000;
      overflow: hidden;
    }
    .profile-panel-overlay.active .profile-panel {
      transform: translateX(0);
    }
    .profile-panel-header {
      padding: 0;
      border-bottom: 1px solid var(--border-subtle);
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      position: relative;
      overflow: hidden;
    }
    .profile-panel-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 60%;
      height: 200%;
      background: radial-gradient(ellipse, rgba(249, 203, 0, 0.15) 0%, transparent 70%);
      pointer-events: none;
    }
    .profile-header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px 0;
      position: relative;
      z-index: 1;
    }
    .profile-header-actions {
      display: flex;
      gap: 8px;
    }
    .profile-header-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .profile-header-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
    }
    .profile-header-btn.close:hover {
      background: rgba(239, 68, 68, 0.4);
    }
    .profile-header-main {
      display: flex;
      align-items: flex-end;
      gap: 20px;
      padding: 20px 24px 24px;
      position: relative;
      z-index: 1;
    }
    .profile-avatar {
      width: 88px;
      height: 88px;
      border-radius: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, #e6b800 50%, var(--accent) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 34px;
      font-weight: 800;
      color: #000;
      flex-shrink: 0;
      box-shadow: 0 8px 32px rgba(249, 203, 0, 0.3);
      border: 3px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }
    .profile-avatar-badge {
      position: absolute;
      bottom: -4px;
      right: -4px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #22c55e;
      border: 3px solid var(--dark-bg);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .profile-avatar-badge svg {
      width: 14px;
      height: 14px;
      color: #fff;
    }
    .profile-header-info {
      flex: 1;
      min-width: 0;
    }
    .profile-name {
      font-size: 26px;
      font-weight: 800;
      color: #fff;
      margin-bottom: 6px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .profile-meta {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
    }
    .profile-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-meta-item svg {
      opacity: 0.6;
    }
    .profile-meta-item a {
      color: rgba(255, 255, 255, 0.7);
      text-decoration: none;
      transition: color 0.2s;
    }
    .profile-meta-item a:hover {
      color: var(--primary);
    }
    .profile-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .profile-status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-status-badge.new { background: rgba(249, 203, 0, 0.25); color: #f9cb00; border: 1px solid rgba(249, 203, 0, 0.3); }
    .profile-status-badge.contacted { background: rgba(59, 130, 246, 0.25); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
    .profile-status-badge.qualified { background: rgba(139, 92, 246, 0.25); color: #a78bfa; border: 1px solid rgba(139, 92, 246, 0.3); }
    .profile-status-badge.quoted { background: rgba(6, 182, 212, 0.25); color: #22d3ee; border: 1px solid rgba(6, 182, 212, 0.3); }
    .profile-status-badge.won { background: rgba(34, 197, 94, 0.25); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
    .profile-status-badge.lost { background: rgba(239, 68, 68, 0.25); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.3); }
    .profile-status-badge.archived { background: rgba(107, 114, 128, 0.25); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.3); }
    .profile-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .profile-close-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .profile-close-btn:hover {
      background: rgba(239, 68, 68, 0.3);
    }

    /* Quick Stats Bar */
    .profile-stats-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1px;
      background: var(--border-subtle);
      border-bottom: 1px solid var(--border-subtle);
    }
    .profile-stat {
      background: var(--dark-elevated);
      padding: 14px 16px;
      text-align: center;
      transition: background 0.2s;
      cursor: default;
    }
    .profile-stat:hover {
      background: var(--dark-surface);
    }
    .profile-stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .profile-stat-value.highlight {
      color: var(--primary);
    }
    .profile-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Tabs with badges */
    .profile-tabs {
      display: flex;
      gap: 0;
      padding: 0 16px;
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
      overflow-x: auto;
      scrollbar-width: none;
    }
    .profile-tabs::-webkit-scrollbar { display: none; }
    .profile-tab {
      padding: 16px 20px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border: none;
      background: none;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }
    .profile-tab:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.03);
    }
    .profile-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: rgba(249, 203, 0, 0.05);
    }
    .profile-tab .tab-icon {
      width: 18px;
      height: 18px;
      opacity: 0.7;
    }
    .profile-tab.active .tab-icon {
      opacity: 1;
    }
    .tab-badge {
      background: var(--primary);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    .tab-badge.muted {
      background: var(--dark-elevated);
      color: var(--text-muted);
    }

    /* Content area */
    .profile-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: var(--dark-bg);
    }
    .profile-section {
      margin-bottom: 28px;
    }
    .profile-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .profile-section-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-secondary);
      margin-bottom: 0;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .profile-section-title svg {
      width: 16px;
      height: 16px;
      color: var(--primary);
    }
    .profile-info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .profile-info-item {
      background: var(--dark-surface);
      padding: 16px 18px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      transition: all 0.2s;
    }
    .profile-info-item:hover {
      border-color: var(--primary);
      background: var(--dark-elevated);
    }
    .profile-info-item.clickable {
      cursor: pointer;
    }
    .profile-info-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .profile-info-value {
      font-size: 15px;
      color: var(--text-primary);
      font-weight: 600;
      word-break: break-word;
    }
    .profile-info-value.muted {
      color: var(--text-muted);
      font-weight: 400;
    }

    /* Quick Actions Grid */
    .profile-quick-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .profile-quick-action {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .profile-quick-action:hover {
      background: var(--dark-elevated);
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .profile-quick-action .action-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .profile-quick-action .action-icon.gold {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.2), rgba(249, 203, 0, 0.1));
      color: var(--primary);
    }
    .profile-quick-action .action-icon.blue {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.1));
      color: #3b82f6;
    }
    .profile-quick-action .action-icon.green {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1));
      color: #22c55e;
    }
    .profile-quick-action .action-icon.purple {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
      color: #8b5cf6;
    }
    .profile-quick-action .action-text {
      flex: 1;
    }
    .profile-quick-action .action-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .profile-quick-action .action-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Footer Actions */
    .profile-actions {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      background: var(--dark-surface);
    }
    .profile-actions .btn-modern {
      flex: 1;
      justify-content: center;
    }

    /* Activity Timeline */
    .activity-timeline {
      position: relative;
      padding-left: 28px;
    }
    .activity-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 8px;
      bottom: 8px;
      width: 2px;
      background: var(--border-subtle);
      border-radius: 2px;
    }
    .activity-item {
      position: relative;
      padding: 12px 0;
      padding-left: 20px;
    }
    .activity-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 18px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--dark-elevated);
      border: 2px solid var(--primary);
    }
    .activity-item.completed::before {
      background: var(--primary);
    }
    .activity-content {
      background: var(--dark-surface);
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
    }
    .activity-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    .activity-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .activity-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    .activity-desc {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Appointment Cards */
    .appointment-card {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      gap: 16px;
      transition: all 0.2s;
    }
    .appointment-card:hover {
      border-color: var(--primary);
    }
    .appointment-date-box {
      width: 56px;
      text-align: center;
      flex-shrink: 0;
    }
    .appointment-month {
      font-size: 11px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .appointment-day {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
    }
    .appointment-weekday {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .appointment-info {
      flex: 1;
    }
    .appointment-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .appointment-time {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .appointment-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .appointment-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .appointment-status.scheduled {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }
    .appointment-status.completed {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
    }
    .appointment-status.cancelled {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
    }

    /* =============================================
       JOB PHASE SCHEDULER (Full Width) - ENHANCED
       ============================================= */
    .job-scheduler-panel {
      position: fixed;
      inset: 0;
      background: #0a0a12;
      z-index: 99998;
      opacity: 0;
      visibility: hidden;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .job-scheduler-panel.active {
      opacity: 1;
      visibility: visible;
    }
    .job-scheduler-header {
      padding: 0 24px;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: 70px;
      border-bottom: 1px solid rgba(249, 203, 0, 0.2);
      position: relative;
    }
    .job-scheduler-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, #e6b800 50%, var(--primary) 100%);
    }
    .job-scheduler-header h1 {
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .job-scheduler-header h1 svg {
      color: var(--primary);
    }
    .scheduler-header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .scheduler-customer-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .scheduler-customer-badge .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      color: #000;
    }
    .scheduler-customer-badge .name {
      color: #fff;
      font-weight: 600;
      font-size: 14px;
    }
    .job-scheduler-close {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .job-scheduler-close:hover {
      background: rgba(239, 68, 68, 0.3);
      color: #fff;
    }
    .job-scheduler-body {
      flex: 1;
      display: grid;
      grid-template-columns: 320px 1fr 300px;
      overflow: hidden;
    }
    @media (max-width: 1200px) {
      .job-scheduler-body {
        grid-template-columns: 280px 1fr;
      }
      .job-scheduler-timeline {
        display: none;
      }
    }
    .job-scheduler-sidebar {
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      padding: 24px;
      overflow-y: auto;
    }
    .job-scheduler-main {
      padding: 24px 32px;
      overflow-y: auto;
      background: var(--dark-bg);
    }
    .job-scheduler-timeline {
      background: var(--dark-surface);
      border-left: 1px solid var(--border-subtle);
      padding: 24px;
      overflow-y: auto;
    }

    /* Phase Cards - Enhanced */
    .phase-card {
      background: var(--dark-surface);
      border: 2px solid var(--border-subtle);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.25s ease;
      position: relative;
      overflow: hidden;
    }
    .phase-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: var(--border-subtle);
      transition: all 0.25s ease;
    }
    .phase-card:hover {
      border-color: var(--primary);
      transform: translateX(4px);
    }
    .phase-card:hover::before {
      background: var(--primary);
    }
    .phase-card.selected {
      border-color: var(--primary);
      background: rgba(249, 203, 0, 0.08);
    }
    .phase-card.selected::before {
      background: var(--primary);
      width: 5px;
    }
    .phase-card.completed {
      border-color: #22c55e;
      background: rgba(34, 197, 94, 0.08);
    }
    .phase-card.completed::before {
      background: #22c55e;
    }
    .phase-header {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .phase-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: linear-gradient(135deg, var(--dark-elevated), var(--dark-surface));
      border: 1px solid var(--border-subtle);
      flex-shrink: 0;
    }
    .phase-card.selected .phase-icon {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.2), rgba(249, 203, 0, 0.1));
      border-color: rgba(249, 203, 0, 0.3);
    }
    .phase-info {
      flex: 1;
      min-width: 0;
    }
    .phase-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .phase-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .phase-date-row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border-subtle);
    }

    /* Timeline Preview */
    .timeline-preview-item {
      display: flex;
      gap: 16px;
      padding: 16px 0;
      position: relative;
    }
    .timeline-preview-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 19px;
      top: 48px;
      bottom: 0;
      width: 2px;
      background: var(--border-subtle);
    }
    .timeline-preview-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--dark-elevated);
      border: 3px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      z-index: 1;
    }
    .timeline-preview-dot.active {
      border-color: var(--primary);
      background: rgba(249, 203, 0, 0.1);
    }
    .timeline-preview-content {
      flex: 1;
      padding-top: 8px;
    }
    .timeline-preview-date {
      font-size: 11px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .timeline-preview-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Scheduler Info Cards */
    .scheduler-info-card {
      background: var(--dark-elevated);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-subtle);
    }
    .scheduler-info-card .label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .scheduler-info-card .value {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .scheduler-date-input {
      background: var(--dark-bg);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }
    .scheduler-date-input label {
      font-size: 12px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
      display: block;
    }
    .scheduler-date-input input[type="date"] {
      font-size: 18px;
      font-weight: 700;
      padding: 12px;
      width: 100%;
    }
    .scheduler-lead-time {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: var(--dark-elevated);
      border-radius: 10px;
      margin-bottom: 10px;
      border: 1px solid var(--border-subtle);
    }
    .scheduler-lead-time:hover {
      border-color: var(--primary);
    }
    .scheduler-lead-time label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .scheduler-lead-time input {
      width: 70px;
      text-align: center;
      font-weight: 600;
    }
    .scheduler-notification {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: var(--dark-elevated);
      border-radius: 10px;
      cursor: pointer;
      margin-bottom: 10px;
      border: 1px solid var(--border-subtle);
      transition: all 0.2s;
    }
    .scheduler-notification:hover {
      border-color: var(--primary);
      background: var(--dark-surface);
    }
    .scheduler-notification input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--primary);
    }
    .scheduler-notification span {
      font-size: 14px;
      color: var(--text-primary);
    }
    .phase-date-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }
    .timeline-item {
      position: relative;
      padding-left: 32px;
      padding-bottom: 24px;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 8px;
      bottom: 0;
      width: 2px;
      background: var(--border-subtle);
    }
    .timeline-item:last-child::before {
      display: none;
    }
    .timeline-dot {
      position: absolute;
      left: 0;
      top: 4px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--dark-surface);
      border: 3px solid var(--primary);
    }
    .timeline-dot.completed {
      background: #22c55e;
      border-color: #22c55e;
    }
    .timeline-content {
      background: var(--dark-surface);
      border-radius: 8px;
      padding: 12px;
      border: 1px solid var(--border-subtle);
    }
    .timeline-date {
      font-size: 12px;
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 4px;
    }
    .timeline-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Notes Component */
    .note-card {
      background: var(--dark-elevated);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
      border-left: 3px solid var(--primary);
    }
    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .note-author {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .note-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    .note-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Activity Timeline */
    .activity-item {
      display: flex;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--dark-elevated);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .activity-content {
      flex: 1;
    }
    .activity-text {
      font-size: 13px;
      color: var(--text-primary);
    }
    .activity-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    @media (max-width: 1200px) {
      .job-scheduler-body {
        grid-template-columns: 1fr;
      }
      .job-scheduler-sidebar,
      .job-scheduler-timeline {
        display: none;
      }
    }
    @media (max-width: 768px) {
      .profile-panel {
        max-width: 100%;
      }
      .profile-info-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
<!-- Unified Navigation -->
<link rel="stylesheet" href="/css/unified-nav.css?v=20260129">
<link rel="stylesheet" href="/css/account/context-menu.css?v=20260119">
<link rel="stylesheet" href="/css/account/dashboard-modern.css?v=20260120">
<script defer src="/js/unified-nav.js?v=20260201d"></script>

</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f9cb00, #cca600); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: #1a1a2e; margin: 0 auto 16px;">SG</div>
      <h1 style="color: #f9cb00; font-size: 24px; font-weight: 700; margin: 0;">Surprise Granite</h1>
      <p style="color: rgba(255,255,255,0.75); font-size: 14px; margin: 4px 0 0;">Client Portal</p>
    </div>
    <div class="spinner"></div>
    <p style="color: rgba(255,255,255,0.75);">Loading your account...</p>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen" style="display: none;">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">SG</div>
        <h1 id="auth-title">Welcome Back</h1>
        <p id="auth-subtitle">Sign in to access your account</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showAuthTab('signup')">Create Account</button>
      </div>

      <div id="auth-message" class="auth-message"></div>

      <!-- Login Form -->
      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" required placeholder="you@example.com" autocomplete="email"/>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" required placeholder="Enter your password" autocomplete="current-password"/>
        </div>
        <button type="submit" class="auth-submit" id="login-btn">Sign In</button>

        <div class="auth-divider">
          <span>or continue with</span>
        </div>

        <button type="button" class="btn-google" onclick="handleGoogleLogin()">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>
      </form>

      <!-- Signup Form -->
      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <!-- Step 1: Account Type Selection -->
        <div class="signup-step" id="signup-step-1">
          <div class="step-header">
            <h3 class="step-title">Choose Your Account Type</h3>
            <p class="step-subtitle">Select the option that best describes you</p>
          </div>

          <div class="account-type-grid">
            <div class="account-type-card" data-type="homeowner" onclick="selectAccountType('homeowner')">
              <div class="type-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
              </div>
              <div class="type-name">Homeowner</div>
              <div class="type-desc">Shopping for countertops, tile, or flooring for your home</div>
              <ul class="type-features">
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Save favorite materials</li>
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Get free estimates</li>
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> List up to 3 remnants</li>
              </ul>
              <div class="type-badge free">Free</div>
            </div>

            <div class="account-type-card" data-type="pro_fabricator" onclick="selectAccountType('pro_fabricator')">
              <div class="type-icon pro">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                </svg>
              </div>
              <div class="type-name">Pro Fabricator</div>
              <div class="type-desc">Countertop fabricators, installers, and stone professionals</div>
              <ul class="type-features">
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> <strong>Unlimited</strong> remnant listings</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Pro verified badge</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Priority in marketplace</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Business profile page</li>
              </ul>
              <div class="type-badge pro">Pro</div>
            </div>

            <div class="account-type-card" data-type="pro_designer" onclick="selectAccountType('pro_designer')">
              <div class="type-icon pro">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402M6.75 21A3.75 3.75 0 013 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 003.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008z"/>
                </svg>
              </div>
              <div class="type-name">Designer / Architect</div>
              <div class="type-desc">Interior designers, architects, and design professionals</div>
              <ul class="type-features">
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Create client mood boards</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Trade pricing access</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Designer verified badge</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Project management tools</li>
              </ul>
              <div class="type-badge pro">Pro</div>
            </div>
          </div>

          <input type="hidden" id="signup-account-type" value="homeowner"/>
          <button type="button" class="auth-submit" id="continue-to-details" onclick="goToSignupStep(2)">Continue</button>
        </div>

        <!-- Step 2: Account Details -->
        <div class="signup-step" id="signup-step-2" style="display: none;">
          <div class="step-header">
            <button type="button" class="step-back" onclick="goToSignupStep(1)">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
              Back
            </button>
            <h3 class="step-title">Create Your Account</h3>
            <p class="step-subtitle" id="selected-type-label">Homeowner Account</p>
          </div>

          <div class="form-group">
            <label for="signup-name">Full Name</label>
            <input type="text" id="signup-name" required placeholder="John Smith" autocomplete="name"/>
          </div>
          <div class="form-group">
            <label for="signup-email">Email</label>
            <input type="email" id="signup-email" required placeholder="you@example.com" autocomplete="email"/>
          </div>
          <div class="form-group">
            <label for="signup-password">Password</label>
            <input type="password" id="signup-password" required minlength="6" placeholder="At least 6 characters" autocomplete="new-password"/>
          </div>
          <div class="form-group">
            <label for="signup-phone">Phone (Optional)</label>
            <input type="tel" id="signup-phone" placeholder="(555) 123-4567" autocomplete="tel"/>
          </div>

          <!-- Pro account fields -->
          <div id="pro-fields" style="display: none;">
            <div class="form-group">
              <label for="signup-business-name">Business Name</label>
              <input type="text" id="signup-business-name" placeholder="Your Company Name" autocomplete="organization"/>
            </div>
            <div class="form-group">
              <label for="signup-business-location">Business Location</label>
              <input type="text" id="signup-business-location" placeholder="City, State" autocomplete="address-level2"/>
            </div>
          </div>

          <div class="signup-terms">
            <label class="checkbox-label">
              <input type="checkbox" id="signup-terms" required/>
              <span>I agree to the <a href="/terms/" target="_blank">Terms of Service</a> and <a href="/privacy/" target="_blank">Privacy Policy</a></span>
            </label>
          </div>

          <button type="submit" class="auth-submit" id="signup-btn">Create Account</button>

          <div class="pro-note" id="pro-upgrade-note" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Pro accounts require verification. You'll receive an email to complete your business verification.</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-app" style="display: none;">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub"><span id="account-type-label">Account</span></div>
          </div>
        </a>
        <button class="sidebar-collapse-btn" onclick="toggleSidebarCollapse()" title="Collapse Sidebar">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
          </svg>
        </button>
      </div>

      <nav class="sidebar-nav">
        <!-- Home Section -->
        <div class="nav-section">
          <a class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="nav-item-text">Dashboard</span>
          </a>
        </div>

        <!-- My Account Section -->
        <div class="nav-section">
          <div class="nav-section-title">My Account</div>
          <a class="nav-item" data-page="profile" onclick="showPage('profile')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <span class="nav-item-text">Profile</span>
          </a>
          <a class="nav-item" data-page="favorites" onclick="showPage('favorites')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            <span class="nav-item-text">Favorites</span>
            <span class="nav-badge" id="favorites-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="my-designs" onclick="showPage('my-designs')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">My Designs</span>
            <span class="nav-badge" id="designs-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="listings" onclick="showPage('listings')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            <span class="nav-item-text">My Listings</span>
            <span class="nav-badge" id="listings-count" data-count="0">0</span>
          </a>
          <a class="nav-item" href="/cart/">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>
            <span class="nav-item-text">Shopping Cart</span>
            <span class="nav-badge" id="account-cart-count" data-count="0">0</span>
          </a>
        </div>

        <!-- Tools Section -->
        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <a class="nav-item" data-page="tools" onclick="showPage('tools')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
            <span class="nav-item-text">Design Tools</span>
          </a>
          <a class="nav-item" href="/tools/countertop-calculator/" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Calculator</span>
          </a>
          <a class="nav-item" href="/tools/room-designer/" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            <span class="nav-item-text">Room Designer</span>
          </a>
        </div>

        <!-- Sales Section (Admin/Contractor) -->
        <div class="nav-section hidden" id="sales-nav">
          <div class="nav-section-title">Sales</div>
          <a class="nav-item" data-page="leads" onclick="showPage('leads')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            <span class="nav-item-text">Leads</span>
            <span class="nav-badge" id="leads-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="customers" onclick="showPage('customers')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span class="nav-item-text">Customers</span>
            <span class="nav-badge" id="customers-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="estimates" onclick="showPage('estimates')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span class="nav-item-text">Estimates</span>
            <span class="nav-badge" id="estimates-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="invoices" onclick="showPage('invoices')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            <span class="nav-item-text">Invoices</span>
          </a>
        </div>

        <!-- Operations Section (Admin/Contractor) -->
        <div class="nav-section hidden" id="operations-nav">
          <div class="nav-section-title">Operations <span class="new-feature-badge">NEW</span></div>
          <a class="nav-item" data-page="projects" onclick="showPage('projects')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
            <span class="nav-item-text">Projects</span>
            <span class="new-feature-badge">NEW</span>
            <span class="nav-badge" id="projects-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="jobs" onclick="showPage('jobs')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Jobs</span>
            <span class="new-feature-badge">NEW</span>
            <span class="nav-badge" id="jobs-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="calendar" onclick="showPage('calendar')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Calendar</span>
            <span class="new-feature-badge">NEW</span>
          </a>
          <a class="nav-item" data-page="collaborators" onclick="showPage('collaborators')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            <span class="nav-item-text">Team</span>
            <span class="new-feature-badge">NEW</span>
          </a>
        </div>

        <!-- Finance Section (Admin Only) -->
        <div class="nav-section hidden" id="finance-nav">
          <div class="nav-section-title">Finance</div>
          <a class="nav-item" data-page="wallet" onclick="showPage('wallet')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
            <span class="nav-item-text">Wallet</span>
          </a>
        </div>

        <!-- Admin Section (Super Admin Only) -->
        <div class="nav-section hidden" id="admin-nav">
          <div class="nav-section-title">Admin</div>
          <a class="nav-item" data-page="admin-users" onclick="showPage('admin-users')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span class="nav-item-text">Manage Users</span>
          </a>
        </div>

        <!-- GOD MODE Section (GOD_MODE_EMAILS ONLY) -->
        <div class="nav-section hidden" id="god-mode-nav" style="display: none; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; margin: 8px; padding: 8px;">
          <div class="nav-section-title" style="color: #a855f7; font-weight: bold;">
            <span style="margin-right: 6px;"></span> GOD MODE
          </div>
          <a class="nav-item" data-page="god-mode" onclick="showPage('god-mode')" style="background: rgba(139, 92, 246, 0.1);">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            <span class="nav-item-text">Developer Tools</span>
          </a>
          <a class="nav-item" data-page="god-users" onclick="showPage('god-users')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span class="nav-item-text">All Users</span>
          </a>
          <a class="nav-item" data-page="god-marketplace" onclick="showPage('god-marketplace')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <span class="nav-item-text">Marketplace</span>
          </a>
          <a class="nav-item" data-page="god-database" onclick="showPage('god-database')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
            <span class="nav-item-text">Database</span>
          </a>
          <a class="nav-item" data-page="god-api" onclick="showPage('god-api')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">API Tester</span>
          </a>
          <a class="nav-item" data-page="god-logs" onclick="showPage('god-logs')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span class="nav-item-text">System Logs</span>
          </a>
          <a class="nav-item" data-page="god-designs" onclick="showPage('god-designs')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="nav-item-text">Designs</span>
          </a>
          <div style="height: 1px; background: rgba(139, 92, 246, 0.2); margin: 8px 0;"></div>
          <a class="nav-item" data-page="god-analytics" onclick="showPage('god-analytics')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
            <span class="nav-item-text">Analytics</span>
          </a>
          <a class="nav-item" data-page="god-site" onclick="showPage('god-site')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
            <span class="nav-item-text">Site Manager</span>
          </a>
          <a class="nav-item" data-page="god-config" onclick="showPage('god-config')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <span class="nav-item-text">Config</span>
          </a>
        </div>

        <!-- Store Section (Vendor) -->
        <div class="nav-section hidden" id="vendor-nav">
          <div class="nav-section-title">Store</div>
          <a class="nav-item" data-page="products" onclick="showPage('products')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <span class="nav-item-text">Products</span>
          </a>
          <a class="nav-item" data-page="orders" onclick="showPage('orders')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
            <span class="nav-item-text">Orders</span>
          </a>
          <a class="nav-item" data-page="messages" onclick="showPage('messages')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            <span class="nav-item-text">Messages</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-menu">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">User</div>
            <div class="user-role" id="user-role">Member</div>
          </div>
          <button class="logout-btn" onclick="handleLogout()" title="Sign Out">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Quick Actions Toolbar (Left Side) -->
    <div class="page-toolbar" id="page-toolbar">
      <div class="toolbar-section">
        <button class="toolbar-btn" onclick="openAddLeadModal()" title="Add Lead">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
        </button>
        <button class="toolbar-btn" onclick="openNewProjectModal()" title="New Project">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        </button>
        <button class="toolbar-btn" onclick="openCalendarEventModal()" title="Add Event">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        </button>
        <button class="toolbar-btn" onclick="openInvoiceModal()" title="Create Invoice">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/></svg>
        </button>
      </div>
      <div class="toolbar-divider"></div>
      <div class="toolbar-section">
        <button class="toolbar-btn" data-page="leads" onclick="showPage('leads')" title="View Leads">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
        </button>
        <button class="toolbar-btn" data-page="projects" onclick="showPage('projects')" title="View Projects">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
        </button>
        <button class="toolbar-btn" data-page="calendar" onclick="showPage('calendar')" title="View Calendar">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        </button>
        <button class="toolbar-btn" data-page="finance" onclick="showPage('finance')" title="View Finance">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </button>
      </div>
      <div style="flex: 1;"></div>
      <div class="toolbar-section">
        <button class="toolbar-btn" onclick="showKeyboardShortcuts()" title="Keyboard Shortcuts (?)">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
      <div class="topbar">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <h1 class="topbar-title" id="page-title">Dashboard</h1>
        <div class="topbar-actions">
          <!-- Role Switcher (for demo/testing - remove in production) -->
          <div id="role-switcher" style="margin-right: 12px;">
            <select id="role-select" onchange="switchRole(this.value)" style="padding: 8px 12px; border-radius: 6px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 13px; cursor: pointer;" aria-label="Switch user role">
              <option value="homeowner">Homeowner View</option>
              <option value="customer">Customer View</option>
              <option value="pro">Pro View</option>
              <option value="contractor">Contractor View</option>
              <option value="fabricator">Fabricator View</option>
              <option value="vendor">Vendor View</option>
              <option value="distributor">Distributor/Stone Yard View</option>
              <option value="admin">Admin View (GOD)</option>
            </select>
          </div>
          <!-- Notification Bell -->
          <div class="notification-bell-wrapper" style="position: relative; margin-right: 8px;">
            <button class="btn-modern ghost" onclick="toggleNotificationPanel()" title="Notifications" style="position: relative; padding: 8px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
              </svg>
              <span id="notification-badge" class="notification-badge" style="display: none; position: absolute; top: 2px; right: 2px; background: #ef4444; color: white; font-size: 10px; font-weight: 600; min-width: 16px; height: 16px; border-radius: 8px; align-items: center; justify-content: center;">0</span>
            </button>
            <!-- Notification Dropdown Panel -->
            <div id="notification-panel" class="notification-panel" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; width: 360px; max-height: 480px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden;">
              <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Notifications</h3>
                <div style="display: flex; gap: 12px; align-items: center;">
                  <button onclick="sendDailyDigest()" style="background: none; border: none; color: var(--text-muted); font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="Send daily summary to your email">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Digest
                  </button>
                  <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: var(--accent); font-size: 13px; cursor: pointer;">Mark all read</button>
                </div>
              </div>
              <div id="notification-list" style="max-height: 380px; overflow-y: auto;">
                <div class="empty-state" style="padding: 40px 20px; text-align: center;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                  </svg>
                  <p style="color: var(--text-muted); margin: 0;">No new notifications</p>
                </div>
              </div>
            </div>
          </div>
          <button class="btn-modern primary" onclick="openAddLeadModal()" title="Add New Lead">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            <span class="btn-text">Add New Lead</span>
          </button>
        </div>
      </div>

      <div class="content-area">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page-section active">
          <div class="stats-grid" id="dashboard-stats">
            <!-- Filled by JS based on role -->
          </div>

          <div id="vendor-onboarding-banner" style="display: none;"></div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="quick-actions" id="quick-actions">
                <!-- Filled by JS based on role -->
              </div>
            </div>
          </div>

          <!-- Needs Attention Widget (Admin only) -->
          <div class="card" id="needs-attention-card" style="display: none;">
            <div class="card-header">
              <h3 class="card-title">Needs Attention</h3>
              <button class="btn-modern ghost" onclick="refreshNeedsAttention()" style="padding: 6px 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
              </button>
            </div>
            <div class="card-body" id="needs-attention-content">
              <div style="text-align: center; padding: 20px; color: var(--text-muted);">
                <div class="spinner" style="margin: 0 auto 12px;"></div>
                Loading...
              </div>
            </div>
          </div>

          <!-- Field Status Widget (Admin only) - Shows en route and on site projects -->
          <div class="card" id="field-status-card" style="display: none;">
            <div class="card-header">
              <h3 class="card-title" style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="#f59e0b" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Field Status
              </h3>
              <button class="btn-modern ghost" onclick="refreshFieldStatus()" style="padding: 6px 12px; font-size: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
            </div>
            <div class="card-body" id="field-status-content" style="padding: 0;">
              <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading field status...</div>
            </div>
          </div>

          <!-- Today's Schedule Widget (Admin only) -->
          <div class="card" id="today-schedule-card" style="display: none;">
            <div class="card-header">
              <h3 class="card-title">Today's Schedule</h3>
              <button class="btn-modern primary" onclick="showPage('calendar'); setTimeout(() => openCalendarEventModal(), 200);" style="padding: 6px 12px; font-size: 12px;">
                + Add Event
              </button>
            </div>
            <div class="card-body" id="today-schedule-content">
              <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>
            </div>
          </div>
        </section>

        <!-- Profile Page -->
        <section id="page-profile" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Profile Information</h3>
              <button class="btn-modern primary" onclick="saveProfile()">Save Changes</button>
            </div>
            <div class="card-body">
              <form id="profile-form">
                <div class="form-row">
                  <div class="form-group">
                    <label for="profile-name">Full Name</label>
                    <input type="text" id="profile-name" placeholder="Your name" autocomplete="name"/>
                  </div>
                  <div class="form-group">
                    <label for="profile-email">Email</label>
                    <input type="email" id="profile-email" readonly style="opacity: 0.6;" autocomplete="email"/>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label for="profile-phone">Phone</label>
                    <input type="tel" id="profile-phone" placeholder="(555) 123-4567" autocomplete="tel"/>
                  </div>
                  <div class="form-group">
                    <label for="profile-company">Company (Optional)</label>
                    <input type="text" id="profile-company" placeholder="Your company" autocomplete="organization"/>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- Favorites Page -->
        <section id="page-favorites" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Your Favorites</h3>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn-modern secondary" onclick="clearAllFavoritesConfirm()" id="clear-all-btn" style="display: none; color: #f87171; border-color: rgba(248,113,113,0.3);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  Clear All
                </button>
                <button class="btn-modern primary" onclick="requestQuoteForFavorites()" id="request-quote-btn" style="display: none;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Request Quote
                </button>
              </div>
            </div>
            <div class="card-body">
              <p style="color: #666; margin-bottom: 20px;">Browse materials on your phone and swipe right to save your favorites. They'll appear here!</p>

              <div id="favorites-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your favorites...</p>
              </div>

              <div id="favorites-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <h3 style="color: #666; margin: 16px 0 8px;">No Favorites Yet</h3>
                <p style="color: #999; margin-bottom: 20px;">Browse our collections on your phone and swipe right to save your favorites!</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                  <a href="/materials/flooring/" class="btn-modern primary">Browse Flooring</a>
                  <a href="/marketplace/slabs//" class="btn-modern secondary">Browse Countertops</a>
                </div>
              </div>

              <!-- Countertops Section -->
              <div id="favorites-countertops" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
                  Countertops
                  <span id="countertops-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-countertops-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Flooring Section -->
              <div id="favorites-flooring" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                  Flooring
                  <span id="flooring-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-flooring-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Tile Section -->
              <div id="favorites-tile" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><path d="M3 3h7v7H3z M14 3h7v7h-7z M3 14h7v7H3z M14 14h7v7h-7z"/></svg>
                  Tile
                  <span id="tile-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-tile-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Shop Section -->
              <div id="favorites-shop" style="display: none;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                  Shop Products
                  <span id="shop-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-shop-grid" class="saved-floors-grid"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- My Designs Page (Room Designer) -->
        <section id="page-my-designs" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Designs</h3>
              <div style="display: flex; gap: 12px; align-items: center;">
                <select id="designs-filter" onchange="filterDesigns()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary);">
                  <option value="all">All Designs</option>
                  <option value="shared">Shared</option>
                  <option value="private">Private</option>
                  <option value="with-messages">With Messages</option>
                </select>
                <button class="btn-modern secondary" onclick="openInviteToProjectModal(null, '', 'designer')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  Invite Collaborator
                </button>
                <a href="/tools/room-designer/" class="btn-modern primary">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Design
                </a>
              </div>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">
                Create kitchen and bathroom layouts with the Room Designer. Your saved designs appear here.
              </p>

              <div id="designs-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your designs...</p>
              </div>

              <div id="designs-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <h3 style="color: #666; margin: 16px 0 8px;">No Designs Yet</h3>
                <p style="color: #999; margin-bottom: 20px;">Create your first kitchen or bathroom design with our Room Designer tool!</p>
                <a href="/tools/room-designer/" class="btn-modern primary">Open Room Designer</a>
              </div>

              <div id="designs-grid" class="designs-grid" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- My Listings Page (Remnants Marketplace) -->
        <section id="page-listings" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Listings</h3>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span id="listing-limit-indicator" style="font-size: 13px; color: var(--text-muted);"></span>
                <button class="btn-modern primary" onclick="openCreateListingModal()" id="create-listing-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Listing
                </button>
              </div>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">
                List your stone remnants here. Other users can find and contact you about materials you have available.
                <a href="/remnants/" style="color: var(--gold-primary);">Browse the marketplace </a>
              </p>

              <div id="listings-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your listings...</p>
              </div>

              <div id="listings-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <h3 style="color: var(--text-secondary); margin: 16px 0 8px;">No Listings Yet</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Have materials to sell? List countertops, tile, flooring, cabinets, or supplies!</p>
                <button class="btn-modern primary" onclick="openCreateListingModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Your First Listing
                </button>
              </div>

              <div id="listings-grid" class="listings-grid" style="display: none;"></div>
            </div>
          </div>

          <!-- Inquiries Section -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Incoming Inquiries</h3>
              <span class="nav-badge" id="inquiries-badge" style="display: none;">0</span>
            </div>
            <div class="card-body">
              <div id="inquiries-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading inquiries...</p>
              </div>
              <div id="inquiries-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                <h3 style="color: var(--text-secondary); margin: 16px 0 8px;">No Inquiries Yet</h3>
                <p style="color: var(--text-muted); margin-bottom: 0;">When someone contacts you about a listing, it will appear here.</p>
              </div>
              <div id="inquiries-list" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- Collaborations Page -->
        <section id="page-collaborations" class="page-section">
          <!-- Collaboration Tabs -->
          <div class="collab-tabs" style="display: flex; gap: 8px; margin-bottom: 20px;">
            <button class="collab-tab active" onclick="switchCollabTab('collaborations')" id="tab-collaborations" style="padding: 10px 20px; border: none; background: var(--gold-primary); color: #1a1a2e; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
              Project Collaborations
            </button>
            <button class="collab-tab" onclick="switchCollabTab('network')" id="tab-network" style="padding: 10px 20px; border: 1px solid var(--border-subtle); background: var(--dark-surface); color: var(--text-secondary); border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
              My Network <span id="network-count-badge" style="display: none; margin-left: 6px; background: var(--gold-primary); color: #1a1a2e; padding: 2px 8px; border-radius: 10px; font-size: 11px;"></span>
            </button>
            <button class="collab-tab" onclick="switchCollabTab('invitations')" id="tab-invitations" style="padding: 10px 20px; border: 1px solid var(--border-subtle); background: var(--dark-surface); color: var(--text-secondary); border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
              Pending Invites <span id="invitations-count-badge" style="display: none; margin-left: 6px; background: var(--warning); color: #1a1a2e; padding: 2px 8px; border-radius: 10px; font-size: 11px;"></span>
            </button>
          </div>

          <!-- Project Collaborations Tab -->
          <div id="collab-tab-collaborations" class="collab-tab-content">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">My Collaborations</h3>
                <button class="btn-modern primary" onclick="openInviteToProjectModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  Invite to Project
                </button>
              </div>
              <div class="card-body">
                <div id="collaborations-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <h3>No collaborations yet</h3>
                    <p>When you're invited to collaborate on projects, they'll appear here.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- My Network Tab (General Collaborators) -->
          <div id="collab-tab-network" class="collab-tab-content" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">My Network</h3>
                <button class="btn-modern primary" onclick="openInviteToNetworkModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  Invite to Network
                </button>
              </div>
              <div class="card-body">
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                  Build your professional network. Invite designers, fabricators, collaborators, and partners - they can later be assigned to specific projects.
                </p>
                <div id="network-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                    <h3>No network contacts yet</h3>
                    <p>Invite colleagues, vendors, and partners to build your professional network.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pending Invitations Tab -->
          <div id="collab-tab-invitations" class="collab-tab-content" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Pending Invitations</h3>
              </div>
              <div class="card-body">
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                  Invitations you've received to join projects or networks.
                </p>
                <div id="received-invitations-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    <h3>No pending invitations</h3>
                    <p>When someone invites you to collaborate, it will appear here.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Design Tools Page -->
        <section id="page-tools" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Design Tools</h3>
              <p style="color: var(--text-muted); font-size: 14px; margin: 0;">Professional design tools for your projects</p>
            </div>
            <div class="card-body">
              <div class="tools-grid">
                <!-- Room Designer Pro -->
                <a href="/tools/room-designer/" class="tool-card featured">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Room Designer Pro</h4>
                    <p>2D/3D kitchen & bath design with instant quotes</p>
                    <span class="tool-badge featured">Featured</span>
                  </div>
                </a>

                <!-- Visualizer -->
                <a href="/tools/visualizer/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Stone Visualizer</h4>
                    <p>See how materials look in your space</p>
                  </div>
                </a>

                <!-- Blueprint Takeoff -->
                <a href="/tools/blueprint-takeoff/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Blueprint Takeoff</h4>
                    <p>Extract measurements from blueprints</p>
                  </div>
                </a>

                <!-- Virtual Kitchen -->
                <a href="/tools/virtual-kitchen-design-tool/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Virtual Kitchen</h4>
                    <p>Design your kitchen with drag & drop</p>
                  </div>
                </a>

                <!-- Virtual Bathroom -->
                <a href="/tools/virtual-bathroom-design-tool/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Virtual Bathroom</h4>
                    <p>Design your bathroom space</p>
                  </div>
                </a>

                <!-- Multi-Surface Visualizer -->
                <a href="/tools/multi-surface-room-visualizer/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Multi-Surface Visualizer</h4>
                    <p>Visualize counters, floors, and backsplash</p>
                  </div>
                </a>

                <!-- Edge Profile Visualizer -->
                <a href="/tools/countertop-edge-visualizer/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Edge Profile Visualizer</h4>
                    <p>Compare countertop edge profiles</p>
                  </div>
                </a>

                <!-- Interior Gallery -->
                <a href="/tools/interior-design-gallery/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Design Gallery</h4>
                    <p>Browse interior design inspiration</p>
                  </div>
                </a>
              </div>

              <!-- Calculators Section -->
              <div style="margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">Calculators</h3>
                <div class="tools-grid calculators-grid">
                  <a href="/tools/countertop-calculator/" class="tool-card calculator" target="_blank">
                    <div class="tool-icon small">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                      </svg>
                    </div>
                    <div class="tool-info">
                      <h4>Countertop Calculator</h4>
                      <p>Calculate material needs</p>
                    </div>
                  </a>
                  <a href="/tools/tile-calculator/" class="tool-card calculator" target="_blank">
                    <div class="tool-icon small">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                      </svg>
                    </div>
                    <div class="tool-info">
                      <h4>Tile Calculator</h4>
                      <p>Plan your tile project</p>
                    </div>
                  </a>
                  <a href="/tools/flooring-calculator/" class="tool-card calculator" target="_blank">
                    <div class="tool-icon small">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                      </svg>
                    </div>
                    <div class="tool-info">
                      <h4>Flooring Calculator</h4>
                      <p>Estimate flooring needs</p>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Leads Page (Admin Only) -->
        <section id="page-leads" class="page-section">
          <div class="table-container">
            <div class="table-header" style="flex-direction: column; align-items: stretch; gap: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h2 class="table-title">All Leads</h2>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <!-- View Toggle Buttons -->
                  <div class="view-toggle" style="display: flex; background: var(--dark-surface); border-radius: 8px; padding: 4px; gap: 2px;">
                    <button onclick="setLeadsView('grid')" id="leads-view-grid" class="view-btn active" title="Grid View" style="padding: 8px 12px; border: none; background: var(--gold-primary); color: var(--dark-primary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/></svg>
                      Grid
                    </button>
                    <button onclick="setLeadsView('list')" id="leads-view-list" class="view-btn" title="List View" style="padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                      List
                    </button>
                    <button onclick="setLeadsView('kanban')" id="leads-view-kanban" class="view-btn" title="Kanban View" style="padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
                      Kanban
                    </button>
                  </div>
                  <div class="search-bar-modern" style="margin: 0; max-width: 300px; flex: 1;">
                    <span class="search-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </span>
                    <input type="text" id="leads-search" placeholder="Search leads..." class="input-modern" aria-label="Search leads">
                  </div>
                </div>
              </div>
              <div class="filter-pills">
                <button class="filter-pill active" data-status="all">All</button>
                <button class="filter-pill" data-status="new">New</button>
                <button class="filter-pill" data-status="contacted">Contacted</button>
                <button class="filter-pill" data-status="qualified">Qualified</button>
                <button class="filter-pill" data-status="quoted">Quoted</button>
                <button class="filter-pill" data-status="won">Won</button>
                <button class="filter-pill" data-status="lost">Lost</button>
                <button class="filter-pill" data-status="archived" style="margin-left: 8px; border-left: 1px solid var(--border-subtle); padding-left: 16px;">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/></svg>
                  Archived
                </button>
              </div>
            </div>
            <div id="leads-table">
              <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading leads...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Customers Page - Unified Customer Management -->
        <section id="page-customers" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 class="page-title">Customer Management</h1>
              <p class="page-subtitle">Unified view of all customers across sources</p>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="btn-modern secondary" onclick="openCustomerImportModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Import CSV
              </button>
              <button class="btn-modern secondary" onclick="exportCustomersCSV()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
              </button>
              <button class="btn-modern primary" onclick="openAddCustomerModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 4v16m8-8H4"/>
                </svg>
                Add Customer
              </button>
            </div>
          </div>

          <!-- Customer Stats by Source -->
          <div class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 24px; margin-bottom: 24px;">
            <div class="stat-card-mini" style="cursor: pointer;" onclick="filterCustomers('all')">
              <div class="stat-card-value" id="stat-total-customers">-</div>
              <div class="stat-card-label">Total Customers</div>
            </div>
            <div class="stat-card-mini" style="cursor: pointer;" onclick="filterCustomers('subscribers')">
              <div class="stat-card-value" id="stat-subscribers" style="color: var(--gold-primary);">-</div>
              <div class="stat-card-label">Account Subscribers</div>
            </div>
            <div class="stat-card-mini" style="cursor: pointer;" onclick="filterCustomers('shopify')">
              <div class="stat-card-value" id="stat-shopify-customers" style="color: var(--info);">-</div>
              <div class="stat-card-label">Shopify Customers</div>
            </div>
            <div class="stat-card-mini" style="cursor: pointer;" onclick="filterCustomers('imported')">
              <div class="stat-card-value" id="stat-imported-customers" style="color: var(--success);">-</div>
              <div class="stat-card-label">Imported Clients</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-customer-revenue" style="color: var(--gold-primary);">-</div>
              <div class="stat-card-label">Total Revenue</div>
            </div>
          </div>

          <!-- Search & Filters -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; position: relative;">
              <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input type="text" id="customers-search" placeholder="Search by name, email, phone..."
                style="width: 100%; padding: 12px 12px 12px 40px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                aria-label="Search customers">
            </div>
            <select id="customers-source-filter" onchange="filterCustomers(this.value)"
              style="padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 150px;"
              aria-label="Filter by source">
              <option value="all">All Sources</option>
              <option value="subscribers">Account Subscribers</option>
              <option value="shopify">Shopify Customers</option>
              <option value="imported">Imported Clients</option>
              <option value="manual">Manually Added</option>
            </select>
            <select id="customers-sort" onchange="sortCustomers(this.value)"
              style="padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 150px;"
              aria-label="Sort customers">
              <option value="recent">Most Recent</option>
              <option value="name">Name A-Z</option>
              <option value="spent">Highest Spent</option>
              <option value="orders">Most Orders</option>
            </select>
          </div>

          <!-- Quick Filters -->
          <div class="filter-pills" style="margin-bottom: 20px;">
            <button class="filter-pill active" data-customer-filter="all" onclick="filterCustomers('all')">All <span id="count-all-customers" style="opacity: 0.7; margin-left: 4px;">0</span></button>
            <button class="filter-pill" data-customer-filter="active" onclick="filterCustomers('active')">Has Orders <span id="count-active-customers" style="opacity: 0.7; margin-left: 4px;">0</span></button>
            <button class="filter-pill" data-customer-filter="recent" onclick="filterCustomers('recent')">Recent 30 Days <span id="count-recent-customers" style="opacity: 0.7; margin-left: 4px;">0</span></button>
            <button class="filter-pill" data-customer-filter="vip" onclick="filterCustomers('vip')">VIP ($1000+) <span id="count-vip-customers" style="opacity: 0.7; margin-left: 4px;">0</span></button>
          </div>

          <!-- Loading State -->
          <div id="customers-loading" class="loading-state">
            <div class="spinner"></div>
            <p>Loading customers...</p>
          </div>

          <!-- Empty State -->
          <div id="customers-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
            </div>
            <h3>No Customers Yet</h3>
            <p>Import your existing clients or add new ones to get started.</p>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
              <button class="btn-modern secondary" onclick="openCustomerImportModal()">Import CSV</button>
              <button class="btn-modern primary" onclick="openAddCustomerModal()">Add Customer</button>
            </div>
          </div>

          <!-- Customers Table -->
          <div id="customers-table" style="display: none;"></div>

          <!-- Pagination -->
          <div id="customers-pagination" style="display: none; justify-content: space-between; align-items: center; margin-top: 20px; padding: 16px; background: var(--dark-elevated); border-radius: 12px;">
            <div id="customers-page-info" style="color: var(--text-muted); font-size: 14px;">Showing 1-50 of 0</div>
            <div style="display: flex; gap: 8px;">
              <button id="customers-prev-btn" onclick="customersPagePrev()" class="btn-modern secondary" style="padding: 8px 16px;" disabled>Previous</button>
              <button id="customers-next-btn" onclick="customersPageNext()" class="btn-modern secondary" style="padding: 8px 16px;">Next</button>
            </div>
          </div>

          <!-- Powered by Remodely -->
          <div style="text-align: center; margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
            <span style="font-size: 12px; color: var(--text-muted);">Powered by</span>
            <span style="font-size: 14px; font-weight: 700; color: var(--gold-primary); margin-left: 6px;">Remodely</span>
          </div>
        </section>

        <!-- Estimates Page -->
        <section id="page-estimates" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Estimates</h3>
              <div style="display: flex; gap: 12px;">
                <button class="btn-modern secondary" onclick="openBusinessSettings()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Settings
                </button>
                <button class="btn-modern secondary" onclick="openServiceCatalog()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  Service Catalog
                </button>
                <button class="btn-modern secondary" onclick="openInviteToProjectModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  Invite Collaborator
                </button>
                <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Estimate
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Stats Row - Modern -->
              <div class="stat-grid">
                <div class="stat-card gold" onclick="filterEstimates('draft')">
                  <div class="stat-value" id="stat-draft-estimates">0</div>
                  <div class="stat-label">Draft</div>
                </div>
                <div class="stat-card" onclick="filterEstimates('sent')" style="--accent: #3b82f6;">
                  <div class="stat-value" style="color: #3b82f6;" id="stat-sent-estimates">0</div>
                  <div class="stat-label">Sent</div>
                </div>
                <div class="stat-card success" onclick="filterEstimates('approved')">
                  <div class="stat-value" id="stat-approved-estimates">0</div>
                  <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card error" onclick="filterEstimates('rejected')">
                  <div class="stat-value" id="stat-rejected-estimates">0</div>
                  <div class="stat-label">Rejected</div>
                </div>
              </div>

              <!-- Filters - Modern Pills -->
              <div class="filter-pills">
                <button class="filter-pill active" data-estimate-status="all" onclick="filterEstimates('all')">All</button>
                <button class="filter-pill" data-estimate-status="draft" onclick="filterEstimates('draft')">Draft</button>
                <button class="filter-pill" data-estimate-status="sent" onclick="filterEstimates('sent')">Sent</button>
                <button class="filter-pill" data-estimate-status="approved" onclick="filterEstimates('approved')">Approved</button>
                <button class="filter-pill" data-estimate-status="rejected" onclick="filterEstimates('rejected')">Rejected</button>
                <button class="filter-pill" data-estimate-status="archived" onclick="filterEstimates('archived')">Archived</button>
              </div>

              <!-- Estimates List -->
              <div id="estimates-list">
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                  <h3 style="margin-bottom: 8px;">No estimates yet</h3>
                  <p style="color: var(--text-muted); margin-bottom: 16px;">Create your first estimate to send to customers</p>
                  <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    Create First Estimate
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Invoices Page (Admin Only) -->
        <section id="page-invoices" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Invoices</h3>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn-modern secondary" onclick="syncFromStripe()" id="sync-stripe-btn" title="Import paid invoices and customers from Stripe">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  Sync from Stripe
                </button>
                <button class="btn-modern secondary" onclick="openTemplatePreview()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                  Email Templates
                </button>
                <button class="btn-modern secondary" onclick="openInviteToProjectModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  Invite Collaborator
                </button>
                <button class="btn-modern secondary" onclick="openQuickPayModal()" style="background: linear-gradient(135deg, #8b5cf6, #6366f1); border: none;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg>
                  Quick Pay
                </button>
                <button class="btn-modern primary" onclick="openInvoiceModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Invoice
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-invoice-status="all" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn" data-invoice-status="draft" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn" data-invoice-status="open" onclick="filterInvoices('open')">Open</button>
                <button class="filter-btn" data-invoice-status="viewed" onclick="filterInvoices('viewed')">Viewed</button>
                <button class="filter-btn" data-invoice-status="paid" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn" data-invoice-status="void" onclick="filterInvoices('void')">Voided</button>
              </div>
              <div id="invoices-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Jobs Page - Enhanced with Job Costing & Kanban -->
        <section id="page-jobs" class="page-section">
          <!-- Stats Row - Enhanced Modern Design -->
          <div class="stats-dashboard">
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper blue">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-active-jobs">0</div>
              <div class="stat-label-enhanced">Active Jobs</div>
            </div>
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper green">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-jobs-revenue">$0</div>
              <div class="stat-label-enhanced">Total Revenue</div>
            </div>
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper red">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-total-costs">$0</div>
              <div class="stat-label-enhanced">Total Costs</div>
            </div>
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper gold">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-net-profit">$0</div>
              <div class="stat-label-enhanced">Net Profit</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
              <h3 class="card-title">Jobs & Projects</h3>
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <!-- View Toggle -->
                <div class="view-toggle" style="display: flex; background: var(--dark-elevated); border-radius: 8px; padding: 4px;">
                  <button class="view-btn active" onclick="setJobsView('list')" id="jobsListBtn" style="padding: 8px 12px; border: none; background: var(--gold-primary); color: var(--dark-primary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    List
                  </button>
                  <button class="view-btn" onclick="setJobsView('kanban')" id="jobsKanbanBtn" style="padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Board
                  </button>
                </div>
                <button class="btn-modern secondary" onclick="openCustomersModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Customers
                </button>
                <button class="btn-modern primary" onclick="openNewJobModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Job
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Filters - Modern Pills -->
              <div class="filter-pills">
                <button class="filter-pill active" data-job-status="all" onclick="filterJobs('all')">All</button>
                <button class="filter-pill" data-job-status="new" onclick="filterJobs('new')">New</button>
                <button class="filter-pill" data-job-status="approved" onclick="filterJobs('approved')">Approved</button>
                <button class="filter-pill" data-job-status="scheduled" onclick="filterJobs('scheduled')">Scheduled</button>
                <button class="filter-pill" data-job-status="in_progress" onclick="filterJobs('in_progress')">In Progress</button>
                <button class="filter-pill" data-job-status="completed" onclick="filterJobs('completed')">Completed</button>
              </div>

              <!-- List View -->
              <div id="jobs-list-view">
                <div id="jobs-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    <h3>No jobs yet</h3>
                    <p>Jobs are created when estimates are approved, or create one manually.</p>
                    <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewJobModal()">Create First Job</button>
                  </div>
                </div>
              </div>

              <!-- Kanban Board View (Hidden by default) -->
              <div id="jobs-kanban-view" style="display: none;">
                <div class="kanban-board" style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 400px;">
                  <div class="kanban-column" data-status="lead" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f59e0b;">
                      <span style="font-weight: 600; color: #f59e0b;">Leads</span>
                      <span class="column-count" id="kanban-count-lead" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-lead" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="approved" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #3b82f6;">
                      <span style="font-weight: 600; color: #3b82f6;">Approved</span>
                      <span class="column-count" id="kanban-count-approved" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-approved" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="scheduled" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #8b5cf6;">
                      <span style="font-weight: 600; color: #8b5cf6;">Scheduled</span>
                      <span class="column-count" id="kanban-count-scheduled" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-scheduled" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="in_progress" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #06b6d4;">
                      <span style="font-weight: 600; color: #06b6d4;">In Progress</span>
                      <span class="column-count" id="kanban-count-in_progress" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-in_progress" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="completed" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #22c55e;">
                      <span style="font-weight: 600; color: #22c55e;">Completed</span>
                      <span class="column-count" id="kanban-count-completed" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-completed" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Projects Page -->
        <section id="page-projects" class="page-section">
          <!-- Stats Row - Enhanced -->
          <div class="stats-dashboard">
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper blue">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-total-projects">0</div>
              <div class="stat-label-enhanced">Total Projects</div>
            </div>
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper purple">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-active-projects">0</div>
              <div class="stat-label-enhanced">In Progress</div>
            </div>
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper green">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-completed-projects">0</div>
              <div class="stat-label-enhanced">Completed</div>
            </div>
            <div class="stat-card-enhanced">
              <div class="stat-header">
                <div class="stat-icon-wrapper gold">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                </div>
              </div>
              <div class="stat-value-large" id="stat-pipeline-value">$0</div>
              <div class="stat-label-enhanced">Pipeline Value</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
              <h3 class="card-title">Projects</h3>
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="projects-search" placeholder="Search projects..." oninput="debounceProjectSearch()" style="padding: 8px 14px; border-radius: 8px; border: 1px solid var(--dark-border); background: var(--dark-elevated); color: var(--text-primary); font-size: 13px; width: 200px;" />
                <div class="view-toggle" style="display: flex; background: var(--dark-elevated); border-radius: 8px; padding: 4px;">
                  <button class="view-btn active" onclick="setProjectsView('list')" id="projectsListBtn" style="padding: 8px 12px; border: none; background: var(--gold-primary); color: var(--dark-primary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    List
                  </button>
                  <button class="view-btn" onclick="setProjectsView('board')" id="projectsBoardBtn" style="padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Board
                  </button>
                </div>
                <button class="btn-modern primary" onclick="openNewProjectModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Project
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Filter Pills -->
              <div class="filter-pills">
                <button class="filter-pill active" data-proj-status="all" onclick="filterProjects('all')">All</button>
                <button class="filter-pill" data-proj-status="lead" onclick="filterProjects('lead')">Lead</button>
                <button class="filter-pill" data-proj-status="approved" onclick="filterProjects('approved')">Approved</button>
                <button class="filter-pill" data-proj-status="scheduled" onclick="filterProjects('scheduled')">Scheduled</button>
                <button class="filter-pill" data-proj-status="in_progress" onclick="filterProjects('in_progress')">In Progress</button>
                <button class="filter-pill" data-proj-status="completed" onclick="filterProjects('completed')">Completed</button>
                <button class="filter-pill" data-proj-status="on_hold" onclick="filterProjects('on_hold')">On Hold</button>
              </div>

              <!-- List View -->
              <div id="projects-list-view">
                <div id="projects-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                    <h3>No projects yet</h3>
                    <p>Create your first project to start tracking work, collaborators, and revenue.</p>
                    <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewProjectModal()">Create First Project</button>
                  </div>
                </div>
              </div>

              <!-- Kanban Board View (Hidden by default) -->
              <div id="projects-board-view" style="display: none;">
                <div class="kanban-board" style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 400px;">
                  <div class="kanban-column" data-status="lead" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;" ondragover="onProjectDragOver(event)" ondragleave="onProjectDragLeave(event)" ondrop="onProjectDrop(event, 'lead')">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f59e0b;">
                      <span style="font-weight: 600; color: #f59e0b;">Lead</span>
                      <span id="proj-kanban-count-lead" style="background: rgba(245,158,11,0.2); color: #f59e0b; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="proj-kanban-cards-lead" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="approved" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;" ondragover="onProjectDragOver(event)" ondragleave="onProjectDragLeave(event)" ondrop="onProjectDrop(event, 'approved')">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #3b82f6;">
                      <span style="font-weight: 600; color: #3b82f6;">Approved</span>
                      <span id="proj-kanban-count-approved" style="background: rgba(59,130,246,0.2); color: #3b82f6; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="proj-kanban-cards-approved" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="scheduled" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;" ondragover="onProjectDragOver(event)" ondragleave="onProjectDragLeave(event)" ondrop="onProjectDrop(event, 'scheduled')">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #8b5cf6;">
                      <span style="font-weight: 600; color: #8b5cf6;">Scheduled</span>
                      <span id="proj-kanban-count-scheduled" style="background: rgba(139,92,246,0.2); color: #8b5cf6; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="proj-kanban-cards-scheduled" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="in_progress" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;" ondragover="onProjectDragOver(event)" ondragleave="onProjectDragLeave(event)" ondrop="onProjectDrop(event, 'in_progress')">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #06b6d4;">
                      <span style="font-weight: 600; color: #06b6d4;">In Progress</span>
                      <span id="proj-kanban-count-in_progress" style="background: rgba(6,182,212,0.2); color: #06b6d4; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="proj-kanban-cards-in_progress" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="completed" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;" ondragover="onProjectDragOver(event)" ondragleave="onProjectDragLeave(event)" ondrop="onProjectDrop(event, 'completed')">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #22c55e;">
                      <span style="font-weight: 600; color: #22c55e;">Completed</span>
                      <span id="proj-kanban-count-completed" style="background: rgba(34,197,94,0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="proj-kanban-cards-completed" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="on_hold" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;" ondragover="onProjectDragOver(event)" ondragleave="onProjectDragLeave(event)" ondrop="onProjectDrop(event, 'on_hold')">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #ef4444;">
                      <span style="font-weight: 600; color: #ef4444;">On Hold</span>
                      <span id="proj-kanban-count-on_hold" style="background: rgba(239,68,68,0.2); color: #ef4444; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div id="proj-kanban-cards-on_hold" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Collaborators Page -->
        <section id="page-collaborators" class="page-section">
          <!-- Team Tabs -->
          <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <button class="filter-btn active" id="team-tab-my-team" onclick="switchTeamTab('my-team')" style="padding: 10px 20px; border-radius: 8px; font-weight: 600;">
              My Team
            </button>
            <button class="filter-btn" id="team-tab-invitations" onclick="switchTeamTab('invitations')" style="padding: 10px 20px; border-radius: 8px; font-weight: 500;">
              Invitations <span id="team-invites-badge" style="display: none; margin-left: 6px; background: var(--warning); color: #1a1a2e; padding: 2px 8px; border-radius: 10px; font-size: 11px;"></span>
            </button>
          </div>

          <!-- My Team Tab -->
          <div id="team-content-my-team">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Contractors & Team</h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn-modern secondary" onclick="openInviteCollaboratorModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Invite
                </button>
                <button class="btn-modern primary" onclick="openNewCollaboratorModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Add Contractor
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-collaborator-status="all" onclick="filterCollaborators('all')">All</button>
                <button class="filter-btn" data-collaborator-status="fabricator" onclick="filterCollaborators('fabricator')">Fabricators</button>
                <button class="filter-btn" data-collaborator-status="installer" onclick="filterCollaborators('installer')">Installers</button>
                <button class="filter-btn" data-collaborator-status="plumber" onclick="filterCollaborators('plumber')">Plumbers</button>
                <button class="filter-btn" data-collaborator-status="other" onclick="filterCollaborators('other')">Other</button>
              </div>
              <div id="collaborators-list">
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <h3>No collaborators yet</h3>
                  <p>Add your fabricators, installers, plumbers, and other team members.</p>
                  <div style="display: flex; gap: 12px; margin-top: 16px; justify-content: center;">
                    <button class="btn-modern secondary" onclick="openInviteCollaboratorModal()">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                      Invite Collaborator
                    </button>
                    <button class="btn-modern primary" onclick="openNewCollaboratorModal()">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                      Add Collaborator
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          </div><!-- end team-content-my-team -->

          <!-- Invitations Tab -->
          <div id="team-content-invitations" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Project Invitations</h3>
              </div>
              <div class="card-body">
                <div id="team-invitations-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    <h3>No pending invitations</h3>
                    <p>When you're invited to collaborate on projects, they'll appear here.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Calendar Page -->
        <section id="page-calendar" class="page-section">
          <div class="card" style="overflow: visible;">
            <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
              <h3 class="card-title">Calendar</h3>
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 4px; align-items: center;">
                  <button class="btn-modern ghost" id="calendar-prev" onclick="changeCalendarMonth(-1)" style="padding: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                  </button>
                  <span id="calendar-month-year" style="font-weight: 600; min-width: 140px; text-align: center;">January 2026</span>
                  <button class="btn-modern ghost" id="calendar-next" onclick="changeCalendarMonth(1)" style="padding: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                  </button>
                </div>
                <button class="btn-modern secondary" onclick="goToToday()">Today</button>
                <button class="btn-modern primary" onclick="openCalendarEventModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Event
                </button>
                <button class="btn-modern secondary" onclick="openQuickScheduleModal()" title="Quick job scheduling">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  Quick Job
                </button>
              </div>
            </div>
            <div class="card-body" style="padding: 0; overflow: visible;">
              <div class="calendar-container" style="overflow: visible;">
                <div class="calendar-header-row">
                  <div class="calendar-header-cell">Sun</div>
                  <div class="calendar-header-cell">Mon</div>
                  <div class="calendar-header-cell">Tue</div>
                  <div class="calendar-header-cell">Wed</div>
                  <div class="calendar-header-cell">Thu</div>
                  <div class="calendar-header-cell">Fri</div>
                  <div class="calendar-header-cell">Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                  <!-- Calendar days will be rendered here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Add Toolbar - Drag & Drop Event Types -->
          <div class="card" id="quick-add-card" style="margin-top: 24px; overflow: visible;">
            <div class="card-header" style="padding: 14px 20px;">
              <h3 class="card-title" style="font-size: 14px; font-weight: 600;">
                <i class="fa-solid fa-grip-vertical" style="margin-right: 8px; color: var(--text-muted);"></i>
                Quick Add
              </h3>
              <span style="font-size: 12px; color: var(--text-muted);">Drag to calendar</span>
            </div>
            <div class="card-body" style="padding: 16px 20px;">
              <div id="quick-add-toolbar" class="quick-add-grid">
                <div class="quick-add-item" draggable="true" data-event-type="appointment"
                     ondragstart="handleQuickAddDragStart(event, 'appointment', 'Appointment', '#f9cb00')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #f9cb00;">
                  <i class="fa-regular fa-calendar-check"></i>
                  <span>Appointment</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="consultation"
                     ondragstart="handleQuickAddDragStart(event, 'consultation', 'Consultation', '#ec4899')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #ec4899;">
                  <i class="fa-regular fa-comments"></i>
                  <span>Consultation</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="measurement"
                     ondragstart="handleQuickAddDragStart(event, 'measurement', 'Measurement', '#f59e0b')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #f59e0b;">
                  <i class="fa-solid fa-ruler-combined"></i>
                  <span>Measurement</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="installation"
                     ondragstart="handleQuickAddDragStart(event, 'installation', 'Installation', '#10b981')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #10b981;">
                  <i class="fa-solid fa-screwdriver-wrench"></i>
                  <span>Installation</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="meeting"
                     ondragstart="handleQuickAddDragStart(event, 'meeting', 'Meeting', '#8b5cf6')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #8b5cf6;">
                  <i class="fa-solid fa-users"></i>
                  <span>Meeting</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="follow_up"
                     ondragstart="handleQuickAddDragStart(event, 'follow_up', 'Follow-up', '#3b82f6')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #3b82f6;">
                  <i class="fa-solid fa-phone"></i>
                  <span>Follow-up</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="site_visit"
                     ondragstart="handleQuickAddDragStart(event, 'site_visit', 'Site Visit', '#14b8a6')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #14b8a6;">
                  <i class="fa-solid fa-location-dot"></i>
                  <span>Site Visit</span>
                </div>
                <div class="quick-add-item" draggable="true" data-event-type="delivery"
                     ondragstart="handleQuickAddDragStart(event, 'delivery', 'Delivery', '#06b6d4')"
                     ondragend="handleQuickAddDragEnd(event)"
                     style="--item-color: #06b6d4;">
                  <i class="fa-solid fa-truck"></i>
                  <span>Delivery</span>
                </div>
              </div>
              <p style="font-size: 11px; color: var(--text-muted); margin-top: 12px; margin-bottom: 0;">
                <i class="fa-solid fa-circle-info" style="margin-right: 6px;"></i>
                Drag to calendar or right-click events for quick actions
              </p>
            </div>
          </div>

          <!-- Upcoming Events -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">Upcoming Events</h3>
            </div>
            <div class="card-body">
              <div id="upcoming-events-list">
                <div class="empty-state" style="padding: 30px;">
                  <p style="color: var(--text-muted);">No upcoming events scheduled</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Wallet Page (Admin Only) -->
        <section id="page-wallet" class="page-section">
          <!-- Balance Cards -->
          <div class="wallet-balance-grid">
            <div class="balance-card available">
              <div class="balance-label">Available Balance</div>
              <div class="balance-amount" id="available-balance">$0.00</div>
              <div class="balance-sub">Ready to withdraw</div>
            </div>
            <div class="balance-card pending">
              <div class="balance-label">Pending Balance</div>
              <div class="balance-amount" id="pending-balance">$0.00</div>
              <div class="balance-sub">Processing payments</div>
            </div>
            <div class="balance-card total">
              <div class="balance-label">Total Revenue</div>
              <div class="balance-amount" id="total-revenue">$0.00</div>
              <div class="balance-sub">All time</div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body" style="display: flex; gap: 12px; flex-wrap: wrap;">
              <a href="https://dashboard.stripe.com" target="_blank" class="btn-modern primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                Open Stripe Dashboard
              </a>
              <button class="btn-modern secondary" onclick="loadWalletData()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
            </div>
          </div>

          <!-- Recent Transactions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Transactions</h3>
            </div>
            <div class="card-body">
              <div id="transactions-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Recent Payouts -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Payouts to Your Bank</h3>
            </div>
            <div class="card-body">
              <div id="payouts-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Fees & Rates Disclosure -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Processing Fees & Rates</h3>
            </div>
            <div class="card-body">
              <div class="fees-grid">
                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    <span>Credit/Debit Cards</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">Per successful transaction</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span>Invoices (Card Payment)</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">When customer pays by card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
                    <span>ACH Bank Transfer</span>
                  </div>
                  <div class="fee-rate">0.8% (max $5)</div>
                  <div class="fee-desc">Direct bank payments</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>Payouts to Bank</span>
                  </div>
                  <div class="fee-rate">Free</div>
                  <div class="fee-desc">Standard 2-day transfer</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span>Instant Payouts</span>
                  </div>
                  <div class="fee-rate">1.5% (min $0.50)</div>
                  <div class="fee-desc">Funds in minutes to debit card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Vendor Payouts</span>
                  </div>
                  <div class="fee-rate">0.25% + $0.25</div>
                  <div class="fee-desc">Per transfer to vendor accounts</div>
                </div>
              </div>

              <div class="fee-note">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div>
                  <strong>How Vendor Payouts Work:</strong>
                  All customer payments are collected through Surprise Granite's Stripe account. Vendors receive payouts after their sales are processed, minus applicable platform and processing fees. Payouts are processed weekly or upon request.
                </div>
              </div>

              <div class="fee-note" style="margin-top: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                <div>
                  <strong>Secure Payments:</strong>
                  All transactions are processed securely through Stripe. We never store credit card numbers on our servers.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin Users Page -->
        <section id="page-admin-users" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Manage Admin Users</h3>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">Add or remove admin access for users. Super admins (joshb@surprisegranite.com, info@surprisegranite.com) always have access.</p>
              <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <input type="email" id="new-admin-email" placeholder="Enter email address" style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <button class="btn-modern primary" onclick="addAdminUser()">Add Admin</button>
              </div>
              <div id="admin-users-list">
                <div class="spinner" style="margin: 20px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- ==================== GOD MODE PAGES ==================== -->

        <!-- GOD MODE - Developer Tools Dashboard -->
        <section id="page-god-mode" class="page-section">
          <div class="page-header" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid rgba(139, 92, 246, 0.3);">
            <div style="display: flex; align-items: center; gap: 16px;">
              <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 28px;"></div>
              <div>
                <h1 class="page-title" style="color: #a855f7; margin: 0;">GOD MODE</h1>
                <p class="page-subtitle" style="margin: 4px 0 0; opacity: 0.8;">Super Admin Developer Tools - Full System Access</p>
              </div>
            </div>
          </div>

          <!-- Dashboard Switcher - All Views -->
          <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%); border: 1px solid rgba(139, 92, 246, 0.2);">
            <div class="card-header"><h3 class="card-title" style="color: #a855f7;"> Dashboard Switcher</h3></div>
            <div class="card-body">
              <p style="margin-bottom: 16px; color: var(--text-secondary); font-size: 14px;">Access all dashboard views across the platform</p>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <!-- Main Dashboards -->
                <a href="/account/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f9cb00 0%, #cca600 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-house" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Customer Account</div><div style="font-size: 12px; color: var(--text-muted);">/account/</div></div>
                </a>
                <a href="/account/pro-dashboard/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-briefcase" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Pro Dashboard</div><div style="font-size: 12px; color: var(--text-muted);">/account/pro-dashboard/</div></div>
                </a>
                <a href="/distributor/dashboard/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-building" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Distributor Portal</div><div style="font-size: 12px; color: var(--text-muted);">/distributor/dashboard/</div></div>
                </a>
                <a href="/distributor/signup/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-pen-to-square" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Distributor Signup</div><div style="font-size: 12px; color: var(--text-muted);">/distributor/signup/</div></div>
                </a>
                <!-- Admin Dashboards -->
                <a href="/admin/products/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-box" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Product Admin</div><div style="font-size: 12px; color: var(--text-muted);">/admin/products/</div></div>
                </a>
                <a href="/admin/orders/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-receipt" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Order Admin</div><div style="font-size: 12px; color: var(--text-muted);">/admin/orders/</div></div>
                </a>
                <!-- Tools -->
                <a href="/tools/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-screwdriver-wrench" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Tools Hub</div><div style="font-size: 12px; color: var(--text-muted);">/tools/</div></div>
                </a>
                <a href="/tools/room-designer/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-palette" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Room Designer</div><div style="font-size: 12px; color: var(--text-muted);">/tools/room-designer/</div></div>
                </a>
                <!-- Stone Yards -->
                <a href="/stone-yards/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #78716c 0%, #57534e 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-mountain" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Stone Yards</div><div style="font-size: 12px; color: var(--text-muted);">/stone-yards/</div></div>
                </a>
                <!-- Auth -->
                <a href="/log-in/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #64748b 0%, #475569 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-lock" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Login Page</div><div style="font-size: 12px; color: var(--text-muted);">/log-in/</div></div>
                </a>
                <a href="/sign-up/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-user-plus" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Sign Up Page</div><div style="font-size: 12px; color: var(--text-muted);">/sign-up/</div></div>
                </a>
                <a href="/auth/callback/" class="god-view-link" style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 12px; text-decoration: none; color: inherit; transition: all 0.2s;">
                  <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;"><i class="fa-solid fa-rotate" style="color: #fff;"></i></div>
                  <div><div style="font-weight: 600;">Auth Callback</div><div style="font-size: 12px; color: var(--text-muted);">/auth/callback/</div></div>
                </a>
              </div>
            </div>
          </div>

          <!-- System Health -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h3 class="card-title">System Health</h3>
              <button class="btn-modern secondary" onclick="refreshSystemHealth()" style="padding: 8px 16px; font-size: 13px;">Refresh</button>
            </div>
            <div class="card-body">
              <div id="god-system-health" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div class="stat-card-mini" style="border-left: 3px solid var(--success);"><div class="stat-card-label">API Status</div><div class="stat-card-value" id="god-api-status" style="color: var(--success);">Checking...</div></div>
                <div class="stat-card-mini" style="border-left: 3px solid var(--success);"><div class="stat-card-label">Supabase</div><div class="stat-card-value" id="god-supabase-status" style="color: var(--success);">Checking...</div></div>
                <div class="stat-card-mini" style="border-left: 3px solid var(--success);"><div class="stat-card-label">Stripe</div><div class="stat-card-value" id="god-stripe-status" style="color: var(--success);">Checking...</div></div>
                <div class="stat-card-mini" style="border-left: 3px solid var(--accent);"><div class="stat-card-label">Total Users</div><div class="stat-card-value" id="god-total-users">-</div></div>
                <div class="stat-card-mini" style="border-left: 3px solid var(--accent);"><div class="stat-card-label">Active Subscribers</div><div class="stat-card-value" id="god-active-subs">-</div></div>
                <div class="stat-card-mini" style="border-left: 3px solid var(--accent);"><div class="stat-card-label">Distributors</div><div class="stat-card-value" id="god-total-distributors">-</div></div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><h3 class="card-title">Quick Actions</h3></div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                <button class="btn-modern secondary" onclick="godClearCache()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg><span style="margin-top: 8px; font-size: 13px;">Clear Cache</span></button>
                <button class="btn-modern secondary" onclick="godSendTestEmail()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg><span style="margin-top: 8px; font-size: 13px;">Test Email</span></button>
                <button class="btn-modern secondary" onclick="godSyncShopify()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg><span style="margin-top: 8px; font-size: 13px;">Sync Shopify</span></button>
                <button class="btn-modern secondary" onclick="godBackupDatabase()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg><span style="margin-top: 8px; font-size: 13px;">Export Backup</span></button>
                <button class="btn-modern secondary" onclick="godToggleMaintenanceMode()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg><span style="margin-top: 8px; font-size: 13px;">Maintenance Mode</span></button>
                <button class="btn-modern secondary" onclick="godReindexProducts()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg><span style="margin-top: 8px; font-size: 13px;">Reindex Products</span></button>
              </div>
            </div>
          </div>

          <!-- Environment Info -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">Environment</h3></div>
            <div class="card-body">
              <div id="god-environment-info" style="font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; overflow-x: auto;">
                <div style="display: grid; grid-template-columns: 150px 1fr; gap: 8px;">
                  <span style="color: var(--text-muted);">Supabase URL:</span><span style="color: var(--accent);">https://ypeypgwsycxcagncgdur.supabase.co</span>
                  <span style="color: var(--text-muted);">API Base:</span><span style="color: var(--accent);" id="god-api-base">Loading...</span>
                  <span style="color: var(--text-muted);">User Agent:</span><span style="color: var(--text-secondary);" id="god-user-agent">Loading...</span>
                  <span style="color: var(--text-muted);">Session ID:</span><span style="color: var(--text-secondary);" id="god-session-id">Loading...</span>
                  <span style="color: var(--text-muted);">Auth Status:</span><span style="color: var(--success);" id="god-auth-status">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- GOD MODE - Customer Hub (Unified User Management) -->
        <section id="page-god-users" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div><h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> Customer Hub</h1><p class="page-subtitle">Unified view of all users, customers, and leads across all platforms</p></div>
            <div style="display: flex; gap: 12px;"><button class="btn-modern secondary" onclick="godExportUsers()">Export CSV</button><button class="btn-modern primary" onclick="godRefreshUsers()">Refresh</button></div>
          </div>

          <!-- Summary Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 24px 0;">
            <div class="stat-card-mini"><div class="stat-card-value" id="god-users-total">-</div><div class="stat-card-label">SG Users</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-users-shopify" style="color: #96bf48;">-</div><div class="stat-card-label">Shopify Customers</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-users-leads" style="color: var(--warning);">-</div><div class="stat-card-label">Leads</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-users-pro" style="color: var(--accent);">-</div><div class="stat-card-label">Pro Users</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-users-collaborators" style="color: var(--success);">-</div><div class="stat-card-label">Collaborators</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-users-admins" style="color: #a855f7;">-</div><div class="stat-card-label">Admins</div></div>
          </div>

          <!-- Customer Hub Tabs -->
          <div class="tabs-modern" style="margin-bottom: 24px;">
            <button class="tab-modern active" onclick="godShowCustomerTab('all-users')">All Users</button>
            <button class="tab-modern" onclick="godShowCustomerTab('shopify')">Shopify Customers</button>
            <button class="tab-modern" onclick="godShowCustomerTab('leads')">Leads</button>
            <button class="tab-modern" onclick="godShowCustomerTab('pro')">Pro Users</button>
            <button class="tab-modern" onclick="godShowCustomerTab('collaborators')">Collaborators</button>
          </div>

          <!-- All Users Tab -->
          <div id="god-customer-tab-all-users" class="god-customer-tab">
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-body">
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 250px; position: relative;"><svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="god-users-search" placeholder="Search by email, name, or ID..." style="width: 100%; padding: 12px 12px 12px 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchUsers()"></div>
                  <select id="god-users-role-filter" onchange="godFilterUsers()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Roles</option><option value="admin">Admin</option><option value="pro">Pro</option><option value="contractor">Contractor</option><option value="fabricator">Fabricator</option><option value="vendor">Vendor</option><option value="distributor">Distributor</option><option value="homeowner">Homeowner</option></select>
                  <select id="god-users-sub-filter" onchange="godFilterUsers()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Subscriptions</option><option value="active">Active</option><option value="inactive">Inactive</option><option value="cancelled">Cancelled</option></select>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                  <thead><tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);"><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">User</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Role</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Subscription</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Created</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Last Active</th><th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px; color: var(--text-muted);">Actions</th></tr></thead>
                  <tbody id="god-users-table-body"><tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading users...</td></tr></tbody>
                </table>
              </div>
              <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border-subtle);"><span id="god-users-count" style="font-size: 13px; color: var(--text-muted);">Showing 0 users</span><div style="display: flex; gap: 8px;"><button class="btn-modern secondary" onclick="godUsersPagePrev()" id="god-users-prev" disabled style="padding: 8px 12px; font-size: 13px;">Previous</button><button class="btn-modern secondary" onclick="godUsersPageNext()" id="god-users-next" style="padding: 8px 12px; font-size: 13px;">Next</button></div></div>
            </div>
          </div>

          <!-- Shopify Customers Tab -->
          <div id="god-customer-tab-shopify" class="god-customer-tab" style="display: none;">
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-body">
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                  <div style="flex: 1; min-width: 250px; position: relative;"><svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="god-shopify-search" placeholder="Search Shopify customers..." style="width: 100%; padding: 12px 12px 12px 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchShopifyCustomers()"></div>
                  <select id="god-shopify-filter" onchange="godFilterShopifyCustomers()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Customers</option><option value="with-orders">With Orders</option><option value="no-orders">No Orders</option><option value="marketing-opted">Marketing Opted-In</option></select>
                  <span style="padding: 8px 16px; background: #96bf48; color: #000; border-radius: 6px; font-size: 13px; font-weight: 600;">Shopify</span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                  <thead><tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);"><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Customer</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Phone</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Orders</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Total Spent</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Created</th><th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px; color: var(--text-muted);">Actions</th></tr></thead>
                  <tbody id="god-shopify-table-body"><tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading Shopify customers...</td></tr></tbody>
                </table>
              </div>
              <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border-subtle);"><span id="god-shopify-count" style="font-size: 13px; color: var(--text-muted);">Showing 0 customers</span><div style="display: flex; gap: 8px;"><button class="btn-modern secondary" onclick="godShopifyPagePrev()" id="god-shopify-prev" disabled style="padding: 8px 12px; font-size: 13px;">Previous</button><button class="btn-modern secondary" onclick="godShopifyPageNext()" id="god-shopify-next" style="padding: 8px 12px; font-size: 13px;">Next</button></div></div>
            </div>
          </div>

          <!-- Leads Tab -->
          <div id="god-customer-tab-leads" class="god-customer-tab" style="display: none;">
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-body">
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                  <div style="flex: 1; min-width: 250px; position: relative;"><svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="god-leads-search" placeholder="Search leads..." style="width: 100%; padding: 12px 12px 12px 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchLeads()"></div>
                  <select id="god-leads-status" onchange="godFilterLeads()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Status</option><option value="new">New</option><option value="contacted">Contacted</option><option value="qualified">Qualified</option><option value="converted">Converted</option><option value="lost">Lost</option></select>
                  <select id="god-leads-source" onchange="godFilterLeads()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Sources</option><option value="website">Website</option><option value="referral">Referral</option><option value="google">Google</option><option value="facebook">Facebook</option></select>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                  <thead><tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);"><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Lead</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Phone</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Status</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Source</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Created</th><th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px; color: var(--text-muted);">Actions</th></tr></thead>
                  <tbody id="god-leads-table-body"><tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading leads...</td></tr></tbody>
                </table>
              </div>
              <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border-subtle);"><span id="god-leads-count" style="font-size: 13px; color: var(--text-muted);">Showing 0 leads</span><div style="display: flex; gap: 8px;"><button class="btn-modern secondary" onclick="godLeadsPagePrev()" id="god-leads-prev" disabled style="padding: 8px 12px; font-size: 13px;">Previous</button><button class="btn-modern secondary" onclick="godLeadsPageNext()" id="god-leads-next" style="padding: 8px 12px; font-size: 13px;">Next</button></div></div>
            </div>
          </div>

          <!-- Pro Users Tab -->
          <div id="god-customer-tab-pro" class="god-customer-tab" style="display: none;">
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-body">
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                  <div style="flex: 1; min-width: 250px; position: relative;"><svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="god-pro-search" placeholder="Search pro users..." style="width: 100%; padding: 12px 12px 12px 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchProUsers()"></div>
                  <select id="god-pro-filter" onchange="godFilterProUsers()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Pro Users</option><option value="active">Active Subscription</option><option value="cancelled">Cancelled</option><option value="trial">Trial</option></select>
                  <span style="padding: 8px 16px; background: var(--accent); color: #000; border-radius: 6px; font-size: 13px; font-weight: 600;">PRO</span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                  <thead><tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);"><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Pro User</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Plan</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Status</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Started</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Next Billing</th><th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px; color: var(--text-muted);">Actions</th></tr></thead>
                  <tbody id="god-pro-table-body"><tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading pro users...</td></tr></tbody>
                </table>
              </div>
              <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border-subtle);"><span id="god-pro-count" style="font-size: 13px; color: var(--text-muted);">Showing 0 pro users</span><div style="display: flex; gap: 8px;"><button class="btn-modern secondary" onclick="godProPagePrev()" id="god-pro-prev" disabled style="padding: 8px 12px; font-size: 13px;">Previous</button><button class="btn-modern secondary" onclick="godProPageNext()" id="god-pro-next" style="padding: 8px 12px; font-size: 13px;">Next</button></div></div>
            </div>
          </div>

          <!-- Collaborators Tab -->
          <div id="god-customer-tab-collaborators" class="god-customer-tab" style="display: none;">
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-body">
                <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                  <div style="flex: 1; min-width: 250px; position: relative;"><svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" id="god-collaborators-search" placeholder="Search collaborators..." style="width: 100%; padding: 12px 12px 12px 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchCollaborators()"></div>
                  <select id="god-collaborators-filter" onchange="godFilterCollaborators()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;"><option value="all">All Collaborators</option><option value="verified">Verified</option><option value="pending">Pending</option><option value="active">Active Jobs</option></select>
                  <span style="padding: 8px 16px; background: var(--success); color: #000; border-radius: 6px; font-size: 13px; font-weight: 600;">Contractor</span>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-body" style="padding: 0; overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                  <thead><tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);"><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Contractor</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Company</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Specialty</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Status</th><th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Jobs</th><th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px; color: var(--text-muted);">Actions</th></tr></thead>
                  <tbody id="god-collaborators-table-body"><tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading collaborators...</td></tr></tbody>
                </table>
              </div>
              <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border-subtle);"><span id="god-collaborators-count" style="font-size: 13px; color: var(--text-muted);">Showing 0 collaborators</span><div style="display: flex; gap: 8px;"><button class="btn-modern secondary" onclick="godCollaboratorsPagePrev()" id="god-collaborators-prev" disabled style="padding: 8px 12px; font-size: 13px;">Previous</button><button class="btn-modern secondary" onclick="godCollaboratorsPageNext()" id="god-collaborators-next" style="padding: 8px 12px; font-size: 13px;">Next</button></div></div>
            </div>
          </div>
        </section>

        <!-- GOD MODE - Marketplace Management -->
        <section id="page-god-marketplace" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div><h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> Marketplace Management</h1><p class="page-subtitle">Manage distributors, listings, and marketplace settings</p></div>
            <button class="btn-modern primary" onclick="godRefreshMarketplace()">Refresh</button>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin: 24px 0;">
            <div class="stat-card-mini"><div class="stat-card-value" id="god-mp-distributors">-</div><div class="stat-card-label">Distributors</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-mp-listings" style="color: var(--accent);">-</div><div class="stat-card-label">Active Listings</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-mp-slabs" style="color: var(--success);">-</div><div class="stat-card-label">Total Slabs</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-mp-inquiries" style="color: var(--warning);">-</div><div class="stat-card-label">Pending Inquiries</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-mp-revenue" style="color: #a855f7;">-</div><div class="stat-card-label">Monthly Revenue</div></div>
          </div>
          <div class="tabs-modern" style="margin-bottom: 24px;"><button class="tab-modern active" onclick="godShowMarketplaceTab('distributors')">Distributors</button><button class="tab-modern" onclick="godShowMarketplaceTab('listings')">Listings</button><button class="tab-modern" onclick="godShowMarketplaceTab('inquiries')">Inquiries</button><button class="tab-modern" onclick="godShowMarketplaceTab('subscriptions')">Subscriptions</button></div>
          <div id="god-mp-tab-distributors" class="god-mp-tab"><div class="card"><div class="card-header" style="display: flex; justify-content: space-between; align-items: center;"><h3 class="card-title">All Distributors</h3><input type="text" placeholder="Search distributors..." style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 13px;" onkeyup="godSearchDistributors(this.value)"></div><div class="card-body" style="padding: 0;"><div id="god-distributors-list" style="max-height: 500px; overflow-y: auto;"><div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading distributors...</div></div></div></div></div>
          <div id="god-mp-tab-listings" class="god-mp-tab" style="display: none;"><div class="card"><div class="card-header"><h3 class="card-title">All Marketplace Listings</h3></div><div class="card-body" style="padding: 0;"><div id="god-listings-list" style="max-height: 500px; overflow-y: auto;"><div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading listings...</div></div></div></div></div>
          <div id="god-mp-tab-inquiries" class="god-mp-tab" style="display: none;"><div class="card"><div class="card-header"><h3 class="card-title">Marketplace Inquiries</h3></div><div class="card-body" style="padding: 0;"><div id="god-inquiries-list" style="max-height: 500px; overflow-y: auto;"><div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading inquiries...</div></div></div></div></div>
          <div id="god-mp-tab-subscriptions" class="god-mp-tab" style="display: none;"><div class="card"><div class="card-header"><h3 class="card-title">Distributor Subscriptions</h3></div><div class="card-body" style="padding: 0;"><div id="god-subscriptions-list" style="max-height: 500px; overflow-y: auto;"><div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading subscriptions...</div></div></div></div></div>
        </section>

        <!-- GOD MODE - Database Tools -->
        <section id="page-god-database" class="page-section">
          <div class="page-header"><h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> Database Tools</h1><p class="page-subtitle">Direct database access and management</p></div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin: 24px 0;"><div class="stat-card-mini"><div class="stat-card-value" id="god-db-tables">-</div><div class="stat-card-label">Tables</div></div><div class="stat-card-mini"><div class="stat-card-value" id="god-db-rows">-</div><div class="stat-card-label">Total Rows</div></div><div class="stat-card-mini"><div class="stat-card-value" id="god-db-size">-</div><div class="stat-card-label">Database Size</div></div></div>
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><h3 class="card-title">SQL Query Runner</h3></div>
            <div class="card-body">
              <textarea id="god-sql-query" placeholder="SELECT * FROM sg_users LIMIT 10;" style="width: 100%; min-height: 120px; padding: 16px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-family: 'Monaco', 'Menlo', monospace; font-size: 13px; resize: vertical;"></textarea>
              <div style="display: flex; gap: 12px; margin-top: 12px;"><button class="btn-modern primary" onclick="godRunSqlQuery()">Run Query</button><button class="btn-modern secondary" onclick="godClearQueryResults()">Clear Results</button><select id="god-sql-preset" onchange="godLoadSqlPreset(this.value)" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);"><option value="">Load Preset Query...</option><option value="users">All Users (limit 100)</option><option value="admins">Admin Users</option><option value="distributors">All Distributors</option><option value="recent_orders">Recent Orders</option><option value="active_subs">Active Subscriptions</option><option value="table_sizes">Table Sizes</option></select></div>
              <div id="god-sql-results" style="margin-top: 16px; max-height: 400px; overflow: auto; display: none;"><pre style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; font-size: 12px; margin: 0; white-space: pre-wrap;"></pre></div>
            </div>
          </div>
          <div class="card"><div class="card-header" style="display: flex; justify-content: space-between; align-items: center;"><h3 class="card-title">Table Browser</h3><select id="god-table-select" onchange="godBrowseTable(this.value)" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 200px;"><option value="">Select a table...</option><option value="sg_users">sg_users</option><option value="customers">customers</option><option value="shopify_customers">shopify_customers</option><option value="shopify_orders">shopify_orders</option><option value="shopify_products">shopify_products</option><option value="distributor_profiles">distributor_profiles</option><option value="marketplace_listings">marketplace_listings</option><option value="jobs">jobs</option><option value="leads">leads</option><option value="estimates">estimates</option></select></div><div class="card-body" style="padding: 0;"><div id="god-table-browser" style="max-height: 400px; overflow: auto;"><div style="padding: 40px; text-align: center; color: var(--text-muted);">Select a table to browse</div></div></div></div>
        </section>

        <!-- GOD MODE - API Tester -->
        <section id="page-god-api" class="page-section">
          <div class="page-header"><h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> API Tester</h1><p class="page-subtitle">Test API endpoints and debug requests</p></div>
          <div class="card">
            <div class="card-body">
              <div style="display: grid; gap: 16px;">
                <div style="display: flex; gap: 12px;"><select id="god-api-method" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 100px;"><option value="GET">GET</option><option value="POST">POST</option><option value="PATCH">PATCH</option><option value="DELETE">DELETE</option></select><input type="text" id="god-api-endpoint" placeholder="/api/endpoint" style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);"><button class="btn-modern primary" onclick="godTestApiEndpoint()">Send Request</button></div>
                <div><label style="display: block; margin-bottom: 8px; font-size: 13px; color: var(--text-muted);">Request Body (JSON)</label><textarea id="god-api-body" placeholder='{"key": "value"}' style="width: 100%; min-height: 100px; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-family: 'Monaco', 'Menlo', monospace; font-size: 13px;"></textarea></div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;"><label style="display: flex; align-items: center; gap: 8px; font-size: 13px;"><input type="checkbox" id="god-api-auth" checked> Include Auth Token</label><select id="god-api-preset" onchange="godLoadApiPreset(this.value)" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"><option value="">Load Preset...</option><option value="health">System Health</option><option value="users">Get Users</option><option value="products">Get Products</option><option value="orders">Get Orders</option><option value="stripe">Stripe Status</option><option value="distributors">Get Distributors</option></select></div>
              </div>
              <div id="god-api-response" style="margin-top: 24px; display: none;"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;"><h4 style="margin: 0; font-size: 14px; color: var(--text-muted);">Response</h4><div style="display: flex; gap: 8px; align-items: center;"><span id="god-api-status-code" style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">-</span><span id="god-api-time" style="font-size: 12px; color: var(--text-muted);">-</span></div></div><pre id="god-api-response-body" style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; font-size: 12px; margin: 0; max-height: 400px; overflow: auto; white-space: pre-wrap;"></pre></div>
            </div>
          </div>
        </section>

        <!-- GOD MODE - System Logs -->
        <section id="page-god-logs" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;"><div><h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> System Logs</h1><p class="page-subtitle">View and analyze system activity</p></div><div style="display: flex; gap: 12px;"><button class="btn-modern secondary" onclick="godExportLogs()">Export Logs</button><button class="btn-modern primary" onclick="godRefreshLogs()">Refresh</button></div></div>
          <div class="card" style="margin: 24px 0;"><div class="card-body"><div style="display: flex; gap: 12px; flex-wrap: wrap;"><select id="god-logs-type" onchange="godFilterLogs()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);"><option value="all">All Types</option><option value="auth">Authentication</option><option value="api">API Requests</option><option value="error">Errors</option><option value="payment">Payments</option><option value="admin">Admin Actions</option></select><select id="god-logs-level" onchange="godFilterLogs()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);"><option value="all">All Levels</option><option value="info">Info</option><option value="warn">Warning</option><option value="error">Error</option></select><input type="text" id="god-logs-search" placeholder="Search logs..." style="flex: 1; min-width: 200px; padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchLogs()"></div></div></div>
          <div class="card"><div class="card-body" style="padding: 0;"><div id="god-logs-container" style="max-height: 600px; overflow-y: auto; font-family: 'Monaco', 'Menlo', monospace; font-size: 12px;"><div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading logs...</div></div></div></div>
        </section>

        <!-- GOD MODE - Analytics Dashboard -->
        <section id="page-god-analytics" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> Analytics Dashboard</h1>
              <p class="page-subtitle">Website traffic, user engagement, and performance metrics</p>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <div id="god-ga-status" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 13px;">
                <span id="god-ga-indicator" style="width: 8px; height: 8px; border-radius: 50%; background: var(--warning);"></span>
                <span id="god-ga-text">GA4 Not Connected</span>
              </div>
              <button id="god-ga-connect-btn" class="btn-modern secondary" onclick="godConnectGoogleAnalytics()" style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Connect GA4
              </button>
              <select id="god-analytics-range" onchange="godLoadAnalytics()" style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
              </select>
              <button class="btn-modern primary" onclick="godLoadAnalytics()">Refresh</button>
            </div>
          </div>

          <!-- Analytics Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin: 24px 0;">
            <div class="stat-card-mini" style="border-left: 3px solid var(--accent);">
              <div class="stat-card-value" id="god-analytics-visitors">-</div>
              <div class="stat-card-label">Total Visitors</div>
            </div>
            <div class="stat-card-mini" style="border-left: 3px solid var(--success);">
              <div class="stat-card-value" id="god-analytics-pageviews">-</div>
              <div class="stat-card-label">Page Views</div>
            </div>
            <div class="stat-card-mini" style="border-left: 3px solid var(--info);">
              <div class="stat-card-value" id="god-analytics-sessions">-</div>
              <div class="stat-card-label">Sessions</div>
            </div>
            <div class="stat-card-mini" style="border-left: 3px solid #a855f7;">
              <div class="stat-card-value" id="god-analytics-bounce">-</div>
              <div class="stat-card-label">Bounce Rate</div>
            </div>
            <div class="stat-card-mini" style="border-left: 3px solid var(--warning);">
              <div class="stat-card-value" id="god-analytics-duration">-</div>
              <div class="stat-card-label">Avg. Duration</div>
            </div>
            <div class="stat-card-mini" style="border-left: 3px solid var(--success);">
              <div class="stat-card-value" id="god-analytics-conversions">-</div>
              <div class="stat-card-label">Conversions</div>
            </div>
          </div>

          <!-- Analytics Tabs -->
          <div class="tabs-modern" style="margin-bottom: 24px;">
            <button class="tab-modern active" onclick="godShowAnalyticsTab('overview')">Overview</button>
            <button class="tab-modern" onclick="godShowAnalyticsTab('traffic')">Traffic Sources</button>
            <button class="tab-modern" onclick="godShowAnalyticsTab('pages')">Top Pages</button>
            <button class="tab-modern" onclick="godShowAnalyticsTab('users')">User Activity</button>
            <button class="tab-modern" onclick="godShowAnalyticsTab('seo')">Search Console</button>
            <button class="tab-modern" onclick="godShowAnalyticsTab('gmb')">Google Business</button>
          </div>

          <!-- Overview Tab -->
          <div id="god-analytics-tab-overview" class="god-analytics-tab">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
              <div class="card">
                <div class="card-header"><h3 class="card-title">Traffic Over Time</h3></div>
                <div class="card-body">
                  <div id="god-chart-traffic" style="height: 250px; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">
                    <div style="text-align: center;">
                      <div style="font-size: 48px; margin-bottom: 12px;"></div>
                      <p>Connect Google Analytics to view traffic data</p>
                      <button class="btn-modern secondary" onclick="godConnectGoogleAnalytics()" style="margin-top: 12px;">Connect GA4</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><h3 class="card-title">Real-Time Visitors</h3></div>
                <div class="card-body">
                  <div id="god-realtime-visitors" style="text-align: center; padding: 20px;">
                    <div style="font-size: 64px; font-weight: 700; color: var(--success);" id="god-realtime-count">-</div>
                    <div style="color: var(--text-muted); margin-top: 8px;">Active users right now</div>
                    <div style="margin-top: 16px; display: flex; justify-content: center; gap: 24px;">
                      <div><span style="font-size: 24px; font-weight: 600;" id="god-realtime-desktop">-</span><br><span style="font-size: 12px; color: var(--text-muted);">Desktop</span></div>
                      <div><span style="font-size: 24px; font-weight: 600;" id="god-realtime-mobile">-</span><br><span style="font-size: 12px; color: var(--text-muted);">Mobile</span></div>
                      <div><span style="font-size: 24px; font-weight: 600;" id="god-realtime-tablet">-</span><br><span style="font-size: 12px; color: var(--text-muted);">Tablet</span></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Traffic Sources Tab -->
          <div id="god-analytics-tab-traffic" class="god-analytics-tab" style="display: none;">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Traffic Sources</h3></div>
              <div class="card-body" style="padding: 0;">
                <div id="god-traffic-sources" style="max-height: 400px; overflow-y: auto;">
                  <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading traffic sources...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Top Pages Tab -->
          <div id="god-analytics-tab-pages" class="god-analytics-tab" style="display: none;">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Top Pages</h3></div>
              <div class="card-body" style="padding: 0;">
                <div id="god-top-pages" style="max-height: 400px; overflow-y: auto;">
                  <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading top pages...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- User Activity Tab -->
          <div id="god-analytics-tab-users" class="god-analytics-tab" style="display: none;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">User Activity Log</h3>
                <button class="btn-modern secondary" onclick="godExportUserActivity()" style="padding: 8px 16px; font-size: 13px;">Export CSV</button>
              </div>
              <div class="card-body" style="padding: 0;">
                <div id="god-user-activity" style="max-height: 500px; overflow-y: auto;">
                  <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading user activity...</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Search Console Tab -->
          <div id="god-analytics-tab-seo" class="god-analytics-tab" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
              <div class="stat-card-mini" style="border-left: 3px solid #4285f4;">
                <div class="stat-card-value" id="god-gsc-clicks">-</div>
                <div class="stat-card-label">Total Clicks</div>
              </div>
              <div class="stat-card-mini" style="border-left: 3px solid #34a853;">
                <div class="stat-card-value" id="god-gsc-impressions">-</div>
                <div class="stat-card-label">Impressions</div>
              </div>
              <div class="stat-card-mini" style="border-left: 3px solid #fbbc05;">
                <div class="stat-card-value" id="god-gsc-ctr">-</div>
                <div class="stat-card-label">CTR</div>
              </div>
              <div class="stat-card-mini" style="border-left: 3px solid #ea4335;">
                <div class="stat-card-value" id="god-gsc-position">-</div>
                <div class="stat-card-label">Avg Position</div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h3 class="card-title">Top Search Queries</h3>
                <button class="btn-modern secondary" onclick="godLoadSearchConsole()" style="padding: 6px 12px; font-size: 12px;">Refresh</button>
              </div>
              <div class="card-body" style="padding: 0;">
                <div id="god-gsc-queries" style="max-height: 400px; overflow-y: auto;">
                  <div style="padding: 40px; text-align: center; color: var(--text-muted);">Click "Connect GA4" to load Search Console data</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Google Business Profile Tab -->
          <div id="god-analytics-tab-gmb" class="god-analytics-tab" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
              <div class="stat-card-mini" style="border-left: 3px solid #4285f4;">
                <div class="stat-card-value" id="god-gmb-views">-</div>
                <div class="stat-card-label">Profile Views</div>
              </div>
              <div class="stat-card-mini" style="border-left: 3px solid #34a853;">
                <div class="stat-card-value" id="god-gmb-searches">-</div>
                <div class="stat-card-label">Search Views</div>
              </div>
              <div class="stat-card-mini" style="border-left: 3px solid #fbbc05;">
                <div class="stat-card-value" id="god-gmb-calls">-</div>
                <div class="stat-card-label">Phone Calls</div>
              </div>
              <div class="stat-card-mini" style="border-left: 3px solid #ea4335;">
                <div class="stat-card-value" id="god-gmb-directions">-</div>
                <div class="stat-card-label">Direction Requests</div>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
              <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                  <h3 class="card-title">Recent Reviews</h3>
                  <button class="btn-modern secondary" onclick="godLoadGoogleBusiness()" style="padding: 6px 12px; font-size: 12px;">Refresh</button>
                </div>
                <div class="card-body" style="padding: 0;">
                  <div id="god-gmb-reviews" style="max-height: 400px; overflow-y: auto;">
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">Click "Connect GA4" to load Google Business data</div>
                  </div>
                </div>
              </div>
              <div class="card">
                <div class="card-header"><h3 class="card-title">Business Actions</h3></div>
                <div class="card-body">
                  <div id="god-gmb-actions" style="min-height: 200px;">
                    <div style="padding: 40px; text-align: center; color: var(--text-muted);">Loading business metrics...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bing Webmaster Tab (moved to after GMB) -->
          <div id="god-analytics-tab-bing" class="god-analytics-tab" style="display: none;">
            <div class="card">
              <div class="card-header"><h3 class="card-title">Bing Webmaster</h3></div>
              <div class="card-body">
                <div id="god-bing-data" style="text-align: center; padding: 20px;">
                  <div style="font-size: 48px; margin-bottom: 12px;"></div>
                  <p style="color: var(--text-muted);">Connect Bing Webmaster Tools to view search data</p>
                  <a href="https://www.bing.com/webmasters" target="_blank" class="btn-modern secondary" style="margin-top: 12px;">Open Bing Webmaster</a>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- GOD MODE - Site Manager -->
        <section id="page-god-site" class="page-section">
          <div class="page-header">
            <h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> Site Manager</h1>
            <p class="page-subtitle">Manage website content, SEO, and performance</p>
          </div>

          <!-- Site Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin: 24px 0;">
            <div class="stat-card-mini" style="border-left: 3px solid var(--success);"><div class="stat-card-value" id="god-site-status">Online</div><div class="stat-card-label">Site Status</div></div>
            <div class="stat-card-mini" style="border-left: 3px solid var(--info);"><div class="stat-card-value" id="god-site-pages">-</div><div class="stat-card-label">Total Pages</div></div>
            <div class="stat-card-mini" style="border-left: 3px solid var(--accent);"><div class="stat-card-value" id="god-site-images">-</div><div class="stat-card-label">Images</div></div>
            <div class="stat-card-mini" style="border-left: 3px solid #a855f7;"><div class="stat-card-value" id="god-site-lighthouse">-</div><div class="stat-card-label">Lighthouse Score</div></div>
          </div>

          <!-- Quick Links -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><h3 class="card-title">Quick Links</h3></div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <a href="https://app.netlify.com/sites/surprise-granite-site/overview" target="_blank" class="btn-modern secondary" style="justify-content: flex-start;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
                  Netlify Dashboard
                </a>
                <a href="https://github.com/SGK112/surprise-granite-site" target="_blank" class="btn-modern secondary" style="justify-content: flex-start;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0020 4.77 5.07 5.07 0 0019.91 1S18.73.65 16 2.48a13.38 13.38 0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 005 4.77a5.44 5.44 0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 009 18.13V22"/></svg>
                  GitHub Repository
                </a>
                <a href="https://ypeypgwsycxcagncgdur.supabase.co" target="_blank" class="btn-modern secondary" style="justify-content: flex-start;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7"/><ellipse cx="12" cy="7" rx="8" ry="4"/></svg>
                  Supabase Dashboard
                </a>
                <a href="https://dashboard.stripe.com" target="_blank" class="btn-modern secondary" style="justify-content: flex-start;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 4H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                  Stripe Dashboard
                </a>
                <a href="https://analytics.google.com" target="_blank" class="btn-modern secondary" style="justify-content: flex-start;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                  Google Analytics
                </a>
                <a href="https://search.google.com/search-console" target="_blank" class="btn-modern secondary" style="justify-content: flex-start;">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  Search Console
                </a>
              </div>
            </div>
          </div>

          <!-- Site Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><h3 class="card-title">Site Actions</h3></div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                <button class="btn-modern secondary" onclick="godClearSiteCache()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                  <span style="margin-top: 8px; font-size: 13px;">Clear All Caches</span>
                </button>
                <button class="btn-modern secondary" onclick="godTriggerDeploy()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
                  <span style="margin-top: 8px; font-size: 13px;">Trigger Deploy</span>
                </button>
                <button class="btn-modern secondary" onclick="godCheckSitemap()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                  <span style="margin-top: 8px; font-size: 13px;">Check Sitemap</span>
                </button>
                <button class="btn-modern secondary" onclick="godRunLighthouse()" style="display: flex; flex-direction: column; align-items: center; padding: 20px; height: auto;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                  <span style="margin-top: 8px; font-size: 13px;">Run Lighthouse</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Sitemap Status -->
          <div class="card">
            <div class="card-header"><h3 class="card-title">Sitemap & Robots</h3></div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <div>
                  <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--text-muted);">sitemap.xml</h4>
                  <div id="god-sitemap-status" style="padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px; font-family: monospace; font-size: 12px;">
                    <a href="/sitemap.xml" target="_blank" style="color: var(--accent);">View Sitemap </a>
                  </div>
                </div>
                <div>
                  <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--text-muted);">robots.txt</h4>
                  <div id="god-robots-status" style="padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px; font-family: monospace; font-size: 12px;">
                    <a href="/robots.txt" target="_blank" style="color: var(--accent);">View Robots.txt </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- GOD MODE - Configuration -->
        <section id="page-god-config" class="page-section">
          <div class="page-header">
            <h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> Configuration</h1>
            <p class="page-subtitle">System configuration, API keys, and feature flags</p>
          </div>

          <!-- Integration Status -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">Integration Status</h3>
              <button class="btn-modern secondary" onclick="godCheckIntegrations()" style="padding: 8px 16px; font-size: 13px;">Check All</button>
            </div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;" id="god-integrations-status">
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);" id="god-int-supabase"></div>
                  <span>Supabase</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);" id="god-int-stripe"></div>
                  <span>Stripe</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning);" id="god-int-ga"></div>
                  <span>Google Analytics</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);" id="god-int-shopify"></div>
                  <span>Shopify</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--warning);" id="god-int-email"></div>
                  <span>Email (Nodemailer)</span>
                </div>
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success);" id="god-int-netlify"></div>
                  <span>Netlify</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Environment Variables (Masked) -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><h3 class="card-title">Environment Configuration</h3></div>
            <div class="card-body">
              <div style="display: grid; gap: 12px; font-family: 'Monaco', 'Menlo', monospace; font-size: 13px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <span style="color: var(--text-muted);">SUPABASE_URL</span>
                  <span style="color: var(--accent);">https://ypeypgwsycxcagncgdur.supabase.co</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <span style="color: var(--text-muted);">SUPABASE_ANON_KEY</span>
                  <span style="color: var(--text-secondary);">eyJh...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <span style="color: var(--text-muted);">STRIPE_PUBLISHABLE_KEY</span>
                  <span style="color: var(--text-secondary);">pk_live_...</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <span style="color: var(--text-muted);">API_BASE_URL</span>
                  <span style="color: var(--accent);" id="god-config-api-url">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Feature Flags -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header"><h3 class="card-title">Feature Flags</h3></div>
            <div class="card-body">
              <div style="display: grid; gap: 12px;">
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                  <div>
                    <span style="font-weight: 500;">Maintenance Mode</span>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Show maintenance page to visitors</p>
                  </div>
                  <input type="checkbox" id="god-flag-maintenance" onchange="godToggleFeature('maintenance', this.checked)" style="width: 20px; height: 20px; accent-color: var(--accent);">
                </label>
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                  <div>
                    <span style="font-weight: 500;">Debug Mode</span>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Show debug info in console</p>
                  </div>
                  <input type="checkbox" id="god-flag-debug" onchange="godToggleFeature('debug', this.checked)" style="width: 20px; height: 20px; accent-color: var(--accent);">
                </label>
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                  <div>
                    <span style="font-weight: 500;">Beta Features</span>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Enable experimental features</p>
                  </div>
                  <input type="checkbox" id="god-flag-beta" onchange="godToggleFeature('beta', this.checked)" style="width: 20px; height: 20px; accent-color: var(--accent);">
                </label>
                <label style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer;">
                  <div>
                    <span style="font-weight: 500;">AI Assistant</span>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Enable AI-powered features</p>
                  </div>
                  <input type="checkbox" id="god-flag-ai" checked onchange="godToggleFeature('ai', this.checked)" style="width: 20px; height: 20px; accent-color: var(--accent);">
                </label>
              </div>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="card" style="border: 1px solid rgba(239, 68, 68, 0.3);">
            <div class="card-header" style="background: rgba(239, 68, 68, 0.1);"><h3 class="card-title" style="color: var(--error);">Danger Zone</h3></div>
            <div class="card-body">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <button class="btn-modern secondary" onclick="godPurgeAllData()" style="color: var(--error); border-color: rgba(239, 68, 68, 0.3);">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6"/></svg>
                  Purge Cache
                </button>
                <button class="btn-modern secondary" onclick="godResetAnalytics()" style="color: var(--error); border-color: rgba(239, 68, 68, 0.3);">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 4v6h-6M1 20v-6h6"/><path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/></svg>
                  Reset Local Analytics
                </button>
              </div>
            </div>
          </div>
        </section>

        <!-- All Designs (God Mode) -->
        <section id="page-god-designs" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 class="page-title" style="color: #a855f7;"><span style="margin-right: 8px;"></span> All Designs</h1>
              <p class="page-subtitle">View and manage all room designs across all users</p>
            </div>
            <div style="display: flex; gap: 12px;">
              <button class="btn-modern secondary" onclick="godExportDesigns()">Export CSV</button>
              <button class="btn-modern primary" onclick="godLoadDesigns()">Refresh</button>
            </div>
          </div>

          <!-- Summary Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin: 24px 0;">
            <div class="stat-card-mini"><div class="stat-card-value" id="god-designs-total">-</div><div class="stat-card-label">Total Designs</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-designs-shared" style="color: var(--success);">-</div><div class="stat-card-label">Shared</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-designs-private" style="color: var(--text-muted);">-</div><div class="stat-card-label">Private</div></div>
            <div class="stat-card-mini"><div class="stat-card-value" id="god-designs-users" style="color: var(--accent);">-</div><div class="stat-card-label">Unique Users</div></div>
          </div>

          <!-- Search & Filters -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-body">
              <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                <div style="flex: 1; min-width: 250px; position: relative;">
                  <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                  <input type="text" id="god-designs-search" placeholder="Search by design name or creator email..." style="width: 100%; padding: 12px 12px 12px 40px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary);" onkeyup="godSearchDesigns()">
                </div>
                <select id="god-designs-type-filter" onchange="godFilterDesignsType()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;">
                  <option value="all">All Room Types</option>
                  <option value="kitchen">Kitchen</option>
                  <option value="bathroom">Bathroom</option>
                  <option value="laundry">Laundry</option>
                  <option value="outdoor">Outdoor</option>
                  <option value="other">Other</option>
                </select>
                <select id="god-designs-status-filter" onchange="godFilterDesignsStatus()" style="padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); min-width: 150px;">
                  <option value="all">All Status</option>
                  <option value="shared">Shared</option>
                  <option value="private">Private</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Designs Table -->
          <div class="card">
            <div class="card-body" style="padding: 0; overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
                <thead>
                  <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Design</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Creator</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Room Type</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Elements</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Quote Total</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Status</th>
                    <th style="padding: 12px 16px; text-align: left; font-weight: 600; font-size: 13px; color: var(--text-muted);">Created</th>
                    <th style="padding: 12px 16px; text-align: center; font-weight: 600; font-size: 13px; color: var(--text-muted);">Actions</th>
                  </tr>
                </thead>
                <tbody id="god-designs-table-body">
                  <tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading designs...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="card-footer" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-top: 1px solid var(--border-subtle);">
              <span id="god-designs-count" style="font-size: 13px; color: var(--text-muted);">Showing 0 designs</span>
              <div style="display: flex; gap: 8px;">
                <button class="btn-modern secondary" onclick="godDesignsPagePrev()" id="god-designs-prev" disabled style="padding: 8px 12px; font-size: 13px;">Previous</button>
                <button class="btn-modern secondary" onclick="godDesignsPageNext()" id="god-designs-next" style="padding: 8px 12px; font-size: 13px;">Next</button>
              </div>
            </div>
          </div>
        </section>

        <!-- ==================== END GOD MODE PAGES ==================== -->

        <!-- Products Page -->
        <section id="page-products" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 class="page-title">Product Management</h1>
              <p class="page-subtitle">Manage your product catalog</p>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="btn-modern secondary" onclick="openImportModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="17 8 12 3 7 8"/>
                  <line x1="12" y1="3" x2="12" y2="15"/>
                </svg>
                Import
              </button>
              <button class="btn-modern secondary" onclick="exportProductsCSV()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Export
              </button>
              <button class="btn-modern primary" onclick="openProductModal()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 4v16m8-8H4"/>
                </svg>
                Add Product
              </button>
            </div>
          </div>

          <!-- Products Stats -->
          <div class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 24px; margin-bottom: 24px;">
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-total-products">-</div>
              <div class="stat-card-label">Total Products</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-active-products" style="color: var(--success);">-</div>
              <div class="stat-card-label">Active</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-draft-products" style="color: var(--warning);">-</div>
              <div class="stat-card-label">Draft</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-lowstock-products" style="color: var(--error);">-</div>
              <div class="stat-card-label">Low Stock</div>
            </div>
          </div>

          <!-- Search & Filters -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; position: relative;">
              <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input type="text" id="products-search" placeholder="Search products by name, SKU, vendor..."
                style="width: 100%; padding: 12px 12px 12px 40px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                aria-label="Search products">
            </div>
            <select id="products-vendor-filter" onchange="filterProductsList()"
              style="padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 150px;"
              aria-label="Filter by vendor">
              <option value="">All Vendors</option>
            </select>
            <select id="products-type-filter" onchange="filterProductsList()"
              style="padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 150px;"
              aria-label="Filter by product type">
              <option value="">All Types</option>
            </select>
          </div>

          <!-- Status Filters -->
          <div class="table-filters" style="margin-bottom: 20px;">
            <button class="filter-btn active" data-product-status="all" onclick="filterProductsByStatus('all')">All <span id="products-count-all" style="opacity: 0.7; margin-left: 4px;">0</span></button>
            <button class="filter-btn" data-product-status="active" onclick="filterProductsByStatus('active')">Active <span id="products-count-active" style="opacity: 0.7; margin-left: 4px;">0</span></button>
            <button class="filter-btn" data-product-status="draft" onclick="filterProductsByStatus('draft')">Draft <span id="products-count-draft" style="opacity: 0.7; margin-left: 4px;">0</span></button>
            <button class="filter-btn" data-product-status="discontinued" onclick="filterProductsByStatus('discontinued')">Discontinued <span id="products-count-discontinued" style="opacity: 0.7; margin-left: 4px;">0</span></button>
          </div>

          <!-- Bulk Actions -->
          <div id="products-bulk-actions" style="display: none; align-items: center; gap: 12px; padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--gold-primary); border-radius: 10px; margin-bottom: 16px;">
            <span><strong id="products-selected-count" style="color: var(--gold-primary);">0</strong> selected</span>
            <button class="btn-modern small" style="padding: 6px 12px; font-size: 13px;" onclick="bulkUpdateProducts('active')">Set Active</button>
            <button class="btn-modern secondary small" style="padding: 6px 12px; font-size: 13px;" onclick="bulkUpdateProducts('draft')">Set Draft</button>
            <button class="btn-modern secondary small" style="padding: 6px 12px; font-size: 13px; color: var(--error);" onclick="bulkDeleteProducts()">Delete</button>
            <button class="btn-modern secondary small" style="padding: 6px 12px; font-size: 13px; margin-left: auto;" onclick="clearProductSelection()">Clear</button>
          </div>

          <!-- Products Loading State -->
          <div id="products-loading" class="loading-state">
            <div class="spinner"></div>
            <p>Loading products...</p>
          </div>

          <!-- Products Empty State -->
          <div id="products-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
              </svg>
            </div>
            <h3>No Products Yet</h3>
            <p>Add your first product to get started.</p>
            <button class="btn-modern primary" onclick="openProductModal()">Add Product</button>
          </div>

          <!-- Products Table -->
          <div id="products-table-container" style="display: none; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; overflow: hidden;">
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; min-width: 800px;">
                <thead>
                  <tr style="background: var(--dark-surface);">
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); width: 40px;">
                      <input type="checkbox" id="products-select-all" onchange="toggleAllProducts()" style="accent-color: var(--gold-primary);">
                    </th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); width: 60px;">Image</th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted);">Product</th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted);">SKU</th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted);">Price</th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted);">Stock</th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted);">Status</th>
                    <th style="padding: 14px 16px; text-align: left; font-size: 12px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); width: 100px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="products-table-body"></tbody>
              </table>
            </div>

            <!-- Pagination -->
            <div id="products-pagination" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border-top: 1px solid var(--border-subtle);">
              <div id="products-page-info" style="color: var(--text-muted); font-size: 14px;">Showing 1-50 of 0</div>
              <div style="display: flex; gap: 8px;">
                <button id="products-prev-btn" onclick="productsPagePrev()" class="btn-modern secondary" style="padding: 8px 16px;" disabled>Previous</button>
                <button id="products-next-btn" onclick="productsPageNext()" class="btn-modern secondary" style="padding: 8px 16px;">Next</button>
              </div>
            </div>
          </div>
        </section>

        <!-- Orders Page -->
        <section id="page-orders" class="page-section">
          <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px;">
            <div>
              <h1 class="page-title">Order History</h1>
              <p class="page-subtitle">View and manage all orders</p>
            </div>
            <button class="btn-modern secondary" onclick="exportOrdersCSV()">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export CSV
            </button>
          </div>

          <!-- Orders Stats -->
          <div id="orders-stats" class="stats-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 24px; margin-bottom: 24px;">
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-total-orders">-</div>
              <div class="stat-card-label">Total Orders</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-orders-revenue" style="color: var(--success);">-</div>
              <div class="stat-card-label">Revenue</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-paid-orders" style="color: var(--info);">-</div>
              <div class="stat-card-label">Paid</div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-card-value" id="stat-fulfilled-orders" style="color: var(--gold-primary);">-</div>
              <div class="stat-card-label">Fulfilled</div>
            </div>
          </div>

          <!-- Search & Filters -->
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; position: relative;">
              <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted);" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
              </svg>
              <input type="text" id="orders-search" placeholder="Search orders..."
                style="width: 100%; padding: 12px 12px 12px 40px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;"
                aria-label="Search orders">
            </div>
            <select id="orders-status-filter" onchange="filterOrders()"
              style="padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 140px;"
              aria-label="Filter by payment status">
              <option value="">All Statuses</option>
              <option value="paid">Paid</option>
              <option value="pending">Pending</option>
              <option value="refunded">Refunded</option>
            </select>
            <select id="orders-fulfillment-filter" onchange="filterOrders()"
              style="padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 140px;"
              aria-label="Filter by fulfillment status">
              <option value="">All Fulfillment</option>
              <option value="fulfilled">Fulfilled</option>
              <option value="unfulfilled">Unfulfilled</option>
              <option value="partial">Partial</option>
            </select>
          </div>

          <!-- Orders Loading State -->
          <div id="orders-loading" class="loading-state">
            <div class="spinner"></div>
            <p>Loading orders...</p>
          </div>

          <!-- Orders Empty State -->
          <div id="orders-empty" class="empty-state" style="display: none;">
            <div class="empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
              </svg>
            </div>
            <h3>No Orders Yet</h3>
            <p>When you place orders, they'll appear here.</p>
            <a href="/shop/" class="btn-modern primary">Browse Products</a>
          </div>

          <!-- Orders List -->
          <div id="orders-list" class="orders-container" style="display: none;"></div>

          <!-- Pagination -->
          <div id="orders-pagination" style="display: none; justify-content: space-between; align-items: center; margin-top: 20px; padding: 16px; background: var(--dark-elevated); border-radius: 12px;">
            <div id="orders-page-info" style="color: var(--text-muted); font-size: 14px;">Showing 1-50 of 557</div>
            <div style="display: flex; gap: 8px;">
              <button id="orders-prev-btn" onclick="ordersPagePrev()" class="btn-modern secondary" style="padding: 8px 16px;" disabled>Previous</button>
              <button id="orders-next-btn" onclick="ordersPageNext()" class="btn-modern secondary" style="padding: 8px 16px;">Next</button>
            </div>
          </div>
        </section>

        <!-- Messages Page -->
        <section id="page-messages" class="page-section">
          <div class="page-header-modern">
            <div>
              <h1>Messages</h1>
              <p class="page-subtitle">Communicate with customers</p>
            </div>
            <button class="btn-modern primary" onclick="openNewMessageModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
              New Message
            </button>
          </div>

          <div class="messages-container">
            <!-- Conversations List -->
            <div class="conversations-list">
              <!-- Mobile Toggle Header -->
              <div class="conversations-toggle" onclick="toggleConversationsList()" style="display: none;">
                <h4>
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  Conversations
                  <span id="conversations-count-badge" style="background: var(--gold); color: var(--dark); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; margin-left: 8px;">0</span>
                </h4>
                <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
              </div>
              <div class="conversations-header">
                <input type="text" class="search-input-modern" id="conversation-search" placeholder="Search messages..." oninput="filterConversations(this.value)" aria-label="Search messages">
                <div class="filter-chips">
                  <button class="filter-chip active" data-filter="all" onclick="setNotificationFilter('all')">All</button>
                  <button class="filter-chip" data-filter="unread" onclick="setNotificationFilter('unread')">Unread</button>
                  <button class="filter-chip" data-filter="messages" onclick="setNotificationFilter('messages')">Messages</button>
                  <button class="filter-chip" data-filter="leads" onclick="setNotificationFilter('leads')">Leads</button>
                </div>
              </div>
              <div class="conversations-items" id="conversations-list">
                <div class="loading-state">
                  <div class="spinner-modern"></div>
                  <span>Loading conversations...</span>
                </div>
              </div>
            </div>

            <!-- Message Thread -->
            <div class="message-thread" id="message-thread">
              <div class="thread-header" id="thread-header" style="display: none;">
                <div class="thread-contact">
                  <div class="avatar-modern" id="thread-avatar">?</div>
                  <div class="thread-info">
                    <h3 id="thread-name">Select a conversation</h3>
                    <span class="thread-status" id="thread-status"></span>
                  </div>
                </div>
                <div class="thread-actions">
                  <button class="btn-icon" onclick="callCustomer()" title="Call">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                  </button>
                  <button class="btn-icon" onclick="emailCustomer()" title="Email">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  </button>
                  <button class="btn-icon" onclick="viewCustomerProfile()" title="View Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  </button>
                </div>
              </div>

              <div class="thread-messages" id="thread-messages">
                <div class="empty-thread">
                  <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  <h3>Select a conversation</h3>
                  <p>Choose a customer from the list to view messages</p>
                </div>
              </div>

              <div class="message-input-area" id="message-input-area" style="display: none;">
                <div class="message-input-wrapper">
                  <button class="btn-icon attachment-btn" onclick="attachFile()" title="Attach file">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                  </button>
                  <textarea id="message-input" class="message-input" placeholder="Type your message..." rows="1" onkeydown="handleMessageKeydown(event)"></textarea>
                  <button class="btn-modern primary send-btn" onclick="sendMessage()" id="send-message-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                  </button>
                </div>
                <div class="message-channel-selector">
                  <label class="channel-option">
                    <input type="radio" name="message-channel" value="in_app" checked>
                    <span>In-App</span>
                  </label>
                  <label class="channel-option">
                    <input type="radio" name="message-channel" value="email">
                    <span>Email</span>
                  </label>
                  <label class="channel-option">
                    <input type="radio" name="message-channel" value="sms">
                    <span>SMS</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Mobile Floating Action Buttons -->
      <button class="fab-modern" id="fab-leads" onclick="openAddLeadModal()" style="display: none;" title="Add Lead">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
      </button>
      <button class="fab-modern" id="fab-estimates" onclick="openCreateEstimateModal()" style="display: none;" title="New Estimate">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
      <button class="fab-modern" id="fab-invoices" onclick="openInvoiceModal()" style="display: none;" title="New Invoice">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
      <button class="fab-modern" id="fab-jobs" onclick="openNewJobModal()" style="display: none;" title="New Job">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
      <button class="fab-modern" id="fab-customers" onclick="openAddCustomerModal()" style="display: none;" title="Add Customer">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
    </main>

  </div>

  <!-- Lead Detail Modal - Modern Sheet Style -->
  <div class="modal-modern-overlay" id="lead-modal" onclick="if(event.target === this) closeLeadModal()">
    <div class="modal-modern" style="max-width: 500px;">
      <div class="modal-drag-handle"></div>
      <div class="modal-modern-header">
        <h2>Lead Details</h2>
        <button class="btn-icon" onclick="closeLeadModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-modern-body" id="lead-details"></div>

      <!-- Linked Estimates Section -->
      <div class="detail-section" style="padding: 0 24px 16px;">
        <div class="detail-section-title">Linked Estimates</div>
        <div id="lead-estimates-list" class="list-modern">
          <div style="padding: 16px; color: var(--text-muted); font-size: 13px; text-align: center;">No estimates yet</div>
        </div>
      </div>

      <!-- Messages Section -->
      <div class="detail-section" style="padding: 0 24px 16px;">
        <div class="detail-section-title" style="display: flex; justify-content: space-between; align-items: center;">
          <span> Messages & Comments</span>
          <span id="lead-unread-badge" style="display: none; background: var(--gold-primary); color: var(--dark-bg); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">0 new</span>
        </div>
        <div id="lead-messages-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 12px;">
          <div style="padding: 16px; color: var(--text-muted); font-size: 13px; text-align: center;">No messages yet</div>
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="lead-message-input" placeholder="Type a reply..." class="input-modern" style="flex: 1; padding: 10px 14px; font-size: 14px;">
          <button class="btn-modern primary" onclick="sendLeadReply()" style="padding: 10px 16px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
          </button>
        </div>
      </div>

      <!-- Quick Actions Grid -->
      <div style="padding: 0 24px 16px;">
        <div class="detail-section-title">Status</div>
        <select class="input-modern select-modern" id="lead-status-select" onchange="updateLeadStatus()" style="margin-bottom: 16px;">
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="quoted">Quoted</option>
          <option value="won">Won - Converted</option>
          <option value="lost">Lost</option>
        </select>

        <div class="detail-section-title">Actions</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
          <button class="btn-modern primary" onclick="scheduleWorkflowForLead()" style="grid-column: span 2; background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Schedule Project Workflow
          </button>
          <button class="btn-modern secondary" onclick="scheduleAppointmentForLead()" style="grid-column: span 2;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            Quick Single Event
          </button>
          <button class="btn-modern secondary" onclick="convertLeadToCustomer()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            Add Customer
          </button>
          <button class="btn-modern secondary" onclick="createEstimateFromLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Create Estimate
          </button>
          <button class="btn-modern secondary" onclick="createDesignFromLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
            Create Design
          </button>
          <button class="btn-modern secondary" onclick="inviteLeadAsCollaborator()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            Invite to Project
          </button>
          <button class="btn-modern secondary" onclick="createProjectFromLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            Create Project
          </button>
          <button class="btn-modern secondary" onclick="sendInvoiceToLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            Send Invoice
          </button>
          <button class="btn-modern ghost" onclick="archiveLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
            Archive
          </button>
        </div>
      </div>

      <div class="modal-modern-footer">
        <button class="btn-modern danger" onclick="deleteLead()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          Delete Lead
        </button>
      </div>
    </div>
  </div>

  <!-- Add New Lead Modal -->
  <div class="modal-overlay" id="add-lead-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Add New Lead</h2>
        <button class="modal-close" onclick="closeAddLeadModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="add-lead-form" onsubmit="saveNewLead(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" id="new-lead-first-name" required placeholder="John"/>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" id="new-lead-last-name" required placeholder="Smith"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="new-lead-email" required placeholder="john@example.com"/>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="new-lead-phone" placeholder="(555) 123-4567"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Project Type</label>
              <select id="new-lead-project-type">
                <option value="">Select Type</option>
                <option value="kitchen">Kitchen Countertops</option>
                <option value="bathroom">Bathroom Vanity</option>
                <option value="flooring">Flooring</option>
                <option value="fireplace">Fireplace</option>
                <option value="outdoor">Outdoor Kitchen</option>
                <option value="commercial">Commercial</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>ZIP Code</label>
              <input type="text" id="new-lead-zip" placeholder="85374" maxlength="5"/>
            </div>
          </div>

          <!-- Billing Address Section -->
          <div class="form-section" style="margin: 20px 0; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#f9cb00" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span style="font-size: 13px; font-weight: 600; color: #f9cb00; text-transform: uppercase; letter-spacing: 0.5px;">Billing Address</span>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Street Address</label>
                <input type="text" id="new-lead-billing-street" placeholder="123 Main St"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>Unit/Apt</label>
                <input type="text" id="new-lead-billing-street2" placeholder="Apt 4B"/>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>City</label>
                <input type="text" id="new-lead-billing-city" placeholder="Surprise"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>State</label>
                <select id="new-lead-billing-state">
                  <option value="AZ" selected>AZ</option>
                  <option value="CA">CA</option>
                  <option value="CO">CO</option>
                  <option value="NV">NV</option>
                  <option value="NM">NM</option>
                  <option value="TX">TX</option>
                  <option value="UT">UT</option>
                </select>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>ZIP</label>
                <input type="text" id="new-lead-billing-zip" placeholder="85374" maxlength="5"/>
              </div>
            </div>
          </div>

          <!-- Address Same Toggle -->
          <div class="form-group" style="margin: 16px 0; padding: 12px 16px; background: rgba(249,203,0,0.05); border: 1px solid rgba(249,203,0,0.2); border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
              <input type="checkbox" id="new-lead-address-same" checked onchange="toggleNewLeadServiceAddress()" style="width: 18px; height: 18px; accent-color: #f9cb00;"/>
              <span style="font-size: 14px;">Service address is the same as billing address</span>
            </label>
          </div>

          <!-- Service Address Section (hidden by default) -->
          <div id="new-lead-service-address-section" style="display: none; margin: 20px 0; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#f9cb00" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              <span style="font-size: 13px; font-weight: 600; color: #f9cb00; text-transform: uppercase; letter-spacing: 0.5px;">Service Address</span>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Street Address</label>
                <input type="text" id="new-lead-service-street" placeholder="456 Project Ave"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>Unit/Apt</label>
                <input type="text" id="new-lead-service-street2" placeholder=""/>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>City</label>
                <input type="text" id="new-lead-service-city" placeholder="Surprise"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>State</label>
                <select id="new-lead-service-state">
                  <option value="AZ" selected>AZ</option>
                  <option value="CA">CA</option>
                  <option value="CO">CO</option>
                  <option value="NV">NV</option>
                  <option value="NM">NM</option>
                  <option value="TX">TX</option>
                  <option value="UT">UT</option>
                </select>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>ZIP</label>
                <input type="text" id="new-lead-service-zip" placeholder="85374" maxlength="5"/>
              </div>
            </div>
          </div>

          <!-- Appointment Scheduling Section -->
          <div class="form-section" style="margin: 20px 0; padding: 16px; background: rgba(34,197,94,0.05); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#22c55e" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span style="font-size: 13px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px;">Schedule Appointment (Optional)</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Appointment Date</label>
                <input type="date" id="new-lead-appt-date" min="" style="color-scheme: dark;"/>
              </div>
              <div class="form-group">
                <label>Appointment Time</label>
                <select id="new-lead-appt-time">
                  <option value="">Select Time</option>
                  <option value="8:00 AM">8:00 AM</option>
                  <option value="9:00 AM">9:00 AM</option>
                  <option value="10:00 AM">10:00 AM</option>
                  <option value="11:00 AM">11:00 AM</option>
                  <option value="12:00 PM">12:00 PM</option>
                  <option value="1:00 PM">1:00 PM</option>
                  <option value="2:00 PM">2:00 PM</option>
                  <option value="3:00 PM">3:00 PM</option>
                  <option value="4:00 PM">4:00 PM</option>
                  <option value="5:00 PM">5:00 PM</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label>Appointment Type</label>
              <select id="new-lead-appt-type">
                <option value="estimate">Free In-Home Estimate</option>
                <option value="measure">Measurement Visit</option>
                <option value="showroom">Showroom Visit</option>
                <option value="consultation">Design Consultation</option>
                <option value="installation">Installation</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Project Details / Notes</label>
            <textarea id="new-lead-message" rows="3" placeholder="Describe the project or add notes..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Lead Source</label>
              <select id="new-lead-source">
                <option value="phone">Phone Call</option>
                <option value="walk-in">Walk-in</option>
                <option value="referral">Referral</option>
                <option value="website">Website</option>
                <option value="social">Social Media</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="new-lead-status">
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="qualified">Qualified</option>
                <option value="quoted">Quoted</option>
                <option value="won">Won</option>
                <option value="lost">Lost</option>
                <option value="archived">Archived</option>
              </select>
            </div>
          </div>

          <!-- Welcome Email Toggle -->
          <div class="form-group" style="margin: 16px 0; padding: 12px 16px; background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
              <input type="checkbox" id="new-lead-send-email" checked style="width: 18px; height: 18px; accent-color: #3b82f6;"/>
              <div>
                <span style="font-size: 14px; font-weight: 500;">Send welcome email to lead</span>
                <p style="font-size: 12px; color: var(--text-muted); margin: 2px 0 0 0;">A friendly confirmation email will be sent automatically</p>
              </div>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeAddLeadModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="save-lead-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            Save Lead
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal-overlay" id="customer-modal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h2 class="modal-title" id="customer-detail-modal-title">Customer Details</h2>
        <button class="modal-close" onclick="closeCustomerModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Customer Info Section -->
        <div id="customer-info" style="margin-bottom: 24px;"></div>

        <!-- Tabs -->
        <div class="customer-tabs" style="display: flex; gap: 8px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 16px; flex-wrap: wrap;">
          <button class="tab-btn active" onclick="showCustomerTab('jobs')" data-tab="jobs">Jobs</button>
          <button class="tab-btn" onclick="showCustomerTab('estimates')" data-tab="estimates">Estimates</button>
          <button class="tab-btn" onclick="showCustomerTab('invoices')" data-tab="invoices">Invoices</button>
          <button class="tab-btn" onclick="showCustomerTab('favorites')" data-tab="favorites">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            Favorites
          </button>
          <button class="tab-btn" onclick="showCustomerTab('messages')" data-tab="messages">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
            Messages
          </button>
          <button class="tab-btn" onclick="showCustomerTab('notes')" data-tab="notes">Notes</button>
        </div>

        <!-- Tab Content -->
        <div id="customer-tab-content">
          <div class="empty-state">
            <div class="spinner"></div>
            <p>Loading...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modern secondary" onclick="editCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
          Edit Customer
        </button>
        <button class="btn-modern primary" onclick="createJobForCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          New Job
        </button>
        <button class="btn-modern primary" onclick="createEstimateForCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          New Estimate
        </button>
        <button class="btn-modern secondary" onclick="scheduleAppointmentForCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Schedule
        </button>
        <button class="btn-modern secondary" onclick="inviteCustomerToProject()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
          Invite to Project
        </button>
        <div style="flex: 1;"></div>
        <button class="btn-modern danger" onclick="deleteCustomer()" style="background: #dc2626;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Customer Modal -->
  <div class="modal-overlay" id="edit-customer-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title" id="edit-customer-title">Add Customer</h2>
        <button class="modal-close" onclick="closeEditCustomerModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="edit-customer-form" onsubmit="saveCustomerForm(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="customer-name" required placeholder="John Smith"/>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="customer-email" placeholder="john@example.com"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="customer-phone" placeholder="(555) 123-4567"/>
            </div>
            <div class="form-group">
              <label>Source</label>
              <select id="customer-source">
                <option value="">Select Source</option>
                <option value="website">Website</option>
                <option value="referral">Referral</option>
                <option value="google">Google</option>
                <option value="walk-in">Walk-in</option>
                <option value="phone">Phone Call</option>
                <option value="social">Social Media</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Address</label>
            <input type="text" id="customer-address" placeholder="123 Main Street"/>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="customer-city" placeholder="Surprise"/>
            </div>
            <div class="form-group" style="width: 100px;">
              <label>State</label>
              <input type="text" id="customer-state" placeholder="AZ" maxlength="2"/>
            </div>
            <div class="form-group" style="width: 120px;">
              <label>ZIP</label>
              <input type="text" id="customer-zip" placeholder="85374"/>
            </div>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea id="customer-notes" rows="3" placeholder="Additional notes about this customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeEditCustomerModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="save-customer-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            Save Customer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal-overlay" id="product-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="product-modal-title">Add New Product</h2>
        <button class="modal-close" onclick="closeProductModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="product-form" onsubmit="saveProduct(event)">
        <input type="hidden" id="product-id">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="product-name" required placeholder="e.g., Calacatta Gold Marble Slab"/>
            </div>
            <div class="form-group">
              <label>SKU</label>
              <input type="text" id="product-sku" placeholder="e.g., CAL-GOLD-001"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Vendor</label>
              <input type="text" id="product-vendor" placeholder="e.g., MSI, Daltile"/>
            </div>
            <div class="form-group">
              <label>Product Type</label>
              <select id="product-type">
                <option value="">Select Type</option>
                <option value="granite">Granite</option>
                <option value="marble">Marble</option>
                <option value="quartz">Quartz</option>
                <option value="quartzite">Quartzite</option>
                <option value="porcelain">Porcelain</option>
                <option value="soapstone">Soapstone</option>
                <option value="remnant">Remnant</option>
                <option value="tile">Tile</option>
                <option value="sink">Sink</option>
                <option value="faucet">Faucet</option>
                <option value="accessory">Accessory</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="product-description" rows="3" placeholder="Describe your product..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price ($) *</label>
              <input type="number" id="product-price" required min="0" step="0.01" placeholder="0.00"/>
            </div>
            <div class="form-group">
              <label>Compare at Price ($)</label>
              <input type="number" id="product-compare-price" min="0" step="0.01" placeholder="Original price"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Cost Price ($)</label>
              <input type="number" id="product-cost" min="0" step="0.01" placeholder="Your cost"/>
            </div>
            <div class="form-group">
              <label>Stock Quantity</label>
              <input type="number" id="product-stock" min="0" value="1" placeholder="1"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Status</label>
              <select id="product-status">
                <option value="draft">Draft</option>
                <option value="active">Active</option>
                <option value="discontinued">Discontinued</option>
                <option value="archived">Archived</option>
              </select>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; margin-top: 28px;">
                <input type="checkbox" id="product-dropship" style="accent-color: var(--gold-primary); width: 18px; height: 18px;">
                Dropship Item
              </label>
            </div>
          </div>

          <div class="form-group" id="product-supplier-group" style="display: none;">
            <label>Supplier Name</label>
            <input type="text" id="product-supplier" placeholder="Supplier for dropship"/>
          </div>

          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="product-image-url" placeholder="https://example.com/image.jpg"/>
            <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
              Paste a direct link to your product image
            </small>
          </div>

          <div class="form-group">
            <label>Tags (comma separated)</label>
            <input type="text" id="product-tags" placeholder="e.g., sale, featured, new"/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeProductModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="product-save-btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Products Modal -->
  <div class="modal-overlay" id="import-modal" onclick="if(event.target === this) closeImportModal()">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title">Import Products</h2>
        <button class="modal-close" onclick="closeImportModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Step 1: File Upload -->
        <div id="import-step-1">
          <div style="border: 2px dashed var(--border-subtle); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 20px; transition: all 0.2s;" id="import-dropzone">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 16px;">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <h3 style="margin-bottom: 8px;">Drop your file here</h3>
            <p style="color: var(--text-muted); margin-bottom: 16px;">or click to browse</p>
            <input type="file" id="import-file-input" accept=".csv,.pdf,.xlsx,.xls" style="display: none;" onchange="handleImportFile(this.files[0])">
            <button type="button" class="btn-modern secondary" onclick="document.getElementById('import-file-input').click()">
              Choose File
            </button>
            <p style="color: var(--text-muted); font-size: 13px; margin-top: 16px;">
              Supported formats: CSV, PDF, Excel (.xlsx, .xls)
            </p>
          </div>

          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
            <h4 style="margin-bottom: 12px; font-size: 14px;">Expected CSV Format</h4>
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 12px;">
              Your CSV should have headers. Common column names will be auto-mapped:
            </p>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">name/title/product</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">sku/item_number</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">price/cost/retail</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">vendor/supplier/brand</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">quantity/stock/qty</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">description/desc</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">type/category</span>
              <span style="background: var(--dark-surface); padding: 4px 10px; border-radius: 6px; font-size: 12px; font-family: monospace;">image/image_url</span>
            </div>
          </div>
        </div>

        <!-- Step 2: Column Mapping -->
        <div id="import-step-2" style="display: none;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <h3 style="margin-bottom: 4px;">Map Columns</h3>
              <p style="color: var(--text-muted); font-size: 14px;" id="import-file-info">0 rows detected</p>
            </div>
            <button type="button" class="btn-modern secondary" onclick="resetImport()" style="padding: 8px 16px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
              Start Over
            </button>
          </div>

          <div style="max-height: 300px; overflow-y: auto; background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
            <div id="import-mapping-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;"></div>
          </div>

          <div style="margin-top: 20px; padding: 16px; background: var(--dark-elevated); border-radius: 10px;">
            <h4 style="margin-bottom: 12px; font-size: 14px;">Import Options</h4>
            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
              <input type="checkbox" id="import-update-existing" style="accent-color: var(--gold-primary); width: 18px; height: 18px;">
              <span>Update existing products (match by SKU)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="import-set-active" checked style="accent-color: var(--gold-primary); width: 18px; height: 18px;">
              <span>Set imported products as Active</span>
            </label>
          </div>

          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 12px; font-size: 14px;">Preview (first 5 rows)</h4>
            <div style="overflow-x: auto; background: var(--dark-elevated); border-radius: 10px;">
              <table id="import-preview-table" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead id="import-preview-head"></thead>
                <tbody id="import-preview-body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Step 3: Importing -->
        <div id="import-step-3" style="display: none; text-align: center; padding: 40px;">
          <div class="spinner" style="margin: 0 auto 20px;"></div>
          <h3 id="import-progress-title">Importing products...</h3>
          <p id="import-progress-text" style="color: var(--text-muted);">0 of 0 products imported</p>
          <div style="width: 100%; max-width: 400px; height: 8px; background: var(--dark-elevated); border-radius: 4px; margin: 20px auto; overflow: hidden;">
            <div id="import-progress-bar" style="width: 0%; height: 100%; background: var(--gold-primary); transition: width 0.3s;"></div>
          </div>
        </div>

        <!-- Step 4: Complete -->
        <div id="import-step-4" style="display: none; text-align: center; padding: 40px;">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" style="margin-bottom: 20px;">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
            <polyline points="22 4 12 14.01 9 11.01"/>
          </svg>
          <h3 style="margin-bottom: 8px;">Import Complete!</h3>
          <p id="import-complete-text" style="color: var(--text-muted); margin-bottom: 20px;">0 products imported successfully</p>
          <button type="button" class="btn-modern primary" onclick="closeImportModal()">Done</button>
        </div>
      </div>

      <div class="modal-footer" id="import-footer">
        <button type="button" class="btn-modern secondary" onclick="closeImportModal()">Cancel</button>
        <button type="button" class="btn-modern primary" id="import-btn" onclick="startImport()" disabled>
          Import Products
        </button>
      </div>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal-overlay" id="invoice-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Invoice</h2>
        <button class="modal-close" onclick="closeInvoiceModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="invoice-form" onsubmit="createInvoice(event)">
        <div class="modal-body">
          <h4 style="margin-bottom: 16px; color: var(--text-secondary);">Customer Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Customer Email *</label>
              <input type="email" id="invoice-email" required placeholder="customer@example.com"/>
            </div>
            <div class="form-group">
              <label>Customer Name</label>
              <input type="text" id="invoice-name" placeholder="John Smith"/>
            </div>
          </div>
          <div class="form-group">
            <label>Customer Phone</label>
            <input type="tel" id="invoice-phone" placeholder="(555) 123-4567"/>
          </div>

          <h4 style="margin: 24px 0 16px; color: var(--text-secondary);">Invoice Items</h4>
          <div id="invoice-items">
            <div class="invoice-item" data-index="0">
              <div class="form-row" style="align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                  <label>Description *</label>
                  <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Qty</label>
                  <input type="number" class="item-qty" value="1" min="1"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Amount ($) *</label>
                  <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00"/>
                </div>
                <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
          <button type="button" class="btn-modern secondary" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Line Item
          </button>

          <div class="form-row">
            <div class="form-group">
              <label>Due In (Days)</label>
              <select id="invoice-due-days">
                <option value="7">7 days</option>
                <option value="14">14 days</option>
                <option value="30" selected>30 days</option>
                <option value="60">60 days</option>
              </select>
            </div>
            <div class="form-group">
              <label>Invoice Total</label>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary); padding: 10px 0;" id="invoice-total">$0.00</div>
            </div>
          </div>

          <div class="form-group">
            <label>Email Template</label>
            <div class="template-selector">
              <label class="template-option">
                <input type="radio" name="invoice-template" value="classic" checked>
                <div class="template-preview classic-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Classic</span>
                  <span class="template-desc">Professional & Clean</span>
                </div>
              </label>
              <label class="template-option">
                <input type="radio" name="invoice-template" value="modern">
                <div class="template-preview modern-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Modern</span>
                  <span class="template-desc">Minimal & Elegant</span>
                </div>
              </label>
              <label class="template-option">
                <input type="radio" name="invoice-template" value="premium">
                <div class="template-preview premium-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Premium</span>
                  <span class="template-desc">Luxury Dark Theme</span>
                </div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea id="invoice-notes" rows="2" placeholder="Add any additional notes for the customer..."></textarea>
          </div>

          <h4 style="margin: 24px 0 16px; color: var(--text-secondary);">Email Options</h4>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
              <input type="checkbox" id="invoice-cc-me" checked style="width: 18px; height: 18px;">
              <span>Send me a copy (CC)</span>
            </label>
          </div>
          <div class="form-group">
            <label>Additional CC (Optional)</label>
            <input type="email" id="invoice-cc-other" placeholder="another@email.com"/>
          </div>
        </div>
        <div class="modal-footer" style="gap: 10px;">
          <button type="button" class="btn-modern secondary" onclick="closeInvoiceModal()">Cancel</button>
          <button type="button" class="btn-modern secondary" onclick="saveInvoiceDraft()" id="invoice-draft-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            Save Draft
          </button>
          <button type="button" class="btn-modern primary" onclick="previewInvoice()" id="invoice-preview-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            Preview & Send
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Pay Modal -->
  <div class="modal-overlay" id="quick-pay-modal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
        <h2 class="modal-title" style="color: white;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg>
          Quick Pay Link
        </h2>
        <button class="modal-close" onclick="closeQuickPayModal()" style="color: white;">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Form State -->
        <div id="quick-pay-form-state">
          <form id="quick-pay-form" onsubmit="return generateQuickPayLink(event)">
            <div class="form-group">
              <label>Customer Name *</label>
              <input type="text" id="qp-name" required placeholder="John Smith">
            </div>
            <div class="form-group">
              <label>Customer Email *</label>
              <input type="email" id="qp-email" required placeholder="customer@email.com">
            </div>
            <div class="form-group">
              <label>Customer Phone (for SMS)</label>
              <input type="tel" id="qp-phone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
              <label>Amount ($) *</label>
              <input type="number" id="qp-amount" required min="1" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
              <label>Description</label>
              <input type="text" id="qp-description" placeholder="e.g., Deposit for Kitchen Countertops">
            </div>
            <div class="modal-footer" style="padding: 0; margin-top: 20px;">
              <button type="button" class="btn-modern secondary" onclick="closeQuickPayModal()">Cancel</button>
              <button type="submit" class="btn-modern primary" id="qp-generate-btn" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                Generate Link
              </button>
            </div>
          </form>
        </div>

        <!-- Result State (hidden initially) -->
        <div id="quick-pay-result-state" style="display: none;">
          <div style="text-align: center; padding: 20px 0;">
            <div style="background: #f0fdf4; border: 2px solid #22c55e; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="#22c55e" stroke-width="2" style="margin-bottom: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <h3 style="color: #166534; margin: 0;">Payment Link Created!</h3>
            </div>

            <div style="margin-bottom: 24px;">
              <p style="margin: 0 0 8px; color: var(--text-muted); font-size: 13px;">For: <strong id="qp-result-name"></strong></p>
              <p style="margin: 0; font-size: 28px; font-weight: 700; color: var(--gold-primary);" id="qp-result-amount"></p>
            </div>

            <!-- QR Code -->
            <div id="qp-qr-container" style="background: white; padding: 20px; border-radius: 12px; display: inline-block; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <img id="qp-qr-code" src="" alt="Payment QR Code" style="width: 180px; height: 180px;">
              <p style="margin: 12px 0 0; font-size: 11px; color: #666;">Scan to pay</p>
            </div>

            <!-- Payment Link -->
            <div style="background: var(--dark-surface); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
              <input type="text" id="qp-link-display" readonly style="width: 100%; background: transparent; border: none; color: var(--text-primary); font-size: 12px; text-align: center;">
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="btn-modern secondary" onclick="copyQuickPayLink()" style="flex: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Copy Link
              </button>
              <button class="btn-modern secondary" onclick="sendQuickPayEmail()" style="flex: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Send Email
              </button>
              <button class="btn-modern secondary" onclick="sendQuickPaySMS()" style="flex: 1;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                Send SMS
              </button>
            </div>

            <div style="margin-top: 20px;">
              <button class="btn-modern primary" onclick="resetQuickPayModal()" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Create Another
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Template Preview Modal -->
  <div class="modal-overlay" id="template-preview-modal">
    <div class="modal" style="max-width: 1200px; max-height: 90vh;">
      <div class="modal-header">
        <h2 class="modal-title">Invoice Email Templates</h2>
        <button class="modal-close" onclick="closeTemplatePreview()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="padding: 0; overflow: hidden;">
        <div class="template-tabs">
          <button class="template-tab active" data-template="classic" onclick="showTemplatePreview('classic')">
            <span class="tab-icon"></span>
            <span class="tab-label">Classic</span>
            <span class="tab-desc">Professional & Clean</span>
          </button>
          <button class="template-tab" data-template="modern" onclick="showTemplatePreview('modern')">
            <span class="tab-icon"></span>
            <span class="tab-label">Modern</span>
            <span class="tab-desc">Minimal & Elegant</span>
          </button>
          <button class="template-tab" data-template="premium" onclick="showTemplatePreview('premium')">
            <span class="tab-icon"></span>
            <span class="tab-label">Premium</span>
            <span class="tab-desc">Luxury Dark Theme</span>
          </button>
        </div>
        <div class="template-preview-container">
          <div class="template-preview-frame" id="template-frame-classic" style="display: block;">
            <iframe id="preview-iframe-classic" srcdoc=""></iframe>
          </div>
          <div class="template-preview-frame" id="template-frame-modern" style="display: none;">
            <iframe id="preview-iframe-modern" srcdoc=""></iframe>
          </div>
          <div class="template-preview-frame" id="template-frame-premium" style="display: none;">
            <iframe id="preview-iframe-premium" srcdoc=""></iframe>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <p style="color: var(--text-muted); font-size: 13px; margin: 0;">Select a template when creating an invoice</p>
        <button class="btn-modern primary" onclick="closeTemplatePreview(); openInvoiceModal();">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Create New Invoice
        </button>
      </div>
    </div>
  </div>

  <!-- Create Listing Modal -->
  <div id="create-listing-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateListingModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Listing</h2>
        <button class="modal-close" onclick="closeCreateListingModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="create-listing-form" onsubmit="return handleCreateListing(event)">
          <!-- Category Selection -->
          <div class="form-section">
            <div class="form-section-title">What are you listing?</div>
            <div class="listing-category-grid" id="listing-category-grid">
              <div class="listing-category-option selected" data-category="countertops" onclick="selectListingCategory('countertops')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M5 12v6M19 12v6M8 8V5a1 1 0 011-1h6a1 1 0 011 1v3"/></svg>
                <span>Countertops</span>
                <small>Granite, Marble, Quartz</small>
              </div>
              <div class="listing-category-option" data-category="tile" onclick="selectListingCategory('tile')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="3" width="8" height="8" rx="1"/><rect x="3" y="13" width="8" height="8" rx="1"/><rect x="13" y="13" width="8" height="8" rx="1"/></svg>
                <span>Tile</span>
                <small>Ceramic, Porcelain, Natural</small>
              </div>
              <div class="listing-category-option" data-category="flooring" onclick="selectListingCategory('flooring')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M3 21h18M3 21V8l4-4h10l4 4v13M7 21v-8h10v8M7 13h10"/></svg>
                <span>Flooring</span>
                <small>Hardwood, LVP, Laminate</small>
              </div>
              <div class="listing-category-option" data-category="cabinets" onclick="selectListingCategory('cabinets')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="3" y1="12" x2="21" y2="12"/><circle cx="8" cy="8" r="1"/><circle cx="16" cy="8" r="1"/><circle cx="8" cy="16" r="1"/><circle cx="16" cy="16" r="1"/></svg>
                <span>Cabinets</span>
                <small>Kitchen, Bath, Storage</small>
              </div>
              <div class="listing-category-option" data-category="supplies" onclick="selectListingCategory('supplies')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <span>Supplies</span>
                <small>Tools, Adhesives, Sealers</small>
              </div>
              <div class="listing-category-option" data-category="other" onclick="selectListingCategory('other')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 8v4M12 16h.01"/></svg>
                <span>Other</span>
                <small>Fixtures, Hardware, etc.</small>
              </div>
            </div>
            <input type="hidden" id="listing-category" value="countertops">
          </div>

          <!-- Product Selection (dynamic based on category) -->
          <div class="form-section" id="product-selection-section">
            <div class="form-section-title" id="product-selection-title">Select Product</div>
            <div class="form-group stone-autocomplete">
              <label id="product-search-label">Search our catalog (optional)</label>
              <input type="text" id="listing-stone-search" placeholder="Start typing product name..." autocomplete="off">
              <div id="stone-autocomplete-results" class="stone-autocomplete-results"></div>
              <input type="hidden" id="listing-stone-slug">
              <input type="hidden" id="listing-stone-name">
              <input type="hidden" id="listing-material-type">
              <input type="hidden" id="listing-brand">
              <input type="hidden" id="listing-color">
            </div>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Link to our catalog so buyers can see the full product details, or skip to create a custom listing.</p>
            <div id="selected-stone-preview" style="display: none; margin-top: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <img id="selected-stone-img" src="" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">
                <div>
                  <div id="selected-stone-name" style="font-weight: 600; color: var(--text-primary);"></div>
                  <div id="selected-stone-meta" style="font-size: 12px; color: var(--text-muted);"></div>
                </div>
                <button type="button" onclick="clearSelectedStone()" style="margin-left: auto; background: none; border: none; color: var(--error); cursor: pointer;">Clear</button>
              </div>
            </div>
          </div>

          <!-- Listing Details -->
          <div class="form-section">
            <div class="form-section-title">Listing Details</div>
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="listing-title" placeholder="e.g., Calacatta Gold Remnant 24x36, White Subway Tile 200 sqft" required>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="listing-description" rows="3" placeholder="Describe your item - condition, origin, why selling, any defects, etc."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Condition</label>
                <select id="listing-condition">
                  <option value="new">New / Unused</option>
                  <option value="remnant">Remnant / Leftover</option>
                  <option value="overstock">Overstock</option>
                  <option value="used">Used / Reclaimed</option>
                  <option value="refurbished">Refurbished</option>
                </select>
              </div>
              <div class="form-group">
                <label>Brand (optional)</label>
                <input type="text" id="listing-brand-input" placeholder="e.g., MSI, Daltile, Shaw">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Dimensions / Size</label>
                <input type="text" id="listing-dimensions" placeholder="e.g., 24x36 in, 200 sqft, 10x20 cm">
              </div>
              <div class="form-group" id="thickness-group">
                <label>Thickness</label>
                <select id="listing-thickness">
                  <option value="">Select...</option>
                  <option value="2cm">2cm (3/4")</option>
                  <option value="3cm">3cm (1 1/4")</option>
                  <option value="1cm">1cm (3/8")</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="listing-quantity" value="1" min="1">
              </div>
              <div class="form-group">
                <label>Price ($)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" id="listing-price" placeholder="0.00" step="0.01" min="0" style="flex: 1;">
                  <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; white-space: nowrap;">
                    <input type="checkbox" id="listing-price-contact" onchange="togglePriceField()">
                    Contact for price
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="form-section">
            <div class="form-section-title">Images (up to 4)</div>

            <!-- Image Upload Area -->
            <div class="image-upload-section">
              <div class="image-upload-grid" id="image-upload-grid">
                <!-- Image Slot 1 -->
                <div class="image-upload-slot" id="image-slot-1" onclick="triggerImageUpload(1)">
                  <input type="file" id="image-file-1" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(1, this)">
                  <input type="hidden" id="listing-image-1">
                  <div class="upload-placeholder" id="upload-placeholder-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Add Photo</span>
                  </div>
                  <img id="image-preview-1" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-1" onclick="removeImage(event, 1)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-1" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-1"></div>
                  </div>
                </div>

                <!-- Image Slot 2 -->
                <div class="image-upload-slot" id="image-slot-2" onclick="triggerImageUpload(2)">
                  <input type="file" id="image-file-2" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(2, this)">
                  <input type="hidden" id="listing-image-2">
                  <div class="upload-placeholder" id="upload-placeholder-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-2" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-2" onclick="removeImage(event, 2)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-2" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-2"></div>
                  </div>
                </div>

                <!-- Image Slot 3 -->
                <div class="image-upload-slot" id="image-slot-3" onclick="triggerImageUpload(3)">
                  <input type="file" id="image-file-3" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(3, this)">
                  <input type="hidden" id="listing-image-3">
                  <div class="upload-placeholder" id="upload-placeholder-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-3" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-3" onclick="removeImage(event, 3)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-3" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-3"></div>
                  </div>
                </div>

                <!-- Image Slot 4 -->
                <div class="image-upload-slot" id="image-slot-4" onclick="triggerImageUpload(4)">
                  <input type="file" id="image-file-4" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(4, this)">
                  <input type="hidden" id="listing-image-4">
                  <div class="upload-placeholder" id="upload-placeholder-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-4" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-4" onclick="removeImage(event, 4)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-4" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-4"></div>
                  </div>
                </div>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; text-align: center;">
                Tap to take a photo or upload from your gallery. First image will be the main photo.
              </p>
            </div>
          </div>

          <!-- Location -->
          <div class="form-section">
            <div class="form-section-title">Location</div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="listing-city" placeholder="Phoenix">
              </div>
              <div class="form-group">
                <label>State</label>
                <select id="listing-state">
                  <option value="">Select State...</option>
                  <option value="AZ">Arizona</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="NV">Nevada</option>
                  <option value="NM">New Mexico</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>ZIP Code</label>
              <input type="text" id="listing-zip" placeholder="85374" maxlength="10">
            </div>
          </div>

          <!-- Contact Preferences -->
          <div class="form-section">
            <div class="form-section-title">Contact Preferences</div>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">How should interested buyers contact you?</p>

            <div class="contact-pref-item" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;" onclick="document.getElementById('listing-show-email').click()">
              <input type="checkbox" id="listing-show-email" style="width: 20px; height: 20px; accent-color: #f9cb00; cursor: pointer;">
              <span style="font-size: 14px; color: #ccc; text-transform: none;">Show my email address</span>
            </div>

            <div class="contact-pref-item" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;" onclick="document.getElementById('listing-show-phone').click()">
              <input type="checkbox" id="listing-show-phone" style="width: 20px; height: 20px; accent-color: #f9cb00; cursor: pointer;">
              <span style="font-size: 14px; color: #ccc; text-transform: none;">Show my phone number</span>
            </div>

            <div class="contact-pref-item" style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="document.getElementById('listing-contact-form').click()">
              <input type="checkbox" id="listing-contact-form" checked style="width: 20px; height: 20px; accent-color: #f9cb00; cursor: pointer;">
              <span style="font-size: 14px; color: #ccc; text-transform: none;">Allow contact through inquiry form</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeCreateListingModal()">Cancel</button>
        <button type="submit" form="create-listing-form" class="btn-modern primary" id="submit-listing-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        </button>
      </div>
    </div>
  </div>

  <!-- Create Estimate Modal - Professional Estimating System -->
  <div id="create-estimate-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateEstimateModal()">
    <div class="modal-content" style="max-width: 1100px; max-height: 95vh; overflow-y: auto;">
      <!-- Professional Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, rgba(249,203,0,0.15), rgba(249,203,0,0.05)); border-bottom: 2px solid var(--gold-primary); padding: 20px 24px;">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="width: 50px; height: 50px; background: var(--gold-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="#1a1a1a" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          </div>
          <div>
            <h2 class="modal-title" style="margin: 0; font-size: 22px;">Professional Estimate</h2>
            <div style="display: flex; align-items: center; gap: 16px; margin-top: 4px;">
              <span style="font-size: 13px; color: var(--text-muted);">Estimate #: <strong id="estimate-number-display" style="color: var(--gold-primary);">Loading...</strong></span>
              <span style="font-size: 13px; color: var(--text-muted);">Date: <strong id="estimate-date-display" style="color: #fff;"></strong></span>
            </div>
          </div>
        </div>
        <button class="modal-close" onclick="closeCreateEstimateModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="modal-body" style="padding: 0;">
        <form id="create-estimate-form" onsubmit="return handleCreateEstimate(event)">
          <!-- Two Column Layout for Customer & Project -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 1px solid var(--border-subtle);">
            <!-- Customer Information -->
            <div class="form-section" style="padding: 20px 24px; border-right: 1px solid var(--border-subtle); margin: 0;">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                Customer Information
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Customer Name *</label>
                <input type="text" id="estimate-customer-name" required placeholder="John Smith" style="font-size: 15px;">
              </div>
              <div class="form-row" style="gap: 12px; margin-bottom: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Email</label>
                  <input type="email" id="estimate-customer-email" placeholder="customer@email.com">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Phone</label>
                  <input type="tel" id="estimate-customer-phone" placeholder="(602) 555-1234">
                </div>
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Address</label>
                <input type="text" id="estimate-customer-address" placeholder="123 Main St">
              </div>
              <div class="form-row" style="gap: 12px;">
                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">City</label>
                  <input type="text" id="estimate-customer-city" placeholder="Phoenix">
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">State</label>
                  <input type="text" id="estimate-customer-state" placeholder="AZ" value="AZ">
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">ZIP</label>
                  <input type="text" id="estimate-customer-zip" placeholder="85001">
                </div>
              </div>
            </div>

            <!-- Project Details -->
            <div class="form-section" style="padding: 20px 24px; margin: 0;">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                Project Details
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Name</label>
                <input type="text" id="estimate-project-name" placeholder="Kitchen Countertop Installation" style="font-size: 15px;">
              </div>
              <div class="form-row" style="gap: 12px; margin-bottom: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Type</label>
                  <select id="estimate-project-type">
                    <option value="countertops">Countertops</option>
                    <option value="tile">Tile Installation</option>
                    <option value="flooring">Flooring</option>
                    <option value="bathroom">Bathroom Remodel</option>
                    <option value="kitchen">Kitchen Remodel</option>
                    <option value="custom">Custom Project</option>
                  </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Valid For (Days)</label>
                  <select id="estimate-valid-days" onchange="updateEstimateValidDate()">
                    <option value="15">15 Days</option>
                    <option value="30" selected>30 Days</option>
                    <option value="45">45 Days</option>
                    <option value="60">60 Days</option>
                    <option value="90">90 Days</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Scope of Work</label>
                <textarea id="estimate-project-desc" rows="3" placeholder="Describe the project scope, including measurements, materials, and work to be performed..." style="resize: vertical;"></textarea>
              </div>
              <input type="hidden" id="estimate-valid-until">
            </div>
          </div>

          <!-- Line Items Section with Categories -->
          <div class="form-section" style="padding: 20px 24px; margin: 0; border-bottom: 1px solid var(--border-subtle);">
            <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                Items & Services
              </div>
              <div style="display: flex; gap: 8px;">
                <button type="button" class="btn-modern secondary small" onclick="openCatalogPicker()" style="font-size: 12px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  From Catalog
                </button>
                <div class="dropdown" style="position: relative;">
                  <button type="button" class="btn-modern primary small" onclick="toggleAddItemMenu()" style="font-size: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    Add Item
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                  </button>
                  <div id="add-item-menu" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; min-width: 180px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <button type="button" onclick="addEstimateLineItem('material')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #3b82f6;"></span>
                      Material
                    </button>
                    <button type="button" onclick="addEstimateLineItem('labor')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span>
                      Labor
                    </button>
                    <button type="button" onclick="addEstimateLineItem('service')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #a855f7;"></span>
                      Service/Fee
                    </button>
                    <div style="border-top: 1px solid var(--border-subtle); margin: 4px 0;"></div>
                    <button type="button" onclick="addEstimateLineItem('other')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #6b7280;"></span>
                      Other
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Line Items Table Header -->
            <div style="display: grid; grid-template-columns: 30px 2fr 90px 70px 85px 85px 70px 90px 36px; gap: 6px; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 8px 8px 0 0; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600;">
              <span></span>
              <span>Description</span>
              <span>Unit</span>
              <span style="text-align: center;">Qty</span>
              <span style="text-align: right; color: rgba(59,130,246,0.8);" title="Your cost (internal only)">Cost</span>
              <span style="text-align: right;">Price</span>
              <span style="text-align: center; color: rgba(59,130,246,0.8);" title="Margin % (internal only)">Margin</span>
              <span style="text-align: right;">Total</span>
              <span></span>
            </div>

            <div id="estimate-line-items" style="min-height: 60px; border: 1px solid var(--border-subtle); border-top: none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.15);">
              <!-- Line items will be added here -->
              <div id="empty-line-items-msg" style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 13px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                <br>No items added yet. Click "Add Item" or "From Catalog" to begin.
              </div>
            </div>

            <!-- Hidden Template -->
            <div class="line-item-template" style="display: none;">
              <div class="estimate-line-item" data-category="material" style="display: grid; grid-template-columns: 30px 2fr 90px 70px 85px 85px 70px 90px 36px; gap: 6px; align-items: start; padding: 12px; border-bottom: 1px solid var(--border-subtle);">
                <div class="category-indicator" style="display: flex; align-items: center; justify-content: center; padding-top: 8px;">
                  <span class="category-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;" title="Material"></span>
                </div>
                <div>
                  <input type="text" class="item-name" placeholder="Item name" style="width: 100%; margin-bottom: 4px; font-weight: 500;">
                  <input type="text" class="item-desc" placeholder="Description or specifications" style="width: 100%; font-size: 12px; opacity: 0.7; padding: 6px 10px;">
                </div>
                <select class="item-unit" style="height: 38px;">
                  <option value="sqft">Sq Ft</option>
                  <option value="lnft">Ln Ft</option>
                  <option value="each">Each</option>
                  <option value="slab">Slab</option>
                  <option value="hour">Hour</option>
                  <option value="day">Day</option>
                  <option value="job">Flat Rate</option>
                </select>
                <input type="number" class="item-qty" placeholder="Qty" value="1" min="0" step="0.01" style="text-align: center;">
                <input type="number" class="item-cost" placeholder="Cost" value="" min="0" step="0.01" style="text-align: right; background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.3);" title="Your cost (internal only)">
                <input type="number" class="item-price" placeholder="Price" value="0" min="0" step="0.01" style="text-align: right;">
                <div class="item-margin" style="text-align: center; padding: 10px 4px; font-size: 12px; color: var(--text-muted); background: rgba(0,0,0,0.2); border-radius: 4px;" title="Margin % (internal only)">--%</div>
                <div class="item-total" style="text-align: right; padding: 10px 0; font-weight: 600; color: var(--gold-primary); font-size: 14px;">$0.00</div>
                <button type="button" class="btn-remove-item" onclick="removeEstimateLineItem(this)" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#6b7280'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
                <input type="hidden" class="item-category" value="material">
              </div>
            </div>
          </div>

          <!-- Totals & Payment Section -->
          <div style="display: grid; grid-template-columns: 1fr 400px; gap: 0; border-bottom: 1px solid var(--border-subtle);">
            <!-- Left: Notes Section -->
            <div class="form-section" style="padding: 20px 24px; margin: 0; border-right: 1px solid var(--border-subtle);">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Notes & Inclusions
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">This Estimate Includes</label>
                <textarea id="estimate-inclusions" rows="3" placeholder="- All materials as specified above&#10;- Professional installation&#10;- Cleanup and debris removal&#10;- 1-year workmanship warranty" style="font-size: 13px;"></textarea>
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">This Estimate Does NOT Include</label>
                <textarea id="estimate-exclusions" rows="2" placeholder="- Plumbing/electrical modifications&#10;- Structural changes&#10;- Permits (if required)" style="font-size: 13px;"></textarea>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Additional Notes</label>
                <textarea id="estimate-notes" rows="2" placeholder="Any additional notes for the customer..." style="font-size: 13px;"></textarea>
              </div>
            </div>

            <!-- Right: Totals -->
            <div class="form-section" style="padding: 20px 24px; margin: 0; background: rgba(0,0,0,0.15);">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Pricing Summary
              </div>
              <div class="estimate-totals" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Margin Summary (Internal Only) -->
                <div id="margin-summary" style="margin-bottom: 12px; padding: 12px; background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(59,130,246,0.9); font-weight: 600;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    Internal Only - Not shown to customer
                  </div>
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px;">
                    <span style="color: var(--text-muted);">Your Cost</span>
                    <span id="estimate-total-cost" style="font-weight: 500;">$0.00</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px;">
                    <span style="color: var(--text-muted);">Gross Profit</span>
                    <span id="estimate-total-profit" style="font-weight: 600; color: #22c55e;">$0.00</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; font-size: 14px; padding-top: 8px; border-top: 1px solid rgba(59,130,246,0.2);">
                    <span style="font-weight: 600; color: rgba(59,130,246,0.9);">Margin</span>
                    <span id="estimate-total-margin" style="font-weight: 700; color: #22c55e;">--%</span>
                  </div>
                </div>

                <!-- Category Subtotals -->
                <div id="category-subtotals" style="margin-bottom: 8px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle);">
                  <div class="category-subtotal" data-category="material" style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 6px; height: 6px; border-radius: 50%; background: #3b82f6;"></span>Materials</span>
                    <span id="subtotal-material">$0.00</span>
                  </div>
                  <div class="category-subtotal" data-category="labor" style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 6px; height: 6px; border-radius: 50%; background: #22c55e;"></span>Labor</span>
                    <span id="subtotal-labor">$0.00</span>
                  </div>
                  <div class="category-subtotal" data-category="service" style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 6px; height: 6px; border-radius: 50%; background: #a855f7;"></span>Services/Fees</span>
                    <span id="subtotal-service">$0.00</span>
                  </div>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                  <span>Subtotal</span>
                  <span id="estimate-subtotal" style="font-weight: 500;">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span>Tax</span>
                    <input type="number" id="estimate-tax-rate" value="0" min="0" max="100" step="0.01" style="width: 55px; text-align: center; padding: 4px; font-size: 12px;">
                    <span style="font-size: 12px;">%</span>
                  </div>
                  <span id="estimate-tax-amount">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span>Discount</span>
                    <input type="number" id="estimate-discount-value" value="0" min="0" step="0.01" style="width: 55px; text-align: center; padding: 4px; font-size: 12px;">
                    <select id="estimate-discount-type" style="padding: 4px; font-size: 12px;">
                      <option value="amount">$</option>
                      <option value="percent">%</option>
                    </select>
                  </div>
                  <span id="estimate-discount-amount" style="color: #22c55e;">-$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 14px 0; border-top: 2px solid var(--gold-primary); margin-top: 8px; font-size: 20px; font-weight: 700;">
                  <span>TOTAL</span>
                  <span id="estimate-total" style="color: var(--gold-primary);">$0.00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Schedule Section -->
          <div class="form-section" style="padding: 20px 24px; margin: 0; border-bottom: 1px solid var(--border-subtle);">
            <div class="form-section-title" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Payment Schedule
              </div>
              <select id="payment-schedule-type" onchange="updatePaymentSchedule()" style="padding: 6px 12px; font-size: 13px;">
                <option value="deposit-balance">Deposit + Balance</option>
                <option value="three-part">3-Part Payment</option>
                <option value="due-on-completion">Due on Completion</option>
                <option value="custom">Custom Schedule</option>
              </select>
            </div>

            <div id="payment-schedule-container">
              <!-- Default: Deposit + Balance -->
              <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div style="padding: 16px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">1. Deposit Required</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <input type="number" id="estimate-deposit-percent" value="50" min="0" max="100" style="width: 50px; text-align: center; padding: 4px; font-size: 13px;" onchange="updateEstimateTotals()">
                      <span style="font-size: 13px;">%</span>
                    </div>
                  </div>
                  <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
                  <div id="estimate-deposit-amount" style="font-size: 22px; font-weight: 700; color: var(--gold-primary);">$0.00</div>
                </div>
                <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">2. Balance Due</span>
                    <span id="estimate-balance-percent" style="font-size: 13px; color: var(--text-muted);">50%</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon completion</div>
                  <div id="estimate-balance-amount" style="font-size: 22px; font-weight: 700;">$0.00</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Terms & Conditions Section -->
          <div class="form-section" style="padding: 20px 24px; margin: 0;">
            <div class="form-section-title" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                Terms & Conditions
              </div>
              <button type="button" class="btn-modern secondary small" onclick="loadTermsTemplate()" style="font-size: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                Load Default Terms
              </button>
            </div>
            <div class="form-row" style="gap: 16px; margin-bottom: 16px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Warranty</label>
                <input type="text" id="estimate-warranty" placeholder="1 year workmanship warranty">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Estimated Timeline</label>
                <input type="text" id="estimate-timeline" placeholder="2-3 weeks from approval">
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Terms & Conditions</label>
              <textarea id="estimate-terms" rows="4" placeholder="Enter your standard terms and conditions..." style="font-size: 13px;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 0; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
              <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #93c5fd;">Internal Notes (Not shown to customer)</label>
              <textarea id="estimate-internal-notes" rows="2" placeholder="Private notes for your records..." style="font-size: 13px; background: transparent;"></textarea>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer with Actions -->
      <div class="modal-footer" style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="button" class="btn-modern secondary" onclick="closeCreateEstimateModal()">Cancel</button>
          <button type="button" class="btn-modern secondary" onclick="previewEstimate()" style="display: flex; align-items: center; gap: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            Preview
          </button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="button" class="btn-modern secondary" onclick="saveEstimateDraft()" style="display: flex; align-items: center; gap: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            Save Draft
          </button>
          <button type="submit" form="create-estimate-form" class="btn-modern primary" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            Create & Send Estimate
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Business Settings Modal -->
  <div id="business-settings-modal" class="modal-overlay" onclick="if(event.target === this) closeBusinessSettings()">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Business Settings</h2>
        <button class="modal-close" onclick="closeBusinessSettings()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="business-settings-form" onsubmit="return saveBusinessSettings(event)">
          <!-- Logo Upload Section -->
          <div class="form-section">
            <div class="form-section-title">Company Logo</div>
            <div style="display: flex; align-items: center; gap: 24px;">
              <div id="logo-preview" style="width: 120px; height: 120px; background: var(--dark-elevated); border: 2px dashed var(--border-subtle); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span id="logo-placeholder" style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 10px;">No logo<br>uploaded</span>
                <img id="logo-image" src="" alt="Company Logo" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
              </div>
              <div style="flex: 1;">
                <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                <button type="button" class="btn-modern secondary" onclick="document.getElementById('logo-upload').click()" style="margin-bottom: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                  Upload Logo
                </button>
                <button type="button" class="btn-modern secondary" onclick="removeLogo()" id="remove-logo-btn" style="display: none; margin-left: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  Remove
                </button>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Recommended: Square image, 200x200px or larger. PNG or JPG.</p>
                <input type="hidden" id="biz-logo-url" value="">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Company Information</div>
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="biz-company-name" placeholder="Your Company Name">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="biz-phone" placeholder="(602) 555-1234">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="biz-email" placeholder="info@company.com">
              </div>
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" id="biz-address" placeholder="123 Main St">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="biz-city" placeholder="Phoenix">
              </div>
              <div class="form-group" style="flex: 0.5;">
                <label>State</label>
                <input type="text" id="biz-state" placeholder="AZ">
              </div>
              <div class="form-group" style="flex: 0.5;">
                <label>ZIP</label>
                <input type="text" id="biz-zip" placeholder="85001">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>License Number</label>
                <input type="text" id="biz-license" placeholder="ROC #123456">
              </div>
              <div class="form-group">
                <label>Website</label>
                <input type="url" id="biz-website" placeholder="https://yoursite.com">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Default Settings</div>
            <div class="form-row">
              <div class="form-group">
                <label>Default Tax Rate (%)</label>
                <input type="number" id="biz-tax-rate" value="0" min="0" max="100" step="0.01">
              </div>
              <div class="form-group">
                <label>Default Deposit (%)</label>
                <input type="number" id="biz-deposit" value="50" min="0" max="100">
              </div>
            </div>
            <div class="form-group">
              <label>Default Payment Terms</label>
              <input type="text" id="biz-payment-terms" placeholder="50% deposit, balance due upon completion">
            </div>
            <div class="form-group">
              <label>Default Warranty</label>
              <input type="text" id="biz-warranty" placeholder="1 year workmanship warranty">
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Numbering</div>
            <div class="form-row">
              <div class="form-group">
                <label>Estimate Prefix</label>
                <input type="text" id="biz-estimate-prefix" value="EST-" maxlength="10">
              </div>
              <div class="form-group">
                <label>Invoice Prefix</label>
                <input type="text" id="biz-invoice-prefix" value="INV-" maxlength="10">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Terms & Conditions</div>
            <div class="form-group">
              <label>Default Terms & Conditions for Estimates</label>
              <textarea id="biz-estimate-terms" rows="4" placeholder="Enter your standard terms and conditions..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeBusinessSettings()">Cancel</button>
        <button type="submit" form="business-settings-form" class="btn-modern primary">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- New Job Modal -->
  <div id="new-job-modal" class="modal-overlay" onclick="if(event.target === this) closeNewJobModal()">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Job</h2>
        <button class="modal-close" onclick="closeNewJobModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="new-job-form" onsubmit="createJob(event)">
        <div class="modal-body">
          <div class="form-section">
            <div class="form-section-title">Customer Information</div>
            <div class="form-group">
              <label>Select Existing Customer or Create New</label>
              <select id="job-customer-select" onchange="toggleNewCustomerFields()">
                <option value="">-- Select Customer --</option>
                <option value="new">+ Add New Customer</option>
              </select>
            </div>
            <div id="new-customer-fields" style="display: none;">
              <div class="form-row">
                <div class="form-group">
                  <label>Customer Name *</label>
                  <input type="text" id="job-customer-name" placeholder="John Smith">
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="job-customer-email" placeholder="john@example.com">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" id="job-customer-phone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                  <label>Address</label>
                  <input type="text" id="job-customer-address" placeholder="123 Main St">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>City</label>
                  <input type="text" id="job-customer-city" placeholder="Phoenix">
                </div>
                <div class="form-group" style="flex: 0.5;">
                  <label>State</label>
                  <input type="text" id="job-customer-state" placeholder="AZ" maxlength="2">
                </div>
                <div class="form-group" style="flex: 0.5;">
                  <label>ZIP</label>
                  <input type="text" id="job-customer-zip" placeholder="85001">
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Job Details</div>
            <div class="form-group">
              <label>Job Title / Description *</label>
              <input type="text" id="job-title" required placeholder="Kitchen Countertop Installation">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Job Type</label>
                <select id="job-type">
                  <option value="installation">Installation</option>
                  <option value="fabrication">Fabrication</option>
                  <option value="repair">Repair</option>
                  <option value="template">Template/Measure</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Priority</label>
                <select id="job-priority">
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Total Amount ($)</label>
                <input type="number" id="job-total" step="0.01" min="0" placeholder="0.00">
              </div>
              <div class="form-group">
                <label>Deposit Received ($)</label>
                <input type="number" id="job-deposit" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea id="job-notes" rows="3" placeholder="Special instructions, material details, etc."></textarea>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Schedule (Optional)</div>
            <div class="form-row">
              <div class="form-group">
                <label>Scheduled Date</label>
                <input type="date" id="job-scheduled-date">
              </div>
              <div class="form-group">
                <label>Scheduled Time</label>
                <input type="time" id="job-scheduled-time">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeNewJobModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Create Job</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Schedule Modal (Calendar) -->
  <div id="quick-schedule-modal" class="modal-overlay" onclick="if(event.target === this) closeQuickScheduleModal()">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Quick Schedule</h2>
        <button class="modal-close" onclick="closeQuickScheduleModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="quick-schedule-form" onsubmit="submitQuickSchedule(event)">
        <div class="modal-body">
          <div class="form-group">
            <label>Event Type</label>
            <select id="schedule-event-type" class="input-modern" required onchange="toggleScheduleFields()">
              <option value="job">Job/Installation</option>
              <option value="measure">Field Measure</option>
              <option value="consultation">Consultation</option>
              <option value="followup">Follow-up</option>
            </select>
          </div>

          <div class="form-group">
            <label>Select Job (Optional)</label>
            <select id="schedule-job-select" class="input-modern">
              <option value="">-- Create New or Select Existing --</option>
            </select>
          </div>

          <div id="schedule-new-job-fields">
            <div class="form-group">
              <label>Customer *</label>
              <select id="schedule-customer-select" class="input-modern">
                <option value="">-- Select Customer --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Description *</label>
              <input type="text" id="schedule-description" class="input-modern" placeholder="Kitchen countertop install" required>
            </div>
          </div>

          <div class="form-row-modern">
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="schedule-date" class="input-modern" required>
            </div>
            <div class="form-group">
              <label>Time</label>
              <select id="schedule-time" class="input-modern">
                <option value="">All Day</option>
                <option value="07:00">7:00 AM</option>
                <option value="08:00">8:00 AM</option>
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Duration</label>
            <select id="schedule-duration" class="input-modern">
              <option value="1">1 hour</option>
              <option value="2" selected>2 hours</option>
              <option value="3">3 hours</option>
              <option value="4">4 hours (Half Day)</option>
              <option value="8">8 hours (Full Day)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea id="schedule-notes" class="input-modern" rows="2" placeholder="Access code, special instructions..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeQuickScheduleModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Day Events Modal (Calendar) -->
  <div id="day-events-modal" class="modal-overlay" onclick="if(event.target === this) closeDayEventsModal()">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title" id="day-events-title">Events for January 1</h2>
        <button class="modal-close" onclick="closeDayEventsModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="day-events-content">
        <!-- Events will be rendered here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern primary" onclick="openQuickScheduleForDate()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Add Event
        </button>
      </div>
    </div>
  </div>

  <!-- Calendar Event Modal (Simplified) -->
  <div id="calendar-event-modal" class="modal-overlay" onclick="if(event.target === this) closeCalendarEventModal()">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="calendar-event-modal-title">New Event</h2>
        <button class="modal-close" onclick="closeCalendarEventModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="calendar-event-form" onsubmit="submitCalendarEventSimple(event)">
        <input type="hidden" id="cal-event-id" value="" />
        <input type="hidden" id="cal-event-lead" value="" />
        <input type="hidden" id="cal-event-customer" value="" />
        <input type="hidden" id="cal-event-job" value="" />
        <input type="hidden" id="cal-event-project" value="" />
        <div class="modal-body" style="padding: 16px;">
          <!-- Title -->
          <div class="form-group" style="margin-bottom: 12px;">
            <label style="font-size: 13px; margin-bottom: 4px;">Title *</label>
            <input type="text" id="cal-event-title" class="input-modern" required placeholder="Event title" />
          </div>

          <!-- Type & Date/Time Row -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 13px; margin-bottom: 4px;">Type</label>
              <select id="cal-event-type" class="input-modern">
                <option value="appointment">Appointment</option>
                <option value="consultation">Consultation</option>
                <option value="measurement">Measurement</option>
                <option value="template">Template</option>
                <option value="fabrication">Fabrication</option>
                <option value="installation">Installation</option>
                <option value="plumbing_disconnect">Plumbing Disconnect</option>
                <option value="plumbing_reconnect">Plumbing Reconnect</option>
                <option value="sealer_application">Sealer Application</option>
                <option value="walk_through">Walk-Through</option>
                <option value="final_inspection">Final Inspection</option>
                <option value="delivery">Delivery</option>
                <option value="site_visit">Site Visit</option>
                <option value="meeting">Meeting</option>
                <option value="follow_up">Follow-up</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 13px; margin-bottom: 4px;">Date *</label>
              <input type="date" id="cal-event-start-date" class="input-modern" required />
            </div>
          </div>

          <!-- Time Row -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 13px; margin-bottom: 4px;">Start Time</label>
              <input type="time" id="cal-event-start-time" class="input-modern" value="09:00" />
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 13px; margin-bottom: 4px;">End Time</label>
              <input type="time" id="cal-event-end-time" class="input-modern" value="10:00" />
            </div>
          </div>
          <input type="hidden" id="cal-event-end-date" value="" />
          <input type="hidden" id="cal-event-status" value="scheduled" />

          <!-- Meeting Format -->
          <div class="form-group" style="margin-bottom: 12px;">
            <label style="font-size: 13px; margin-bottom: 4px;">Meeting Format</label>
            <select id="cal-event-meeting-format" class="input-modern">
              <option value="in_person">In Person</option>
              <option value="phone_call">Phone Call</option>
              <option value="video_call">Video Call</option>
              <option value="conference_call">Conference Call</option>
            </select>
          </div>

          <!-- Contact (optional) - Searchable -->
          <div class="form-group" style="margin-bottom: 12px; position: relative;">
            <label style="font-size: 13px; margin-bottom: 4px;">Contact</label>
            <input type="hidden" id="cal-event-contact-type" value="" />
            <input type="hidden" id="cal-event-contact-id" value="" />
            <!-- Selected contact chip (shown when contact is selected) -->
            <div id="cal-event-contact-chip" style="display: none; padding: 8px 12px; background: var(--gold-primary)22; border: 1px solid var(--gold-primary); border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                  <span id="cal-event-contact-chip-name" style="font-weight: 600; color: var(--text-primary);"></span>
                  <span id="cal-event-contact-chip-badge" style="font-size: 10px; padding: 2px 6px; border-radius: 10px; background: var(--gold-primary); color: #000; margin-left: 6px;"></span>
                </div>
                <button type="button" onclick="clearCalEventContact()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px 6px; font-size: 16px;">&times;</button>
              </div>
            </div>
            <!-- Search input -->
            <input type="text" id="cal-event-contact-search" class="input-modern" placeholder="Search leads, customers, contractors..." oninput="searchCalEventContacts(this.value)" onfocus="searchCalEventContacts(this.value)" />
            <!-- Suggestions dropdown -->
            <div id="cal-event-contact-suggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 13px; margin-bottom: 4px;">Email</label>
              <input type="email" id="cal-event-contact-email" class="input-modern" placeholder="email@example.com" />
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label style="font-size: 13px; margin-bottom: 4px;">Phone</label>
              <input type="tel" id="cal-event-contact-phone" class="input-modern" placeholder="(555) 123-4567" />
            </div>
          </div>

          <!-- Location / Meeting Details (Dynamic based on meeting format) -->
          <div id="cal-event-location-section" class="form-group" style="margin-bottom: 12px;">
            <!-- In Person Location -->
            <div id="location-in-person" style="display: block;">
              <label style="font-size: 13px; margin-bottom: 8px; display: block;">Location</label>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Contact address option (only shown when contact has address) -->
                <div id="contact-address-option" style="display: none;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; margin-bottom: 8px;">
                    <input type="checkbox" id="use-contact-address" style="accent-color: #10b981;" onchange="handleUseContactAddress()" />
                    <i class="fa-solid fa-location-dot" style="color: #10b981;"></i>
                    <span style="flex: 1;">
                      <span style="font-size: 12px; color: var(--text-muted); display: block;">Use contact address:</span>
                      <span id="contact-address-text" style="font-size: 13px; color: var(--text-primary);"></span>
                    </span>
                  </label>
                </div>
                <!-- Manual location input with autocomplete -->
                <input type="text" id="cal-event-location" class="input-modern" placeholder="Enter address or location" />
                <!-- Map preview (shows when address is selected) -->
                <div id="location-map-preview" style="display: none; margin-top: 10px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-color);">
                  <div id="location-map" style="height: 150px; width: 100%; background: var(--dark-tertiary);"></div>
                  <div id="location-map-info" style="padding: 8px 12px; background: var(--dark-elevated); font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                    <i class="fa-solid fa-location-dot" style="color: var(--gold-primary);"></i>
                    <span id="location-map-address"></span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phone Call Details -->
            <div id="location-phone-call" style="display: none;">
              <label style="font-size: 13px; margin-bottom: 8px; display: block;">Phone Call Details</label>
              <div style="padding: 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                  <i class="fa-solid fa-phone" style="color: #3b82f6; font-size: 16px;"></i>
                  <span style="font-size: 13px; color: var(--text-muted);">Call will be made to:</span>
                </div>
                <div id="phone-call-number" style="font-size: 16px; font-weight: 600; color: var(--text-primary); padding-left: 26px;">
                  <span id="phone-call-display">No phone number set</span>
                </div>
                <input type="hidden" id="cal-event-location-phone" value="" />
              </div>
            </div>

            <!-- Video Call Details -->
            <div id="location-video-call" style="display: none;">
              <label style="font-size: 13px; margin-bottom: 8px; display: block;">Video Call Details</label>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <select id="cal-event-video-platform" class="input-modern" onchange="handleVideoPlatformChange()">
                  <option value="">Select platform...</option>
                  <option value="zoom">Zoom</option>
                  <option value="google_meet">Google Meet</option>
                  <option value="teams">Microsoft Teams</option>
                  <option value="facetime">FaceTime</option>
                  <option value="other">Other</option>
                </select>
                <input type="text" id="cal-event-video-link" class="input-modern" placeholder="Meeting link (optional)" />
              </div>
            </div>

            <!-- Conference Call Details -->
            <div id="location-conference-call" style="display: none;">
              <label style="font-size: 13px; margin-bottom: 8px; display: block;">Conference Call Details</label>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <input type="text" id="cal-event-conference-number" class="input-modern" placeholder="Dial-in number" />
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                  <input type="text" id="cal-event-conference-code" class="input-modern" placeholder="Access code" />
                  <input type="text" id="cal-event-conference-pin" class="input-modern" placeholder="PIN (optional)" />
                </div>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="form-group" style="margin-bottom: 12px;">
            <label style="font-size: 13px; margin-bottom: 4px;">Notes</label>
            <textarea id="cal-event-description" class="input-modern" rows="2" placeholder="Additional details..." style="resize: none;"></textarea>
          </div>

          <!-- Event Participants (Enhanced Group Events) -->
          <div class="form-group" style="margin-bottom: 12px;">
            <label style="font-size: 13px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
              <span>Participants</span>
              <span style="font-size: 11px; color: var(--text-muted); font-weight: normal;" id="participant-count">0 added</span>
            </label>

            <!-- Participant chips container -->
            <div id="event-participants-chips" style="display: flex; flex-wrap: wrap; gap: 6px; min-height: 36px; padding: 8px; background: var(--dark-tertiary); border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 10px;">
              <span style="color: var(--text-muted); font-size: 12px; padding: 4px 0;" id="no-participants-msg">No participants added</span>
            </div>

            <!-- Quick-add buttons -->
            <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
              <button type="button" class="btn-modern ghost" style="flex: 1; min-width: 140px; padding: 8px 12px; font-size: 12px;" onclick="openParticipantPicker()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                My Network
              </button>
              <button type="button" class="btn-modern ghost" style="flex: 1; min-width: 140px; padding: 8px 12px; font-size: 12px;" onclick="addProjectTeamToEvent()" id="add-project-team-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                Project Team
              </button>
              <button type="button" class="btn-modern ghost" style="flex: 1; min-width: 140px; padding: 8px 12px; font-size: 12px;" onclick="toggleManualParticipantForm()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                Add Manual
              </button>
            </div>

            <!-- Manual participant form (hidden by default) -->
            <div id="manual-participant-form" style="display: none; background: var(--dark-elevated); padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 10px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <input type="text" id="manual-participant-name" placeholder="Name *" class="input-modern" style="font-size: 13px; padding: 8px 10px;" />
                <select id="manual-participant-role" class="input-modern" style="font-size: 13px; padding: 8px 10px;">
                  <option value="customer">Customer</option>
                  <option value="contractor">Contractor</option>
                  <option value="fabricator">Fabricator</option>
                  <option value="installer">Installer</option>
                  <option value="plumber">Plumber</option>
                  <option value="designer">Designer</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <input type="email" id="manual-participant-email" placeholder="Email" class="input-modern" style="font-size: 13px; padding: 8px 10px;" />
                <input type="tel" id="manual-participant-phone" placeholder="Phone" class="input-modern" style="font-size: 13px; padding: 8px 10px;" />
              </div>
              <div style="display: flex; gap: 8px; justify-content: flex-end;">
                <button type="button" class="btn-modern ghost" style="padding: 6px 12px; font-size: 12px;" onclick="toggleManualParticipantForm()">Cancel</button>
                <button type="button" class="btn-modern primary" style="padding: 6px 12px; font-size: 12px;" onclick="addManualParticipant()">Add Participant</button>
              </div>
            </div>

            <!-- Hidden input for legacy contractors (still used for compatibility) -->
            <select id="cal-event-contractors" class="input-modern" multiple style="display: none;">
            </select>
          </div>

          <!-- Link to Project -->
          <div class="form-group" style="margin-bottom: 0;">
            <label style="font-size: 13px; margin-bottom: 4px;">Link to Project</label>
            <select id="cal-event-project-select" class="input-modern">
              <option value="">-- None --</option>
            </select>
          </div>
        </div>
        <div class="modal-footer" style="padding: 12px 16px;">
          <button type="button" class="btn-modern ghost" onclick="closeCalendarEventModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="save-calendar-event-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            Save Event
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Multi-Event Workflow Scheduling Modal -->
  <div id="workflow-schedule-modal" class="modal-overlay" onclick="if(event.target === this) closeWorkflowScheduleModal()">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);">
        <h2 class="modal-title" style="color: #fff;">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -4px; margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Schedule Project Workflow
        </h2>
        <button class="modal-close" onclick="closeWorkflowScheduleModal()" style="color: #fff;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="workflow-schedule-form" onsubmit="submitWorkflowSchedule(event)">
        <input type="hidden" id="workflow-lead-id" value="" />
        <div class="modal-body" style="padding: 20px; max-height: 65vh; overflow-y: auto;">

          <!-- Customer Info Summary -->
          <div id="workflow-customer-info" style="background: var(--dark-tertiary); border-radius: 10px; padding: 14px; margin-bottom: 20px; border: 1px solid var(--border-color);">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; color: #fff; font-weight: 600;" id="workflow-customer-avatar">?</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 15px; color: var(--text-primary);" id="workflow-customer-name">Customer Name</div>
                <div style="font-size: 13px; color: var(--text-muted);" id="workflow-customer-details">email@example.com  (555) 123-4567</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;" id="workflow-customer-address">123 Main St, City, ST</div>
              </div>
            </div>
          </div>

          <!-- Event Type Selection -->
          <div style="margin-bottom: 20px;">
            <label style="font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--text-primary);">Select Events to Schedule</label>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
              <label class="workflow-event-toggle" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" id="workflow-include-template" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                <div>
                  <div style="font-weight: 500; font-size: 14px; color: var(--text-primary);"> Template/Measure</div>
                  <div style="font-size: 11px; color: var(--text-muted);">On-site measurement</div>
                </div>
              </label>
              <label class="workflow-event-toggle" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" id="workflow-include-demo" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <div>
                  <div style="font-weight: 500; font-size: 14px; color: var(--text-primary);"> Demo/Tear-out</div>
                  <div style="font-size: 11px; color: var(--text-muted);">Remove existing counters</div>
                </div>
              </label>
              <label class="workflow-event-toggle" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" id="workflow-include-fabrication" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                <div>
                  <div style="font-weight: 500; font-size: 14px; color: var(--text-primary);"> Fabrication</div>
                  <div style="font-size: 11px; color: var(--text-muted);">Cut & polish at shop</div>
                </div>
              </label>
              <label class="workflow-event-toggle" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" id="workflow-include-installation" checked style="width: 18px; height: 18px; accent-color: var(--primary);">
                <div>
                  <div style="font-weight: 500; font-size: 14px; color: var(--text-primary);"> Installation</div>
                  <div style="font-size: 11px; color: var(--text-muted);">Install at customer site</div>
                </div>
              </label>
              <label class="workflow-event-toggle" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" id="workflow-include-plumbing" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <div>
                  <div style="font-weight: 500; font-size: 14px; color: var(--text-primary);"> Plumbing</div>
                  <div style="font-size: 11px; color: var(--text-muted);">Disconnect & reconnect</div>
                </div>
              </label>
              <label class="workflow-event-toggle" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-color); border-radius: 10px; cursor: pointer; transition: all 0.2s;">
                <input type="checkbox" id="workflow-include-sealer" style="width: 18px; height: 18px; accent-color: var(--primary);">
                <div>
                  <div style="font-weight: 500; font-size: 14px; color: var(--text-primary);"> Sealer Application</div>
                  <div style="font-size: 11px; color: var(--text-muted);">Apply protective sealer</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Dates Section -->
          <div style="margin-bottom: 20px;">
            <label style="font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block; color: var(--text-primary);">Schedule Dates</label>
            <div id="workflow-dates-container" style="display: flex; flex-direction: column; gap: 12px;">
              <!-- Dynamic date inputs will be inserted here -->
            </div>
          </div>

          <!-- Participants Section -->
          <div style="margin-bottom: 16px;">
            <label style="font-size: 14px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; color: var(--text-primary);">
              <span>Invite Participants</span>
              <span style="font-size: 12px; font-weight: normal; color: var(--text-muted);" id="workflow-participant-count">0 selected</span>
            </label>

            <!-- Homeowner (auto-added) -->
            <div id="workflow-homeowner-participant" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 8px; margin-bottom: 10px;">
              <input type="checkbox" id="workflow-invite-homeowner" checked style="width: 16px; height: 16px; accent-color: #22c55e;">
              <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 13px; color: var(--text-primary);"> Homeowner</div>
                <div style="font-size: 11px; color: var(--text-muted);" id="workflow-homeowner-email">customer@email.com</div>
              </div>
              <span style="font-size: 10px; padding: 2px 8px; background: #22c55e; color: #fff; border-radius: 4px;">Customer</span>
            </div>

            <!-- Contractor Selection -->
            <div style="background: var(--dark-tertiary); border-radius: 8px; padding: 12px; border: 1px solid var(--border-color);">
              <div style="font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary);">Add Contractors</div>
              <div id="workflow-contractors-list" style="max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px;">
                <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Loading contractors...</div>
              </div>
            </div>
          </div>

          <!-- Notification Options -->
          <div style="background: var(--dark-elevated); border-radius: 8px; padding: 14px; border: 1px solid var(--border-color);">
            <label style="font-size: 13px; font-weight: 500; margin-bottom: 10px; display: block; color: var(--text-secondary);">Notification Options</label>
            <div style="display: flex; flex-wrap: wrap; gap: 16px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="workflow-send-email" checked style="width: 16px; height: 16px; accent-color: var(--primary);">
                <span style="font-size: 13px; color: var(--text-primary);"> Send email invites</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="workflow-send-sms" style="width: 16px; height: 16px; accent-color: var(--primary);">
                <span style="font-size: 13px; color: var(--text-primary);"> Send SMS reminders</span>
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="workflow-add-calendar" checked style="width: 16px; height: 16px; accent-color: var(--primary);">
                <span style="font-size: 13px; color: var(--text-primary);"> Add to calendar</span>
              </label>
            </div>
          </div>

          <!-- Notes -->
          <div style="margin-top: 16px;">
            <label style="font-size: 13px; margin-bottom: 4px; display: block; color: var(--text-secondary);">Notes for all events</label>
            <textarea id="workflow-notes" class="input-modern" rows="2" placeholder="Special instructions, access codes, etc..." style="resize: none;"></textarea>
          </div>
        </div>

        <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size: 12px; color: var(--text-muted);">
            <span id="workflow-event-summary">3 events will be created</span>
          </div>
          <div style="display: flex; gap: 10px;">
            <button type="button" class="btn-modern ghost" onclick="closeWorkflowScheduleModal()">Cancel</button>
            <button type="submit" class="btn-modern primary" id="workflow-submit-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              Schedule & Send Invites
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- =============================================
       LEAD/CUSTOMER PROFILE PANEL (Slide-over) - ENHANCED
       ============================================= -->
  <div id="profile-panel-overlay" class="profile-panel-overlay" onclick="if(event.target === this) closeProfilePanel()">
    <div class="profile-panel">
      <!-- Enhanced Header -->
      <div class="profile-panel-header">
        <div class="profile-header-top">
          <div class="profile-header-actions">
            <button class="profile-header-btn" onclick="copyProfileLink()" title="Copy link">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            </button>
            <button class="profile-header-btn" onclick="printProfile()" title="Print">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            </button>
          </div>
          <button class="profile-header-btn close" onclick="closeProfilePanel()" title="Close">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>
        <div class="profile-header-main">
          <div class="profile-avatar" id="profile-avatar">
            JD
            <div class="profile-avatar-badge" id="profile-avatar-badge" style="display: none;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>
            </div>
          </div>
          <div class="profile-header-info">
            <div class="profile-name" id="panel-profile-name">John Doe</div>
            <div class="profile-meta">
              <span class="profile-meta-item" id="panel-profile-email">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                <a href="#" id="panel-profile-email-link">email@example.com</a>
              </span>
              <span class="profile-meta-item" id="panel-profile-phone">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                <a href="#" id="panel-profile-phone-link">(555) 123-4567</a>
              </span>
            </div>
            <div class="profile-badges">
              <span class="profile-status-badge new" id="profile-status">New Lead</span>
              <span class="profile-tag" id="profile-source-tag" style="display: none;">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                <span id="profile-source-text">Website</span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Stats Bar -->
      <div class="profile-stats-bar">
        <div class="profile-stat">
          <div class="profile-stat-value" id="profile-stat-days">0</div>
          <div class="profile-stat-label">Days in Pipeline</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value highlight" id="profile-stat-value">$0</div>
          <div class="profile-stat-label">Est. Value</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profile-stat-appointments">0</div>
          <div class="profile-stat-label">Appointments</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-value" id="profile-stat-messages">0</div>
          <div class="profile-stat-label">Messages</div>
        </div>
      </div>

      <!-- Enhanced Tabs with Icons -->
      <div class="profile-tabs">
        <button class="profile-tab active" data-tab="overview" onclick="switchProfileTab('overview')">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          Overview
        </button>
        <button class="profile-tab" data-tab="appointments" onclick="switchProfileTab('appointments')">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Appointments
          <span class="tab-badge muted" id="tab-badge-appointments">0</span>
        </button>
        <button class="profile-tab" data-tab="notes" onclick="switchProfileTab('notes')">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
          Notes
          <span class="tab-badge muted" id="tab-badge-notes">0</span>
        </button>
        <button class="profile-tab" data-tab="attachments" onclick="switchProfileTab('attachments')">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
          Files
          <span class="tab-badge muted" id="tab-badge-files">0</span>
        </button>
        <button class="profile-tab" data-tab="messages" onclick="switchProfileTab('messages')">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Messages
          <span class="tab-badge muted" id="tab-badge-messages">0</span>
        </button>
        <button class="profile-tab" data-tab="activity" onclick="switchProfileTab('activity')">
          <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Activity
        </button>
      </div>

      <!-- Content -->
      <div class="profile-content">
        <!-- Overview Tab -->
        <div id="profile-tab-overview" class="profile-tab-content">
          <!-- Contact Information -->
          <div class="profile-section">
            <div class="profile-section-header">
              <div class="profile-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                Contact Information
              </div>
            </div>
            <div class="profile-info-grid">
              <div class="profile-info-item clickable" onclick="copyToClipboard(document.getElementById('profile-detail-email').textContent, 'Email copied')">
                <div class="profile-info-label">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                  Email
                </div>
                <div class="profile-info-value" id="profile-detail-email"></div>
              </div>
              <div class="profile-info-item clickable" onclick="copyToClipboard(document.getElementById('profile-detail-phone').textContent, 'Phone copied')">
                <div class="profile-info-label">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg>
                  Phone
                </div>
                <div class="profile-info-value" id="profile-detail-phone"></div>
              </div>
              <div class="profile-info-item" style="grid-column: span 2;">
                <div class="profile-info-label">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  Address
                </div>
                <div id="profile-address-container">
                  <a href="#" id="profile-detail-address-link" target="_blank" class="profile-info-value" style="color: #3b82f6; text-decoration: none; display: block;">
                    <span id="profile-detail-address"></span>
                  </a>
                  <div id="profile-address-actions" style="display: none; margin-top: 8px; display: flex; gap: 8px;">
                    <button onclick="openDirectionsFromProfile()" class="btn-modern ghost" style="font-size: 11px; padding: 6px 10px; flex: 1;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                      Directions
                    </button>
                    <button onclick="shareEnRouteFromProfile()" class="btn-modern primary" style="font-size: 11px; padding: 6px 10px; flex: 1;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                      En Route
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Project Details -->
          <div class="profile-section">
            <div class="profile-section-header">
              <div class="profile-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Project Details
              </div>
            </div>
            <div class="profile-info-grid">
              <div class="profile-info-item">
                <div class="profile-info-label">Project Type</div>
                <div class="profile-info-value" id="profile-detail-project-type"></div>
              </div>
              <div class="profile-info-item">
                <div class="profile-info-label">Budget Range</div>
                <div class="profile-info-value" id="profile-detail-budget"></div>
              </div>
              <div class="profile-info-item">
                <div class="profile-info-label">Timeline</div>
                <div class="profile-info-value" id="profile-detail-timeline"></div>
              </div>
              <div class="profile-info-item">
                <div class="profile-info-label">Lead Source</div>
                <div class="profile-info-value" id="profile-detail-source"></div>
              </div>
            </div>
          </div>

          <!-- Original Message -->
          <div class="profile-section" id="profile-message-section" style="display: none;">
            <div class="profile-section-header">
              <div class="profile-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                Original Message
              </div>
            </div>
            <div class="profile-info-item" style="background: var(--dark-elevated); border-left: 3px solid var(--primary);">
              <div class="profile-info-value" id="profile-detail-message" style="font-style: italic; color: var(--text-secondary); white-space: pre-wrap;"></div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="profile-section">
            <div class="profile-section-header">
              <div class="profile-section-title">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Quick Actions
              </div>
            </div>
            <div class="profile-quick-actions">
              <button class="profile-quick-action" onclick="openJobSchedulerFromProfile()">
                <div class="action-icon gold">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                </div>
                <div class="action-text">
                  <div class="action-title">Schedule Job</div>
                  <div class="action-desc">Plan phases & send invites</div>
                </div>
              </button>
              <button class="profile-quick-action" onclick="createEstimateFromProfile()">
                <div class="action-icon blue">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                </div>
                <div class="action-text">
                  <div class="action-title">Create Estimate</div>
                  <div class="action-desc">Generate a quote</div>
                </div>
              </button>
              <button class="profile-quick-action" onclick="sendMessageFromProfile()">
                <div class="action-icon green">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                </div>
                <div class="action-text">
                  <div class="action-title">Send Email</div>
                  <div class="action-desc">Contact customer</div>
                </div>
              </button>
              <button class="profile-quick-action" onclick="openPortalFromProfile()">
                <div class="action-icon purple">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                </div>
                <div class="action-text">
                  <div class="action-title">Customer Portal</div>
                  <div class="action-desc">View their portal</div>
                </div>
              </button>
              <button class="profile-quick-action" onclick="archiveLeadFromProfile()" id="archive-lead-btn">
                <div class="action-icon" style="background: rgba(107, 114, 128, 0.15);">
                  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
                </div>
                <div class="action-text">
                  <div class="action-title" id="archive-btn-title">Archive Lead</div>
                  <div class="action-desc" id="archive-btn-desc">Hide from active list</div>
                </div>
              </button>
            </div>
          </div>
        </div>

        <!-- Appointments Tab -->
        <div id="profile-tab-appointments" class="profile-tab-content" style="display: none;">
          <div class="profile-section-header" style="margin-bottom: 16px;">
            <div class="profile-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Scheduled Appointments
            </div>
            <button class="btn-modern primary" onclick="openJobSchedulerFromProfile()" style="padding: 8px 16px; font-size: 13px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              Schedule
            </button>
          </div>
          <div id="profile-appointments-list">
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Appointments Yet</div>
              <div style="font-size: 13px; max-width: 280px; margin: 0 auto;">Click "Schedule" to plan job phases like templating, fabrication, and installation</div>
            </div>
          </div>
        </div>

        <!-- Notes Tab -->
        <div id="profile-tab-notes" class="profile-tab-content" style="display: none;">
          <div class="profile-section-header" style="margin-bottom: 16px;">
            <div class="profile-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              Notes
            </div>
            <button class="btn-modern primary" onclick="addNewNote()" style="padding: 8px 16px; font-size: 13px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              Add Note
            </button>
          </div>
          <div id="profile-notes-input" style="display: none; margin-bottom: 20px; background: var(--dark-surface); padding: 16px; border-radius: 12px; border: 1px solid var(--primary);">
            <textarea id="new-note-text" class="input-modern" rows="4" placeholder="Type your note here..." style="margin-bottom: 12px; resize: none;"></textarea>
            <div style="display: flex; gap: 8px; justify-content: flex-end;">
              <button class="btn-modern ghost" onclick="cancelNewNote()">Cancel</button>
              <button class="btn-modern primary" onclick="saveNewNote()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 13l4 4L19 7"/></svg>
                Save Note
              </button>
            </div>
          </div>
          <div id="profile-notes-list">
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Notes Yet</div>
              <div style="font-size: 13px;">Add notes to track important details about this lead</div>
            </div>
          </div>
        </div>

        <!-- Attachments Tab -->
        <div id="profile-tab-attachments" class="profile-tab-content" style="display: none;">
          <div class="profile-section-header" style="margin-bottom: 16px;">
            <div class="profile-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
              Files & Attachments
            </div>
            <button class="btn-modern primary" onclick="uploadAttachment()" style="padding: 8px 16px; font-size: 13px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
              Upload
            </button>
          </div>
          <div id="profile-attachments-list">
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(139,92,246,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="1.5"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Files Attached</div>
              <div style="font-size: 13px;">Upload photos, contracts, or other documents</div>
            </div>
          </div>
        </div>

        <!-- Messages Tab -->
        <div id="profile-tab-messages" class="profile-tab-content" style="display: none;">
          <div class="profile-section-header" style="margin-bottom: 16px;">
            <div class="profile-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              Messages
            </div>
            <button class="btn-modern primary" onclick="composeMessage()" style="padding: 8px 16px; font-size: 13px;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
              Compose
            </button>
          </div>
          <div id="profile-messages-list">
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(34,197,94,0.1), rgba(34,197,94,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Messages Yet</div>
              <div style="font-size: 13px;">Send an email to start the conversation</div>
            </div>
          </div>
        </div>

        <!-- Activity Tab -->
        <div id="profile-tab-activity" class="profile-tab-content" style="display: none;">
          <div class="profile-section-header" style="margin-bottom: 16px;">
            <div class="profile-section-title">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
              Activity Timeline
            </div>
          </div>
          <div id="profile-activity-list">
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(6,182,212,0.1), rgba(6,182,212,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="1.5"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Activity Yet</div>
              <div style="font-size: 13px;">Activity will appear as you interact with this lead</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="profile-actions">
        <button class="btn-modern secondary" onclick="editProfileRecord()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Edit Details
        </button>
        <button class="btn-modern primary" onclick="openJobSchedulerFromProfile()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Schedule Job
        </button>
      </div>
    </div>
  </div>

  <!-- =============================================
       JOB PHASE SCHEDULER (Full Page) - ENHANCED
       ============================================= -->
  <div id="job-scheduler-panel" class="job-scheduler-panel">
    <!-- Enhanced Header -->
    <div class="job-scheduler-header">
      <h1>
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        Job Phase Scheduler
      </h1>
      <div class="scheduler-header-right">
        <div class="scheduler-customer-badge">
          <div class="avatar" id="scheduler-avatar">JD</div>
          <span class="name" id="scheduler-customer-name">Customer Name</span>
        </div>
        <button class="job-scheduler-close" onclick="closeJobScheduler()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
      </div>
    </div>

    <!-- Body -->
    <div class="job-scheduler-body">
      <!-- Left Sidebar: Customer Info & Settings -->
      <div class="job-scheduler-sidebar">
        <!-- Customer Info -->
        <div class="profile-section">
          <div class="profile-section-title" style="margin-bottom: 16px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Customer Info
          </div>
          <div class="scheduler-info-card">
            <div class="label">Name</div>
            <div class="value" id="scheduler-detail-name"></div>
          </div>
          <div class="scheduler-info-card">
            <div class="label">Address</div>
            <div class="value" id="scheduler-detail-address"></div>
          </div>
          <div class="scheduler-info-card">
            <div class="label">Phone</div>
            <div class="value" id="scheduler-detail-phone"></div>
          </div>
        </div>

        <!-- Backward Scheduling -->
        <div class="profile-section">
          <div class="profile-section-title" style="margin-bottom: 16px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            Backward Scheduling
          </div>
          <div class="scheduler-date-input">
            <label>Installation Date</label>
            <input type="date" id="scheduler-install-date" class="input-modern" onchange="recalculatePhases()">
            <p style="font-size: 11px; color: var(--text-muted); margin-top: 10px; margin-bottom: 0;">Set the install date and we'll calculate all other phases backward automatically.</p>
          </div>
        </div>

        <!-- Lead Times -->
        <div class="profile-section">
          <div class="profile-section-title" style="margin-bottom: 16px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            Lead Times (Days)
          </div>
          <div class="scheduler-lead-time">
            <label>Fab to Install</label>
            <input type="number" id="lead-time-fab" value="3" min="1" max="14" class="input-modern" onchange="recalculatePhases()">
          </div>
          <div class="scheduler-lead-time">
            <label>Template to Fab</label>
            <input type="number" id="lead-time-template" value="5" min="1" max="14" class="input-modern" onchange="recalculatePhases()">
          </div>
        </div>

        <!-- Notifications -->
        <div class="profile-section">
          <div class="profile-section-title" style="margin-bottom: 16px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
            Notifications
          </div>
          <label class="scheduler-notification">
            <input type="checkbox" id="scheduler-notify-customer" checked>
            <span>Email customer invites</span>
          </label>
          <label class="scheduler-notification">
            <input type="checkbox" id="scheduler-notify-contractors" checked>
            <span>Email contractor invites</span>
          </label>
          <label class="scheduler-notification">
            <input type="checkbox" id="scheduler-sms">
            <span>SMS reminders (24hr before)</span>
          </label>
        </div>
      </div>

      <!-- Main: Phase Cards -->
      <div class="job-scheduler-main">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <div>
            <h2 style="margin: 0 0 4px; font-size: 20px; font-weight: 700; color: var(--text-primary);">Job Phases</h2>
            <p style="margin: 0; font-size: 13px; color: var(--text-muted);">Enable phases and set dates for the project workflow</p>
          </div>
          <div style="display: flex; gap: 10px;">
            <button class="btn-modern ghost" onclick="resetPhases()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
              Reset
            </button>
            <button class="btn-modern primary" onclick="saveJobPhases()" style="padding: 12px 24px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
              Save & Send Invites
            </button>
          </div>
        </div>

        <div id="job-phases-container">
          <!-- Phase cards will be rendered here -->
        </div>

        <!-- Add Phase Button -->
        <button class="btn-modern ghost" style="width: 100%; padding: 18px; border: 2px dashed var(--border-subtle); margin-top: 16px; transition: all 0.2s;" onclick="showAddPhaseOptions()" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          Add Custom Phase
        </button>
      </div>

      <!-- Right Sidebar: Timeline Preview -->
      <div class="job-scheduler-timeline">
        <div class="profile-section-title" style="margin-bottom: 20px;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          Timeline Preview
        </div>
        <div id="scheduler-timeline-preview">
          <!-- Timeline items will be rendered here -->
          <div style="text-align: center; padding: 30px 0; color: var(--text-muted);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.4; margin-bottom: 10px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <div style="font-size: 13px;">Enable phases to see timeline</div>
          </div>
        </div>

        <div style="margin-top: 28px; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
          <div class="profile-section-title" style="margin-bottom: 16px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Assigned Contractors
          </div>
          <div id="scheduler-contractors-list">
            <button class="btn-modern ghost" style="width: 100%; font-size: 13px; padding: 14px;" onclick="openContractorPicker()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              Add Contractor
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar Event Detail Modal -->
  <div id="calendar-event-detail-modal" class="modal-overlay" onclick="if(event.target === this) closeCalendarEventDetailModal()">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title" id="event-detail-title">Event Details</h2>
        <button class="modal-close" onclick="closeCalendarEventDetailModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="event-detail-content">
        <div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>
      </div>
      <div class="modal-footer" id="event-detail-actions">
        <button type="button" class="btn-modern secondary" onclick="closeCalendarEventDetailModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Participant Picker Modal -->
  <div class="modal-overlay" id="participant-picker-modal" onclick="if(event.target === this) closeParticipantPicker()">
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header">
        <h2 class="modal-title">Add from My Network</h2>
        <button class="modal-close" onclick="closeParticipantPicker()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <input type="text" id="participant-search" class="input-modern" placeholder="Search by name, email, or role..." oninput="filterParticipantPicker(this.value)" style="margin-bottom: 12px;" />
        <div id="participant-picker-list" style="max-height: 300px; overflow-y: auto;">
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading network...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern ghost" onclick="closeParticipantPicker()">Cancel</button>
        <button type="button" class="btn-modern primary" onclick="confirmSelectedParticipants()">
          Add Selected (<span id="selected-participants-count">0</span>)
        </button>
      </div>
    </div>
  </div>

  <!-- Simple Invite Modal -->
  <div class="modal-overlay" id="invite-to-network-modal" onclick="if(event.target === this) closeInviteToNetworkModal()">
    <div class="modal-content" style="max-width: 420px;">
      <div class="modal-header" style="border-bottom: none; padding-bottom: 0;">
        <h2 class="modal-title" style="font-size: 22px;">Invite Someone</h2>
        <button class="modal-close" onclick="closeInviteToNetworkModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="padding-top: 8px;">
        <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px; line-height: 1.5;">
          Send them a link to create their free account. They'll be able to collaborate with you, check messages, and use all the tools.
        </p>
        <form id="invite-network-form" onsubmit="return sendNetworkInvite(event)">
          <div class="form-group" style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600;">Their Name</label>
            <input type="text" id="network-invite-name" required placeholder="John Smith" class="input-modern" maxlength="200" style="font-size: 16px; padding: 14px;" />
          </div>
          <div class="form-group" style="margin-bottom: 16px;">
            <label style="font-size: 13px; font-weight: 600;">Email or Phone</label>
            <input type="text" id="network-invite-contact" placeholder="john@email.com or (555) 123-4567" class="input-modern" style="font-size: 16px; padding: 14px;" />
            <span style="font-size: 11px; color: var(--text-muted);">We'll send them an invite link</span>
          </div>
          <div class="form-group" style="margin-bottom: 20px;">
            <label style="font-size: 13px; font-weight: 600;">They are a...</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px;">
              <label class="role-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.15s;">
                <input type="radio" name="invite-role" value="contractor" style="display: none;">
                <span style="font-size: 20px;"></span>
                <span style="font-size: 14px;">Contractor</span>
              </label>
              <label class="role-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.15s;">
                <input type="radio" name="invite-role" value="fabricator" style="display: none;">
                <span style="font-size: 20px;"></span>
                <span style="font-size: 14px;">Fabricator</span>
              </label>
              <label class="role-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.15s;">
                <input type="radio" name="invite-role" value="installer" style="display: none;">
                <span style="font-size: 20px;"></span>
                <span style="font-size: 14px;">Installer</span>
              </label>
              <label class="role-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.15s;">
                <input type="radio" name="invite-role" value="designer" style="display: none;">
                <span style="font-size: 20px;"></span>
                <span style="font-size: 14px;">Designer</span>
              </label>
              <label class="role-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.15s;">
                <input type="radio" name="invite-role" value="partner" style="display: none;">
                <span style="font-size: 20px;"></span>
                <span style="font-size: 14px;">Trade Partner</span>
              </label>
              <label class="role-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--dark-elevated); border: 2px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.15s;">
                <input type="radio" name="invite-role" value="vendor" style="display: none;">
                <span style="font-size: 20px;"></span>
                <span style="font-size: 14px;">Vendor</span>
              </label>
            </div>
          </div>
          <button type="submit" class="btn-modern primary" id="send-network-invite-btn" style="width: 100%; padding: 16px; font-size: 16px; font-weight: 600;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 10px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            Send Invite
          </button>
        </form>
      </div>
    </div>
  </div>
  <style>
    .role-option:has(input:checked) {
      border-color: var(--gold-primary) !important;
      background: rgba(249, 203, 0, 0.1) !important;
    }
    .role-option:hover {
      border-color: var(--gold-primary);
    }
  </style>

  <!-- Assign to Project Modal -->
  <div class="modal-overlay" id="assign-to-project-modal" onclick="if(event.target === this) closeAssignToProjectModal()">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">Assign to Project</h2>
        <button class="modal-close" onclick="closeAssignToProjectModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
          Assign <strong id="assign-collaborator-name"></strong> to a project.
        </p>
        <form id="assign-project-form" onsubmit="return submitAssignToProject(event)">
          <input type="hidden" id="assign-collaborator-id" />
          <div class="form-group">
            <label>Select Project *</label>
            <select id="assign-project-select" required class="input-modern">
              <option value="">Loading projects...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Access Level</label>
            <select id="assign-access-level" class="input-modern">
              <option value="read">Read Only</option>
              <option value="write">Read & Write</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <button type="submit" class="btn-modern primary" style="width: 100%;">
            Assign to Project
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Quick Assign Team Member Modal (from Project to Network) -->
  <div class="modal-overlay" id="quick-assign-modal" onclick="if(event.target === this) closeQuickAssignModal()">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Assign Team Member</h2>
        <button class="modal-close" onclick="closeQuickAssignModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <input type="hidden" id="quick-assign-project-id" />
        <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
          Select a collaborator from your network to add to this project's team.
        </p>

        <!-- Search -->
        <input type="text" id="quick-assign-search" class="input-modern" placeholder="Search by name, role, or company..." oninput="filterQuickAssignList(this.value)" style="margin-bottom: 12px;" />

        <!-- Collaborator List -->
        <div id="quick-assign-list" style="max-height: 280px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading network...</div>
        </div>

        <!-- Role Selection -->
        <div style="margin-top: 16px;">
          <label style="font-size: 13px; font-weight: 600; display: block; margin-bottom: 8px;">Assign as Role</label>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            <label class="role-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--dark-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="quick-assign-role" value="contractor" checked style="display: none;" />
              <span> Contractor</span>
            </label>
            <label class="role-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--dark-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="quick-assign-role" value="fabricator" style="display: none;" />
              <span> Fabricator</span>
            </label>
            <label class="role-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--dark-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="quick-assign-role" value="installer" style="display: none;" />
              <span> Installer</span>
            </label>
            <label class="role-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--dark-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="quick-assign-role" value="plumber" style="display: none;" />
              <span> Plumber</span>
            </label>
            <label class="role-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--dark-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="quick-assign-role" value="measurer" style="display: none;" />
              <span> Measurer</span>
            </label>
            <label class="role-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--dark-tertiary); border: 2px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: all 0.2s;">
              <input type="radio" name="quick-assign-role" value="designer" style="display: none;" />
              <span> Designer</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern ghost" onclick="closeQuickAssignModal()">Cancel</button>
        <button type="button" class="btn-modern primary" id="quick-assign-btn" onclick="confirmQuickAssign()" disabled>
          Assign Selected
        </button>
      </div>
    </div>
  </div>
  <style>
    .role-chip:has(input:checked) {
      border-color: var(--gold-primary) !important;
      background: rgba(249, 203, 0, 0.15) !important;
    }
    .role-chip:hover {
      border-color: var(--gold-primary);
    }
    .quick-assign-item.selected {
      background: var(--gold-primary)11 !important;
      border-left: 3px solid var(--gold-primary);
    }
  </style>

  <!-- Job Detail Modal -->
  <div id="job-detail-modal" class="modal-overlay" onclick="if(event.target === this) closeJobDetailModal()">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Job Details - <span id="job-detail-number">JOB-0001</span></h2>
        <button class="modal-close" onclick="closeJobDetailModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Job Status Bar -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
          <select id="job-detail-status" onchange="updateJobStatus()" style="padding: 8px 16px; border-radius: 8px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);">
            <option value="new">New</option>
            <option value="reviewing">Reviewing</option>
            <option value="material_ordered">Material Ordered</option>
            <option value="material_received">Material Received</option>
            <option value="assigned">Assigned</option>
            <option value="scheduled">Scheduled</option>
            <option value="measured">Measured</option>
            <option value="in_production">In Production</option>
            <option value="ready">Ready</option>
            <option value="installing">Installing</option>
            <option value="completed">Completed</option>
            <option value="on_hold">On Hold</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <button class="btn-modern primary small" onclick="scheduleForCurrentJob()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Schedule
          </button>
          <button class="btn-modern secondary small" onclick="sendCustomerUpdate()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Email Customer
          </button>
          <button class="btn-modern secondary small" onclick="openAssignCollaboratorModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            Assign Collaborator
          </button>
          <button class="btn-modern secondary small" onclick="inviteCollaboratorForJob()" title="Invite someone to collaborate on this job">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
            Invite Collaborator
          </button>
          <button class="btn-modern secondary small" onclick="orderMaterials()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            Order Materials
          </button>
        </div>

        <!-- Two Column Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Left Column - Customer & Job Info -->
          <div>
            <div class="form-section">
              <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                Customer
                <div style="display: flex; gap: 6px;">
                  <button class="btn-modern secondary small" onclick="inviteCustomerAsCollaborator()" title="Invite customer to collaborate">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                    Invite
                  </button>
                  <button class="btn-modern secondary small" onclick="sendCustomerPortalLink()" title="Send portal access link">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                    Portal
                  </button>
                </div>
              </div>
              <div id="job-detail-customer" style="padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                <div style="font-weight: 600;" id="job-customer-name-display">Loading...</div>
                <div style="font-size: 13px; color: var(--text-muted);" id="job-customer-email-display"></div>
                <div style="font-size: 13px; color: var(--text-muted);" id="job-customer-phone-display"></div>
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;" id="job-customer-address-display"></div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">Job Info</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Type</label>
                  <div id="job-detail-type" style="font-weight: 500;">Installation</div>
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Priority</label>
                  <div id="job-detail-priority" style="font-weight: 500;">Normal</div>
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Total</label>
                  <div id="job-detail-total" style="font-weight: 600; color: var(--gold-primary);">$0.00</div>
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Balance Due</label>
                  <div id="job-detail-balance" style="font-weight: 600;">$0.00</div>
                </div>
              </div>
              <div style="margin-top: 12px;">
                <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Notes</label>
                <div id="job-detail-notes" style="font-size: 14px; color: var(--text-secondary);">-</div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">Schedule</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Field Measure</label>
                  <input type="datetime-local" id="job-field-measure-date" onchange="updateJobSchedule('field_measure_date')"
                         style="width: 100%; padding: 8px; border-radius: 6px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 13px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Install Date</label>
                  <input type="datetime-local" id="job-install-date" onchange="updateJobSchedule('install_date')"
                         style="width: 100%; padding: 8px; border-radius: 6px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 13px;">
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                Team & Collaborators
                <div style="display: flex; gap: 6px;">
                  <button class="btn-modern secondary small" onclick="inviteCollaboratorForJob()" title="Invite collaborator">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                    Invite
                  </button>
                  <button class="btn-modern secondary small" onclick="openAssignCollaboratorModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    Add
                  </button>
                </div>
              </div>
              <div id="job-collaborators-list" style="min-height: 60px;">
                <div style="color: var(--text-muted); font-size: 13px;">No collaborators assigned yet.</div>
              </div>
            </div>
          </div>

          <!-- Right Column - Files & Timeline -->
          <div>
            <div class="form-section">
              <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                Files & Drawings
                <label class="btn-modern secondary small" style="cursor: pointer;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                  Upload
                  <input type="file" id="job-file-upload" multiple accept="image/*,.pdf,.dxf,.dwg" style="display: none;" onchange="uploadJobFiles(event)">
                </label>
              </div>
              <div id="job-files-list" style="min-height: 100px; max-height: 300px; overflow-y: auto;">
                <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
                  No files uploaded yet.<br>
                  <span style="font-size: 12px;">Drop files here or click Upload</span>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">Activity Timeline</div>
              <div id="job-timeline" style="max-height: 200px; overflow-y: auto;">
                <div style="color: var(--text-muted); font-size: 13px;">No activity yet.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeJobDetailModal()">Close</button>
        <button type="button" class="btn-modern primary" onclick="saveJobChanges()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Customers Modal -->
  <div id="customers-modal" class="modal-overlay" onclick="if(event.target === this) closeCustomersModal()">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Customer Database</h2>
        <button class="modal-close" onclick="closeCustomersModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <input type="text" id="customer-search" placeholder="Search customers..." style="flex: 1; max-width: 300px; padding: 8px 12px; border-radius: 8px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);" oninput="searchCustomers()">
          <button class="btn-modern primary small" onclick="openAddCustomerModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Customer
          </button>
        </div>
        <div id="customers-list-modal">
          <div class="spinner" style="margin: 40px auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Customer Modal -->
  <div id="add-customer-modal" class="modal-overlay" onclick="if(event.target === this) closeAddCustomerModal()">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title" id="add-customer-modal-title">Add New Customer</h2>
        <button class="modal-close" onclick="closeAddCustomerModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="add-customer-form" onsubmit="saveCustomer(event)">
        <input type="hidden" id="edit-customer-id">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="cust-name" required placeholder="John Smith">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="cust-email" placeholder="john@email.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="cust-phone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
              <label>Company</label>
              <input type="text" id="cust-company" placeholder="Optional">
            </div>
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="cust-address" placeholder="123 Main St">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="cust-city" placeholder="Phoenix">
            </div>
            <div class="form-group" style="max-width: 80px;">
              <label>State</label>
              <input type="text" id="cust-state" value="AZ" maxlength="2">
            </div>
            <div class="form-group" style="max-width: 100px;">
              <label>ZIP</label>
              <input type="text" id="cust-zip" placeholder="85001">
            </div>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="cust-notes" rows="2" placeholder="Internal notes about this customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeAddCustomerModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Save Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Contractor Modal -->
  <div id="new-collaborator-modal" class="modal-overlay" onclick="if(event.target === this) closeNewCollaboratorModal()">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Add Collaborator</h2>
        <button class="modal-close" onclick="closeNewCollaboratorModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="new-contractor-form" onsubmit="createContractor(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="contractor-name" required placeholder="John's Fabrication">
            </div>
            <div class="form-group">
              <label>Type *</label>
              <select id="contractor-type" required>
                <option value="fabricator">Fabricator</option>
                <option value="installer">Installer</option>
                <option value="plumber">Plumber</option>
                <option value="electrician">Electrician</option>
                <option value="template">Template Tech</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="contractor-email" placeholder="john@fabrication.com">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="contractor-phone" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="form-group">
            <label>Company / Business Name</label>
            <input type="text" id="contractor-company" placeholder="ABC Stoneworks LLC">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Hourly Rate ($)</label>
              <input type="number" id="contractor-rate" step="0.01" min="0" placeholder="75.00">
            </div>
            <div class="form-group">
              <label>License #</label>
              <input type="text" id="contractor-license" placeholder="ROC #123456">
            </div>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="contractor-notes" rows="2" placeholder="Specialties, availability, etc."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeNewCollaboratorModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Add Collaborator</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invite Contractor Modal -->
  <div id="invite-collaborator-modal" class="modal-overlay" onclick="if(event.target === this) closeInviteCollaboratorModal()">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">Invite to Network</h2>
        <button class="modal-close" onclick="closeInviteCollaboratorModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <!-- Quick Share Link Section -->
      <div class="modal-body" style="border-bottom: 1px solid var(--border-color); padding-bottom: 20px;">
        <div style="text-align: center; margin-bottom: 12px;">
          <span style="font-size: 13px; color: var(--text-muted);">Share your invite link</span>
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="quick-share-link" readonly style="flex: 1; background: var(--bg-tertiary); font-size: 13px; padding: 10px 12px;" placeholder="Click to generate link...">
          <button type="button" class="btn-modern primary" id="copy-link-btn" onclick="generateAndCopyShareLink()" style="white-space: nowrap;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
            Copy Link
          </button>
        </div>
      </div>

      <div style="text-align: center; padding: 12px 0; color: var(--text-muted); font-size: 12px;">or send via email</div>

      <form id="invite-contractor-form" onsubmit="sendContractorInvitation(event)">
        <div class="modal-body" style="padding-top: 0;">
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="invite-contractor-email" required placeholder="email@example.com">
          </div>
          <div class="form-group">
            <label>Message (Optional)</label>
            <textarea id="invite-contractor-message" rows="2" placeholder="Add a personal note..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeInviteCollaboratorModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="send-invite-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Invite
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Contractor Profile/Detail Modal -->
  <div id="contractor-profile-modal" class="modal-overlay" onclick="if(event.target === this) closeContractorProfileModal()">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Collaborator Profile</h2>
        <button class="modal-close" onclick="closeContractorProfileModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Trust Score Badge -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: var(--dark-surface); border-radius: 12px;">
          <div>
            <div style="font-size: 20px; font-weight: 700;" id="contractor-profile-name">Contractor Name</div>
            <div style="font-size: 13px; color: var(--text-muted);" id="contractor-profile-company">Company Name</div>
          </div>
          <div style="text-align: center;">
            <div class="trust-score-badge" id="contractor-trust-badge">
              <span class="trust-score-value" id="contractor-trust-score">0</span>
              <span class="trust-score-label">Trust Score</span>
            </div>
          </div>
        </div>

        <!-- Invite Link Section -->
        <div class="form-section">
          <div class="form-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
            Invite to Join Platform
          </div>
          <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
            Share this link or QR code so the contractor can claim their profile, upload documents, and build their trust score.
          </p>
          <div style="display: flex; gap: 12px; align-items: stretch;">
            <div style="flex: 1;">
              <div style="display: flex; gap: 8px;">
                <input type="text" id="contractor-invite-link" readonly
                       style="flex: 1; padding: 10px 12px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 12px;"
                       value="Generating link...">
                <button class="btn-modern secondary" onclick="copyInviteLink()" title="Copy Link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                </button>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn-modern secondary small" onclick="sendInviteEmail()" style="flex: 1;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Email Invite
                </button>
                <button class="btn-modern secondary small" onclick="sendInviteSMS()" style="flex: 1;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                  Text Invite
                </button>
              </div>
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="btn-modern primary small" onclick="inviteContractorAsCollaborator()" style="flex: 1;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Collaborator
                </button>
                <button class="btn-modern secondary small" onclick="assignContractorToProject(currentContractorId)" style="flex: 1;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                  Assign to Project
                </button>
              </div>
            </div>
            <div style="width: 100px; height: 100px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;" id="contractor-qr-code">
              <div style="color: #333; font-size: 10px; text-align: center;">QR Code</div>
            </div>
          </div>
        </div>

        <!-- Verification Checklist -->
        <div class="form-section">
          <div class="form-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
            Verification Status
          </div>
          <div id="contractor-verification-checklist" style="display: grid; gap: 8px;">
            <!-- Checklist items will be rendered here -->
          </div>
        </div>

        <!-- Documents Section -->
        <div class="form-section">
          <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Documents
            </span>
            <label class="btn-modern secondary small" style="cursor: pointer;">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
              Upload
              <input type="file" id="contractor-doc-upload" accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="uploadContractorDocument(event)">
            </label>
          </div>
          <div id="contractor-documents-list" style="min-height: 60px;">
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No documents uploaded yet
            </div>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="form-section">
          <div class="form-section-title">Contact Information</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Email</label>
              <div id="contractor-profile-email" style="font-size: 14px;">-</div>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Phone</label>
              <div id="contractor-profile-phone" style="font-size: 14px;">-</div>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Type</label>
              <div id="contractor-profile-type" style="font-size: 14px;">-</div>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">License #</label>
              <div id="contractor-profile-license" style="font-size: 14px;">-</div>
            </div>
          </div>
        </div>

        <!-- Job History -->
        <div class="form-section">
          <div class="form-section-title">Job History</div>
          <div id="contractor-job-history" style="max-height: 150px; overflow-y: auto;">
            <div style="color: var(--text-muted); font-size: 13px;">No jobs assigned yet</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeContractorProfileModal()">Close</button>
        <button type="button" class="btn-modern primary" onclick="editContractorDetails()">Edit Details</button>
      </div>
    </div>
  </div>

  <!-- Assign Collaborator Modal -->
  <div id="assign-collaborator-modal" class="modal-overlay" onclick="if(event.target === this) closeAssignCollaboratorModal()">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Assign Collaborator to Job</h2>
        <button class="modal-close" onclick="closeAssignCollaboratorModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="assign-contractor-form" onsubmit="assignContractor(event)">
        <div class="modal-body">
          <!-- Existing Contractor Selection -->
          <div id="select-existing-contractor">
            <div class="form-group">
              <label>Select Contractor *</label>
              <select id="assign-contractor-select" onchange="toggleNewContractorInAssign()">
                <option value="">-- Select Contractor --</option>
                <option value="__new__">+ Add New Contractor</option>
              </select>
            </div>
          </div>

          <!-- New Contractor Form (hidden by default) -->
          <div id="new-contractor-inline" style="display: none; padding: 16px; background: var(--dark-surface); border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--gold-primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--gold-primary);">New Contractor Details</span>
              <button type="button" class="btn-modern secondary small" onclick="cancelNewContractorInline()" style="padding: 4px 8px; font-size: 11px;">Cancel</button>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Name *</label>
                <input type="text" id="inline-contractor-name" placeholder="John Smith">
              </div>
              <div class="form-group">
                <label>Company</label>
                <input type="text" id="inline-contractor-company" placeholder="ABC Stoneworks">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="inline-contractor-email" placeholder="john@example.com">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="inline-contractor-phone" placeholder="(555) 123-4567">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Role on this Job</label>
            <select id="assign-contractor-role">
              <option value="fabricator">Fabricator</option>
              <option value="installer">Installer</option>
              <option value="plumber">Plumber</option>
              <option value="electrician">Electrician</option>
              <option value="template">Template Tech</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Amount to Pay ($)</label>
            <input type="number" id="assign-contractor-amount" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="assign-contractor-notify" checked style="width: 18px; height: 18px;">
              Send email invitation to contractor
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeAssignCollaboratorModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Assign Collaborator</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Service Catalog Modal -->
  <div id="service-catalog-modal" class="modal-overlay" onclick="if(event.target === this) closeServiceCatalog()">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Service & Material Catalog</h2>
        <button class="modal-close" onclick="closeServiceCatalog()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 20px;">Create reusable services and materials for quick estimate creation.</p>

        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <div class="table-filters">
            <button class="filter-btn active" onclick="filterCatalog('all')">All</button>
            <button class="filter-btn" onclick="filterCatalog('material')">Materials</button>
            <button class="filter-btn" onclick="filterCatalog('service')">Services</button>
            <button class="filter-btn" onclick="filterCatalog('labor')">Labor</button>
          </div>
          <button class="btn-modern primary small" onclick="openAddCatalogItem()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Item
          </button>
        </div>

        <div id="service-catalog-list">
          <div class="empty-state" style="padding: 40px;">
            <p style="color: var(--text-muted);">No catalog items yet. Add your first service or material.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeServiceCatalog()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add Catalog Item Modal -->
  <div id="add-catalog-item-modal" class="modal-overlay" onclick="if(event.target === this) closeAddCatalogItem()" style="z-index: 10001;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Add Catalog Item</h2>
        <button class="modal-close" onclick="closeAddCatalogItem()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="add-catalog-item-form" onsubmit="return saveCatalogItem(event)">
          <div class="form-group">
            <label>Item Name *</label>
            <input type="text" id="catalog-item-name" required placeholder="e.g., Granite Installation">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="catalog-item-desc" placeholder="Brief description">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Category</label>
              <select id="catalog-item-category">
                <option value="service">Service</option>
                <option value="material">Material</option>
                <option value="labor">Labor</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Unit Type</label>
              <select id="catalog-item-unit">
                <option value="each">Each</option>
                <option value="sqft">Sq Ft</option>
                <option value="lnft">Ln Ft</option>
                <option value="hour">Hour</option>
                <option value="day">Day</option>
                <option value="job">Job</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Unit Price ($) *</label>
              <input type="number" id="catalog-item-price" required min="0" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
              <label>Your Cost ($)</label>
              <input type="number" id="catalog-item-cost" min="0" step="0.01" placeholder="0.00">
            </div>
          </div>
          <input type="hidden" id="catalog-item-id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeAddCatalogItem()">Cancel</button>
        <button type="submit" form="add-catalog-item-form" class="btn-modern primary">Save Item</button>
      </div>
    </div>
  </div>

  <!-- Accept Invite Modal -->
  <div class="modal-overlay" id="accept-invite-modal" onclick="if(event.target === this) closeAcceptInviteModal()">
    <div class="modal-content" style="max-width: 480px;">
      <div class="modal-header">
        <h2 class="modal-title">Collaboration Invitation</h2>
        <button class="modal-close" onclick="closeAcceptInviteModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="accept-invite-body">
        <div style="text-align: center; padding: 20px 0;">
          <div class="spinner" style="margin: 0 auto;"></div>
          <p style="margin-top: 12px; color: var(--text-muted);">Loading invitation...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite to Project Modal -->
  <div class="modal-overlay" id="invite-to-project-modal" onclick="if(event.target === this) closeInviteToProjectModal()">
    <div class="modal-content" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">Invite Collaborator</h2>
        <button class="modal-close" onclick="closeInviteToProjectModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="invite-collaborator-form" onsubmit="return sendCollaborationInvite(event)">
          <input type="hidden" id="invite-project-id" />
          <div class="form-group" id="invite-project-selector" style="display: none;">
            <label>Project *</label>
            <select id="invite-project-select" required onchange="onInviteProjectSelected()">
              <option value="">Select a Project</option>
            </select>
          </div>
          <div id="inline-create-project-form" style="display: none; background: var(--dark-elevated); border: 1px solid var(--dark-border); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--gold-primary); margin-bottom: 12px;">Create New Project</div>
            <div class="form-group" style="margin-bottom: 10px;">
              <input type="text" id="inline-project-name" placeholder="Project Name *" maxlength="200" style="width: 100%;" />
            </div>
            <div class="form-group" style="margin-bottom: 10px;">
              <input type="text" id="inline-project-customer" placeholder="Customer Name *" maxlength="200" style="width: 100%;" />
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <input type="text" id="inline-project-description" placeholder="Description (optional)" maxlength="2000" style="width: 100%;" />
            </div>
            <div style="display: flex; gap: 10px;">
              <button type="button" class="btn-modern secondary" onclick="cancelInlineProjectCreate()" style="flex: 1; font-size: 12px; padding: 8px;">Cancel</button>
              <button type="button" class="btn-modern primary" onclick="submitInlineProjectCreate()" id="inline-create-project-btn" style="flex: 1; font-size: 12px; padding: 8px;">Create & Select</button>
            </div>
          </div>
          <div class="form-group">
            <label>Email Address *</label>
            <input type="email" id="invite-email" required placeholder="colleague@example.com" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Role *</label>
              <select id="invite-role" required>
                <option value="">Select Role</option>
                <option value="designer">Designer</option>
                <option value="fabricator">Fabricator</option>
                <option value="contractor">Contractor</option>
                <option value="installer">Installer</option>
                <option value="viewer">Viewer</option>
              </select>
            </div>
            <div class="form-group">
              <label>Access Level</label>
              <select id="invite-access-level">
                <option value="read">Read Only</option>
                <option value="write">Read &amp; Write</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Notes (optional)</label>
            <input type="text" id="invite-notes" placeholder="e.g., Please review kitchen layout" maxlength="500" />
          </div>
          <button type="submit" class="btn-modern primary" id="send-project-invite-btn" style="width: 100%;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Invitation
          </button>
        </form>
        <div id="pending-invitations-section" style="margin-top: 24px; display: none;">
          <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Pending Invitations</div>
          <div id="pending-invitations-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Design Handoff Modal -->
  <div class="modal-overlay" id="start-handoff-modal" onclick="if(event.target === this) closeStartHandoffModal()">
    <div class="modal-content" style="max-width: 520px;">
      <div class="modal-header">
        <h2 class="modal-title">Start Design Handoff</h2>
        <button class="modal-close" onclick="closeStartHandoffModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 13px;">Hand off your design to a fabricator and track the entire fabrication-to-installation pipeline.</p>
        <form id="start-handoff-form" onsubmit="return submitStartHandoff(event)">
          <input type="hidden" id="handoff-design-id" />
          <div class="form-group">
            <label>Select Project *</label>
            <select id="handoff-project-select" required>
              <option value="">Loading projects...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Handoff Title *</label>
            <input type="text" id="handoff-title" required placeholder="e.g., Kitchen Countertop Fabrication" maxlength="200" />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="handoff-description" placeholder="Describe what needs to be fabricated and installed..." maxlength="2000" rows="3" style="resize: vertical;"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Assign Fabricator</label>
              <select id="handoff-fabricator">
                <option value="">None (assign later)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Assign Collaborator/Installer</label>
              <select id="handoff-contractor">
                <option value="">None (assign later)</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <input type="text" id="handoff-notes" placeholder="Special instructions for fabrication or installation..." maxlength="2000" />
          </div>
          <button type="submit" class="btn-modern primary" id="submit-handoff-btn" style="width: 100%;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
            Start Handoff
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Handoff Detail/Tracker Modal -->
  <div class="modal-overlay" id="handoff-detail-modal" onclick="if(event.target === this) closeHandoffDetailModal()">
    <div class="modal-content" style="max-width: 640px;">
      <div class="modal-header">
        <h2 class="modal-title" id="handoff-detail-title">Design Handoff</h2>
        <button class="modal-close" onclick="closeHandoffDetailModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="handoff-detail-content">
        <div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="color: var(--text-muted); margin-top: 12px;">Loading handoff...</p></div>
      </div>
    </div>
  </div>

  <!-- Create/Edit Project Modal -->
  <div class="modal-overlay" id="project-modal" onclick="if(event.target === this) closeProjectModal()">
    <div class="modal-content" style="max-width: 680px;">
      <div class="modal-header">
        <h2 class="modal-title" id="project-modal-title">New Project</h2>
        <button class="modal-close" onclick="closeProjectModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <form id="project-form" onsubmit="return saveProject(event)">
          <input type="hidden" id="project-edit-id" />
          <input type="hidden" id="proj-lead-id" />
          <input type="hidden" id="proj-customer-id" />

          <!-- Source Selector (New Projects Only) -->
          <div id="project-source-selector" style="margin-bottom: 20px;">
            <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Create From</div>
            <div style="display: flex; gap: 8px; margin-bottom: 16px;">
              <button type="button" class="source-tab active" onclick="selectProjectSource('manual')" id="source-tab-manual" style="flex: 1; padding: 10px 16px; border: 2px solid var(--gold-primary); background: var(--gold-primary); color: var(--dark-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Manual
              </button>
              <button type="button" class="source-tab" onclick="selectProjectSource('lead')" id="source-tab-lead" style="flex: 1; padding: 10px 16px; border: 2px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                From Lead
              </button>
              <button type="button" class="source-tab" onclick="selectProjectSource('customer')" id="source-tab-customer" style="flex: 1; padding: 10px 16px; border: 2px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                From Customer
              </button>
            </div>

            <!-- Lead Selector -->
            <div id="lead-selector-container" style="display: none; margin-bottom: 16px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label>Select Lead</label>
                <div style="position: relative;">
                  <input type="text" id="lead-search-input" placeholder="Search leads by name, email, or phone..." style="padding-right: 32px;" oninput="filterLeadsForProject(this.value)" onfocus="showLeadDropdown()" />
                  <div id="lead-dropdown" class="search-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--dark-secondary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100;">
                    <div class="dropdown-loading" style="padding: 16px; text-align: center; color: var(--text-secondary);">Loading leads...</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Customer Selector -->
            <div id="customer-selector-container" style="display: none; margin-bottom: 16px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label>Select Customer</label>
                <div style="position: relative;">
                  <input type="text" id="customer-search-input" placeholder="Search customers by name, email, or phone..." style="padding-right: 32px;" oninput="filterCustomersForProject(this.value)" onfocus="showCustomerDropdown()" />
                  <div id="customer-dropdown" class="search-dropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: var(--dark-secondary); border: 1px solid var(--border-color); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100;">
                    <div class="dropdown-loading" style="padding: 16px; text-align: center; color: var(--text-secondary);">Loading customers...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Details</div>
          <div class="form-group">
            <label>Project Name *</label>
            <input type="text" id="proj-name" required maxlength="200" placeholder="e.g., Kitchen Countertops - Smith Residence" />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="proj-description" rows="2" maxlength="2000" placeholder="Brief project description..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Status</label>
              <select id="proj-status">
                <option value="lead">Lead</option>
                <option value="approved">Approved</option>
                <option value="scheduled">Scheduled</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
                <option value="on_hold">On Hold</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="form-group">
              <label>Priority</label>
              <select id="proj-priority">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
            </div>
          </div>

          <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 20px 0 12px; text-transform: uppercase; letter-spacing: 0.5px;">Customer Information</div>
          <div class="form-group">
            <label>Customer Name *</label>
            <input type="text" id="proj-customer-name" required maxlength="200" placeholder="Full name" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="proj-customer-email" maxlength="254" placeholder="email@example.com" />
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="proj-customer-phone" maxlength="20" placeholder="(555) 123-4567" />
            </div>
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="proj-address" maxlength="500" placeholder="Street address" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="proj-city" maxlength="100" placeholder="City" />
            </div>
            <div class="form-group" style="max-width: 80px;">
              <label>State</label>
              <input type="text" id="proj-state" maxlength="2" placeholder="AZ" />
            </div>
            <div class="form-group" style="max-width: 120px;">
              <label>ZIP</label>
              <input type="text" id="proj-zip" maxlength="20" placeholder="85374" />
            </div>
          </div>

          <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 20px 0 12px; text-transform: uppercase; letter-spacing: 0.5px;">Financials & Schedule</div>
          <div class="form-row">
            <div class="form-group">
              <label>Value ($)</label>
              <input type="number" id="proj-value" step="0.01" min="0" placeholder="0.00" />
            </div>
            <div class="form-group">
              <label>Cost ($)</label>
              <input type="number" id="proj-cost" step="0.01" min="0" placeholder="0.00" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Start Date</label>
              <input type="date" id="proj-start-date" />
            </div>
            <div class="form-group">
              <label>End Date</label>
              <input type="date" id="proj-end-date" />
            </div>
            <div class="form-group">
              <label>Est. Duration (days)</label>
              <input type="number" id="proj-duration" min="0" placeholder="0" />
            </div>
          </div>

          <div style="font-size: 13px; font-weight: 600; color: var(--text-secondary); margin: 20px 0 12px; text-transform: uppercase; letter-spacing: 0.5px;">Notes</div>
          <div class="form-group">
            <label>Internal Notes</label>
            <textarea id="proj-notes" rows="2" maxlength="5000" placeholder="Internal notes (not visible to customer)..."></textarea>
          </div>
          <div class="form-group">
            <label>Customer Notes</label>
            <textarea id="proj-customer-notes" rows="2" maxlength="5000" placeholder="Notes visible to customer..."></textarea>
          </div>

          <button type="submit" class="btn-modern primary" id="save-project-btn" style="width: 100%; margin-top: 16px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            Save Project
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Project Detail Modal -->
  <div class="modal-overlay" id="project-detail-modal" onclick="if(event.target === this) closeProjectDetail()">
    <div class="modal-content" style="max-width: 720px;">
      <div class="modal-header">
        <h2 class="modal-title" id="project-detail-title">Project Details</h2>
        <button class="modal-close" onclick="closeProjectDetail()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="project-detail-body" style="max-height: 70vh; overflow-y: auto;">
        <div class="spinner" style="margin: 40px auto;"></div>
      </div>
    </div>
  </div>

  <!-- Payment Request Modal -->
  <div id="payment-request-modal" class="payment-modal" style="display: none;" onclick="if(event.target === this) closePaymentModal()">
    <div class="payment-modal-content">
      <div class="payment-modal-header">
        <h3>Send Payment Request</h3>
        <button class="payment-modal-close" onclick="closePaymentModal()">&times;</button>
      </div>
      <div class="payment-modal-body">
        <div class="payment-modal-info">
          <p><strong>To:</strong> <span id="payment-recipient-name"></span></p>
          <p><strong>Email:</strong> <span id="payment-recipient-email"></span></p>
        </div>
        <form id="payment-request-form" onsubmit="return sendPaymentRequest(event)">
          <input type="hidden" id="payment-inquiry-id">
          <input type="hidden" id="payment-customer-email">
          <input type="hidden" id="payment-customer-name">
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="payment-amount" step="0.01" min="1" required placeholder="500.00">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="payment-description" required placeholder="Stone remnant - Calacatta Gold 24x36">
          </div>
          <div class="form-group">
            <label>Note to Customer (optional)</label>
            <textarea id="payment-note" rows="3" placeholder="Thank you for your interest! Here's the payment link for your purchase..."></textarea>
          </div>
        </form>
      </div>
      <div class="payment-modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closePaymentModal()">Cancel</button>
        <button type="submit" form="payment-request-form" class="btn-modern primary" id="send-payment-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Send Payment Link
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';

    const SUPER_ADMIN_EMAILS = ['joshb@surprisegranite.com', 'info@surprisegranite.com'];

    let supabaseClient;
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let userRole = 'customer'; // customer, contractor, vendor, admin

    // Google Maps variables (googleMapsReady is defined in head section)
    let locationAutocomplete = null;
    let locationMap = null;
    let locationMarker = null;

    // Listen for Google Maps ready event (dispatched by callback in head)
    document.addEventListener('googlemaps-ready', function() {
      console.log('[GoogleMaps] Ready event received in main script');
      // Initialize autocomplete on location input if it exists and modal is open
      const locationInput = document.getElementById('cal-event-location');
      if (locationInput && document.getElementById('calendar-event-modal')?.classList.contains('active')) {
        initLocationAutocomplete(locationInput);
      }
    });

    // Initialize Places Autocomplete on an input element
    function initLocationAutocomplete(inputElement) {
      if (!googleMapsReady || !google?.maps?.places) {
        console.log('[GoogleMaps] API not ready, skipping autocomplete init');
        return;
      }

      try {
        locationAutocomplete = new google.maps.places.Autocomplete(inputElement, {
          types: ['address'],
          componentRestrictions: { country: 'us' },
          fields: ['formatted_address', 'geometry', 'name', 'address_components']
        });

        locationAutocomplete.addListener('place_changed', () => {
          const place = locationAutocomplete.getPlace();
          if (place.geometry) {
            updateLocationMapPreview(place);
          }
        });

        console.log('[GoogleMaps] Autocomplete initialized on location input');
      } catch (err) {
        console.warn('[GoogleMaps] Failed to initialize autocomplete:', err);
      }
    }

    // Update map preview when address is selected
    function updateLocationMapPreview(place) {
      const mapContainer = document.getElementById('location-map-preview');
      const mapElement = document.getElementById('location-map');
      const addressDisplay = document.getElementById('location-map-address');

      if (!mapContainer || !mapElement || !place.geometry) return;

      // Show map preview
      mapContainer.style.display = 'block';

      // Update address text
      if (addressDisplay) {
        addressDisplay.textContent = place.formatted_address || place.name || '';
      }

      // Initialize or update map
      const location = place.geometry.location;

      if (!locationMap) {
        locationMap = new google.maps.Map(mapElement, {
          center: location,
          zoom: 15,
          disableDefaultUI: true,
          zoomControl: true,
          styles: [
            { elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
            { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a2e' }] },
            { elementType: 'labels.text.fill', stylers: [{ color: '#8b8b8b' }] },
            { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d2d44' }] },
            { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e1a' }] }
          ]
        });
      } else {
        locationMap.setCenter(location);
      }

      // Add or update marker
      if (locationMarker) {
        locationMarker.setPosition(location);
      } else {
        locationMarker = new google.maps.Marker({
          map: locationMap,
          position: location,
          animation: google.maps.Animation.DROP
        });
      }
    }

    // Hide map preview
    function hideLocationMapPreview() {
      const mapContainer = document.getElementById('location-map-preview');
      if (mapContainer) {
        mapContainer.style.display = 'none';
      }
    }

    // Generate Google Calendar URL for an event
    function generateGoogleCalendarUrl(event) {
      const baseUrl = 'https://calendar.google.com/calendar/render';

      // Format dates for Google Calendar (YYYYMMDDTHHmmssZ format)
      const formatDateForGCal = (dateStr) => {
        const d = new Date(dateStr);
        return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      };

      const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: event.title || 'Appointment',
        dates: `${formatDateForGCal(event.start_time)}/${formatDateForGCal(event.end_time)}`,
        details: event.description || '',
        location: event.location || '',
        sf: 'true',
        output: 'xml'
      });

      return `${baseUrl}?${params.toString()}`;
    }

    // Open Google Calendar with event details
    function addToGoogleCalendar(event) {
      const url = generateGoogleCalendarUrl(event);
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // Initialize map in event detail modal
    let eventDetailMap = null;
    let eventDetailMarker = null;

    function initEventDetailMap(address) {
      if (!googleMapsReady || !google?.maps) {
        console.log('[GoogleMaps] API not ready for event detail map');
        return;
      }

      const mapElement = document.getElementById('event-detail-map');
      if (!mapElement) return;

      // Use Geocoder to get coordinates from address
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const location = results[0].geometry.location;

          // Create or update map
          eventDetailMap = new google.maps.Map(mapElement, {
            center: location,
            zoom: 15,
            disableDefaultUI: true,
            zoomControl: false,
            styles: [
              { elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
              { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a2e' }] },
              { elementType: 'labels.text.fill', stylers: [{ color: '#8b8b8b' }] },
              { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d2d44' }] },
              { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e1a' }] },
              { featureType: 'poi', stylers: [{ visibility: 'off' }] }
            ]
          });

          // Add marker
          eventDetailMarker = new google.maps.Marker({
            map: eventDetailMap,
            position: location,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: '#f9cb00',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2
            }
          });
        } else {
          // Hide map container if geocoding fails
          mapElement.style.display = 'none';
          console.log('[GoogleMaps] Geocoding failed for:', address);
        }
      });
    }

    // Auth ready state tracking - prevents race conditions
    let authReady = false;
    let authReadyPromise = null;
    let authReadyResolve = null;

    // Create promise that resolves when auth is ready
    function createAuthReadyPromise() {
      authReadyPromise = new Promise(resolve => {
        authReadyResolve = resolve;
      });
    }
    createAuthReadyPromise();

    function setAuthReady() {
      console.log('[Auth] setAuthReady called');
      authReady = true;
      if (authReadyResolve) {
        authReadyResolve();
      }
    }

    async function waitForAuth(timeoutMs = 10000) {
      console.log('[Auth] waitForAuth called, authReady:', authReady);
      if (authReady) return true;
      if (authReadyPromise) {
        // Add timeout to prevent infinite wait
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Auth timeout')), timeoutMs);
        });
        try {
          await Promise.race([authReadyPromise, timeoutPromise]);
        } catch (err) {
          console.error('[Auth] waitForAuth timeout or error:', err.message);
          // If we timeout, check if supabaseClient exists and try to proceed anyway
          if (supabaseClient) {
            console.log('[Auth] supabaseClient exists, proceeding despite timeout');
            authReady = true;
            return true;
          }
          return false;
        }
      }
      console.log('[Auth] waitForAuth completed, authReady:', authReady);
      return authReady;
    }

    // Role-based feature permissions
    const ROLE_PERMISSIONS = {
      homeowner: {
        nav: ['dashboard', 'profile', 'favorites', 'tools', 'calendar'],
        features: ['view_own_jobs', 'view_estimates', 'approve_estimates', 'pay_invoices', 'view_calendar', 'upload_files', 'leave_reviews']
      },
      customer: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'calendar', 'messages'],
        features: ['view_own_jobs', 'view_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews']
      },
      pro: {
        nav: ['dashboard', 'profile', 'favorites', 'my-designs', 'listings', 'leads', 'customers', 'estimates', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'messages'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'message_team', 'view_calendar', 'upload_files', 'view_collaborators', 'manage_customers', 'view_leads', 'ai_tools', 'analytics']
      },
      contractor: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'customers', 'estimates', 'invoices', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'products', 'orders', 'messages'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews', 'view_collaborators', 'manage_customers', 'view_leads', 'hire_subcollaborators', 'ai_tools', 'analytics']
      },
      fabricator: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'customers', 'estimates', 'invoices', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'products', 'orders', 'messages', 'inventory', 'slabs'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews', 'view_collaborators', 'manage_customers', 'view_leads', 'hire_subcollaborators', 'ai_tools', 'analytics', 'manage_inventory', 'slab_management']
      },
      vendor: {
        nav: ['dashboard', 'profile', 'products', 'orders', 'customers', 'messages', 'calendar', 'wallet'],
        features: ['list_products', 'receive_orders', 'view_analytics', 'message_team', 'manage_inventory', 'connect_collaborators']
      },
      distributor: {
        nav: ['dashboard', 'profile', 'products', 'orders', 'customers', 'messages', 'calendar', 'wallet', 'inventory', 'slabs'],
        features: ['list_products', 'receive_orders', 'view_analytics', 'message_team', 'manage_inventory', 'slab_management', 'connect_collaborators'],
        redirectTo: '/distributor/dashboard/'
      },
      admin: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'customers', 'estimates', 'invoices', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'admin-users', 'products', 'orders', 'messages', 'inventory', 'slabs', 'analytics', 'settings'],
        features: ['full_access']
      }
    };

    // Apply role-based navigation visibility
    function applyRoleBasedNav(role) {
      const permissions = ROLE_PERMISSIONS[role] || ROLE_PERMISSIONS.customer;
      const allowedNavItems = permissions.nav;

      console.log('Applying nav for role:', role, 'Allowed items:', allowedNavItems);

      // Get all nav items with data-page attribute
      const navItems = document.querySelectorAll('.nav-item[data-page]');

      navItems.forEach(item => {
        const page = item.dataset.page;
        if (allowedNavItems.includes(page)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });

      // Show/hide nav sections based on role
      const salesNavEl = document.getElementById('sales-nav');
      const operationsNavEl = document.getElementById('operations-nav');
      const financeNavEl = document.getElementById('finance-nav');
      const adminNavEl = document.getElementById('admin-nav');
      const vendorNavEl = document.getElementById('vendor-nav');

      // Sales section - visible to collaborators and admins
      if (salesNavEl) {
        const showSalesNav = ['contractor', 'fabricator', 'admin'].includes(role);
        salesNavEl.classList.toggle('hidden', !showSalesNav);
        console.log('Sales nav:', showSalesNav ? 'visible' : 'hidden');
      }

      // Operations section - visible to all roles for project management
      if (operationsNavEl) {
        operationsNavEl.classList.remove('hidden');
        console.log('Operations nav: visible (enabled for all roles)');
      }

      // Finance section - visible to admins only
      if (financeNavEl) {
        const showFinanceNav = ['admin'].includes(role);
        financeNavEl.classList.toggle('hidden', !showFinanceNav);
        console.log('Finance nav:', showFinanceNav ? 'visible' : 'hidden');
      }

      // Admin section - visible to super admins only
      if (adminNavEl) {
        const showAdminNav = isSuperAdmin || role === 'admin';
        adminNavEl.classList.toggle('hidden', !showAdminNav);
        console.log('Admin nav:', showAdminNav ? 'visible' : 'hidden');
      }

      // Vendor/Store section - visible to vendors and admins
      if (vendorNavEl) {
        const showVendorNav = ['vendor', 'admin'].includes(role);
        vendorNavEl.classList.toggle('hidden', !showVendorNav);
        console.log('Vendor nav:', showVendorNav ? 'visible' : 'hidden');
      }

      // GOD MODE section - visible ONLY to GOD_MODE_EMAILS
      const godModeNavEl = document.getElementById('god-mode-nav');
      if (godModeNavEl) {
        const showGodMode = isGodMode();
        godModeNavEl.classList.toggle('hidden', !showGodMode);
        // Also set inline display to ensure it's hidden
        godModeNavEl.style.display = showGodMode ? 'block' : 'none';
        console.log('GOD MODE nav:', showGodMode ? 'visible ( ENABLED)' : 'hidden');

        // Add special body class for GOD MODE users
        if (showGodMode) {
          document.body.classList.add('god-mode-active');
        } else {
          document.body.classList.remove('god-mode-active');
        }
      }

      // Add role indicator to body for CSS targeting
      document.body.dataset.userRole = role;

      console.log('Applied role-based nav for:', role);
    }

    // Check if user has permission for a feature
    function hasPermission(feature) {
      const permissions = ROLE_PERMISSIONS[userRole] || ROLE_PERMISSIONS.customer;
      return permissions.features.includes('full_access') || permissions.features.includes(feature);
    }

    // Switch role (for demo/testing)
    function switchRole(newRole) {
      if (!ROLE_PERMISSIONS[newRole]) return;

      // Check if role has a redirect (like distributor)
      const roleConfig = ROLE_PERMISSIONS[newRole];
      if (roleConfig.redirectTo) {
        showToast(`Redirecting to ${newRole} dashboard...`);
        window.location.href = roleConfig.redirectTo;
        return;
      }

      userRole = newRole;

      // Update role flags based on new role
      isAdmin = ['admin', 'super_admin'].includes(newRole);
      isSuperAdmin = newRole === 'super_admin';

      applyRoleBasedNav(newRole);

      // Update role display
      const roleEl = document.getElementById('user-role');
      const roleLabels = { homeowner: 'Homeowner', customer: 'Customer', contractor: 'Contractor', vendor: 'Vendor', pro: 'Pro', fabricator: 'Fabricator', distributor: 'Distributor', admin: 'Admin' };
      if (roleEl) roleEl.textContent = roleLabels[newRole] || 'Customer';

      // Show notification
      showToast(`Switched to ${roleLabels[newRole]} view`);

      // Refresh current page to show role-specific content
      const activePage = document.querySelector('.page.active');
      if (activePage) {
        const pageId = activePage.id.replace('page-', '');
        showPage(pageId);
      }
    }

    // GOD mode emails - EXCLUSIVE access to developer tools and role switcher
    const GOD_MODE_EMAILS = ['joshb@surprisegranite.com', 'sgk112@gmail.com'];

    // Check if current user has GOD MODE access
    function isGodMode() {
      const userEmail = currentUser?.email?.toLowerCase() || '';
      return GOD_MODE_EMAILS.includes(userEmail);
    }

    // Show role switcher only for GOD mode users
    function enableRoleSwitcher() {
      const switcher = document.getElementById('role-switcher');
      const select = document.getElementById('role-select');
      const userEmail = currentUser?.email?.toLowerCase() || '';

      // Only show for GOD mode emails
      if (switcher && select && GOD_MODE_EMAILS.includes(userEmail)) {
        switcher.style.display = 'block';
        select.value = userRole;
      }
    }

    let allLeads = [];
    let currentFilter = 'all';
    let currentLeadsView = 'grid'; // 'grid', 'list', or 'kanban'
    let selectedLead = null;
    let editingLeadId = null; // Track if we're editing an existing lead
    let showArchivedLeads = false; // Hide archived leads by default

    let allCustomers = [];
    let selectedCustomer = null;
    let customerFilter = 'all';
    let currentCustomerTab = 'jobs';

    // Global contractors state
    let allContractors = [];

    // Global estimates state
    let allEstimates = [];
    let selectedEstimate = null;
    let currentEstimateFilter = 'all';

    // ============================================
    // UNIFIED WORKFLOW STATE
    // Centralized state management for lead  customer  estimate  invoice  job flow
    // ============================================
    const workflowState = {
      currentLead: null,
      currentCustomer: null,
      currentEstimate: null,
      currentInvoice: null,
      currentJob: null,
      reset() {
        this.currentLead = null;
        this.currentCustomer = null;
        this.currentEstimate = null;
        this.currentInvoice = null;
        this.currentJob = null;
      }
    };

    // Modal-specific state for estimate creation
    let estimateModalState = {
      customerId: null,
      leadId: null,
      editingEstimateId: null
    };

    // ============================================
    // UNIVERSAL CONTEXT MENU SYSTEM
    // Right-click menus for jobs, invoices, customers, estimates, leads
    // ============================================
    const ContextMenu = {
      menu: null,
      overlay: null,
      currentItem: null,
      currentType: null,

      init() {
        // Create menu container
        this.menu = document.createElement('div');
        this.menu.className = 'context-menu';
        this.menu.id = 'universal-context-menu';
        document.body.appendChild(this.menu);

        // Create overlay for closing
        this.overlay = document.createElement('div');
        this.overlay.className = 'context-menu-overlay';
        this.overlay.style.display = 'none';
        this.overlay.addEventListener('click', () => this.hide());
        this.overlay.addEventListener('contextmenu', (e) => { e.preventDefault(); this.hide(); });
        document.body.appendChild(this.overlay);

        // Global right-click listener
        document.addEventListener('contextmenu', (e) => this.handleContextMenu(e));

        // Close on scroll or escape
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.hide(); });
        document.addEventListener('scroll', () => this.hide(), true);
      },

      handleContextMenu(e) {
        const target = e.target.closest('[data-context-menu]');
        if (!target) return;

        e.preventDefault();

        const menuType = target.dataset.contextMenu;
        const itemId = target.dataset.itemId;
        const itemData = target.dataset.itemData ? JSON.parse(target.dataset.itemData) : {};

        this.show(e.clientX, e.clientY, menuType, itemId, itemData, target);
      },

      show(x, y, type, itemId, itemData, targetElement) {
        this.currentType = type;
        this.currentItem = { id: itemId, ...itemData };

        // Clear previous highlight
        document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));

        // Highlight current row
        if (targetElement) {
          targetElement.classList.add('context-active');
        }

        // Build menu content
        const menuContent = this.buildMenu(type, itemData);
        this.menu.innerHTML = menuContent;

        // Show overlay and menu
        this.overlay.style.display = 'block';
        this.menu.classList.add('visible');

        // Position menu
        this.position(x, y);

        // Attach click handlers
        this.attachHandlers();
      },

      hide() {
        this.menu.classList.remove('visible');
        this.overlay.style.display = 'none';
        document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));
        this.currentItem = null;
        this.currentType = null;
      },

      position(x, y) {
        const menuRect = this.menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        let posX = x;
        let posY = y;
        let originClass = '';

        // Adjust for right edge
        if (x + menuRect.width > viewportWidth - 10) {
          posX = x - menuRect.width;
          originClass = 'origin-right';
        }

        // Adjust for bottom edge
        if (y + menuRect.height > viewportHeight - 10) {
          posY = y - menuRect.height;
          originClass = originClass ? 'origin-bottom-right' : 'origin-bottom';
        }

        this.menu.style.left = Math.max(10, posX) + 'px';
        this.menu.style.top = Math.max(10, posY) + 'px';
        this.menu.className = 'context-menu visible ' + originClass;
      },

      buildMenu(type, itemData) {
        const menus = {
          job: this.buildJobMenu(itemData),
          invoice: this.buildInvoiceMenu(itemData),
          customer: this.buildCustomerMenu(itemData),
          estimate: this.buildEstimateMenu(itemData),
          lead: this.buildLeadMenu(itemData),
          calendar_event: this.buildCalendarEventMenu(itemData)
        };
        return menus[type] || '';
      },

      buildJobMenu(data) {
        const statusOptions = [
          { value: 'new', label: 'New' },
          { value: 'reviewing', label: 'Reviewing' },
          { value: 'material_ordered', label: 'Material Ordered' },
          { value: 'material_received', label: 'Material Received' },
          { value: 'scheduled', label: 'Scheduled' },
          { value: 'measured', label: 'Measured' },
          { value: 'in_production', label: 'In Production' },
          { value: 'ready', label: 'Ready' },
          { value: 'installing', label: 'Installing' },
          { value: 'completed', label: 'Completed' },
          { value: 'on_hold', label: 'On Hold' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">Job</div>
            <div class="subtitle">${data.job_number || 'Job'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Details
          </button>
          <button class="context-menu-item has-submenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <span class="status-dot ${s.value}"></span>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="schedule">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Schedule Job
          </button>
          <button class="context-menu-item" data-action="assign">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Assign Collaborator
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item warning" data-action="archive">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
            Archive Job
          </button>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Job
          </button>
        `;
      },

      buildInvoiceMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Invoice</div>
            <div class="subtitle">${data.invoice_number || 'Invoice'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Invoice
          </button>
          <button class="context-menu-item" data-action="open-stripe">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            Open in Stripe
          </button>
          <button class="context-menu-item" data-action="download-pdf">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Download PDF
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="send-reminder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Reminder
          </button>
          <button class="context-menu-item" data-action="copy-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            Copy Payment Link
          </button>
          <button class="context-menu-item" data-action="create-project">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            Create Project
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="void">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
            Void Invoice
          </button>
        `;
      },

      buildCustomerMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Customer</div>
            <div class="subtitle">${data.name || 'Customer'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            View Profile
          </button>
          <button class="context-menu-item primary" data-action="create-estimate">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Create Estimate
          </button>
          <button class="context-menu-item" data-action="create-invoice">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Create Invoice
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="email">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Email
          </button>
          <button class="context-menu-item" data-action="call">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            Call Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Customer
          </button>
        `;
      },

      buildEstimateMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Estimate</div>
            <div class="subtitle">${data.estimate_number || 'Estimate'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <i class="fa-regular fa-eye"></i>
            View Estimate
          </button>
          <button class="context-menu-item" data-action="edit">
            <i class="fa-regular fa-pen-to-square"></i>
            Edit Estimate
          </button>
          <button class="context-menu-item primary" data-action="convert-invoice">
            <i class="fa-solid fa-file-invoice-dollar"></i>
            Convert to Invoice
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="duplicate">
            <i class="fa-regular fa-clone"></i>
            Duplicate
          </button>
          <button class="context-menu-item" data-action="send">
            <i class="fa-regular fa-envelope"></i>
            Send to Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <i class="fa-regular fa-trash-can"></i>
            Delete Estimate
          </button>
        `;
      },

      buildLeadMenu(data) {
        const statusOptions = [
          { value: 'new', label: 'New' },
          { value: 'contacted', label: 'Contacted' },
          { value: 'qualified', label: 'Qualified' },
          { value: 'quoted', label: 'Quoted' },
          { value: 'won', label: 'Won' },
          { value: 'lost', label: 'Lost' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">Lead</div>
            <div class="subtitle">${data.name || 'Lead'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <i class="fa-regular fa-user"></i>
            View Lead
          </button>
          <button class="context-menu-item primary" data-action="create-estimate">
            <i class="fa-regular fa-file-lines"></i>
            Create Estimate
          </button>
          <button class="context-menu-item has-submenu">
            <i class="fa-solid fa-arrows-rotate"></i>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <span class="status-dot ${s.value}"></span>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item success" data-action="convert-customer">
            <i class="fa-solid fa-user-plus"></i>
            Convert to Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <i class="fa-regular fa-trash-can"></i>
            Delete Lead
          </button>
        `;
      },

      buildCalendarEventMenu(data) {
        const isApiEvent = !!data.apiEventId;
        const isJobEvent = !!data.jobId && !data.apiEventId;
        const statusOptions = [
          { value: 'scheduled', label: 'Scheduled', icon: 'fa-regular fa-calendar' },
          { value: 'confirmed', label: 'Confirmed', icon: 'fa-solid fa-circle-check' },
          { value: 'completed', label: 'Completed', icon: 'fa-solid fa-flag-checkered' },
          { value: 'cancelled', label: 'Cancelled', icon: 'fa-solid fa-circle-xmark' },
          { value: 'rescheduled', label: 'Rescheduled', icon: 'fa-solid fa-rotate' },
          { value: 'no_show', label: 'No Show', icon: 'fa-solid fa-user-slash' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">${isJobEvent ? 'Job Event' : 'Calendar Event'}</div>
            <div class="subtitle">${escapeHtml(data.title || 'Event')}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <i class="fa-regular fa-eye"></i>
            View Details
          </button>
          ${isApiEvent ? `
          <button class="context-menu-item" data-action="edit">
            <i class="fa-regular fa-pen-to-square"></i>
            Edit Event
          </button>
          <button class="context-menu-item has-submenu">
            <i class="fa-solid fa-arrows-rotate"></i>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <i class="${s.icon}" style="width: 16px; margin-right: 8px;"></i>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="reschedule">
            <i class="fa-regular fa-calendar-days"></i>
            Reschedule
          </button>
          <button class="context-menu-item" data-action="duplicate">
            <i class="fa-regular fa-clone"></i>
            Duplicate Event
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item success" data-action="confirm">
            <i class="fa-solid fa-circle-check"></i>
            Mark Confirmed
          </button>
          <button class="context-menu-item" data-action="complete">
            <i class="fa-solid fa-flag-checkered"></i>
            Mark Completed
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <i class="fa-regular fa-trash-can"></i>
            Delete Event
          </button>
          ` : `
          <button class="context-menu-item" data-action="view-job">
            <i class="fa-regular fa-clipboard"></i>
            Open Job Details
          </button>
          <button class="context-menu-item" data-action="create-event">
            <i class="fa-solid fa-calendar-plus"></i>
            Create Calendar Event
          </button>
          `}
        `;
      },

      attachHandlers() {
        this.menu.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            const status = btn.dataset.status;
            this.handleAction(action, status);
          });
        });
      },

      handleAction(action, status) {
        const item = this.currentItem;
        const type = this.currentType;

        this.hide();

        // Route to appropriate handler based on type and action
        switch (type) {
          case 'job':
            this.handleJobAction(action, item, status);
            break;
          case 'invoice':
            this.handleInvoiceAction(action, item);
            break;
          case 'customer':
            this.handleCustomerAction(action, item);
            break;
          case 'estimate':
            this.handleEstimateAction(action, item);
            break;
          case 'lead':
            this.handleLeadAction(action, item, status);
            break;
          case 'calendar_event':
            this.handleCalendarEventAction(action, item, status);
            break;
        }
      },

      async handleJobAction(action, item, status) {
        switch (action) {
          case 'view':
            openJobDetail(item.id);
            break;
          case 'status':
            await updateJobStatusById(item.id, status);
            break;
          case 'schedule':
            openQuickScheduleModal(null, item.id);
            break;
          case 'assign':
            openAssignCollaboratorModal(item.id);
            break;
          case 'archive':
            await archiveJob(item.id);
            break;
          case 'delete':
            await deleteJob(item.id);
            break;
        }
      },

      async handleInvoiceAction(action, item) {
        switch (action) {
          case 'view':
            // Use unified view function that handles both Supabase and Stripe invoices
            viewSupabaseInvoice(item.id);
            break;
          case 'open-stripe':
            if (item.hosted_invoice_url) {
              window.open(item.hosted_invoice_url, '_blank');
            } else {
              showToast('No Stripe payment link available', 'warning');
            }
            break;
          case 'download-pdf':
            if (item.pdf_url) {
              window.open(item.pdf_url, '_blank');
            } else {
              showToast('No PDF available for this invoice', 'warning');
            }
            break;
          case 'send-reminder':
            await sendInvoiceReminder(item.id);
            break;
          case 'copy-link':
            if (item.hosted_invoice_url) {
              await navigator.clipboard.writeText(item.hosted_invoice_url);
              showToast('Payment link copied!', 'success');
            }
            break;
          case 'create-project':
            createProjectFromInvoice(item.id);
            break;
          case 'void':
            await voidInvoice(item.id);
            break;
        }
      },

      handleCustomerAction(action, item) {
        switch (action) {
          case 'view':
            selectCustomer(item.id);
            break;
          case 'create-estimate':
            startEstimateFromCustomer(item.id);
            break;
          case 'create-invoice':
            openInvoiceModal(item);
            break;
          case 'email':
            if (item.email) {
              window.location.href = `mailto:${item.email}`;
            }
            break;
          case 'call':
            if (item.phone) {
              window.location.href = `tel:${item.phone}`;
            }
            break;
          case 'delete':
            deleteCustomer(item.id);
            break;
        }
      },

      async handleEstimateAction(action, item) {
        switch (action) {
          case 'view':
            viewEstimate(item.id);
            break;
          case 'edit':
            editEstimate(item.id);
            break;
          case 'convert-invoice':
            convertEstimateToInvoice(item.id);
            break;
          case 'duplicate':
            await duplicateEstimate(item.id);
            break;
          case 'send':
            sendEstimateEmail(item.id);
            break;
          case 'delete':
            deleteEstimate(item.id);
            break;
        }
      },

      async handleLeadAction(action, item, status) {
        switch (action) {
          case 'view':
            viewLead(item.id);
            break;
          case 'create-estimate':
            startEstimateFromLead(item.id);
            break;
          case 'status':
            await updateLeadStatus(item.id, status);
            break;
          case 'convert-customer':
            await convertLeadToCustomer(item.id);
            break;
          case 'delete':
            await deleteLead(item.id);
            break;
        }
      },

      async handleCalendarEventAction(action, item, status) {
        const eventId = item.apiEventId || item.id;
        const jobId = item.jobId;

        switch (action) {
          case 'view':
            if (item.apiEventId) {
              openCalendarEventDetailModal(item.apiEventId);
            } else if (jobId) {
              openJobDetail(jobId);
            }
            break;
          case 'edit':
            if (item.apiEventId) {
              openCalendarEventModal(item.apiEventId);
            }
            break;
          case 'status':
            if (item.apiEventId && status) {
              await updateCalendarEventStatus(item.apiEventId, status);
            }
            break;
          case 'reschedule':
            if (item.apiEventId) {
              openCalendarEventModal(item.apiEventId);
            }
            break;
          case 'duplicate':
            if (item.apiEventId) {
              await duplicateCalendarEvent(item.apiEventId);
            }
            break;
          case 'confirm':
            if (item.apiEventId) {
              await updateCalendarEventStatus(item.apiEventId, 'confirmed');
            }
            break;
          case 'complete':
            if (item.apiEventId) {
              await updateCalendarEventStatus(item.apiEventId, 'completed');
            }
            break;
          case 'delete':
            if (item.apiEventId) {
              await deleteCalendarEvent(item.apiEventId);
            }
            break;
          case 'view-job':
            if (jobId) {
              openJobDetail(jobId);
            }
            break;
          case 'create-event':
            // Create a new calendar event linked to this job
            openCalendarEventModal(null, item.date, {
              title: item.title,
              projectId: jobId,
              type: item.type === 'measure' ? 'measurement' : item.type === 'install' ? 'installation' : 'appointment'
            });
            break;
        }
      }
    };

    // Calendar event status update helper
    async function updateCalendarEventStatus(eventId, status) {
      try {
        const { error } = await supabaseClient
          .from('calendar_events')
          .update({ status, updated_at: new Date().toISOString() })
          .eq('id', eventId);

        if (error) throw error;

        showToast(`Event marked as ${status}`, 'success');
        await loadCalendarEvents();
        await loadAllCalendarEvents();
      } catch (err) {
        console.error('Error updating event status:', err);
        showToast('Failed to update event status', 'error');
      }
    }

    // Duplicate calendar event helper
    async function duplicateCalendarEvent(eventId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Fetch original event
        const { data: original, error: fetchError } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('id', eventId)
          .single();

        if (fetchError) throw fetchError;

        // Create duplicate with new dates (tomorrow)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);

        const originalStart = new Date(original.start_time);
        const originalEnd = new Date(original.end_time);
        const duration = originalEnd - originalStart;

        const newStart = new Date(tomorrow);
        newStart.setHours(originalStart.getHours(), originalStart.getMinutes(), 0, 0);
        const newEnd = new Date(newStart.getTime() + duration);

        const duplicateData = {
          created_by: user.id,
          title: `${original.title} (Copy)`,
          description: original.description,
          event_type: original.event_type,
          meeting_format: original.meeting_format,
          start_time: newStart.toISOString(),
          end_time: newEnd.toISOString(),
          location: original.location,
          lead_id: original.lead_id,
          customer_id: original.customer_id,
          project_id: original.project_id,
          metadata: original.metadata,
          status: 'scheduled'
        };

        const { data: newEvent, error: insertError } = await supabaseClient
          .from('calendar_events')
          .insert(duplicateData)
          .select()
          .single();

        if (insertError) throw insertError;

        showToast('Event duplicated', 'success');

        // Open the new event for editing
        openCalendarEventModal(newEvent.id);

        await loadCalendarEvents();
        await loadAllCalendarEvents();
      } catch (err) {
        console.error('Error duplicating event:', err);
        showToast('Failed to duplicate event', 'error');
      }
    }

    // Initialize context menu on page load
    document.addEventListener('DOMContentLoaded', () => {
      ContextMenu.init();
    });

    // ============================================
    // HELPER FUNCTIONS FOR UNIFIED FLOW
    // ============================================

    // Fetch customer from database (not just cached array)
    async function getCustomer(customerId) {
      if (!customerId) return null;

      // Try cache first
      let customer = allCustomers?.find(c => c.id === customerId);
      if (customer) return customer;

      // Fetch from database
      try {
        const { data, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('id', customerId)
          .single();

        if (!error && data) {
          // Add to cache
          if (!allCustomers) allCustomers = [];
          allCustomers.push(data);
          return data;
        }
      } catch (e) {
        console.error('Error fetching customer:', e);
      }
      return null;
    }

    // Find or create customer from lead data
    async function findOrCreateCustomerFromLead(lead) {
      if (!lead) {
        console.error('[findOrCreateCustomerFromLead] No lead provided');
        return null;
      }

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        console.error('[findOrCreateCustomerFromLead] No user logged in');
        return null;
      }

      console.log('[findOrCreateCustomerFromLead] Processing lead:', lead.id, lead.email);

      // Check if customer already exists with this email
      if (lead.email) {
        const { data: existing, error: findError } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .eq('email', lead.email)
          .maybeSingle();

        if (findError) {
          console.error('[findOrCreateCustomerFromLead] Error finding customer:', findError);
        }

        if (existing) {
          console.log('[findOrCreateCustomerFromLead] Found existing customer:', existing.id);
          // Update lead with customer_id reference
          const { error: updateError } = await supabaseClient.from('leads').update({ customer_id: existing.id }).eq('id', lead.id);
          if (updateError) console.error('[findOrCreateCustomerFromLead] Error updating lead:', updateError);
          return existing;
        }
      }

      // Parse name
      const nameParts = (lead.full_name || '').trim().split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      // Parse address
      let address = '', city = '', state = 'AZ', zip = '';
      if (lead.service_address) {
        // service_address could be string or object
        if (typeof lead.service_address === 'string') {
          address = lead.service_address;
        } else if (typeof lead.service_address === 'object') {
          address = lead.service_address.street || lead.service_address.address || '';
          city = lead.service_address.city || '';
          state = lead.service_address.state || 'AZ';
          zip = lead.service_address.zip || lead.service_address.zip_code || '';
        }
      } else if (lead.billing_address) {
        // billing_address could be string or object
        if (typeof lead.billing_address === 'string') {
          const parts = lead.billing_address.split(',').map(s => s.trim());
          address = parts[0] || '';
          city = parts[1] || '';
          const stateZip = (parts[2] || '').split(' ');
          state = stateZip[0] || 'AZ';
          zip = stateZip[1] || '';
        } else if (typeof lead.billing_address === 'object') {
          address = lead.billing_address.street || lead.billing_address.address || '';
          city = lead.billing_address.city || '';
          state = lead.billing_address.state || 'AZ';
          zip = lead.billing_address.zip || lead.billing_address.zip_code || '';
        }
      } else if (lead.project_address) {
        address = lead.project_address;
      }

      // Create new customer (with bidirectional lead_id reference)
      console.log('[findOrCreateCustomerFromLead] Creating new customer for:', lead.full_name, lead.email);
      const { data: newCustomer, error } = await supabaseClient
        .from('customers')
        .insert({
          user_id: user.id,
          name: lead.full_name || 'Customer',
          email: lead.email || null,
          phone: lead.phone || null,
          address: address || null,
          city: city || null,
          state: state || 'AZ',
          zip: zip || null,
          lead_id: lead.id, // Bidirectional reference back to lead
          source: 'lead_conversion',
          notes: `Converted from lead. Project: ${lead.project_type || 'N/A'}`
        })
        .select()
        .single();

      if (error) {
        console.error('[findOrCreateCustomerFromLead] Error creating customer:', error);
        showToast('Error creating customer: ' + (error.message || 'Unknown error'), 'error');
        return null;
      }

      if (newCustomer) {
        console.log('[findOrCreateCustomerFromLead] Created customer:', newCustomer.id);
        // Update lead with customer reference
        const { error: updateError } = await supabaseClient.from('leads').update({
          customer_id: newCustomer.id,
          status: 'qualified'
        }).eq('id', lead.id);

        if (updateError) {
          console.error('[findOrCreateCustomerFromLead] Error updating lead:', updateError);
        } else {
          console.log('[findOrCreateCustomerFromLead] Updated lead with customer_id');
        }

        // Add to cache
        if (!allCustomers) allCustomers = [];
        allCustomers.push(newCustomer);

        // Refresh leads list
        loadLeads();

        return newCustomer;
      }

      return null;
    }

    // Create customer from estimate form data
    async function createCustomerFromEstimateForm(formData) {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return null;

      // Check if customer exists with this email
      if (formData.customerEmail) {
        const { data: existing } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .eq('email', formData.customerEmail)
          .single();

        if (existing) return existing;
      }

      // Create new customer
      const { data: newCustomer, error } = await supabaseClient
        .from('customers')
        .insert({
          user_id: user.id,
          name: formData.customerName || 'Customer',
          email: formData.customerEmail,
          phone: formData.customerPhone,
          address: formData.customerAddress,
          city: formData.customerCity,
          state: formData.customerState || 'AZ',
          source: 'estimate_creation'
        })
        .select()
        .single();

      if (!error && newCustomer) {
        if (!allCustomers) allCustomers = [];
        allCustomers.push(newCustomer);
        return newCustomer;
      }

      return null;
    }

    // Pre-fill estimate form with customer data
    function fillEstimateCustomerFields(customer) {
      if (!customer) return;

      const fields = {
        'estimate-customer-name': customer.name,
        'estimate-customer-email': customer.email,
        'estimate-customer-phone': customer.phone,
        'estimate-customer-address': customer.address,
        'estimate-customer-city': customer.city,
        'estimate-customer-state': customer.state || 'AZ'
      };

      Object.entries(fields).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el && value) el.value = value;
      });
    }

    // Initialize with timeout fallback
    document.addEventListener('DOMContentLoaded', async () => {
      // Fallback timer - show dashboard/auth if things take too long
      const fallbackTimer = setTimeout(() => {
        console.warn('Init timeout - forcing display');
        // Check if we have a cached session indicator
        const hasSession = localStorage.getItem('sb-ypeypgwsycxcagncgdur-auth-token');
        if (hasSession) {
          showDashboard();
        } else {
          showAuth();
        }
      }, 5000);

      try {
        // Wait for Supabase to be available (max 3 seconds)
        let attempts = 0;
        while (!window.supabase && attempts < 30) {
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }

        if (!window.supabase) {
          console.error('Supabase library failed to load after', attempts * 100, 'ms');
          clearTimeout(fallbackTimer);
          showAuth();
          return;
        }

        const { createClient } = window.supabase;

        // Check localStorage availability (mobile Safari ITP workaround)
        let storageAvailable = true;
        try {
          localStorage.setItem('__storage_test__', '1');
          localStorage.removeItem('__storage_test__');
        } catch (e) {
          storageAvailable = false;
          console.warn('localStorage unavailable, using memory storage');
        }

        // Create custom storage that falls back gracefully
        const customStorage = storageAvailable ? window.localStorage : {
          _data: {},
          getItem(key) { return this._data[key] || null; },
          setItem(key, value) { this._data[key] = value; },
          removeItem(key) { delete this._data[key]; }
        };

        // Use global client or create our own
        supabaseClient = window._sgSupabaseClient;
        if (!supabaseClient) {
          console.log('Creating local Supabase client');
          const { createClient } = window.supabase;
          supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
              storage: customStorage,
              autoRefreshToken: true,
              persistSession: true
            }
          });
          window._sgSupabaseClient = supabaseClient;
        }

        // Listen for auth state changes (handles token refresh on mobile)
        let authChangeHandled = false;
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          console.log('Account Auth State:', event);

          // Prevent double-handling
          if (authChangeHandled && event === 'INITIAL_SESSION') return;

          if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
            currentUser = null;
            showAuth();
          } else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'INITIAL_SESSION') {
            if (session) {
              authChangeHandled = true;
              currentUser = session.user;
              // Refresh profile on token refresh
              loadUserProfile().catch(err => console.warn('Profile refresh failed:', err));
            }
          }
        });

        // Try to get session with retry for mobile
        let session = null;
        let sessionError = null;

        for (let retry = 0; retry < 2; retry++) {
          const result = await supabaseClient.auth.getSession();
          session = result.data?.session;
          sessionError = result.error;

          if (session || !sessionError) break;

          // Wait before retry
          await new Promise(r => setTimeout(r, 500));
        }

        clearTimeout(fallbackTimer);

        if (sessionError) {
          console.error('Session error:', sessionError);
          // Only redirect if this is a real error, not just missing session
          if (sessionError.message?.includes('refresh_token')) {
            showAuth();
            return;
          }
        }

        if (session) {
          console.log('[Init] Session found, loading profile...');
          currentUser = session.user;
          // Load profile BEFORE showing dashboard so isAdmin is set correctly
          try {
            await loadUserProfile();
            console.log('[Init] Profile loaded, showing dashboard...');
          } catch (err) {
            console.warn('[Init] Profile load failed:', err);
          }
          showDashboard();
        } else {
          console.log('[Init] No session, showing auth');
          showAuth();
        }
      } catch (err) {
        clearTimeout(fallbackTimer);
        console.error('Init error:', err);
        showAuth();
      }
    });

    function showAuth() {
      // Check for incoming redirect parameter (e.g., from tools page auth check)
      const params = new URLSearchParams(window.location.search);
      const incomingRedirect = params.get('redirect');
      if (incomingRedirect) {
        // Store the original redirect destination for after login
        sessionStorage.setItem('auth_redirect', incomingRedirect);
      }
      // Redirect to unified login page instead of showing embedded auth
      window.location.href = '/log-in/?redirect=' + encodeURIComponent(window.location.pathname + window.location.hash);
    }

    // ============================================
    // NOTIFICATIONS SYSTEM
    // ============================================
    let allNotifications = [];
    let notificationPanelOpen = false;

    function toggleNotificationPanel() {
      const panel = document.getElementById('notification-panel');
      notificationPanelOpen = !notificationPanelOpen;
      panel.style.display = notificationPanelOpen ? 'block' : 'none';

      if (notificationPanelOpen) {
        loadNotifications();
        // Close when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeNotificationPanelOnClickOutside);
        }, 100);
      } else {
        document.removeEventListener('click', closeNotificationPanelOnClickOutside);
      }
    }

    function closeNotificationPanelOnClickOutside(e) {
      const panel = document.getElementById('notification-panel');
      const bell = e.target.closest('.notification-bell-wrapper');
      if (!bell && !panel.contains(e.target)) {
        notificationPanelOpen = false;
        panel.style.display = 'none';
        document.removeEventListener('click', closeNotificationPanelOnClickOutside);
      }
    }

    async function loadNotifications() {
      if (!supabaseClient || !currentUser) return;

      try {
        // Load from pro_notifications table
        const { data: notifications, error } = await supabaseClient
          .from('pro_notifications')
          .select('*')
          .eq('pro_user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(20);

        if (error) {
          console.warn('Could not load notifications:', error.message);
          // Fall back to generating notifications from recent activity
          await loadNotificationsFromActivity();
          return;
        }

        // Merge with StateManager viewed state for local persistence
        allNotifications = (notifications || []).map(notif => {
          if (typeof StateManager !== 'undefined' && StateManager.isNotificationViewed(notif.id)) {
            return { ...notif, read: true };
          }
          return notif;
        });
        renderNotificationPanel();
        updateNotificationBadge();
      } catch (err) {
        console.warn('Notifications error:', err);
        await loadNotificationsFromActivity();
      }
    }

    async function loadNotificationsFromActivity() {
      // Generate notifications from recent leads, appointments, etc.
      const notifications = [];

      try {
        // Recent leads (last 7 days)
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data: recentLeads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, created_at, status')
          .gte('created_at', weekAgo)
          .order('created_at', { ascending: false })
          .limit(10);

        (recentLeads || []).forEach(lead => {
          notifications.push({
            id: 'lead-' + lead.id,
            type: 'new_lead',
            title: 'New Lead',
            message: `${lead.full_name || lead.email || 'Someone'} submitted a lead`,
            created_at: lead.created_at,
            read: lead.status !== 'new',
            data: { lead_id: lead.id }
          });
        });

        // Upcoming appointments (next 48 hours)
        const now = new Date().toISOString();
        const twoDaysOut = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
        const { data: upcomingEvents } = await supabaseClient
          .from('calendar_events')
          .select('id, title, start_time, status')
          .gte('start_time', now)
          .lte('start_time', twoDaysOut)
          .eq('status', 'scheduled')
          .order('start_time', { ascending: true })
          .limit(5);

        (upcomingEvents || []).forEach(event => {
          const eventDate = new Date(event.start_time);
          const hoursUntil = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
          notifications.push({
            id: 'event-' + event.id,
            type: 'appointment_reminder',
            title: hoursUntil <= 24 ? 'Appointment Soon' : 'Upcoming Appointment',
            message: `${event.title} - ${hoursUntil <= 1 ? 'in 1 hour' : hoursUntil <= 24 ? 'in ' + hoursUntil + ' hours' : 'tomorrow'}`,
            created_at: new Date().toISOString(),
            read: false,
            data: { event_id: event.id }
          });
        });

        // Events needing confirmation
        const { data: pendingEvents } = await supabaseClient
          .from('calendar_events')
          .select('id, title, start_time')
          .eq('status', 'scheduled')
          .gte('start_time', now)
          .order('start_time', { ascending: true })
          .limit(5);

        (pendingEvents || []).forEach(event => {
          notifications.push({
            id: 'confirm-' + event.id,
            type: 'action_required',
            title: 'Needs Confirmation',
            message: `${event.title} is pending confirmation`,
            created_at: event.start_time,
            read: false,
            data: { event_id: event.id, action: 'confirm' }
          });
        });

      } catch (err) {
        console.warn('Activity notifications error:', err);
      }

      // Sort by date
      notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // Check StateManager for previously viewed notifications
      allNotifications = notifications.slice(0, 20).map(notif => {
        if (typeof StateManager !== 'undefined' && StateManager.isNotificationViewed(notif.id)) {
          return { ...notif, read: true };
        }
        return notif;
      });

      // Add welcome notification for new features if user hasn't seen tutorial
      if (!localStorage.getItem('sg_tutorial_seen_v2')) {
        allNotifications.unshift({
          id: 'new-features-welcome',
          type: 'new_features',
          title: 'New Project Management Features!',
          message: 'We\'ve added Projects, Jobs, Calendar, and Team collaboration. Click to take a tour!',
          created_at: new Date().toISOString(),
          read: false,
          data: { action: 'start_tutorial' }
        });
      }

      renderNotificationPanel();
      updateNotificationBadge();
    }

    function renderNotificationPanel() {
      const list = document.getElementById('notification-list');
      if (!list) return;

      if (allNotifications.length === 0) {
        list.innerHTML = `
          <div class="empty-state" style="padding: 40px 20px; text-align: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <p style="color: var(--text-muted); margin: 0;">No new notifications</p>
          </div>
        `;
        return;
      }

      // Professional SVG icons for notification types
      const typeIcons = {
        new_lead: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>`,
          color: '#3b82f6',
          actions: [
            { label: 'Schedule', action: 'schedule_lead', primary: true },
            { label: 'View', action: 'view_lead' }
          ]
        },
        appointment_booked: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="m9 16 2 2 4-4"/></svg>`,
          color: '#10b981',
          actions: [
            { label: 'Confirm', action: 'confirm_appointment', primary: true },
            { label: 'Reschedule', action: 'reschedule_appointment' }
          ]
        },
        appointment_reminder: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
          color: '#f59e0b',
          actions: [
            { label: 'View Event', action: 'view_event', primary: true },
            { label: 'Send Reminder', action: 'send_reminder' }
          ]
        },
        action_required: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
          color: '#ef4444',
          actions: [
            { label: 'Take Action', action: 'take_action', primary: true },
            { label: 'Dismiss', action: 'dismiss' }
          ]
        },
        estimate_approved: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
          color: '#10b981',
          actions: [
            { label: 'Create Invoice', action: 'create_invoice', primary: true },
            { label: 'View', action: 'view_estimate' }
          ]
        },
        payment_received: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
          color: '#10b981',
          actions: [
            { label: 'View Invoice', action: 'view_invoice', primary: true },
            { label: 'Send Receipt', action: 'send_receipt' }
          ]
        },
        message_received: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
          color: '#8b5cf6',
          actions: [
            { label: 'Reply', action: 'reply_message', primary: true },
            { label: 'View', action: 'view_message' }
          ]
        },
        new_features: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
          color: '#f59e0b',
          actions: [
            { label: 'Learn More', action: 'start_tutorial', primary: true }
          ]
        },
        default: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
          color: '#6b7280',
          actions: []
        }
      };

      list.innerHTML = allNotifications.map(notif => {
        const typeInfo = typeIcons[notif.type] || typeIcons.default;
        const timeAgo = getTimeAgo(new Date(notif.created_at));
        const unreadStyle = notif.read ? '' : 'background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;';
        const dataAttr = encodeURIComponent(JSON.stringify(notif.data || {}));

        // Build action buttons
        const actionButtons = typeInfo.actions.map(act => {
          const btnStyle = act.primary
            ? `background: ${typeInfo.color}; color: white; border: none;`
            : `background: transparent; color: ${typeInfo.color}; border: 1px solid ${typeInfo.color}40;`;
          return `<button onclick="event.stopPropagation(); handleNotificationAction('${notif.id}', '${act.action}', '${dataAttr}')"
                          style="${btnStyle} padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    ${act.label}
                  </button>`;
        }).join('');

        return `
          <div class="notification-item" onclick="handleNotificationClick('${notif.id}', '${notif.type}', ${JSON.stringify(notif.data || {}).replace(/"/g, '&quot;')})"
               style="padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background 0.2s; ${unreadStyle}">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
              <div style="width: 38px; height: 38px; border-radius: 10px; background: ${typeInfo.color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: ${typeInfo.color};">
                ${typeInfo.icon}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 14px; margin-bottom: 3px; ${notif.read ? 'color: var(--text-secondary)' : 'color: var(--text-primary)'}">${escapeHtml(notif.title)}</div>
                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.4; margin-bottom: 6px;">${escapeHtml(notif.message)}</div>
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                  <span style="font-size: 11px; color: var(--text-muted);">${timeAgo}</span>
                  ${actionButtons ? `<div style="display: flex; gap: 6px;">${actionButtons}</div>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Handle notification action button clicks
    async function handleNotificationAction(notifId, action, encodedData) {
      const data = JSON.parse(decodeURIComponent(encodedData));

      // Mark notification as read
      const notif = allNotifications.find(n => n.id === notifId);
      if (notif) notif.read = true;
      if (typeof StateManager !== 'undefined') {
        StateManager.markNotificationViewed(notifId);
      }

      // Close notification panel
      toggleNotificationPanel();

      // Handle different actions
      switch (action) {
        case 'schedule_lead':
          if (data.lead_id) {
            showPage('leads');
            setTimeout(() => openScheduleLeadModal(data.lead_id), 300);
          }
          break;

        case 'view_lead':
          if (data.lead_id) {
            showPage('leads');
            setTimeout(() => viewLead(data.lead_id), 300);
          }
          break;

        case 'confirm_appointment':
          if (data.event_id) {
            await confirmCalendarEvent(data.event_id);
            showToast('Appointment confirmed');
          }
          break;

        case 'reschedule_appointment':
          if (data.event_id) {
            showPage('calendar');
            setTimeout(() => {
              openCalendarEventDetailModal(data.event_id);
              // Auto-click edit after opening
              setTimeout(() => {
                const editBtn = document.querySelector('#calendar-event-detail-modal [onclick*="editCalendarEvent"]');
                if (editBtn) editBtn.click();
              }, 300);
            }, 300);
          }
          break;

        case 'view_event':
          if (data.event_id) {
            showPage('calendar');
            setTimeout(() => openCalendarEventDetailModal(data.event_id), 300);
          }
          break;

        case 'send_reminder':
          if (data.event_id) {
            await sendEventReminder(data.event_id);
          }
          break;

        case 'take_action':
          // Navigate based on data context
          if (data.lead_id) {
            showPage('leads');
            setTimeout(() => viewLead(data.lead_id), 300);
          } else if (data.event_id) {
            showPage('calendar');
            setTimeout(() => openCalendarEventDetailModal(data.event_id), 300);
          } else if (data.estimate_id) {
            showPage('estimates');
          } else if (data.invoice_id) {
            showPage('invoices');
          }
          break;

        case 'dismiss':
          renderNotificationPanel();
          updateNotificationBadge();
          break;

        case 'create_invoice':
          if (data.estimate_id) {
            showPage('invoices');
            setTimeout(() => createInvoiceFromEstimate(data.estimate_id), 300);
          }
          break;

        case 'view_estimate':
          if (data.estimate_id) {
            showPage('estimates');
          }
          break;

        case 'view_invoice':
          if (data.invoice_id) {
            showPage('invoices');
          }
          break;

        case 'send_receipt':
          if (data.invoice_id) {
            await sendInvoiceReceipt(data.invoice_id);
          }
          break;

        case 'reply_message':
        case 'view_message':
          // TODO: Implement message viewing
          showToast('Messages feature coming soon', 'info');
          break;

        case 'start_tutorial':
          setTimeout(() => showFeatureTutorial(), 300);
          break;

        default:
          console.log('Unknown notification action:', action);
      }

      renderNotificationPanel();
      updateNotificationBadge();
    }

    // Send reminder for an event
    async function sendEventReminder(eventId) {
      try {
        const response = await fetch('/api/calendar/events/' + eventId + '/reminder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          showToast('Reminder sent successfully');
        } else {
          showToast('Failed to send reminder', 'error');
        }
      } catch (err) {
        console.error('Error sending reminder:', err);
        showToast('Failed to send reminder', 'error');
      }
    }

    // Send invoice receipt
    async function sendInvoiceReceipt(invoiceId) {
      try {
        const response = await fetch('/api/invoices/' + invoiceId + '/receipt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          showToast('Receipt sent successfully');
        } else {
          showToast('Failed to send receipt', 'error');
        }
      } catch (err) {
        console.error('Error sending receipt:', err);
        showToast('Failed to send receipt', 'error');
      }
    }

    // Create invoice from estimate
    async function createInvoiceFromEstimate(estimateId) {
      // Open invoice creation modal pre-filled with estimate data
      // This assumes there's an existing function or we need to implement it
      if (typeof openCreateInvoiceModal === 'function') {
        openCreateInvoiceModal({ estimate_id: estimateId });
      } else {
        showToast('Opening invoice creation...', 'info');
        // Navigate to invoices page - the user can create manually
      }
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      if (!badge) return;

      const unreadCount = allNotifications.filter(n => !n.read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    async function handleNotificationClick(notifId, type, data) {
      // Mark as read in memory
      const notif = allNotifications.find(n => n.id === notifId);
      if (notif) notif.read = true;

      // Persist to StateManager
      if (typeof StateManager !== 'undefined') {
        StateManager.markNotificationViewed(notifId);
      }

      // Update database
      if (supabaseClient && currentUser) {
        try {
          await supabaseClient
            .from('pro_notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('id', notifId);
        } catch (err) {
          console.warn('Could not persist notification read state:', err);
        }
      }

      renderNotificationPanel();
      updateNotificationBadge();

      // Navigate based on type
      toggleNotificationPanel();

      if (type === 'new_features' && data.action === 'start_tutorial') {
        // Start the feature tutorial
        setTimeout(() => showFeatureTutorial(), 300);
      } else if (type === 'new_lead' && data.lead_id) {
        showPage('leads');
        setTimeout(() => viewLead(data.lead_id), 300);
      } else if ((type === 'appointment_reminder' || type === 'action_required') && data.event_id) {
        showPage('calendar');
        setTimeout(() => openCalendarEventDetailModal(data.event_id), 300);
      } else if (type === 'estimate_approved' && data.estimate_id) {
        showPage('estimates');
      } else if (type === 'payment_received' && data.invoice_id) {
        showPage('invoices');
      }
    }

    async function markAllNotificationsRead() {
      // Mark all as read in memory and persist to StateManager
      allNotifications.forEach(n => {
        n.read = true;
        if (typeof StateManager !== 'undefined') {
          StateManager.markNotificationViewed(n.id);
        }
      });
      renderNotificationPanel();
      updateNotificationBadge();

      // Update in database if using pro_notifications
      if (supabaseClient && currentUser) {
        try {
          await supabaseClient
            .from('pro_notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('pro_user_id', currentUser.id)
            .eq('is_read', false);
        } catch (err) {
          // Ignore - may not have this table
        }
      }

      showToast('All notifications marked as read');
    }

    // Load notifications periodically
    function startNotificationPolling() {
      loadNotifications();
      setInterval(loadNotifications, 60000); // Every minute
    }

    // Send daily digest email
    async function sendDailyDigest() {
      if (!currentUser) {
        showToast('Please sign in to receive your digest', 'error');
        return;
      }

      const userName = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User';

      showToast('Sending daily digest...', 'info');

      try {
        const response = await fetch('/api/email/daily-digest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUser.id,
            email: currentUser.email,
            name: userName
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showToast(`Digest sent to ${currentUser.email}`, 'success');
          toggleNotificationPanel();
        } else {
          throw new Error(result.error || 'Failed to send digest');
        }
      } catch (err) {
        console.error('Error sending digest:', err);
        showToast('Failed to send digest: ' + err.message, 'error');
      }
    }

    function showDashboard() {
      // Check for stored redirect URL (e.g., from Room Designer auth flow)
      const authRedirect = sessionStorage.getItem('auth_redirect');
      if (authRedirect) {
        sessionStorage.removeItem('auth_redirect');
        window.location.href = authRedirect;
        return;
      }

      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-app').style.display = 'block';
      setupDashboard();

      // Initialize StateManager with current user and sync all persisted data
      if (typeof StateManager !== 'undefined') {
        StateManager.setUser(currentUser);
        if (supabaseClient && currentUser) {
          // Sync confirmed events and read notifications in parallel
          Promise.all([
            StateManager.syncConfirmedEvents(supabaseClient),
            StateManager.syncReadNotifications(supabaseClient, currentUser.id)
          ]).then(() => {
            StateManager.cleanup(); // Clean up old data
          });
        }
      }

      // Start notification polling
      startNotificationPolling();

      // Initialize sidebar collapsed state from localStorage
      initSidebarState();

      // Update badge visibility (hide zeros)
      updateBadgeVisibility();

      // Add help button to header and initialize tutorials
      addHelpButton();
      initShepherdTours();

      // Mark auth as ready BEFORE handling hash navigation
      setAuthReady();
      console.log('[Auth] Auth ready, supabaseClient initialized');

      // Check for invite acceptance tokens
      checkForInviteToken();
      checkForNetworkInviteToken();

      // Listen for auto-claimed invitations
      window.addEventListener('sg-invitations-claimed', function(e) {
        var count = e.detail && e.detail.count || 0;
        if (count > 0) {
          showToast('You\'ve been added to ' + count + ' project' + (count > 1 ? 's' : '') + ' as collaborator!');
          if (document.getElementById('page-collaborations') && document.getElementById('page-collaborations').classList.contains('active')) {
            loadCollaborations();
          }
        }
      });

      // Handle hash navigation (e.g., /account/#favorites)
      handleHashNavigation();

      // Listen for hash changes
      window.addEventListener('hashchange', handleHashNavigation);

      // Show tutorial for new features if user hasn't seen it
      setTimeout(() => {
        if (!localStorage.getItem('sg_tutorial_seen_v2')) {
          showFeatureTutorial();
        }
      }, 1500);
    }


    // ==================== SHEPHERD.JS TUTORIAL SYSTEM ====================

    // Tutorial tour configurations
    var shepherdTours = {};

    function initShepherdTours() {
      if (typeof Shepherd === 'undefined') {
        console.warn('[Tutorial] Shepherd.js not loaded');
        return;
      }

      // Quick Start Tour
      shepherdTours.quickStart = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
          cancelIcon: { enabled: true },
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      shepherdTours.quickStart.addSteps([
        {
          id: 'welcome',
          title: 'Welcome to Your Dashboard',
          text: 'This is your command center. See your stats, upcoming appointments, and items needing attention all in one place.',
          attachTo: { element: '#page-dashboard', on: 'bottom' },
          buttons: [
            { text: 'Skip', action: shepherdTours.quickStart.cancel, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'leads',
          title: 'Leads - Your Starting Point',
          text: 'Every customer journey starts here. Capture leads from your website, phone calls, or add them manually.',
          attachTo: { element: 'a[data-page="leads"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'customers',
          title: 'Customer Management',
          text: 'Once a lead converts, they become a customer. View their info, orders, estimates, and invoices in one place.',
          attachTo: { element: 'a[data-page="customers"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'estimates',
          title: 'Professional Estimates',
          text: 'Create detailed estimates with line items and terms. Send them to customers for approval.',
          attachTo: { element: 'a[data-page="estimates"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'operations',
          title: 'Operations Hub',
          text: 'Your complete project management system. Track projects through every stage from lead to completion.',
          attachTo: { element: '#operations-nav', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'notifications',
          title: 'Stay Notified',
          text: 'Get notifications for new leads, estimate approvals, appointments, and team activity.',
          attachTo: { element: '.notification-bell-wrapper', on: 'left' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Finish', action: shepherdTours.quickStart.complete, classes: 'shepherd-button-primary' }
          ]
        }
      ]);

      shepherdTours.quickStart.on('complete', function() {
        localStorage.setItem('sg_tutorial_seen', 'true');
        showToast('Tutorial complete! Click the help button anytime to learn more.');
      });

      // Complete Workflow Tour
      shepherdTours.completeWorkflow = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
          cancelIcon: { enabled: true },
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      shepherdTours.completeWorkflow.addSteps([
        {
          id: 'step1',
          title: 'Step 1: Capture Leads',
          text: 'Leads come from your website, quote requests, or manual entry. Each lead has contact info and project details.<br><br><strong>Tip:</strong> Respond within 5 minutes for better conversion.',
          attachTo: { element: 'a[data-page="leads"]', on: 'right' },
          buttons: [
            { text: 'Skip', action: shepherdTours.completeWorkflow.cancel, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step2',
          title: 'Step 2: Schedule Appointment',
          text: 'Contact the lead and schedule an appointment using the calendar. Appointments sync and send reminders automatically.',
          attachTo: { element: 'a[data-page="calendar"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step3',
          title: 'Step 3: Convert to Customer',
          text: 'When qualified, convert the lead to a customer. This creates a permanent record preserving all their history.',
          attachTo: { element: 'a[data-page="customers"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step4',
          title: 'Step 4: Create Estimate',
          text: 'Build a professional estimate with itemized costs, materials, and labor. Send via email for customer approval.',
          attachTo: { element: 'a[data-page="estimates"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step5',
          title: 'Step 5: Create Project',
          text: 'Once approved, create a project to track the entire job lifecycle. Projects link to estimates, invoices, and events.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step6',
          title: 'Step 6: Assign Team',
          text: 'Add contractors, fabricators, and installers from your network. Assign them specific roles on the project.',
          attachTo: { element: 'a[data-page="collaborators"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step7',
          title: 'Step 7: Schedule Installation',
          text: 'Schedule the installation on your calendar. Add multiple participants - they all get notified.',
          attachTo: { element: 'a[data-page="calendar"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step8',
          title: 'Step 8: Invoice & Get Paid',
          text: 'Convert estimates to invoices, collect deposits, and track payments. Integrates with Stripe for online payments.',
          attachTo: { element: 'a[data-page="invoices"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Finish', action: shepherdTours.completeWorkflow.complete, classes: 'shepherd-button-primary' }
          ]
        }
      ]);

      shepherdTours.completeWorkflow.on('complete', function() {
        showToast('Workflow tutorial complete!');
      });

      // Project Management Tour
      shepherdTours.projectManagement = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
          cancelIcon: { enabled: true },
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      shepherdTours.projectManagement.addSteps([
        {
          id: 'overview',
          title: 'Projects Overview',
          text: 'Projects are the heart of operations. Each project tracks a job from start to finish with all related data.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Skip', action: shepherdTours.projectManagement.cancel, secondary: true },
            { text: 'Next', action: shepherdTours.projectManagement.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'creation',
          title: 'Creating Projects',
          text: 'Click "New Project" to create one. Populate from an existing Lead, Customer, or enter details manually.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.projectManagement.back, secondary: true },
            { text: 'Next', action: shepherdTours.projectManagement.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'workflow',
          title: 'Workflow Status',
          text: 'Each project shows a workflow progress bar with 9 stages. Click to advance stages and auto-create calendar events.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.projectManagement.back, secondary: true },
            { text: 'Next', action: shepherdTours.projectManagement.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'team',
          title: 'Team Assignment',
          text: 'In project details, click "Assign" to add team members. Assign roles like Installer, Fabricator, or Measurer.',
          attachTo: { element: 'a[data-page="collaborators"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.projectManagement.back, secondary: true },
            { text: 'Finish', action: shepherdTours.projectManagement.complete, classes: 'shepherd-button-primary' }
          ]
        }
      ]);

      shepherdTours.projectManagement.on('complete', function() {
        showToast('Project management tutorial complete!');
      });
    }

    // Start a specific tour
    function startTour(tourName) {
      if (!shepherdTours[tourName]) {
        console.warn('[Tutorial] Tour not found:', tourName);
        return;
      }

      // Cancel any active tour
      Object.values(shepherdTours).forEach(function(tour) {
        if (tour.isActive()) tour.cancel();
      });

      shepherdTours[tourName].start();
    }

    // Show tour selection menu
    function showTutorialMenu() {
      var modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'tutorial-menu-modal';
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

      modal.innerHTML = '<div class="modal-content" style="max-width: 480px;">' +
        '<div class="modal-header">' +
          '<h2 class="modal-title">Learn the App</h2>' +
          '<button class="modal-close" onclick="document.getElementById(\'tutorial-menu-modal\').remove()">&times;</button>' +
        '</div>' +
        '<div class="modal-body" style="padding: 20px;">' +
          '<p style="color: var(--text-secondary); margin-bottom: 20px;">Choose a tutorial to learn different parts of the app:</p>' +

          '<div onclick="document.getElementById(\'tutorial-menu-modal\').remove(); startTour(\'quickStart\')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
            '<div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
              '<svg width="22" height="22" fill="none" stroke="#1a1a2e" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: 600; color: var(--text-primary);">Quick Start</div>' +
              '<div style="font-size: 13px; color: var(--text-secondary);">Overview of key features (6 steps)</div>' +
            '</div>' +
            '<svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
          '</div>' +

          '<div onclick="document.getElementById(\'tutorial-menu-modal\').remove(); startTour(\'completeWorkflow\')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
            '<div style="width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
              '<svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: 600; color: var(--text-primary);">Complete Workflow</div>' +
              '<div style="font-size: 13px; color: var(--text-secondary);">Full lead-to-completion process (8 steps)</div>' +
            '</div>' +
            '<svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
          '</div>' +

          '<div onclick="document.getElementById(\'tutorial-menu-modal\').remove(); startTour(\'projectManagement\')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
            '<div style="width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
              '<svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: 600; color: var(--text-primary);">Project Management</div>' +
              '<div style="font-size: 13px; color: var(--text-secondary);">Deep dive on project features (4 steps)</div>' +
            '</div>' +
            '<svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
          '</div>' +

        '</div>' +
        '<div class="modal-footer">' +
          '<button class="btn-modern ghost" onclick="document.getElementById(\'tutorial-menu-modal\').remove()">Close</button>' +
        '</div>' +
      '</div>';

      document.body.appendChild(modal);
    }

    // Add help button to header
    function addHelpButton() {
      var headerRight = document.querySelector('.header-right');
      if (!headerRight || document.getElementById('help-menu-btn')) return;

      var helpBtn = document.createElement('div');
      helpBtn.id = 'help-menu-btn';
      helpBtn.style.cssText = 'position: relative; margin-right: 8px;';
      helpBtn.innerHTML = '<button onclick="toggleHelpMenu()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'var(--dark-elevated)\'; this.style.color=\'var(--text-primary)\'" onmouseout="this.style.background=\'none\'; this.style.color=\'var(--text-secondary)\'" title="Help & Tutorials">' +
        '<svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
      '</button>' +
      '<div id="help-dropdown" style="display: none; position: absolute; top: 100%; right: 0; width: 200px; background: var(--dark-secondary); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden; margin-top: 4px;">' +
        '<div style="padding: 8px;">' +
          '<div onclick="toggleHelpMenu(); showTutorialMenu()" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>' +
            '<span style="color: var(--text-primary); font-size: 13px;">All Tutorials</span>' +
          '</div>' +
          '<div onclick="toggleHelpMenu(); startTour(\'quickStart\')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
            '<span style="color: var(--text-primary); font-size: 13px;">Quick Start</span>' +
          '</div>' +
        '</div>' +
        '<div style="padding: 8px; border-top: 1px solid var(--border-color);">' +
          '<a href="mailto:support@surprisegranite.com" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>' +
            '<span style="color: var(--text-secondary); font-size: 13px;">Contact Support</span>' +
          '</a>' +
        '</div>' +
      '</div>';

      var notifWrapper = headerRight.querySelector('.notification-bell-wrapper');
      if (notifWrapper) {
        headerRight.insertBefore(helpBtn, notifWrapper);
      } else {
        headerRight.appendChild(helpBtn);
      }
    }

    function toggleHelpMenu() {
      var dropdown = document.getElementById('help-dropdown');
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Close help dropdown when clicking outside
    document.addEventListener('click', function(e) {
      var helpBtn = document.getElementById('help-menu-btn');
      var dropdown = document.getElementById('help-dropdown');
      if (helpBtn && dropdown && !helpBtn.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Legacy function aliases for backward compatibility
    function showFeatureTutorial(tourName) {
      startTour(tourName || 'quickStart');
    }
    function resetTutorial() {
      localStorage.removeItem('sg_tutorial_seen');
      startTour('quickStart');
    }

    // Expose functions globally
    window.startTour = startTour;
    window.showTutorialMenu = showTutorialMenu;
    window.showFeatureTutorial = showFeatureTutorial;
    window.resetTutorial = resetTutorial;
    window.toggleHelpMenu = toggleHelpMenu;
    window.initShepherdTours = initShepherdTours;
    // ==================== END TUTORIAL SYSTEM ====================

    async function handleHashNavigation() {
      const hash = window.location.hash.replace('#', '');
      console.log('[Nav] handleHashNavigation called, hash:', hash, 'authReady:', authReady);
      const validPages = ['favorites', 'profile', 'leads', 'customers', 'estimates', 'invoices', 'jobs', 'projects', 'collaborators', 'products', 'dashboard', 'wallet', 'orders', 'messages', 'listings', 'admin-users', 'calendar', 'my-designs', 'tools', 'collaborations'];
      if (hash && validPages.includes(hash)) {
        console.log('[Nav] Calling showPage for:', hash);
        await showPage(hash);
      }
    }

    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

      document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tab}-form`).classList.add('active');

      document.getElementById('auth-title').textContent = tab === 'login' ? 'Welcome Back' : 'Create Account';
      document.getElementById('auth-subtitle').textContent = tab === 'login' ? 'Sign in to access your account' : 'Join us to get started';
      hideAuthMessage();

      // Reset signup to step 1 when switching tabs
      if (tab === 'signup') {
        goToSignupStep(1);
        selectAccountType('homeowner');
      }
    }

    // Signup step functions
    function selectAccountType(type) {
      // Update hidden input
      document.getElementById('signup-account-type').value = type;

      // Update card selection UI
      document.querySelectorAll('.account-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`.account-type-card[data-type="${type}"]`).classList.add('selected');
    }

    function goToSignupStep(step) {
      const step1 = document.getElementById('signup-step-1');
      const step2 = document.getElementById('signup-step-2');
      const accountType = document.getElementById('signup-account-type').value;

      if (step === 1) {
        step1.style.display = 'block';
        step2.style.display = 'none';
        document.getElementById('auth-title').textContent = 'Create Account';
        document.getElementById('auth-subtitle').textContent = 'Join us to get started';
      } else {
        step1.style.display = 'none';
        step2.style.display = 'block';

        // Update labels based on account type
        const typeLabels = {
          'homeowner': 'Homeowner Account',
          'pro_fabricator': 'Pro Fabricator Account',
          'pro_designer': 'Designer / Architect Account'
        };
        document.getElementById('selected-type-label').textContent = typeLabels[accountType] || 'Your Account';

        // Show/hide pro fields
        const proFields = document.getElementById('pro-fields');
        const proNote = document.getElementById('pro-upgrade-note');
        const isPro = accountType.startsWith('pro_');

        proFields.style.display = isPro ? 'block' : 'none';
        proNote.style.display = isPro ? 'flex' : 'none';

        // Update header for pro accounts
        if (isPro) {
          document.getElementById('auth-title').textContent = 'Pro Account Setup';
          document.getElementById('auth-subtitle').textContent = 'Unlock unlimited features';
        } else {
          document.getElementById('auth-title').textContent = 'Create Account';
          document.getElementById('auth-subtitle').textContent = 'Almost there!';
        }
      }
    }

    // Initialize account type selection on page load
    document.addEventListener('DOMContentLoaded', function() {
      const homeownerCard = document.querySelector('.account-type-card[data-type="homeowner"]');
      if (homeownerCard) {
        homeownerCard.classList.add('selected');
      }
    });

    function showAuthMessage(msg, type) {
      const el = document.getElementById('auth-message');
      el.textContent = msg;
      el.className = `auth-message visible ${type}`;
    }

    function hideAuthMessage() {
      document.getElementById('auth-message').classList.remove('visible');
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();
        showDashboard();
      } catch (err) {
        showAuthMessage(err.message || 'Failed to sign in', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleGoogleLogin() {
      hideAuthMessage();

      const btn = document.querySelector('.btn-google');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="20"/></svg> Connecting...';
      }

      try {
        // Use SgAuth if available, otherwise use direct Supabase client
        if (window.SgAuth && window.SgAuth.signInWithGoogle) {
          await window.SgAuth.signInWithGoogle(window.location.origin + '/account/');
        } else {
          const { data, error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.origin + '/account/'
            }
          });
          if (error) throw error;
        }
        // OAuth redirects to Google, so we won't reach here unless there's an error
      } catch (err) {
        showAuthMessage(err.message || 'Failed to connect with Google', 'error');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google';
        }
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      try {
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const phone = document.getElementById('signup-phone').value;
        const accountType = document.getElementById('signup-account-type').value;
        const businessName = document.getElementById('signup-business-name')?.value || null;
        const businessLocation = document.getElementById('signup-business-location')?.value || null;

        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: name,
              phone,
              account_type: accountType,
              business_name: businessName,
              business_location: businessLocation
            }
          }
        });

        if (error) throw error;

        // Store in sg_users
        await supabaseClient.from('sg_users').insert([{
          id: data.user.id,
          email,
          full_name: name,
          phone: phone || null,
          account_type: accountType,
          business_name: businessName,
          business_location: businessLocation,
          verified: accountType === 'homeowner' // Homeowners auto-verified, pros need verification
        }]);

        // Show success message based on account type
        const isPro = accountType.startsWith('pro_');
        const successMsg = isPro
          ? 'Pro account created! Check your email to verify. Our team will review your business details.'
          : 'Account created! Check your email to verify, then sign in.';

        showAuthMessage(successMsg, 'success');
        showAuthTab('login');
      } catch (err) {
        showAuthMessage(err.message || 'Failed to create account', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return;

      try {
        // Use maybeSingle() to handle missing profiles gracefully
        const { data: profile, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (error) {
          console.warn('Profile query error:', error);
        }

        userProfile = profile;

        const meta = currentUser.user_metadata || {};
        const name = profile?.full_name || meta.full_name || currentUser.email?.split('@')[0] || 'User';
        const accountType = profile?.account_type || 'homeowner';

        // Check admin status
        isSuperAdmin = SUPER_ADMIN_EMAILS.includes((currentUser.email || '').toLowerCase());
        isAdmin = isSuperAdmin || ['admin', 'super_admin'].includes(accountType);

        // Determine user role (from profile or derived from account type)
        if (isAdmin) {
          userRole = 'admin';
        } else if (profile?.user_role) {
          userRole = profile.user_role;
        } else if (accountType.startsWith('pro_')) {
          userRole = 'contractor';
        } else {
          userRole = 'customer';
        }

        // Safely update sidebar user info
        const avatarEl = document.getElementById('user-avatar');
        const nameEl = document.getElementById('user-name');
        const roleEl = document.getElementById('user-role');

        const roleLabels = {
          homeowner: 'Homeowner',
          customer: 'Customer',
          contractor: 'Contractor',
          vendor: 'Vendor',
          pro: 'Pro',
          fabricator: 'Fabricator',
          admin: 'Admin'
        };

        if (avatarEl) avatarEl.textContent = name.charAt(0).toUpperCase();
        if (nameEl) nameEl.textContent = name;
        if (roleEl) roleEl.textContent = isSuperAdmin ? 'Super Admin' : roleLabels[userRole] || roleLabels[accountType] || 'Customer';

        // Update account type label in sidebar header
        const accountTypeLabel = document.getElementById('account-type-label');
        if (accountTypeLabel) {
          const typeLabels = {
            'customer': 'Customer Account',
            'contractor': 'Contractor Account',
            'vendor': 'Vendor Account',
            'admin': 'Admin Account',
            'homeowner': 'Customer Account',
            'pro_contractor': 'Contractor Account',
            'pro_fabricator': 'Fabricator Account',
            'pro_designer': 'Designer Account',
            'pro_builder': 'Builder Account',
            'super_admin': 'Admin Account'
          };
          accountTypeLabel.textContent = isSuperAdmin ? ' GOD MODE' : (typeLabels[userRole] || typeLabels[accountType] || 'Account');
        }

        // Safely update profile form
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const profilePhoneEl = document.getElementById('profile-phone');
        const profileCompanyEl = document.getElementById('profile-company');

        if (profileNameEl) profileNameEl.value = name;
        if (profileEmailEl) profileEmailEl.value = currentUser.email || '';
        if (profilePhoneEl) profilePhoneEl.value = profile?.phone || meta.phone || '';
        if (profileCompanyEl) profileCompanyEl.value = profile?.company_name || '';

        // Apply role-based navigation
        applyRoleBasedNav(userRole);

        // Enable role switcher for admins (for testing different views)
        if (isAdmin) {
          enableRoleSwitcher();
        }

      } catch (err) {
        console.warn('Profile load error:', err);
      }

      // Load favorites count (non-blocking)
      loadFavoritesCount().catch(err => console.warn('Favorites count error:', err));
    }

    // ============ FAVORITES FUNCTIONS ============

    let allFavorites = [];
    let flooringFavorites = [];
    let countertopFavorites = [];

    async function loadFavoritesCount() {
      if (!currentUser) return;

      try {
        const { count } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = count || 0;
          countEl.style.display = count > 0 ? 'inline' : 'none';
        }
      } catch (err) {
        console.warn('Error loading favorites count:', err);
      }
    }

    async function loadFavorites() {
      if (!currentUser) return;

      const loadingEl = document.getElementById('favorites-loading');
      const emptyEl = document.getElementById('favorites-empty');
      const flooringSection = document.getElementById('favorites-flooring');
      const countertopsSection = document.getElementById('favorites-countertops');
      const tileSection = document.getElementById('favorites-tile');
      const shopSection = document.getElementById('favorites-shop');
      const quoteBtn = document.getElementById('request-quote-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');

      try {
        const { data, error } = await supabaseClient
          .from('user_favorites')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allFavorites = data || [];
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');
        const tileFavorites = allFavorites.filter(f => f.product_type === 'tile');
        const shopFavorites = allFavorites.filter(f => f.product_type === 'shop');

        loadingEl.style.display = 'none';

        if (allFavorites.length === 0) {
          emptyEl.style.display = 'block';
          flooringSection.style.display = 'none';
          countertopsSection.style.display = 'none';
          if (tileSection) tileSection.style.display = 'none';
          if (shopSection) shopSection.style.display = 'none';
          quoteBtn.style.display = 'none';
          if (clearAllBtn) clearAllBtn.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          quoteBtn.style.display = 'inline-flex';
          if (clearAllBtn) clearAllBtn.style.display = 'inline-flex';

          // Show/render countertops section
          if (countertopFavorites.length > 0) {
            countertopsSection.style.display = 'block';
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            countertopsSection.style.display = 'none';
          }

          // Show/render flooring section
          if (flooringFavorites.length > 0) {
            flooringSection.style.display = 'block';
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            flooringSection.style.display = 'none';
          }

          // Show/render tile section
          if (tileFavorites.length > 0 && tileSection) {
            tileSection.style.display = 'block';
            document.getElementById('tile-section-count').textContent = tileFavorites.length;
            renderFavoritesGrid('favorites-tile-grid', tileFavorites);
          } else if (tileSection) {
            tileSection.style.display = 'none';
          }

          // Show/render shop section
          if (shopFavorites.length > 0 && shopSection) {
            shopSection.style.display = 'block';
            document.getElementById('shop-section-count').textContent = shopFavorites.length;
            renderFavoritesGrid('favorites-shop-grid', shopFavorites);
          } else if (shopSection) {
            shopSection.style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

      } catch (err) {
        console.error('Error loading favorites:', err);
        loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading favorites. Please try again.</p>';
      }
    }

    // Orders functionality
    let ordersLoaded = false;
    let allOrders = [];
    let filteredOrders = [];
    let ordersPage = 1;
    const ordersPageSize = 50;
    let ordersSearchTerm = '';

    async function loadOrders() {
      console.log('[Orders] loadOrders called, ordersLoaded:', ordersLoaded);
      if (ordersLoaded) {
        console.log('[Orders] Already loaded, skipping');
        return;
      }

      const loadingEl = document.getElementById('orders-loading');
      const emptyEl = document.getElementById('orders-empty');
      const listEl = document.getElementById('orders-list');

      if (!loadingEl || !emptyEl || !listEl) {
        console.warn('[Orders] DOM elements not found', { loadingEl: !!loadingEl, emptyEl: !!emptyEl, listEl: !!listEl });
        return;
      }

      try {
        if (!supabaseClient) {
          console.error('[Orders] supabaseClient not initialized');
          loadingEl.style.display = 'none';
          emptyEl.innerHTML = '<p>Database not ready. Please refresh.</p>';
          emptyEl.style.display = 'block';
          return;
        }
        console.log('[Orders] Fetching orders from database...');
        // Load ALL orders from shopify_orders
        const { data, error } = await supabaseClient
          .from('shopify_orders')
          .select('*')
          .order('shopify_created_at', { ascending: false });

        if (error) throw error;

        allOrders = data || [];
        filteredOrders = [...allOrders];
        ordersLoaded = true;

        loadingEl.style.display = 'none';

        // Update stats
        updateOrderStats();

        // Setup search
        setupOrdersSearch();

        if (allOrders.length === 0) {
          emptyEl.style.display = 'block';
          listEl.style.display = 'none';
          document.getElementById('orders-stats').style.display = 'none';
          document.getElementById('orders-pagination').style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          listEl.style.display = 'block';
          document.getElementById('orders-pagination').style.display = 'flex';
          renderOrders();
        }
      } catch (err) {
        console.error('Error loading orders:', err);
        loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading orders. Please try again.</p>';
      }
    }

    function updateOrderStats() {
      const total = allOrders.length;
      // Check multiple possible field names for total
      const revenue = allOrders.reduce((sum, o) => {
        const orderTotal = parseFloat(o.total_price || o.total || o.amount || 0);
        return sum + orderTotal;
      }, 0);
      const paid = allOrders.filter(o => o.financial_status === 'paid').length;
      const fulfilled = allOrders.filter(o => o.fulfillment_status === 'fulfilled').length;

      document.getElementById('stat-total-orders').textContent = total.toLocaleString();
      document.getElementById('stat-orders-revenue').textContent = '$' + revenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('stat-paid-orders').textContent = paid.toLocaleString();
      document.getElementById('stat-fulfilled-orders').textContent = fulfilled.toLocaleString();

      // Debug: log first order to see field names
      if (allOrders.length > 0) {
        console.log('Sample order fields:', Object.keys(allOrders[0]), 'Total field values:', allOrders[0].total_price, allOrders[0].total);
      }
    }

    function setupOrdersSearch() {
      const searchInput = document.getElementById('orders-search');
      let timeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          ordersSearchTerm = e.target.value.toLowerCase();
          filterOrders();
        }, 300);
      });
    }

    function filterOrders() {
      const statusFilter = document.getElementById('orders-status-filter').value;
      const fulfillmentFilter = document.getElementById('orders-fulfillment-filter').value;

      filteredOrders = allOrders.filter(order => {
        // Status filter
        if (statusFilter && order.financial_status !== statusFilter) return false;

        // Fulfillment filter
        if (fulfillmentFilter && order.fulfillment_status !== fulfillmentFilter) return false;

        // Search
        if (ordersSearchTerm) {
          const searchable = `${order.order_number || ''} ${order.customer_name || ''} ${order.customer_email || ''}`.toLowerCase();
          if (!searchable.includes(ordersSearchTerm)) return false;
        }

        return true;
      });

      ordersPage = 1;
      renderOrders();
    }

    function renderOrders() {
      const listEl = document.getElementById('orders-list');
      const emptyEl = document.getElementById('orders-empty');
      const paginationEl = document.getElementById('orders-pagination');

      if (filteredOrders.length === 0) {
        listEl.style.display = 'none';
        emptyEl.style.display = 'block';
        paginationEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      listEl.style.display = 'block';
      paginationEl.style.display = 'flex';

      const start = (ordersPage - 1) * ordersPageSize;
      const end = start + ordersPageSize;
      const pageOrders = filteredOrders.slice(start, end);

      listEl.innerHTML = pageOrders.map(order => {
        const orderDate = order.shopify_created_at
          ? new Date(order.shopify_created_at).toLocaleDateString('en-US', {
              year: 'numeric', month: 'short', day: 'numeric'
            })
          : 'N/A';

        const financialStatus = (order.financial_status || 'pending').toLowerCase();
        const fulfillmentStatus = (order.fulfillment_status || 'unfulfilled').toLowerCase();

        // Parse line items
        const lineItems = Array.isArray(order.line_items) ? order.line_items : [];

        return `
          <div class="order-card" onclick="showOrderDetail('${order.id}')" style="cursor: pointer;">
            <div class="order-header">
              <div class="order-info">
                <div class="order-number">Order #${escapeHtml(String(order.order_number || order.id))}</div>
                <div class="order-date">${orderDate}</div>
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(order.customer_name || order.customer_email || 'Guest')}</div>
              </div>
              <div class="order-status">
                <span class="status-badge ${financialStatus}">${escapeHtml(financialStatus)}</span>
                <span class="status-badge ${fulfillmentStatus}">${escapeHtml(fulfillmentStatus)}</span>
              </div>
            </div>

            <div class="order-items">
              ${lineItems.slice(0, 2).map(item => `
                <div class="order-item">
                  <div class="order-item-image">
                    ${item.image?.url
                      ? `<img src="${escapeHtml(item.image.url)}" alt="${escapeHtml(item.title || item.name)}" loading="lazy">`
                      : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="width:100%;height:100%;padding:15px;color:var(--text-muted)"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'
                    }
                  </div>
                  <div class="order-item-details">
                    <div class="order-item-name">${escapeHtml(item.title || item.name || 'Product')}</div>
                    <div class="order-item-meta">Qty: ${item.quantity || 1}</div>
                  </div>
                  <div class="order-item-price">$${((item.originalUnitPrice?.amount || item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                </div>
              `).join('')}
              ${lineItems.length > 2 ? `
                <div class="order-item-meta" style="padding: 8px 0; color: var(--text-muted);">
                  + ${lineItems.length - 2} more item${lineItems.length - 2 > 1 ? 's' : ''}
                </div>
              ` : ''}
            </div>

            <div class="order-footer" style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div class="order-total-label">Total</div>
                <div class="order-total">$${parseFloat(order.total || 0).toFixed(2)}</div>
              </div>
              <button class="btn-modern secondary small" onclick="event.stopPropagation(); createProjectFromOrder('${order.id}')" title="Create Project" style="font-size: 11px; padding: 4px 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                Project
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Update pagination
      const totalPages = Math.ceil(filteredOrders.length / ordersPageSize);
      document.getElementById('orders-page-info').textContent = `Showing ${start + 1}-${Math.min(end, filteredOrders.length)} of ${filteredOrders.length}`;
      document.getElementById('orders-prev-btn').disabled = ordersPage === 1;
      document.getElementById('orders-next-btn').disabled = ordersPage >= totalPages;
    }

    function ordersPagePrev() {
      if (ordersPage > 1) {
        ordersPage--;
        renderOrders();
        document.getElementById('page-orders').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function ordersPageNext() {
      const totalPages = Math.ceil(filteredOrders.length / ordersPageSize);
      if (ordersPage < totalPages) {
        ordersPage++;
        renderOrders();
        document.getElementById('page-orders').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function showOrderDetail(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;

      const lineItems = Array.isArray(order.line_items) ? order.line_items : [];
      const orderDate = order.shopify_created_at
        ? new Date(order.shopify_created_at).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
          })
        : 'N/A';

      const modal = document.createElement('div');
      modal.className = 'order-detail-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      modal.innerHTML = `
        <div style="background: var(--dark-surface); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 18px; font-weight: 700;">Order #${escapeHtml(String(order.order_number || order.id))}</h3>
            <button onclick="this.closest('.order-detail-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Date</div>
                <div style="font-weight: 500;">${orderDate}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Status</div>
                <div><span class="status-badge ${order.financial_status || 'pending'}">${escapeHtml(order.financial_status || 'pending')}</span></div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Customer</div>
                <div style="font-weight: 500;">${escapeHtml(order.customer_name || 'Guest')}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${escapeHtml(order.customer_email || '')}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Fulfillment</div>
                <div><span class="status-badge ${order.fulfillment_status || 'unfulfilled'}">${escapeHtml(order.fulfillment_status || 'unfulfilled')}</span></div>
              </div>
            </div>

            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Items (${lineItems.length})</div>
            <div style="background: var(--dark-elevated); border-radius: 12px; padding: 12px;">
              ${lineItems.map(item => `
                <div style="display: flex; gap: 12px; padding: 8px 0; align-items: center; ${lineItems.indexOf(item) > 0 ? 'border-top: 1px solid var(--border-subtle);' : ''}">
                  <div style="width: 50px; height: 50px; border-radius: 8px; background: var(--dark-surface); overflow: hidden; flex-shrink: 0;">
                    ${item.image?.url
                      ? `<img src="${escapeHtml(item.image.url)}" style="width: 100%; height: 100%; object-fit: cover;">`
                      : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted);"></div>'
                    }
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: 500;">${escapeHtml(item.title || item.name || 'Product')}</div>
                    <div style="font-size: 13px; color: var(--text-muted);">Qty: ${item.quantity || 1}</div>
                  </div>
                  <div style="font-weight: 600;">$${((item.originalUnitPrice?.amount || item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 16px; font-weight: 600;">Total</span>
              <span style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${parseFloat(order.total || 0).toFixed(2)}</span>
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    function exportOrdersCSV() {
      if (filteredOrders.length === 0) {
        showToast('No orders to export', 'error');
        return;
      }

      const csv = [
        ['Order #', 'Date', 'Customer', 'Email', 'Total', 'Financial Status', 'Fulfillment Status'].join(','),
        ...filteredOrders.map(o => [
          o.order_number || o.id,
          o.shopify_created_at ? new Date(o.shopify_created_at).toLocaleDateString() : '',
          `"${(o.customer_name || '').replace(/"/g, '""')}"`,
          o.customer_email || '',
          o.total || 0,
          o.financial_status || '',
          o.fulfillment_status || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `orders-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Orders exported', 'success');
    }

    function renderFavoritesGrid(gridId, items) {
      const gridEl = document.getElementById(gridId);
      if (!gridEl) return;

      gridEl.innerHTML = items.map(item => `
        <div class="saved-floor-item" data-id="${item.id}">
          <img class="saved-floor-image" src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}" loading="lazy">
          <div class="saved-floor-content">
            <div class="saved-floor-title">${item.product_title}</div>
            ${item.product_material ? `<div class="saved-floor-material">${item.product_material}</div>` : ''}
            <div class="saved-floor-specs">
              ${item.product_color ? `<span class="saved-floor-spec">${item.product_color}</span>` : ''}
              ${item.product_thickness ? `<span class="saved-floor-spec">${item.product_thickness}</span>` : ''}
              ${item.product_wear_layer ? `<span class="saved-floor-spec">${item.product_wear_layer}</span>` : ''}
            </div>
            <div class="saved-floor-actions">
              <a href="${item.product_url}" class="saved-floor-view" target="_blank">View</a>
              <button class="saved-floor-remove" onclick="removeFavorite('${item.id}', '${item.product_type}')">Remove</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function removeFavorite(id, productType) {
      if (!confirm('Remove this from your favorites?')) return;

      try {
        const { error } = await supabaseClient
          .from('user_favorites')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);

        if (error) throw error;

        // Remove from local arrays
        allFavorites = allFavorites.filter(f => f.id !== id);
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');

        // Re-render the appropriate grid
        if (productType === 'countertop') {
          if (countertopFavorites.length > 0) {
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            document.getElementById('favorites-countertops').style.display = 'none';
          }
        } else {
          if (flooringFavorites.length > 0) {
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            document.getElementById('favorites-flooring').style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

        // Show empty state if no more favorites
        if (allFavorites.length === 0) {
          document.getElementById('favorites-empty').style.display = 'block';
          document.getElementById('request-quote-btn').style.display = 'none';
        }

        showToast('Removed from favorites', 'success');

      } catch (err) {
        console.error('Error removing favorite:', err);
        showToast('Error removing item', 'error');
      }
    }

    // Clear ALL favorites - permanent action
    async function clearAllFavoritesConfirm() {
      // Show confirmation modal
      const confirmModal = document.createElement('div');
      confirmModal.className = 'quote-modal';
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      confirmModal.innerHTML = `
        <div style="background: linear-gradient(180deg, #1a1a2e 0%, #0d0d15 100%); border-radius: 20px; padding: 32px; max-width: 400px; width: 100%; text-align: center; color: #fff;">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" style="margin-bottom: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <h3 style="margin: 0 0 12px; font-size: 22px;">Clear All Favorites?</h3>
          <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px; line-height: 1.5;">This will permanently delete <strong>${allFavorites.length}</strong> item${allFavorites.length !== 1 ? 's' : ''} from your favorites. This action cannot be undone.</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancel-clear" style="background: rgba(255,255,255,0.1); color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px;">Cancel</button>
            <button id="confirm-clear" style="background: #dc2626; color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px;">Yes, Clear All</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);

      // Handle cancel
      confirmModal.querySelector('#cancel-clear').addEventListener('click', () => {
        confirmModal.remove();
      });

      // Handle confirm
      confirmModal.querySelector('#confirm-clear').addEventListener('click', async () => {
        const confirmBtn = confirmModal.querySelector('#confirm-clear');
        confirmBtn.textContent = 'Clearing...';
        confirmBtn.disabled = true;

        try {
          // Delete from Supabase
          const { error } = await supabaseClient
            .from('user_favorites')
            .delete()
            .eq('user_id', currentUser.id);

          if (error) throw error;

          // Clear ALL localStorage keys related to favorites
          const keysToRemove = [
            'sg_all_favorites',
            'sg_flooring_favorites',
            'sg_countertop_favorites',
            'sg_tile_favorites',
            'sg_cabinet_favorites',
            'sg_sink_favorites',
            'sg_shop_favorites',
            'sg_general_favorites',
            'favorites',
            'userFavorites',
            'sg_favorites'
          ];
          keysToRemove.forEach(key => {
            try { localStorage.removeItem(key); } catch (e) {}
          });

          // Also clear any key containing 'favorite'
          Object.keys(localStorage).forEach(key => {
            if (key.toLowerCase().includes('favorite')) {
              try { localStorage.removeItem(key); } catch (e) {}
            }
          });

          // Clear local arrays
          allFavorites = [];
          flooringFavorites = [];
          countertopFavorites = [];
          tileFavorites = [];
          shopFavorites = [];

          // Hide all sections
          document.getElementById('favorites-countertops').style.display = 'none';
          document.getElementById('favorites-flooring').style.display = 'none';
          document.getElementById('favorites-tile').style.display = 'none';
          document.getElementById('favorites-shop').style.display = 'none';

          // Show empty state
          document.getElementById('favorites-empty').style.display = 'block';

          // Hide buttons
          document.getElementById('request-quote-btn').style.display = 'none';
          document.getElementById('clear-all-btn').style.display = 'none';

          // Update counts
          const countEl = document.getElementById('favorites-count');
          if (countEl) {
            countEl.textContent = '0';
            countEl.style.display = 'none';
          }

          // Update dashboard stat if visible
          const statEl = document.getElementById('stat-favorites');
          if (statEl) statEl.textContent = '0';

          // Update global favorites if available
          if (window.SGFavorites && typeof window.SGFavorites.clearAll === 'function') {
            // Already cleared above, but this ensures in-memory state is synced
          }

          confirmModal.remove();
          showToast('All favorites cleared permanently', 'success');

        } catch (err) {
          console.error('Error clearing favorites:', err);
          confirmBtn.textContent = 'Yes, Clear All';
          confirmBtn.disabled = false;
          showToast('Error clearing favorites. Please try again.', 'error');
        }
      });

      // Close on click outside
      confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
          confirmModal.remove();
        }
      });
    }

    // =============================================
    // MY DESIGNS (ROOM DESIGNER)
    // =============================================

    let allDesigns = [];
    let designShares = {}; // Map of design_id -> share info with customer/lead data
    let designMessages = {}; // Map of design_id -> unread message count
    let designsFilter = 'all';

    async function loadMyDesigns() {
      const loadingEl = document.getElementById('designs-loading');
      const emptyEl = document.getElementById('designs-empty');
      const gridEl = document.getElementById('designs-grid');

      if (!loadingEl || !emptyEl || !gridEl) return;

      // Show loading
      loadingEl.style.display = 'flex';
      emptyEl.style.display = 'none';
      gridEl.style.display = 'none';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          loadingEl.style.display = 'none';
          emptyEl.style.display = 'block';
          return;
        }

        // Load designs created by this user
        const { data: designs, error } = await supabaseClient
          .from('room_designs')
          .select('*')
          .eq('user_id', user.id)
          .order('updated_at', { ascending: false });

        if (error) throw error;

        allDesigns = designs || [];

        // Load share info with customer/lead data for each design
        if (allDesigns.length > 0) {
          const designIds = allDesigns.map(d => d.id);

          // Get shares with lead info
          const { data: shares } = await supabaseClient
            .from('room_design_shares')
            .select('design_id, lead_id, customer_name, customer_email, permission_level, comments')
            .in('design_id', designIds);

          // Map shares by design_id
          designShares = {};
          (shares || []).forEach(share => {
            if (!designShares[share.design_id]) {
              designShares[share.design_id] = [];
            }
            designShares[share.design_id].push(share);
          });

          // Get unread message counts for designs with shares
          const leadIds = (shares || []).filter(s => s.lead_id).map(s => s.lead_id);
          if (leadIds.length > 0) {
            const { data: messages } = await supabaseClient
              .from('customer_messages')
              .select('customer_id, id, read_at')
              .in('customer_id', leadIds)
              .eq('channel', 'design_share')
              .eq('direction', 'inbound');

            // Count unread messages per lead, then map to design
            const unreadByLead = {};
            (messages || []).forEach(msg => {
              if (!msg.read_at) {
                unreadByLead[msg.customer_id] = (unreadByLead[msg.customer_id] || 0) + 1;
              }
            });

            // Map back to designs
            designMessages = {};
            (shares || []).forEach(share => {
              if (share.lead_id && unreadByLead[share.lead_id]) {
                designMessages[share.design_id] = (designMessages[share.design_id] || 0) + unreadByLead[share.lead_id];
              }
            });
          }
        }

        // Update count badge
        const countEl = document.getElementById('designs-count');
        if (countEl) {
          countEl.textContent = allDesigns.length;
          countEl.style.display = allDesigns.length > 0 ? 'inline-flex' : 'none';
        }

        loadingEl.style.display = 'none';

        if (allDesigns.length === 0) {
          emptyEl.style.display = 'block';
          gridEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          gridEl.style.display = 'grid';
          renderDesigns();
        }

      } catch (err) {
        console.error('Error loading designs:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        gridEl.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading designs. Please try again.</p>';
      }
    }

    function filterDesigns() {
      designsFilter = document.getElementById('designs-filter').value;
      renderDesigns();
    }

    function renderDesigns() {
      const gridEl = document.getElementById('designs-grid');
      if (!gridEl) return;

      let filtered = allDesigns;
      if (designsFilter === 'shared') {
        filtered = allDesigns.filter(d => d.share_token);
      } else if (designsFilter === 'private') {
        filtered = allDesigns.filter(d => !d.share_token);
      } else if (designsFilter === 'with-messages') {
        filtered = allDesigns.filter(d => designMessages[d.id] > 0);
      }

      if (filtered.length === 0) {
        gridEl.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 40px; grid-column: 1 / -1;">No ${designsFilter === 'all' ? '' : designsFilter + ' '}designs found.</p>`;
        return;
      }

      gridEl.innerHTML = filtered.map(design => {
        const isShared = !!design.share_token;
        const roomType = design.room_type || 'kitchen';
        const updatedDate = new Date(design.updated_at).toLocaleDateString();
        const elementCount = Array.isArray(design.elements) ? design.elements.length : 0;

        // Get customer/lead info from shares
        const shares = designShares[design.id] || [];
        const primaryShare = shares[0];
        const customerName = primaryShare?.customer_name || primaryShare?.customer_email;
        const unreadCount = designMessages[design.id] || 0;

        return `
          <div class="design-card" data-id="${design.id}">
            <div class="design-preview">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              <span class="design-preview-badge ${isShared ? 'shared' : 'private'}">${isShared ? 'Shared' : 'Private'}</span>
              ${unreadCount > 0 ? `<span class="design-message-badge">${unreadCount}</span>` : ''}
            </div>
            <div class="design-content">
              <div class="design-title">${escapeHtml(design.name || design.project_name || 'Untitled Design')}</div>
              ${customerName ? `
                <div class="design-customer">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  <span>${escapeHtml(customerName)}</span>
                </div>
              ` : ''}
              <div class="design-meta">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                  ${roomType.charAt(0).toUpperCase() + roomType.slice(1)}
                </span>
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  ${elementCount} items
                </span>
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  ${updatedDate}
                </span>
              </div>
              <div class="design-actions">
                <a href="/tools/room-designer/?p=${design.share_token || design.id}" class="design-btn-open">Open</a>
                ${unreadCount > 0 ? `
                  <button class="design-btn-messages" onclick="openDesignMessages('${design.id}')" title="${unreadCount} unread message${unreadCount > 1 ? 's' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <span class="btn-badge">${unreadCount}</span>
                  </button>
                ` : ''}
                <button class="design-btn-share" onclick="copyDesignLink('${design.share_token || design.id}')" title="Copy share link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                </button>
                <button class="design-btn-share" onclick="linkDesignToLead('${design.id}')" title="Link to customer/lead" style="color: var(--gold-primary);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                </button>
                <button class="design-btn-share" onclick="openStartHandoffModal('${design.id}', '${escapeHtml(design.name || design.project_name || '')}')" title="Start fabrication handoff" style="color: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </button>
                <button class="design-btn-delete" onclick="deleteDesign('${design.id}', '${escapeHtml(design.name || design.project_name || 'Untitled')}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function copyDesignLink(token) {
      const url = `${window.location.origin}/tools/room-designer/?p=${token}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Design link copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    async function deleteDesign(designId, designName) {
      if (!confirm(`Are you sure you want to delete "${designName}"? This cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('room_designs')
          .delete()
          .eq('id', designId);

        if (error) throw error;

        // Remove from local array
        allDesigns = allDesigns.filter(d => d.id !== designId);

        // Update count badge
        const countEl = document.getElementById('designs-count');
        if (countEl) {
          countEl.textContent = allDesigns.length;
          countEl.style.display = allDesigns.length > 0 ? 'inline-flex' : 'none';
        }

        // Re-render or show empty
        if (allDesigns.length === 0) {
          document.getElementById('designs-empty').style.display = 'block';
          document.getElementById('designs-grid').style.display = 'none';
        } else {
          renderDesigns();
        }

        showToast('Design deleted successfully', 'success');

      } catch (err) {
        console.error('Error deleting design:', err);
        showToast('Failed to delete design', 'error');
      }
    }

    // Link a design to a lead/customer from CRM
    async function linkDesignToLead(designId) {
      const design = allDesigns.find(d => d.id === designId);
      if (!design) return;

      // Create modal for lead selection
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'linkLeadModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h3>Link Design to Customer</h3>
            <button onclick="document.getElementById('linkLeadModal').remove()" class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <p style="color: var(--text-muted); margin-bottom: 16px;">
              Link "${escapeHtml(design.name || design.project_name || 'this design')}" to a customer from your CRM.
            </p>
            <div class="form-group">
              <label>Search Customer/Lead</label>
              <input type="text" id="leadSearchInput" placeholder="Type name or email..."
                     style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary);"
                     oninput="searchLeadsForDesign(this.value)">
            </div>
            <div id="leadSearchResults" style="max-height: 200px; overflow-y: auto; margin-top: 12px;"></div>
            <div class="form-group" style="margin-top: 16px;">
              <label>Or enter customer email directly</label>
              <input type="email" id="directCustomerEmail" placeholder="customer@email.com"
                     style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary);">
            </div>
          </div>
          <div class="modal-footer">
            <button onclick="document.getElementById('linkLeadModal').remove()" class="btn-modern secondary">Cancel</button>
            <button onclick="confirmLinkDesignToLead('${designId}')" class="btn-modern primary">Link Customer</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Store design ID for the confirm function
      window._linkingDesignId = designId;
    }

    async function searchLeadsForDesign(query) {
      const resultsEl = document.getElementById('leadSearchResults');
      if (!resultsEl) return;

      if (!query || query.length < 2) {
        resultsEl.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">Type at least 2 characters to search...</p>';
        return;
      }

      try {
        const { data: leads, error } = await supabaseClient
          .from('leads')
          .select('id, name, email, phone, status')
          .or(`name.ilike.%${query}%,email.ilike.%${query}%`)
          .limit(10);

        if (error) throw error;

        if (!leads || leads.length === 0) {
          resultsEl.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No customers found.</p>';
          return;
        }

        resultsEl.innerHTML = leads.map(lead => `
          <div class="lead-search-item" onclick="selectLeadForDesign('${lead.id}', '${escapeHtml(lead.name || '')}', '${escapeHtml(lead.email || '')}')"
               style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
            <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(lead.name || 'Unknown')}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(lead.email || 'No email')}</div>
            <div style="font-size: 11px; color: var(--gold-primary); margin-top: 4px;">${lead.status || 'Lead'}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error searching leads:', err);
        resultsEl.innerHTML = '<p style="color: var(--error);">Error searching customers.</p>';
      }
    }

    let _selectedLeadId = null;
    let _selectedLeadName = null;
    let _selectedLeadEmail = null;

    function selectLeadForDesign(leadId, name, email) {
      _selectedLeadId = leadId;
      _selectedLeadName = name;
      _selectedLeadEmail = email;

      // Highlight selected
      document.querySelectorAll('.lead-search-item').forEach(el => {
        el.style.background = 'transparent';
        el.style.borderColor = 'var(--border-color)';
      });
      event.currentTarget.style.background = 'rgba(249, 203, 0, 0.1)';
      event.currentTarget.style.borderColor = 'var(--gold-primary)';
    }

    async function confirmLinkDesignToLead(designId) {
      const directEmail = document.getElementById('directCustomerEmail')?.value?.trim();

      let leadId = _selectedLeadId;
      let customerName = _selectedLeadName;
      let customerEmail = _selectedLeadEmail || directEmail;

      if (!leadId && !customerEmail) {
        showToast('Please select a customer or enter an email', 'warning');
        return;
      }

      try {
        // If only email provided, try to find or we'll store the email
        if (!leadId && customerEmail) {
          // Check if lead exists with this email
          const { data: existingLead } = await supabaseClient
            .from('leads')
            .select('id, name')
            .eq('email', customerEmail)
            .single();

          if (existingLead) {
            leadId = existingLead.id;
            customerName = existingLead.name;
          }
        }

        // Generate share token if design doesn't have one
        const design = allDesigns.find(d => d.id === designId);
        let shareToken = design?.share_token;

        if (!shareToken) {
          shareToken = generateToken(16);
          await supabaseClient
            .from('room_designs')
            .update({ share_token: shareToken })
            .eq('id', designId);
        }

        // Create or update room_design_shares record
        const { error } = await supabaseClient
          .from('room_design_shares')
          .upsert({
            design_id: designId,
            lead_id: leadId,
            customer_name: customerName,
            customer_email: customerEmail,
            share_token: shareToken,
            permission_level: 'view'
          }, { onConflict: 'design_id,lead_id' });

        if (error) throw error;

        document.getElementById('linkLeadModal')?.remove();
        showToast(`Design linked to ${customerName || customerEmail}`, 'success');

        // Refresh designs to show the link
        await loadMyDesigns();

        // Reset
        _selectedLeadId = null;
        _selectedLeadName = null;
        _selectedLeadEmail = null;

      } catch (err) {
        console.error('Error linking design:', err);
        showToast('Failed to link design to customer', 'error');
      }
    }

    function generateToken(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < length; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    // Open messages for a specific design
    function openDesignMessages(designId) {
      // Navigate to messages page with design filter
      showPage('messages');

      // Set filter to show messages for this design
      setTimeout(() => {
        const shares = designShares[designId] || [];
        if (shares.length > 0 && shares[0].lead_id) {
          // If we have a conversation filter, apply it
          const leadId = shares[0].lead_id;
          if (typeof loadConversation === 'function') {
            loadConversation(leadId, 'design_share');
          }
        }
        showToast('Showing messages for this design', 'info');
      }, 300);
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============ NAVIGATION & LOCATION HELPERS ============

    // Build full address string
    function buildFullAddress(street, city, state, zip) {
      const parts = [street, city, state, zip].filter(Boolean);
      return parts.join(', ');
    }

    // Get navigation URL (works on mobile and desktop)
    function getNavigationUrl(street, city, state, zip) {
      const address = buildFullAddress(street, city, state, zip);
      // Use universal Google Maps URL that works everywhere
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    }

    // Open in Google Maps with directions
    function openInGoogleMaps(street, city, state, zip) {
      const address = buildFullAddress(street, city, state, zip);
      // Check if on iOS for Apple Maps option
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (isIOS && confirm('Open in Apple Maps instead of Google Maps?')) {
        window.open(`https://maps.apple.com/?daddr=${encodeURIComponent(address)}`, '_blank');
      } else {
        // Google Maps directions (will prompt for starting location)
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`, '_blank');
      }
    }

    // Share En Route status - notifies customer and logs activity
    async function shareEnRouteStatus(projectId, customerName, street, city, state, zip) {
      const address = buildFullAddress(street, city, state, zip);

      // Show confirmation with options
      const options = [
        { label: 'Start Navigation & Notify Customer', value: 'navigate_notify' },
        { label: 'Just Start Navigation', value: 'navigate_only' },
        { label: 'Just Update Status', value: 'status_only' }
      ];

      const choice = await showEnRouteOptions(customerName, address);
      if (!choice) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Update project status to show en route
        if (choice !== 'navigate_only') {
          await supabaseClient
            .from('projects')
            .update({
              en_route_status: 'en_route',
              en_route_started_at: new Date().toISOString(),
              en_route_by: user.id,
              updated_at: new Date().toISOString()
            })
            .eq('id', projectId);

          // Log activity
          await supabaseClient.from('project_activity').insert({
            project_id: projectId,
            user_id: user.id,
            type: 'en_route',
            message: `${userProfile?.full_name || 'Team member'} is en route to the project location`,
            created_at: new Date().toISOString()
          });

          showToast('En Route status updated!', 'success');
        }

        // Open navigation
        if (choice === 'navigate_notify' || choice === 'navigate_only') {
          openInGoogleMaps(street, city, state, zip);
        }

        // Send notification to customer (if they have email)
        if (choice === 'navigate_notify') {
          const { data: project } = await supabaseClient
            .from('projects')
            .select('customer_email, customer_phone, customer_name')
            .eq('id', projectId)
            .single();

          if (project?.customer_email) {
            // Send en route notification email
            try {
              await fetch(`${API_BASE}/api/notifications/en-route`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  customer_email: project.customer_email,
                  customer_name: project.customer_name,
                  team_member: userProfile?.full_name || 'Our team',
                  project_address: address
                })
              });
              showToast('Customer notified!', 'success');
            } catch (e) {
              console.warn('Could not send en route notification:', e);
            }
          }
        }

      } catch (err) {
        console.error('Error updating en route status:', err);
        showToast('Error updating status', 'error');
      }
    }

    // Show en route options dialog
    function showEnRouteOptions(customerName, address) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.style.zIndex = '20000';
        modal.innerHTML = `
          <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
              <h2 class="modal-title">En Route to Project</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
              <div style="background: var(--dark-surface); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">DESTINATION</div>
                <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(customerName || 'Customer')}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(address)}</div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-modern primary" style="width: 100%; justify-content: center; padding: 14px;" onclick="this.closest('.modal-overlay').dataset.choice='navigate_notify'; this.closest('.modal-overlay').remove();">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                  Navigate & Notify Customer
                </button>
                <button class="btn-modern secondary" style="width: 100%; justify-content: center; padding: 14px;" onclick="this.closest('.modal-overlay').dataset.choice='navigate_only'; this.closest('.modal-overlay').remove();">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                  Just Navigate
                </button>
                <button class="btn-modern ghost" style="width: 100%; justify-content: center; padding: 14px;" onclick="this.closest('.modal-overlay').dataset.choice='status_only'; this.closest('.modal-overlay').remove();">
                  Update Status Only
                </button>
              </div>
            </div>
          </div>
        `;

        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
            resolve(null);
          }
        });

        const observer = new MutationObserver(() => {
          if (!document.body.contains(modal)) {
            observer.disconnect();
            resolve(modal.dataset.choice || null);
          }
        });
        observer.observe(document.body, { childList: true });

        document.body.appendChild(modal);
      });
    }

    // Mark as arrived at location
    async function markArrivedAtProject(projectId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        await supabaseClient
          .from('projects')
          .update({
            en_route_status: 'arrived',
            arrived_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('id', projectId);

        await supabaseClient.from('project_activity').insert({
          project_id: projectId,
          user_id: user.id,
          type: 'arrived',
          message: `${userProfile?.full_name || 'Team member'} arrived at the project location`,
          created_at: new Date().toISOString()
        });

        showToast('Marked as arrived!', 'success');
        if (typeof openProjectDetail === 'function') {
          openProjectDetail(projectId);
        }
      } catch (err) {
        console.error('Error marking arrived:', err);
        showToast('Error updating status', 'error');
      }
    }

    function requestQuoteForFavorites() {
      if (allFavorites.length === 0) {
        showToast('No favorites saved yet!', 'error');
        return;
      }

      // Build quote modal
      const modal = document.createElement('div');
      modal.className = 'quote-modal';
      modal.id = 'quote-modal';
      modal.innerHTML = `
        <div class="quote-modal-content">
          <div class="quote-modal-header">
            <h3>Request a Quote</h3>
            <button onclick="closeQuoteModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div class="quote-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">We'll prepare a quote for these ${allFavorites.length} items:</p>

            <div class="quote-items-list">
              ${allFavorites.map(item => `
                <div class="quote-item">
                  <img src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}">
                  <div class="quote-item-info">
                    <div class="quote-item-title">${item.product_title}</div>
                    <div class="quote-item-material">${item.product_type || ''} ${item.product_material ? '- ' + item.product_material : ''} ${item.product_color ? '- ' + item.product_color : ''}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Additional Notes (Optional)</label>
              <textarea id="quote-notes" rows="3" placeholder="Tell us about your project, room size, timeline, etc." style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark); color: var(--text-primary); resize: vertical;"></textarea>
            </div>

            <button class="btn-modern primary" style="width: 100%;" onclick="submitQuoteRequest()">
              Submit Quote Request
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeQuoteModal() {
      const modal = document.getElementById('quote-modal');
      if (modal) modal.remove();
    }

    async function submitQuoteRequest() {
      const notes = document.getElementById('quote-notes')?.value || '';

      // Group favorites by type for the quote
      const groupedFavorites = allFavorites.reduce((acc, f) => {
        const type = f.product_type || 'other';
        if (!acc[type]) acc[type] = [];
        acc[type].push(f);
        return acc;
      }, {});

      // Build formatted list
      const itemsList = Object.entries(groupedFavorites).map(([type, items]) => {
        return `${type.charAt(0).toUpperCase() + type.slice(1)}:\n${items.map(f => `  - ${f.product_title} (${f.product_material || 'N/A'})`).join('\n')}`;
      }).join('\n\n');

      try {
        // Create lead/quote request in Supabase
        const quoteData = {
          user_id: currentUser.id,
          email: currentUser.email,
          full_name: userProfile?.full_name || currentUser.email.split('@')[0],
          phone: userProfile?.phone || '',
          status: 'new',
          source: 'favorites_quote',
          notes: `Quote Request from Favorites:\n\n${itemsList}\n\nAdditional Notes: ${notes || 'None'}`,
          created_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
          .from('leads')
          .insert(quoteData);

        if (error) {
          console.warn('Lead insert error (table may not exist):', error);
        }

        // Send email notification via API
        try {
          await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'info@surprisegranite.com',
              counterSqft: 'Quote Request from Favorites',
              splashSqft: '',
              totalSqft: `${allFavorites.length} items selected`,
              edgeProfile: `Customer: ${userProfile?.full_name || currentUser.email}`,
              edgeLF: `Phone: ${userProfile?.phone || 'N/A'}`,
              priceBudget: allFavorites.map(f => f.product_title).join(', '),
              pricePopular: notes || 'No additional notes',
              pricePremium: `Email: ${currentUser.email}`
            })
          });
        } catch (emailErr) {
          console.warn('Email notification error:', emailErr);
        }

        closeQuoteModal();
        showToast('Quote request submitted! We\'ll contact you soon.', 'success');

      } catch (err) {
        console.error('Quote submit error:', err);
        showToast('Error submitting quote. Please try again.', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#333'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Show keyboard shortcuts modal
    function showKeyboardShortcuts() {
      const shortcuts = [
        { category: 'Navigation', items: [
          { keys: 'D', desc: 'Go to Dashboard' },
          { keys: 'L', desc: 'Go to Leads' },
          { keys: 'P', desc: 'Go to Projects' },
          { keys: 'C', desc: 'Go to Calendar' },
          { keys: 'F', desc: 'Go to Finance' },
        ]},
        { category: 'Quick Actions', items: [
          { keys: 'Ctrl/Cmd + N', desc: 'Add New Lead' },
          { keys: 'Ctrl/Cmd + K', desc: 'Focus Search' },
          { keys: 'Shift + E', desc: 'Add Calendar Event' },
          { keys: 'Shift + I', desc: 'Create Invoice' },
          { keys: 'Shift + P', desc: 'Create Project' },
        ]},
        { category: 'General', items: [
          { keys: 'Escape', desc: 'Close Modal/Popup' },
        ]},
      ];

      const modal = document.createElement('div');
      modal.className = 'keyboard-shortcuts-modal';
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000;
        display: flex; align-items: center; justify-content: center; padding: 20px;
      `;
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; max-width: 480px; width: 100%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Keyboard Shortcuts</h2>
            <button onclick="this.closest('.keyboard-shortcuts-modal').remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px;">&times;</button>
          </div>
          ${shortcuts.map(cat => `
            <div style="margin-bottom: 20px;">
              <h3 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 10px;">${cat.category}</h3>
              ${cat.items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                  <span style="color: var(--text-secondary); font-size: 14px;">${item.desc}</span>
                  <kbd style="background: var(--dark-elevated); border: 1px solid var(--border-light); border-radius: 6px; padding: 4px 10px; font-family: monospace; font-size: 12px; color: var(--gold-primary);">${item.keys}</kbd>
                </div>
              `).join('')}
            </div>
          `).join('')}
          <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; text-align: center;">Press <kbd style="background: var(--dark-elevated); border: 1px solid var(--border-light); border-radius: 4px; padding: 2px 6px; font-size: 11px;">?</kbd> anytime to show this help</p>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ============ NOTIFICATION HELPER ============
    // Send email + SMS notifications via API
    async function sendNotification(type, action, entity, recipient, newStatus = null) {
      // Only send if we have recipient info
      if (!recipient?.email && !recipient?.phone) {
        console.log('[Notify] No recipient info, skipping notification');
        return { email: { sent: false }, sms: { sent: false } };
      }

      try {
        const response = await fetch('/api/workflow/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type,          // 'estimate', 'invoice', 'job', 'appointment'
            action,        // 'sent', 'approved', 'status_change', 'reminder', 'paid'
            entity,        // The data object
            recipient,     // { email, phone, name }
            new_status: newStatus
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('[Notify] Sent:', { type, action, result: result.notifications });
          return result.notifications;
        } else {
          console.log('[Notify] API error:', response.status);
          return { email: { sent: false }, sms: { sent: false } };
        }
      } catch (err) {
        console.log('[Notify] Error:', err.message);
        return { email: { sent: false }, sms: { sent: false } };
      }
    }

    // Load subscriber/user statistics
    // ============ NEEDS ATTENTION WIDGET ============
    async function loadNeedsAttention() {
      const container = document.getElementById('needs-attention-content');
      if (!container) return;

      try {
        const items = [];

        // Get leads not contacted in 48+ hours
        const cutoff48h = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString();
        const { data: staleLeads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, created_at')
          .eq('status', 'new')
          .lt('created_at', cutoff48h)
          .limit(5);

        if (staleLeads?.length > 0) {
          items.push({
            type: 'leads',
            icon: '',
            color: '#f59e0b',
            title: `${staleLeads.length} lead${staleLeads.length > 1 ? 's' : ''} need follow-up`,
            subtitle: 'Not contacted in 48+ hours',
            action: () => showPage('leads')
          });
        }

        // Get today's appointments
        const today = new Date();
        const todayStart = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const todayEnd = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        const { data: todayAppts } = await supabaseClient
          .from('calendar_events')
          .select('id')
          .gte('start_time', todayStart)
          .lte('start_time', todayEnd)
          .in('status', ['scheduled', 'confirmed']);

        if (todayAppts?.length > 0) {
          items.push({
            type: 'appointments',
            icon: '',
            color: '#3b82f6',
            title: `${todayAppts.length} appointment${todayAppts.length > 1 ? 's' : ''} today`,
            subtitle: 'View your schedule',
            action: () => showPage('calendar')
          });
        }

        // Get overdue invoices
        const { data: overdueInvoices } = await supabaseClient
          .from('invoices')
          .select('id, total')
          .eq('status', 'sent')
          .lt('due_date', new Date().toISOString())
          .limit(10);

        if (overdueInvoices?.length > 0) {
          const total = overdueInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
          items.push({
            type: 'invoices',
            icon: '',
            color: '#ef4444',
            title: `$${total.toLocaleString()} in overdue invoices`,
            subtitle: `${overdueInvoices.length} invoice${overdueInvoices.length > 1 ? 's' : ''} past due`,
            action: () => showPage('invoices')
          });
        }

        // Get pending estimates awaiting approval
        const { data: pendingEstimates } = await supabaseClient
          .from('estimates')
          .select('id')
          .eq('status', 'sent')
          .limit(10);

        if (pendingEstimates?.length > 0) {
          items.push({
            type: 'estimates',
            icon: '',
            color: '#8b5cf6',
            title: `${pendingEstimates.length} estimate${pendingEstimates.length > 1 ? 's' : ''} awaiting approval`,
            subtitle: 'Sent but not yet approved',
            action: () => showPage('estimates')
          });
        }

        // Render items
        if (items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <p style="margin: 0;">All caught up!</p>
            </div>`;
          return;
        }

        container.innerHTML = items.map(item => `
          <div class="attention-item" onclick="${item.action ? item.action.toString().replace(/"/g, "'") : ''}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 8px; cursor: pointer; border-left: 3px solid ${item.color};">
            <span style="font-size: 20px;">${item.icon}</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${item.title}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${item.subtitle}</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          </div>
        `).join('');

        // Make items clickable
        container.querySelectorAll('.attention-item').forEach((el, i) => {
          el.onclick = items[i].action;
        });

      } catch (err) {
        console.error('Load needs attention error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading data</div>';
      }
    }

    function refreshNeedsAttention() {
      loadNeedsAttention();
      showToast('Refreshed', 'success');
    }

    // ============ TODAY'S SCHEDULE WIDGET ============
    async function loadTodaySchedule() {
      const container = document.getElementById('today-schedule-content');
      if (!container) return;

      try {
        const today = new Date();
        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
        const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59).toISOString();

        const { data: events, error } = await supabaseClient
          .from('calendar_events')
          .select('id, title, start_time, end_time, event_type, location, status')
          .gte('start_time', todayStart)
          .lte('start_time', todayEnd)
          .order('start_time', { ascending: true });

        if (error) throw error;

        if (!events || events.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <p style="margin: 0 0 12px;">No appointments scheduled for today</p>
              <button class="btn-modern primary" onclick="showPage('calendar'); setTimeout(() => openCalendarEventModal(), 200);" style="font-size: 13px;">
                Schedule Something
              </button>
            </div>`;
          return;
        }

        container.innerHTML = events.map(event => {
          const startTime = new Date(event.start_time);
          const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const typeColors = {
            appointment: '#f59e0b',
            consultation: '#6366f1',
            measurement: '#10b981',
            installation: '#3b82f6',
            delivery: '#8b5cf6'
          };
          const color = typeColors[event.event_type] || '#6b7280';

          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--border-subtle);">
              <div style="width: 4px; height: 40px; background: ${color}; border-radius: 2px;"></div>
              <div style="min-width: 70px; font-size: 13px; color: var(--text-muted);">${timeStr}</div>
              <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 14px;">${escapeHtml(event.title)}</div>
                ${event.location ? `<div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(event.location)}</div>` : ''}
              </div>
              <span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: ${color}20; color: ${color};">${event.event_type}</span>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load today schedule error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading schedule</div>';
      }
    }

    // Load field status - projects with team en route or on site
    async function loadFieldStatus() {
      const container = document.getElementById('field-status-content');
      const card = document.getElementById('field-status-card');
      if (!container || !card) return;

      try {
        // Fetch projects with en_route_status
        const { data: projects, error } = await supabaseClient
          .from('projects')
          .select('id, name, customer_name, customer_phone, address, city, state, zip, en_route_status, en_route_started_at, arrived_at, en_route_by')
          .in('en_route_status', ['en_route', 'arrived'])
          .order('en_route_started_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        // Show/hide card based on whether there are any en route projects
        if (!projects || projects.length === 0) {
          card.style.display = 'none';
          return;
        }

        card.style.display = 'block';

        container.innerHTML = projects.map(p => {
          const isEnRoute = p.en_route_status === 'en_route';
          const isArrived = p.en_route_status === 'arrived';
          const statusColor = isEnRoute ? '#f59e0b' : '#22c55e';
          const statusLabel = isEnRoute ? 'EN ROUTE' : 'ON SITE';
          const statusIcon = isEnRoute
            ? '<path d="M13 10V3L4 14h7v7l9-11h-7z"/>'
            : '<path d="M5 13l4 4L19 7"/>';
          const timeStr = p.en_route_started_at
            ? new Date(p.en_route_started_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
            : '';
          const address = buildFullAddress(p.address, p.city, p.state, p.zip);

          return `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background 0.15s;" onclick="openProjectDetail('${p.id}')" onmouseover="this.style.background='var(--dark-elevated)'" onmouseout="this.style.background='transparent'">
              <div style="width: 36px; height: 36px; border-radius: 8px; background: ${statusColor}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="18" height="18" fill="none" stroke="${statusColor}" stroke-width="2" viewBox="0 0 24 24">${statusIcon}</svg>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${escapeHtml(p.name)}</span>
                  <span style="font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: ${statusColor}; color: white;">${statusLabel}</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">${escapeHtml(p.customer_name || 'No customer')}</div>
                ${address ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                  <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  ${escapeHtml(address)}
                </div>` : ''}
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex-shrink: 0;">
                ${timeStr ? `<span style="font-size: 11px; color: var(--text-muted);">Started ${timeStr}</span>` : ''}
                <div style="display: flex; gap: 4px;">
                  ${p.customer_phone ? `<a href="tel:${p.customer_phone}" onclick="event.stopPropagation();" style="width: 28px; height: 28px; border-radius: 6px; background: #22c55e20; display: flex; align-items: center; justify-content: center;">
                    <svg width="14" height="14" fill="none" stroke="#22c55e" stroke-width="2" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72"/></svg>
                  </a>` : ''}
                  <button onclick="event.stopPropagation(); openInGoogleMaps('${escapeHtml(p.address || '')}', '${escapeHtml(p.city || '')}', '${escapeHtml(p.state || '')}', '${escapeHtml(p.zip || '')}')" style="width: 28px; height: 28px; border-radius: 6px; background: #3b82f620; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="14" height="14" fill="none" stroke="#3b82f6" stroke-width="2" viewBox="0 0 24 24"><path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                  </button>
                  ${isEnRoute ? `<button onclick="event.stopPropagation(); markArrivedAtProject('${p.id}')" style="padding: 4px 10px; border-radius: 6px; background: #22c55e; border: none; cursor: pointer; font-size: 11px; font-weight: 600; color: white;">Mark Arrived</button>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        // Silently hide card if columns don't exist yet (schema not updated)
        card.style.display = 'none';
      }
    }

    function refreshFieldStatus() {
      loadFieldStatus();
      showToast('Field status refreshed', 'success');
    }

    async function loadSubscriberStats() {
      console.log('[SubscriberStats] Loading...');
      try {
        // Get total users count
        const { count: totalUsers, error: totalError } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact', head: true });

        if (totalError) throw totalError;

        // Get new users (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        const { count: newUsers, error: newError } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact', head: true })
          .gte('created_at', sevenDaysAgo.toISOString());

        if (newError) throw newError;

        // Update UI
        const totalUsersEl = document.getElementById('stat-total-users');
        const newUsersEl = document.getElementById('stat-new-users');

        if (totalUsersEl) totalUsersEl.textContent = totalUsers || 0;
        if (newUsersEl) newUsersEl.textContent = newUsers || 0;

        console.log('Subscriber stats loaded:', { totalUsers, newUsers });
      } catch (err) {
        console.warn('Error loading subscriber stats:', err.message);
        // Set fallback values
        const totalUsersEl = document.getElementById('stat-total-users');
        const newUsersEl = document.getElementById('stat-new-users');
        if (totalUsersEl) totalUsersEl.textContent = '0';
        if (newUsersEl) newUsersEl.textContent = '0';
      }
    }

    let dashboardInitialized = false;

    function setupDashboard() {
      // Prevent re-initialization which would reset stats
      if (dashboardInitialized) {
        console.log('[Dashboard] Already initialized, skipping setup');
        return;
      }
      dashboardInitialized = true;
      console.log('[Dashboard] Initializing dashboard...');

      // Setup stats and quick actions based on role
      const statsEl = document.getElementById('dashboard-stats');
      const actionsEl = document.getElementById('quick-actions');

      if (isAdmin) {
        loadLeads();
        loadCustomers();
        loadSubscriberStats();
        setupLeadsRealtime();
        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Leads</div>
            <div class="stat-value" id="stat-new">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Users</div>
            <div class="stat-value" id="stat-new-users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="stat-total-users">-</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('collaborators')">
            <div class="stat-label">Network</div>
            <div class="stat-value" id="stat-network">-</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="javascript:void(0)" class="action-card" onclick="showPage('leads'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>View Leads</h4>
              <p>Manage incoming leads from the website</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="showPage('calendar'); setTimeout(() => openCalendarEventModal(), 200); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Schedule</h4>
              <p>Create appointment or meeting</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="openInviteToProjectModal(); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            </div>
            <div class="action-text">
              <h4>Invite Collaborator</h4>
              <p>Invite someone to collaborate on a project</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="showPage('projects'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Projects</h4>
              <p>Manage projects, track progress and revenue</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="resetTutorial(); return false;" style="border: 1px dashed var(--gold-primary); background: rgba(249, 203, 0, 0.05);">
            <div class="action-icon" style="color: var(--gold-primary);">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>Take the Tour <span class="new-feature-badge" style="margin-left: 8px;">NEW</span></h4>
              <p>Learn about new project management features</p>
            </div>
          </a>
        `;

        // Show admin widgets
        document.getElementById('needs-attention-card').style.display = 'block';
        document.getElementById('today-schedule-card').style.display = 'block';
        // Field status card visibility is controlled by loadFieldStatus based on data
        loadNeedsAttention();
        loadTodaySchedule();
        loadFieldStatus();
      } else {
        // Enhanced user stats
        statsEl.innerHTML = `
          <div class="stat-card clickable" onclick="showPage('favorites')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></div>
            <div class="stat-label">My Favorites</div>
            <div class="stat-value" id="stat-favorites">0</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('listings')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></div>
            <div class="stat-label">My Listings</div>
            <div class="stat-value" id="stat-listings">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
            <div class="stat-label">Quotes Sent</div>
            <div class="stat-value" id="stat-quotes">0</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('collaborators')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
            <div class="stat-label">My Network</div>
            <div class="stat-value" id="stat-network">0</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="/get-a-free-estimate/" class="action-card action-highlight">
            <div class="action-icon action-icon-gold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Get Free Estimate</h4>
              <p>Request a quote for your project</p>
            </div>
          </a>
          <a href="javascript:void(0)" onclick="showPage('favorites'); return false;" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>My Favorites</h4>
              <p>View saved materials</p>
            </div>
          </a>
          <a href="/remnants/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            </div>
            <div class="action-text">
              <h4>Stone Marketplace</h4>
              <p>Buy & sell remnants</p>
            </div>
          </a>
          <a href="/marketplace/slabs//" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Countertops</h4>
              <p>Granite, quartz, marble</p>
            </div>
          </a>
          <a href="/materials/flooring/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-width="2" d="M4 4h16v16H4z M4 10h16 M10 4v16"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Flooring</h4>
              <p>LVP, hardwood, tile</p>
            </div>
          </a>
          <a href="/tools/countertop-calculator/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Calculator</h4>
              <p>Estimate your project</p>
            </div>
          </a>
          <a href="javascript:void(0)" onclick="showPage('collaborators'); return false;" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>Collaborations</h4>
              <p>View project collaborations</p>
            </div>
          </a>
        `;
      }

      // Setup leads filter buttons (filter-pill with data-status)
      document.querySelectorAll('.filter-pills .filter-pill[data-status]').forEach(btn => {
        btn.addEventListener('click', () => {
          // Only toggle active within leads filter pills
          btn.closest('.filter-pills').querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          renderLeads();
        });
      });

      // Setup search
      document.getElementById('leads-search')?.addEventListener('input', () => {
        renderLeads();
      });

      // Load admin users if admin
      if (isSuperAdmin) {
        loadAdminUsers();
      }

      // Load user stats from database
      if (!isAdmin) {
        loadUserStats();
      }

      // Bridge: check vendor onboarding + network stats
      checkVendorOnboarding();
      loadNetworkStats();
    }

    // Load real user stats from database
    async function loadUserStats() {
      if (!currentUser) return;

      try {
        // Load favorites count
        const { count: favCount, error: favError } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!favError) {
          const favEl = document.getElementById('stat-favorites');
          if (favEl) favEl.textContent = favCount || 0;
        }

        // Load listings count
        const { count: listCount, error: listError } = await supabaseClient
          .from('marketplace_listings')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!listError) {
          const listEl = document.getElementById('stat-listings');
          if (listEl) listEl.textContent = listCount || 0;
        }

        // Load quotes count
        const { count: quoteCount, error: quoteError } = await supabaseClient
          .from('quote_requests')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!quoteError) {
          const quoteEl = document.getElementById('stat-quotes');
          if (quoteEl) quoteEl.textContent = quoteCount || 0;
        }

        console.log('Dashboard: Loaded user stats', { favorites: favCount, listings: listCount, quotes: quoteCount });

      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    // Bridge 1: Check if pro user needs vendor onboarding
    async function checkVendorOnboarding() {
      try {
        if (!currentUser || !userProfile) return;
        var role = userProfile.account_type || userProfile.role || '';
        if (['pro_fabricator', 'pro_designer', 'contractor'].indexOf(role) === -1) return;

        var result = await supabaseClient
          .from('vendor_profiles')
          .select('id')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (result.data) return; // Already has vendor profile

        var banner = document.getElementById('vendor-onboarding-banner');
        if (!banner) return;
        banner.style.display = '';
        banner.innerHTML =
          '<div class="vendor-onboarding-banner">' +
            '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="1.5" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>' +
            '<div class="banner-text">' +
              '<h3>Complete Your Vendor Profile</h3>' +
              '<p>Set up your business profile to appear in our network, receive project leads, and list your inventory on the marketplace.</p>' +
            '</div>' +
            '<a href="/vendor/signup/" class="btn-modern primary" style="white-space: nowrap;">Set Up Profile</a>' +
            '<button class="banner-dismiss" onclick="this.closest(\'.vendor-onboarding-banner\').parentElement.style.display=\'none\'" title="Dismiss">&times;</button>' +
          '</div>';
      } catch (err) {
        console.error('[VendorOnboarding] Check failed:', err);
      }
    }

    // Bridge 4: Load network/collaboration stats for dashboard
    async function loadNetworkStats() {
      try {
        var resp = await apiCall('/api/collaboration/my-projects?status=accepted');
        var data = await resp.json();
        var count = (data.collaborations || []).length;
        var el = document.getElementById('stat-network');
        if (el) el.textContent = count;
      } catch (e) {
        // Silently fail - network stats are non-critical
      }
    }

    async function showPage(page) {
      console.log('[showPage] Called for page:', page, 'authReady:', authReady, 'supabaseClient:', !!supabaseClient);

      // Block non-GOD MODE users from accessing god-* pages
      if (page.startsWith('god-') && !isGodMode()) {
        console.warn('[showPage] Access denied: GOD MODE required for page:', page);
        showPage('dashboard');
        return;
      }

      // Update URL hash without triggering hashchange
      if (window.location.hash !== `#${page}`) {
        history.replaceState(null, '', `#${page}`);
      }

      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update toolbar active state
      document.querySelectorAll('.page-toolbar .toolbar-btn[data-page]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === page);
      });

      // Update page sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === `page-${page}`);
      });

      // Update title
      const titles = {
        'dashboard': 'Dashboard',
        'profile': 'My Profile',
        'favorites': 'My Favorites',
        'my-designs': 'My Designs',
        'listings': 'My Listings',
        'tools': 'Design Tools',
        'leads': 'Leads',
        'customers': 'Customers',
        'estimates': 'Estimates',
        'invoices': 'Invoices',
        'jobs': 'Jobs & Projects',
        'projects': 'Projects',
        'collaborators': 'Collaborators & Team',
        'calendar': 'Calendar',
        'wallet': 'Wallet',
        'admin-users': 'Manage Admins',
        'products': 'Products',
        'orders': 'Orders',
        'messages': 'Messages',
        'collaborations': 'My Collaborations',
        'god-designs': 'All Designs'
      };
      document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

      // Close mobile sidebar first (don't wait for data)
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      if (sidebar) sidebar.classList.remove('open');
      if (overlay) overlay.classList.remove('active');

      // Update FAB visibility based on current page
      updateFabVisibility(page);

      // Wait for auth to be ready before loading any data
      if (!authReady || !supabaseClient) {
        console.log('[showPage] Waiting for auth, authReady:', authReady, 'supabaseClient:', !!supabaseClient);
        const ready = await waitForAuth();
        if (!ready || !supabaseClient) {
          console.error('[showPage] Auth failed to initialize for page:', page);
          return;
        }
        console.log('[showPage] Auth now ready, loading', page);
      }

      console.log('[showPage] Loading data for page:', page);

      // Load data based on page - wrapped in try-catch to prevent silent failures
      try {
        // Load estimates when that page is shown
        if (page === 'estimates') {
          await loadEstimates();
        }

        // Load invoices when that page is shown
        if (page === 'invoices') {
          await loadInvoices();
        }

        // Load leads when that page is shown (if not already loaded by setupDashboard)
        if (page === 'leads' && (!allLeads || allLeads.length === 0)) {
          await loadLeads();
        }

        // Load favorites when that page is shown
        if (page === 'favorites') {
          await loadFavorites();
        }

        // Load my designs when that page is shown
        if (page === 'my-designs') {
          await loadMyDesigns();
        }

        // Load listings when that page is shown
        if (page === 'listings') {
          await loadMyListings();
        }

        // Load jobs when that page is shown
        if (page === 'jobs') {
          await loadJobs();
        }

        // Load projects when that page is shown
        if (page === 'projects') {
          await loadProjects();
        }

        // Load orders when that page is shown
        if (page === 'orders') {
          await loadOrders();
        }

        // Load collaborators when that page is shown
        if (page === 'collaborators') {
          await loadCollaborators();
        }

        // Load calendar when that page is shown - optimized for speed
        if (page === 'calendar') {
          renderCalendar(); // Show empty grid immediately
          // Load job events first (clears array), then custom events (merges)
          loadCalendarEvents().then(() => loadAllCalendarEvents());
        }

        // Load customers when that page is shown
        if (page === 'customers') {
          await loadCustomers();
        }

        // Load messages when that page is shown
        if (page === 'messages') {
          await loadConversations();
        }

        // Load collaborations when that page is shown
        if (page === 'collaborations') {
          await loadCollaborations();
          // Also load network count and invitations count for badges
          loadMyNetwork();
          loadReceivedInvitations();
        }
      } catch (err) {
        console.error('[showPage] Error loading data for', page, err);
      }
    }

    // Show/hide the appropriate FAB based on current page
    function updateFabVisibility(page) {
      const fabMap = {
        'leads': 'fab-leads',
        'estimates': 'fab-estimates',
        'invoices': 'fab-invoices',
        'jobs': 'fab-jobs',
        'customers': 'fab-customers'
      };

      // Hide all FABs first
      document.querySelectorAll('.fab-modern').forEach(fab => {
        fab.style.display = 'none';
      });

      // Show the FAB for current page (mobile only)
      const fabId = fabMap[page];
      if (fabId && window.innerWidth <= 768) {
        const fab = document.getElementById(fabId);
        if (fab) {
          fab.style.display = 'flex';
        }
      }
    }

    // Update FAB visibility on window resize
    window.addEventListener('resize', () => {
      const currentPage = window.location.hash.slice(1) || 'dashboard';
      updateFabVisibility(currentPage);
    });

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      if (sidebar) sidebar.classList.toggle('open');
      if (overlay) overlay.classList.toggle('active');
    }

    // Toggle sidebar collapse state (desktop)
    function toggleSidebarCollapse() {
      const sidebar = document.getElementById('sidebar');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      document.body.classList.toggle('sidebar-collapsed', isCollapsed);

      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
    }

    // Initialize sidebar state from localStorage
    function initSidebarState() {
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
      }
    }

    // Update badge visibility based on count
    function updateBadgeVisibility() {
      document.querySelectorAll('.nav-badge').forEach(badge => {
        const count = parseInt(badge.textContent) || 0;
        badge.setAttribute('data-count', count);
        if (count === 0) {
          badge.style.display = 'none';
        } else {
          badge.style.display = '';
        }
      });
    }

    async function saveProfile() {
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;
      const company = document.getElementById('profile-company').value;

      try {
        const { error } = await supabaseClient
          .from('sg_users')
          .update({
            full_name: name,
            phone: phone || null,
            company_name: company || null,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentUser.id);

        if (error) throw error;

        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        alert('Profile saved successfully!');
      } catch (err) {
        alert('Error saving profile: ' + err.message);
      }
    }

    async function handleLogout() {
      // Use SgAuth's comprehensive logout if available
      if (window.SgAuth && typeof window.SgAuth.signOut === 'function') {
        await window.SgAuth.signOut({ redirect: true, redirectUrl: '/' });
        return;
      }

      // Fallback logout
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.warn('Logout error:', e);
      }

      // Clear all state
      currentUser = null;
      userProfile = null;

      // Clear localStorage
      try {
        const storageKey = window._sgSupabaseConfig?.storageKey || 'sg-auth-token';
        localStorage.removeItem(storageKey);
        localStorage.removeItem('sb-ypeypgwsycxcagncgdur-auth-token');
        sessionStorage.removeItem('auth_redirect');
      } catch (e) {}

      // Dispatch logout event for other components
      window.dispatchEvent(new CustomEvent('sg-auth-logout', {
        detail: { timestamp: Date.now() }
      }));

      // Redirect to home
      window.location.href = '/';
    }

    // Leads Functions
    let leadsSubscription = null;

    function setupLeadsRealtime() {
      // Subscribe to new leads in real-time
      if (leadsSubscription) {
        leadsSubscription.unsubscribe();
      }

      leadsSubscription = supabaseClient
        .channel('leads-changes')
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'leads' },
          (payload) => {
            console.log('New lead received:', payload.new);
            // Add to beginning of array
            allLeads.unshift(payload.new);
            updateStats();
            renderLeads();
            // Show notification
            showNewLeadNotification(payload.new);
          }
        )
        .on('postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'leads' },
          (payload) => {
            const idx = allLeads.findIndex(l => l.id === payload.new.id);
            if (idx !== -1) {
              allLeads[idx] = payload.new;
              updateStats();
              renderLeads();
            }
          }
        )
        .subscribe();
    }

    function showNewLeadNotification(lead) {
      // Create floating notification
      const notification = document.createElement('div');
      notification.className = 'new-lead-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid var(--gold-primary);
        border-radius: 12px;
        padding: 16px 20px;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        animation: slideIn 0.3s ease;
        cursor: pointer;
        max-width: 350px;
      `;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; background: var(--gold-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="#1a1a2e" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
          </div>
          <div>
            <div style="font-weight: 700; color: var(--gold-primary); font-size: 12px; text-transform: uppercase;">New Lead!</div>
            <div style="font-weight: 600; color: #fff;">${lead.full_name || 'Unknown'}</div>
            <div style="font-size: 13px; color: var(--text-muted);">${lead.project_type || 'General Inquiry'} - ${lead.form_name || 'Website'}</div>
          </div>
        </div>
      `;

      notification.onclick = () => {
        notification.remove();
        showPage('leads');
        setTimeout(() => viewLead(lead.id), 100);
      };

      document.body.appendChild(notification);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, 10000);

      // Play notification sound if available
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleGw+AGql1O3NpFg+H1qfzunXuWBOQFaVx+PiyHxqV06Ow9fex4ZeUU2EudLYu4FbTEJ3q8jMsHhSTjtvob/CpWtMSWijt764hW9VWmqjwM26i3taYnamu8jIl4RramKYtcPJoJCHf3pijaS0t6OXkYqAdXWInaCmo5qTi4J4');
        audio.volume = 0.3;
        audio.play().catch(() => {});
      } catch (e) {}
    }

    let isLoadingLeads = false;
    async function loadLeads() {
      if (isLoadingLeads) return;
      isLoadingLeads = true;
      console.log('[Leads] loadLeads called');
      try {
        const { data, error } = await supabaseClient
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allLeads = data || [];
        console.log('[Leads] Loaded', allLeads.length, 'leads');
        updateStats();
        renderLeads();
      } catch (err) {
        console.error('[Leads] Error loading leads:', err);
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <h3>Error loading leads</h3>
            <p>${escapeHtml(err.message || 'Unknown error')}</p>
          </div>
        `;
      } finally {
        isLoadingLeads = false;
      }
    }

    function updateStats() {
      // Exclude archived leads from main stats
      const activeLeads = allLeads.filter(l => l.status !== 'archived');
      const archivedCount = allLeads.filter(l => l.status === 'archived').length;

      const stats = {
        total: activeLeads.length,
        new: activeLeads.filter(l => l.status === 'new').length,
        contacted: activeLeads.filter(l => l.status === 'contacted').length,
        won: activeLeads.filter(l => l.status === 'won').length,
        archived: archivedCount
      };

      console.log('[Stats] updateStats called, stats:', stats);

      // Update stat elements if they exist (with null checks)
      const statTotal = document.getElementById('stat-total');
      const statNew = document.getElementById('stat-new');
      const statContacted = document.getElementById('stat-contacted');
      const statWon = document.getElementById('stat-won');

      console.log('[Stats] Elements found:', { statTotal: !!statTotal, statNew: !!statNew });

      if (statTotal) statTotal.textContent = stats.total;
      if (statNew) statNew.textContent = stats.new;
      if (statContacted) statContacted.textContent = stats.contacted;
      if (statWon) statWon.textContent = stats.won;

      const leadsCountEl = document.getElementById('leads-count');
      if (leadsCountEl) {
        leadsCountEl.textContent = stats.new;
        leadsCountEl.setAttribute('data-count', stats.new);
        leadsCountEl.style.display = stats.new > 0 ? '' : 'none';
      }
    }

    // Set leads view mode
    function setLeadsView(view) {
      currentLeadsView = view;
      // Update button styles
      ['grid', 'list', 'kanban'].forEach(v => {
        const btn = document.getElementById(`leads-view-${v}`);
        if (btn) {
          if (v === view) {
            btn.style.background = 'var(--gold-primary)';
            btn.style.color = 'var(--dark-primary)';
          } else {
            btn.style.background = 'transparent';
            btn.style.color = 'var(--text-secondary)';
          }
        }
      });
      renderLeads();
    }

    function renderLeads() {
      const searchTerm = document.getElementById('leads-search')?.value.toLowerCase() || '';

      let filtered = allLeads;

      // Filter out archived leads unless showArchivedLeads is true or filtering by archived
      if (!showArchivedLeads && currentFilter !== 'archived') {
        filtered = filtered.filter(l => l.status !== 'archived');
      }

      if (currentFilter !== 'all') {
        filtered = filtered.filter(l => l.status === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(l =>
          (l.full_name || l.homeowner_name || l.name || '').toLowerCase().includes(searchTerm) ||
          (l.email || l.homeowner_email || '').toLowerCase().includes(searchTerm) ||
          (l.phone || l.homeowner_phone || '').toLowerCase().includes(searchTerm)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <h3>No leads found</h3>
            <p>${currentFilter !== 'all' ? 'No leads with this status.' : 'Leads from your website forms will appear here.'}</p>
          </div>
        `;
        return;
      }

      // Render based on current view
      if (currentLeadsView === 'list') {
        renderLeadsListView(filtered);
      } else if (currentLeadsView === 'kanban') {
        renderLeadsKanbanView(filtered);
      } else {
        renderLeadsGridView(filtered);
      }
    }

    function renderLeadsGridView(filtered) {
      const statusIcons = {
        new: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
        contacted: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>',
        qualified: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        quoted: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        won: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>',
        lost: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>'
      };

      document.getElementById('leads-table').innerHTML = `
        <div class="leads-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px;">
          ${filtered.map(lead => {
            const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';
            const leadEmail = lead.email || lead.homeowner_email || '';
            const leadPhone = lead.phone || lead.homeowner_phone || '';
            const hasAppointment = lead.appointment_date && lead.appointment_time;
            const statusColor = getStatusColor(lead.status);
            return `
            <div class="lead-card" onclick="viewLead('${lead.id}')"
                 style="background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;"
                 onmouseover="this.style.borderColor='${statusColor}'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.3)'"
                 onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.boxShadow='none'">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: ${statusColor};"></div>
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-size: 17px; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(leadName)}</div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${formatDate(lead.created_at)} ${lead.source ? ' ' + escapeHtml(lead.source) : ''}</div>
                </div>
                <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; background: ${statusColor}25; color: ${statusColor}; text-transform: uppercase; letter-spacing: 0.5px;">
                  ${statusIcons[lead.status] || ''} ${lead.status}
                </span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px;">
                ${leadPhone ? `<div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="opacity: 0.7;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg><span>${escapeHtml(leadPhone)}</span></div>` : ''}
                ${leadEmail ? `<div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="opacity: 0.7;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(leadEmail)}</span></div>` : ''}
              </div>
              ${lead.project_type ? `<div style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 6px 10px; background: var(--dark-surface); border-radius: 6px; color: var(--text-secondary); margin-bottom: 14px;"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>${escapeHtml(lead.project_type)}</div>` : ''}
              ${hasAppointment ? `<div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 12px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;"><svg width="16" height="16" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><span style="font-size: 12px; font-weight: 600; color: #10b981; text-transform: uppercase;">Scheduled</span></div><div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${lead.appointment_date}</div><div style="font-size: 13px; color: var(--text-secondary);">at ${lead.appointment_time}</div></div>` : `<button onclick="event.stopPropagation(); openScheduleLeadModal('${lead.id}')" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%); border: none; border-radius: 8px; color: var(--dark-primary); font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 12px;"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Schedule Appointment</button>`}
              <div class="lead-quick-actions">
                ${leadPhone ? `<button onclick="event.stopPropagation(); window.location.href='tel:${encodeURIComponent(leadPhone)}'" class="btn-action call" title="Call"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>Call</button>` : ''}
                ${leadEmail ? `<button onclick="event.stopPropagation(); openLeadEmailModal('${lead.id}')" class="btn-action email" title="Email"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>Email</button>` : ''}
                <button onclick="event.stopPropagation(); quickChangeLeadStatus('${lead.id}', '${lead.status}')" class="btn-action status" title="Change Status"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>Status</button>
                <button onclick="event.stopPropagation(); convertLeadToProject('${lead.id}')" class="btn-action project" title="Convert to Project"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>Project</button>
                <button onclick="event.stopPropagation(); quickArchiveLead('${lead.id}')" class="btn-action archive" title="${lead.status === 'archived' ? 'Restore' : 'Archive'}"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/></svg>${lead.status === 'archived' ? 'Restore' : 'Archive'}</button>
                <button onclick="event.stopPropagation(); quickDeleteLead('${lead.id}')" class="btn-action delete" title="Delete"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Delete</button>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function renderLeadsListView(filtered) {
      document.getElementById('leads-table').innerHTML = `
        <div class="leads-list" style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 120px; gap: 16px; padding: 12px 16px; background: var(--dark-surface); border-radius: 8px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
            <span>Name</span>
            <span>Contact</span>
            <span>Project</span>
            <span>Status</span>
            <span>Actions</span>
          </div>
          ${filtered.map(lead => {
            const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';
            const leadEmail = lead.email || lead.homeowner_email || '';
            const leadPhone = lead.phone || lead.homeowner_phone || '';
            const statusColor = getStatusColor(lead.status);
            return `
            <div class="lead-list-row" onclick="viewLead('${lead.id}')"
                 style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 120px; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 10px; cursor: pointer; align-items: center; transition: all 0.2s;"
                 onmouseover="this.style.borderColor='${statusColor}'; this.style.background='var(--dark-surface)'"
                 onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--dark-elevated)'">
              <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">${escapeHtml(leadName)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${formatDate(lead.created_at)} ${lead.source ? ' ' + escapeHtml(lead.source) : ''}</div>
              </div>
              <div style="font-size: 13px;">
                ${leadPhone ? `<div style="color: var(--text-secondary); margin-bottom: 2px;">${escapeHtml(leadPhone)}</div>` : ''}
                ${leadEmail ? `<div style="color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(leadEmail)}</div>` : ''}
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">${lead.project_type ? escapeHtml(lead.project_type) : '-'}</div>
              <div>
                <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; background: ${statusColor}25; color: ${statusColor}; text-transform: uppercase;">${lead.status}</span>
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;" onclick="event.stopPropagation()">
                ${leadPhone ? `<button onclick="window.location.href='tel:${encodeURIComponent(leadPhone)}'" style="padding: 6px 10px; background: rgba(34, 197, 94, 0.15); border: none; border-radius: 6px; color: #22c55e; cursor: pointer; font-size: 12px;">Call</button>` : ''}
                ${leadEmail ? `<button onclick="openLeadEmailModal('${lead.id}')" style="padding: 6px 10px; background: rgba(59, 130, 246, 0.15); border: none; border-radius: 6px; color: #3b82f6; cursor: pointer; font-size: 12px;">Email</button>` : ''}
                <button onclick="quickArchiveLead('${lead.id}')" style="padding: 6px 10px; background: rgba(107, 114, 128, 0.15); border: none; border-radius: 6px; color: #9ca3af; cursor: pointer; font-size: 12px;" title="${lead.status === 'archived' ? 'Restore' : 'Archive'}">${lead.status === 'archived' ? '' : ''}</button>
                <button onclick="quickDeleteLead('${lead.id}')" style="padding: 6px 10px; background: rgba(239, 68, 68, 0.15); border: none; border-radius: 6px; color: #ef4444; cursor: pointer; font-size: 12px;" title="Delete"></button>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function renderLeadsKanbanView(filtered) {
      const statuses = ['new', 'contacted', 'qualified', 'quoted', 'won', 'lost'];
      const statusLabels = { new: 'New', contacted: 'Contacted', qualified: 'Qualified', quoted: 'Quoted', won: 'Won', lost: 'Lost', archived: 'Archived' };
      const grouped = {};
      statuses.forEach(s => grouped[s] = []);
      filtered.forEach(lead => {
        if (grouped[lead.status]) grouped[lead.status].push(lead);
        else grouped['new'].push(lead);
      });

      document.getElementById('leads-table').innerHTML = `
        <div class="leads-kanban" style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 500px;">
          ${statuses.map(status => {
            const statusColor = getStatusColor(status);
            const leads = grouped[status];
            return `
            <div class="kanban-column" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px; display: flex; flex-direction: column;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${statusColor};">
                <span style="font-weight: 600; color: ${statusColor};">${statusLabels[status]}</span>
                <span style="background: ${statusColor}25; color: ${statusColor}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${leads.length}</span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 12px; flex: 1; overflow-y: auto;">
                ${leads.length === 0 ? `<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">No leads</div>` : leads.map(lead => {
                  const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';
                  const leadEmail = lead.email || lead.homeowner_email || '';
                  const leadPhone = lead.phone || lead.homeowner_phone || '';
                  return `
                  <div onclick="viewLead('${lead.id}')" style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='${statusColor}'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 14px;">${escapeHtml(leadName)}</div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${formatDate(lead.created_at)}</div>
                    ${lead.project_type ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${escapeHtml(lead.project_type)}</div>` : ''}
                    <div style="display: flex; gap: 6px; margin-top: 10px;" onclick="event.stopPropagation()">
                      ${leadPhone ? `<button onclick="window.location.href='tel:${encodeURIComponent(leadPhone)}'" style="flex: 1; padding: 6px; background: rgba(34, 197, 94, 0.15); border: none; border-radius: 6px; color: #22c55e; cursor: pointer; font-size: 11px;">Call</button>` : ''}
                      ${leadEmail ? `<button onclick="openLeadEmailModal('${lead.id}')" style="flex: 1; padding: 6px; background: rgba(59, 130, 246, 0.15); border: none; border-radius: 6px; color: #3b82f6; cursor: pointer; font-size: 11px;">Email</button>` : ''}
                      <button onclick="quickArchiveLead('${lead.id}')" style="padding: 6px 8px; background: rgba(107, 114, 128, 0.15); border: none; border-radius: 6px; color: #9ca3af; cursor: pointer; font-size: 11px;" title="Archive"></button>
                      <button onclick="quickDeleteLead('${lead.id}')" style="padding: 6px 8px; background: rgba(239, 68, 68, 0.15); border: none; border-radius: 6px; color: #ef4444; cursor: pointer; font-size: 11px;" title="Delete"></button>
                    </div>
                  </div>
                `}).join('')}
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    // Helper: Get color for status
    function getStatusColor(status) {
      const colors = {
        // Lead statuses
        new: '#f9cb00',
        contacted: '#3b82f6',
        qualified: '#8b5cf6',
        quoted: '#06b6d4',
        won: '#22c55e',
        lost: '#ef4444',
        archived: '#6b7280',
        // Project statuses
        lead: '#f59e0b',
        approved: '#22c55e',
        scheduled: '#8b5cf6',
        in_progress: '#06b6d4',
        completed: '#22c55e',
        on_hold: '#ef4444',
        cancelled: '#6b7280',
        // Invoice/Estimate statuses
        draft: '#6b7280',
        sent: '#3b82f6',
        paid: '#22c55e',
        overdue: '#ef4444',
        rejected: '#ef4444',
        void: '#6b7280',
        // En route statuses
        en_route: '#f59e0b',
        arrived: '#22c55e',
        on_site: '#22c55e'
      };
      return colors[status] || '#6b7280';
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) return 'Just now';
        return `${hours}h ago`;
      } else if (days === 1) return 'Yesterday';
      else if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function openLeadModal(id) { viewLead(id); }

    // Open professional email modal for leads
    function openLeadEmailModal(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Customer';
      const leadEmail = lead.email || lead.homeowner_email || '';
      const firstName = leadName.split(' ')[0];

      if (!leadEmail) {
        showToast('No email address for this lead', 'error');
        return;
      }

      // Professional email templates
      const templates = [
        {
          name: 'Initial Follow-up',
          subject: `Thank you for your interest - ${lead.project_type || 'Your Project'}`,
          body: `Hi ${firstName},\n\nThank you for reaching out to Surprise Granite! I wanted to personally follow up on your inquiry about ${lead.project_type || 'your project'}.\n\nWe specialize in beautiful, high-quality countertops and would love to help bring your vision to life. Would you be available for a quick call or an in-home consultation?\n\nPlease let me know what times work best for you, or feel free to call us directly.\n\nBest regards,\nThe Surprise Granite Team`
        },
        {
          name: 'Schedule Appointment',
          subject: 'Let\'s Schedule Your Free Consultation',
          body: `Hi ${firstName},\n\nI hope this message finds you well! I wanted to reach out about scheduling your free in-home consultation for ${lead.project_type || 'your countertop project'}.\n\nDuring the consultation, we'll:\n- Take precise measurements\n- Show you material samples\n- Provide a detailed quote\n\nThe entire process takes about 30-45 minutes. What day and time works best for you?\n\nLooking forward to meeting you!\n\nBest regards,\nThe Surprise Granite Team`
        },
        {
          name: 'Quote Follow-up',
          subject: 'Following Up on Your Quote',
          body: `Hi ${firstName},\n\nI wanted to follow up on the quote we provided for your ${lead.project_type || 'countertop project'}.\n\nDo you have any questions about the materials, pricing, or installation process? I'm happy to go over everything with you.\n\nIf you're ready to move forward, just let me know and we can get you scheduled!\n\nBest regards,\nThe Surprise Granite Team`
        },
        {
          name: 'Custom Message',
          subject: '',
          body: `Hi ${firstName},\n\n\n\nBest regards,\nThe Surprise Granite Team`
        }
      ];

      // Create modal
      const existing = document.getElementById('lead-email-modal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'lead-email-modal';
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="modal compose-modal" style="max-width: 600px;">
          <div class="modal-header">
            <h2>Send Email to ${escapeHtml(leadName)}</h2>
            <button class="modal-close" onclick="document.getElementById('lead-email-modal').remove()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" style="padding: 20px;">
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">To</label>
              <div style="padding: 12px 16px; background: var(--dark-surface); border-radius: 8px; color: var(--text-primary);">${escapeHtml(leadEmail)}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Template</label>
              <select id="lead-email-template" onchange="applyLeadEmailTemplate()" style="width: 100%; padding: 12px 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                ${templates.map((t, i) => `<option value="${i}">${t.name}</option>`).join('')}
              </select>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Subject</label>
              <input type="text" id="lead-email-subject" value="${escapeHtml(templates[0].subject)}" style="width: 100%; padding: 12px 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Message</label>
              <textarea id="lead-email-body" rows="10" style="width: 100%; padding: 12px 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; line-height: 1.5;">${escapeHtml(templates[0].body)}</textarea>
            </div>
          </div>
          <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-subtle);">
            <button onclick="document.getElementById('lead-email-modal').remove()" class="btn-modern secondary">Cancel</button>
            <button onclick="sendLeadEmail('${leadId}')" class="btn-modern primary" id="send-lead-email-btn">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              Send Email
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Store templates for template switching
      window.leadEmailTemplates = templates;
    }

    function applyLeadEmailTemplate() {
      const select = document.getElementById('lead-email-template');
      const idx = parseInt(select.value);
      const template = window.leadEmailTemplates[idx];
      if (template) {
        document.getElementById('lead-email-subject').value = template.subject;
        document.getElementById('lead-email-body').value = template.body;
      }
    }

    async function sendLeadEmail(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const leadEmail = lead.email || lead.homeowner_email || '';
      const subject = document.getElementById('lead-email-subject').value;
      const body = document.getElementById('lead-email-body').value;

      if (!subject.trim() || !body.trim()) {
        showToast('Please enter subject and message', 'error');
        return;
      }

      const btn = document.getElementById('send-lead-email-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Sending...';

      try {
        const response = await fetch('/api/email/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: leadEmail,
            subject: subject,
            body: body,
            lead_id: leadId
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('Email sent successfully!', 'success');
          document.getElementById('lead-email-modal').remove();

          // Update lead status to contacted if it was new
          if (lead.status === 'new') {
            await supabaseClient
              .from('leads')
              .update({ status: 'contacted', updated_at: new Date().toISOString() })
              .eq('id', leadId);
            loadLeads();
          }
        } else {
          throw new Error(result.error || 'Failed to send email');
        }
      } catch (err) {
        console.error('Email send error:', err);
        showToast('Failed to send email: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Send Email';
      }
    }

    // Quick Actions for Lead Cards
    function quickChangeLeadStatus(leadId, currentStatus) {
      const statuses = ['new', 'contacted', 'qualified', 'quoted', 'won', 'lost'];
      const statusLabels = { new: 'New', contacted: 'Contacted', qualified: 'Qualified', quoted: 'Quoted', won: 'Won', lost: 'Lost', archived: 'Archived' };

      // Create dropdown modal
      const modal = document.createElement('div');
      modal.id = 'quick-status-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; min-width: 240px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin: 0 0 16px; font-size: 14px; color: var(--text-primary);">Change Lead Status</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${statuses.map(s => `
              <button onclick="setLeadStatusQuick('${leadId}', '${s}')"
                      style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: ${s === currentStatus ? 'var(--gold-primary)20' : 'var(--dark-elevated)'}; border: 1px solid ${s === currentStatus ? 'var(--gold-primary)' : 'var(--border-subtle)'}; border-radius: 8px; cursor: pointer; transition: all 0.15s; color: ${s === currentStatus ? 'var(--gold-primary)' : 'var(--text-secondary)'};"
                      onmouseover="this.style.borderColor='var(--gold-primary)'"
                      onmouseout="this.style.borderColor='${s === currentStatus ? 'var(--gold-primary)' : 'var(--border-subtle)'}'"
              >
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${getStatusColor(s)};"></span>
                <span style="font-weight: 500;">${statusLabels[s]}</span>
                ${s === currentStatus ? '<span style="margin-left: auto; font-size: 11px;">Current</span>' : ''}
              </button>
            `).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function setLeadStatusQuick(leadId, newStatus) {
      document.getElementById('quick-status-modal')?.remove();

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', leadId);

        if (error) throw error;

        // Update local data
        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.status = newStatus;

        renderLeads();
        showToast(`Lead status changed to ${newStatus}`, 'success');
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    async function convertLeadToProject(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';

      if (!confirm(`Convert "${leadName}" to a project?`)) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Create project from lead data
        const projectData = {
          user_id: user.id,
          name: `${leadName} - ${lead.project_type || 'Project'}`,
          customer_name: leadName,
          customer_email: lead.email || lead.homeowner_email || null,
          customer_phone: lead.phone || lead.homeowner_phone || null,
          address: lead.project_address || lead.address || null,
          description: lead.message || lead.project_details || null,
          status: 'lead',
          priority: 'medium',
          lead_id: leadId
        };

        const { data: project, error } = await supabaseClient
          .from('projects')
          .insert(projectData)
          .select()
          .single();

        if (error) throw error;

        // Update lead status to won
        await supabaseClient
          .from('leads')
          .update({ status: 'won', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        // Update local lead
        if (lead) lead.status = 'won';

        showToast('Project created successfully!', 'success');
        renderLeads();

        // Optionally navigate to projects page
        if (confirm('View the new project?')) {
          showPage('projects');
          await loadProjects();
          setTimeout(() => openProjectDetail(project.id), 500);
        }

      } catch (err) {
        console.error('Error converting lead:', err);
        showToast('Failed to convert lead: ' + err.message, 'error');
      }
    }

    async function viewLead(id) {
      try {
      selectedLead = allLeads.find(function(l) { return l.id === id; });
      if (!selectedLead) return;

      // Open the new profile panel instead of old modal
      openProfilePanel(selectedLead, 'lead');
      return; // Skip old modal code

      var container = document.getElementById('lead-details');
      if (!container) { alert('Container not found'); return; }
      container.innerHTML = '';

      // Get values safely
      var name = String(selectedLead.full_name || selectedLead.homeowner_name || selectedLead.name || 'Unknown');
      var email = String(selectedLead.email || selectedLead.homeowner_email || '');
      var phone = String(selectedLead.phone || selectedLead.homeowner_phone || '');
      var address = String(selectedLead.project_address || selectedLead.address || '');
      var zip = String(selectedLead.project_zip || '');
      var project = String(selectedLead.project_type || 'Not specified');
      var msg = String(selectedLead.message || selectedLead.project_details || '');
      var source = String(selectedLead.source || 'Website');
      var apptDate = selectedLead.appointment_date || '';
      var apptTime = selectedLead.appointment_time || '';

      // Appointment banner with actions
      if (apptDate && apptTime) {
        var apptStatus = selectedLead.appointment_status || 'scheduled';
        var statusColors = {scheduled:'#f59e0b',confirmed:'#10b981',completed:'#6366f1',cancelled:'#ef4444'};
        var statusColor = statusColors[apptStatus] || '#f59e0b';

        var apptDiv = document.createElement('div');
        apptDiv.style.cssText = 'background:rgba(245,158,11,0.15);border:2px solid '+statusColor+';border-radius:12px;padding:16px;margin-bottom:16px;';

        var apptHeader = document.createElement('div');
        apptHeader.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
        var apptTitle = document.createElement('div');
        apptTitle.style.cssText = 'color:'+statusColor+';font-weight:bold;font-size:14px;';
        apptTitle.textContent = 'APPOINTMENT ' + apptStatus.toUpperCase();
        var statusBadge = document.createElement('span');
        statusBadge.style.cssText = 'background:'+statusColor+';color:#fff;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;';
        statusBadge.textContent = apptStatus;
        apptHeader.appendChild(apptTitle);
        apptHeader.appendChild(statusBadge);
        apptDiv.appendChild(apptHeader);

        var apptDateTime = document.createElement('div');
        apptDateTime.style.cssText = 'font-size:18px;font-weight:bold;margin-top:8px;';
        apptDateTime.textContent = apptDate + ' at ' + apptTime;
        apptDiv.appendChild(apptDateTime);

        if (address) {
          var apptLoc = document.createElement('div');
          apptLoc.style.cssText = 'margin-top:4px;color:#999;';
          apptLoc.textContent = ' ' + address;
          apptDiv.appendChild(apptLoc);
        }

        // Action buttons
        var btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display:flex;gap:8px;margin-top:12px;';

        if (apptStatus === 'scheduled') {
          var confirmBtn = document.createElement('button');
          confirmBtn.style.cssText = 'flex:1;padding:10px;border:none;border-radius:8px;background:#10b981;color:#fff;font-weight:600;cursor:pointer;';
          confirmBtn.textContent = ' Confirm & Create Event';
          confirmBtn.onclick = function() { confirmAppointment(selectedLead.id); };
          btnContainer.appendChild(confirmBtn);
        }

        var rescheduleBtn = document.createElement('button');
        rescheduleBtn.style.cssText = 'flex:1;padding:10px;border:none;border-radius:8px;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;';
        rescheduleBtn.textContent = ' Reschedule';
        rescheduleBtn.onclick = function() { openRescheduleModal(selectedLead.id); };
        btnContainer.appendChild(rescheduleBtn);

        if (apptStatus !== 'cancelled') {
          var cancelBtn = document.createElement('button');
          cancelBtn.style.cssText = 'padding:10px 16px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-weight:600;cursor:pointer;';
          cancelBtn.textContent = '';
          cancelBtn.title = 'Cancel Appointment';
          cancelBtn.onclick = function() { cancelAppointment(selectedLead.id); };
          btnContainer.appendChild(cancelBtn);
        }

        apptDiv.appendChild(btnContainer);
        container.appendChild(apptDiv);
      }

      // Check if message contains appointment info - auto-create pending event
      if (!apptDate && msg && (msg.includes('APPOINTMENT') || msg.includes('Date:') || msg.includes('Time:'))) {
        var parsedDate = '', parsedTime = '', parsedAddress = '';

        var dateMatch = msg.match(/Date:\s*([^\n]+)/i);
        if (dateMatch) parsedDate = dateMatch[1].trim();

        var timeMatch = msg.match(/Time:\s*([^\n]+)/i);
        if (timeMatch) parsedTime = timeMatch[1].trim();

        var addrMatch = msg.match(/Address:\s*([^\n]+)/i);
        if (addrMatch) parsedAddress = addrMatch[1].trim();

        if (parsedDate || parsedTime) {
          selectedLead._parsedDate = parsedDate;
          selectedLead._parsedTime = parsedTime;
          selectedLead._parsedAddress = parsedAddress || address;

          // Auto-create calendar event as pending (runs in background)
          autoCreatePendingEvent(selectedLead.id, parsedDate, parsedTime, parsedAddress || address, name, email, phone, msg);

          // Show pending appointment banner
          var pendingDiv = document.createElement('div');
          pendingDiv.id = 'pending-appt-banner';
          pendingDiv.style.cssText = 'background:rgba(251,191,36,0.15);border:2px solid #fbbf24;border-radius:12px;padding:16px;margin-bottom:16px;';

          var headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
          headerDiv.innerHTML = '<div style="color:#fbbf24;font-weight:bold;font-size:14px;"> APPOINTMENT REQUEST</div><span style="background:#fbbf24;color:#000;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">PENDING</span>';
          pendingDiv.appendChild(headerDiv);

          var dateDiv = document.createElement('div');
          dateDiv.style.cssText = 'font-size:18px;font-weight:bold;margin-top:8px;';
          dateDiv.textContent = parsedDate || 'Date to be confirmed';
          pendingDiv.appendChild(dateDiv);

          var timeDiv = document.createElement('div');
          timeDiv.style.cssText = 'color:#ccc;margin-top:2px;';
          timeDiv.textContent = parsedTime || 'Time to be confirmed';
          pendingDiv.appendChild(timeDiv);

          if (parsedAddress) {
            var locDiv = document.createElement('div');
            locDiv.style.cssText = 'color:#999;margin-top:4px;';
            locDiv.textContent = ' ' + parsedAddress;
            pendingDiv.appendChild(locDiv);
          }

          var btnDiv = document.createElement('div');
          btnDiv.style.cssText = 'display:flex;gap:8px;margin-top:12px;';
          btnDiv.innerHTML = '<button onclick="confirmParsedAppointment(\'' + selectedLead.id + '\')" style="flex:1;padding:10px;border:none;border-radius:8px;background:#10b981;color:#fff;font-weight:600;cursor:pointer;"> Confirm</button>' +
            '<button onclick="openRescheduleModal(\'' + selectedLead.id + '\')" style="flex:1;padding:10px;border:none;border-radius:8px;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;"> Reschedule</button>' +
            '<button onclick="declineAppointment(\'' + selectedLead.id + '\')" style="padding:10px 16px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-weight:600;cursor:pointer;"></button>';
          pendingDiv.appendChild(btnDiv);

          container.appendChild(pendingDiv);
        }
      }

      // Helper to create rows
      function addRow(label, value, linkHref) {
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;padding:12px 0;border-bottom:1px solid #333;';
        var labelEl = document.createElement('div');
        labelEl.style.cssText = 'width:100px;color:#888;font-size:12px;text-transform:uppercase;flex-shrink:0;';
        labelEl.textContent = label;
        var valueEl = document.createElement('div');
        valueEl.style.cssText = 'flex:1;font-size:14px;word-break:break-word;';
        if (linkHref && value) {
          var a = document.createElement('a');
          a.href = linkHref;
          a.style.cssText = 'color:#f9cb00;text-decoration:none;';
          a.textContent = value;
          if (linkHref.startsWith('http')) a.target = '_blank';
          valueEl.appendChild(a);
        } else {
          valueEl.textContent = value || 'Not provided';
        }
        row.appendChild(labelEl);
        row.appendChild(valueEl);
        container.appendChild(row);
      }

      addRow('Name', name);
      addRow('Email', email, email ? 'mailto:' + email : null);
      addRow('Phone', phone, phone ? 'tel:' + phone : null);
      if (address) addRow('Address', address, 'https://maps.google.com/?q=' + encodeURIComponent(address));
      if (zip) addRow('ZIP', zip);
      addRow('Project', project);

      // Message row
      var msgRow = document.createElement('div');
      msgRow.style.cssText = 'display:flex;padding:12px 0;border-bottom:1px solid #333;align-items:flex-start;';
      var msgLabel = document.createElement('div');
      msgLabel.style.cssText = 'width:100px;color:#888;font-size:12px;text-transform:uppercase;flex-shrink:0;';
      msgLabel.textContent = 'Message';
      var msgValue = document.createElement('div');
      msgValue.style.cssText = 'flex:1;background:#1a1a2e;padding:12px;border-radius:8px;max-height:150px;overflow-y:auto;white-space:pre-wrap;font-size:13px;';
      msgValue.textContent = msg || 'No message';
      msgRow.appendChild(msgLabel);
      msgRow.appendChild(msgValue);
      container.appendChild(msgRow);

      addRow('Source', source);
      addRow('Submitted', selectedLead.created_at ? new Date(selectedLead.created_at).toLocaleString() : 'Unknown');

      // Load linked estimates
      const estimatesContainer = document.getElementById('lead-estimates-list');
      if (estimatesContainer) {
        estimatesContainer.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px;">Loading estimates...</div>';

        const { data: estimates } = await supabaseClient
          .from('estimates')
          .select('id, estimate_number, total, status, created_at')
          .eq('lead_id', selectedLead.id)
          .order('created_at', { ascending: false });

        if (estimates && estimates.length > 0) {
          estimatesContainer.innerHTML = estimates.map(est => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--dark-bg); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; font-size: 14px;">${est.estimate_number || 'Draft'}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${new Date(est.created_at).toLocaleDateString()}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--gold-primary);">$${(est.total || 0).toLocaleString()}</div>
                <span class="status-badge status-${est.status}" style="font-size: 11px;">${est.status}</span>
              </div>
            </div>
          `).join('');
        } else {
          estimatesContainer.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px; text-align: center;">No estimates yet</div>';
        }
      }

      // Load linked calendar events for this lead
      try {
        const { data: calendarEvents, error: calEventsError } = await supabaseClient
          .from('calendar_events')
          .select('id, title, event_type, start_time, end_time, status, location')
          .eq('lead_id', selectedLead.id)
          .order('start_time', { ascending: true });

        if (calEventsError) {
          console.warn('Calendar events query error:', calEventsError.message);
        }

        if (calendarEvents && calendarEvents.length > 0) {
          // Add calendar events section to detailsHtml
          const eventsHtml = calendarEvents.map(evt => {
            const startDate = new Date(evt.start_time);
            const statusColors = {
              'scheduled': '#f59e0b',
              'confirmed': '#10b981',
              'completed': '#6366f1',
              'cancelled': '#ef4444',
              'no_show': '#ef4444'
            };
            return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--dark-bg); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${statusColors[evt.status] || '#f59e0b'};">
                <div>
                  <div style="font-weight: 600; font-size: 13px;">${evt.title || evt.event_type}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                  ${evt.location ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;"> ${evt.location}</div>` : ''}
                </div>
                <span style="background: ${statusColors[evt.status] || '#f59e0b'}; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: capitalize;">${evt.status}</span>
              </div>
            `;
          }).join('');

          // Insert calendar section before Messages section
          const detailsContainer = document.getElementById('lead-details');
          if (detailsContainer) {
            detailsContainer.insertAdjacentHTML('beforeend', `
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                <div class="detail-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#f59e0b" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  <span style="color: #f59e0b;">Calendar Events</span>
                </div>
                ${eventsHtml}
              </div>
            `);
          }
        }
      } catch (calErr) {
        console.warn('Failed to load calendar events for lead:', calErr);
      }

      // Load messages for this lead
      loadLeadMessages(selectedLead.id);

      document.getElementById('lead-status-select').value = selectedLead.status || 'new';
      document.getElementById('lead-modal').classList.add('active');
      } catch(err) {
        console.error('viewLead error:', err);
        showToast('Error loading lead details', 'error');
      }
    }

    // Confirm appointment and create calendar event
    async function confirmAppointment(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead || !lead.appointment_date || !lead.appointment_time) {
        showToast('No appointment to confirm', 'error');
        return;
      }

      try {
        showToast('Creating calendar event...', 'info');

        // Parse date and time
        const dateStr = lead.appointment_date;
        const timeStr = lead.appointment_time;
        const [timePart, ampm] = timeStr.split(' ');
        let [hours, minutes] = timePart.split(':').map(Number);
        if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
        if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
        minutes = minutes || 0;

        const startTime = new Date(dateStr + 'T' + String(hours).padStart(2,'0') + ':' + String(minutes).padStart(2,'0') + ':00');
        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // 1 hour

        const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Customer';
        const leadEmail = lead.email || lead.homeowner_email || '';
        const leadPhone = lead.phone || lead.homeowner_phone || '';
        const leadAddress = lead.project_address || lead.address || '';

        // Create calendar event
        const { data: calEvent, error: calError } = await supabaseClient
          .from('calendar_events')
          .insert([{
            created_by: currentUser.id,
            title: 'Appointment: ' + leadName,
            description: 'Project: ' + (lead.project_type || 'Not specified') + '\nPhone: ' + leadPhone + '\nEmail: ' + leadEmail + '\n\nNotes: ' + (lead.message || lead.project_details || ''),
            event_type: 'appointment',
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: leadAddress,
            location_address: leadAddress,
            lead_id: leadId,
            status: 'confirmed',
            reminder_minutes: [1440, 60],
            color: '#10b981'
          }])
          .select()
          .single();

        if (calError) throw calError;

        // Add customer as participant
        if (calEvent) {
          await supabaseClient.from('calendar_event_participants').insert([{
            event_id: calEvent.id,
            email: leadEmail.toLowerCase(),
            name: leadName,
            phone: leadPhone,
            participant_type: 'attendee',
            response_status: 'accepted'
          }]);
        }

        // Update lead appointment status
        await supabaseClient
          .from('leads')
          .update({ appointment_status: 'confirmed', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        // Update local data
        lead.appointment_status = 'confirmed';

        showToast('Appointment confirmed! Calendar event created.', 'success');
        viewLead(leadId); // Refresh the modal

      } catch (err) {
        console.error('Confirm appointment error:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    // Open reschedule modal
    function openRescheduleModal(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const currentDate = lead.appointment_date || '';
      const currentTime = lead.appointment_time || '';

      const modal = document.createElement('div');
      modal.id = 'reschedule-modal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:20000;';
      modal.innerHTML = `
        <div style="background:#1e1e2e;border-radius:16px;padding:24px;width:90%;max-width:400px;">
          <h3 style="margin:0 0 16px;font-size:18px;">Reschedule Appointment</h3>
          <p style="color:#888;margin-bottom:16px;">Current: ${currentDate} at ${currentTime}</p>
          <div style="margin-bottom:12px;">
            <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">NEW DATE</label>
            <input type="date" id="reschedule-date" value="${currentDate}" style="width:100%;padding:12px;background:#2a2a3e;border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">NEW TIME</label>
            <input type="time" id="reschedule-time" style="width:100%;padding:12px;background:#2a2a3e;border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="document.getElementById('reschedule-modal').remove()" style="flex:1;padding:12px;border:1px solid #444;border-radius:8px;background:transparent;color:#fff;cursor:pointer;">Cancel</button>
            <button onclick="submitReschedule('${leadId}')" style="flex:1;padding:12px;border:none;border-radius:8px;background:#f9cb00;color:#000;font-weight:600;cursor:pointer;">Save & Update Event</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
    }

    // Submit reschedule
    async function submitReschedule(leadId) {
      const newDate = document.getElementById('reschedule-date').value;
      const newTimeInput = document.getElementById('reschedule-time').value;
      if (!newDate || !newTimeInput) {
        showToast('Please select date and time', 'error');
        return;
      }

      // Convert 24h to 12h format for display
      const [h, m] = newTimeInput.split(':');
      const hour = parseInt(h);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      const newTime = hour12 + ':' + m + ' ' + ampm;

      try {
        // Update lead
        await supabaseClient
          .from('leads')
          .update({
            appointment_date: newDate,
            appointment_time: newTime,
            appointment_status: 'scheduled',
            updated_at: new Date().toISOString()
          })
          .eq('id', leadId);

        // Update any existing calendar events for this lead
        const startTime = new Date(newDate + 'T' + newTimeInput + ':00');
        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);

        await supabaseClient
          .from('calendar_events')
          .update({
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            status: 'scheduled'
          })
          .eq('lead_id', leadId);

        // Update local data
        const lead = allLeads.find(l => l.id === leadId);
        if (lead) {
          lead.appointment_date = newDate;
          lead.appointment_time = newTime;
          lead.appointment_status = 'scheduled';
        }

        document.getElementById('reschedule-modal').remove();
        showToast('Appointment rescheduled!', 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Reschedule error:', err);
        showToast('Failed to reschedule: ' + err.message, 'error');
      }
    }

    // Cancel appointment
    async function cancelAppointment(leadId) {
      if (!confirm('Cancel this appointment?')) return;

      try {
        await supabaseClient
          .from('leads')
          .update({ appointment_status: 'cancelled', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        await supabaseClient
          .from('calendar_events')
          .update({ status: 'cancelled' })
          .eq('lead_id', leadId);

        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.appointment_status = 'cancelled';

        showToast('Appointment cancelled', 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Cancel error:', err);
        showToast('Failed to cancel: ' + err.message, 'error');
      }
    }

    // Create event from parsed message data
    async function createEventFromMessage(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const parsedDate = lead._parsedDate || '';
      const parsedTime = lead._parsedTime || '';
      const parsedAddress = lead._parsedAddress || lead.project_address || lead.address || '';

      if (!parsedDate) {
        showToast('Could not parse date from message', 'error');
        return;
      }

      try {
        showToast('Creating calendar event...', 'info');

        // Parse the date string (e.g., "Wednesday, February 4, 2026")
        let startTime;
        try {
          // Try to parse natural date
          const dateStr = parsedDate.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, '');
          startTime = new Date(dateStr);
          if (isNaN(startTime.getTime())) {
            startTime = new Date(parsedDate);
          }
        } catch (e) {
          startTime = new Date(parsedDate);
        }

        // Parse time (e.g., "3:00 PM")
        if (parsedTime) {
          const timeMatch = parsedTime.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
          if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]) || 0;
            const ampm = timeMatch[3];
            if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
            startTime.setHours(hours, minutes, 0, 0);
          }
        }

        if (isNaN(startTime.getTime())) {
          showToast('Could not parse date/time. Please schedule manually.', 'error');
          return;
        }

        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
        const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Customer';
        const leadEmail = lead.email || lead.homeowner_email || '';
        const leadPhone = lead.phone || lead.homeowner_phone || '';

        // Create calendar event
        const { data: calEvent, error: calError } = await supabaseClient
          .from('calendar_events')
          .insert([{
            created_by: currentUser.id,
            title: 'Appointment: ' + leadName,
            description: 'Project: ' + (lead.project_type || 'Countertops') + '\nPhone: ' + leadPhone + '\nEmail: ' + leadEmail + '\n\n' + (lead.message || lead.project_details || ''),
            event_type: 'appointment',
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: parsedAddress,
            location_address: parsedAddress,
            lead_id: leadId,
            status: 'confirmed',
            reminder_minutes: [1440, 60],
            color: '#10b981'
          }])
          .select()
          .single();

        if (calError) throw calError;

        // Add customer as participant
        if (calEvent && leadEmail) {
          await supabaseClient.from('calendar_event_participants').insert([{
            event_id: calEvent.id,
            email: leadEmail.toLowerCase(),
            name: leadName,
            phone: leadPhone,
            participant_type: 'attendee',
            response_status: 'accepted'
          }]);
        }

        // Update lead with parsed appointment data
        const isoDate = startTime.toISOString().split('T')[0];
        const hours12 = startTime.getHours() % 12 || 12;
        const ampm = startTime.getHours() >= 12 ? 'PM' : 'AM';
        const formattedTime = hours12 + ':' + String(startTime.getMinutes()).padStart(2, '0') + ' ' + ampm;

        await supabaseClient
          .from('leads')
          .update({
            appointment_date: isoDate,
            appointment_time: formattedTime,
            appointment_status: 'confirmed',
            project_address: parsedAddress || lead.project_address,
            updated_at: new Date().toISOString()
          })
          .eq('id', leadId);

        // Update local data
        lead.appointment_date = isoDate;
        lead.appointment_time = formattedTime;
        lead.appointment_status = 'confirmed';
        if (parsedAddress) lead.project_address = parsedAddress;

        showToast('Calendar event created for ' + startTime.toLocaleDateString() + ' at ' + formattedTime, 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Create event error:', err);
        showToast('Failed to create event: ' + err.message, 'error');
      }
    }

    // Auto-create pending calendar event in background
    async function autoCreatePendingEvent(leadId, parsedDate, parsedTime, address, name, email, phone, message) {
      try {
        console.log('[AutoCreate] Starting for lead:', leadId, 'date:', parsedDate, 'time:', parsedTime);

        // Must have currentUser
        if (!currentUser || !currentUser.id) {
          console.warn('[AutoCreate] No currentUser, cannot create event');
          return;
        }

        // Check if event already exists for this lead
        const { data: existing, error: checkError } = await supabaseClient
          .from('calendar_events')
          .select('id')
          .eq('lead_id', leadId)
          .limit(1);

        if (checkError) {
          console.warn('[AutoCreate] Check existing error:', checkError.message);
        }

        if (existing && existing.length > 0) {
          console.log('[AutoCreate] Event already exists for lead', leadId);
          return;
        }

        // Parse date - try multiple formats
        let startTime = null;
        const dateFormats = [
          parsedDate,
          parsedDate.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, ''),
          parsedDate.replace(/(\d+)(st|nd|rd|th)/gi, '$1') // Remove ordinals
        ];

        for (const fmt of dateFormats) {
          const d = new Date(fmt);
          if (!isNaN(d.getTime())) {
            startTime = d;
            break;
          }
        }

        if (!startTime) {
          console.warn('[AutoCreate] Could not parse date:', parsedDate);
          return;
        }

        // Parse time
        if (parsedTime) {
          const timeMatch = parsedTime.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
          if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]) || 0;
            const ampm = timeMatch[3];
            if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
            startTime.setHours(hours, minutes, 0, 0);
            console.log('[AutoCreate] Parsed time:', hours + ':' + minutes);
          }
        } else {
          // Default to 9 AM if no time specified
          startTime.setHours(9, 0, 0, 0);
        }

        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
        console.log('[AutoCreate] Creating event:', startTime.toISOString(), 'to', endTime.toISOString());

        // Create scheduled event
        const { data: newEvent, error } = await supabaseClient
          .from('calendar_events')
          .insert([{
            created_by: currentUser.id,
            title: 'Appointment: ' + name,
            description: 'Phone: ' + (phone || 'N/A') + '\nEmail: ' + (email || 'N/A') + '\n\n' + (message || ''),
            event_type: 'appointment',
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: address || null,
            location_address: address || null,
            lead_id: leadId,
            status: 'scheduled',
            color: '#fbbf24'
          }])
          .select()
          .single();

        if (error) {
          console.error('[AutoCreate] Insert error:', error.message, error.details, error.hint);
        } else {
          console.log('[AutoCreate] SUCCESS - Event created:', newEvent?.id);
          // Refresh calendar events
          if (typeof loadAllCalendarEvents === 'function') {
            loadAllCalendarEvents();
          }
        }

      } catch (err) {
        console.error('[AutoCreate] Exception:', err);
      }
    }

    // Confirm parsed appointment
    async function confirmParsedAppointment(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      try {
        showToast('Confirming appointment...', 'info');

        // Update calendar event status
        await supabaseClient
          .from('calendar_events')
          .update({ status: 'confirmed', color: '#10b981' })
          .eq('lead_id', leadId);

        // Update lead
        const parsedDate = lead._parsedDate || '';
        const parsedTime = lead._parsedTime || '';
        const parsedAddr = lead._parsedAddress || '';

        // Try to format date for storage
        let isoDate = '';
        try {
          const dateStr = parsedDate.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, '');
          const d = new Date(dateStr);
          if (!isNaN(d.getTime())) isoDate = d.toISOString().split('T')[0];
        } catch (e) {}

        await supabaseClient
          .from('leads')
          .update({
            appointment_date: isoDate,
            appointment_time: parsedTime,
            appointment_status: 'confirmed',
            project_address: parsedAddr || lead.project_address,
            updated_at: new Date().toISOString()
          })
          .eq('id', leadId);

        lead.appointment_date = isoDate;
        lead.appointment_time = parsedTime;
        lead.appointment_status = 'confirmed';

        // Close modal, reload calendar, show toast
        closeLeadModal();
        showPage('calendar');
        // Force reload calendar events (sequentially to avoid race condition)
        setTimeout(async function() {
          if (typeof loadCalendarEvents === 'function') await loadCalendarEvents();
          if (typeof loadAllCalendarEvents === 'function') await loadAllCalendarEvents();
          console.log('[Calendar] Events reloaded after confirmation, total:', calendarEvents.length);
        }, 100);
        showToast(' Appointment confirmed - ' + (lead._parsedDate || 'Date set'), 'success');

      } catch (err) {
        console.error('Confirm error:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    // Decline appointment
    async function declineAppointment(leadId) {
      if (!confirm('Decline this appointment request?')) return;

      try {
        await supabaseClient
          .from('calendar_events')
          .update({ status: 'cancelled', color: '#ef4444' })
          .eq('lead_id', leadId);

        await supabaseClient
          .from('leads')
          .update({ appointment_status: 'cancelled', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.appointment_status = 'cancelled';

        showToast('Appointment declined', 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Decline error:', err);
        showToast('Failed to decline: ' + err.message, 'error');
      }
    }

    async function loadLeadMessages(leadId) {
      const container = document.getElementById('lead-messages-list');
      const badge = document.getElementById('lead-unread-badge');

      if (!container) return;

      container.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px; text-align: center;">Loading messages...</div>';

      try {
        const { data: messages } = await supabaseClient
          .from('customer_messages')
          .select('*')
          .eq('lead_id', leadId)
          .order('created_at', { ascending: true });

        if (!messages || messages.length === 0) {
          container.innerHTML = '<div style="padding: 16px; color: var(--text-muted); font-size: 13px; text-align: center;">No messages yet. Comments from design shares will appear here.</div>';
          if (badge) badge.style.display = 'none';
          return;
        }

        // Count unread inbound messages
        const unread = messages.filter(m => m.direction === 'inbound' && m.status !== 'read').length;
        if (badge) {
          if (unread > 0) {
            badge.textContent = `${unread} new`;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }

        container.innerHTML = messages.map(msg => {
          const isInbound = msg.direction === 'inbound';
          const channelIcon = msg.channel === 'design_share' ? '' : (msg.channel === 'sms' ? '' : '');
          return `
            <div style="padding: 10px; margin-bottom: 8px; background: var(--dark-${isInbound ? 'bg' : 'elevated'}); border-radius: 8px; border-left: 3px solid ${isInbound ? '#3b82f6' : 'var(--gold-primary)'};">
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="font-size: 11px; color: var(--text-muted);">
                  ${channelIcon} ${isInbound ? (msg.sent_from || 'Customer') : 'You'}
                  ${msg.channel === 'design_share' ? ' Design Comment' : ''}
                </span>
                <span style="font-size: 11px; color: var(--text-muted);">${new Date(msg.created_at).toLocaleString()}</span>
              </div>
              <div style="color: var(--text-primary); font-size: 13px; line-height: 1.4;">${escapeHtml(msg.message || '')}</div>
            </div>
          `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

        // Mark as read
        const unreadIds = messages.filter(m => m.direction === 'inbound' && m.status !== 'read').map(m => m.id);
        if (unreadIds.length > 0) {
          supabaseClient
            .from('customer_messages')
            .update({ status: 'read', read_at: new Date().toISOString() })
            .in('id', unreadIds)
            .then(() => {
              if (badge) badge.style.display = 'none';
            });
        }
      } catch (err) {
        console.error('Load lead messages error:', err);
        container.innerHTML = '<div style="padding: 16px; color: var(--error); font-size: 13px; text-align: center;">Error loading messages</div>';
      }
    }

    async function sendLeadReply() {
      if (!selectedLead) return;

      const input = document.getElementById('lead-message-input');
      const message = input?.value?.trim();
      if (!message) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const leadEmail = selectedLead.email;
        const leadName = selectedLead.full_name || selectedLead.name || '';
        const channel = leadEmail ? 'email' : 'portal';

        // Save to database
        const { data, error } = await supabaseClient
          .from('customer_messages')
          .insert({
            lead_id: selectedLead.id,
            sender_id: user?.id || null,
            direction: 'outbound',
            channel: channel,
            message: message,
            sent_from: user?.email || 'Surprise Granite',
            sent_to: leadEmail || null,
            status: 'sent',
            created_at: new Date().toISOString()
          });

        if (error) throw error;

        input.value = '';
        loadLeadMessages(selectedLead.id);

        // Send actual email if lead has an email address
        if (leadEmail) {
          try {
            const resp = await apiCall('/api/send-lead-message', {
              method: 'POST',
              body: JSON.stringify({
                to_email: leadEmail,
                to_name: leadName,
                message: message,
                sender_name: user?.user_metadata?.full_name || user?.email || 'Surprise Granite',
                lead_id: selectedLead.id
              })
            });
            const result = await resp.json();
            if (result.success) {
              showToast('Reply sent via email!', 'success');
            } else {
              showToast('Saved but email delivery failed', 'warning');
            }
          } catch (emailErr) {
            console.error('Email delivery error:', emailErr);
            showToast('Saved but email delivery failed', 'warning');
          }
        } else {
          showToast('Reply saved (no email on file for this lead)', 'info');
        }
      } catch (err) {
        console.error('Send reply error:', err);
        showToast('Failed to send reply', 'error');
      }
    }

    function closeLeadModal() {
      document.getElementById('lead-modal').classList.remove('active');
      selectedLead = null;
    }

    function openAddLeadModal() {
      document.getElementById('add-lead-form').reset();
      document.getElementById('add-lead-modal').classList.add('active');

      // Set min date for appointment picker to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('new-lead-appt-date').min = today;

      // Reset service address visibility
      document.getElementById('new-lead-service-address-section').style.display = 'none';
      document.getElementById('new-lead-address-same').checked = true;
    }

    function closeAddLeadModal() {
      document.getElementById('add-lead-modal').classList.remove('active');
      // Reset service address section
      document.getElementById('new-lead-address-same').checked = true;
      document.getElementById('new-lead-service-address-section').style.display = 'none';
      // Reset edit mode and title
      editingLeadId = null;
      const modalTitle = document.querySelector('#add-lead-modal .modal-title');
      if (modalTitle) modalTitle.textContent = 'Add New Lead';
      document.getElementById('add-lead-form').reset();
    }

    function toggleNewLeadServiceAddress() {
      const checkbox = document.getElementById('new-lead-address-same');
      const serviceSection = document.getElementById('new-lead-service-address-section');

      if (checkbox.checked) {
        serviceSection.style.display = 'none';
        // Clear service address fields
        document.getElementById('new-lead-service-street').value = '';
        document.getElementById('new-lead-service-street2').value = '';
        document.getElementById('new-lead-service-city').value = '';
        document.getElementById('new-lead-service-zip').value = '';
      } else {
        serviceSection.style.display = 'block';
        // Animate in
        serviceSection.style.animation = 'fadeSlideIn 0.3s ease';
      }
    }

    async function saveNewLead(event) {
      event.preventDefault();

      const btn = document.getElementById('save-lead-btn');
      const originalBtnHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Saving...';

      try {
        // Get current user for lead ownership
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in to add leads');

        const firstName = document.getElementById('new-lead-first-name').value.trim();
        const lastName = document.getElementById('new-lead-last-name').value.trim();
        const fullName = `${firstName} ${lastName}`.trim();
        const email = document.getElementById('new-lead-email').value.trim();
        const phone = document.getElementById('new-lead-phone').value.trim() || null;
        const projectType = document.getElementById('new-lead-project-type').value || null;

        // Collect billing address
        const billingStreet = document.getElementById('new-lead-billing-street').value.trim();
        const billingAddress = billingStreet ? {
          street: billingStreet,
          street2: document.getElementById('new-lead-billing-street2').value.trim() || null,
          city: document.getElementById('new-lead-billing-city').value.trim() || null,
          state: document.getElementById('new-lead-billing-state').value || null,
          zip: document.getElementById('new-lead-billing-zip').value.trim() || null
        } : null;

        // Check if service address is same as billing
        const addressSame = document.getElementById('new-lead-address-same').checked;

        // Collect service address if different
        let serviceAddress = null;
        if (!addressSame) {
          const serviceStreet = document.getElementById('new-lead-service-street').value.trim();
          if (serviceStreet) {
            serviceAddress = {
              street: serviceStreet,
              street2: document.getElementById('new-lead-service-street2').value.trim() || null,
              city: document.getElementById('new-lead-service-city').value.trim() || null,
              state: document.getElementById('new-lead-service-state').value || null,
              zip: document.getElementById('new-lead-service-zip').value.trim() || null
            };
          }
        }

        // Collect appointment data
        const apptDate = document.getElementById('new-lead-appt-date').value;
        const apptTime = document.getElementById('new-lead-appt-time').value;
        const apptType = document.getElementById('new-lead-appt-type').value;
        const hasAppointment = apptDate && apptTime;

        // Format appointment string for message
        let appointmentInfo = '';
        if (hasAppointment) {
          const apptDateObj = new Date(apptDate + 'T12:00:00');
          const formattedDate = apptDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
          const apptTypeLabels = {
            'estimate': 'Free In-Home Estimate',
            'measure': 'Measurement Visit',
            'showroom': 'Showroom Visit',
            'consultation': 'Design Consultation',
            'installation': 'Installation'
          };
          appointmentInfo = `\n\nSCHEDULED APPOINTMENT:\n${apptTypeLabels[apptType] || apptType}\n${formattedDate} at ${apptTime}`;
        }

        const userMessage = document.getElementById('new-lead-message').value.trim() || '';
        const fullMessage = userMessage + appointmentInfo;

        const leadData = {
          full_name: fullName,
          first_name: firstName,
          last_name: lastName,
          email: email,
          phone: phone,
          project_type: projectType,
          zip_code: document.getElementById('new-lead-zip').value.trim() || null,
          message: fullMessage || null,
          source: document.getElementById('new-lead-source').value,
          status: document.getElementById('new-lead-status').value,
          // Address fields
          billing_address: billingAddress,
          service_address: serviceAddress,
          address_same: addressSame,
          // Appointment data in raw_data
          raw_data: hasAppointment ? {
            appointment: {
              date: apptDate,
              time: apptTime,
              type: apptType
            }
          } : null
        };

        let data, error;

        // Check if we're editing an existing lead
        if (editingLeadId) {
          // Update existing lead - add updated_at timestamp
          leadData.updated_at = new Date().toISOString();

          const { data: updateData, error: updateError } = await supabaseClient
            .from('leads')
            .update(leadData)
            .eq('id', editingLeadId)
            .select()
            .single();
          data = updateData;
          error = updateError;
        } else {
          // Insert new lead - add created_at and form_name
          leadData.created_at = new Date().toISOString();
          leadData.form_name = 'manual-entry';

          const { data: insertData, error: insertError } = await supabaseClient
            .from('leads')
            .insert([leadData])
            .select()
            .single();
          data = insertData;
          error = insertError;
        }

        if (error) throw error;

        // Create portal token for new leads only (not edits)
        let portalUrl = null;
        if (!editingLeadId) {
          try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { data: token, error: tokenError } = await supabaseClient
              .from('portal_tokens')
              .insert([{
                lead_id: data.id,
                owner_id: user.id,
                email: email,
                phone: phone,
                permissions: {
                  view_project: true,
                  view_estimates: true,
                  approve_estimates: true,
                  view_invoices: true,
                  pay_invoices: true,
                  upload_photos: true,
                  send_messages: true,
                  view_appointments: true
                }
              }])
              .select()
              .single();

            if (token && !tokenError) {
              portalUrl = `https://www.surprisegranite.com/portal/?token=${token.token}`;
              console.log('Portal token created:', token.id);
            } else if (tokenError) {
              console.warn('Portal token error:', tokenError.message);
            }
          } catch (tokenErr) {
            console.warn('Portal token creation error:', tokenErr);
          }
        }

        // Send welcome email if checkbox is checked (new leads only)
        const sendEmail = document.getElementById('new-lead-send-email').checked;
        if (sendEmail && email && !editingLeadId) {
          try {
            await sendLeadWelcomeEmail({
              firstName,
              lastName,
              email,
              phone,
              projectType,
              hasAppointment,
              apptDate,
              apptTime,
              apptType,
              portalUrl
            });
          } catch (emailErr) {
            console.warn('Welcome email error (non-blocking):', emailErr);
          }
        }

        // Capture edit state before closing modal (which resets editingLeadId)
        const wasEditing = !!editingLeadId;

        // Update local array and refresh display
        if (wasEditing && data) {
          // Replace existing lead in array
          const index = allLeads.findIndex(l => l.id === editingLeadId);
          if (index !== -1) {
            allLeads[index] = data;
          }
        } else if (data) {
          // Add new lead to beginning
          allLeads.unshift(data);
        }

        updateStats();
        renderLeads();
        closeAddLeadModal();

        let successMsg = wasEditing ? 'Lead updated successfully!' : 'Lead added successfully!';
        if (!wasEditing && sendEmail && email) successMsg += ' Welcome email sent.';
        if (hasAppointment) successMsg += ' Appointment scheduled.';
        showToast(successMsg, 'success');

      } catch (err) {
        console.error('Error saving lead:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
      }
    }

    // Send welcome email to new lead
    async function sendLeadWelcomeEmail(leadInfo) {
      const { firstName, lastName, email, phone, projectType, hasAppointment, apptDate, apptTime, apptType, notes, portalUrl } = leadInfo;

      const projectTypeLabels = {
        'kitchen': 'Kitchen Countertops',
        'bathroom': 'Bathroom Vanity',
        'flooring': 'Flooring',
        'fireplace': 'Fireplace Surround',
        'outdoor': 'Outdoor Kitchen',
        'commercial': 'Commercial Project',
        'other': 'Home Improvement'
      };
      const projectLabel = projectTypeLabels[projectType] || 'Countertop Project';

      const apptTypeLabels = {
        'estimate': 'Free In-Home Estimate',
        'measure': 'Measurement Visit',
        'showroom': 'Showroom Visit',
        'consultation': 'Design Consultation',
        'installation': 'Installation'
      };

      // Format appointment date nicely
      let formattedDate = '';
      if (hasAppointment && apptDate) {
        const apptDateObj = new Date(apptDate + 'T12:00:00');
        formattedDate = apptDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      }

      try {
        // Use local API for development, production API otherwise
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiBase = isLocal ? 'http://localhost:3001' : 'https://surprise-granite-email-api.onrender.com';

        const response = await fetch(`${apiBase}/api/email/lead-welcome`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            first_name: firstName,
            last_name: lastName,
            full_name: `${firstName} ${lastName}`.trim(),
            project_type: projectLabel,
            notes: notes || null,
            has_appointment: hasAppointment,
            appointment_date: hasAppointment ? formattedDate : null,
            appointment_time: hasAppointment ? apptTime : null,
            appointment_type: hasAppointment ? (apptTypeLabels[apptType] || 'Appointment') : null,
            portal_url: portalUrl || null,
            source: 'Manual Entry - Account'
          })
        });

        const result = await response.json();
        if (!response.ok) {
          console.error('Welcome email failed:', result);
          return false;
        }
        console.log('Welcome email sent successfully to:', email);
        return true;
      } catch (error) {
        console.error('Failed to send welcome email:', error);
        return false;
      }
    }

    // Close add lead modal when clicking overlay
    document.getElementById('add-lead-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeAddLeadModal();
    });

    async function updateLeadStatus() {
      if (!selectedLead) return;

      const newStatus = document.getElementById('lead-status-select').value;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = newStatus;

        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Status updated', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteLead() {
      if (!selectedLead) return;

      const confirmed = confirm(`Are you sure you want to permanently delete this lead?\n\n${selectedLead.full_name || 'Unknown'}\n${selectedLead.email || ''}\n\nThis action cannot be undone.`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', selectedLead.id);

        if (error) throw error;

        // Remove from local array
        allLeads = allLeads.filter(l => l.id !== selectedLead.id);
        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Lead deleted', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function archiveLead() {
      if (!selectedLead) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        // Update local array
        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = 'archived';

        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Lead archived', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickDeleteLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const confirmed = confirm(`Delete this lead?\n\n${lead.full_name || 'Unknown'}\n${lead.email || ''}`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', leadId);

        if (error) throw error;

        allLeads = allLeads.filter(l => l.id !== leadId);
        updateStats();
        renderLeads();
        showToast('Lead deleted', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickArchiveLead(leadId) {
      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === leadId);
        if (idx !== -1) allLeads[idx].status = 'archived';

        updateStats();
        renderLeads();
        showToast('Lead archived', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function convertLeadToCustomer() {
      if (!selectedLead) {
        showToast('No lead selected', 'error');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Check if customer already exists with this email
        if (selectedLead.email) {
          const { data: existing, error: checkError } = await supabaseClient
            .from('customers')
            .select('id')
            .eq('email', selectedLead.email)
            .eq('user_id', user.id)
            .maybeSingle();

          // Ignore 406 errors (no rows found)
          if (existing && !checkError) {
            showToast('Customer with this email already exists', 'info');
            return;
          }
        }

        // Parse name into parts
        const nameParts = (selectedLead.full_name || '').trim().split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';

        // Get address from structured data or parse from string
        let address = null, city = null, state = 'AZ', zip = null;

        // Try structured service_address first, then billing_address
        const structuredAddr = selectedLead.service_address || selectedLead.billing_address;
        if (structuredAddr && typeof structuredAddr === 'object') {
          address = structuredAddr.street || null;
          if (structuredAddr.street2) address += ' ' + structuredAddr.street2;
          city = structuredAddr.city || null;
          state = structuredAddr.state || 'AZ';
          zip = structuredAddr.zip || selectedLead.zip_code || null;
        } else {
          // Fall back to parsing address string
          const addressParts = (selectedLead.project_address || selectedLead.address || '').split(',').map(s => s.trim());
          address = addressParts[0] || null;
          city = addressParts[1] || null;
          state = addressParts[2] || 'AZ';
          zip = selectedLead.zip_code || null;
        }

        // Build notes with appointment info if present
        let notes = `Lead source: ${selectedLead.form_name || 'Website'}\nProject type: ${selectedLead.project_type || 'Not specified'}`;
        if (selectedLead.raw_data?.appointment) {
          const appt = selectedLead.raw_data.appointment;
          const apptTypeLabels = {
            'estimate': 'Free In-Home Estimate',
            'measure': 'Measurement Visit',
            'showroom': 'Showroom Visit',
            'consultation': 'Design Consultation',
            'installation': 'Installation'
          };
          notes += `\n\nScheduled: ${apptTypeLabels[appt.type] || appt.type} on ${appt.date} at ${appt.time}`;
        }
        if (selectedLead.message) {
          notes += `\n\nOriginal message: ${selectedLead.message}`;
        }

        // Create customer with standard fields only (+ bidirectional lead_id reference)
        const customerData = {
          user_id: user.id,
          name: selectedLead.full_name || 'Unknown',
          email: selectedLead.email || null,
          phone: selectedLead.phone || null,
          address: address,
          city: city,
          state: state,
          zip: zip,
          notes: notes,
          lead_id: selectedLead.id, // Bidirectional reference back to lead
          source: selectedLead.form_name || 'lead_conversion'
        };

        console.log('Creating customer with data:', customerData);

        const { data: customer, error } = await supabaseClient
          .from('customers')
          .insert(customerData)
          .select()
          .single();

        if (error) {
          console.error('Customer insert error:', error);
          throw error;
        }

        // Update lead status to "qualified"
        await supabaseClient
          .from('leads')
          .update({ status: 'qualified', customer_id: customer.id, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        // Update local lead data (bidirectional sync)
        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) {
          allLeads[idx].status = 'qualified';
          allLeads[idx].customer_id = customer.id;
        }

        // Add new customer to global array (bidirectional sync)
        customer.lead_id = selectedLead.id;
        customer.total_jobs = 0;
        customer.total_spent = 0;
        allCustomers.unshift(customer);

        // Save appointment info before closing modal (which clears selectedLead)
        const hasAppointment = selectedLead?.raw_data?.appointment;
        const customerId = customer.id;

        showToast('Customer created successfully!');
        updateStats();
        renderLeads();
        closeLeadModal();

        // Offer to create estimate with appointment pre-filled
        const confirmMsg = hasAppointment
          ? 'Customer added! They have an appointment scheduled. Create an estimate for them now?'
          : 'Customer added! Would you like to create an estimate for them now?';

        if (confirm(confirmMsg)) {
          createEstimateForCustomer(customerId);
        }
      } catch (err) {
        console.error('Convert lead error:', err);
        showToast('Error creating customer: ' + err.message, 'error');
      }
    }

    // UNIFIED: Start estimate from lead - ensures customer is created/linked first
    async function startEstimateFromLead(leadId) {
      const lead = leadId ? allLeads.find(l => l.id === leadId) : selectedLead;
      if (!lead) {
        showToast('No lead selected', 'error');
        return;
      }

      // Close lead modal
      closeLeadModal();

      showToast('Creating customer record...', 'info');

      // ALWAYS create/find customer first - this ensures proper linkage
      const customer = await findOrCreateCustomerFromLead(lead);
      if (!customer) {
        showToast('Failed to create customer record', 'error');
        return;
      }

      // Update workflow state
      workflowState.currentLead = lead;
      workflowState.currentCustomer = customer;

      // Navigate to estimates page
      showPage('estimates');

      // Small delay to ensure page is rendered
      setTimeout(() => {
        // Set modal state with proper customer linkage
        estimateModalState = {
          customerId: customer.id,
          leadId: lead.id,
          editingEstimateId: null
        };

        // Open estimate modal (preserveState=true since we set estimateModalState above)
        openCreateEstimateModal(true);

        // Pre-fill customer info
        fillEstimateCustomerFields(customer);

        // Pre-fill project info from lead
        const projectNameField = document.getElementById('estimate-project-name');
        const projectDescField = document.getElementById('estimate-project-desc');
        if (projectNameField) projectNameField.value = lead.project_type ? `${lead.project_type} Project` : 'New Project';
        if (projectDescField) projectDescField.value = lead.message || lead.project_details || '';

        // Update lead status to "quoted"
        supabaseClient
          .from('leads')
          .update({ status: 'quoted', updated_at: new Date().toISOString() })
          .eq('id', lead.id);

        showToast(`Estimate linked to customer: ${customer.name}`);
      }, 150);
    }

    // Backward compatibility alias
    async function createEstimateFromLead() {
      return startEstimateFromLead(selectedLead?.id);
    }

    // Send invoice directly to lead (without requiring an estimate)
    function sendInvoiceToLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'warning');
        return;
      }

      closeLeadModal();
      showPage('invoices');

      setTimeout(() => {
        openInvoiceModal({
          email: selectedLead.email || '',
          name: selectedLead.full_name || '',
          phone: selectedLead.phone || ''
        });

        showToast('Invoice form pre-filled from lead', 'success');
      }, 200);
    }

    // Create project from lead
    async function createProjectFromLead() {
      if (!selectedLead) { showToast('No lead selected', 'warning'); return; }
      var lead = selectedLead;

      // Ensure customer exists first
      await findOrCreateCustomerFromLead(lead);

      // Close lead modal and navigate to projects
      const leadModal = document.getElementById('lead-modal');
      if (leadModal) leadModal.classList.remove('active');
      showPage('projects');

      setTimeout(function() {
        openNewProjectModal();
        // Pre-fill from lead data
        document.getElementById('proj-name').value = (lead.project_type || 'New Project') + ' - ' + (lead.full_name || '');
        document.getElementById('proj-customer-name').value = lead.full_name || '';
        document.getElementById('proj-customer-email').value = lead.email || '';
        document.getElementById('proj-customer-phone').value = lead.phone || '';
        // Parse address
        var addr = lead.project_address || lead.service_address || '';
        if (typeof addr === 'object' && addr !== null) {
          document.getElementById('proj-address').value = addr.street || '';
          document.getElementById('proj-city').value = addr.city || '';
          document.getElementById('proj-state').value = addr.state || 'AZ';
          document.getElementById('proj-zip').value = addr.zip || '';
        } else {
          document.getElementById('proj-address').value = addr;
        }
        document.getElementById('proj-notes').value = 'From lead: ' + (lead.message || lead.project_details || '');
        document.getElementById('proj-status').value = 'lead';

        showToast('Project form pre-filled from lead', 'success');
      }, 300);
    }

    // Create room design from lead
    async function createDesignFromLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'error');
        return;
      }

      // Store lead info in sessionStorage for the room designer to read
      const leadInfo = {
        id: selectedLead.id,
        full_name: selectedLead.full_name || '',
        email: selectedLead.email || '',
        phone: selectedLead.phone || '',
        address: selectedLead.project_address || selectedLead.address || '',
        project_type: selectedLead.project_type || '',
        message: selectedLead.message || selectedLead.project_details || ''
      };

      sessionStorage.setItem('sg_lead_for_design', JSON.stringify(leadInfo));

      // Close lead modal
      closeLeadModal();

      // Open room designer in new tab with lead flag
      window.open('/tools/room-designer/?from_lead=1', '_blank');

      showToast('Opening Room Designer with lead info...');
    }

    // Quick convert from leads table
    async function quickConvertLead(leadId, action) {
      selectedLead = allLeads.find(l => l.id === leadId);
      if (!selectedLead) {
        showToast('Lead not found', 'error');
        return;
      }

      if (action === 'customer') {
        await convertLeadToCustomer();
      } else if (action === 'estimate') {
        await createEstimateFromLead();
      } else if (action === 'design') {
        await createDesignFromLead();
      }
    }

    // ==========================================
    // UNIFIED CUSTOMER MANAGEMENT SYSTEM
    // Combines: Account Subscribers, Shopify Customers, Imported Clients
    // ==========================================

    // allCustomers and customerFilter declared above
    let filteredCustomersList = [];
    let customersPage = 1;
    const customersPageSize = 50;
    // customerFilter declared above
    let customerSort = 'recent';
    let customersLoaded = false;

    // Customer source counts
    let subscriberCount = 0;
    let shopifyCustomerCount = 0;
    let importedCustomerCount = 0;

    async function loadCustomers() {
      if (customersLoaded) {
        renderCustomers();
        return;
      }

      const loadingEl = document.getElementById('customers-loading');
      const emptyEl = document.getElementById('customers-empty');
      const tableEl = document.getElementById('customers-table');
      const paginationEl = document.getElementById('customers-pagination');

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();

        // Step 1: Consolidate sg_users and shopify_customers into unified customers table
        await consolidateCustomerSources(user);

        // Step 2: Load from the unified customers table (single source of truth)
        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Map source labels for display
        const sourceLabels = {
          'subscriber': { label: 'Account', color: 'var(--gold-primary)' },
          'shopify': { label: 'Shopify', color: 'var(--info)' },
          'manual': { label: 'Manual', color: 'var(--text-muted)' },
          'stripe_sync': { label: 'Stripe', color: 'var(--success)' },
          'lead_conversion': { label: 'Lead', color: 'var(--warning)' }
        };

        allCustomers = (customers || []).map(c => ({
          ...c,
          _source: c.source || 'manual',
          name: c.name || c.full_name || c.email?.split('@')[0] || 'Unknown',
          total_spent: parseFloat(c.total_spent || 0),
          orders_count: c.total_jobs || 0,
          _sourceLabel: sourceLabels[c.source]?.label || 'Customer',
          _sourceColor: sourceLabels[c.source]?.color || 'var(--text-muted)'
        }));

        // Count by source for stats
        subscriberCount = allCustomers.filter(c => c._source === 'subscriber').length;
        shopifyCustomerCount = allCustomers.filter(c => c._source === 'shopify').length;
        importedCustomerCount = allCustomers.filter(c => c._source === 'stripe_sync' || c._source === 'manual').length;

        customersLoaded = true;
        loadingEl.style.display = 'none';

        // Update stats
        updateCustomerStats();

        // Setup search
        setupCustomersSearch();

        if (allCustomers.length === 0) {
          emptyEl.style.display = 'block';
          tableEl.style.display = 'none';
          paginationEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          tableEl.style.display = 'block';
          paginationEl.style.display = 'flex';
          filterCustomers('all');
        }

      } catch (err) {
        console.error('Error loading customers:', err);
        loadingEl.innerHTML = `<p style="color: var(--error);">Error loading customers: ${escapeHtml(err.message || 'Unknown error')}</p>`;
      }
    }

    // Consolidate records from sg_users and shopify_customers into the unified customers table
    async function consolidateCustomerSources(user) {
      try {
        // Get existing customer emails for deduplication
        const { data: existingCustomers } = await supabaseClient
          .from('customers')
          .select('email');

        const existingEmails = new Set((existingCustomers || []).map(c => c.email?.toLowerCase()).filter(Boolean));

        // Fetch from sg_users and shopify_customers in parallel
        const [subscribersResult, shopifyResult] = await Promise.all([
          supabaseClient.from('sg_users').select('id, email, full_name, phone, created_at, account_type, avatar_url'),
          supabaseClient.from('shopify_customers').select('*').order('created_at', { ascending: false })
        ]);

        const toInsert = [];

        // Process subscribers not yet in customers table
        (subscribersResult.data || []).forEach(u => {
          if (u.email && !existingEmails.has(u.email.toLowerCase())) {
            existingEmails.add(u.email.toLowerCase());
            toInsert.push({
              user_id: user?.id,
              name: u.full_name || u.email?.split('@')[0] || 'Unknown',
              email: u.email,
              phone: u.phone || null,
              source: 'subscriber',
              created_at: u.created_at
            });
          }
        });

        // Process Shopify customers not yet in customers table
        (shopifyResult.data || []).forEach(c => {
          const name = c.name || [c.first_name, c.last_name].filter(Boolean).join(' ') || c.email?.split('@')[0] || 'Unknown';
          if (c.email && !existingEmails.has(c.email.toLowerCase())) {
            existingEmails.add(c.email.toLowerCase());
            toInsert.push({
              user_id: user?.id,
              name: name,
              email: c.email,
              phone: c.phone || null,
              source: 'shopify',
              created_at: c.created_at
            });
          }
        });

        // Bulk insert new records
        if (toInsert.length > 0) {
          console.log('[Customers] Consolidating', toInsert.length, 'new records into customers table');
          const { error } = await supabaseClient.from('customers').upsert(toInsert, { onConflict: 'user_id,email', ignoreDuplicates: true });
          if (error) {
            console.warn('[Customers] Consolidation error (non-fatal):', error.message);
          }
        }
      } catch (err) {
        console.warn('[Customers] Consolidation failed (non-fatal):', err.message);
      }
    }

    function updateCustomerStats() {
      const total = allCustomers.length;
      const totalRevenue = allCustomers.reduce((sum, c) => sum + (parseFloat(c.total_spent) || 0), 0);
      const activeCount = allCustomers.filter(c => (c.orders_count || 0) > 0).length;
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const recentCount = allCustomers.filter(c => new Date(c.created_at) > thirtyDaysAgo).length;
      const vipCount = allCustomers.filter(c => (parseFloat(c.total_spent) || 0) >= 1000).length;

      document.getElementById('stat-total-customers').textContent = total.toLocaleString();
      document.getElementById('stat-subscribers').textContent = subscriberCount.toLocaleString();
      document.getElementById('stat-shopify-customers').textContent = shopifyCustomerCount.toLocaleString();
      document.getElementById('stat-imported-customers').textContent = importedCustomerCount.toLocaleString();
      document.getElementById('stat-customer-revenue').textContent = '$' + totalRevenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      // Update filter counts
      document.getElementById('count-all-customers').textContent = total;
      document.getElementById('count-active-customers').textContent = activeCount;
      document.getElementById('count-recent-customers').textContent = recentCount;
      document.getElementById('count-vip-customers').textContent = vipCount;

      // Update nav badge
      const countEl = document.getElementById('customers-count');
      if (countEl) {
        countEl.textContent = total.toLocaleString();
        countEl.dataset.count = total;
        countEl.style.display = total > 0 ? 'inline-flex' : 'none';
      }
    }

    function setupCustomersSearch() {
      const searchInput = document.getElementById('customers-search');
      if (!searchInput) return;
      let timeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          customersPage = 1;
          renderCustomers();
        }, 300);
      });
    }

    function filterCustomers(filter) {
      customerFilter = filter;

      // Update filter pills
      document.querySelectorAll('[data-customer-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.customerFilter === filter);
      });

      // Update source dropdown
      const sourceSelect = document.getElementById('customers-source-filter');
      if (sourceSelect && ['all', 'subscribers', 'shopify', 'imported', 'manual'].includes(filter)) {
        sourceSelect.value = filter;
      }

      customersPage = 1;
      renderCustomers();
    }

    function sortCustomers(sortBy) {
      customerSort = sortBy;
      renderCustomers();
    }

    function renderCustomers() {
      const searchTerm = (document.getElementById('customers-search')?.value || '').toLowerCase();
      let filtered = [...allCustomers];

      // Apply source filter
      if (customerFilter === 'subscribers') {
        filtered = filtered.filter(c => c._source === 'subscriber' || c._source === 'both');
      } else if (customerFilter === 'shopify') {
        filtered = filtered.filter(c => c._source === 'shopify' || c._source === 'both');
      } else if (customerFilter === 'imported') {
        filtered = filtered.filter(c => c._source === 'imported');
      } else if (customerFilter === 'manual') {
        filtered = filtered.filter(c => c._source === 'manual');
      } else if (customerFilter === 'active') {
        filtered = filtered.filter(c => (c.orders_count || 0) > 0);
      } else if (customerFilter === 'recent') {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        filtered = filtered.filter(c => new Date(c.created_at) > thirtyDaysAgo);
      } else if (customerFilter === 'vip') {
        filtered = filtered.filter(c => (parseFloat(c.total_spent) || 0) >= 1000);
      }

      // Apply search
      if (searchTerm) {
        filtered = filtered.filter(c => {
          const name = c.name || '';
          return name.toLowerCase().includes(searchTerm) ||
            (c.email || '').toLowerCase().includes(searchTerm) ||
            (c.phone || '').toLowerCase().includes(searchTerm) ||
            (c.city || '').toLowerCase().includes(searchTerm);
        });
      }

      // Apply sort
      if (customerSort === 'name') {
        filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      } else if (customerSort === 'spent') {
        filtered.sort((a, b) => (parseFloat(b.total_spent) || 0) - (parseFloat(a.total_spent) || 0));
      } else if (customerSort === 'orders') {
        filtered.sort((a, b) => (b.orders_count || 0) - (a.orders_count || 0));
      } else {
        filtered.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      }

      filteredCustomersList = filtered;

      const tableEl = document.getElementById('customers-table');
      const emptyEl = document.getElementById('customers-empty');
      const paginationEl = document.getElementById('customers-pagination');

      if (filtered.length === 0) {
        tableEl.style.display = 'none';
        emptyEl.style.display = 'block';
        paginationEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      tableEl.style.display = 'block';
      paginationEl.style.display = 'flex';

      // Paginate
      const start = (customersPage - 1) * customersPageSize;
      const end = start + customersPageSize;
      const pageCustomers = filtered.slice(start, end);

      // Render customer cards
      tableEl.innerHTML = `
        <div class="list-modern">
          ${pageCustomers.map(c => {
            const ordersCount = c.orders_count || 0;
            const totalSpent = parseFloat(c.total_spent || 0);
            const ordersColor = ordersCount > 0 ? '#22c55e' : '#6b7280';
            return `
            <div class="list-item-modern" onclick="viewShopifyCustomer('${c.id}')" data-item-id="${c.id}">
              <div class="list-item-icon" style="background: rgba(249, 203, 0, 0.15); color: var(--gold-primary);">
                ${c.avatar_url
                  ? `<img src="${c.avatar_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                  : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>`
                }
              </div>
              <div class="list-item-content">
                <div class="list-item-title">
                  ${escapeHtml(c.name)}
                  <span style="display: inline-block; padding: 2px 8px; font-size: 10px; font-weight: 600; border-radius: 10px; margin-left: 8px; background: ${c._sourceColor}20; color: ${c._sourceColor};">${c._sourceLabel}</span>
                </div>
                <div class="list-item-subtitle">${escapeHtml(c.email || 'No email')} ${c.phone ? ' ' + escapeHtml(c.phone) : ''}</div>
                <div class="list-item-subtitle" style="margin-top: 2px;">
                  ${escapeHtml(c.city || '')}${c.state ? ', ' + escapeHtml(c.state) : ''}
                  ${c.account_type ? `<span style="color: var(--text-muted); margin-left: 8px;">${c.account_type}</span>` : ''}
                </div>
              </div>
              <div class="list-item-meta">
                <div style="font-weight: 700; font-size: 15px; color: var(--gold-primary); margin-bottom: 4px;">$${totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                <span class="badge-modern" style="background: ${ordersColor}20; color: ${ordersColor};">${ordersCount} orders</span>
              </div>
            </div>
          `;}).join('')}
        </div>
      `;

      // Update pagination
      const totalPages = Math.ceil(filtered.length / customersPageSize);
      document.getElementById('customers-page-info').textContent = `Showing ${start + 1}-${Math.min(end, filtered.length)} of ${filtered.length}`;
      document.getElementById('customers-prev-btn').disabled = customersPage === 1;
      document.getElementById('customers-next-btn').disabled = customersPage >= totalPages;
    }

    function customersPagePrev() {
      if (customersPage > 1) {
        customersPage--;
        renderCustomers();
      }
    }

    function customersPageNext() {
      const totalPages = Math.ceil(filteredCustomersList.length / customersPageSize);
      if (customersPage < totalPages) {
        customersPage++;
        renderCustomers();
      }
    }

    // Export customers to CSV
    function exportCustomersCSV() {
      if (filteredCustomersList.length === 0) {
        showToast('No customers to export', 'error');
        return;
      }

      const csv = [
        ['Name', 'Email', 'Phone', 'City', 'State', 'Total Spent', 'Orders', 'Source', 'Created'].join(','),
        ...filteredCustomersList.map(c => [
          `"${(c.name || '').replace(/"/g, '""')}"`,
          c.email || '',
          c.phone || '',
          `"${(c.city || '').replace(/"/g, '""')}"`,
          c.state || '',
          c.total_spent || 0,
          c.orders_count || 0,
          c._sourceLabel || '',
          c.created_at ? new Date(c.created_at).toLocaleDateString() : ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customers-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Customers exported', 'success');
    }

    // Customer import modal
    function openCustomerImportModal() {
      const modal = document.createElement('div');
      modal.className = 'customer-import-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      modal.innerHTML = `
        <div style="background: var(--dark-surface); border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 18px; font-weight: 700;">Import Customers</h3>
            <button onclick="this.closest('.customer-import-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div style="padding: 24px;">
            <div style="border: 2px dashed var(--border-subtle); border-radius: 12px; padding: 32px; text-align: center; margin-bottom: 20px;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p style="margin-bottom: 12px;">Upload a CSV file with your customers</p>
              <input type="file" id="customer-import-file" accept=".csv" style="display: none;" onchange="handleCustomerImport(this.files[0])">
              <button class="btn-modern primary" onclick="document.getElementById('customer-import-file').click()">Choose File</button>
            </div>
            <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
              <h4 style="margin-bottom: 12px; font-size: 14px;">Expected CSV Format</h4>
              <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">Include headers in first row:</p>
              <code style="display: block; background: var(--dark-surface); padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto;">
                name,email,phone,address,city,state,zip,notes
              </code>
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    async function handleCustomerImport(file) {
      if (!file) return;

      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim());

        if (lines.length < 2) {
          showToast('CSV file is empty', 'error');
          return;
        }

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
        const customers = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].match(/(".*?"|[^,]+)/g)?.map(v => v.trim().replace(/^"|"$/g, '')) || [];
          if (values.length === 0) continue;

          const customer = {
            source: 'imported',
            created_at: new Date().toISOString()
          };

          headers.forEach((header, idx) => {
            const value = values[idx] || '';
            if (header.includes('name') || header === 'full_name') customer.name = value;
            else if (header.includes('email')) customer.email = value;
            else if (header.includes('phone')) customer.phone = value;
            else if (header.includes('address') && !header.includes('city')) customer.address = value;
            else if (header.includes('city')) customer.city = value;
            else if (header.includes('state')) customer.state = value;
            else if (header.includes('zip') || header.includes('postal')) customer.zip = value;
            else if (header.includes('note')) customer.notes = value;
          });

          if (customer.name || customer.email) {
            customers.push(customer);
          }
        }

        if (customers.length === 0) {
          showToast('No valid customers found in CSV', 'error');
          return;
        }

        // Insert into customers table (for imported clients)
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          const toInsert = customers.map(c => ({ ...c, user_id: user.id }));
          const { error } = await supabaseClient.from('customers').insert(toInsert);
          if (error) {
            console.error('Import error:', error);
            showToast('Error importing: ' + error.message, 'error');
            return;
          }
        }

        showToast(`${customers.length} customers imported!`, 'success');
        document.querySelector('.customer-import-modal')?.remove();

        // Reload customers
        customersLoaded = false;
        await loadCustomers();

      } catch (err) {
        console.error('Import error:', err);
        showToast('Error reading file', 'error');
      }
    }

    function searchCustomersPage() {
      customersPage = 1;
      renderCustomers();
    }

    async function viewCustomer(customerId) {
      selectedCustomer = allCustomers.find(c => c.id === customerId);
      if (!selectedCustomer) {
        // Try loading from database
        const { data } = await supabaseClient.from('customers').select('*').eq('id', customerId).single();
        if (data) selectedCustomer = data;
        else return;
      }

      // Update modal title
      document.getElementById('customer-detail-modal-title').textContent = selectedCustomer.name || 'Customer Details';

      // Render customer info
      document.getElementById('customer-info').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${selectedCustomer.email ? `<a href="mailto:${selectedCustomer.email}" style="color: var(--gold-primary);">${selectedCustomer.email}</a>` : 'Not provided'}</div></div>
          <div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">${selectedCustomer.phone ? `<a href="tel:${selectedCustomer.phone}" style="color: var(--gold-primary);">${selectedCustomer.phone}</a>` : 'Not provided'}</div></div>
          <div class="detail-row"><div class="detail-label">Address</div><div class="detail-value">${selectedCustomer.address || '-'}</div></div>
          <div class="detail-row"><div class="detail-label">City/State/ZIP</div><div class="detail-value">${[selectedCustomer.city, selectedCustomer.state, selectedCustomer.zip].filter(Boolean).join(', ') || '-'}</div></div>
          <div class="detail-row"><div class="detail-label">Source</div><div class="detail-value">${selectedCustomer.source || 'Direct'}</div></div>
          <div class="detail-row"><div class="detail-label">Customer Since</div><div class="detail-value">${new Date(selectedCustomer.created_at).toLocaleDateString()}</div></div>
        </div>
      `;

      // Reset to jobs tab and load content
      currentCustomerTab = 'jobs';
      document.querySelectorAll('.customer-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === 'jobs');
      });
      loadCustomerTabContent('jobs');

      // Show modal
      document.getElementById('customer-modal').classList.add('active');
    }

    function closeCustomerModal() {
      document.getElementById('customer-modal').classList.remove('active');
      selectedCustomer = null;
    }

    // View Shopify customer details
    function viewShopifyCustomer(customerId) {
      const customer = allCustomers.find(c => c.id === customerId);
      if (!customer) return;

      const customerName = customer.name || [customer.first_name, customer.last_name].filter(Boolean).join(' ') || 'Unknown';
      const totalSpent = parseFloat(customer.total_spent || 0);
      const ordersCount = customer.orders_count || 0;
      const createdAt = customer.shopify_created_at || customer.created_at;

      const modal = document.createElement('div');
      modal.className = 'shopify-customer-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      modal.innerHTML = `
        <div style="background: var(--dark-surface); border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 18px; font-weight: 700;">${escapeHtml(customerName)}</h3>
            <button onclick="this.closest('.shopify-customer-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
              <div style="background: var(--dark-elevated); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Total Spent</div>
              </div>
              <div style="background: var(--dark-elevated); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--success);">${ordersCount}</div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Orders</div>
              </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Email</span>
                <span>${customer.email ? `<a href="mailto:${escapeHtml(customer.email)}" style="color: var(--gold-primary);">${escapeHtml(customer.email)}</a>` : '-'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Phone</span>
                <span>${customer.phone ? `<a href="tel:${escapeHtml(customer.phone)}" style="color: var(--gold-primary);">${escapeHtml(customer.phone)}</a>` : '-'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Location</span>
                <span>${[customer.city, customer.state, customer.zip].filter(Boolean).join(', ') || '-'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Address</span>
                <span style="text-align: right; max-width: 60%;">${escapeHtml(customer.address || '-')}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Customer Since</span>
                <span>${createdAt ? new Date(createdAt).toLocaleDateString() : '-'}</span>
              </div>
              ${customer.tags ? `
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Tags</span>
                <span>${escapeHtml(customer.tags)}</span>
              </div>
              ` : ''}
              ${customer.note ? `
              <div style="padding: 12px 0;">
                <div style="color: var(--text-muted); margin-bottom: 8px;">Notes</div>
                <div style="background: var(--dark-elevated); padding: 12px; border-radius: 8px; font-size: 14px;">${escapeHtml(customer.note)}</div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    function showCustomerTab(tab) {
      currentCustomerTab = tab;
      document.querySelectorAll('.customer-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      loadCustomerTabContent(tab);
    }

    async function loadCustomerTabContent(tab) {
      const container = document.getElementById('customer-tab-content');
      container.innerHTML = '<div class="empty-state"><div class="spinner"></div><p>Loading...</p></div>';

      if (!selectedCustomer) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        if (tab === 'jobs') {
          const { data: jobs } = await supabaseClient
            .from('projects')
            .select('*')
            .eq('customer_id', selectedCustomer.id)
            .order('created_at', { ascending: false });

          if (!jobs || jobs.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No jobs for this customer yet.</p>
                <button class="btn-modern primary" onclick="createJobForCustomer()" style="margin-top: 12px;">Create First Job</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Job #</th><th>Description</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                <tbody>
                  ${jobs.map(j => `
                    <tr style="cursor: pointer;" onclick="viewJob && viewJob('${j.id}')">
                      <td style="font-weight: 600;">${j.job_number || '-'}</td>
                      <td>${j.description || '-'}</td>
                      <td><span class="status-badge job-${j.status || 'new'}">${(j.status || 'new').replace('_', ' ')}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(j.total_price || 0).toFixed(2)}</td>
                      <td>${new Date(j.created_at).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'estimates') {
          const { data: estimates } = await supabaseClient
            .from('estimates')
            .select('*')
            .or(`customer_email.eq.${selectedCustomer.email},customer_id.eq.${selectedCustomer.id}`)
            .order('created_at', { ascending: false });

          if (!estimates || estimates.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No estimates for this customer yet.</p>
                <button class="btn-modern primary" onclick="createEstimateForCustomer()" style="margin-top: 12px;">Create Estimate</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Estimate #</th><th>Project</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                <tbody>
                  ${estimates.map(e => `
                    <tr style="cursor: pointer;" onclick="viewEstimate && viewEstimate('${e.id}')">
                      <td style="font-weight: 600;">${e.estimate_number || 'Draft'}</td>
                      <td>${e.project_name || '-'}</td>
                      <td><span class="status-badge status-${e.status}">${e.status}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(e.total || 0).toFixed(2)}</td>
                      <td>${new Date(e.created_at).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'invoices') {
          const { data: invoices } = await supabaseClient
            .from('invoices')
            .select('*')
            .or(`customer_email.eq.${selectedCustomer.email},customer_id.eq.${selectedCustomer.id}`)
            .order('created_at', { ascending: false });

          if (!invoices || invoices.length === 0) {
            container.innerHTML = `<div class="empty-state"><p>No invoices for this customer yet.</p></div>`;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Invoice #</th><th>Status</th><th>Amount</th><th>Due Date</th></tr></thead>
                <tbody>
                  ${invoices.map(inv => `
                    <tr>
                      <td style="font-weight: 600;">${inv.invoice_number || '-'}</td>
                      <td><span class="status-badge status-${inv.status === 'paid' ? 'won' : inv.status === 'open' ? 'new' : 'lost'}">${inv.status}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(inv.amount_due || 0).toFixed(2)}</td>
                      <td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'favorites') {
          // Load customer's favorites if they have a user account
          let favorites = [];

          // Try to find user by email
          if (selectedCustomer.email) {
            const { data: userData } = await supabaseClient
              .from('sg_users')
              .select('id')
              .eq('email', selectedCustomer.email)
              .single();

            if (userData) {
              const { data: favData } = await supabaseClient
                .from('user_favorites')
                .select('*')
                .eq('user_id', userData.id)
                .order('created_at', { ascending: false });

              favorites = favData || [];
            }
          }

          if (!favorites || favorites.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <p>No favorites found for this customer.</p>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Customer may not have an account or hasn't saved any favorites yet.</p>
              </div>
            `;
          } else {
            container.innerHTML = `
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                ${favorites.map(fav => `
                  <div class="favorite-card" style="background: var(--dark-elevated); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-subtle);">
                    ${fav.image_url ? `<img src="${fav.image_url}" alt="${fav.product_name || 'Product'}" style="width: 100%; height: 120px; object-fit: cover;">` : `<div style="width: 100%; height: 120px; background: var(--dark-surface); display: flex; align-items: center; justify-content: center; color: var(--text-muted);"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>`}
                    <div style="padding: 12px;">
                      <div style="font-weight: 600; margin-bottom: 4px;">${fav.product_name || 'Unknown Product'}</div>
                      <div style="font-size: 12px; color: var(--text-muted);">${fav.product_type || fav.category || 'Material'}</div>
                      ${fav.product_url ? `<a href="${fav.product_url}" target="_blank" class="btn-modern secondary" style="margin-top: 8px; font-size: 12px; padding: 6px 10px;">View Product</a>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
              <p style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">These are materials and products your customer has saved as favorites.</p>
            `;
          }
        } else if (tab === 'messages') {
          // Load messages/correspondence with this customer
          let messages = [];

          if (selectedCustomer.id) {
            const { data: msgData } = await supabaseClient
              .from('customer_messages')
              .select('*')
              .eq('customer_id', selectedCustomer.id)
              .order('created_at', { ascending: false });

            messages = msgData || [];
          }

          container.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <!-- Message Input -->
              <div style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid var(--border-subtle);">
                <textarea id="new-customer-message" rows="3" placeholder="Type a message to this customer..." style="width: 100%; padding: 12px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); resize: vertical; margin-bottom: 12px;"></textarea>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn-modern secondary" onclick="sendCustomerEmail()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Send Email
                  </button>
                  <button class="btn-modern primary" onclick="sendCustomerSMS()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    Send SMS
                  </button>
                </div>
              </div>

              <!-- Message History -->
              <div style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid var(--border-subtle);">
                <h4 style="margin-bottom: 12px; color: var(--text-secondary);">Message History</h4>
                ${messages.length === 0 ? `
                  <div class="empty-state" style="padding: 24px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <p>No messages yet.</p>
                    <p style="font-size: 12px; color: var(--text-muted);">Send your first message to start the conversation.</p>
                  </div>
                ` : `
                  <div style="display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto;">
                    ${messages.map(msg => `
                      <div style="padding: 12px; background: var(--dark-surface); border-radius: 8px; border-left: 3px solid ${msg.direction === 'outbound' ? 'var(--gold-primary)' : '#3b82f6'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                          <span style="font-size: 12px; color: var(--text-muted);">${msg.direction === 'outbound' ? 'Sent' : 'Received'} via ${msg.channel || 'email'}</span>
                          <span style="font-size: 12px; color: var(--text-muted);">${new Date(msg.created_at).toLocaleString()}</span>
                        </div>
                        <div style="color: var(--text-primary);">${msg.message || msg.content || ''}</div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          `;
        } else if (tab === 'notes') {
          container.innerHTML = `
            <div style="padding: 16px;">
              <textarea id="customer-notes-edit" rows="6" style="width: 100%; padding: 12px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); resize: vertical;">${selectedCustomer.notes || ''}</textarea>
              <button class="btn-modern primary" onclick="saveCustomerNotes()" style="margin-top: 12px;">Save Notes</button>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error loading tab content:', err);
        container.innerHTML = `<div class="empty-state"><p style="color: var(--error);">Error: ${escapeHtml(err.message || 'Unknown error')}</p></div>`;
      }
    }

    async function saveCustomerNotes() {
      if (!selectedCustomer) return;
      const notes = document.getElementById('customer-notes-edit')?.value || '';

      try {
        const { error } = await supabaseClient
          .from('customers')
          .update({ notes, updated_at: new Date().toISOString() })
          .eq('id', selectedCustomer.id);

        if (error) throw error;
        selectedCustomer.notes = notes;
        showToast('Notes saved!');
      } catch (err) {
        showToast('Error saving notes: ' + err.message, 'error');
      }
    }

    // Send email to customer
    async function sendCustomerEmail() {
      if (!selectedCustomer) return;

      const message = document.getElementById('new-customer-message')?.value?.trim();
      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }

      if (!selectedCustomer.email) {
        showToast('Customer has no email address', 'error');
        return;
      }

      try {
        // Log the message to database
        const { error } = await supabaseClient.from('customer_messages').insert({
          customer_id: selectedCustomer.id,
          sender_id: currentUser.id,
          direction: 'outbound',
          channel: 'email',
          message: message,
          sent_to: selectedCustomer.email,
          status: 'sent',
          created_at: new Date().toISOString()
        });

        if (error) throw error;

        // Open email client as fallback
        const subject = encodeURIComponent('Message from Surprise Granite');
        const body = encodeURIComponent(message);
        window.open(`mailto:${selectedCustomer.email}?subject=${subject}&body=${body}`, '_blank');

        document.getElementById('new-customer-message').value = '';
        showToast('Message logged! Email client opened.');
        loadCustomerTabContent('messages');
      } catch (err) {
        console.error('Email error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // Send SMS to customer
    async function sendCustomerSMS() {
      if (!selectedCustomer) return;

      const message = document.getElementById('new-customer-message')?.value?.trim();
      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }

      if (!selectedCustomer.phone) {
        showToast('Customer has no phone number', 'error');
        return;
      }

      try {
        // Log the message to database
        const { error } = await supabaseClient.from('customer_messages').insert({
          customer_id: selectedCustomer.id,
          sender_id: currentUser.id,
          direction: 'outbound',
          channel: 'sms',
          message: message,
          sent_to: selectedCustomer.phone,
          status: 'sent',
          created_at: new Date().toISOString()
        });

        if (error) throw error;

        // Open SMS app as fallback (works on mobile)
        const smsBody = encodeURIComponent(message);
        window.open(`sms:${selectedCustomer.phone}?body=${smsBody}`, '_blank');

        document.getElementById('new-customer-message').value = '';
        showToast('Message logged! SMS app opened.');
        loadCustomerTabContent('messages');
      } catch (err) {
        console.error('SMS error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function openQuickAddCustomerModal() {
      selectedCustomer = null;
      document.getElementById('edit-customer-title').textContent = 'Add Customer';
      document.getElementById('edit-customer-form').reset();
      document.getElementById('edit-customer-modal').classList.add('active');
    }

    function editCustomer() {
      if (!selectedCustomer) return;
      document.getElementById('edit-customer-title').textContent = 'Edit Customer';

      // Populate form
      document.getElementById('customer-name').value = selectedCustomer.name || '';
      document.getElementById('customer-email').value = selectedCustomer.email || '';
      document.getElementById('customer-phone').value = selectedCustomer.phone || '';
      document.getElementById('customer-source').value = selectedCustomer.source || '';
      document.getElementById('customer-address').value = selectedCustomer.address || '';
      document.getElementById('customer-city').value = selectedCustomer.city || '';
      document.getElementById('customer-state').value = selectedCustomer.state || '';
      document.getElementById('customer-zip').value = selectedCustomer.zip || '';
      document.getElementById('customer-notes').value = selectedCustomer.notes || '';

      closeCustomerModal();
      document.getElementById('edit-customer-modal').classList.add('active');
    }

    function closeEditCustomerModal() {
      document.getElementById('edit-customer-modal').classList.remove('active');
    }

    async function saveCustomerForm(event) {
      event.preventDefault();

      const btn = document.getElementById('save-customer-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        const customerData = {
          user_id: user.id,
          name: document.getElementById('customer-name').value.trim(),
          email: document.getElementById('customer-email').value.trim() || null,
          phone: document.getElementById('customer-phone').value.trim() || null,
          source: document.getElementById('customer-source').value || null,
          address: document.getElementById('customer-address').value.trim() || null,
          city: document.getElementById('customer-city').value.trim() || null,
          state: document.getElementById('customer-state').value.trim() || null,
          zip: document.getElementById('customer-zip').value.trim() || null,
          notes: document.getElementById('customer-notes').value.trim() || null,
          updated_at: new Date().toISOString()
        };

        let result;
        if (selectedCustomer) {
          // Update existing
          result = await supabaseClient
            .from('customers')
            .update(customerData)
            .eq('id', selectedCustomer.id)
            .select()
            .single();
        } else {
          // Insert new
          result = await supabaseClient
            .from('customers')
            .insert([customerData])
            .select()
            .single();
        }

        if (result.error) throw result.error;

        closeEditCustomerModal();
        showToast(selectedCustomer ? 'Customer updated!' : 'Customer added!');
        await loadCustomers();

        // If we were viewing this customer, refresh the view
        if (selectedCustomer) {
          viewCustomer(result.data.id);
        }
      } catch (err) {
        console.error('Save customer error:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Customer';
      }
    }

    async function deleteCustomer() {
      if (!selectedCustomer) return;

      const confirmed = confirm(`Are you sure you want to delete this customer?\n\n${selectedCustomer.name}\n${selectedCustomer.email || ''}\n\nThis will NOT delete their jobs, estimates, or invoices.`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('customers')
          .delete()
          .eq('id', selectedCustomer.id);

        if (error) throw error;

        closeCustomerModal();
        allCustomers = allCustomers.filter(c => c.id !== selectedCustomer.id);
        updateCustomersCount();
        renderCustomers();
        showToast('Customer deleted');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    function createJobForCustomer() {
      if (!selectedCustomer) return;
      closeCustomerModal();
      showPage('jobs');

      setTimeout(() => {
        if (typeof openCreateJobModal === 'function') {
          openCreateJobModal(selectedCustomer);
        } else {
          showToast('Navigate to Jobs page to create a job', 'info');
        }
      }, 100);
    }

    // Note: Main createEstimateForCustomer function is defined later with full implementation
    // This early reference is kept for code that runs before the full definition loads

    function quickNewJobForCustomer(customerId) {
      selectedCustomer = allCustomers.find(c => c.id === customerId);
      createJobForCustomer();
    }

    function quickNewEstimateForCustomer(customerId) {
      createEstimateForCustomer(customerId);
    }

    // Schedule appointment for customer
    function scheduleAppointmentForCustomer() {
      if (!selectedCustomer) {
        showToast('No customer selected', 'warning');
        return;
      }

      const customer = selectedCustomer;
      closeCustomerModal();
      showPage('calendar');

      setTimeout(() => {
        openCalendarEventModal(null, null, {
          title: `Appointment - ${customer.name || customer.email || 'Customer'}`,
          type: 'appointment',
          contactName: customer.name || '',
          contactEmail: customer.email || '',
          contactPhone: customer.phone || '',
          location: formatAddressFromData(customer),
          customerId: customer.id
        });
      }, 200);
    }

    // Close modals on overlay click
    document.getElementById('customer-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeCustomerModal();
    });
    document.getElementById('edit-customer-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeEditCustomerModal();
    });

    // Admin Users Functions
    let adminUsers = [];

    async function loadAdminUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .or('account_type.eq.admin,account_type.eq.super_admin')
          .order('created_at', { ascending: false });

        if (error) throw error;
        adminUsers = data || [];
        renderAdminUsers();
      } catch (err) {
        document.getElementById('admin-users-list').innerHTML = `<p style="color: var(--error);">Error: ${escapeHtml(err.message || 'Unknown error')}</p>`;
      }
    }

    function renderAdminUsers() {
      const allAdmins = [
        ...SUPER_ADMIN_EMAILS.map(email => ({ email, full_name: email.split('@')[0], isSuperAdmin: true })),
        ...adminUsers.filter(u => !SUPER_ADMIN_EMAILS.includes(u.email?.toLowerCase()))
      ];

      document.getElementById('admin-users-list').innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allAdmins.map(user => `
              <tr>
                <td>${user.email}</td>
                <td>${user.full_name || '-'}</td>
                <td><span class="status-badge ${user.isSuperAdmin ? 'status-won' : 'status-qualified'}">${user.isSuperAdmin ? 'Super Admin' : 'Admin'}</span></td>
                <td style="text-align: right;">
                  ${user.isSuperAdmin ? '<span style="color: var(--text-muted); font-size: 12px;">Protected</span>' :
                    `<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeAdminUser('${user.id}', '${user.email}')">Remove</button>`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function addAdminUser() {
      const email = document.getElementById('new-admin-email').value.trim().toLowerCase();
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
      }

      if (SUPER_ADMIN_EMAILS.includes(email)) {
        alert('Already a super admin');
        return;
      }

      try {
        const { data: existing } = await supabaseClient.from('sg_users').select('*').eq('email', email).single();

        if (existing) {
          await supabaseClient.from('sg_users').update({ account_type: 'admin' }).eq('id', existing.id);
        } else {
          await supabaseClient.from('sg_users').insert([{ email, account_type: 'admin', full_name: email.split('@')[0] }]);
        }

        document.getElementById('new-admin-email').value = '';
        loadAdminUsers();
        alert(`Admin access granted to ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeAdminUser(userId, email) {
      if (!confirm(`Remove admin access for ${email}?`)) return;

      try {
        await supabaseClient.from('sg_users').update({ account_type: 'homeowner' }).eq('id', userId);
        loadAdminUsers();
        alert(`Admin removed: ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape closes modals
      if (e.key === 'Escape') {
        closeLeadModal();
        closeProductModal();
        closeInvoiceModal();
      }

      // Don't trigger shortcuts when typing in inputs
      const activeEl = document.activeElement;
      const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
      if (isTyping) return;

      // Keyboard navigation shortcuts (no modifiers = page navigation)
      if (!e.ctrlKey && !e.metaKey && !e.altKey) {
        switch(e.key) {
          case 'd': case 'D': showPage('dashboard'); break;
          case 'l': case 'L': showPage('leads'); break;
          case 'p': case 'P': showPage('projects'); break;
          case 'c': case 'C': showPage('calendar'); break;
          case 'f': case 'F': showPage('finance'); break;
        }
      }

      // Action shortcuts (Ctrl/Cmd + key)
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'n': case 'N':
            e.preventDefault();
            openAddLeadModal();
            break;
          case 'k': case 'K':
            e.preventDefault();
            // Global search focus (if exists)
            const searchInput = document.querySelector('.topbar-search input, #global-search');
            if (searchInput) searchInput.focus();
            break;
        }
      }

      // Shift shortcuts for quick actions
      if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
        switch(e.key) {
          case 'E': case 'e':
            e.preventDefault();
            openCalendarEventModal && openCalendarEventModal();
            break;
          case 'I': case 'i':
            e.preventDefault();
            openInvoiceModal && openInvoiceModal();
            break;
          case 'P': case 'p':
            e.preventDefault();
            openNewProjectModal && openNewProjectModal();
            break;
          case '?':
            e.preventDefault();
            showKeyboardShortcuts && showKeyboardShortcuts();
            break;
        }
      }

      // ? without shift also shows help
      if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        showKeyboardShortcuts && showKeyboardShortcuts();
      }
    });

    document.getElementById('lead-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeLeadModal();
    });

    // ============ PRODUCT MANAGEMENT (Shopify Products) ============
    let allProducts = [];
    let filteredProducts = [];
    let selectedProducts = new Set();
    let productsPage = 1;
    const productsPageSize = 50;
    let productsSearchTerm = '';
    let productsStatusFilter = 'all';
    let productsVendorFilter = '';
    let productsTypeFilter = '';
    let productsLoaded = false;
    let editingProduct = null;

    async function loadProducts() {
      if (productsLoaded) return;

      const loadingEl = document.getElementById('products-loading');
      const emptyEl = document.getElementById('products-empty');
      const tableEl = document.getElementById('products-table-container');

      try {
        // Load ALL products from shopify_products
        const { data, error } = await supabaseClient
          .from('shopify_products')
          .select('*')
          .order('name');

        if (error) throw error;

        allProducts = data || [];
        filteredProducts = [...allProducts];
        productsLoaded = true;

        loadingEl.style.display = 'none';

        // Update stats
        updateProductStats();

        // Populate vendor/type filters
        populateProductFilters();

        // Setup search
        setupProductsSearch();

        // Setup dropship toggle handler
        document.getElementById('product-dropship')?.addEventListener('change', (e) => {
          document.getElementById('product-supplier-group').style.display = e.target.checked ? 'block' : 'none';
        });

        if (allProducts.length === 0) {
          emptyEl.style.display = 'block';
          tableEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          tableEl.style.display = 'block';
          renderProductsTable();
        }
      } catch (err) {
        console.error('Error loading products:', err);
        loadingEl.innerHTML = '<p style="color: var(--error);">Error loading products. Please try again.</p>';
      }
    }

    function updateProductStats() {
      const total = allProducts.length;
      const active = allProducts.filter(p => p.status === 'active').length;
      const draft = allProducts.filter(p => p.status === 'draft').length;
      const lowStock = allProducts.filter(p => p.inventory_quantity !== null && p.inventory_quantity <= 5).length;
      const discontinued = allProducts.filter(p => p.status === 'discontinued').length;

      document.getElementById('stat-total-products').textContent = total.toLocaleString();
      document.getElementById('stat-active-products').textContent = active.toLocaleString();
      document.getElementById('stat-draft-products').textContent = draft.toLocaleString();
      document.getElementById('stat-lowstock-products').textContent = lowStock.toLocaleString();

      // Update filter counts
      document.getElementById('products-count-all').textContent = total;
      document.getElementById('products-count-active').textContent = active;
      document.getElementById('products-count-draft').textContent = draft;
      document.getElementById('products-count-discontinued').textContent = discontinued;
    }

    function populateProductFilters() {
      // Vendors
      const vendors = [...new Set(allProducts.map(p => p.vendor).filter(Boolean))].sort();
      const vendorSelect = document.getElementById('products-vendor-filter');
      if (vendorSelect) {
        vendorSelect.innerHTML = '<option value="">All Vendors</option>' +
          vendors.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      }

      // Types
      const types = [...new Set(allProducts.map(p => p.product_type).filter(Boolean))].sort();
      const typeSelect = document.getElementById('products-type-filter');
      if (typeSelect) {
        typeSelect.innerHTML = '<option value="">All Types</option>' +
          types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      }
    }

    function setupProductsSearch() {
      const searchInput = document.getElementById('products-search');
      if (!searchInput) return;
      let timeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          productsSearchTerm = e.target.value.toLowerCase();
          filterProductsList();
        }, 300);
      });
    }

    function filterProductsByStatus(status) {
      productsStatusFilter = status;
      document.querySelectorAll('[data-product-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.productStatus === status);
      });
      productsPage = 1;
      filterProductsList();
    }

    function filterProductsList() {
      productsVendorFilter = document.getElementById('products-vendor-filter')?.value || '';
      productsTypeFilter = document.getElementById('products-type-filter')?.value || '';

      filteredProducts = allProducts.filter(p => {
        // Status filter
        if (productsStatusFilter !== 'all' && p.status !== productsStatusFilter) return false;

        // Vendor filter
        if (productsVendorFilter && p.vendor !== productsVendorFilter) return false;

        // Type filter
        if (productsTypeFilter && p.product_type !== productsTypeFilter) return false;

        // Search
        if (productsSearchTerm) {
          const searchable = `${p.name || ''} ${p.sku || ''} ${p.vendor || ''} ${p.product_type || ''}`.toLowerCase();
          if (!searchable.includes(productsSearchTerm)) return false;
        }

        return true;
      });

      productsPage = 1;
      renderProductsTable();
    }

    function renderProductsTable() {
      const tbody = document.getElementById('products-table-body');
      const emptyEl = document.getElementById('products-empty');
      const tableEl = document.getElementById('products-table-container');

      if (filteredProducts.length === 0) {
        tbody.innerHTML = '';
        tableEl.style.display = 'none';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      tableEl.style.display = 'block';

      const start = (productsPage - 1) * productsPageSize;
      const end = start + productsPageSize;
      const pageProducts = filteredProducts.slice(start, end);
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        // Mobile card view
        tbody.innerHTML = pageProducts.map(p => `
          <div class="product-card-mobile" style="display: block; margin-bottom: 12px;">
            <div class="product-card-mobile-header">
              <input type="checkbox" data-id="${p.id}"
                ${selectedProducts.has(p.id) ? 'checked' : ''}
                onchange="toggleProductSelect('${p.id}')"
                style="accent-color: var(--gold-primary); width: 20px; height: 20px; margin-right: 8px;">
              <img src="${p.image_url || 'https://via.placeholder.com/60x60?text=No+Image'}"
                   class="product-card-mobile-image"
                   onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
              <div class="product-card-mobile-info">
                <div class="product-card-mobile-name">${escapeHtml(p.name || '')}</div>
                <div class="product-card-mobile-meta">${escapeHtml(p.vendor || 'No vendor')} ${p.sku ? ' ' + escapeHtml(p.sku) : ''}</div>
              </div>
            </div>
            <div class="product-card-mobile-row">
              <span class="product-card-mobile-label">Price</span>
              <span class="product-card-mobile-value" style="color: var(--gold-primary);">$${parseFloat(p.price || 0).toFixed(2)}</span>
            </div>
            <div class="product-card-mobile-row">
              <span class="product-card-mobile-label">Stock</span>
              <span class="product-card-mobile-value" style="color: ${p.inventory_quantity !== null && p.inventory_quantity <= 5 ? 'var(--error)' : 'var(--success)'};">
                ${p.inventory_quantity !== null ? p.inventory_quantity : '-'}
              </span>
            </div>
            <div class="product-card-mobile-row">
              <span class="product-card-mobile-label">Status</span>
              <span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; text-transform: capitalize;
                background: ${p.status === 'active' ? 'rgba(34, 197, 94, 0.15)' : p.status === 'draft' ? 'rgba(156, 163, 175, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                color: ${p.status === 'active' ? '#4ade80' : p.status === 'draft' ? '#9ca3af' : '#f87171'};">
                ${escapeHtml(p.status || 'draft')}
              </span>
              ${p.is_dropship ? '<span style="display: inline-block; padding: 2px 6px; background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 4px;">DS</span>' : ''}
            </div>
            <div class="product-card-mobile-actions">
              <button onclick="editProduct('${p.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit
              </button>
              <button class="danger" onclick="deleteProduct('${p.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete
              </button>
            </div>
          </div>
        `).join('');
      } else {
        // Desktop table view
        tbody.innerHTML = pageProducts.map(p => `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <input type="checkbox" class="product-row-checkbox" data-id="${p.id}"
                ${selectedProducts.has(p.id) ? 'checked' : ''}
                onchange="toggleProductSelect('${p.id}')"
                style="accent-color: var(--gold-primary);">
            </td>
            <td style="padding: 12px 16px;">
              <img src="${p.image_url || 'https://via.placeholder.com/50x50?text=No+Image'}"
                   alt="" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: var(--dark-surface);"
                   onerror="this.src='https://via.placeholder.com/50x50?text=No+Image'">
            </td>
            <td style="padding: 12px 16px;">
              <div style="font-weight: 600; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(p.name || '')}</div>
              <div style="font-size: 13px; color: var(--text-muted);">${escapeHtml(p.vendor || '-')}</div>
            </td>
            <td style="padding: 12px 16px; font-family: monospace; font-size: 13px; color: var(--text-secondary);">${escapeHtml(p.sku || '-')}</td>
            <td style="padding: 12px 16px; font-weight: 600;">$${parseFloat(p.price || 0).toFixed(2)}</td>
            <td style="padding: 12px 16px;">
              <span style="font-weight: 600; color: ${p.inventory_quantity !== null && p.inventory_quantity <= 5 ? 'var(--error)' : 'var(--success)'};">
                ${p.inventory_quantity !== null ? p.inventory_quantity : '-'}
              </span>
            </td>
            <td style="padding: 12px 16px;">
              <span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; text-transform: capitalize;
                background: ${p.status === 'active' ? 'rgba(34, 197, 94, 0.15)' : p.status === 'draft' ? 'rgba(156, 163, 175, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                color: ${p.status === 'active' ? '#4ade80' : p.status === 'draft' ? '#9ca3af' : '#f87171'};">
                ${escapeHtml(p.status || 'draft')}
              </span>
              ${p.is_dropship ? '<span style="display: inline-block; padding: 2px 6px; background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 4px;">DS</span>' : ''}
            </td>
            <td style="padding: 12px 16px;">
              <div style="display: flex; gap: 8px;">
                <button onclick="editProduct('${p.id}')" title="Edit" style="padding: 8px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button onclick="deleteProduct('${p.id}')" title="Delete" style="padding: 8px; border-radius: 6px; border: none; background: transparent; color: var(--error); cursor: pointer;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // Update pagination
      const totalPages = Math.ceil(filteredProducts.length / productsPageSize);
      document.getElementById('products-page-info').textContent = `Showing ${start + 1}-${Math.min(end, filteredProducts.length)} of ${filteredProducts.length}`;
      document.getElementById('products-prev-btn').disabled = productsPage === 1;
      document.getElementById('products-next-btn').disabled = productsPage >= totalPages;

      updateProductsBulkActions();
    }

    // Re-render on resize for responsive view
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (productsLoaded) renderProductsTable();
      }, 250);
    });

    function productsPagePrev() {
      if (productsPage > 1) {
        productsPage--;
        renderProductsTable();
      }
    }

    function productsPageNext() {
      const totalPages = Math.ceil(filteredProducts.length / productsPageSize);
      if (productsPage < totalPages) {
        productsPage++;
        renderProductsTable();
      }
    }

    // Selection functions
    function toggleProductSelect(id) {
      if (selectedProducts.has(id)) {
        selectedProducts.delete(id);
      } else {
        selectedProducts.add(id);
      }
      updateProductsBulkActions();
    }

    function toggleAllProducts() {
      const checkbox = document.getElementById('products-select-all');
      const start = (productsPage - 1) * productsPageSize;
      const end = start + productsPageSize;
      const pageProducts = filteredProducts.slice(start, end);

      if (checkbox.checked) {
        pageProducts.forEach(p => selectedProducts.add(p.id));
      } else {
        pageProducts.forEach(p => selectedProducts.delete(p.id));
      }
      renderProductsTable();
    }

    function clearProductSelection() {
      selectedProducts.clear();
      document.getElementById('products-select-all').checked = false;
      renderProductsTable();
    }

    function updateProductsBulkActions() {
      const bulkActions = document.getElementById('products-bulk-actions');
      const count = selectedProducts.size;
      document.getElementById('products-selected-count').textContent = count;
      bulkActions.style.display = count > 0 ? 'flex' : 'none';
    }

    // Bulk actions
    async function bulkUpdateProducts(status) {
      if (selectedProducts.size === 0) return;

      try {
        const ids = Array.from(selectedProducts);
        const { error } = await supabaseClient
          .from('shopify_products')
          .update({ status, updated_at: new Date().toISOString() })
          .in('id', ids);

        if (error) throw error;

        showToast(`${ids.length} products updated to ${status}`, 'success');
        clearProductSelection();
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Bulk update error:', err);
        showToast('Error updating products', 'error');
      }
    }

    async function bulkDeleteProducts() {
      if (selectedProducts.size === 0) return;
      if (!confirm(`Are you sure you want to delete ${selectedProducts.size} products? This cannot be undone.`)) return;

      try {
        const ids = Array.from(selectedProducts);
        const { error } = await supabaseClient
          .from('shopify_products')
          .delete()
          .in('id', ids);

        if (error) throw error;

        showToast(`${ids.length} products deleted`, 'success');
        clearProductSelection();
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Bulk delete error:', err);
        showToast('Error deleting products', 'error');
      }
    }

    // Open modal for create/edit
    function openProductModal(product = null) {
      editingProduct = product;
      const modal = document.getElementById('product-modal');
      const title = document.getElementById('product-modal-title');
      const form = document.getElementById('product-form');

      title.textContent = product ? 'Edit Product' : 'Add New Product';
      form.reset();
      document.getElementById('product-id').value = '';
      document.getElementById('product-supplier-group').style.display = 'none';

      if (product) {
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-sku').value = product.sku || '';
        document.getElementById('product-vendor').value = product.vendor || '';
        document.getElementById('product-type').value = product.product_type || '';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-compare-price').value = product.compare_at_price || '';
        document.getElementById('product-cost').value = product.cost_price || '';
        document.getElementById('product-stock').value = product.inventory_quantity || 0;
        document.getElementById('product-status').value = product.status || 'draft';
        document.getElementById('product-dropship').checked = product.is_dropship || false;
        document.getElementById('product-supplier').value = product.supplier_name || '';
        document.getElementById('product-image-url').value = product.image_url || '';
        document.getElementById('product-tags').value = Array.isArray(product.tags) ? product.tags.join(', ') : (product.tags || '');

        if (product.is_dropship) {
          document.getElementById('product-supplier-group').style.display = 'block';
        }
      }

      modal.classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('active');
      editingProduct = null;
    }

    function editProduct(id) {
      const product = allProducts.find(p => p.id === id);
      if (product) {
        openProductModal(product);
      }
    }

    async function saveProduct(e) {
      e.preventDefault();
      const btn = document.getElementById('product-save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const productId = document.getElementById('product-id').value;
      const tagsInput = document.getElementById('product-tags').value;
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];

      const productData = {
        name: document.getElementById('product-name').value,
        sku: document.getElementById('product-sku').value || null,
        vendor: document.getElementById('product-vendor').value || null,
        product_type: document.getElementById('product-type').value || null,
        description: document.getElementById('product-description').value || null,
        price: parseFloat(document.getElementById('product-price').value) || 0,
        compare_at_price: parseFloat(document.getElementById('product-compare-price').value) || null,
        cost_price: parseFloat(document.getElementById('product-cost').value) || null,
        inventory_quantity: parseInt(document.getElementById('product-stock').value) || 0,
        status: document.getElementById('product-status').value,
        is_dropship: document.getElementById('product-dropship').checked,
        supplier_name: document.getElementById('product-supplier').value || null,
        image_url: document.getElementById('product-image-url').value || null,
        tags: tags,
        updated_at: new Date().toISOString()
      };

      try {
        if (productId) {
          // Update existing
          const { error } = await supabaseClient
            .from('shopify_products')
            .update(productData)
            .eq('id', productId);
          if (error) throw error;
          showToast('Product updated successfully', 'success');
        } else {
          // Create new - generate handle from name
          productData.handle = productData.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
          productData.created_at = new Date().toISOString();

          const { error } = await supabaseClient
            .from('shopify_products')
            .insert([productData]);
          if (error) throw error;
          showToast('Product created successfully', 'success');
        }

        closeProductModal();
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Save error:', err);
        showToast('Error saving product: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Product';
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const { error } = await supabaseClient
          .from('shopify_products')
          .delete()
          .eq('id', id);
        if (error) throw error;

        showToast('Product deleted', 'success');
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Delete error:', err);
        showToast('Error deleting product: ' + err.message, 'error');
      }
    }

    function exportProductsCSV() {
      if (filteredProducts.length === 0) {
        showToast('No products to export', 'error');
        return;
      }

      const csv = [
        ['Name', 'SKU', 'Vendor', 'Type', 'Price', 'Stock', 'Status', 'Dropship', 'Shopify ID'].join(','),
        ...filteredProducts.map(p => [
          `"${(p.name || '').replace(/"/g, '""')}"`,
          p.sku || '',
          `"${(p.vendor || '').replace(/"/g, '""')}"`,
          `"${(p.product_type || '').replace(/"/g, '""')}"`,
          p.price || 0,
          p.inventory_quantity || 0,
          p.status || '',
          p.is_dropship ? 'Yes' : 'No',
          p.shopify_id || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `products-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Products exported', 'success');
    }

    // Load products when showing products page
    const originalShowPage = showPage;
    showPage = async function(page) {
      await originalShowPage(page);
      if (page === 'products') {
        await loadProducts();
      }
    };

    // Product modal click-outside to close
    document.getElementById('product-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeProductModal();
    });

    // ============ PRODUCT IMPORT ============
    let importData = [];
    let importHeaders = [];
    let importMapping = {};

    function openImportModal() {
      document.getElementById('import-modal').classList.add('active');
      resetImport();
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('active');
      resetImport();
    }

    function resetImport() {
      importData = [];
      importHeaders = [];
      importMapping = {};
      document.getElementById('import-step-1').style.display = 'block';
      document.getElementById('import-step-2').style.display = 'none';
      document.getElementById('import-step-3').style.display = 'none';
      document.getElementById('import-step-4').style.display = 'none';
      document.getElementById('import-footer').style.display = 'flex';
      document.getElementById('import-btn').disabled = true;
      document.getElementById('import-file-input').value = '';
    }

    // Setup drag and drop
    document.addEventListener('DOMContentLoaded', () => {
      const dropzone = document.getElementById('import-dropzone');
      if (!dropzone) return;

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.style.borderColor = 'var(--gold-primary)';
          dropzone.style.background = 'rgba(249, 203, 0, 0.05)';
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.style.borderColor = 'var(--border-subtle)';
          dropzone.style.background = 'transparent';
        });
      });

      dropzone.addEventListener('drop', (e) => {
        const file = e.dataTransfer.files[0];
        if (file) handleImportFile(file);
      });
    });

    async function handleImportFile(file) {
      if (!file) return;

      const fileName = file.name.toLowerCase();

      if (fileName.endsWith('.csv')) {
        await parseCSV(file);
      } else if (fileName.endsWith('.pdf')) {
        await parsePDF(file);
      } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        await parseExcel(file);
      } else {
        showToast('Unsupported file format. Please use CSV, PDF, or Excel.', 'error');
        return;
      }
    }

    async function parseCSV(file) {
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(line => line.trim());

      if (lines.length < 2) {
        showToast('CSV file is empty or has no data rows', 'error');
        return;
      }

      // Parse headers
      importHeaders = parseCSVLine(lines[0]);

      // Parse data rows
      importData = [];
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.some(v => v.trim())) {
          const row = {};
          importHeaders.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          importData.push(row);
        }
      }

      showMappingStep(file.name);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"' && inQuotes && nextChar === '"') {
          current += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    async function parsePDF(file) {
      showToast('Processing PDF...', 'info');

      // Load PDF.js if not already loaded
      if (!window.pdfjsLib) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }

        // Try to extract tabular data from PDF text
        const extractedData = extractPDFData(fullText);

        if (extractedData.length === 0) {
          showToast('Could not extract product data from PDF. Try CSV format instead.', 'error');
          return;
        }

        importHeaders = Object.keys(extractedData[0]);
        importData = extractedData;
        showMappingStep(file.name);
      } catch (err) {
        console.error('PDF parse error:', err);
        showToast('Error reading PDF file. Try CSV format instead.', 'error');
      }
    }

    function extractPDFData(text) {
      // Try to find patterns like SKU, prices, product names
      const lines = text.split(/\n/).filter(l => l.trim());
      const products = [];

      // Pattern matching for common product list formats
      // Look for lines with prices (contains $ or numeric values)
      const pricePattern = /\$?\d+\.?\d{0,2}/g;
      const skuPattern = /[A-Z0-9]{3,}[-_]?[A-Z0-9]*/gi;

      for (const line of lines) {
        const prices = line.match(pricePattern);
        const skus = line.match(skuPattern);

        if (prices && prices.length > 0) {
          // Extract what looks like a product line
          const cleanLine = line.replace(pricePattern, '|||PRICE|||').replace(skuPattern, '|||SKU|||');
          const parts = cleanLine.split(/\s{2,}|\t/).filter(p => p.trim());

          if (parts.length >= 1) {
            const product = {
              name: line.replace(pricePattern, '').replace(skuPattern, '').trim().substring(0, 200) || 'Unknown Product',
              price: prices[0]?.replace('$', '') || '',
              sku: skus?.[0] || ''
            };
            if (product.name && product.name !== 'Unknown Product') {
              products.push(product);
            }
          }
        }
      }

      return products;
    }

    async function parseExcel(file) {
      showToast('Processing Excel file...', 'info');

      // Load SheetJS if not already loaded
      if (!window.XLSX) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        if (jsonData.length < 2) {
          showToast('Excel file is empty or has no data rows', 'error');
          return;
        }

        importHeaders = jsonData[0].map(h => String(h || '').trim());
        importData = [];

        for (let i = 1; i < jsonData.length; i++) {
          const row = {};
          importHeaders.forEach((header, idx) => {
            row[header] = jsonData[i][idx] !== undefined ? String(jsonData[i][idx]) : '';
          });
          if (Object.values(row).some(v => v.trim())) {
            importData.push(row);
          }
        }

        showMappingStep(file.name);
      } catch (err) {
        console.error('Excel parse error:', err);
        showToast('Error reading Excel file', 'error');
      }
    }

    function showMappingStep(fileName) {
      document.getElementById('import-step-1').style.display = 'none';
      document.getElementById('import-step-2').style.display = 'block';
      document.getElementById('import-file-info').textContent = `${importData.length} rows detected from ${fileName}`;

      // Auto-map columns based on common names
      const fieldMappings = {
        name: ['name', 'title', 'product', 'product_name', 'productname', 'item', 'item_name', 'description'],
        sku: ['sku', 'item_number', 'itemnumber', 'item_no', 'itemno', 'product_code', 'productcode', 'code', 'upc', 'part_number', 'partnumber'],
        price: ['price', 'cost', 'retail', 'retail_price', 'retailprice', 'unit_price', 'unitprice', 'amount', 'msrp'],
        vendor: ['vendor', 'supplier', 'brand', 'manufacturer', 'mfg', 'mfr'],
        inventory_quantity: ['quantity', 'stock', 'qty', 'inventory', 'in_stock', 'instock', 'available'],
        description: ['description', 'desc', 'details', 'notes', 'product_description'],
        product_type: ['type', 'category', 'product_type', 'producttype', 'material'],
        image_url: ['image', 'image_url', 'imageurl', 'photo', 'picture', 'img']
      };

      importMapping = {};
      const mappingGrid = document.getElementById('import-mapping-grid');
      mappingGrid.innerHTML = '';

      Object.entries(fieldMappings).forEach(([field, aliases]) => {
        // Find matching header
        const matchedHeader = importHeaders.find(h =>
          aliases.some(alias => h.toLowerCase().replace(/[^a-z0-9]/g, '').includes(alias.replace(/[^a-z0-9]/g, '')))
        );

        if (matchedHeader) {
          importMapping[field] = matchedHeader;
        }

        const fieldLabels = {
          name: 'Product Name *',
          sku: 'SKU',
          price: 'Price *',
          vendor: 'Vendor',
          inventory_quantity: 'Stock Quantity',
          description: 'Description',
          product_type: 'Product Type',
          image_url: 'Image URL'
        };

        mappingGrid.innerHTML += `
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 13px; font-weight: 500;">${fieldLabels[field]}</label>
            <select id="map-${field}" onchange="updateMapping('${field}', this.value)"
              style="padding: 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
              <option value="">-- Skip --</option>
              ${importHeaders.map(h => `<option value="${escapeHtml(h)}" ${importMapping[field] === h ? 'selected' : ''}>${escapeHtml(h)}</option>`).join('')}
            </select>
          </div>
        `;
      });

      // Show preview
      updateImportPreview();

      // Enable import button if required fields are mapped
      validateMapping();
    }

    function updateMapping(field, value) {
      if (value) {
        importMapping[field] = value;
      } else {
        delete importMapping[field];
      }
      updateImportPreview();
      validateMapping();
    }

    function validateMapping() {
      const hasName = importMapping.name;
      const hasPrice = importMapping.price;
      document.getElementById('import-btn').disabled = !(hasName && hasPrice);
    }

    function updateImportPreview() {
      const thead = document.getElementById('import-preview-head');
      const tbody = document.getElementById('import-preview-body');

      const mappedFields = Object.entries(importMapping).filter(([_, v]) => v);

      thead.innerHTML = `<tr style="background: var(--dark-surface);">
        ${mappedFields.map(([field]) => `<th style="padding: 10px; text-align: left; font-size: 12px; text-transform: uppercase; color: var(--text-muted);">${field}</th>`).join('')}
      </tr>`;

      tbody.innerHTML = importData.slice(0, 5).map(row => `
        <tr style="border-bottom: 1px solid var(--border-subtle);">
          ${mappedFields.map(([field, header]) => `<td style="padding: 10px; font-size: 13px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(row[header] || '-')}</td>`).join('')}
        </tr>
      `).join('');
    }

    async function startImport() {
      document.getElementById('import-step-2').style.display = 'none';
      document.getElementById('import-step-3').style.display = 'block';
      document.getElementById('import-footer').style.display = 'none';

      const updateExisting = document.getElementById('import-update-existing').checked;
      const setActive = document.getElementById('import-set-active').checked;

      let imported = 0;
      let updated = 0;
      let errors = 0;
      const total = importData.length;

      for (let i = 0; i < importData.length; i++) {
        const row = importData[i];

        // Build product object from mapping
        const product = {
          name: row[importMapping.name] || 'Unknown Product',
          sku: row[importMapping.sku] || null,
          price: parseFloat(String(row[importMapping.price] || '0').replace(/[^0-9.]/g, '')) || 0,
          vendor: row[importMapping.vendor] || null,
          inventory_quantity: parseInt(row[importMapping.inventory_quantity]) || 0,
          description: row[importMapping.description] || null,
          product_type: row[importMapping.product_type] || null,
          image_url: row[importMapping.image_url] || null,
          status: setActive ? 'active' : 'draft',
          handle: (row[importMapping.name] || 'product').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''),
          updated_at: new Date().toISOString()
        };

        try {
          // Check if product exists by SKU
          if (updateExisting && product.sku) {
            const { data: existing } = await supabaseClient
              .from('shopify_products')
              .select('id')
              .eq('sku', product.sku)
              .single();

            if (existing) {
              // Update existing
              const { error } = await supabaseClient
                .from('shopify_products')
                .update(product)
                .eq('id', existing.id);

              if (error) throw error;
              updated++;
            } else {
              // Insert new
              product.created_at = new Date().toISOString();
              const { error } = await supabaseClient
                .from('shopify_products')
                .insert([product]);

              if (error) throw error;
              imported++;
            }
          } else {
            // Insert new
            product.created_at = new Date().toISOString();
            const { error } = await supabaseClient
              .from('shopify_products')
              .insert([product]);

            if (error) throw error;
            imported++;
          }
        } catch (err) {
          console.error('Import error for row:', row, err);
          errors++;
        }

        // Update progress
        const progress = Math.round(((i + 1) / total) * 100);
        document.getElementById('import-progress-bar').style.width = progress + '%';
        document.getElementById('import-progress-text').textContent = `${i + 1} of ${total} products processed`;
      }

      // Show complete step
      document.getElementById('import-step-3').style.display = 'none';
      document.getElementById('import-step-4').style.display = 'block';

      let message = `${imported} products imported`;
      if (updated > 0) message += `, ${updated} updated`;
      if (errors > 0) message += `, ${errors} errors`;
      document.getElementById('import-complete-text').textContent = message;

      // Refresh products list
      productsLoaded = false;
      await loadProducts();
    }

    // ============ INVOICE MANAGEMENT ============
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? `http://${window.location.host}`
      : 'https://surprise-granite-email-api.onrender.com';
    const API_BASE = API_URL;

    // Reusable API call helper - auto-includes Supabase JWT auth token
    async function apiCall(endpoint, options = {}) {
      const { data: { session } } = await supabaseClient.auth.getSession();
      const token = session?.access_token;
      if (!token) {
        console.warn('[apiCall] No auth token available for', endpoint, '- session:', !!session);
      }
      return fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
          ...(options.headers || {})
        }
      });
    }

    let allInvoices = [];
    let invoiceFilter = 'all';
    let invoiceItemCount = 1;

    async function loadInvoices() {
      console.log('[Invoices] Loading invoices...');
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) {
        console.warn('[Invoices] No invoices-list container found');
        return;
      }

      try {
        // Show loading state
        invoicesList.innerHTML = '<div class="empty-state"><p>Loading invoices...</p></div>';

        if (!supabaseClient) {
          console.error('[Invoices] supabaseClient not initialized');
          invoicesList.innerHTML = '<div class="empty-state"><p>Database connection not ready. Please refresh.</p></div>';
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        console.log('[Invoices] User:', user?.id);

        // Load from both Supabase (source of truth) and Stripe (supplementary) in parallel
        const [supabaseResult, stripeResult] = await Promise.all([
          supabaseClient
            .from('invoices')
            .select('*, invoice_items(*)')
            .eq('user_id', user?.id)
            .order('created_at', { ascending: false }),
          apiCall('/api/invoices?limit=100')
            .then(r => r.ok ? r.json() : { invoices: [] })
            .catch(err => {
              console.warn('[Invoices] Stripe fetch failed (non-fatal):', err.message);
              return { invoices: [] };
            })
        ]);

        if (supabaseResult.error) throw supabaseResult.error;

        // Map Supabase invoices
        const supabaseInvoices = (supabaseResult.data || []).map(inv => ({
          id: inv.id,
          number: inv.invoice_number,
          invoice_number: inv.invoice_number,
          customer_email: inv.customer_email,
          customer_name: inv.customer_name,
          status: inv.status === 'unpaid' ? 'open' : inv.status,
          total: inv.total || 0,
          amount_due: inv.amount_due || inv.total || 0,
          amount_paid: inv.amount_paid || 0,
          due_date: inv.due_date,
          created: new Date(inv.created_at).getTime() / 1000,
          created_at: inv.created_at,
          source: 'supabase',
          estimate_id: inv.estimate_id,
          stripe_invoice_id: inv.stripe_invoice_id,
          stripe_hosted_url: inv.stripe_hosted_url,
          stripe_pdf_url: inv.stripe_pdf_url,
          invoice_items: inv.invoice_items,
          view_count: inv.view_count || 0
        }));

        // Track Stripe IDs already in Supabase for deduplication
        const knownStripeIds = new Set(
          supabaseInvoices.map(inv => inv.stripe_invoice_id).filter(Boolean)
        );

        // Safe date conversion for Unix timestamps
        function safeISODate(ts) {
          if (!ts) return null;
          try {
            const d = new Date(typeof ts === 'number' ? ts * 1000 : ts);
            return isNaN(d.getTime()) ? null : d.toISOString();
          } catch { return null; }
        }

        // Map Stripe-only invoices (server already returns dollars and ISO dates)
        const stripeInvoices = (stripeResult.invoices || [])
          .filter(inv => inv.id && !knownStripeIds.has(inv.id))
          .map(inv => ({
            id: inv.id,
            number: inv.number || inv.id,
            invoice_number: inv.number || inv.id,
            customer_email: inv.customer_email || '',
            customer_name: inv.customer_name || '',
            status: inv.status || 'unknown',
            total: inv.total || 0,
            amount_due: inv.amount_due || 0,
            amount_paid: inv.amount_paid || 0,
            due_date: inv.due_date || null,
            created: inv.created ? new Date(inv.created).getTime() / 1000 : null,
            created_at: inv.created || null,
            source: 'stripe',
            stripe_invoice_id: inv.id,
            stripe_hosted_url: inv.hosted_invoice_url || null,
            stripe_pdf_url: inv.invoice_pdf || null,
            invoice_items: [],
            view_count: inv.view_count || 0
          }));

        // Merge: Supabase first (source of truth), then Stripe-only records
        allInvoices = [...supabaseInvoices, ...stripeInvoices];

        console.log('[Invoices] Loaded', supabaseInvoices.length, 'from Supabase,', stripeInvoices.length, 'from Stripe (total:', allInvoices.length, ')');
        renderInvoices();
      } catch (err) {
        console.error('Error loading invoices:', err);
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>Unable to Load Invoices</h3>
            <p>Please try again or create a new invoice.</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
      }
    }

    // Sync paid invoices and customers from Stripe to local database
    async function syncFromStripe() {
      console.log('[Sync] Starting sync from Stripe...');
      const btn = document.getElementById('sync-stripe-btn');
      if (!btn) {
        console.error('[Sync] Sync button not found');
        return;
      }
      const originalHtml = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;"></span> Syncing...';

        if (!supabaseClient) {
          throw new Error('Database connection not ready');
        }

        if (!API_URL) {
          throw new Error('API URL not configured');
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');
        console.log('[Sync] User authenticated:', user.id);

        // Fetch paid invoices from Stripe via authenticated API (one-time import)
        console.log('[Sync] Fetching paid invoices from Stripe...');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

        let response;
        try {
          response = await apiCall('/api/invoices?status=paid&limit=100', {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          if (fetchErr.name === 'AbortError') {
            throw new Error('Stripe API timed out. The server may be starting up - please try again in a moment.');
          }
          throw fetchErr;
        }

        if (!response.ok) throw new Error('Failed to fetch Stripe invoices: ' + response.status);

        const { invoices: stripeInvoices } = await response.json();
        console.log('[Sync] Found', stripeInvoices?.length || 0, 'paid invoices');

        if (!stripeInvoices || stripeInvoices.length === 0) {
          showToast('No paid invoices found in Stripe', 'info');
          return;
        }

        let customersCreated = 0;
        let invoicesSynced = 0;
        let jobsCreated = 0;
        let errors = [];

        for (const inv of stripeInvoices) {
          if (!inv.customer_email) {
            console.log('[Sync] Skipping invoice without email:', inv.id);
            continue;
          }

          console.log('[Sync] Processing:', inv.customer_name, inv.customer_email);

          // Step 1: Check/create customer (always do this)
          let customerId = null;
          try {
            const { data: existingCustomer } = await supabaseClient
              .from('customers')
              .select('id')
              .eq('user_id', user.id)
              .eq('email', inv.customer_email)
              .single();

            if (existingCustomer) {
              customerId = existingCustomer.id;
              console.log('[Sync] Found existing customer:', customerId);
            } else {
              const { data: newCustomer, error: custErr } = await supabaseClient
                .from('customers')
                .insert({
                  user_id: user.id,
                  name: inv.customer_name || 'Customer',
                  email: inv.customer_email,
                  phone: inv.customer_phone || null,
                  source: 'stripe_sync'
                })
                .select()
                .single();

              if (!custErr && newCustomer) {
                customerId = newCustomer.id;
                customersCreated++;
                console.log('[Sync] Created customer:', customerId);
              } else if (custErr) {
                console.error('[Sync] Customer error:', custErr.message);
                errors.push(`Customer ${inv.customer_email}: ${custErr.message}`);
              }
            }
          } catch (e) {
            console.error('[Sync] Customer exception:', e);
          }

          // Step 2: Try to create invoice (may fail if columns don't exist - that's OK)
          let invoiceId = null;
          try {
            // Check if invoice exists by number
            const { data: existingInvoice } = await supabaseClient
              .from('invoices')
              .select('id')
              .eq('invoice_number', inv.number)
              .single();

            if (existingInvoice) {
              invoiceId = existingInvoice.id;
              console.log('[Sync] Invoice already exists:', invoiceId);
            } else {
              // Try with all columns first
              const invoiceData = {
                user_id: user.id,
                invoice_number: inv.number || `STR-${inv.id.slice(-8)}`,
                customer_id: customerId,
                customer_name: inv.customer_name || 'Customer',
                customer_email: inv.customer_email,
                total: inv.amount_paid || 0,
                status: 'paid',
                paid_at: new Date().toISOString()
              };

              // Add optional stripe columns (may not exist)
              try {
                invoiceData.amount_paid = inv.amount_paid || 0;
                invoiceData.amount_due = 0;
                invoiceData.stripe_invoice_id = inv.id;
                invoiceData.stripe_hosted_url = inv.hosted_invoice_url;
                invoiceData.stripe_pdf_url = inv.pdf;
              } catch (e) {}

              const { data: newInvoice, error: invErr } = await supabaseClient
                .from('invoices')
                .insert(invoiceData)
                .select()
                .single();

              if (!invErr && newInvoice) {
                invoiceId = newInvoice.id;
                invoicesSynced++;
                console.log('[Sync] Created invoice:', invoiceId);
              } else if (invErr) {
                console.error('[Sync] Invoice error:', invErr.message);
                // Try minimal insert without stripe columns
                const { data: minInvoice, error: minErr } = await supabaseClient
                  .from('invoices')
                  .insert({
                    user_id: user.id,
                    invoice_number: inv.number || `STR-${inv.id.slice(-8)}`,
                    customer_id: customerId,
                    customer_name: inv.customer_name || 'Customer',
                    customer_email: inv.customer_email,
                    total: inv.amount_paid || 0,
                    status: 'paid'
                  })
                  .select()
                  .single();

                if (!minErr && minInvoice) {
                  invoiceId = minInvoice.id;
                  invoicesSynced++;
                  console.log('[Sync] Created invoice (minimal):', invoiceId);
                }
              }
            }
          } catch (e) {
            console.error('[Sync] Invoice exception:', e);
          }

          // Step 3: Create job (even if invoice failed, as long as we have customer)
          if (customerId) {
            try {
              // Check if job exists for this customer email
              const { data: existingJob } = await supabaseClient
                .from('projects')
                .select('id')
                .eq('user_id', user.id)
                .eq('customer_email', inv.customer_email)
                .single();

              if (!existingJob) {
                const jobNum = `JOB-${Date.now().toString(36).toUpperCase()}`;
                const jobData = {
                  user_id: user.id,
                  job_number: jobNum,
                  customer_id: customerId,
                  customer_name: inv.customer_name || 'Customer',
                  customer_email: inv.customer_email,
                  contract_amount: inv.amount_paid || 0,
                  total_paid: inv.amount_paid || 0,
                  deposit_paid: true,
                  status: 'new'
                };

                if (invoiceId) jobData.invoice_id = invoiceId;

                const { error: jobErr } = await supabaseClient
                  .from('projects')
                  .insert(jobData);

                if (!jobErr) {
                  jobsCreated++;
                  console.log('[Sync] Created job:', jobNum);
                } else {
                  console.error('[Sync] Job error:', jobErr.message);
                }
              } else {
                console.log('[Sync] Job already exists for customer');
              }
            } catch (e) {
              console.error('[Sync] Job exception:', e);
            }
          }
        }

        showToast(`Synced: ${customersCreated} customers, ${invoicesSynced} invoices, ${jobsCreated} jobs`);

        // Reload data
        await Promise.all([loadInvoices(), loadCustomers(), loadJobs()]);

      } catch (err) {
        console.error('Sync error:', err);
        showToast('Sync failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    function filterInvoices(status) {
      invoiceFilter = status;
      document.querySelectorAll('[data-invoice-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.invoiceStatus === status);
      });
      renderInvoices();
    }

    async function voidInvoice(invoiceId) {
      if (!confirm('Void this invoice? The customer will no longer be able to pay it.')) return;

      try {
        // Check if it's a Stripe invoice (starts with 'in_')
        if (invoiceId.startsWith('in_')) {
          // Void via Stripe API
          const response = await apiCall(`/api/invoices/${invoiceId}/void`, {
            method: 'POST'
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to void invoice');
          }
        } else {
          // Supabase invoice - update status directly
          const { error } = await supabaseClient
            .from('invoices')
            .update({ status: 'void' })
            .eq('id', invoiceId);

          if (error) throw error;
        }

        loadInvoices();
        showToast('Invoice voided');
      } catch (err) {
        console.error('Void invoice error:', err);
        alert('Error voiding invoice: ' + err.message);
      }
    }

    function renderInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      let filtered = allInvoices;
      // Filter by status
      if (invoiceFilter !== 'all') {
        if (invoiceFilter === 'viewed') {
          // Filter for invoices that have been viewed
          filtered = filtered.filter(inv => inv.view_count > 0);
        } else {
          filtered = filtered.filter(inv => inv.status === invoiceFilter);
        }
      }

      if (filtered.length === 0) {
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>No invoices found</h3>
            <p>${invoiceFilter !== 'all' ? 'No invoices with this status.' : 'Create your first invoice to get started.'}</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
        return;
      }

      // Modern card-based list for invoices
      invoicesList.innerHTML = `
        <div class="list-modern">
          ${filtered.map(inv => {
            const statusColor = inv.status === 'paid' ? '#22c55e' : inv.status === 'open' ? '#3b82f6' : inv.status === 'void' ? '#ef4444' : inv.status === 'draft' ? '#6b7280' : '#f59e0b';
            const viewedInfo = inv.view_count > 0 ? `Viewed ${inv.view_count}x` : '';
            return `
            <div class="list-item-modern"
                 onclick="viewSupabaseInvoice('${inv.id}')"
                 data-context-menu="invoice"
                 data-item-id="${inv.id}"
                 data-item-data='${JSON.stringify({ invoice_number: inv.number, status: inv.status, hosted_invoice_url: inv.stripe_hosted_url, pdf_url: inv.stripe_pdf_url, customer_name: inv.customer_name, source: inv.source }).replace(/'/g, "&#39;")}'>
              <div class="list-item-icon" style="background: ${statusColor}20; color: ${statusColor};">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">#${inv.number || inv.id.slice(-8)}</div>
                <div class="list-item-subtitle">${inv.customer_name || 'No customer'} ${inv.customer_email ? ' ' + inv.customer_email : ''}</div>
                <div class="list-item-subtitle" style="margin-top: 2px;">
                  Due: ${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'Not set'}
                  ${viewedInfo ? `<span style="color: #22c55e; margin-left: 8px;">${viewedInfo}</span>` : ''}
                </div>
              </div>
              <div class="list-item-meta">
                <div style="font-weight: 700; font-size: 15px; color: var(--gold-primary); margin-bottom: 4px;">$${(inv.amount_due || 0).toFixed(2)}</div>
                <span class="badge-modern" style="background: ${statusColor}20; color: ${statusColor};">${inv.status}</span>
              </div>
            </div>
          `;}).join('')}
        </div>
      `;
    }

    function openInvoiceModal(customer = null) {
      document.getElementById('invoice-modal').classList.add('active');
      document.getElementById('invoice-form').reset();
      document.getElementById('invoice-items').innerHTML = `
        <div class="invoice-item" data-index="0">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      invoiceItemCount = 1;
      updateInvoiceTotal();

      // Pre-fill customer details if provided
      if (customer) {
        if (customer.email) {
          document.getElementById('invoice-email').value = customer.email;
        }
        if (customer.name) {
          document.getElementById('invoice-name').value = customer.name;
        }
        if (customer.phone) {
          document.getElementById('invoice-phone').value = customer.phone;
        }
      }
    }

    function closeInvoiceModal() {
      document.getElementById('invoice-modal').classList.remove('active');
    }

    // Template Preview Modal Functions
    const templatePreviews = {
      classic: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #f4f4f4;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <tr>
            <td style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; text-align: center;">
              <h1 style="color: #f9cb00; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 1px;">Surprise Granite</h1>
              <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0; font-size: 14px;">Premium Countertops & Expert Installation</p>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 40px 20px; border-bottom: 2px solid #f9cb00;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h2 style="margin: 0; color: #1a1a2e; font-size: 32px; font-weight: 300;">INVOICE</h2>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px;"><strong>Date:</strong> Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #1a1a2e; font-size: 14px;"><strong>Due:</strong> Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Bill To</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 16px; font-weight: 600;">John Smith</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">From</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px; font-weight: 600;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 13px;">14155 W. Bell Road, Suite 100</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 30px;">
              <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: collapse;">
                <tr style="background-color: #1a1a2e;">
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Description</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: center;">Qty</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: right;">Amount</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Kitchen Countertop - Granite</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$2,500.00</td>
                </tr>
                <tr style="background-color: #ffffff;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Installation Labor</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$800.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" style="background-color: #1a1a2e; padding: 20px; border-radius: 8px;">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700;">TOTAL</td>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700; text-align: right;">$3,300.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px; text-align: center;">
              <a href="javascript:void(0)" style="display: inline-block; background: linear-gradient(135deg, #f9cb00 0%, #e6b800 100%); color: #1a1a2e; text-decoration: none; padding: 18px 50px; border-radius: 50px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(249, 203, 0, 0.4);">Pay Now</a>
            </td>
          </tr>
          <tr>
            <td style="background-color: #f9f9f9; padding: 30px 40px; text-align: center; border-top: 1px solid #eee;">
              <p style="margin: 0 0 10px; color: #666; font-size: 14px;">Questions? Contact us at <a href="javascript:void(0)" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a></p>
              <p style="margin: 0; color: #999; font-size: 12px;">Surprise Granite Marble & Quartz</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      modern: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="center" style="padding: 60px 20px;">
        <table role="presentation" width="550" cellspacing="0" cellpadding="0">
          <tr>
            <td style="padding-bottom: 40px; border-bottom: 1px solid #eee;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h1 style="margin: 0; color: #000; font-size: 24px; font-weight: 800; letter-spacing: -0.5px;">SURPRISE<span style="color: #f9cb00;">GRANITE</span></h1>
                    <p style="margin: 4px 0 0; color: #888; font-size: 12px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #000; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;">Invoice</p>
                    <p style="margin: 4px 0 0; color: #f9cb00; font-size: 20px; font-weight: 700;">#INV-2024-001</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Billed To</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 18px; font-weight: 600;">John Smith</p>
                    <p style="margin: 4px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" align="right">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Invoice Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">January 7, 2025</p>
                    <p style="margin: 20px 0 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Due Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">February 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Kitchen Countertop - Granite</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$2,500.00</p>
                  </td>
                </tr>
              </table>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Installation Labor</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$800.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" align="right">
                    <p style="margin: 0; padding: 15px 0; color: #000; font-size: 20px; font-weight: 700;">Total</p>
                    <p style="margin: 0; color: #000; font-size: 24px; font-weight: 700;">$3,300.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 20px 0 50px; text-align: center;">
              <a href="javascript:void(0)" style="display: inline-block; background-color: #000; color: #fff; text-decoration: none; padding: 16px 60px; font-size: 14px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;">Pay Invoice </a>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0; border-top: 1px solid #eee; text-align: center;">
              <p style="margin: 0; color: #888; font-size: 13px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;"><a href="javascript:void(0)" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a>  <a href="javascript:void(0)" style="color: #f9cb00; text-decoration: none;">(602) 833-3189</a></p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      premium: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #0a0a12; font-family: 'Georgia', 'Times New Roman', serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #0a0a12;">
    <tr>
      <td align="center" style="padding: 50px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0">
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 12px; letter-spacing: 4px; text-transform: uppercase;">Premium Quality</p>
              <h1 style="margin: 15px 0 0; color: #ffffff; font-size: 36px; font-weight: 400; letter-spacing: 3px;">SURPRISE GRANITE</h1>
              <p style="margin: 10px 0 0; color: #888; font-size: 14px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 3px; text-transform: uppercase;">Invoice Number</p>
                    <p style="margin: 8px 0 0; color: #ffffff; font-size: 24px; font-weight: 300;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #888; font-size: 13px;">Issue Date: Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">Due: Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Bill To</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 20px; font-weight: 400;">John Smith</p>
                    <p style="margin: 8px 0 0; color: #888; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">From</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 14px;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">(602) 833-3189</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="padding: 20px 50px; border-bottom: 1px solid rgba(249, 203, 0, 0.2);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Description</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: center;" width="80">Qty</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: right;" width="120">Amount</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Kitchen Countertop - Granite</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$2,500.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Installation Labor</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$800.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background: linear-gradient(135deg, #f9cb00 0%, #d4a800 100%); padding: 30px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="color: #1a1a2e; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">Total Amount</td>
                  <td align="right" style="color: #1a1a2e; font-size: 32px; font-weight: 700;">$3,300.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <a href="javascript:void(0)" style="display: inline-block; border: 2px solid #f9cb00; color: #f9cb00; text-decoration: none; padding: 18px 60px; font-size: 13px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase;">PAY INVOICE</a>
              <p style="margin: 30px 0 0; color: #666; font-size: 13px;">Secure payment powered by Stripe</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #0a0a12; padding: 40px 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 2px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 15px 0 0; color: #666; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 10px 0 0; color: #666; font-size: 12px;">info@surprisegranite.com  (602) 833-3189</p>
              <p style="margin: 20px 0 0; color: #444; font-size: 11px;">Thank you for choosing Surprise Granite for your project.</p>
            </td>
          </tr>
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`
    };

    function openTemplatePreview() {
      document.getElementById('template-preview-modal').classList.add('active');
      // Load the classic template by default
      showTemplatePreview('classic');
    }

    function closeTemplatePreview() {
      document.getElementById('template-preview-modal').classList.remove('active');
    }

    function showTemplatePreview(templateName) {
      // Update active tab
      document.querySelectorAll('.template-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.template === templateName) {
          tab.classList.add('active');
        }
      });

      // Show corresponding preview frame
      document.querySelectorAll('.template-preview-frame').forEach(frame => {
        frame.style.display = 'none';
      });
      const activeFrame = document.getElementById('template-frame-' + templateName);
      if (activeFrame) {
        activeFrame.style.display = 'block';
        // Load the template content into the iframe
        const iframe = document.getElementById('preview-iframe-' + templateName);
        if (iframe && templatePreviews[templateName]) {
          iframe.srcdoc = templatePreviews[templateName];
        }
      }
    }

    // Close template preview modal on click outside
    document.getElementById('template-preview-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeTemplatePreview();
    });

    function addInvoiceItem() {
      const container = document.getElementById('invoice-items');
      const itemHTML = `
        <div class="invoice-item" data-index="${invoiceItemCount}">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Installation Labor"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', itemHTML);
      invoiceItemCount++;
    }

    function removeInvoiceItem(btn) {
      const items = document.querySelectorAll('.invoice-item');
      if (items.length > 1) {
        btn.closest('.invoice-item').remove();
        updateInvoiceTotal();
      }
    }

    function updateInvoiceTotal() {
      const items = document.querySelectorAll('.invoice-item');
      let total = 0;
      items.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
        const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
        total += qty * amount;
      });
      document.getElementById('invoice-total').textContent = `$${total.toFixed(2)}`;
    }

    // Get invoice form data helper
    function getInvoiceFormData() {
      const items = [];
      document.querySelectorAll('.invoice-item').forEach(item => {
        items.push({
          description: item.querySelector('.item-description').value,
          quantity: parseInt(item.querySelector('.item-qty').value) || 1,
          amount: parseFloat(item.querySelector('.item-amount').value) || 0
        });
      });

      return {
        items,
        customerEmail: document.getElementById('invoice-email').value,
        customerName: document.getElementById('invoice-name').value,
        customerPhone: document.getElementById('invoice-phone').value,
        dueDays: parseInt(document.getElementById('invoice-due-days').value) || 30,
        notes: document.getElementById('invoice-notes').value,
        selectedTemplate: document.querySelector('input[name="invoice-template"]:checked')?.value || 'classic',
        ccMe: document.getElementById('invoice-cc-me')?.checked ?? true,
        ccOther: document.getElementById('invoice-cc-other')?.value || ''
      };
    }

    // Save invoice as draft (no email sent)
    async function saveInvoiceDraft() {
      const btn = document.getElementById('invoice-draft-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        const formData = getInvoiceFormData();
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        const total = formData.items.reduce((sum, item) => sum + (item.quantity * item.amount), 0);
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        const { data: invoice, error } = await supabaseClient
          .from('invoices')
          .insert({
            user_id: user.id,
            invoice_number: invoiceNumber,
            customer_email: formData.customerEmail,
            customer_name: formData.customerName,
            customer_phone: formData.customerPhone,
            subtotal: total,
            total: total,
            amount_due: total,
            amount_paid: 0,
            due_date: new Date(Date.now() + formData.dueDays * 24 * 60 * 60 * 1000).toISOString(),
            notes: formData.notes,
            status: 'draft'
          })
          .select()
          .single();

        if (error) throw error;

        // Save items
        if (formData.items.length > 0) {
          const invoiceItems = formData.items.map(item => ({
            invoice_id: invoice.id,
            description: item.description,
            name: item.description,
            quantity: item.quantity,
            unit_price: item.amount,
            total: item.quantity * item.amount
          }));
          await supabaseClient.from('invoice_items').insert(invoiceItems);
        }

        closeInvoiceModal();
        loadInvoices();
        showToast(`Invoice #${invoiceNumber} saved as draft`, 'success');
      } catch (err) {
        showToast('Error saving draft: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg> Save Draft';
      }
    }

    // Preview invoice before sending
    async function previewInvoice() {
      console.log('[Invoices] previewInvoice called');
      const formData = getInvoiceFormData();
      console.log('[Invoices] previewInvoice formData:', formData);

      if (!formData.customerEmail) {
        showToast('Please enter customer email', 'warning');
        return;
      }
      if (formData.items.length === 0 || !formData.items[0].description) {
        showToast('Please add at least one line item', 'warning');
        return;
      }

      const total = formData.items.reduce((sum, item) => sum + (item.quantity * item.amount), 0);
      const dueDate = new Date(Date.now() + formData.dueDays * 24 * 60 * 60 * 1000);

      // Build CC list for display
      const ccList = [];
      if (formData.ccMe && userProfile?.email) ccList.push(userProfile.email);
      if (formData.ccOther) ccList.push(formData.ccOther);

      const previewHtml = `
        <div style="max-width: 600px; margin: 0 auto; font-family: system-ui, sans-serif;">
          <div style="background: var(--dark-elevated); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 16px; color: var(--gold-primary);">Invoice Preview</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div>
                <div style="color: var(--text-muted); font-size: 12px;">TO</div>
                <div style="font-weight: 600;">${formData.customerName || 'Customer'}</div>
                <div style="color: var(--text-secondary);">${formData.customerEmail}</div>
                ${formData.customerPhone ? `<div style="color: var(--text-secondary);">${formData.customerPhone}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="color: var(--text-muted); font-size: 12px;">DUE DATE</div>
                <div style="font-weight: 600;">${dueDate.toLocaleDateString()}</div>
                <div style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">TEMPLATE</div>
                <div>${formData.selectedTemplate.charAt(0).toUpperCase() + formData.selectedTemplate.slice(1)}</div>
              </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-subtle);">
                  <th style="text-align: left; padding: 8px 0; color: var(--text-muted); font-size: 12px;">ITEM</th>
                  <th style="text-align: center; padding: 8px 0; color: var(--text-muted); font-size: 12px;">QTY</th>
                  <th style="text-align: right; padding: 8px 0; color: var(--text-muted); font-size: 12px;">AMOUNT</th>
                </tr>
              </thead>
              <tbody>
                ${formData.items.map(item => `
                  <tr style="border-bottom: 1px solid var(--border-subtle);">
                    <td style="padding: 12px 0;">${item.description || 'Item'}</td>
                    <td style="text-align: center; padding: 12px 0;">${item.quantity}</td>
                    <td style="text-align: right; padding: 12px 0;">$${(item.quantity * item.amount).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div style="text-align: right; font-size: 20px; font-weight: 700; color: var(--gold-primary);">
              Total: $${total.toFixed(2)}
            </div>

            ${formData.notes ? `
              <div style="margin-top: 16px; padding: 12px; background: var(--dark-surface); border-radius: 8px;">
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">NOTES</div>
                <div style="color: var(--text-secondary);">${formData.notes}</div>
              </div>
            ` : ''}

            ${ccList.length > 0 ? `
              <div style="margin-top: 16px; padding: 12px; background: rgba(249, 203, 0, 0.1); border-radius: 8px; border-left: 3px solid var(--gold-primary);">
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">CC COPY TO</div>
                <div style="color: var(--text-secondary);">${ccList.join(', ')}</div>
              </div>
            ` : ''}
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn-modern secondary" id="preview-edit-btn">Edit Invoice</button>
            <button class="btn-modern primary" id="preview-send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              Send Invoice
            </button>
          </div>
        </div>
      `;

      // Create preview modal
      let previewModal = document.getElementById('invoice-preview-modal');
      if (!previewModal) {
        previewModal = document.createElement('div');
        previewModal.id = 'invoice-preview-modal';
        previewModal.className = 'modal-overlay';
        previewModal.innerHTML = `<div class="modal" style="max-width: 700px;">${previewHtml}</div>`;
        previewModal.addEventListener('click', (e) => {
          if (e.target === previewModal) previewModal.classList.remove('active');
        });
        document.body.appendChild(previewModal);
      } else {
        previewModal.querySelector('.modal').innerHTML = previewHtml;
      }

      // Attach button handlers after modal is created
      const editBtn = previewModal.querySelector('#preview-edit-btn');
      const sendBtn = previewModal.querySelector('#preview-send-btn');
      if (editBtn) {
        editBtn.onclick = () => previewModal.classList.remove('active');
      }
      if (sendBtn) {
        sendBtn.onclick = () => {
          console.log('[Invoices] Send button clicked');
          confirmSendInvoice();
        };
      }

      previewModal.classList.add('active');
      console.log('[Invoices] Preview modal shown');
    }

    // Confirm and send invoice after preview
    async function confirmSendInvoice() {
      console.log('[Invoices] confirmSendInvoice called');
      document.getElementById('invoice-preview-modal')?.classList.remove('active');
      try {
        await createInvoice(new Event('submit'));
      } catch (err) {
        console.error('[Invoices] confirmSendInvoice error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    let isCreatingInvoice = false; // Guard against double-clicks

    async function createInvoice(e) {
      console.log('[Invoices] createInvoice called, isCreating:', isCreatingInvoice);
      if (e && e.preventDefault) e.preventDefault();

      // Prevent double-submission
      if (isCreatingInvoice) {
        console.log('[Invoices] Already creating an invoice, ignoring');
        return;
      }
      isCreatingInvoice = true;

      const btn = document.getElementById('invoice-preview-btn');
      const sendBtn = document.getElementById('preview-send-btn');

      // Disable both buttons if they exist
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Creating...';
      }
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner"></span> Sending...';
      }

      let formData;
      try {
        formData = getInvoiceFormData();
        console.log('[Invoices] Form data:', formData);
      } catch (formErr) {
        console.error('[Invoices] Form data error:', formErr);
        showToast('Error reading form data', 'error');
        isCreatingInvoice = false;
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Preview & Send';
        }
        return;
      }

      const { items, customerEmail, customerName, customerPhone, dueDays, notes, selectedTemplate, ccMe, ccOther } = formData;

      // Build CC recipients list
      const ccRecipients = [];
      if (ccMe && userProfile?.email) ccRecipients.push(userProfile.email);
      if (ccOther && ccOther.trim()) ccRecipients.push(ccOther.trim());

      try {
        console.log('[Invoices] Getting user...');
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        if (authError) {
          console.error('[Invoices] Auth error:', authError);
          throw new Error('Authentication error: ' + authError.message);
        }
        if (!user) throw new Error('Not authenticated');
        console.log('[Invoices] User:', user.id);

        // Calculate total from items
        const total = items.reduce((sum, item) => sum + (item.quantity * item.amount), 0);
        console.log('[Invoices] Total:', total, 'Email:', customerEmail);
        if (total <= 0) throw new Error('Invoice total must be greater than $0');
        if (!customerEmail) throw new Error('Customer email is required');

        // Generate invoice number
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        console.log('[Invoices] Creating invoice:', invoiceNumber, 'for', customerEmail);

        // Step 1: Create invoice in Supabase (single source of truth)
        const { data: invoice, error: invoiceError } = await supabaseClient
          .from('invoices')
          .insert({
            user_id: user.id,
            invoice_number: invoiceNumber,
            customer_email: customerEmail,
            customer_name: customerName,
            customer_phone: customerPhone,
            subtotal: total,
            total: total,
            amount_due: total,
            amount_paid: 0,
            due_date: new Date(Date.now() + dueDays * 24 * 60 * 60 * 1000).toISOString(),
            notes: notes,
            status: 'draft'
          })
          .select()
          .single();

        if (invoiceError) {
          console.error('[Invoices] Supabase insert error:', invoiceError);
          throw invoiceError;
        }

        console.log('[Invoices] Supabase invoice created:', invoice.id);

        // Step 2: Create invoice items in Supabase
        if (items.length > 0) {
          const invoiceItems = items.map(item => ({
            invoice_id: invoice.id,
            description: item.description,
            name: item.description,
            quantity: item.quantity,
            unit_price: item.amount,
            total: item.quantity * item.amount
          }));

          const { error: itemsError } = await supabaseClient.from('invoice_items').insert(invoiceItems);
          if (itemsError) console.warn('[Invoices] Items insert error:', itemsError);
        }

        // Close modal and show success IMMEDIATELY - don't wait for Stripe
        closeInvoiceModal();
        isCreatingInvoice = false; // Reset guard
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> Preview & Send';
        }
        console.log('[Invoices] Invoice created successfully:', invoiceNumber);
        showToast(`Invoice #${invoiceNumber} created! Sending email...`, 'success');
        loadInvoices();

        // Step 3: Create Stripe invoice in background (non-blocking)
        (async () => {
          try {
            console.log('[Invoices] Starting Stripe API call for:', customerEmail);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

            const response = await apiCall('/api/invoices', {
              method: 'POST',
              signal: controller.signal,
              body: JSON.stringify({
                customer_email: customerEmail,
                customer_name: customerName,
                customer_phone: customerPhone,
                items,
                due_days: dueDays,
                notes: notes,
                auto_send: true,
                template: selectedTemplate,
                cc_recipients: ccRecipients
              })
            });

            clearTimeout(timeoutId);
            console.log('[Invoices] Stripe API response status:', response.status);

            if (response.ok) {
              const stripeData = await response.json();
              console.log('[Invoices] Stripe response data:', stripeData);
              const stripeInvoiceId = stripeData.invoice?.id;
              const stripeHostedUrl = stripeData.invoice?.hosted_invoice_url;

              if (stripeInvoiceId) {
                await supabaseClient
                  .from('invoices')
                  .update({
                    stripe_invoice_id: stripeInvoiceId,
                    stripe_hosted_url: stripeHostedUrl,
                    status: 'open'
                  })
                  .eq('id', invoice.id);

                console.log('[Invoices] Stripe invoice created and linked:', stripeInvoiceId);
                showToast(`Invoice emailed to ${customerEmail}!`, 'success');
                loadInvoices(); // Refresh to show updated status
              } else {
                console.error('[Invoices] Stripe response missing invoice ID:', stripeData);
                showToast('Invoice saved but email may not have sent', 'warning');
              }
            } else {
              const errorText = await response.text();
              console.error('[Invoices] Stripe API error:', response.status, errorText);
              showToast(`Email delivery failed (${response.status}). Invoice saved locally.`, 'error');
            }
          } catch (stripeErr) {
            if (stripeErr.name === 'AbortError') {
              console.error('[Invoices] Stripe API timed out after 30s');
              showToast('Email service timed out. Invoice saved, please resend manually.', 'warning');
            } else {
              console.error('[Invoices] Stripe error:', stripeErr);
              showToast('Email failed: ' + stripeErr.message, 'error');
            }
          }
        })();

      } catch (err) {
        console.error('[Invoices] Create error:', err);
        showToast('Error creating invoice: ' + err.message, 'error');
        isCreatingInvoice = false; // Reset guard
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> Preview & Send';
        }
        const sendBtn = document.getElementById('preview-send-btn');
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = 'Send Invoice';
        }
      }
    }

    async function sendReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        const response = await apiCall(`/api/invoices/${invoiceId}/remind`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to send reminder');
        }

        alert('Payment reminder sent!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Invoice modal click-outside to close
    document.getElementById('invoice-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeInvoiceModal();
    });

    // ============ SUPABASE INVOICE FUNCTIONS ============
    async function viewSupabaseInvoice(invoiceId) {
      try {
        // First check if this is a Stripe-only invoice (starts with 'in_')
        const stripeOnlyInvoice = allInvoices.find(inv => inv.id === invoiceId && inv.source === 'stripe');
        if (stripeOnlyInvoice) {
          // For Stripe-only invoices, open the hosted URL or show basic info
          if (stripeOnlyInvoice.stripe_hosted_url) {
            window.open(stripeOnlyInvoice.stripe_hosted_url, '_blank');
            return;
          }
          // Fallback: show what we have from Stripe
          const invoiceHtml = `
            <html>
            <head><title>Invoice #${stripeOnlyInvoice.number}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
              .header { border-bottom: 3px solid #f9cb00; padding-bottom: 20px; margin-bottom: 30px; }
              .header h1 { color: #1a1a2e; margin: 0; }
              .info-box { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
              .status { display: inline-block; padding: 6px 16px; border-radius: 20px; font-weight: 600; }
              .status-paid { background: #d1fae5; color: #059669; }
              .status-open { background: #fef3c7; color: #d97706; }
            </style>
            </head>
            <body>
              <div class="header"><h1>Surprise Granite</h1><p>Marble & Quartz</p></div>
              <h2>Invoice #${stripeOnlyInvoice.number}</h2>
              <div class="info-box">
                <p><strong>Customer:</strong> ${stripeOnlyInvoice.customer_name || stripeOnlyInvoice.customer_email || 'N/A'}</p>
                <p><strong>Status:</strong> <span class="status status-${stripeOnlyInvoice.status}">${stripeOnlyInvoice.status}</span></p>
                <p><strong>Amount Due:</strong> $${(stripeOnlyInvoice.amount_due || 0).toFixed(2)}</p>
                <p><strong>Due Date:</strong> ${stripeOnlyInvoice.due_date ? new Date(stripeOnlyInvoice.due_date).toLocaleDateString() : 'N/A'}</p>
              </div>
              <p style="color: #666;">This invoice was created in Stripe. For full details, view in the Stripe Dashboard.</p>
            </body>
            </html>
          `;
          const win = window.open('', '_blank');
          win.document.write(invoiceHtml);
          win.document.close();
          return;
        }

        // For Supabase invoices, fetch full details
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*, invoice_items(*)')
          .eq('id', invoiceId)
          .single();

        if (!invoice) {
          alert('Invoice not found');
          return;
        }

        // Create a simple invoice view modal or open in new tab
        const invoiceHtml = `
          <html>
          <head><title>Invoice #${invoice.invoice_number}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
            .header { border-bottom: 3px solid #f9cb00; padding-bottom: 20px; margin-bottom: 30px; }
            .header h1 { color: #1a1a2e; margin: 0; }
            .header p { color: #666; margin: 5px 0 0; }
            .info-row { display: flex; justify-content: space-between; margin-bottom: 30px; }
            .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { background: #f8f9fa; font-weight: 600; }
            .total-row { font-size: 18px; font-weight: bold; color: #f9cb00; }
            .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
            .status-open { background: #fef3c7; color: #d97706; }
            .status-paid { background: #d1fae5; color: #059669; }
            @media print { body { padding: 20px; } }
          </style>
          </head>
          <body>
            <div class="header">
              <h1>Surprise Granite</h1>
              <p>Marble & Quartz</p>
            </div>
            <h2>Invoice #${invoice.invoice_number}</h2>
            <div class="info-row">
              <div class="info-box">
                <strong>Bill To:</strong><br>
                ${invoice.customer_name || 'N/A'}<br>
                ${invoice.customer_email || ''}<br>
                ${invoice.customer_phone || ''}
              </div>
              <div class="info-box">
                <strong>Status:</strong> <span class="status status-${invoice.status}">${invoice.status}</span><br>
                <strong>Due Date:</strong> ${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A'}<br>
                <strong>Created:</strong> ${new Date(invoice.created_at).toLocaleDateString()}
              </div>
            </div>
            <table>
              <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
              <tbody>
                ${(invoice.invoice_items || []).map(item => `
                  <tr>
                    <td>${item.description || item.name || 'Item'}</td>
                    <td>${item.quantity || 1}</td>
                    <td>$${(item.unit_price || 0).toFixed(2)}</td>
                    <td>$${(item.total || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <table style="width: 300px; margin-left: auto;">
              <tr><td>Subtotal:</td><td style="text-align: right;">$${(invoice.subtotal || invoice.total || 0).toFixed(2)}</td></tr>
              ${invoice.tax_amount ? `<tr><td>Tax:</td><td style="text-align: right;">$${invoice.tax_amount.toFixed(2)}</td></tr>` : ''}
              <tr class="total-row"><td>Total:</td><td style="text-align: right;">$${(invoice.total || 0).toFixed(2)}</td></tr>
              <tr><td>Amount Paid:</td><td style="text-align: right;">$${(invoice.amount_paid || 0).toFixed(2)}</td></tr>
              <tr style="font-weight: bold;"><td>Amount Due:</td><td style="text-align: right;">$${(invoice.amount_due || invoice.total || 0).toFixed(2)}</td></tr>
            </table>
            ${invoice.notes ? `<div style="margin-top: 30px; padding: 15px; background: #fffbeb; border-radius: 8px;"><strong>Notes:</strong><br>${invoice.notes}</div>` : ''}
            <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px;">
              <p>Surprise Granite | (602) 833-3189 | info@surprisegranite.com</p>
            </div>
          </body>
          </html>
        `;

        const win = window.open('', '_blank');
        win.document.write(invoiceHtml);
        win.document.close();
      } catch (err) {
        console.error('View invoice error:', err);
        alert('Error viewing invoice');
      }
    }

    async function sendSupabaseInvoice(invoiceId) {
      if (!confirm('Send this invoice to the customer?')) return;

      try {
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*, invoice_items(*)')
          .eq('id', invoiceId)
          .single();

        if (!invoice || !invoice.customer_email) {
          alert('Invoice not found or missing customer email');
          return;
        }

        // Send via email API
        const response = await apiCall('/api/send-invoice-email', {
          method: 'POST',
          body: JSON.stringify({
            customer_email: invoice.customer_email,
            customer_name: invoice.customer_name,
            invoice_number: invoice.invoice_number,
            items: invoice.invoice_items,
            subtotal: invoice.subtotal,
            tax_amount: invoice.tax_amount,
            total: invoice.total,
            due_date: invoice.due_date,
            notes: invoice.notes
          })
        });

        if (response.ok) {
          showToast('Invoice sent!');
          // Update status
          await supabaseClient.from('invoices').update({ status: 'sent' }).eq('id', invoiceId);
          loadInvoices();

          // Send SMS notification (email already sent by API)
          sendNotification('invoice', 'sent', invoice, {
            email: null, // Already sent by email API
            phone: invoice.customer_phone,
            name: invoice.customer_name
          });
        } else {
          // Fallback to email client
          const subject = encodeURIComponent(`Invoice #${invoice.invoice_number} from Surprise Granite`);
          const body = encodeURIComponent(`Hi ${invoice.customer_name},\n\nPlease find your invoice #${invoice.invoice_number} for $${invoice.total.toFixed(2)}.\n\nDue date: ${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'Upon receipt'}\n\nThank you,\nSurprise Granite`);
          window.open(`mailto:${invoice.customer_email}?subject=${subject}&body=${body}`);
          showToast('Email client opened');
        }
      } catch (err) {
        console.error('Send invoice error:', err);
        alert('Error sending invoice');
      }
    }

    async function deleteSupabaseInvoice(invoiceId) {
      if (!confirm('Delete this invoice? This cannot be undone.')) return;

      try {
        // Delete invoice items first
        await supabaseClient.from('invoice_items').delete().eq('invoice_id', invoiceId);
        // Delete invoice
        await supabaseClient.from('invoices').delete().eq('id', invoiceId);

        showToast('Invoice deleted');
        loadInvoices();
      } catch (err) {
        console.error('Delete invoice error:', err);
        alert('Error deleting invoice');
      }
    }

    async function sendInvoiceReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        // Check if it's a Stripe invoice (starts with 'in_')
        if (invoiceId.startsWith('in_')) {
          // Use Stripe API
          const response = await apiCall(`/api/invoices/${invoiceId}/remind`, {
            method: 'POST'
          });
          if (response.ok) {
            showToast('Payment reminder sent!', 'success');
          } else {
            throw new Error('Stripe reminder failed');
          }
        } else {
          // Supabase invoice - send via our email API
          const { data: invoice } = await supabaseClient
            .from('invoices')
            .select('*')
            .eq('id', invoiceId)
            .single();

          if (!invoice || !invoice.customer_email) {
            showToast('Invoice not found or missing customer email', 'error');
            return;
          }

          const response = await apiCall('/api/send-invoice-reminder', {
            method: 'POST',
            body: JSON.stringify({
              customer_email: invoice.customer_email,
              customer_name: invoice.customer_name,
              invoice_number: invoice.invoice_number,
              amount_due: invoice.amount_due || invoice.total,
              due_date: invoice.due_date,
              payment_url: invoice.stripe_hosted_url || null
            })
          });

          if (response.ok) {
            showToast('Payment reminder sent!', 'success');
          } else {
            // Fallback to email client
            const subject = encodeURIComponent(`Payment Reminder - Invoice #${invoice.invoice_number}`);
            const body = encodeURIComponent(`Hi ${invoice.customer_name || 'there'},\n\nThis is a friendly reminder that Invoice #${invoice.invoice_number} for $${(invoice.amount_due || invoice.total || 0).toFixed(2)} is due.\n\nPlease let us know if you have any questions.\n\nThank you,\nSurprise Granite`);
            window.open(`mailto:${invoice.customer_email}?subject=${subject}&body=${body}`);
            showToast('Email client opened for reminder', 'info');
          }
        }
      } catch (err) {
        console.error('Send reminder error:', err);
        showToast('Error sending reminder', 'error');
      }
    }

    async function markInvoicePaid(invoiceId) {
      if (!confirm('Mark this invoice as paid?')) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get invoice details
        const { data: invoice, error: fetchError } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        if (fetchError) throw fetchError;

        // Update invoice status
        const { error: updateError } = await supabaseClient
          .from('invoices')
          .update({
            status: 'paid',
            amount_paid: invoice.total,
            amount_due: 0,
            paid_at: new Date().toISOString()
          })
          .eq('id', invoiceId);

        if (updateError) throw updateError;

        // Record payment in payments table
        await supabaseClient.from('payments').insert({
          user_id: user.id,
          invoice_id: invoiceId,
          customer_id: invoice.customer_id,
          amount: invoice.total,
          payment_method: 'manual',
          status: 'completed',
          notes: 'Manually marked as paid'
        });

        // Update customer totals if customer_id exists
        if (invoice.customer_id) {
          const { data: customer } = await supabaseClient
            .from('customers')
            .select('total_spent, total_jobs')
            .eq('id', invoice.customer_id)
            .single();

          if (customer) {
            await supabaseClient
              .from('customers')
              .update({
                total_spent: (customer.total_spent || 0) + invoice.total,
                total_jobs: (customer.total_jobs || 0) + 1
              })
              .eq('id', invoice.customer_id);
          }
        }

        // Generate job number (fallback if RPC not available)
        let jobNumber = null;
        try {
          const { data } = await supabaseClient.rpc('get_next_job_number', { p_user_id: user.id });
          jobNumber = data;
        } catch { /* RPC may not exist yet */ }

        // Create job from paid invoice with full traceability
        const { data: newJob } = await supabaseClient.from('projects').insert({
          user_id: user.id,
          customer_id: invoice.customer_id,
          invoice_id: invoiceId,
          estimate_id: invoice.estimate_id,
          lead_id: invoice.lead_id,  // Preserve lead reference for traceability
          job_number: jobNumber || `JOB-${Date.now()}`,
          customer_name: invoice.customer_name,
          customer_email: invoice.customer_email,
          customer_phone: invoice.customer_phone,
          customer_address: invoice.customer_address,
          description: invoice.project_name || 'Project from Invoice #' + invoice.invoice_number,
          contract_amount: invoice.total,
          status: 'approved'
        }).select().single();

        // Send payment confirmation notification (email + SMS)
        sendNotification('invoice', 'paid', {
          ...invoice,
          amount: invoice.total
        }, {
          email: invoice.customer_email,
          phone: invoice.customer_phone,
          name: invoice.customer_name
        });

        showToast('Invoice marked as paid! Job created.');
        loadInvoices();
        loadJobs();
      } catch (err) {
        console.error('Mark paid error:', err);
        alert('Error marking invoice as paid: ' + err.message);
      }
    }

    // Update showPage to load invoices and wallet
    const _originalShowPage = showPage;
    showPage = async function(page) {
      await _originalShowPage(page);
      if (page === 'invoices' && isAdmin) {
        await loadInvoices();
      }
      if (page === 'wallet' && isAdmin) {
        await loadWalletData();
      }
      if (page === 'calendar') {
        initCalendar();
      }
      if (page === 'jobs') {
        await loadJobs();
      }
      if (page === 'collaborators') {
        loadCollaborators();
      }
    };

    // ============ WALLET MANAGEMENT ============
    let totalRevenue = 0;

    async function loadWalletData() {
      await Promise.all([
        loadBalance(),
        loadTransactions(),
        loadPayouts()
      ]);
    }

    async function loadBalance() {
      try {
        const response = await apiCall('/api/balance');
        if (!response.ok) throw new Error('Failed to load balance');

        const data = await response.json();

        document.getElementById('available-balance').textContent = `$${data.total_available.toFixed(2)}`;
        document.getElementById('pending-balance').textContent = `$${data.total_pending.toFixed(2)}`;

      } catch (err) {
        console.error('Balance error:', err);
        document.getElementById('available-balance').textContent = '$--.--';
        document.getElementById('pending-balance').textContent = '$--.--';
      }
    }

    async function loadTransactions() {
      const container = document.getElementById('transactions-list');
      if (!container) return;

      try {
        const response = await apiCall('/api/balance-transactions?limit=15');
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();

        if (data.transactions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No transactions yet</p>
            </div>
          `;
          return;
        }

        // Calculate total revenue from charges
        totalRevenue = data.transactions
          .filter(t => t.type === 'charge' && t.amount > 0)
          .reduce((sum, t) => sum + t.amount, 0);

        document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;

        container.innerHTML = data.transactions.map(t => {
          const isPositive = t.amount > 0 && t.type !== 'payout' && t.type !== 'stripe_fee';
          const iconClass = t.type === 'payout' ? 'payout' : (t.type === 'stripe_fee' ? 'fee' : 'income');
          const icon = t.type === 'payout'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>'
            : t.type === 'stripe_fee'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>';

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon ${iconClass}">${icon}</div>
                <div class="transaction-details">
                  <h4>${t.description || t.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                  <p>${t.type} ${t.fee > 0 ? ` Fee: $${t.fee.toFixed(2)}` : ''}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                <div class="date">${new Date(t.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Transactions error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load transactions</p>
          </div>
        `;
      }
    }

    async function loadPayouts() {
      const container = document.getElementById('payouts-list');
      if (!container) return;

      try {
        const response = await apiCall('/api/payouts?limit=10');
        if (!response.ok) throw new Error('Failed to load payouts');

        const data = await response.json();

        if (data.payouts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No payouts yet. Funds are automatically transferred to your bank account.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = data.payouts.map(p => {
          const statusColor = p.status === 'paid' ? 'var(--success)' : (p.status === 'pending' ? 'var(--warning)' : 'var(--text-muted)');

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon payout">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <div class="transaction-details">
                  <h4>Bank Transfer</h4>
                  <p style="color: ${statusColor};">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}  Arrives ${new Date(p.arrival_date).toLocaleDateString()}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount">$${p.amount.toFixed(2)}</div>
                <div class="date">${new Date(p.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Payouts error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load payouts</p>
          </div>
        `;
      }
    }

    // ============================================
    // STONE LISTINGS - Remnants Marketplace
    // ============================================

    let countertopsData = [];
    const MAX_FREE_LISTINGS = 3;

    // Load countertops data for autocomplete
    async function loadCountertopsData() {
      try {
        const response = await fetch('/data/countertops.json');
        countertopsData = await response.json();
      } catch (err) {
        console.error('Failed to load countertops data:', err);
      }
    }

    // Initialize listings functionality
    loadCountertopsData();

    // Stone autocomplete
    const stoneSearchInput = document.getElementById('listing-stone-search');
    const autocompleteResults = document.getElementById('stone-autocomplete-results');

    if (stoneSearchInput) {
      stoneSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 2) {
          autocompleteResults.classList.remove('active');
          return;
        }

        const matches = countertopsData
          .filter(stone =>
            stone.name.toLowerCase().includes(query) ||
            (stone.brand && stone.brand.toLowerCase().includes(query)) ||
            (stone.color && stone.color.toLowerCase().includes(query))
          )
          .slice(0, 8);

        if (matches.length === 0) {
          autocompleteResults.innerHTML = '<div style="padding: 12px; color: var(--text-muted);">No matching stones found</div>';
        } else {
          autocompleteResults.innerHTML = matches.map(stone => `
            <div class="stone-result-item" onclick="selectStone(${JSON.stringify(stone).replace(/"/g, '&quot;')})">
              <img src="${stone.image || '/images/placeholder.svg'}" alt="" class="stone-result-thumb">
              <div class="stone-result-info">
                <div class="stone-result-name">${stone.name}</div>
                <div class="stone-result-meta">${stone.brand || ''}  ${stone.type || ''}  ${stone.color || ''}</div>
              </div>
            </div>
          `).join('');
        }
        autocompleteResults.classList.add('active');
      });

      // Close autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.stone-autocomplete')) {
          autocompleteResults.classList.remove('active');
        }
      });
    }

    function selectStone(stone) {
      document.getElementById('listing-stone-slug').value = stone.slug || '';
      document.getElementById('listing-stone-name').value = stone.name || '';
      document.getElementById('listing-material-type').value = stone.type || '';
      document.getElementById('listing-brand').value = stone.brand || '';
      document.getElementById('listing-color').value = stone.color || '';
      document.getElementById('listing-stone-search').value = stone.name;

      // Update preview
      document.getElementById('selected-stone-preview').style.display = 'block';
      document.getElementById('selected-stone-img').src = stone.image || '/images/placeholder.svg';
      document.getElementById('selected-stone-name').textContent = stone.name;
      document.getElementById('selected-stone-meta').textContent = `${stone.brand || ''}  ${stone.type || ''}  ${stone.color || ''}`;

      // Auto-fill title if empty
      const titleInput = document.getElementById('listing-title');
      if (!titleInput.value) {
        titleInput.value = `${stone.name} Remnant`;
      }

      autocompleteResults.classList.remove('active');
    }

    function clearSelectedStone() {
      document.getElementById('listing-stone-slug').value = '';
      document.getElementById('listing-stone-name').value = '';
      document.getElementById('listing-material-type').value = '';
      document.getElementById('listing-brand').value = '';
      document.getElementById('listing-color').value = '';
      document.getElementById('listing-stone-search').value = '';
      document.getElementById('selected-stone-preview').style.display = 'none';
    }

    function togglePriceField() {
      const priceInput = document.getElementById('listing-price');
      const contactCheckbox = document.getElementById('listing-price-contact');
      priceInput.disabled = contactCheckbox.checked;
      if (contactCheckbox.checked) {
        priceInput.value = '';
        priceInput.placeholder = 'Contact for price';
      } else {
        priceInput.placeholder = '0.00';
      }
    }

    // Image Upload Functions
    function triggerImageUpload(slotNum) {
      const fileInput = document.getElementById(`image-file-${slotNum}`);
      fileInput.click();
    }

    async function handleImageUpload(slotNum, input) {
      const file = input.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB');
        return;
      }

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const progress = document.getElementById(`upload-progress-${slotNum}`);
      const progressBar = document.getElementById(`upload-bar-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);

      // Show progress
      progress.style.display = 'block';
      progressBar.style.width = '10%';

      try {
        // Get current user
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          alert('Please log in to upload images');
          return;
        }

        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

        progressBar.style.width = '30%';

        // Compress image if needed
        const compressedFile = await compressImage(file, 1200, 0.8);

        progressBar.style.width = '50%';

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('listing-images')
          .upload(fileName, compressedFile, {
            cacheControl: '3600',
            upsert: false
          });

        progressBar.style.width = '80%';

        if (error) {
          // Fallback: use data URL for preview and let user know to use URL input
          console.warn('Storage upload failed, using local preview:', error);
          const dataUrl = await readFileAsDataUrl(file);
          preview.src = dataUrl;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
          removeBtn.style.display = 'flex';
          slot.classList.add('has-image');
          // Store data URL temporarily (won't persist to DB, but shows preview)
          hiddenInput.value = dataUrl;
          progressBar.style.width = '100%';
          setTimeout(() => { progress.style.display = 'none'; }, 500);
          return;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('listing-images')
          .getPublicUrl(fileName);

        progressBar.style.width = '100%';

        // Update UI
        preview.src = urlData.publicUrl;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        removeBtn.style.display = 'flex';
        slot.classList.add('has-image');
        hiddenInput.value = urlData.publicUrl;

        setTimeout(() => { progress.style.display = 'none'; }, 500);

      } catch (err) {
        console.error('Upload error:', err);
        alert('Failed to upload image. Please try again or paste an image URL.');
        progress.style.display = 'none';
      }
    }

    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressImage(file, maxWidth, quality) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function removeImage(event, slotNum) {
      event.stopPropagation();

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);
      const fileInput = document.getElementById(`image-file-${slotNum}`);

      // Reset UI
      preview.src = '';
      preview.style.display = 'none';
      placeholder.style.display = 'flex';
      removeBtn.style.display = 'none';
      slot.classList.remove('has-image');
      hiddenInput.value = '';
      fileInput.value = '';
    }

    function updateImagePreviews() {
      const previewGrid = document.getElementById('image-preview-grid');
      const images = [
        document.getElementById('listing-image-1').value,
        document.getElementById('listing-image-2').value,
        document.getElementById('listing-image-3').value,
        document.getElementById('listing-image-4').value
      ].filter(url => url);

      previewGrid.innerHTML = images.map((url, i) => `
        <div class="image-preview-item">
          <img src="${url}" alt="Preview ${i + 1}" onerror="this.src='/images/placeholder.svg'">
        </div>
      `).join('');
    }

    // Modal functions
    async function openCreateListingModal() {
      // Check listing limit first
      const canCreate = await checkListingLimit();
      if (!canCreate.allowed) {
        alert(`You've reached your limit of ${canCreate.max} free listings. Upgrade to Pro for unlimited listings!`);
        return;
      }

      document.getElementById('create-listing-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCreateListingModal() {
      document.getElementById('create-listing-modal').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('create-listing-form').reset();
      clearSelectedStone();
      // Reset category to default
      selectListingCategory('countertops');
    }

    function selectListingCategory(category) {
      // Update hidden input
      document.getElementById('listing-category').value = category;

      // Update visual selection
      document.querySelectorAll('.listing-category-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.category === category);
      });

      // Update product selection section based on category
      const productSection = document.getElementById('product-selection-section');
      const titleEl = document.getElementById('product-selection-title');
      const labelEl = document.getElementById('product-search-label');
      const searchInput = document.getElementById('listing-stone-search');

      // Category-specific labels
      const categoryConfig = {
        countertops: {
          title: 'Select Stone',
          label: 'Search countertops catalog (optional)',
          placeholder: 'Start typing stone name...',
          showCatalog: true
        },
        tile: {
          title: 'Select Tile',
          label: 'Search tile catalog (optional)',
          placeholder: 'Start typing tile name...',
          showCatalog: true
        },
        flooring: {
          title: 'Select Flooring',
          label: 'Search flooring catalog (optional)',
          placeholder: 'Start typing flooring name...',
          showCatalog: true
        },
        cabinets: {
          title: 'Cabinet Details',
          label: 'Describe your cabinets',
          placeholder: 'e.g., Shaker White 36" Base Cabinet',
          showCatalog: false
        },
        supplies: {
          title: 'Product Details',
          label: 'Describe your product',
          placeholder: 'e.g., Mapei Kerabond Thinset 50lb',
          showCatalog: false
        },
        other: {
          title: 'Product Details',
          label: 'Describe your item',
          placeholder: 'e.g., Delta Faucet, Cabinet Hardware',
          showCatalog: false
        }
      };

      const config = categoryConfig[category] || categoryConfig.other;
      titleEl.textContent = config.title;
      labelEl.textContent = config.label;
      searchInput.placeholder = config.placeholder;

      // Show/hide autocomplete for categories without catalog
      const autocompleteResults = document.getElementById('stone-autocomplete-results');
      if (!config.showCatalog) {
        autocompleteResults.style.display = 'none';
      }

      // Clear previous selection when switching categories
      clearSelectedStone();
    }

    async function checkListingLimit() {
      const user = await supabaseClient.auth.getUser();
      if (!user.data.user) return { allowed: false, remaining: 0 };

      // Check if super admin by email
      const userEmail = (user.data.user.email || '').toLowerCase();
      if (SUPER_ADMIN_EMAILS.includes(userEmail)) {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Check if pro account
      const { data: profile } = await supabaseClient
        .from('sg_users')
        .select('account_type')
        .eq('id', user.data.user.id)
        .single();

      const accountType = profile?.account_type || 'homeowner';
      if (accountType.startsWith('pro_') || accountType === 'admin' || accountType === 'super_admin') {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Count active listings
      const { count } = await supabaseClient
        .from('stone_listings')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.data.user.id)
        .eq('status', 'active');

      return {
        allowed: (count || 0) < MAX_FREE_LISTINGS,
        remaining: MAX_FREE_LISTINGS - (count || 0),
        current: count || 0,
        max: MAX_FREE_LISTINGS,
        isPro: false
      };
    }

    async function handleCreateListing(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submit-listing-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Creating...';

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          throw new Error('Please sign in to create a listing');
        }

        // Get category and determine product name
        const category = document.getElementById('listing-category').value;
        const catalogStoneName = document.getElementById('listing-stone-name').value;
        const userBrandInput = document.getElementById('listing-brand-input').value;

        const listingData = {
          user_id: user.data.user.id,
          category: category,
          condition: document.getElementById('listing-condition').value || 'new',
          stone_name: catalogStoneName || document.getElementById('listing-title').value,
          stone_slug: document.getElementById('listing-stone-slug').value || null,
          material_type: document.getElementById('listing-material-type').value || category,
          brand: document.getElementById('listing-brand').value || userBrandInput || null,
          color: document.getElementById('listing-color').value || null,
          title: document.getElementById('listing-title').value,
          description: document.getElementById('listing-description').value || null,
          dimensions: document.getElementById('listing-dimensions').value || null,
          thickness: document.getElementById('listing-thickness').value || null,
          quantity: parseInt(document.getElementById('listing-quantity').value) || 1,
          price: document.getElementById('listing-price-contact').checked ? null : (parseFloat(document.getElementById('listing-price').value) || null),
          image_url: document.getElementById('listing-image-1').value || null,
          image_url_2: document.getElementById('listing-image-2').value || null,
          image_url_3: document.getElementById('listing-image-3').value || null,
          image_url_4: document.getElementById('listing-image-4').value || null,
          city: document.getElementById('listing-city').value || null,
          state: document.getElementById('listing-state').value || null,
          zip_code: document.getElementById('listing-zip').value || null,
          show_email: document.getElementById('listing-show-email').checked,
          show_phone: document.getElementById('listing-show-phone').checked,
          contact_form_only: document.getElementById('listing-contact-form').checked,
          status: 'active'
        };

        const { data, error } = await supabaseClient
          .from('stone_listings')
          .insert([listingData])
          .select()
          .single();

        if (error) throw error;

        closeCreateListingModal();
        await loadMyListings();
        alert('Listing created successfully!');

      } catch (err) {
        console.error('Create listing error:', err);
        alert('Failed to create listing: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        `;
      }
    }

    async function loadMyListings() {
      const loadingEl = document.getElementById('listings-loading');
      const emptyEl = document.getElementById('listings-empty');
      const gridEl = document.getElementById('listings-grid');
      const limitIndicator = document.getElementById('listing-limit-indicator');

      if (loadingEl) loadingEl.style.display = 'block';
      if (emptyEl) emptyEl.style.display = 'none';
      if (gridEl) gridEl.style.display = 'none';

      // Always try to load inquiries regardless of listings
      loadMyInquiries().catch(err => console.error('Inquiries load error:', err));

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          if (loadingEl) loadingEl.innerHTML = '<p style="color: var(--text-muted);">Please sign in to view your listings</p>';
          return;
        }

        // Update listing count and limit indicator
        const limitInfo = await checkListingLimit();
        if (limitIndicator) {
          if (limitInfo.isPro) {
            limitIndicator.textContent = 'Unlimited listings (Pro)';
            limitIndicator.style.color = 'var(--gold-primary)';
          } else {
            limitIndicator.textContent = `${limitInfo.current}/${limitInfo.max} listings used`;
            limitIndicator.style.color = limitInfo.remaining === 0 ? 'var(--error)' : 'var(--text-muted)';
          }
        }

        // Update nav badge
        const listingsCountEl = document.getElementById('listings-count');
        if (listingsCountEl) {
          const count = limitInfo.current || 0;
          listingsCountEl.textContent = count;
          listingsCountEl.setAttribute('data-count', count);
          listingsCountEl.style.display = count > 0 ? '' : 'none';
        }

        const { data: listings, error } = await supabaseClient
          .from('stone_listings')
          .select('*')
          .eq('user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (loadingEl) loadingEl.style.display = 'none';

        if (!listings || listings.length === 0) {
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        if (gridEl) {
          gridEl.style.display = 'grid';
          gridEl.innerHTML = listings.map(listing => {
          const category = listing.category || 'countertops';
          const categoryLabels = { countertops: 'Countertops', tile: 'Tile', flooring: 'Flooring', cabinets: 'Cabinets', supplies: 'Supplies', other: 'Other' };
          const conditionLabels = { new: 'New', remnant: 'Remnant', overstock: 'Overstock', used: 'Used', refurbished: 'Refurb' };
          return `
          <div class="listing-card">
            <div class="listing-image">
              ${listing.image_url ? `<img src="${listing.image_url}" alt="${listing.title}">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>'}
              <span class="listing-category-badge ${category}">${categoryLabels[category] || category}</span>
              <span class="listing-status-badge ${listing.status}">${listing.status}</span>
            </div>
            <div class="listing-content">
              <div class="listing-title">${listing.title}</div>
              <div class="listing-stone">${listing.stone_name || listing.brand || ''}</div>
              <div class="listing-meta">
                ${listing.condition ? `<span class="listing-meta-item">${conditionLabels[listing.condition] || listing.condition}</span>` : ''}
                ${listing.dimensions ? `<span class="listing-meta-item">${listing.dimensions}</span>` : ''}
                ${listing.thickness ? `<span class="listing-meta-item">${listing.thickness}</span>` : ''}
              </div>
              <div class="listing-price ${listing.price === null ? 'contact' : ''}">
                ${listing.price !== null ? '$' + listing.price.toFixed(2) : 'Contact for price'}
              </div>
              <div class="listing-stats">
                <span>${listing.views || 0} views</span>
                <span>${listing.inquiries || 0} inquiries</span>
              </div>
              <div class="listing-actions">
                <button class="btn-edit" onclick="editListing('${listing.id}')">Edit</button>
                ${listing.status === 'active' ?
                  `<button class="btn-edit" onclick="markListingSold('${listing.id}')">Mark Sold</button>` :
                  `<button class="btn-edit" onclick="reactivateListing('${listing.id}')">Reactivate</button>`
                }
                <button class="btn-delete" onclick="deleteListing('${listing.id}')">Delete</button>
              </div>
            </div>
          </div>
        `}).join('');
        }

      } catch (err) {
        console.error('Load listings error:', err);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
      }
    }

    async function loadMyInquiries() {
      const loadingEl = document.getElementById('inquiries-loading');
      const emptyEl = document.getElementById('inquiries-empty');
      const listEl = document.getElementById('inquiries-list');
      const badgeEl = document.getElementById('inquiries-badge');

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        // Get all inquiries for user's listings
        const { data: inquiries, error } = await supabaseClient
          .from('listing_inquiries')
          .select(`
            *,
            stone_listings!inner(title, user_id)
          `)
          .eq('stone_listings.user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        if (loadingEl) loadingEl.style.display = 'none';

        if (error || !inquiries || inquiries.length === 0) {
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        const unreadCount = inquiries.filter(i => !i.read).length;
        if (badgeEl) {
          if (unreadCount > 0) {
            badgeEl.textContent = unreadCount;
            badgeEl.style.display = 'flex';
          } else {
            badgeEl.style.display = 'none';
          }
        }

        if (listEl) {
          listEl.style.display = 'block';
          listEl.innerHTML = inquiries.map(inquiry => `
          <div class="inquiry-item ${inquiry.read ? '' : 'unread'}" onclick="markInquiryRead('${inquiry.id}')">
            <div class="inquiry-header">
              <div>
                <div class="inquiry-listing">Re: ${inquiry.stone_listings.title}</div>
                <div class="inquiry-sender">${inquiry.sender_name}</div>
                <div class="inquiry-contact">
                  ${inquiry.sender_email}
                  ${inquiry.sender_phone ? `  ${inquiry.sender_phone}` : ''}
                </div>
              </div>
              <div class="inquiry-date">${new Date(inquiry.created_at).toLocaleDateString()}</div>
            </div>
            <div class="inquiry-message">${inquiry.message}</div>
            <div class="inquiry-actions" onclick="event.stopPropagation()">
              <a href="mailto:${inquiry.sender_email}?subject=Re: ${encodeURIComponent(inquiry.stone_listings.title)}" class="btn btn-email">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Reply via Email
              </a>
              <button class="btn btn-payment" onclick="openPaymentModal('${inquiry.id}', '${inquiry.sender_name.replace(/'/g, "\\'")}', '${inquiry.sender_email}', '${inquiry.stone_listings.title.replace(/'/g, "\\'")}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Send Payment Link
              </button>
            </div>
          </div>
        `).join('');
        }

      } catch (err) {
        console.error('Load inquiries error:', err);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
      }
    }

    async function markInquiryRead(id) {
      try {
        await supabaseClient
          .from('listing_inquiries')
          .update({ read: true })
          .eq('id', id);
        await loadMyInquiries();
      } catch (err) {
        console.error('Mark read error:', err);
      }
    }

    // ==========================================
    // UNIFIED MESSAGES / NOTIFICATION CENTER
    // ==========================================
    let messageItems = [];
    let currentNotification = null;
    let notificationFilter = 'all';

    async function loadConversations() {
      console.log('[Messages] loadConversations called');
      const listEl = document.getElementById('conversations-list');
      if (!listEl) {
        console.warn('[Messages] conversations-list element not found');
        return;
      }

      listEl.innerHTML = '<div class="loading-state"><div class="spinner-modern"></div><span>Loading...</span></div>';

      try {
        if (!supabaseClient) {
          console.error('[Messages] supabaseClient not initialized');
          listEl.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">Database not ready. Please refresh.</div>';
          return;
        }
        console.log('[Messages] Getting user...');
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          listEl.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">Please sign in to view messages</div>';
          return;
        }

        messageItems = [];

        // 1. Load Pro Notifications (design shares, favorites, wishlists, etc.)
        try {
          const { data: proNotifs } = await supabaseClient
            .from('pro_notifications')
            .select('*')
            .eq('pro_user_id', user.data.user.id)
            .order('created_at', { ascending: false })
            .limit(50);

          (proNotifs || []).forEach(n => {
            messageItems.push({
              id: n.id,
              type: 'notification',
              category: n.notification_type,
              title: n.title,
              message: n.message,
              data: n.data || {},
              isRead: n.is_read,
              createdAt: n.created_at,
              icon: getNotificationIcon(n.notification_type),
              color: getNotificationColor(n.notification_type)
            });
          });
        } catch (e) { console.warn('Pro notifications not available:', e.message); }

        // 2. Load Listing Inquiries (marketplace messages)
        try {
          const { data: inquiries } = await supabaseClient
            .from('listing_inquiries')
            .select('*, stone_listings!inner(title, user_id)')
            .eq('stone_listings.user_id', user.data.user.id)
            .order('created_at', { ascending: false })
            .limit(50);

          (inquiries || []).forEach(inq => {
            messageItems.push({
              id: inq.id,
              type: 'inquiry',
              category: 'listing_inquiry',
              title: `Inquiry: ${inq.stone_listings?.title || 'Listing'}`,
              message: inq.message,
              sender: { name: inq.sender_name, email: inq.sender_email, phone: inq.sender_phone },
              isRead: inq.read || false,
              createdAt: inq.created_at,
              icon: 'marketplace',
              color: 'blue'
            });
          });
        } catch (e) { console.warn('Listing inquiries not available:', e.message); }

        // 3. Load Customer Messages (grouped by customer)
        try {
          const { data: messages } = await supabaseClient
            .from('customer_messages')
            .select('*, customers(id, name, email, phone)')
            .order('created_at', { ascending: false })
            .limit(100);

          const customerMsgMap = new Map();
          (messages || []).forEach(msg => {
            if (!msg.customer_id) return;
            if (!customerMsgMap.has(msg.customer_id)) {
              customerMsgMap.set(msg.customer_id, {
                customer: msg.customers,
                messages: [],
                lastMessage: msg,
                unreadCount: 0
              });
            }
            customerMsgMap.get(msg.customer_id).messages.push(msg);
            if (msg.direction === 'inbound' && !msg.read_at) {
              customerMsgMap.get(msg.customer_id).unreadCount++;
            }
          });

          customerMsgMap.forEach((conv, customerId) => {
            const customer = conv.customer || {};
            messageItems.push({
              id: customerId,
              type: 'conversation',
              category: 'customer_message',
              title: customer.name || customer.email || 'Customer',
              message: conv.lastMessage?.message || 'No messages',
              customer: customer,
              messages: conv.messages,
              unreadCount: conv.unreadCount,
              isRead: conv.unreadCount === 0,
              createdAt: conv.lastMessage?.created_at || conv.customer?.created_at,
              icon: 'customer',
              color: 'gold'
            });
          });
        } catch (e) { console.warn('Customer messages not available:', e.message); }

        // 4. Load Recent Leads (as notifications)
        try {
          const { data: leads } = await supabaseClient
            .from('leads')
            .select('*')
            .eq('status', 'new')
            .order('created_at', { ascending: false })
            .limit(20);

          (leads || []).forEach(lead => {
            messageItems.push({
              id: lead.id,
              type: 'lead',
              category: 'new_lead',
              title: `New Lead: ${lead.full_name || lead.email || 'Unknown'}`,
              message: lead.project_type ? `${lead.project_type} project` : 'New inquiry',
              lead: lead,
            isRead: lead.status !== 'new',
            createdAt: lead.created_at,
            icon: 'lead',
            color: 'green'
            });
          });
        } catch (e) { console.warn('Leads not available:', e.message); }

        // Sort all by date
        messageItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        renderMessageItems();
        updateUnreadBadge();

      } catch (err) {
        console.error('Load notifications error:', err);
        listEl.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">Error loading messages</div>';
      }
    }

    function getNotificationIcon(type) {
      const icons = {
        design_shared: 'design',
        favorite_added: 'heart',
        wishlist_shared: 'list',
        estimate_requested: 'estimate',
        new_customer: 'customer',
        customer_active: 'customer',
        system: 'bell'
      };
      return icons[type] || 'bell';
    }

    function getNotificationColor(type) {
      const colors = {
        design_shared: 'purple',
        favorite_added: 'pink',
        wishlist_shared: 'blue',
        estimate_requested: 'gold',
        new_customer: 'green',
        customer_active: 'green',
        system: 'gray'
      };
      return colors[type] || 'gray';
    }

    function renderMessageItems(filter = '') {
      const listEl = document.getElementById('conversations-list');
      if (!listEl) return;

      let filtered = messageItems;

      // Apply category filter
      if (notificationFilter !== 'all') {
        filtered = filtered.filter(n => {
          if (notificationFilter === 'unread') return !n.isRead;
          if (notificationFilter === 'messages') return n.type === 'conversation' || n.type === 'inquiry';
          if (notificationFilter === 'leads') return n.type === 'lead';
          if (notificationFilter === 'notifications') return n.type === 'notification';
          return true;
        });
      }

      // Apply search filter
      if (filter) {
        const q = filter.toLowerCase();
        filtered = filtered.filter(n =>
          (n.title || '').toLowerCase().includes(q) ||
          (n.message || '').toLowerCase().includes(q)
        );
      }

      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="opacity: 0.3; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <p>${filter ? 'No results found' : 'No messages yet'}</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewMessageModal()">Send a Message</button>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filtered.map(notif => {
        const initials = getNotifInitials(notif);
        const preview = (notif.message || '').slice(0, 60) + ((notif.message || '').length > 60 ? '...' : '');
        const time = formatMessageTime(notif.createdAt);
        const isActive = currentNotification && currentNotification.id === notif.id;
        const unreadDot = !notif.isRead ? '<div class="notif-unread-dot"></div>' : '';
        const badge = notif.unreadCount > 0 ? `<div class="conversation-unread">${notif.unreadCount}</div>` : '';

        return `
          <div class="conversation-item ${isActive ? 'active' : ''} ${!notif.isRead ? 'unread' : ''}" onclick="selectNotification('${notif.id}', '${notif.type}')">
            <div class="notif-avatar ${notif.color}">${getNotifIconSvg(notif.icon)}</div>
            <div class="conversation-details">
              <div class="conversation-name">${unreadDot}${escapeHtml(notif.title)}</div>
              <div class="conversation-preview">${escapeHtml(preview)}</div>
            </div>
            <div class="conversation-meta">
              <div class="conversation-time">${time}</div>
              ${badge}
            </div>
          </div>
        `;
      }).join('');

      // Update mobile badge count
      const countBadge = document.getElementById('conversations-count-badge');
      if (countBadge) {
        const unreadCount = messageItems.filter(n => !n.isRead).length;
        countBadge.textContent = unreadCount > 0 ? unreadCount : filtered.length;
        countBadge.style.background = unreadCount > 0 ? 'var(--gold)' : 'var(--surface-elevated)';
        countBadge.style.color = unreadCount > 0 ? 'var(--dark)' : 'var(--text-muted)';
      }
    }

    function getNotifInitials(notif) {
      if (notif.customer) {
        return (notif.customer.name || notif.customer.email || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      }
      if (notif.sender) {
        return (notif.sender.name || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      }
      return '!';
    }

    function getNotifIconSvg(icon) {
      const icons = {
        design: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>',
        heart: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>',
        list: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>',
        estimate: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        customer: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
        lead: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>',
        marketplace: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
        bell: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>'
      };
      return icons[icon] || icons.bell;
    }

    function filterConversations(query) {
      renderMessageItems(query);
    }

    function setNotificationFilter(filter) {
      notificationFilter = filter;
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      document.querySelector(`.filter-chip[data-filter="${filter}"]`)?.classList.add('active');
      renderMessageItems();
    }

    async function selectNotification(id, type) {
      const notif = messageItems.find(n => n.id === id);
      if (!notif) return;

      currentNotification = notif;
      renderMessageItems();
      mobileCollapseOnSelect();

      // Show appropriate detail view
      const headerEl = document.getElementById('thread-header');
      const inputEl = document.getElementById('message-input-area');
      const messagesEl = document.getElementById('thread-messages');

      if (type === 'conversation') {
        // Show customer conversation
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'block';

        const customer = notif.customer || {};
        document.getElementById('thread-avatar').textContent = getNotifInitials(notif);
        document.getElementById('thread-name').textContent = customer.name || customer.email || 'Customer';
        document.getElementById('thread-status').textContent = customer.email || customer.phone || '';

        await loadThreadMessages(id);
        markNotificationRead(notif);

      } else if (type === 'inquiry') {
        // Show inquiry detail
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'block';

        document.getElementById('thread-avatar').textContent = getNotifInitials(notif);
        document.getElementById('thread-name').textContent = notif.sender?.name || 'Inquiry';
        document.getElementById('thread-status').textContent = notif.sender?.email || '';

        messagesEl.innerHTML = `
          <div class="notif-detail-card">
            <div class="notif-detail-header">
              <h3>${escapeHtml(notif.title)}</h3>
              <span class="notif-time">${formatDateDivider(notif.createdAt)}</span>
            </div>
            <div class="notif-detail-body">
              <p>${escapeHtml(notif.message)}</p>
            </div>
            <div class="notif-detail-contact">
              ${notif.sender?.email ? `<a href="mailto:${notif.sender.email}" class="contact-link"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> ${notif.sender.email}</a>` : ''}
              ${notif.sender?.phone ? `<a href="tel:${notif.sender.phone}" class="contact-link"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg> ${notif.sender.phone}</a>` : ''}
            </div>
            <div class="notif-detail-actions">
              <button class="btn-modern primary" onclick="replyToInquiry('${id}')">Reply</button>
              <button class="btn-modern secondary" onclick="convertInquiryToLead('${id}')">Convert to Lead</button>
            </div>
          </div>
        `;
        markInquiryAsRead(id);

      } else if (type === 'lead') {
        // Show lead detail
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'none';

        document.getElementById('thread-avatar').textContent = getNotifInitials(notif);
        document.getElementById('thread-name').textContent = notif.lead?.full_name || 'Lead';
        document.getElementById('thread-status').textContent = notif.lead?.email || '';

        const lead = notif.lead || {};
        messagesEl.innerHTML = `
          <div class="notif-detail-card">
            <div class="notif-detail-header">
              <h3>New Lead</h3>
              <span class="notif-time">${formatDateDivider(notif.createdAt)}</span>
            </div>
            <div class="notif-detail-body">
              <div class="detail-row"><strong>Name:</strong> ${escapeHtml(lead.full_name || 'N/A')}</div>
              <div class="detail-row"><strong>Email:</strong> ${escapeHtml(lead.email || 'N/A')}</div>
              <div class="detail-row"><strong>Phone:</strong> ${escapeHtml(lead.phone || 'N/A')}</div>
              <div class="detail-row"><strong>Project:</strong> ${escapeHtml(lead.project_type || 'N/A')}</div>
              ${lead.notes ? `<div class="detail-row"><strong>Notes:</strong> ${escapeHtml(lead.notes)}</div>` : ''}
            </div>
            <div class="notif-detail-actions">
              <button class="btn-modern primary" onclick="openLeadModal('${lead.id}')">View Lead</button>
              <button class="btn-modern secondary" onclick="contactLead('${lead.id}')">Contact</button>
            </div>
          </div>
        `;

      } else {
        // Show notification detail
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'none';

        document.getElementById('thread-avatar').innerHTML = getNotifIconSvg(notif.icon);
        document.getElementById('thread-name').textContent = notif.title;
        document.getElementById('thread-status').textContent = formatDateDivider(notif.createdAt);

        messagesEl.innerHTML = `
          <div class="notif-detail-card">
            <div class="notif-detail-header">
              <h3>${escapeHtml(notif.title)}</h3>
            </div>
            <div class="notif-detail-body">
              <p>${escapeHtml(notif.message)}</p>
            </div>
            ${notif.data?.link ? `
              <div class="notif-detail-actions">
                <button class="btn-modern primary" onclick="window.location.href='${notif.data.link}'">View Details</button>
              </div>
            ` : ''}
          </div>
        `;
        markNotificationRead(notif);
      }
    }

    async function loadThreadMessages(entityId) {
      const messagesEl = document.getElementById('thread-messages');
      if (!messagesEl) return;

      try {
        // Try customer_id first, then lead_id
        let { data: messages, error } = await supabaseClient
          .from('customer_messages')
          .select('*')
          .eq('customer_id', entityId)
          .order('created_at', { ascending: true });

        // If no results, try as lead_id
        if ((!messages || messages.length === 0) && !error) {
          const leadResult = await supabaseClient
            .from('customer_messages')
            .select('*')
            .eq('lead_id', entityId)
            .order('created_at', { ascending: true });
          if (leadResult.data?.length) {
            messages = leadResult.data;
            error = leadResult.error;
          }
        }

        if (error) throw error;

        if (!messages || messages.length === 0) {
          messagesEl.innerHTML = `
            <div class="empty-thread">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <h3>Start the conversation</h3>
              <p>Send a message to begin</p>
            </div>
          `;
          return;
        }

        let html = '';
        let lastDate = '';

        messages.forEach(msg => {
          const msgDate = new Date(msg.created_at).toLocaleDateString();
          if (msgDate !== lastDate) {
            html += `<div class="date-divider">${formatDateDivider(msg.created_at)}</div>`;
            lastDate = msgDate;
          }
          const channelBadge = msg.channel && msg.channel !== 'in_app' ? `<span class="message-channel-badge">${msg.channel.toUpperCase()}</span>` : '';
          const statusIcon = getMessageStatusIcon(msg.status);
          const sourceLabel = msg.source_type === 'design_comment' ? '<span class="message-channel-badge">DESIGN</span>' : '';

          html += `
            <div class="message-bubble-wrapper ${msg.direction}">
              <div class="message-bubble ${msg.direction}">
                <div class="message-content">${escapeHtml(msg.message)}</div>
                <div class="message-meta">
                  <span class="message-time">${formatMessageTime(msg.created_at)}</span>
                  ${channelBadge}
                  ${sourceLabel}
                  ${msg.direction === 'outbound' ? `<span class="message-status ${msg.status || 'sent'}">${statusIcon}</span>` : ''}
                </div>
              </div>
              <div class="message-actions">
                ${msg.direction === 'outbound' ? `
                  <button class="message-action-btn delete" onclick="deleteMessage('${msg.id}')" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete
                  </button>
                ` : `
                  <button class="message-action-btn" onclick="replyToMessage('${msg.id}')" title="Reply">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                    Reply
                  </button>
                `}
              </div>
            </div>
          `;
        });

        messagesEl.innerHTML = html;
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Mark inbound messages as read
        const unreadIds = messages.filter(m => m.direction === 'inbound' && !m.read_at).map(m => m.id);
        if (unreadIds.length > 0) {
          await supabaseClient.from('customer_messages')
            .update({ read_at: new Date().toISOString(), status: 'read' })
            .in('id', unreadIds);
        }

      } catch (err) {
        console.error('Load thread error:', err);
      }
    }

    async function markNotificationRead(notif) {
      if (notif.isRead) return;
      try {
        await supabaseClient.from('pro_notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('id', notif.id);
        notif.isRead = true;
        updateUnreadBadge();
      } catch (err) {
        console.error('Mark read error:', err);
      }
    }

    async function markInquiryAsRead(id) {
      try {
        await supabaseClient.from('listing_inquiries').update({ read: true }).eq('id', id);
        const notif = messageItems.find(n => n.id === id);
        if (notif) notif.isRead = true;
        updateUnreadBadge();
      } catch (err) {
        console.error('Mark inquiry read error:', err);
      }
    }

    function updateUnreadBadge() {
      const unreadCount = messageItems.filter(n => !n.isRead).length;
      const badge = document.querySelector('.nav-item[data-page="messages"] .nav-badge');
      if (badge) {
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'flex' : 'none';
      }
    }

    async function replyToInquiry(id) {
      const notif = messageItems.find(n => n.id === id);
      if (!notif?.sender?.email) {
        showToast('No email to reply to', 'error');
        return;
      }
      openNewMessageModal();
      setTimeout(() => {
        setManualRecipient(notif.sender.email);
      }, 100);
    }

    async function convertInquiryToLead(id) {
      const notif = messageItems.find(n => n.id === id);
      if (!notif) return;
      try {
        const user = await supabaseClient.auth.getUser();
        await supabaseClient.from('leads').insert({
          user_id: user.data.user.id,
          full_name: notif.sender?.name || '',
          email: notif.sender?.email || '',
          phone: notif.sender?.phone || '',
          source: 'marketplace_inquiry',
          notes: notif.message,
          status: 'new'
        });
        showToast('Converted to lead!', 'success');
      } catch (err) {
        showToast('Error converting to lead', 'error');
      }
    }

    function contactLead(leadId) {
      const notif = messageItems.find(n => n.lead?.id === leadId);
      if (!notif?.lead) return;
      openNewMessageModal();
      setTimeout(() => {
        if (notif.lead.email) setManualRecipient(notif.lead.email);
        else if (notif.lead.phone) setManualRecipient(notif.lead.phone);
      }, 100);
    }

    async function sendMessage() {
      if (!currentNotification || currentNotification.type !== 'conversation') {
        showToast('Please select a conversation', 'error');
        return;
      }

      const inputEl = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-message-btn');
      const message = inputEl?.value?.trim();
      if (!message) return;

      const channel = document.querySelector('input[name="message-channel"]:checked')?.value || 'in_app';

      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="spinner-modern" style="width:16px;height:16px;"></div>';
      }

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) throw new Error('Not authenticated');

        const isLead = currentNotification.source === 'lead' || currentNotification.lead;
        const recipientEmail = currentNotification.customer?.email || currentNotification.lead?.email;
        const recipientName = currentNotification.customer?.name || currentNotification.lead?.full_name || currentNotification.lead?.name || '';
        const effectiveChannel = (channel === 'email' && recipientEmail) ? 'email' : channel;

        const { data: insertedMsg } = await supabaseClient.from('customer_messages').insert({
          ...(isLead ? { lead_id: currentNotification.id } : { customer_id: currentNotification.id }),
          sender_id: user.data.user.id,
          direction: 'outbound',
          channel: effectiveChannel,
          message: message,
          sent_from: user.data.user.email,
          sent_to: recipientEmail || currentNotification.customer?.phone || null,
          status: 'sent'
        }).select('id');

        if (inputEl) inputEl.value = '';
        await loadThreadMessages(currentNotification.id);

        // Send actual email if channel is email and recipient has email
        if (effectiveChannel === 'email' && recipientEmail) {
          try {
            const resp = await apiCall('/api/send-lead-message', {
              method: 'POST',
              body: JSON.stringify({
                to_email: recipientEmail,
                to_name: recipientName,
                message: message,
                sender_name: user.data.user.user_metadata?.full_name || user.data.user.email || 'Surprise Granite',
                lead_id: isLead ? currentNotification.id : null
              })
            });
            const result = await resp.json();
            if (result.success) {
              showToast('Message sent via email!', 'success');
            } else {
              showToast('Saved but email delivery failed', 'warning');
            }
          } catch (emailErr) {
            console.error('Email delivery error:', emailErr);
            showToast('Saved but email delivery failed', 'warning');
          }
        } else {
          showToast('Message sent', 'success');
        }

      } catch (err) {
        console.error('Send error:', err);
        showToast('Failed to send', 'error');
      } finally {
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>';
        }
      }
    }

    function handleMessageKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function formatMessageTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      if (days === 1) return 'Yesterday';
      if (days < 7) return date.toLocaleDateString([], { weekday: 'short' });
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    function formatDateDivider(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      return date.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
    }

    function callCustomer() {
      const phone = currentNotification?.customer?.phone || currentNotification?.sender?.phone || currentNotification?.lead?.phone;
      if (!phone) { showToast('No phone number', 'error'); return; }
      window.open(`tel:${phone}`, '_self');
    }

    function emailCustomer() {
      const email = currentNotification?.customer?.email || currentNotification?.sender?.email || currentNotification?.lead?.email;
      if (!email) { showToast('No email', 'error'); return; }
      window.open(`mailto:${email}`, '_blank');
    }

    function viewCustomerProfile() {
      if (currentNotification?.customer) openCustomerDetailModal(currentNotification.customer);
      else if (currentNotification?.lead) openLeadModal(currentNotification.lead.id);
    }

    function attachFile() {
      showToast('File attachments coming soon', 'info');
    }

    // Message status icon helper
    function getMessageStatusIcon(status) {
      if (status === 'read') {
        return '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      } else if (status === 'delivered') {
        return '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      }
      return '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
    }

    // Delete message with confirmation
    async function deleteMessage(messageId) {
      if (!confirm('Delete this message? This cannot be undone.')) return;

      try {
        const { error } = await supabaseClient
          .from('customer_messages')
          .delete()
          .eq('id', messageId);

        if (error) throw error;

        showToast('Message deleted', 'success');

        // Reload thread
        if (currentNotification) {
          await loadThreadMessages(currentNotification.id);
        }
      } catch (err) {
        console.error('Delete message error:', err);
        showToast('Failed to delete message', 'error');
      }
    }

    // Reply to a specific message
    function replyToMessage(messageId) {
      const inputEl = document.getElementById('message-input');
      if (inputEl) {
        inputEl.focus();
        inputEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // Toggle conversations list on mobile
    function toggleConversationsList() {
      const list = document.querySelector('#page-messages .conversations-list');
      const toggle = document.querySelector('.conversations-toggle');
      if (list && toggle) {
        list.classList.toggle('collapsed');
        toggle.classList.toggle('collapsed');
      }
    }

    // Mobile: auto-collapse conversations when selecting
    function mobileCollapseOnSelect() {
      if (window.innerWidth <= 768) {
        const list = document.querySelector('#page-messages .conversations-list');
        const toggle = document.querySelector('.conversations-toggle');
        if (list && toggle) {
          list.classList.add('collapsed');
          toggle.classList.add('collapsed');
        }
      }
    }

    // New Message Composer - Full Featured
    let composeRecipient = null;
    let allContacts = [];

    function openNewMessageModal() {
      // Create compose modal
      const existing = document.getElementById('compose-message-modal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'compose-message-modal';
      modal.onclick = function(e) { if (e.target === modal) closeComposeModal(); };
      modal.innerHTML = `
        <div class="modal compose-modal">
          <div class="modal-header">
            <h2>New Message</h2>
            <button class="modal-close" onclick="closeComposeModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" style="padding: 0;">
            <!-- Recipient Selection -->
            <div class="compose-section">
              <label class="compose-label">To:</label>
              <div id="compose-recipient-display" style="display: none;" class="compose-recipient-chip">
                <span id="compose-recipient-name"></span>
                <button type="button" onclick="clearComposeRecipient()" class="chip-remove">&times;</button>
              </div>
              <input type="text" id="compose-recipient-search" class="compose-input" placeholder="Search contacts or enter email/phone..." oninput="searchComposeRecipients(this.value)" onfocus="showContactSuggestions()">
              <div id="compose-suggestions" class="compose-suggestions"></div>
            </div>

            <!-- Manual Entry Toggle -->
            <div class="compose-section" id="manual-entry-section" style="display: none;">
              <div class="manual-entry-fields">
                <input type="text" id="compose-manual-name" class="compose-input" placeholder="Name (optional)">
                <input type="email" id="compose-manual-email" class="compose-input" placeholder="Email">
                <input type="tel" id="compose-manual-phone" class="compose-input" placeholder="Phone (optional)">
              </div>
            </div>

            <!-- Channel Selection -->
            <div class="compose-section">
              <label class="compose-label">Send via:</label>
              <div class="compose-channels">
                <label class="channel-chip selected" data-channel="email">
                  <input type="radio" name="compose-channel" value="email" checked>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Email
                </label>
                <label class="channel-chip" data-channel="sms">
                  <input type="radio" name="compose-channel" value="sms">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  SMS
                </label>
                <label class="channel-chip" data-channel="in_app">
                  <input type="radio" name="compose-channel" value="in_app">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                  In-App
                </label>
              </div>
            </div>

            <!-- Subject (for email) -->
            <div class="compose-section" id="compose-subject-section">
              <input type="text" id="compose-subject" class="compose-input" placeholder="Subject">
            </div>

            <!-- Message -->
            <div class="compose-section compose-message-section">
              <textarea id="compose-message" class="compose-textarea" placeholder="Type your message..." rows="4"></textarea>
            </div>

            <!-- Quick Templates -->
            <div class="compose-section">
              <div class="quick-templates">
                <button type="button" class="template-chip" onclick="insertTemplate('estimate')">Send Estimate</button>
                <button type="button" class="template-chip" onclick="insertTemplate('followup')">Follow Up</button>
                <button type="button" class="template-chip" onclick="insertTemplate('payment')">Payment Link</button>
                <button type="button" class="template-chip" onclick="insertTemplate('schedule')">Schedule Visit</button>
              </div>
            </div>
          </div>
          <div class="modal-footer compose-footer">
            <button type="button" class="btn-modern secondary" onclick="closeComposeModal()">Cancel</button>
            <button type="button" class="btn-modern primary" id="compose-send-btn" onclick="sendComposeMessage()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              Send
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Setup channel toggle
      modal.querySelectorAll('.channel-chip').forEach(chip => {
        chip.addEventListener('click', function() {
          modal.querySelectorAll('.channel-chip').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          this.querySelector('input').checked = true;
          // Show/hide subject for email
          const subjectSection = document.getElementById('compose-subject-section');
          if (subjectSection) {
            subjectSection.style.display = this.dataset.channel === 'email' ? 'block' : 'none';
          }
        });
      });

      // Load contacts
      loadAllContacts();
    }

    function closeComposeModal() {
      const modal = document.getElementById('compose-message-modal');
      if (modal) modal.remove();
      composeRecipient = null;
    }

    async function loadAllContacts() {
      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) return;

        allContacts = [];

        // Load customers
        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone')
          .eq('user_id', user.data.user.id)
          .limit(100);

        (customers || []).forEach(c => {
          allContacts.push({
            id: c.id,
            type: 'customer',
            name: c.name || c.email || 'Unknown',
            email: c.email,
            phone: c.phone,
            label: 'Customer'
          });
        });

        // Load leads (RLS handles user filtering)
        const { data: leads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, phone')
          .limit(100);

        (leads || []).forEach(l => {
          allContacts.push({
            id: l.id,
            type: 'lead',
            name: l.full_name || l.email || 'Unknown',
            email: l.email,
            phone: l.phone,
            label: 'Lead'
          });
        });

        // Load collaborators (may not exist for all users)
        try {
          const { data: collaborators } = await supabaseClient
            .from('collaborators')
            .select('id, name, email, phone')
            .eq('user_id', user.data.user.id)
            .limit(50);

          (collaborators || []).forEach(c => {
            allContacts.push({
              id: c.id,
              type: 'contractor',
              name: c.name || c.email || 'Unknown',
              email: c.email,
              phone: c.phone,
              label: 'Contractor'
            });
          });
        } catch (contractorErr) {
          console.warn('Collaborators table not available:', contractorErr);
        }

      } catch (err) {
        console.error('Load contacts error:', err);
      }
    }

    function showContactSuggestions() {
      if (composeRecipient) return;
      searchComposeRecipients('');
    }

    function searchComposeRecipients(query) {
      const suggestionsEl = document.getElementById('compose-suggestions');
      if (!suggestionsEl) return;

      const q = query.toLowerCase().trim();

      // Check if it looks like an email or phone
      const isEmail = q.includes('@') || /^[a-z0-9._%+-]+$/i.test(q);
      const isPhone = /^[\d\s\-\(\)\+]+$/.test(q) && q.replace(/\D/g, '').length >= 7;

      let filtered = allContacts.filter(c => {
        if (!q) return true;
        return (c.name || '').toLowerCase().includes(q) ||
               (c.email || '').toLowerCase().includes(q) ||
               (c.phone || '').includes(q);
      }).slice(0, 8);

      let html = '';

      // Manual entry option at top if query looks like contact info
      if (q && (isEmail || isPhone)) {
        html += `
          <div class="suggestion-item manual" onclick="setManualRecipient('${escapeHtml(q)}')">
            <div class="suggestion-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            </div>
            <div class="suggestion-details">
              <div class="suggestion-name">Send to "${escapeHtml(q)}"</div>
              <div class="suggestion-meta">Manual entry</div>
            </div>
          </div>
        `;
      }

      // Contact results
      if (filtered.length > 0) {
        filtered.forEach(c => {
          const initials = (c.name || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          html += `
            <div class="suggestion-item" onclick="selectComposeRecipient('${c.type}', '${c.id}', '${escapeHtml(c.name)}', '${c.email || ''}', '${c.phone || ''}')">
              <div class="suggestion-avatar">${initials}</div>
              <div class="suggestion-details">
                <div class="suggestion-name">${escapeHtml(c.name)}</div>
                <div class="suggestion-meta">${c.email || c.phone || ''} <span class="suggestion-badge">${c.label}</span></div>
              </div>
            </div>
          `;
        });
      } else if (!q) {
        html = '<div class="suggestion-empty">Start typing to search contacts...</div>';
      } else if (!isEmail && !isPhone) {
        html += '<div class="suggestion-empty">No contacts found. Enter an email or phone number.</div>';
      }

      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = html ? 'block' : 'none';
    }

    function selectComposeRecipient(type, id, name, email, phone) {
      composeRecipient = { type, id, name, email, phone };

      document.getElementById('compose-recipient-search').style.display = 'none';
      document.getElementById('compose-suggestions').style.display = 'none';
      document.getElementById('compose-recipient-display').style.display = 'flex';
      document.getElementById('compose-recipient-name').textContent = name + (email ? ` (${email})` : phone ? ` (${phone})` : '');

      // Focus message input
      document.getElementById('compose-message').focus();
    }

    function setManualRecipient(value) {
      const isEmail = value.includes('@');
      composeRecipient = {
        type: 'manual',
        id: null,
        name: '',
        email: isEmail ? value : '',
        phone: isEmail ? '' : value
      };

      document.getElementById('compose-recipient-search').style.display = 'none';
      document.getElementById('compose-suggestions').style.display = 'none';
      document.getElementById('compose-recipient-display').style.display = 'flex';
      document.getElementById('compose-recipient-name').textContent = value;

      // Auto-select channel based on input
      if (!isEmail) {
        document.querySelector('.channel-chip[data-channel="sms"]').click();
      }

      document.getElementById('compose-message').focus();
    }

    function clearComposeRecipient() {
      composeRecipient = null;
      document.getElementById('compose-recipient-search').style.display = 'block';
      document.getElementById('compose-recipient-search').value = '';
      document.getElementById('compose-recipient-display').style.display = 'none';
      document.getElementById('compose-suggestions').style.display = 'none';
      document.getElementById('compose-recipient-search').focus();
    }

    function insertTemplate(type) {
      const messageEl = document.getElementById('compose-message');
      const subjectEl = document.getElementById('compose-subject');
      if (!messageEl) return;

      const templates = {
        estimate: {
          subject: 'Your Estimate from Surprise Granite',
          message: 'Hi,\n\nThank you for your interest in Surprise Granite! I\'ve prepared an estimate for your project.\n\nPlease review it at your convenience and let me know if you have any questions.\n\nBest regards'
        },
        followup: {
          subject: 'Following Up - Surprise Granite',
          message: 'Hi,\n\nI wanted to follow up on our recent conversation about your project.\n\nDo you have any questions I can help answer? I\'m happy to schedule a time to discuss further.\n\nBest regards'
        },
        payment: {
          subject: 'Payment Request - Surprise Granite',
          message: 'Hi,\n\nThank you for choosing Surprise Granite!\n\nPlease use the link below to complete your payment securely:\n[Payment Link]\n\nLet me know if you have any questions.\n\nBest regards'
        },
        schedule: {
          subject: 'Schedule Your Appointment - Surprise Granite',
          message: 'Hi,\n\nI\'d like to schedule a visit to take measurements and discuss your project in detail.\n\nWhat days/times work best for you this week?\n\nBest regards'
        }
      };

      const template = templates[type];
      if (template) {
        if (subjectEl) subjectEl.value = template.subject;
        messageEl.value = template.message;
        messageEl.focus();
      }
    }

    async function sendComposeMessage() {
      const messageEl = document.getElementById('compose-message');
      const subjectEl = document.getElementById('compose-subject');
      const sendBtn = document.getElementById('compose-send-btn');
      const channel = document.querySelector('input[name="compose-channel"]:checked')?.value || 'email';
      const message = messageEl?.value?.trim();
      const subject = subjectEl?.value?.trim();

      if (!composeRecipient) {
        showToast('Please select a recipient', 'error');
        return;
      }

      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }

      // Validate contact method for channel
      if (channel === 'email' && !composeRecipient.email) {
        showToast('Recipient has no email address', 'error');
        return;
      }
      if (channel === 'sms' && !composeRecipient.phone) {
        showToast('Recipient has no phone number', 'error');
        return;
      }

      // Disable button
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="spinner-modern" style="width:16px;height:16px;"></div> Sending...';
      }

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) throw new Error('Not authenticated');

        // For email channel, send via API
        if (channel === 'email' && composeRecipient.email) {
          try {
            await apiCall('/api/send-estimate', {
              method: 'POST',
              body: JSON.stringify({
                email: composeRecipient.email,
                counterSqft: subject || 'Message from Surprise Granite',
                splashSqft: '',
                totalSqft: '',
                edgeProfile: `From: ${user.data.user.email}`,
                edgeLF: '',
                priceBudget: message,
                pricePopular: '',
                pricePremium: ''
              })
            });
          } catch (emailErr) {
            console.warn('Email send error (continuing):', emailErr);
            // Continue even if email fails - we'll save to database
          }
        }

        // For SMS channel - log for now (requires Twilio setup)
        if (channel === 'sms') {
          console.log('SMS would be sent to:', composeRecipient.phone, 'Message:', message);
          // SMS integration can be added later with Twilio
        }

        // Save to database for any recipient type
        if (composeRecipient.type === 'customer' && composeRecipient.id) {
          await supabaseClient.from('customer_messages').insert({
            customer_id: composeRecipient.id,
            sender_id: user.data.user.id,
            direction: 'outbound',
            channel: channel,
            message: message,
            subject: subject || null,
            sent_from: user.data.user.email,
            sent_to: composeRecipient.email || composeRecipient.phone,
            status: 'sent'
          });
        } else if (composeRecipient.type === 'lead' && composeRecipient.id) {
          // For leads, we could create a customer_messages entry or log it
          console.log('Message to lead:', composeRecipient.id, message);
        }

        showToast(`Message sent via ${channel.toUpperCase()}`, 'success');
        closeComposeModal();

        // Refresh conversations if on messages page
        if (document.getElementById('page-messages')?.classList.contains('active')) {
          loadConversations();
        }

      } catch (err) {
        console.error('Send message error:', err);
        showToast(err.message || 'Failed to send message', 'error');
      } finally {
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Send';
        }
      }
    }

    async function startNewConversation(customerId) {
      await selectConversation(customerId);
      const inputEl = document.getElementById('message-input');
      if (inputEl) inputEl.focus();
    }

    // Payment Request Modal Functions
    function openPaymentModal(inquiryId, customerName, customerEmail, listingTitle) {
      document.getElementById('payment-inquiry-id').value = inquiryId;
      document.getElementById('payment-customer-email').value = customerEmail;
      document.getElementById('payment-customer-name').value = customerName;
      document.getElementById('payment-recipient-name').textContent = customerName;
      document.getElementById('payment-recipient-email').textContent = customerEmail;
      document.getElementById('payment-description').value = listingTitle;
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-request-modal').style.display = 'flex';
    }

    function closePaymentModal() {
      document.getElementById('payment-request-modal').style.display = 'none';
    }

    async function sendPaymentRequest(event) {
      event.preventDefault();

      const sendBtn = document.getElementById('send-payment-btn');
      const originalText = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Creating...';

      try {
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const description = document.getElementById('payment-description').value;
        const customerEmail = document.getElementById('payment-customer-email').value;
        const customerName = document.getElementById('payment-customer-name').value;
        const note = document.getElementById('payment-note').value;

        // Create payment link via API
        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/payment-links', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: amount,
            description: description,
            customer_email: customerEmail
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create payment link');
        }

        // Send email with payment link
        const emailResponse = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: customerName,
            email: customerEmail,
            subject: `Payment Request for ${description}`,
            message: `
              <p>Hello ${customerName},</p>
              ${note ? `<p>${note}</p>` : '<p>Thank you for your interest in our stone remnant!</p>'}
              <p><strong>Amount Due:</strong> $${amount.toFixed(2)}</p>
              <p><strong>Description:</strong> ${description}</p>
              <p style="margin: 24px 0;">
                <a href="${result.payment_link.url}" style="display: inline-block; background: #f9cb00; color: #1a1a2e; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600;">Pay Now</a>
              </p>
              <p style="font-size: 13px; color: #666;">Or copy this link: ${result.payment_link.url}</p>
            `,
            source: 'marketplace-payment-request'
          })
        });

        closePaymentModal();
        showToast('Payment link sent to ' + customerEmail);

      } catch (err) {
        console.error('Payment request error:', err);
        alert('Failed to send payment request: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }

      return false;
    }

    // ============ QUICK PAY FUNCTIONS ============
    let quickPayData = {};

    function openQuickPayModal() {
      document.getElementById('quick-pay-modal').classList.add('active');
      document.getElementById('quick-pay-form-state').style.display = 'block';
      document.getElementById('quick-pay-result-state').style.display = 'none';
      document.getElementById('quick-pay-form').reset();
    }

    function closeQuickPayModal() {
      document.getElementById('quick-pay-modal').classList.remove('active');
    }

    function resetQuickPayModal() {
      document.getElementById('quick-pay-form-state').style.display = 'block';
      document.getElementById('quick-pay-result-state').style.display = 'none';
      document.getElementById('quick-pay-form').reset();
    }

    async function generateQuickPayLink(event) {
      event.preventDefault();

      const btn = document.getElementById('qp-generate-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Creating...';

      try {
        const name = document.getElementById('qp-name').value.trim();
        const email = document.getElementById('qp-email').value.trim();
        const phone = document.getElementById('qp-phone').value.trim();
        const amount = parseFloat(document.getElementById('qp-amount').value);
        const description = document.getElementById('qp-description').value.trim() || 'Payment to Surprise Granite';

        if (!name || !email || !amount || amount <= 0) {
          throw new Error('Please fill in all required fields');
        }

        // Create payment link via API (with authentication)
        const response = await apiCall('/api/payment-links', {
          method: 'POST',
          body: JSON.stringify({
            amount: amount,
            description: description,
            customer_email: email,
            customer_name: name
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create payment link');
        }

        // Store data for sharing
        quickPayData = {
          name,
          email,
          phone,
          amount,
          description,
          url: result.payment_link.url
        };

        // Update result display
        document.getElementById('qp-result-name').textContent = name;
        document.getElementById('qp-result-amount').textContent = '$' + amount.toFixed(2);
        document.getElementById('qp-link-display').value = result.payment_link.url;

        // Generate QR code using free API
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(result.payment_link.url)}`;
        document.getElementById('qp-qr-code').src = qrUrl;

        // Switch to result state
        document.getElementById('quick-pay-form-state').style.display = 'none';
        document.getElementById('quick-pay-result-state').style.display = 'block';

        showToast('Payment link created!', 'success');

      } catch (err) {
        console.error('Quick pay error:', err);
        showToast(err.message || 'Failed to create payment link', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Generate Link';
      }

      return false;
    }

    async function copyQuickPayLink() {
      try {
        await navigator.clipboard.writeText(quickPayData.url);
        showToast('Payment link copied!', 'success');
      } catch (err) {
        // Fallback for older browsers
        const input = document.getElementById('qp-link-display');
        input.select();
        document.execCommand('copy');
        showToast('Payment link copied!', 'success');
      }
    }

    async function sendQuickPayEmail() {
      const btn = event.target.closest('button');
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';

      try {
        const emailResponse = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: quickPayData.name,
            email: quickPayData.email,
            subject: `Payment Request - $${quickPayData.amount.toFixed(2)}`,
            message: `
              <p>Hello ${quickPayData.name},</p>
              <p>Here's your secure payment link for <strong>${quickPayData.description}</strong>.</p>
              <p style="font-size: 24px; font-weight: bold; color: #f9cb00;">Amount Due: $${quickPayData.amount.toFixed(2)}</p>
              <p style="margin: 24px 0;">
                <a href="${quickPayData.url}" style="display: inline-block; background: #f9cb00; color: #1a1a2e; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600;">Pay Now</a>
              </p>
              <p style="font-size: 13px; color: #666;">Or copy this link: ${quickPayData.url}</p>
              <p style="margin-top: 24px;">Thank you for your business!</p>
              <p>- Surprise Granite</p>
            `,
            source: 'quick-pay'
          })
        });

        if (emailResponse.ok) {
          showToast(`Payment link sent to ${quickPayData.email}!`, 'success');
        } else {
          throw new Error('Email failed to send');
        }
      } catch (err) {
        // Fallback to mailto
        const subject = encodeURIComponent(`Payment Request - $${quickPayData.amount.toFixed(2)}`);
        const body = encodeURIComponent(`Hi ${quickPayData.name},\n\nHere's your payment link for ${quickPayData.description}:\n\nAmount: $${quickPayData.amount.toFixed(2)}\nPay here: ${quickPayData.url}\n\nThank you!\nSurprise Granite`);
        window.open(`mailto:${quickPayData.email}?subject=${subject}&body=${body}`);
        showToast('Opening email client...', 'info');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    function sendQuickPaySMS() {
      const message = encodeURIComponent(`Hi ${quickPayData.name}! Here's your payment link for $${quickPayData.amount.toFixed(2)}: ${quickPayData.url} - Surprise Granite`);
      const phone = quickPayData.phone ? quickPayData.phone.replace(/\D/g, '') : '';

      // If we have a phone number, open SMS to that number
      if (phone) {
        // Format for different platforms
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
          window.open(`sms:${phone}&body=${message}`);
        } else if (/Android/i.test(navigator.userAgent)) {
          window.open(`sms:${phone}?body=${message}`);
        } else {
          // Desktop - open default SMS handler
          window.open(`sms:${phone}?body=${message}`);
        }
        showToast(`Opening SMS to ${quickPayData.phone}`, 'success');
      } else {
        // No phone - copy to clipboard
        navigator.clipboard.writeText(`Hi ${quickPayData.name}! Here's your payment link for $${quickPayData.amount.toFixed(2)}: ${quickPayData.url} - Surprise Granite`);
        showToast('SMS text copied to clipboard! (No phone number entered)', 'info');
      }
    }

    async function deleteListing(id) {
      if (!confirm('Are you sure you want to delete this listing?')) return;

      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .delete()
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Delete listing error:', err);
        alert('Failed to delete listing');
      }
    }

    async function markListingSold(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({ status: 'sold' })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Mark sold error:', err);
        alert('Failed to update listing');
      }
    }

    async function reactivateListing(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({
            status: 'active',
            expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString()
          })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Reactivate error:', err);
        alert('Failed to reactivate listing');
      }
    }

    function editListing(id) {
      // TODO: Implement edit listing modal
      alert('Edit functionality coming soon!');
    }

    // =============================================
    // ESTIMATES FEATURE
    // =============================================

    let serviceCatalog = [];
    let businessSettings = null;

    async function loadEstimates() {
      console.log('[Estimates] Loading estimates...');
      const listContainer = document.getElementById('estimates-list');
      if (!listContainer) {
        console.warn('[Estimates] No estimates-list container found');
        return;
      }

      listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="loading-spinner"></div><p>Loading estimates...</p></div>';

      try {
        if (!supabaseClient) {
          console.error('[Estimates] supabaseClient not initialized');
          listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><p>Database connection not ready. Please refresh.</p></div>';
          return;
        }
        const { data: { user } } = await supabaseClient.auth.getUser();
        console.log('[Estimates] User:', user?.id);
        if (!user) {
          listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><p>Please log in to view estimates</p></div>';
          return;
        }

        let query = supabaseClient
          .from('estimates')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        // Filter by status
        if (currentEstimateFilter === 'archived') {
          query = query.not('archived_at', 'is', null);
        } else {
          // By default, hide archived estimates
          query = query.is('archived_at', null);
          if (currentEstimateFilter !== 'all') {
            query = query.eq('status', currentEstimateFilter);
          }
        }

        const { data: estimates, error } = await query;
        console.log('[Estimates] Query result:', estimates?.length || 0, 'estimates', error ? 'Error: ' + error.message : '');

        if (error) throw error;

        // Update global estimates array with full data
        const { data: allEstimatesData } = await supabaseClient
          .from('estimates')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (allEstimatesData) {
          allEstimates = allEstimatesData; // Update global array
          const stats = {
            draft: allEstimates.filter(e => e.status === 'draft').length,
            sent: allEstimates.filter(e => e.status === 'sent').length,
            approved: allEstimates.filter(e => e.status === 'approved').length,
            rejected: allEstimates.filter(e => e.status === 'rejected').length
          };
          document.getElementById('stat-draft-estimates').textContent = stats.draft;
          document.getElementById('stat-sent-estimates').textContent = stats.sent;
          document.getElementById('stat-approved-estimates').textContent = stats.approved;
          document.getElementById('stat-rejected-estimates').textContent = stats.rejected;
          document.getElementById('estimates-count').textContent = allEstimates.length;
          document.getElementById('estimates-count').dataset.count = allEstimates.length;
        }

        if (!estimates || estimates.length === 0) {
          listContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 16px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <h3 style="margin-bottom: 8px;">No estimates yet</h3>
              <p style="color: var(--text-muted); margin-bottom: 16px;">Create your first estimate to send to customers</p>
              <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Create First Estimate
              </button>
            </div>`;
          return;
        }

        listContainer.innerHTML = estimates.map(estimate => `
          <div class="estimate-card" style="background: var(--dark-elevated); border-radius: 12px; padding: 20px; margin-bottom: 12px; border: 1px solid var(--border-subtle);"
               data-context-menu="estimate"
               data-item-id="${estimate.id}"
               data-item-data='${JSON.stringify({ estimate_number: estimate.estimate_number, status: estimate.status, customer_name: estimate.customer_name }).replace(/'/g, "&#39;")}'>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                  <span style="font-size: 18px; font-weight: 600;">${estimate.estimate_number || 'Draft'}</span>
                  <span class="status-badge status-${estimate.status}" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                    ${estimate.status}
                  </span>
                </div>
                <div style="color: var(--text-secondary);">${estimate.customer_name}</div>
                ${estimate.project_name ? `<div style="color: var(--text-muted); font-size: 13px;">${estimate.project_name}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="font-size: 20px; font-weight: 700; color: var(--gold-primary);">$${(estimate.total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${new Date(estimate.created_at).toLocaleDateString()}</div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn-modern secondary small" onclick="viewEstimate('${estimate.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                View
              </button>
              <button class="btn-modern secondary small" onclick="scheduleForEstimate('${estimate.id}', '${(estimate.estimate_number || '').replace(/'/g, '')}', '${(estimate.customer_name || '').replace(/'/g, '')}', '${(estimate.customer_email || '').replace(/'/g, '')}')" title="Schedule Follow-up">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Schedule
              </button>
              ${estimate.status === 'draft' ? `
                <button class="btn-modern primary small" onclick="sendEstimate('${estimate.id}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                  Send
                </button>
              ` : ''}
              ${estimate.status === 'approved' ? `
                <button class="btn-modern success small" onclick="convertToInvoice('${estimate.id}')" style="background: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Convert to Invoice
                </button>
              ` : ''}
              <button class="btn-modern secondary small" onclick="duplicateEstimate('${estimate.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Duplicate
              </button>
              <button class="btn-modern secondary small" onclick="event.stopPropagation(); inviteFromEstimate('${estimate.id}')" title="Invite collaborator">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                Invite
              </button>
              ${!estimate.archived_at ? `
                <button class="btn-modern secondary small" onclick="event.stopPropagation(); createProjectFromEstimate('${estimate.id}')" title="Create Project">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                  Project
                </button>
              ` : ''}
              ${estimate.archived_at ? `
                <button class="btn-modern secondary small" onclick="unarchiveEstimate('${estimate.id}')" title="Restore">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  Restore
                </button>
                <button class="btn-modern small" onclick="deleteEstimatePermanent('${estimate.id}')" style="color: #ef4444;" title="Delete Permanently">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              ` : `
                <button class="btn-modern small" onclick="archiveEstimate('${estimate.id}')" style="color: #6b7280;" title="Archive">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                </button>
              `}
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Load estimates error:', err);
        listContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--error);">Error loading estimates: ${escapeHtml(err.message || 'Unknown error')}</div>`;
      }
    }

    function filterEstimates(status) {
      currentEstimateFilter = status;

      // Update active filter button
      document.querySelectorAll('[data-estimate-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.estimateStatus === status);
      });

      loadEstimates();
    }

    async function openCreateEstimateModal(preserveState = false) {
      const modal = document.getElementById('create-estimate-modal');
      modal.classList.add('active');
      document.getElementById('create-estimate-form').reset();

      // Reset state unless preserveState is true (called from startEstimateFromLead/Customer)
      if (!preserveState) {
        estimateModalState = {
          customerId: null,
          leadId: null,
          editingEstimateId: null
        };
      }

      // Reset line items container with empty message
      const container = document.getElementById('estimate-line-items');
      container.innerHTML = `<div id="empty-line-items-msg" style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        <br>No items added yet. Click "Add Item" or "From Catalog" to begin.
      </div>`;

      // Set current date display
      const today = new Date();
      document.getElementById('estimate-date-display').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

      // Set default valid until date (30 days from now)
      updateEstimateValidDate();

      // Get next estimate number
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          const { data } = await supabaseClient.rpc('get_next_estimate_number', { p_user_id: user.id });
          document.getElementById('estimate-number-display').textContent = data || '0001';
        }
      } catch (err) {
        document.getElementById('estimate-number-display').textContent = '0001';
      }

      // Load business settings defaults
      loadBusinessDefaults();

      // Reset category subtotals
      document.getElementById('subtotal-material').textContent = '$0.00';
      document.getElementById('subtotal-labor').textContent = '$0.00';
      document.getElementById('subtotal-service').textContent = '$0.00';

      // Reset totals
      calculateEstimateTotals();
    }

    function updateEstimateValidDate() {
      const days = parseInt(document.getElementById('estimate-valid-days').value) || 30;
      const validUntil = new Date();
      validUntil.setDate(validUntil.getDate() + days);
      document.getElementById('estimate-valid-until').value = validUntil.toISOString().split('T')[0];
    }

    function toggleAddItemMenu() {
      const menu = document.getElementById('add-item-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';

      // Close when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!e.target.closest('.dropdown')) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 10);
    }

    function updatePaymentSchedule() {
      const type = document.getElementById('payment-schedule-type').value;
      const container = document.getElementById('payment-schedule-container');
      const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;

      if (type === 'deposit-balance') {
        const depositPercent = parseFloat(document.getElementById('estimate-deposit-percent').value) || 50;
        container.innerHTML = `
          <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="padding: 16px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 14px;">1. Deposit Required</span>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="estimate-deposit-percent" value="${depositPercent}" min="0" max="100" style="width: 50px; text-align: center; padding: 4px; font-size: 13px;" onchange="updateEstimateTotals()">
                  <span style="font-size: 13px;">%</span>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
              <div id="estimate-deposit-amount" style="font-size: 22px; font-weight: 700; color: var(--gold-primary);">$${(total * depositPercent / 100).toFixed(2)}</div>
            </div>
            <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 14px;">2. Balance Due</span>
                <span id="estimate-balance-percent" style="font-size: 13px; color: var(--text-muted);">${100 - depositPercent}%</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon completion</div>
              <div id="estimate-balance-amount" style="font-size: 22px; font-weight: 700;">$${(total * (100 - depositPercent) / 100).toFixed(2)}</div>
            </div>
          </div>`;
      } else if (type === 'three-part') {
        container.innerHTML = `
          <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <div style="padding: 14px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">1. Deposit (33%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gold-primary);">$${(total * 0.33).toFixed(2)}</div>
            </div>
            <div style="padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">2. Progress (33%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">At project midpoint</div>
              <div style="font-size: 18px; font-weight: 700;">$${(total * 0.33).toFixed(2)}</div>
            </div>
            <div style="padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">3. Final (34%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Upon completion</div>
              <div style="font-size: 18px; font-weight: 700;">$${(total * 0.34).toFixed(2)}</div>
            </div>
          </div>`;
      } else if (type === 'due-on-completion') {
        container.innerHTML = `
          <div class="payment-schedule-items">
            <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px; text-align: center;">
              <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px;">Full Amount Due Upon Completion</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">No deposit required</div>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${total.toFixed(2)}</div>
            </div>
          </div>`;
      } else {
        container.innerHTML = `
          <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Define your custom payment milestones in the notes section above.</p>
            <div style="font-weight: 600;">Total: <span style="color: var(--gold-primary);">$${total.toFixed(2)}</span></div>
          </div>`;
      }
    }

    function loadTermsTemplate() {
      const defaultTerms = `1. ACCEPTANCE: This estimate is valid for the period specified above. Acceptance of this estimate constitutes agreement to all terms and conditions.

2. PAYMENT: Payment terms as outlined in the payment schedule above. We accept cash, check, and major credit cards. A 3% processing fee applies to credit card payments.

3. CHANGES: Any changes to the scope of work after acceptance may result in additional charges and timeline adjustments.

4. WARRANTY: Workmanship is warranted as specified above. Manufacturer warranties apply to all materials as per their terms.

5. ACCESS: Customer agrees to provide reasonable access to the work area during normal business hours.

6. COMPLETION: Estimated timelines are approximate and may vary based on material availability and unforeseen conditions.`;

      document.getElementById('estimate-terms').value = defaultTerms;

      if (businessSettings && businessSettings.default_warranty_terms) {
        document.getElementById('estimate-warranty').value = businessSettings.default_warranty_terms;
      } else {
        document.getElementById('estimate-warranty').value = '1 year workmanship warranty';
      }
    }

    function previewEstimate() {
      // Collect all form data and generate a preview
      const customerName = document.getElementById('estimate-customer-name').value.trim() || 'Customer Name';
      const projectName = document.getElementById('estimate-project-name').value.trim() || 'Project';
      const estimateNumber = document.getElementById('estimate-number-display').textContent;
      const estimateDate = document.getElementById('estimate-date-display').textContent;

      // Get business settings for branding
      const companyName = businessSettings?.company_name || 'Your Company Name';
      const companyPhone = businessSettings?.phone || '';
      const companyEmail = businessSettings?.email || '';
      const companyWebsite = businessSettings?.website || '';
      const companyLogo = businessSettings?.logo_url || '';
      const companyAddress = [
        businessSettings?.address,
        [businessSettings?.city, businessSettings?.state, businessSettings?.zip].filter(Boolean).join(', ')
      ].filter(Boolean).join(', ');
      const companyContact = [companyPhone, companyEmail].filter(Boolean).join(' | ');

      // Collect line items
      const lineItems = [];
      document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
        const name = item.querySelector('.item-name').value.trim();
        if (name) {
          lineItems.push({
            name: name,
            description: item.querySelector('.item-desc').value.trim(),
            unit: item.querySelector('.item-unit').value,
            quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
            unit_price: parseFloat(item.querySelector('.item-price').value) || 0,
            category: item.querySelector('.item-category').value || 'other'
          });
        }
      });

      // Get totals
      const subtotal = document.getElementById('estimate-subtotal').textContent;
      const taxAmount = document.getElementById('estimate-tax-amount').textContent;
      const discountAmount = document.getElementById('estimate-discount-amount').textContent;
      const total = document.getElementById('estimate-total').textContent;
      const depositAmount = document.getElementById('estimate-deposit-amount').textContent;

      // Generate preview HTML
      const previewHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Estimate Preview - ${estimateNumber}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
            .estimate-preview { max-width: 800px; margin: 0 auto; background: #fff; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
            .header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); color: #fff; padding: 30px; display: flex; justify-content: space-between; align-items: center; }
            .header h1 { font-size: 28px; color: #f9cb00; }
            .header .est-number { font-size: 14px; color: #aaa; }
            .header .est-number strong { color: #f9cb00; }
            .customer-section { padding: 20px 30px; border-bottom: 1px solid #eee; }
            .customer-section h3 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 8px; }
            .customer-section p { font-size: 15px; line-height: 1.6; }
            .items-section { padding: 20px 30px; }
            .items-section h3 { font-size: 14px; margin-bottom: 15px; color: #333; }
            .items-table { width: 100%; border-collapse: collapse; }
            .items-table th { background: #f5f5f5; padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
            .items-table td { padding: 12px 10px; border-bottom: 1px solid #eee; }
            .items-table .category-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
            .totals-section { padding: 20px 30px; background: #f9f9f9; }
            .totals-row { display: flex; justify-content: space-between; padding: 8px 0; }
            .totals-row.total { font-size: 20px; font-weight: bold; border-top: 2px solid #f9cb00; padding-top: 15px; margin-top: 10px; }
            .deposit-box { background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border: 1px solid rgba(249,203,0,0.3); padding: 15px 20px; border-radius: 8px; margin-top: 15px; }
            .footer { padding: 20px 30px; background: #1a1a1a; color: #888; font-size: 12px; text-align: center; }
            .preview-banner { background: #f9cb00; color: #1a1a1a; padding: 10px; text-align: center; font-weight: bold; }
            @media print { .preview-banner { display: none; } body { padding: 0; } .estimate-preview { box-shadow: none; } }
          </style>
        </head>
        <body>
          <div class="preview-banner">PREVIEW - This is how your estimate will appear to the customer</div>
          <div class="estimate-preview">
            <div class="header">
              <div style="display: flex; align-items: center; gap: 20px;">
                ${companyLogo ? `<img src="${companyLogo}" alt="Logo" style="height: 60px; width: auto; max-width: 120px; object-fit: contain; border-radius: 8px;">` : `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f9cb00, #cca600); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: #1a1a1a;">${companyName.substring(0,2).toUpperCase()}</div>`}
                <div>
                  <div style="font-size: 22px; font-weight: 700;">${companyName}</div>
                  ${companyAddress ? `<div style="font-size: 12px; color: #aaa; margin-top: 4px;">${companyAddress}</div>` : ''}
                  ${companyContact ? `<div style="font-size: 12px; color: #aaa;">${companyContact}</div>` : ''}
                </div>
              </div>
              <div style="text-align: right;">
                <h1 style="font-size: 28px; color: #f9cb00; margin: 0;">ESTIMATE</h1>
                <div class="est-number" style="margin-top: 8px;">Estimate #: <strong>${estimateNumber}</strong></div>
                <div style="font-size: 12px; color: #888;">Date: ${estimateDate}</div>
              </div>
            </div>

            <div class="customer-section">
              <h3>Prepared For</h3>
              <p><strong>${customerName}</strong></p>
              <p>${document.getElementById('estimate-customer-address').value || ''} ${document.getElementById('estimate-customer-city').value || ''}</p>
              <p style="margin-top: 10px;"><strong>Project:</strong> ${projectName}</p>
            </div>

            <div class="items-section">
              <h3>Items & Services</h3>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Unit</th>
                    <th style="text-align:center;">Qty</th>
                    <th style="text-align:right;">Price</th>
                    <th style="text-align:right;">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${lineItems.map(item => {
                    const colors = { material: '#3b82f6', labor: '#22c55e', service: '#a855f7', other: '#6b7280' };
                    return `<tr>
                      <td><span class="category-dot" style="background:${colors[item.category] || '#6b7280'}"></span>${item.name}${item.description ? '<br><small style="color:#888">' + item.description + '</small>' : ''}</td>
                      <td>${item.unit}</td>
                      <td style="text-align:center;">${item.quantity}</td>
                      <td style="text-align:right;">$${item.unit_price.toFixed(2)}</td>
                      <td style="text-align:right;">$${(item.quantity * item.unit_price).toFixed(2)}</td>
                    </tr>`;
                  }).join('')}
                  ${lineItems.length === 0 ? '<tr><td colspan="5" style="text-align:center;color:#888;padding:20px;">No items added</td></tr>' : ''}
                </tbody>
              </table>
            </div>

            <div class="totals-section">
              <div class="totals-row"><span>Subtotal</span><span>${subtotal}</span></div>
              <div class="totals-row"><span>Tax</span><span>${taxAmount}</span></div>
              <div class="totals-row"><span>Discount</span><span>${discountAmount}</span></div>
              <div class="totals-row total"><span>TOTAL</span><span style="color:#f9cb00;">${total}</span></div>
              <div class="deposit-box">
                <div style="display:flex;justify-content:space-between;"><span><strong>Deposit Required</strong></span><span style="font-size:18px;font-weight:bold;color:#f9cb00;">${depositAmount}</span></div>
                <div style="font-size:12px;color:#666;margin-top:5px;">Due upon approval to begin project</div>
              </div>
            </div>

            <div class="footer">
              <p>Thank you for choosing <strong>${companyName}</strong>!</p>
              ${companyWebsite ? `<p style="margin-top: 5px;">${companyWebsite}</p>` : ''}
            </div>
          </div>
          <div style="text-align:center;margin-top:20px;">
            <button onclick="window.print()" style="padding:10px 20px;background:#f9cb00;border:none;border-radius:5px;cursor:pointer;font-weight:bold;">Print Preview</button>
            <button onclick="window.close()" style="padding:10px 20px;background:#333;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-left:10px;">Close</button>
          </div>
        </body>
        </html>
      `;

      // Open in new window
      const previewWindow = window.open('', '_blank', 'width=900,height=700');
      previewWindow.document.write(previewHtml);
      previewWindow.document.close();
    }

    function closeCreateEstimateModal() {
      const modal = document.getElementById('create-estimate-modal');
      modal.classList.remove('active');
      // Clear any linked customer ID
      if (modal) delete modal.dataset.customerId;
    }

    async function loadBusinessDefaults() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: settings } = await supabaseClient
          .from('business_settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (settings) {
          businessSettings = settings;
          if (settings.default_tax_rate) {
            document.getElementById('estimate-tax-rate').value = settings.default_tax_rate;
          }
          if (settings.default_deposit_percent) {
            document.getElementById('estimate-deposit-percent').value = settings.default_deposit_percent;
          }
          if (settings.default_payment_terms) {
            document.getElementById('estimate-payment-terms').value = settings.default_payment_terms;
          }
          if (settings.default_warranty_terms) {
            document.getElementById('estimate-warranty').value = settings.default_warranty_terms;
          }
        }
      } catch (err) {
        console.log('No business settings found');
      }
    }

    function addEstimateLineItem(category = 'material', itemData = null) {
      const container = document.getElementById('estimate-line-items');

      // Remove empty message if present
      const emptyMsg = document.getElementById('empty-line-items-msg');
      if (emptyMsg) emptyMsg.remove();

      // Close the add item menu
      const menu = document.getElementById('add-item-menu');
      if (menu) menu.style.display = 'none';

      const template = document.querySelector('.line-item-template .estimate-line-item').cloneNode(true);

      // Set category
      const categoryColors = {
        material: '#3b82f6',
        labor: '#22c55e',
        service: '#a855f7',
        other: '#6b7280'
      };

      template.dataset.category = category;
      template.querySelector('.item-category').value = category;
      template.querySelector('.category-dot').style.background = categoryColors[category] || '#6b7280';
      template.querySelector('.category-dot').title = category.charAt(0).toUpperCase() + category.slice(1);

      // Set default unit based on category
      const unitSelect = template.querySelector('.item-unit');
      if (category === 'labor') {
        unitSelect.value = 'hour';
      } else if (category === 'service') {
        unitSelect.value = 'job';
      } else if (category === 'material') {
        unitSelect.value = 'sqft';
      }

      // Set values if item data provided
      if (itemData) {
        template.querySelector('.item-name').value = itemData.name || '';
        template.querySelector('.item-desc').value = itemData.description || '';
        template.querySelector('.item-unit').value = itemData.unit || unitSelect.value;
        template.querySelector('.item-qty').value = itemData.quantity || 1;
        template.querySelector('.item-price').value = itemData.price || 0;
      }

      // Add event listeners for real-time calculation
      template.querySelector('.item-qty').addEventListener('input', calculateEstimateTotals);
      template.querySelector('.item-price').addEventListener('input', calculateEstimateTotals);
      const costInput = template.querySelector('.item-cost');
      if (costInput) costInput.addEventListener('input', calculateEstimateTotals);

      container.appendChild(template);
      calculateEstimateTotals();

      // Focus the name field
      template.querySelector('.item-name').focus();
    }

    function removeEstimateLineItem(button) {
      const lineItem = button.closest('.estimate-line-item');
      lineItem.remove();
      calculateEstimateTotals();
    }

    function calculateEstimateTotals() {
      const lineItems = document.querySelectorAll('#estimate-line-items .estimate-line-item');
      let subtotal = 0;
      let totalCost = 0;
      const categoryTotals = { material: 0, labor: 0, service: 0, other: 0 };

      lineItems.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        const costInput = item.querySelector('.item-cost');
        const cost = costInput ? (parseFloat(costInput.value) || 0) : 0;
        const total = qty * price;
        const totalItemCost = qty * cost;
        const category = item.querySelector('.item-category').value || 'other';

        item.querySelector('.item-total').textContent = '$' + total.toFixed(2);
        subtotal += total;
        totalCost += totalItemCost;
        categoryTotals[category] = (categoryTotals[category] || 0) + total;

        // Calculate and display margin for this line item
        const marginEl = item.querySelector('.item-margin');
        if (marginEl) {
          if (cost > 0 && price > 0) {
            const marginPercent = ((price - cost) / cost) * 100;
            marginEl.textContent = marginPercent.toFixed(1) + '%';
            // Color code the margin
            if (marginPercent < 0) {
              marginEl.style.color = '#ef4444'; // Red for negative
            } else if (marginPercent < 20) {
              marginEl.style.color = '#f59e0b'; // Orange for low
            } else {
              marginEl.style.color = '#22c55e'; // Green for good
            }
          } else {
            marginEl.textContent = '--%';
            marginEl.style.color = 'var(--text-muted)';
          }
        }
      });

      // Update category subtotals
      const subtotalMaterial = document.getElementById('subtotal-material');
      const subtotalLabor = document.getElementById('subtotal-labor');
      const subtotalService = document.getElementById('subtotal-service');

      if (subtotalMaterial) subtotalMaterial.textContent = '$' + categoryTotals.material.toFixed(2);
      if (subtotalLabor) subtotalLabor.textContent = '$' + categoryTotals.labor.toFixed(2);
      if (subtotalService) subtotalService.textContent = '$' + (categoryTotals.service + categoryTotals.other).toFixed(2);

      document.getElementById('estimate-subtotal').textContent = '$' + subtotal.toFixed(2);

      // Calculate tax
      const taxRate = parseFloat(document.getElementById('estimate-tax-rate').value) || 0;
      const taxAmount = subtotal * (taxRate / 100);
      document.getElementById('estimate-tax-amount').textContent = '$' + taxAmount.toFixed(2);

      // Calculate discount
      const discountValue = parseFloat(document.getElementById('estimate-discount-value').value) || 0;
      const discountType = document.getElementById('estimate-discount-type').value;
      let discountAmount = 0;
      if (discountType === 'percent') {
        discountAmount = subtotal * (discountValue / 100);
      } else {
        discountAmount = discountValue;
      }
      document.getElementById('estimate-discount-amount').textContent = '-$' + discountAmount.toFixed(2);

      // Calculate total
      const total = subtotal + taxAmount - discountAmount;
      document.getElementById('estimate-total').textContent = '$' + total.toFixed(2);

      // Calculate deposit and balance
      const depositPercentEl = document.getElementById('estimate-deposit-percent');
      const depositPercent = depositPercentEl ? (parseFloat(depositPercentEl.value) || 0) : 50;
      const depositAmount = total * (depositPercent / 100);
      const balanceAmount = total - depositAmount;

      const depositAmountEl = document.getElementById('estimate-deposit-amount');
      const balanceAmountEl = document.getElementById('estimate-balance-amount');
      const balancePercentEl = document.getElementById('estimate-balance-percent');

      if (depositAmountEl) depositAmountEl.textContent = '$' + depositAmount.toFixed(2);
      if (balanceAmountEl) balanceAmountEl.textContent = '$' + balanceAmount.toFixed(2);
      if (balancePercentEl) balancePercentEl.textContent = (100 - depositPercent) + '%';

      // Update margin summary (internal only)
      const totalCostEl = document.getElementById('estimate-total-cost');
      const totalProfitEl = document.getElementById('estimate-total-profit');
      const totalMarginEl = document.getElementById('estimate-total-margin');

      if (totalCostEl) totalCostEl.textContent = '$' + totalCost.toFixed(2);

      const profit = subtotal - totalCost;
      if (totalProfitEl) {
        totalProfitEl.textContent = '$' + profit.toFixed(2);
        totalProfitEl.style.color = profit >= 0 ? '#22c55e' : '#ef4444';
      }

      if (totalMarginEl) {
        if (totalCost > 0) {
          const overallMargin = ((subtotal - totalCost) / totalCost) * 100;
          totalMarginEl.textContent = overallMargin.toFixed(1) + '%';
          if (overallMargin < 0) {
            totalMarginEl.style.color = '#ef4444';
          } else if (overallMargin < 20) {
            totalMarginEl.style.color = '#f59e0b';
          } else {
            totalMarginEl.style.color = '#22c55e';
          }
        } else {
          totalMarginEl.textContent = '--%';
          totalMarginEl.style.color = 'var(--text-muted)';
        }
      }
    }

    // Alias for compatibility
    function updateEstimateTotals() {
      calculateEstimateTotals();
    }

    // Add event listeners for tax, discount, deposit changes
    document.addEventListener('DOMContentLoaded', function() {
      ['estimate-tax-rate', 'estimate-discount-value', 'estimate-discount-type', 'estimate-deposit-percent'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', calculateEstimateTotals);
      });
    });

    // Helper: timeout wrapper for promises
    function withTimeout(promise, ms, errorMsg) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(errorMsg || 'Operation timed out')), ms))
      ]);
    }

    async function handleCreateEstimate(event) {
      event.preventDefault();
      console.log('[Estimate] Starting creation...');

      // Check supabaseClient
      if (!supabaseClient) {
        console.error('[Estimate] Supabase client not initialized');
        alert('Error: Database connection not ready. Please refresh the page.');
        return;
      }

      // Button is in modal footer, not inside form, so find it by form attribute
      const submitBtn = document.querySelector('button[form="create-estimate-form"][type="submit"]');
      if (!submitBtn) {
        console.error('[Estimate] Submit button not found');
        alert('Error: Submit button not found');
        return;
      }
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px;"></div> Creating...';
      submitBtn.disabled = true;

      try {
        console.log('[Estimate] Getting user...');
        const { data: { user }, error: userError } = await withTimeout(
          supabaseClient.auth.getUser(),
          10000,
          'Getting user timed out'
        );
        if (userError) {
          console.error('[Estimate] User error:', userError);
          throw userError;
        }
        if (!user) throw new Error('Please log in');

        // Collect line items with category
        const lineItems = [];
        document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
          const name = item.querySelector('.item-name').value.trim();
          if (name) {
            lineItems.push({
              name: name,
              description: item.querySelector('.item-desc').value.trim(),
              unit: item.querySelector('.item-unit').value,
              quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
              unit_price: parseFloat(item.querySelector('.item-price').value) || 0,
              category: item.querySelector('.item-category').value || 'other'
            });
          }
        });

        if (lineItems.length === 0) {
          throw new Error('Please add at least one line item');
        }
        console.log('[Estimate] Line items:', lineItems.length);

        // Generate estimate number
        const timestamp = Date.now().toString().slice(-6);
        const estimateNumber = `EST-${timestamp}`;
        console.log('[Estimate] Generated number:', estimateNumber);

        // Get totals
        const subtotal = parseFloat(document.getElementById('estimate-subtotal').textContent.replace('$', '').replace(',', '')) || 0;
        const taxRate = parseFloat(document.getElementById('estimate-tax-rate').value) || 0;
        const taxAmount = parseFloat(document.getElementById('estimate-tax-amount').textContent.replace('$', '').replace(',', '')) || 0;
        const discountValue = parseFloat(document.getElementById('estimate-discount-value').value) || 0;
        const discountType = document.getElementById('estimate-discount-type').value;
        const discountAmount = parseFloat(document.getElementById('estimate-discount-amount').textContent.replace('-$', '').replace(',', '')) || 0;
        const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;
        const depositPercentEl = document.getElementById('estimate-deposit-percent');
        const depositPercent = depositPercentEl ? (parseFloat(depositPercentEl.value) || 0) : 50;
        const depositAmount = total * (depositPercent / 100);

        // Get additional fields
        const projectType = document.getElementById('estimate-project-type').value || 'custom';
        const inclusionsEl = document.getElementById('estimate-inclusions');
        const exclusionsEl = document.getElementById('estimate-exclusions');
        const termsEl = document.getElementById('estimate-terms');
        const timelineEl = document.getElementById('estimate-timeline');
        const paymentScheduleType = document.getElementById('payment-schedule-type').value || 'deposit-balance';

        // Get customer_id from unified state (not dataset attributes)
        let customerId = estimateModalState.customerId || null;
        const leadId = estimateModalState.leadId || null;

        // If no customer linked, auto-create from form data
        const customerEmail = document.getElementById('estimate-customer-email').value.trim();
        const customerName = document.getElementById('estimate-customer-name').value.trim();

        if (!customerId && customerEmail) {
          console.log('[Estimate] No customer_id, creating customer from form...');
          const formData = {
            customerName: customerName,
            customerEmail: customerEmail,
            customerPhone: document.getElementById('estimate-customer-phone').value.trim(),
            customerAddress: document.getElementById('estimate-customer-address').value.trim(),
            customerCity: document.getElementById('estimate-customer-city').value.trim(),
            customerState: document.getElementById('estimate-customer-state').value.trim()
          };
          const newCustomer = await createCustomerFromEstimateForm(formData);
          if (newCustomer) {
            customerId = newCustomer.id;
            console.log('[Estimate] Auto-created customer:', customerId);
          }
        }

        // Create estimate
        const estimateData = {
          user_id: user.id,
          estimate_number: estimateNumber,
          customer_id: customerId,
          lead_id: leadId,
          customer_name: document.getElementById('estimate-customer-name').value.trim(),
          customer_email: document.getElementById('estimate-customer-email').value.trim() || null,
          customer_phone: document.getElementById('estimate-customer-phone').value.trim() || null,
          customer_address: document.getElementById('estimate-customer-address').value.trim() || null,
          customer_city: document.getElementById('estimate-customer-city').value.trim() || null,
          customer_state: document.getElementById('estimate-customer-state').value.trim() || null,
          customer_zip: document.getElementById('estimate-customer-zip').value.trim() || null,
          project_name: document.getElementById('estimate-project-name').value.trim() || null,
          description: document.getElementById('estimate-project-desc').value.trim() || null,
          project_type: projectType,
          valid_until: document.getElementById('estimate-valid-until')?.value || null,
          subtotal: subtotal,
          tax_rate: taxRate,
          tax_amount: taxAmount,
          discount_type: discountType,
          discount_value: discountValue,
          discount_amount: discountAmount,
          total: total,
          deposit_percent: depositPercent,
          deposit_amount: depositAmount,
          payment_schedule_type: paymentScheduleType,
          inclusions: inclusionsEl ? inclusionsEl.value.trim() || null : null,
          exclusions: exclusionsEl ? exclusionsEl.value.trim() || null : null,
          terms_conditions: termsEl ? termsEl.value.trim() || null : null,
          estimated_timeline: timelineEl ? timelineEl.value.trim() || null : null,
          warranty_terms: document.getElementById('estimate-warranty')?.value?.trim() || null,
          notes: document.getElementById('estimate-notes')?.value?.trim() || null,
          internal_notes: document.getElementById('estimate-internal-notes')?.value?.trim() || null,
          status: 'sent'
        };

        console.log('[Estimate] Inserting estimate with data:', JSON.stringify(estimateData, null, 2));
        console.log('[Estimate] Inserting estimate into database...');
        const { data: estimate, error: estimateError } = await withTimeout(
          supabaseClient.from('estimates').insert([estimateData]).select().single(),
          15000,
          'Database insert timed out - please try again'
        );

        if (estimateError) {
          console.error('[Estimate] Insert error:', estimateError);
          console.error('[Estimate] Error details:', JSON.stringify(estimateError, null, 2));
          console.error('[Estimate] Data sent:', JSON.stringify(estimateData, null, 2));
          throw new Error(estimateError.message || estimateError.details || 'Failed to create estimate');
        }
        console.log('[Estimate] Created:', estimate.id);

        // Insert line items with category
        const itemsToInsert = lineItems.map(item => ({
          estimate_id: estimate.id,
          name: item.name,
          description: item.description,
          unit_type: item.unit,
          quantity: item.quantity,
          unit_price: item.unit_price,
          total: item.quantity * item.unit_price,
          category: item.category
        }));

        console.log('[Estimate] Inserting line items...');
        const { error: itemsError } = await withTimeout(
          supabaseClient.from('estimate_items').insert(itemsToInsert),
          15000,
          'Line items insert timed out'
        );

        if (itemsError) {
          console.error('[Estimate] Items error:', itemsError);
          throw itemsError;
        }
        console.log('[Estimate] Items inserted');

        // Generate approval token
        console.log('[Estimate] Creating token...');
        const token = crypto.randomUUID();
        try {
          const { error: tokenError } = await withTimeout(
            supabaseClient.from('estimate_tokens').insert([{
              estimate_id: estimate.id,
              token: token,
              expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]),
            10000,
            'Token creation timed out'
          );

          if (tokenError) {
            console.error('[Estimate] Token error:', tokenError);
          }
        } catch (tokenErr) {
          console.error('[Estimate] Token creation failed:', tokenErr.message);
          // Don't throw - estimate is already created
        }
        console.log('[Estimate] Token created, closing modal...');

        // Open preview with option to send
        closeCreateEstimateModal();
        loadEstimates();

        const viewLink = `${window.location.origin}/estimate/view/?token=${token}`;

        // Try to send email via API, but don't fail if it doesn't work
        // (customerEmail was already defined earlier in this function)
        if (customerEmail) {
          try {
            const emailController = new AbortController();
            const emailTimeout = setTimeout(() => emailController.abort(), 10000); // 10 sec timeout
            await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              signal: emailController.signal,
              body: JSON.stringify({
                to: customerEmail,
                customerName: estimateData.customer_name,
                estimateNumber: estimate.estimate_number,
                projectName: estimateData.project_name,
                total: estimateData.total,
                approvalUrl: viewLink
              })
            });
            clearTimeout(emailTimeout);
            showToast('Estimate created and email sent!');
          } catch (emailErr) {
            console.log('Email API unavailable:', emailErr.message);
            // Fallback: offer to copy link or open email client
            const sendManually = confirm(
              `Estimate created successfully!\n\n` +
              `The email server is temporarily unavailable (starting up). Would you like to:\n\n` +
              ` Click OK to open your email client with the estimate link\n` +
              ` Click Cancel to just copy the link\n\n` +
              `(The email will be sent automatically on future attempts)`
            );

            if (sendManually) {
              const subject = encodeURIComponent(`Your Estimate from ${businessSettings?.company_name || 'Surprise Granite'}`);
              const body = encodeURIComponent(
                `Hi ${estimateData.customer_name},\n\n` +
                `Please review your estimate at the link below:\n\n${viewLink}\n\n` +
                `Thank you,\n${businessSettings?.company_name || 'Surprise Granite'}`
              );
              window.open(`mailto:${customerEmail}?subject=${subject}&body=${body}`);
            } else {
              navigator.clipboard.writeText(viewLink);
              showToast('Estimate link copied to clipboard!');
            }
          }
        } else {
          showToast('Estimate created! Add customer email to send.');
        }

        // Offer to preview
        if (confirm('Would you like to preview the estimate?')) {
          window.open(viewLink, '_blank');
        }

      } catch (err) {
        console.error('Create estimate error:', err);
        alert('Error creating estimate: ' + err.message);
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    async function saveEstimateDraft() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Collect line items
        const lineItems = [];
        document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
          const name = item.querySelector('.item-name').value.trim();
          if (name) {
            lineItems.push({
              name: name,
              description: item.querySelector('.item-desc').value.trim(),
              unit: item.querySelector('.item-unit').value,
              quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
              unit_price: parseFloat(item.querySelector('.item-price').value) || 0
            });
          }
        });

        const customerName = document.getElementById('estimate-customer-name').value.trim();
        if (!customerName) {
          throw new Error('Please enter a customer name');
        }

        // Get customer_id from unified state (preserve customer link in drafts!)
        let customerId = estimateModalState.customerId || null;
        const leadId = estimateModalState.leadId || null;

        // If no customer linked, auto-create from form data (even for drafts)
        const customerEmail = document.getElementById('estimate-customer-email').value.trim();
        if (!customerId && customerEmail) {
          const formData = {
            customerName: customerName,
            customerEmail: customerEmail,
            customerPhone: document.getElementById('estimate-customer-phone').value.trim(),
            customerAddress: document.getElementById('estimate-customer-address').value.trim(),
            customerCity: document.getElementById('estimate-customer-city').value.trim(),
            customerState: document.getElementById('estimate-customer-state').value.trim()
          };
          const newCustomer = await createCustomerFromEstimateForm(formData);
          if (newCustomer) customerId = newCustomer.id;
        }

        // Get totals
        const subtotal = parseFloat(document.getElementById('estimate-subtotal').textContent.replace('$', '').replace(',', '')) || 0;
        const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;

        const estimateData = {
          user_id: user.id,
          customer_id: customerId,
          lead_id: leadId,
          customer_name: customerName,
          customer_email: document.getElementById('estimate-customer-email').value.trim() || null,
          customer_phone: document.getElementById('estimate-customer-phone').value.trim() || null,
          customer_address: document.getElementById('estimate-customer-address').value.trim() || null,
          customer_city: document.getElementById('estimate-customer-city').value.trim() || null,
          customer_state: document.getElementById('estimate-customer-state').value.trim() || null,
          customer_zip: document.getElementById('estimate-customer-zip').value.trim() || null,
          project_name: document.getElementById('estimate-project-name').value.trim() || null,
          description: document.getElementById('estimate-project-desc').value.trim() || null,
          valid_until: document.getElementById('estimate-valid-until').value || null,
          subtotal: subtotal,
          tax_rate: parseFloat(document.getElementById('estimate-tax-rate').value) || 0,
          tax_amount: parseFloat(document.getElementById('estimate-tax-amount').textContent.replace('$', '')) || 0,
          discount_type: document.getElementById('estimate-discount-type').value,
          discount_value: parseFloat(document.getElementById('estimate-discount-value').value) || 0,
          discount_amount: parseFloat(document.getElementById('estimate-discount-amount').textContent.replace('-$', '')) || 0,
          total: total,
          deposit_percent: parseFloat(document.getElementById('estimate-deposit-percent').value) || 0,
          deposit_amount: parseFloat(document.getElementById('estimate-deposit-amount').textContent.replace('$', '')) || 0,
          payment_terms: document.getElementById('estimate-payment-terms').value.trim() || null,
          warranty_terms: document.getElementById('estimate-warranty').value.trim() || null,
          notes: document.getElementById('estimate-notes').value.trim() || null,
          internal_notes: document.getElementById('estimate-internal-notes').value.trim() || null,
          status: 'draft'
        };

        const { data: estimate, error } = await supabaseClient
          .from('estimates')
          .insert([estimateData])
          .select()
          .single();

        if (error) throw error;

        // Insert line items if any
        if (lineItems.length > 0) {
          const itemsToInsert = lineItems.map(item => ({
            estimate_id: estimate.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.quantity * item.unit_price
          }));

          await supabaseClient.from('estimate_items').insert(itemsToInsert);
        }

        closeCreateEstimateModal();
        loadEstimates();
        showToast('Draft saved successfully!');

      } catch (err) {
        console.error('Save draft error:', err);
        alert('Error saving draft: ' + err.message);
      }
    }

    async function sendEstimateEmail(estimateId, token) {
      try {
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!estimate || !estimate.customer_email) return;

        const approvalUrl = `${window.location.origin}/estimate/view/?token=${token}`;

        await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: estimate.customer_email,
            customerName: estimate.customer_name,
            estimateNumber: estimate.estimate_number,
            projectName: estimate.project_name,
            total: estimate.total,
            depositAmount: estimate.deposit_amount,
            validUntil: estimate.valid_until,
            approvalUrl: approvalUrl,
            items: estimate.estimate_items
          })
        });
      } catch (err) {
        console.error('Send email error:', err);
      }
    }

    async function sendEstimate(estimateId) {
      if (!confirm('Send this estimate to the customer?')) return;

      // Show loading state
      const btn = event?.target || document.querySelector(`button[onclick*="sendEstimate('${estimateId}')"]`);
      const originalText = btn?.innerHTML;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = ' Sending...';
      }
      showToast('Preparing estimate...', 'info');

      try {
        // Fetch estimate with items
        const { data: estimate, error: fetchErr } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (fetchErr) throw fetchErr;

        if (!estimate.customer_email) {
          alert('Please add a customer email before sending');
          return;
        }

        // Update status to sent
        await supabaseClient
          .from('estimates')
          .update({ status: 'sent', sent_at: new Date().toISOString() })
          .eq('id', estimateId);

        // Generate token
        const token = crypto.randomUUID();
        await supabaseClient
          .from('estimate_tokens')
          .insert([{
            estimate_id: estimateId,
            token: token,
            expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
          }]);

        const viewLink = `${window.location.origin}/estimate/view/?token=${token}`;

        // Prepare complete estimate data for email + PDF
        const emailData = {
          customer_email: estimate.customer_email,
          customer_name: estimate.customer_name,
          customer_phone: estimate.customer_phone,
          customer_address: estimate.customer_address,
          estimate_number: estimate.estimate_number,
          estimate_id: estimate.id,
          items: (estimate.estimate_items || []).map(item => ({
            description: item.description,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          })),
          subtotal: estimate.subtotal,
          tax_rate: estimate.tax_rate,
          tax_amount: estimate.tax_amount,
          total: estimate.total,
          notes: estimate.notes,
          view_url: viewLink,
          // Business info
          business_name: businessSettings?.company_name,
          business_email: businessSettings?.company_email,
          business_phone: businessSettings?.company_phone,
          business_address: businessSettings?.company_address,
          business_logo: businessSettings?.logo_url,
          // Project details
          project_type: estimate.project_type || estimate.project_name,
          estimated_timeline: estimate.estimated_timeline,
          inclusions: estimate.inclusions,
          exclusions: estimate.exclusions,
          terms_conditions: estimate.terms_conditions,
          valid_until: estimate.valid_until,
          created_at: estimate.created_at
        };

        // Parse payment schedule if stored as JSON
        if (estimate.payment_schedule) {
          try {
            emailData.payment_schedule = typeof estimate.payment_schedule === 'string'
              ? JSON.parse(estimate.payment_schedule)
              : estimate.payment_schedule;
          } catch (e) {}
        }

        // Try to send email via API with timeout
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 15000); // 15 sec timeout
          const response = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal,
            body: JSON.stringify(emailData)
          });
          clearTimeout(timeout);

          const result = await response.json();

          if (response.ok && result.success) {
            showToast(result.pdf_attached ? 'Estimate sent with PDF!' : 'Estimate sent!');

            // Send SMS notification (email already sent by API)
            sendNotification('estimate', 'sent', estimate, {
              email: null, // Already sent by email API
              phone: estimate.customer_phone,
              name: estimate.customer_name
            });
          } else {
            throw new Error(result.error || 'Failed to send');
          }
        } catch (emailErr) {
          console.log('Email API error:', emailErr.message);
          // Fallback to email client
          const subject = encodeURIComponent(`Your Estimate from ${businessSettings?.company_name || 'Surprise Granite'}`);
          const body = encodeURIComponent(
            `Hi ${estimate.customer_name},\n\n` +
            `Please review your estimate at the link below:\n\n${viewLink}\n\n` +
            `Thank you,\n${businessSettings?.company_name || 'Surprise Granite'}`
          );
          window.open(`mailto:${estimate.customer_email}?subject=${subject}&body=${body}`);
          showToast('Email client opened with estimate link');
        }

        loadEstimates();
      } catch (err) {
        console.error('Send estimate error:', err);
        alert('Error sending estimate: ' + err.message);
      } finally {
        // Reset button state
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText || 'Send';
        }
      }
    }

    async function viewEstimate(estimateId) {
      // Open estimate in preview modal or new tab
      try {
        const { data: tokenData } = await supabaseClient
          .from('estimate_tokens')
          .select('token')
          .eq('estimate_id', estimateId)
          .order('created_at', { ascending: false })
          .limit(1)
          .single();

        if (tokenData) {
          window.open(`/estimate/view/?token=${tokenData.token}`, '_blank');
        } else {
          // Generate new token for viewing
          const token = crypto.randomUUID();
          await supabaseClient
            .from('estimate_tokens')
            .insert([{
              estimate_id: estimateId,
              token: token,
              expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]);
          window.open(`/estimate/view/?token=${token}`, '_blank');
        }
      } catch (err) {
        console.error('View estimate error:', err);
        alert('Error viewing estimate');
      }
    }

    async function deleteEstimate(estimateId) {
      if (!confirm('Delete this draft estimate?')) return;

      try {
        await supabaseClient.from('estimates').delete().eq('id', estimateId);
        loadEstimates();
        showToast('Estimate deleted');
      } catch (err) {
        console.error('Delete estimate error:', err);
        alert('Error deleting estimate');
      }
    }

    async function archiveEstimate(estimateId) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ archived_at: new Date().toISOString() })
          .eq('id', estimateId);

        if (error) throw error;
        loadEstimates();
        showToast('Estimate archived');
      } catch (err) {
        console.error('Archive estimate error:', err);
        alert('Error archiving estimate');
      }
    }

    async function unarchiveEstimate(estimateId) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ archived_at: null })
          .eq('id', estimateId);

        if (error) throw error;
        loadEstimates();
        showToast('Estimate restored');
      } catch (err) {
        console.error('Unarchive estimate error:', err);
        alert('Error restoring estimate');
      }
    }

    async function deleteEstimatePermanent(estimateId) {
      if (!confirm('Permanently delete this estimate? This cannot be undone.')) return;

      try {
        // Delete line items first
        await supabaseClient.from('estimate_items').delete().eq('estimate_id', estimateId);
        // Delete the estimate
        await supabaseClient.from('estimates').delete().eq('id', estimateId);
        loadEstimates();
        showToast('Estimate permanently deleted');
      } catch (err) {
        console.error('Delete estimate error:', err);
        alert('Error deleting estimate');
      }
    }

    async function duplicateEstimate(estimateId) {
      try {
        const { data: original } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!original) throw new Error('Estimate not found');

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Create copy
        const newEstimate = {
          user_id: user.id,
          customer_name: original.customer_name,
          customer_email: original.customer_email,
          customer_phone: original.customer_phone,
          customer_address: original.customer_address,
          customer_city: original.customer_city,
          customer_state: original.customer_state,
          customer_zip: original.customer_zip,
          project_name: original.project_name ? original.project_name + ' (Copy)' : null,
          description: original.description,
          valid_until: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          subtotal: original.subtotal,
          tax_rate: original.tax_rate,
          tax_amount: original.tax_amount,
          discount_type: original.discount_type,
          discount_value: original.discount_value,
          discount_amount: original.discount_amount,
          total: original.total,
          deposit_percent: original.deposit_percent,
          deposit_amount: original.deposit_amount,
          payment_terms: original.payment_terms,
          warranty_terms: original.warranty_terms,
          notes: original.notes,
          internal_notes: original.internal_notes,
          status: 'draft'
        };

        const { data: newEst, error } = await supabaseClient
          .from('estimates')
          .insert([newEstimate])
          .select()
          .single();

        if (error) throw error;

        // Copy line items
        if (original.estimate_items && original.estimate_items.length > 0) {
          const items = original.estimate_items.map(item => ({
            estimate_id: newEst.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          }));

          await supabaseClient.from('estimate_items').insert(items);
        }

        loadEstimates();
        showToast('Estimate duplicated!');
      } catch (err) {
        console.error('Duplicate estimate error:', err);
        alert('Error duplicating estimate');
      }
    }

    // Bridge: Create project pre-filled from order data
    async function createProjectFromOrder(orderId) {
      try {
        var order = (allOrders || []).find(function(o) { return o.id === orderId; });
        if (!order) {
          var result = await supabaseClient.from('shopify_orders').select('*').eq('id', orderId).single();
          order = result.data;
        }
        if (!order) { showToast('Order not found', 'warning'); return; }

        showPage('projects');
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = 'Order #' + (order.order_number || order.id) + ' - ' + (order.customer_name || '');
          document.getElementById('proj-customer-name').value = order.customer_name || '';
          document.getElementById('proj-customer-email').value = order.customer_email || '';
          document.getElementById('proj-customer-phone').value = order.customer_phone || '';
          document.getElementById('proj-value').value = order.total || '';
          document.getElementById('proj-notes').value = 'Created from order #' + (order.order_number || order.id);
          document.getElementById('proj-status').value = (order.financial_status || '').toLowerCase() === 'paid' ? 'scheduled' : 'approved';
          showToast('Project form pre-filled from order', 'success');
        }, 300);
      } catch (err) {
        showToast('Error loading order', 'error');
      }
    }

    // Bridge: Create project pre-filled from invoice data
    async function createProjectFromInvoice(invoiceId) {
      try {
        // First try to find in our cached allInvoices array (handles both Supabase and Stripe)
        var inv = allInvoices.find(i => i.id === invoiceId);

        // If not found in cache and it's a UUID (Supabase), try fetching from database
        if (!inv && !invoiceId.startsWith('in_')) {
          var result = await supabaseClient.from('invoices').select('*').eq('id', invoiceId).single();
          inv = result.data;
        }

        if (!inv) { showToast('Invoice not found', 'warning'); return; }

        showPage('projects');
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = 'Project - ' + (inv.customer_name || inv.invoice_number || '');
          document.getElementById('proj-customer-name').value = inv.customer_name || '';
          document.getElementById('proj-customer-email').value = inv.customer_email || '';
          document.getElementById('proj-customer-phone').value = inv.customer_phone || '';
          document.getElementById('proj-value').value = inv.total || '';
          document.getElementById('proj-notes').value = 'Created from invoice #' + (inv.invoice_number || invoiceId.substring(0, 8));
          document.getElementById('proj-status').value = inv.status === 'paid' ? 'scheduled' : 'approved';
          showToast('Project form pre-filled from invoice', 'success');
        }, 300);
      } catch (err) {
        showToast('Error loading invoice', 'error');
      }
    }

    // Bridge: Create project pre-filled from estimate data
    async function createProjectFromEstimate(estimateId) {
      try {
        var result = await supabaseClient.from('estimates').select('*').eq('id', estimateId).single();
        var est = result.data;
        if (!est) { showToast('Estimate not found', 'warning'); return; }

        showPage('projects');
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = est.project_name || ('Project - ' + (est.customer_name || ''));
          document.getElementById('proj-customer-name').value = est.customer_name || '';
          document.getElementById('proj-customer-email').value = est.customer_email || '';
          document.getElementById('proj-customer-phone').value = est.customer_phone || '';
          document.getElementById('proj-address').value = est.customer_address || '';
          document.getElementById('proj-city').value = est.customer_city || '';
          document.getElementById('proj-state').value = est.customer_state || '';
          document.getElementById('proj-zip').value = est.customer_zip || '';
          document.getElementById('proj-value').value = est.total || '';
          document.getElementById('proj-notes').value = 'Created from estimate ' + (est.estimate_number || '#' + estimateId.substring(0, 8));
          document.getElementById('proj-status').value = 'approved';
          showToast('Project form pre-filled from estimate', 'success');
        }, 300);
      } catch (err) {
        showToast('Error loading estimate', 'error');
      }
    }

    // Bridge: Create estimate pre-filled from project data
    async function createEstimateFromProject(projectId) {
      var project = allProjects.find(function(p) { return p.id === projectId; });
      if (!project) { showToast('Project not found', 'warning'); return; }

      // Close project detail modal
      document.getElementById('project-detail-modal').classList.remove('active');
      showPage('estimates');

      estimateModalState = { customerId: null, leadId: null, editingEstimateId: null };

      setTimeout(function() {
        openCreateEstimateModal(false);
        fillField('estimate-customer-name', project.customer_name);
        fillField('estimate-customer-email', project.customer_email);
        fillField('estimate-customer-phone', project.customer_phone);
        fillField('estimate-customer-address', project.address);
        fillField('estimate-customer-city', project.city);
        fillField('estimate-customer-state', project.state);
        fillField('estimate-customer-zip', project.zip);
        fillField('estimate-project-name', project.name);
        fillField('estimate-project-desc', project.description || '');
        showToast('Estimate form pre-filled from project', 'success');
      }, 300);
    }

    async function convertToInvoice(estimateId) {
      if (!confirm('Convert this estimate to an invoice?')) return;

      try {
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!estimate) throw new Error('Estimate not found');

        // Prevent duplicate conversion
        if (estimate.status === 'converted' || estimate.converted_to_invoice_id) {
          alert('This estimate has already been converted to an invoice.');
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Generate invoice number
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        // Create invoice - preserve full traceability chain
        const invoiceData = {
          user_id: user.id,
          invoice_number: invoiceNumber,
          estimate_id: estimateId,
          lead_id: estimate.lead_id || null,  // Preserve lead reference for traceability
          customer_id: estimate.customer_id || null,
          customer_name: estimate.customer_name,
          customer_email: estimate.customer_email,
          customer_phone: estimate.customer_phone,
          customer_address: estimate.customer_address,
          customer_city: estimate.customer_city,
          customer_state: estimate.customer_state,
          customer_zip: estimate.customer_zip,
          project_name: estimate.project_name,
          subtotal: estimate.subtotal,
          tax_rate: estimate.tax_rate,
          tax_amount: estimate.tax_amount,
          discount_type: estimate.discount_type,
          discount_value: estimate.discount_value,
          discount_amount: estimate.discount_amount,
          total: estimate.total,
          amount_paid: 0,
          amount_due: estimate.total,
          payment_terms: estimate.payment_terms,
          notes: estimate.notes,
          status: 'unpaid',
          due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        };

        const { data: invoice, error } = await supabaseClient
          .from('invoices')
          .insert([invoiceData])
          .select()
          .single();

        if (error) throw error;

        // Copy line items to invoice
        if (estimate.estimate_items && estimate.estimate_items.length > 0) {
          const items = estimate.estimate_items.map(item => ({
            invoice_id: invoice.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          }));

          await supabaseClient.from('invoice_items').insert(items);
        }

        // Update estimate status
        await supabaseClient
          .from('estimates')
          .update({ status: 'converted', converted_to_invoice_id: invoice.id })
          .eq('id', estimateId);

        // Optionally create Stripe invoice for payment processing (non-blocking)
        try {
          const stripeItems = (estimate.estimate_items || []).map(item => ({
            description: item.name || item.description,
            quantity: item.quantity || 1,
            amount: item.unit_price || item.total || 0
          }));

          if (stripeItems.length > 0 && estimate.customer_email) {
            const response = await apiCall('/api/invoices', {
              method: 'POST',
              body: JSON.stringify({
                customer_email: estimate.customer_email,
                customer_name: estimate.customer_name,
                customer_phone: estimate.customer_phone,
                items: stripeItems,
                due_days: 30,
                notes: estimate.notes || '',
                auto_send: false
              })
            });

            if (response.ok) {
              const stripeData = await response.json();
              if (stripeData.invoice?.id) {
                await supabaseClient
                  .from('invoices')
                  .update({
                    stripe_invoice_id: stripeData.invoice.id,
                    stripe_hosted_url: stripeData.invoice.hosted_invoice_url,
                    stripe_pdf_url: stripeData.invoice.pdf
                  })
                  .eq('id', invoice.id);
              }
            }
          }
        } catch (stripeErr) {
          console.warn('[ConvertToInvoice] Stripe invoice creation failed (Supabase record saved):', stripeErr.message);
        }

        // Bridge: Link invoice back to project if one references this estimate
        try {
          var projResult = await supabaseClient.from('projects')
            .select('id')
            .eq('estimate_id', estimateId)
            .single();
          if (projResult.data) {
            await supabaseClient.from('projects')
              .update({ invoice_id: invoice.id })
              .eq('id', projResult.data.id);
          }
        } catch (e) { /* non-blocking */ }

        showToast('Invoice created successfully!');
        showPage('invoices');
        loadInvoices();
      } catch (err) {
        console.error('Convert to invoice error:', err);
        alert('Error converting to invoice: ' + err.message);
      }
    }

    // Alias for context menu compatibility
    const convertEstimateToInvoice = convertToInvoice;

    // =============================================
    // BUSINESS SETTINGS
    // =============================================

    function openBusinessSettings() {
      const modal = document.getElementById('business-settings-modal');
      modal.classList.add('active');
      loadBusinessSettings();
    }

    function closeBusinessSettings() {
      const modal = document.getElementById('business-settings-modal');
      modal.classList.remove('active');
    }

    async function loadBusinessSettings() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: settings } = await supabaseClient
          .from('business_settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (settings) {
          document.getElementById('biz-company-name').value = settings.company_name || '';
          document.getElementById('biz-phone').value = settings.phone || '';
          document.getElementById('biz-email').value = settings.email || '';
          document.getElementById('biz-address').value = settings.address || '';
          document.getElementById('biz-city').value = settings.city || '';
          document.getElementById('biz-state').value = settings.state || '';
          document.getElementById('biz-zip').value = settings.zip || '';
          document.getElementById('biz-license').value = settings.license_number || '';
          document.getElementById('biz-website').value = settings.website || '';
          document.getElementById('biz-estimate-prefix').value = settings.estimate_prefix || 'EST-';
          if (document.getElementById('biz-invoice-prefix')) {
            document.getElementById('biz-invoice-prefix').value = settings.invoice_prefix || 'INV-';
          }
          document.getElementById('biz-estimate-terms').value = settings.default_estimate_terms || '';

          // Load defaults
          if (document.getElementById('biz-tax-rate')) {
            document.getElementById('biz-tax-rate').value = settings.default_tax_rate || 0;
          }
          if (document.getElementById('biz-deposit')) {
            document.getElementById('biz-deposit').value = settings.default_deposit_percent || 50;
          }
          if (document.getElementById('biz-payment-terms')) {
            document.getElementById('biz-payment-terms').value = settings.default_payment_terms || '';
          }
          if (document.getElementById('biz-warranty')) {
            document.getElementById('biz-warranty').value = settings.default_warranty_terms || '';
          }

          // Load logo if exists
          const logoUrl = settings.logo_url;
          const logoImage = document.getElementById('logo-image');
          const logoPlaceholder = document.getElementById('logo-placeholder');
          const removeLogoBtn = document.getElementById('remove-logo-btn');
          const logoUrlInput = document.getElementById('biz-logo-url');

          if (logoUrl) {
            logoImage.src = logoUrl;
            logoImage.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            removeLogoBtn.style.display = 'inline-block';
            logoUrlInput.value = logoUrl;
          } else {
            logoImage.style.display = 'none';
            logoPlaceholder.style.display = 'block';
            removeLogoBtn.style.display = 'none';
            logoUrlInput.value = '';
          }
        }
      } catch (err) {
        console.log('No business settings found');
      }
    }

    async function saveBusinessSettings(event) {
      if (event) event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const settingsData = {
          user_id: user.id,
          company_name: document.getElementById('biz-company-name').value.trim() || null,
          phone: document.getElementById('biz-phone').value.trim() || null,
          email: document.getElementById('biz-email').value.trim() || null,
          address: document.getElementById('biz-address').value.trim() || null,
          city: document.getElementById('biz-city').value.trim() || null,
          state: document.getElementById('biz-state').value.trim() || null,
          zip: document.getElementById('biz-zip').value.trim() || null,
          license_number: document.getElementById('biz-license').value.trim() || null,
          website: document.getElementById('biz-website').value.trim() || null,
          estimate_prefix: document.getElementById('biz-estimate-prefix').value.trim() || 'EST-',
          invoice_prefix: document.getElementById('biz-invoice-prefix')?.value.trim() || 'INV-',
          default_estimate_terms: document.getElementById('biz-estimate-terms').value.trim() || null,
          default_tax_rate: parseFloat(document.getElementById('biz-tax-rate')?.value) || 0,
          default_deposit_percent: parseFloat(document.getElementById('biz-deposit')?.value) || 50,
          default_payment_terms: document.getElementById('biz-payment-terms')?.value.trim() || null,
          default_warranty_terms: document.getElementById('biz-warranty')?.value.trim() || null,
          logo_url: document.getElementById('biz-logo-url').value.trim() || null
        };

        const { error } = await supabaseClient
          .from('business_settings')
          .upsert([settingsData], { onConflict: 'user_id' });

        if (error) throw error;

        closeBusinessSettings();
        showToast('Business settings saved!');
      } catch (err) {
        console.error('Save business settings error:', err);
        alert('Error saving settings: ' + err.message);
      }

      return false;
    }

    // Logo upload handler
    async function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('Image must be smaller than 2MB');
        return;
      }

      const logoImage = document.getElementById('logo-image');
      const logoPlaceholder = document.getElementById('logo-placeholder');
      const removeLogoBtn = document.getElementById('remove-logo-btn');
      const logoUrlInput = document.getElementById('biz-logo-url');

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Show loading state
        logoPlaceholder.innerHTML = 'Uploading...';
        logoPlaceholder.style.display = 'block';
        logoImage.style.display = 'none';

        // Create unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `logos/${user.id}/logo-${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (error) throw error;

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('lead-images')
          .getPublicUrl(fileName);

        const publicUrl = urlData.publicUrl;

        // Update UI
        logoImage.src = publicUrl;
        logoImage.style.display = 'block';
        logoPlaceholder.style.display = 'none';
        removeLogoBtn.style.display = 'inline-block';
        logoUrlInput.value = publicUrl;

        showToast('Logo uploaded! Click Save to apply changes.');
      } catch (err) {
        console.error('Logo upload error:', err);
        logoPlaceholder.innerHTML = 'No logo<br>uploaded';
        logoPlaceholder.style.display = 'block';
        alert('Error uploading logo: ' + err.message);
      }
    }

    // Remove logo handler
    function removeLogo() {
      const logoImage = document.getElementById('logo-image');
      const logoPlaceholder = document.getElementById('logo-placeholder');
      const removeLogoBtn = document.getElementById('remove-logo-btn');
      const logoUrlInput = document.getElementById('biz-logo-url');
      const logoUpload = document.getElementById('logo-upload');

      logoImage.src = '';
      logoImage.style.display = 'none';
      logoPlaceholder.innerHTML = 'No logo<br>uploaded';
      logoPlaceholder.style.display = 'block';
      removeLogoBtn.style.display = 'none';
      logoUrlInput.value = '';
      logoUpload.value = '';

      showToast('Logo removed. Click Save to apply changes.');
    }

    // =============================================
    // PROJECTS MANAGEMENT
    // =============================================

    let allProjects = [];
    let projectFilter = 'all';
    let projectSearchTerm = '';
    let currentProjectsView = 'list';
    let currentProjectId = null;
    let projectSearchTimeout = null;

    const PROJECT_STATUS_COLORS = {
      lead: '#f59e0b',
      approved: '#3b82f6',
      scheduled: '#8b5cf6',
      in_progress: '#06b6d4',
      completed: '#22c55e',
      on_hold: '#ef4444',
      cancelled: '#6b7280'
    };

    const PROJECT_STATUS_LABELS = {
      lead: 'Lead',
      approved: 'Approved',
      scheduled: 'Scheduled',
      in_progress: 'In Progress',
      completed: 'Completed',
      on_hold: 'On Hold',
      cancelled: 'Cancelled'
    };

    const PROJECT_PRIORITY_COLORS = {
      low: '#6b7280',
      medium: '#3b82f6',
      high: '#f59e0b',
      urgent: '#ef4444'
    };

    // Workflow stages for home services projects
    const WORKFLOW_STAGES = [
      { key: 'lead', label: 'Lead', icon: '', color: '#6b7280', status: 'lead' },
      { key: 'appointment', label: 'Appointment', icon: '', color: '#3b82f6', status: 'lead' },
      { key: 'estimate', label: 'Estimate', icon: '', color: '#8b5cf6', status: 'lead' },
      { key: 'approved', label: 'Approved', icon: '', color: '#10b981', status: 'approved' },
      { key: 'deposit', label: 'Deposit', icon: '', color: '#f59e0b', status: 'approved' },
      { key: 'materials', label: 'Materials', icon: '', color: '#14b8a6', status: 'scheduled' },
      { key: 'scheduled', label: 'Scheduled', icon: '', color: '#06b6d4', status: 'scheduled' },
      { key: 'installing', label: 'Installing', icon: '', color: '#ec4899', status: 'in_progress' },
      { key: 'completed', label: 'Complete', icon: '', color: '#22c55e', status: 'completed' }
    ];

    function getWorkflowStageIndex(project) {
      // Map project status to workflow stage
      const status = project.status || 'lead';
      const workflowStage = project.workflow_stage;

      // If explicit workflow_stage is set, use that
      if (workflowStage) {
        const idx = WORKFLOW_STAGES.findIndex(s => s.key === workflowStage);
        if (idx >= 0) return idx;
      }

      // Otherwise infer from status
      switch (status) {
        case 'lead': return project.has_estimate ? 2 : (project.has_appointment ? 1 : 0);
        case 'approved': return project.has_deposit ? 4 : 3;
        case 'scheduled': return project.has_materials ? 6 : 5;
        case 'in_progress': return 7;
        case 'completed': return 8;
        default: return 0;
      }
    }

    function renderWorkflowStatusBar(project) {
      const currentIndex = getWorkflowStageIndex(project);

      return '<div style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">' +
          '<div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Workflow Progress</div>' +
          '<span style="font-size: 12px; color: var(--gold-primary); font-weight: 600;">' + Math.round((currentIndex / (WORKFLOW_STAGES.length - 1)) * 100) + '%</span>' +
        '</div>' +
        '<div style="display: flex; align-items: center; gap: 4px; overflow-x: auto; padding-bottom: 8px;">' +
          WORKFLOW_STAGES.map(function(stage, i) {
            var isCompleted = i < currentIndex;
            var isCurrent = i === currentIndex;
            var isPending = i > currentIndex;
            var bgColor = isCompleted ? stage.color : (isCurrent ? stage.color + '33' : 'var(--dark-tertiary)');
            var textColor = isCompleted ? '#fff' : (isCurrent ? stage.color : 'var(--text-muted)');
            var canAdvance = i === currentIndex + 1;

            return '<div class="workflow-stage" onclick="' + (canAdvance ? 'advanceWorkflowStage(\'' + project.id + '\', \'' + stage.key + '\')' : '') + '" style="flex: 1; min-width: 60px; text-align: center; cursor: ' + (canAdvance ? 'pointer' : 'default') + '; opacity: ' + (isPending && !canAdvance ? '0.5' : '1') + '; transition: all 0.2s;" title="' + (canAdvance ? 'Click to advance to ' + stage.label : stage.label) + '">' +
              '<div style="width: 32px; height: 32px; border-radius: 50%; background: ' + bgColor + '; color: ' + textColor + '; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; font-size: 14px; border: 2px solid ' + (isCurrent ? stage.color : 'transparent') + '; transition: all 0.2s;">' +
                (isCompleted ? '' : stage.icon) +
              '</div>' +
              '<div style="font-size: 10px; color: ' + (isCurrent ? 'var(--text-primary)' : 'var(--text-muted)') + '; font-weight: ' + (isCurrent ? '600' : '400') + '; white-space: nowrap;">' + stage.label + '</div>' +
            '</div>' +
            (i < WORKFLOW_STAGES.length - 1 ? '<div style="flex-shrink: 0; width: 20px; height: 2px; background: ' + (isCompleted ? stage.color : 'var(--dark-border)') + '; margin-top: -16px;"></div>' : '');
          }).join('') +
        '</div>' +
      '</div>';
    }

    async function advanceWorkflowStage(projectId, newStage) {
      const stage = WORKFLOW_STAGES.find(s => s.key === newStage);
      if (!stage) return;

      const confirmed = confirm('Advance project to "' + stage.label + '" stage?');
      if (!confirmed) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Update project with new workflow stage and status
        const { error } = await supabaseClient
          .from('projects')
          .update({
            workflow_stage: newStage,
            status: stage.status,
            updated_at: new Date().toISOString()
          })
          .eq('id', projectId)
          .eq('user_id', user.id);

        if (error) throw error;

        // Auto-create calendar event for certain stages
        if (['appointment', 'scheduled', 'installing'].includes(newStage)) {
          await autoCreateWorkflowEvent(projectId, newStage, user.id);
        }

        showToast('Advanced to ' + stage.label, 'success');
        await loadProjects();

        // Refresh detail modal if open
        if (currentProjectId === projectId) {
          openProjectDetail(projectId);
        }

      } catch (err) {
        console.error('Error advancing workflow:', err);
        showToast(err.message || 'Failed to advance workflow', 'error');
      }
    }

    async function autoCreateWorkflowEvent(projectId, stage, userId) {
      try {
        // Get project details
        const { data: project } = await supabaseClient
          .from('projects')
          .select('name, customer_name, customer_email, customer_phone, address, city, state, zip')
          .eq('id', projectId)
          .single();

        if (!project) return;

        const eventTypes = {
          appointment: { type: 'measurement', title: 'Measurement - ' },
          scheduled: { type: 'installation', title: 'Installation - ' },
          installing: { type: 'installation', title: 'In Progress - ' }
        };

        const eventConfig = eventTypes[stage];
        if (!eventConfig) return;

        // Check if event already exists for this project and type
        const { data: existingEvents } = await supabaseClient
          .from('calendar_events')
          .select('id')
          .eq('project_id', projectId)
          .eq('event_type', eventConfig.type)
          .limit(1);

        if (existingEvents && existingEvents.length > 0) {
          console.log('Event already exists for this stage');
          return;
        }

        // Create the event (scheduled for tomorrow at 9am)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        const endTime = new Date(tomorrow.getTime() + 3 * 60 * 60 * 1000); // 3 hours

        await supabaseClient
          .from('calendar_events')
          .insert({
            created_by: userId,
            title: eventConfig.title + (project.customer_name || project.name),
            event_type: eventConfig.type,
            status: 'scheduled',
            start_time: tomorrow.toISOString(),
            end_time: endTime.toISOString(),
            location: project.address,
            location_address: [project.address, project.city, project.state, project.zip].filter(Boolean).join(', '),
            description: 'Customer: ' + (project.customer_name || 'N/A') + '\nPhone: ' + (project.customer_phone || 'N/A') + '\nEmail: ' + (project.customer_email || 'N/A'),
            project_id: projectId,
            metadata: {
              contact_name: project.customer_name,
              contact_email: project.customer_email,
              contact_phone: project.customer_phone,
              auto_created: true,
              workflow_stage: stage
            }
          });

        showToast('Calendar event auto-created', 'info');
        console.log('Auto-created calendar event for workflow stage:', stage);

      } catch (err) {
        console.warn('Could not auto-create workflow event:', err.message);
      }
    }

    async function loadProjects() {
      const listEl = document.getElementById('projects-list');
      if (!listEl) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        listEl.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: projects, error } = await supabaseClient
          .from('projects')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allProjects = projects || [];
        updateProjectStats();
        updateProjectsCount();
        renderProjectsList();
        renderProjectsKanban();

        // Bridge: Check for design-to-project handoff
        checkDesignToProjectBridge();
      } catch (err) {
        console.error('Error loading projects:', err);
        listEl.innerHTML = '<div class="empty-state"><h3>Error loading projects</h3><p>' + (err.message || 'Please try again') + '</p></div>';
      }
    }

    // Bridge: Detect design-to-project handoff from room designer
    function checkDesignToProjectBridge() {
      var designData = sessionStorage.getItem('sg_design_for_project');
      if (!designData || !window.location.hash.includes('from_design')) return;
      sessionStorage.removeItem('sg_design_for_project');

      try {
        var design = JSON.parse(designData);
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = design.name || 'Room Design Project';
          document.getElementById('proj-description').value = 'From room designer' + (design.room_type ? ' (' + design.room_type + ')' : '');
          if (design.quote_total) document.getElementById('proj-value').value = design.quote_total;
          document.getElementById('proj-status').value = 'lead';
          showToast('Project form pre-filled from design', 'success');
        }, 400);
      } catch (e) { /* ignore parse errors */ }
    }

    function updateProjectsCount() {
      const badge = document.getElementById('projects-count');
      if (!badge) return;
      const active = allProjects.filter(p => ['approved', 'scheduled', 'in_progress'].includes(p.status)).length;
      badge.textContent = active;
      badge.dataset.count = active;
    }

    function updateProjectStats() {
      const all = allProjects;
      const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
      el('stat-total-projects', all.length);
      el('stat-active-projects', all.filter(p => ['approved', 'scheduled', 'in_progress'].includes(p.status)).length);
      el('stat-completed-projects', all.filter(p => p.status === 'completed').length);
      const pipeline = all.filter(p => !['completed', 'cancelled'].includes(p.status))
        .reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
      el('stat-pipeline-value', '$' + pipeline.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
    }

    function filterProjects(status) {
      projectFilter = status;
      document.querySelectorAll('[data-proj-status]').forEach(pill => {
        pill.classList.toggle('active', pill.dataset.projStatus === status);
      });
      renderProjectsList();
      renderProjectsKanban();
    }

    function debounceProjectSearch() {
      clearTimeout(projectSearchTimeout);
      projectSearchTimeout = setTimeout(() => {
        projectSearchTerm = (document.getElementById('projects-search')?.value || '').toLowerCase().trim();
        renderProjectsList();
        renderProjectsKanban();
      }, 300);
    }

    function getFilteredProjects() {
      return allProjects.filter(p => {
        if (projectFilter !== 'all' && p.status !== projectFilter) return false;
        if (projectSearchTerm) {
          const term = projectSearchTerm;
          return (p.name || '').toLowerCase().includes(term) ||
                 (p.customer_name || '').toLowerCase().includes(term) ||
                 (p.description || '').toLowerCase().includes(term);
        }
        return true;
      });
    }

    function renderProjectsList() {
      const listEl = document.getElementById('projects-list');
      if (!listEl) return;

      const filtered = getFilteredProjects();

      if (filtered.length === 0) {
        listEl.innerHTML = `<div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
          <h3>${projectFilter !== 'all' ? 'No ' + (PROJECT_STATUS_LABELS[projectFilter] || projectFilter) + ' projects' : 'No projects yet'}</h3>
          <p>${projectFilter !== 'all' ? 'No projects match this filter.' : 'Create your first project to start tracking work.'}</p>
          ${projectFilter === 'all' ? '<button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewProjectModal()">Create First Project</button>' : ''}
        </div>`;
        return;
      }

      listEl.innerHTML = filtered.map(p => {
        const statusColor = PROJECT_STATUS_COLORS[p.status] || '#6b7280';
        const priorityColor = PROJECT_PRIORITY_COLORS[p.priority] || '#6b7280';
        const value = parseFloat(p.value) || 0;
        const progress = p.progress || 0;
        const dateStr = p.created_at ? new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

        return `<div class="list-item-modern project-list-item" style="display: flex; align-items: center; gap: 16px; padding: 16px; cursor: pointer; border-bottom: 1px solid var(--dark-border); transition: background 0.15s; position: relative;" onclick="openProjectDetail('${p.id}')">
          <div style="width: 42px; height: 42px; border-radius: 10px; background: ${statusColor}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${statusColor}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.name)}</span>
              ${p.en_route_status === 'en_route' ? '<span style="font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: #f59e0b20; color: #f59e0b; display: inline-flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>EN ROUTE</span>' : ''}
              ${p.en_route_status === 'arrived' ? '<span style="font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: #22c55e20; color: #22c55e;">ON SITE</span>' : ''}
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${escapeHtml(p.customer_name || 'No customer')}</div>
            ${p.address ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; display: flex; align-items: center; gap: 4px; cursor: pointer;" onclick="event.stopPropagation(); openInGoogleMaps('${escapeHtml(p.address)}', '${escapeHtml(p.city || '')}', '${escapeHtml(p.state || '')}', '${escapeHtml(p.zip || '')}')"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${escapeHtml(p.address)}${p.city ? ', ' + escapeHtml(p.city) : ''}</div>` : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
            ${progress > 0 ? `<div style="width: 60px; height: 6px; background: var(--dark-border); border-radius: 3px; overflow: hidden;"><div style="width: ${progress}%; height: 100%; background: ${statusColor}; border-radius: 3px;"></div></div>` : ''}
            <span style="font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 6px; background: ${statusColor}20; color: ${statusColor};">${PROJECT_STATUS_LABELS[p.status] || p.status}</span>
            <span style="font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: ${priorityColor}15; color: ${priorityColor}; text-transform: capitalize;">${p.priority || 'medium'}</span>
            ${value > 0 ? `<span style="font-size: 13px; font-weight: 600; color: var(--gold-primary);">$${value.toLocaleString()}</span>` : ''}
            <span style="font-size: 11px; color: var(--text-muted);">${dateStr}</span>
            <!-- Quick Actions (visible on hover) -->
            <div class="project-quick-actions">
              <button onclick="event.stopPropagation(); quickChangeProjectStatus('${p.id}', '${p.status}')" class="status" title="Change Status">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
              </button>
              <button onclick="event.stopPropagation(); scheduleForProject('${p.id}')" class="schedule" title="Schedule">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </button>
              <button onclick="event.stopPropagation(); quickAddProjectTask('${p.id}')" class="task" title="Add Task">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
              </button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function renderProjectsKanban() {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed', 'on_hold'];
      const filtered = getFilteredProjects();

      statuses.forEach(status => {
        const cardsEl = document.getElementById(`proj-kanban-cards-${status}`);
        const countEl = document.getElementById(`proj-kanban-count-${status}`);
        if (!cardsEl) return;

        const statusProjects = filtered.filter(p => p.status === status);
        if (countEl) countEl.textContent = statusProjects.length;

        if (statusProjects.length === 0) {
          cardsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">No projects</div>';
          return;
        }

        cardsEl.innerHTML = statusProjects.map(p => {
          const value = parseFloat(p.value) || 0;
          const progress = p.progress || 0;
          const priorityColor = PROJECT_PRIORITY_COLORS[p.priority] || '#6b7280';

          return `<div class="kanban-card" draggable="true" ondragstart="onProjectDragStart(event, '${p.id}')" ondragend="onProjectDragEnd(event)" onclick="openProjectDetail('${p.id}')" style="background: var(--dark-card); border: 1px solid ${p.en_route_status === 'en_route' ? '#f59e0b' : 'var(--dark-border)'}; border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.15s; ${p.en_route_status === 'en_route' ? 'box-shadow: 0 0 0 1px #f59e0b40;' : ''}">
            ${p.en_route_status === 'en_route' ? '<div style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; margin-bottom: 8px; display: inline-flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>EN ROUTE</div>' : ''}
            ${p.en_route_status === 'arrived' ? '<div style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; margin-bottom: 8px; display: inline-flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>ON SITE</div>' : ''}
            <div style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.name)}</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${escapeHtml(p.customer_name || 'No customer')}</div>
            ${p.address ? `<div style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(p.address)}${p.city ? ', ' + escapeHtml(p.city) : ''}</span></div>` : '<div style="margin-bottom: 8px;"></div>'}
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
              <span style="font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: ${priorityColor}15; color: ${priorityColor}; text-transform: capitalize;">${p.priority || 'medium'}</span>
              ${value > 0 ? `<span style="font-size: 12px; font-weight: 600; color: var(--gold-primary);">$${value.toLocaleString()}</span>` : ''}
            </div>
            ${progress > 0 ? `<div style="margin-top: 8px; height: 4px; background: var(--dark-border); border-radius: 2px; overflow: hidden;"><div style="width: ${progress}%; height: 100%; background: var(--gold-primary); border-radius: 2px;"></div></div>` : ''}
            <!-- Kanban Quick Actions -->
            <div class="kanban-quick-actions">
              <button onclick="event.stopPropagation(); scheduleForProject('${p.id}')" class="schedule">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Schedule
              </button>
              <button onclick="event.stopPropagation(); quickAddProjectTask('${p.id}')" class="task">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Task
              </button>
            </div>
          </div>`;
        }).join('');
      });
    }

    // Kanban Drag-and-Drop
    var draggedProjectId = null;

    function onProjectDragStart(event, projectId) {
      draggedProjectId = projectId;
      event.dataTransfer.effectAllowed = 'move';
      event.target.style.opacity = '0.5';
      document.querySelectorAll('.kanban-column').forEach(function(col) {
        col.style.outline = '2px dashed rgba(212,175,55,0.3)';
      });
    }

    function onProjectDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      event.currentTarget.style.outline = '2px solid var(--gold-primary)';
    }

    function onProjectDragLeave(event) {
      event.currentTarget.style.outline = '2px dashed rgba(212,175,55,0.3)';
    }

    function onProjectDrop(event, newStatus) {
      event.preventDefault();
      document.querySelectorAll('.kanban-column').forEach(function(col) {
        col.style.outline = '';
      });
      if (!draggedProjectId) return;

      var project = allProjects.find(function(p) { return p.id === draggedProjectId; });
      if (!project || project.status === newStatus) {
        draggedProjectId = null;
        return;
      }

      quickUpdateProjectStatus(draggedProjectId, newStatus);
      draggedProjectId = null;
    }

    function onProjectDragEnd(event) {
      event.target.style.opacity = '';
      document.querySelectorAll('.kanban-column').forEach(function(col) {
        col.style.outline = '';
      });
      draggedProjectId = null;
    }

    function setProjectsView(view) {
      currentProjectsView = view;
      const listView = document.getElementById('projects-list-view');
      const boardView = document.getElementById('projects-board-view');
      const listBtn = document.getElementById('projectsListBtn');
      const boardBtn = document.getElementById('projectsBoardBtn');

      if (view === 'list') {
        if (listView) listView.style.display = '';
        if (boardView) boardView.style.display = 'none';
        if (listBtn) { listBtn.style.background = 'var(--gold-primary)'; listBtn.style.color = 'var(--dark-primary)'; }
        if (boardBtn) { boardBtn.style.background = 'transparent'; boardBtn.style.color = 'var(--text-secondary)'; }
      } else {
        if (listView) listView.style.display = 'none';
        if (boardView) boardView.style.display = '';
        if (listBtn) { listBtn.style.background = 'transparent'; listBtn.style.color = 'var(--text-secondary)'; }
        if (boardBtn) { boardBtn.style.background = 'var(--gold-primary)'; boardBtn.style.color = 'var(--dark-primary)'; }
      }
    }

    // Project source data caches
    let projectLeadsCache = [];
    let projectCustomersCache = [];
    let currentProjectSource = 'manual';

    function openNewProjectModal() {
      document.getElementById('project-modal-title').textContent = 'New Project';
      document.getElementById('project-edit-id').value = '';
      document.getElementById('proj-lead-id').value = '';
      document.getElementById('proj-customer-id').value = '';
      document.getElementById('project-form').reset();
      document.getElementById('proj-status').value = 'lead';
      document.getElementById('proj-priority').value = 'medium';

      // Show source selector for new projects
      document.getElementById('project-source-selector').style.display = '';
      selectProjectSource('manual');

      document.getElementById('project-modal').classList.add('active');

      // Pre-load leads and customers for quick selection
      loadLeadsForProjectSelect();
      loadCustomersForProjectSelect();
    }

    function selectProjectSource(source) {
      currentProjectSource = source;

      // Update tab styles
      ['manual', 'lead', 'customer'].forEach(s => {
        const tab = document.getElementById('source-tab-' + s);
        if (tab) {
          if (s === source) {
            tab.style.background = 'var(--gold-primary)';
            tab.style.borderColor = 'var(--gold-primary)';
            tab.style.color = 'var(--dark-primary)';
          } else {
            tab.style.background = 'transparent';
            tab.style.borderColor = 'var(--border-color)';
            tab.style.color = 'var(--text-primary)';
          }
        }
      });

      // Show/hide selectors
      document.getElementById('lead-selector-container').style.display = source === 'lead' ? '' : 'none';
      document.getElementById('customer-selector-container').style.display = source === 'customer' ? '' : 'none';

      // Clear search inputs
      if (source !== 'lead') {
        document.getElementById('lead-search-input').value = '';
        document.getElementById('proj-lead-id').value = '';
      }
      if (source !== 'customer') {
        document.getElementById('customer-search-input').value = '';
      }
    }

    async function loadLeadsForProjectSelect() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: leads, error } = await supabaseClient
          .from('leads')
          .select('id, name, email, phone, address, city, state, zip, status, service_type, notes')
          .eq('user_id', user.id)
          .not('status', 'eq', 'converted')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;
        projectLeadsCache = leads || [];
        renderLeadDropdown(projectLeadsCache);
      } catch (err) {
        console.error('Error loading leads:', err);
      }
    }

    function renderLeadDropdown(leads) {
      const dropdown = document.getElementById('lead-dropdown');
      if (!dropdown) return;

      if (leads.length === 0) {
        dropdown.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">No leads found</div>';
        return;
      }

      dropdown.innerHTML = leads.map(lead => {
        const statusColor = lead.status === 'new' ? '#10b981' : lead.status === 'contacted' ? '#3b82f6' : '#f59e0b';
        return '<div class="dropdown-item" onclick="selectLeadForProject(\'' + lead.id + '\')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
          '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(lead.name) + '</div>' +
          '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">' + escapeHtml(lead.email || 'No email') + (lead.phone ? '  ' + escapeHtml(lead.phone) : '') + '</div>' +
          '<div style="display: flex; gap: 8px; margin-top: 4px;">' +
            '<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: ' + statusColor + '22; color: ' + statusColor + '; text-transform: uppercase;">' + lead.status + '</span>' +
            (lead.service_type ? '<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--dark-tertiary); color: var(--text-secondary);">' + escapeHtml(lead.service_type) + '</span>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    }

    function filterLeadsForProject(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderLeadDropdown(projectLeadsCache);
        return;
      }
      const filtered = projectLeadsCache.filter(lead =>
        (lead.name && lead.name.toLowerCase().includes(q)) ||
        (lead.email && lead.email.toLowerCase().includes(q)) ||
        (lead.phone && lead.phone.includes(q))
      );
      renderLeadDropdown(filtered);
    }

    function showLeadDropdown() {
      document.getElementById('lead-dropdown').style.display = '';
      document.getElementById('customer-dropdown').style.display = 'none';
    }

    function selectLeadForProject(leadId) {
      const lead = projectLeadsCache.find(l => l.id === leadId);
      if (!lead) return;

      // Populate form from lead
      document.getElementById('proj-lead-id').value = leadId;
      document.getElementById('lead-search-input').value = lead.name;
      document.getElementById('lead-dropdown').style.display = 'none';

      // Auto-fill project fields
      document.getElementById('proj-name').value = (lead.service_type ? lead.service_type + ' - ' : '') + lead.name;
      document.getElementById('proj-customer-name').value = lead.name || '';
      document.getElementById('proj-customer-email').value = lead.email || '';
      document.getElementById('proj-customer-phone').value = lead.phone || '';
      document.getElementById('proj-address').value = lead.address || '';
      document.getElementById('proj-city').value = lead.city || '';
      document.getElementById('proj-state').value = lead.state || '';
      document.getElementById('proj-zip').value = lead.zip || '';
      if (lead.notes) {
        document.getElementById('proj-notes').value = 'From lead: ' + lead.notes;
      }

      showToast('Lead data loaded', 'success');
    }

    async function loadCustomersForProjectSelect() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state, zip, notes, lead_id')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;
        projectCustomersCache = customers || [];
        renderCustomerDropdown(projectCustomersCache);
      } catch (err) {
        console.error('Error loading customers:', err);
      }
    }

    function renderCustomerDropdown(customers) {
      const dropdown = document.getElementById('customer-dropdown');
      if (!dropdown) return;

      if (customers.length === 0) {
        dropdown.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">No customers found</div>';
        return;
      }

      dropdown.innerHTML = customers.map(customer => {
        return '<div class="dropdown-item" onclick="selectCustomerForProject(\'' + customer.id + '\')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
          '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(customer.name) + '</div>' +
          '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">' + escapeHtml(customer.email || 'No email') + (customer.phone ? '  ' + escapeHtml(customer.phone) : '') + '</div>' +
          (customer.address ? '<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">' + escapeHtml(customer.address) + '</div>' : '') +
        '</div>';
      }).join('');
    }

    function filterCustomersForProject(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderCustomerDropdown(projectCustomersCache);
        return;
      }
      const filtered = projectCustomersCache.filter(customer =>
        (customer.name && customer.name.toLowerCase().includes(q)) ||
        (customer.email && customer.email.toLowerCase().includes(q)) ||
        (customer.phone && customer.phone.includes(q))
      );
      renderCustomerDropdown(filtered);
    }

    function showCustomerDropdown() {
      document.getElementById('customer-dropdown').style.display = '';
      document.getElementById('lead-dropdown').style.display = 'none';
    }

    function selectCustomerForProject(customerId) {
      const customer = projectCustomersCache.find(c => c.id === customerId);
      if (!customer) return;

      // Populate form from customer
      document.getElementById('proj-customer-id').value = customerId;
      document.getElementById('proj-lead-id').value = customer.lead_id || '';
      document.getElementById('customer-search-input').value = customer.name;
      document.getElementById('customer-dropdown').style.display = 'none';

      // Auto-fill project fields
      document.getElementById('proj-name').value = 'Project - ' + customer.name;
      document.getElementById('proj-customer-name').value = customer.name || '';
      document.getElementById('proj-customer-email').value = customer.email || '';
      document.getElementById('proj-customer-phone').value = customer.phone || '';
      document.getElementById('proj-address').value = customer.address || '';
      document.getElementById('proj-city').value = customer.city || '';
      document.getElementById('proj-state').value = customer.state || '';
      document.getElementById('proj-zip').value = customer.zip || '';
      if (customer.notes) {
        document.getElementById('proj-notes').value = 'From customer: ' + customer.notes;
      }

      showToast('Customer data loaded', 'success');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#lead-selector-container')) {
        const leadDropdown = document.getElementById('lead-dropdown');
        if (leadDropdown) leadDropdown.style.display = 'none';
      }
      if (!e.target.closest('#customer-selector-container')) {
        const customerDropdown = document.getElementById('customer-dropdown');
        if (customerDropdown) customerDropdown.style.display = 'none';
      }
    });

    function openEditProjectModal(project) {
      document.getElementById('project-modal-title').textContent = 'Edit Project';
      document.getElementById('project-edit-id').value = project.id;
      document.getElementById('proj-lead-id').value = project.lead_id || '';
      document.getElementById('proj-customer-id').value = project.customer_id || '';
      document.getElementById('proj-name').value = project.name || '';
      document.getElementById('proj-description').value = project.description || '';
      document.getElementById('proj-status').value = project.status || 'lead';
      document.getElementById('proj-priority').value = project.priority || 'medium';
      document.getElementById('proj-customer-name').value = project.customer_name || '';
      document.getElementById('proj-customer-email').value = project.customer_email || '';
      document.getElementById('proj-customer-phone').value = project.customer_phone || '';
      document.getElementById('proj-address').value = project.address || '';
      document.getElementById('proj-city').value = project.city || '';
      document.getElementById('proj-state').value = project.state || '';
      document.getElementById('proj-zip').value = project.zip || '';
      document.getElementById('proj-value').value = project.value || '';
      document.getElementById('proj-cost').value = project.cost || '';
      document.getElementById('proj-start-date').value = project.start_date ? project.start_date.split('T')[0] : '';
      document.getElementById('proj-end-date').value = project.end_date ? project.end_date.split('T')[0] : '';
      document.getElementById('proj-duration').value = project.estimated_duration || '';
      document.getElementById('proj-notes').value = project.notes || '';
      document.getElementById('proj-customer-notes').value = project.customer_notes || '';

      // Hide source selector when editing existing projects
      document.getElementById('project-source-selector').style.display = 'none';

      document.getElementById('project-modal').classList.add('active');
    }

    function closeProjectModal() {
      document.getElementById('project-modal').classList.remove('active');
    }

    async function saveProject(event) {
      event.preventDefault();

      const editId = document.getElementById('project-edit-id').value;
      const isEdit = !!editId;

      const leadId = document.getElementById('proj-lead-id').value.trim() || null;
      const customerId = document.getElementById('proj-customer-id').value.trim() || null;

      const projectData = {
        name: document.getElementById('proj-name').value.trim(),
        description: document.getElementById('proj-description').value.trim() || null,
        status: document.getElementById('proj-status').value,
        priority: document.getElementById('proj-priority').value,
        lead_id: leadId,
        customer_id: customerId,
        customer_name: document.getElementById('proj-customer-name').value.trim(),
        customer_email: document.getElementById('proj-customer-email').value.trim() || null,
        customer_phone: document.getElementById('proj-customer-phone').value.trim() || null,
        address: document.getElementById('proj-address').value.trim() || null,
        city: document.getElementById('proj-city').value.trim() || null,
        state: document.getElementById('proj-state').value.trim() || null,
        zip: document.getElementById('proj-zip').value.trim() || null,
        value: parseFloat(document.getElementById('proj-value').value) || 0,
        cost: parseFloat(document.getElementById('proj-cost').value) || 0,
        start_date: document.getElementById('proj-start-date').value || null,
        end_date: document.getElementById('proj-end-date').value || null,
        estimated_duration: parseInt(document.getElementById('proj-duration').value) || null,
        notes: document.getElementById('proj-notes').value.trim() || null,
        customer_notes: document.getElementById('proj-customer-notes').value.trim() || null
      };

      const btn = document.getElementById('save-project-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 18px; height: 18px; margin: 0 auto;"></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        let result;
        if (isEdit) {
          result = await supabaseClient
            .from('projects')
            .update(projectData)
            .eq('id', editId)
            .eq('user_id', user.id)
            .select()
            .single();
        } else {
          result = await supabaseClient
            .from('projects')
            .insert({ ...projectData, user_id: user.id })
            .select()
            .single();
        }

        if (result.error) throw result.error;

        closeProjectModal();
        showToast(isEdit ? 'Project updated' : 'Project created', 'success');
        await loadProjects();

        const project = result.data;

        // If created from a lead, update lead status to 'converted' and auto-create customer
        if (!isEdit && leadId) {
          try {
            // Update lead status to converted
            await supabaseClient
              .from('leads')
              .update({ status: 'converted', converted_at: new Date().toISOString() })
              .eq('id', leadId)
              .eq('user_id', user.id);
            console.log('Lead marked as converted:', leadId);

            // Auto-create customer if not already linked
            if (!customerId && projectData.customer_name) {
              // Check if customer with this email already exists
              let existingCustomer = null;
              if (projectData.customer_email) {
                const { data: existing } = await supabaseClient
                  .from('customers')
                  .select('id')
                  .eq('user_id', user.id)
                  .eq('email', projectData.customer_email)
                  .limit(1);
                existingCustomer = existing?.[0];
              }

              if (existingCustomer) {
                // Link existing customer to project
                await supabaseClient
                  .from('projects')
                  .update({ customer_id: existingCustomer.id })
                  .eq('id', project.id);
                console.log('Linked existing customer to project:', existingCustomer.id);
              } else {
                // Create new customer from project data
                const { data: newCustomer, error: custErr } = await supabaseClient
                  .from('customers')
                  .insert({
                    user_id: user.id,
                    lead_id: leadId,
                    name: projectData.customer_name,
                    email: projectData.customer_email,
                    phone: projectData.customer_phone,
                    address: projectData.address,
                    city: projectData.city,
                    state: projectData.state,
                    zip: projectData.zip
                  })
                  .select()
                  .single();

                if (!custErr && newCustomer) {
                  // Link new customer to project
                  await supabaseClient
                    .from('projects')
                    .update({ customer_id: newCustomer.id })
                    .eq('id', project.id);
                  console.log('Auto-created customer from lead:', newCustomer.id);
                }
              }
            }
          } catch (convErr) {
            console.warn('Could not convert lead:', convErr.message);
          }
        }

        // Auto-create calendar event if project has start_date and status is scheduled/in_progress
        if (project && project.start_date && ['scheduled', 'in_progress'].includes(project.status)) {
          try {
            // Check if calendar event already exists for this project
            const { data: existingEvent } = await supabaseClient
              .from('calendar_events')
              .select('id')
              .eq('project_id', project.id)
              .limit(1);

            if (!existingEvent || existingEvent.length === 0) {
              // Create calendar event for project start
              const startDate = new Date(project.start_date + 'T09:00:00');
              const endDate = new Date(startDate.getTime() + 4 * 60 * 60 * 1000); // 4 hours

              await supabaseClient
                .from('calendar_events')
                .insert([{
                  created_by: user.id,
                  title: 'Project: ' + project.name,
                  description: 'Customer: ' + project.customer_name + '\nPhone: ' + (project.customer_phone || 'N/A') + '\nEmail: ' + (project.customer_email || 'N/A') + '\nAddress: ' + (project.address || 'N/A'),
                  event_type: project.status === 'scheduled' ? 'measurement' : 'installation',
                  start_time: startDate.toISOString(),
                  end_time: endDate.toISOString(),
                  location: project.address,
                  location_address: [project.address, project.city, project.state, project.zip].filter(Boolean).join(', '),
                  project_id: project.id,
                  status: 'scheduled',
                  color: '#10b981'
                }]);

              console.log('Calendar event auto-created for project', project.id);
            }
          } catch (calErr) {
            console.warn('Could not auto-create calendar event:', calErr.message);
          }
        }

        // If detail modal is open, refresh it
        if (currentProjectId && isEdit) {
          openProjectDetail(currentProjectId);
        }
      } catch (err) {
        console.error('Error saving project:', err);
        showToast('Error: ' + (err.message || 'Failed to save project'), 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Project';
      }
    }

    async function openProjectDetail(projectId) {
      currentProjectId = projectId;
      const modal = document.getElementById('project-detail-modal');
      const body = document.getElementById('project-detail-body');
      modal.classList.add('active');
      body.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        const { data: project, error } = await supabaseClient
          .from('projects')
          .select('*')
          .eq('id', projectId)
          .single();

        if (error || !project) throw error || new Error('Project not found');

        // Fetch related data in parallel
        const [tasksResult, activityResult, collaboratorsResult, estimatesResult, invoicesResult] = await Promise.all([
          supabaseClient.from('project_tasks').select('*').eq('project_id', projectId).order('sort_order', { ascending: true }),
          supabaseClient.from('project_activity').select('*').eq('project_id', projectId).order('created_at', { ascending: false }).limit(20),
          supabaseClient.from('project_collaborators').select('*').eq('project_id', projectId),
          project.customer_email ? supabaseClient.from('estimates').select('id, estimate_number, status, total, created_at').eq('user_id', user.id).eq('customer_email', project.customer_email).order('created_at', { ascending: false }).limit(5) : Promise.resolve({ data: [] }),
          project.customer_email ? supabaseClient.from('invoices').select('id, invoice_number, status, total, created_at').eq('user_id', user.id).eq('customer_email', project.customer_email).order('created_at', { ascending: false }).limit(5) : Promise.resolve({ data: [] })
        ]);

        const tasks = tasksResult.data || [];
        const activity = activityResult.data || [];
        const collaborators = collaboratorsResult.data || [];
        const linkedEstimates = estimatesResult.data || [];
        const linkedInvoices = invoicesResult.data || [];

        document.getElementById('project-detail-title').textContent = project.name;

        const statusColor = PROJECT_STATUS_COLORS[project.status] || '#6b7280';
        const priorityColor = PROJECT_PRIORITY_COLORS[project.priority] || '#6b7280';
        const value = parseFloat(project.value) || 0;
        const cost = parseFloat(project.cost) || 0;
        const profit = value - cost;
        const progress = project.progress || 0;

        body.innerHTML = `
          <!-- Workflow Status Bar -->
          ${renderWorkflowStatusBar(project)}

          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
            <span style="font-size: 13px; font-weight: 600; padding: 6px 14px; border-radius: 8px; background: ${statusColor}20; color: ${statusColor};">${PROJECT_STATUS_LABELS[project.status] || project.status}</span>
            <span style="font-size: 13px; font-weight: 600; padding: 6px 14px; border-radius: 8px; background: ${priorityColor}15; color: ${priorityColor}; text-transform: capitalize;">${project.priority || 'medium'} priority</span>
            <select onchange="quickUpdateProjectStatus('${project.id}', this.value)" style="font-size: 12px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--dark-border); background: var(--dark-elevated); color: var(--text-primary); cursor: pointer;">
              <option value="" disabled selected>Change Status...</option>
              ${Object.entries(PROJECT_STATUS_LABELS).map(([k, v]) => `<option value="${k}" ${project.status === k ? 'disabled' : ''}>${v}</option>`).join('')}
            </select>
          </div>

          <!-- Progress Bar -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
              <span>Progress</span><span>${progress}%</span>
            </div>
            <div style="height: 8px; background: var(--dark-border); border-radius: 4px; overflow: hidden;">
              <div style="width: ${progress}%; height: 100%; background: ${progress >= 100 ? '#22c55e' : 'var(--gold-primary)'}; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
          </div>

          <!-- Task Checklist -->
          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="none" stroke="var(--gold-primary)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Tasks</span>
                <span style="font-size: 11px; color: var(--text-muted);">(${tasks.filter(t => t.status === 'completed').length}/${tasks.length})</span>
              </div>
              <div style="display: flex; gap: 6px;">
                <button onclick="showAddTaskTemplates('${project.id}')" class="btn-modern ghost" style="font-size: 11px; padding: 4px 8px;" title="Add from template">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                </button>
                <button onclick="addProjectTask('${project.id}')" class="btn-modern primary" style="font-size: 11px; padding: 4px 10px;">+ Add Task</button>
              </div>
            </div>
            <div id="project-tasks-list" data-project-id="${project.id}">
              ${tasks.length > 0 ? tasks.map(task => renderProjectTaskItem(task)).join('') : '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">No tasks yet. Add tasks to track progress.</div>'}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Customer</div>
              <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(project.customer_name || 'N/A')}</div>
              ${project.customer_email ? `<a href="mailto:${escapeHtml(project.customer_email)}" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; display: block; text-decoration: none;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${escapeHtml(project.customer_email)}</a>` : ''}
              ${project.customer_phone ? `<a href="tel:${escapeHtml(project.customer_phone)}" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px; display: block; text-decoration: none;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${escapeHtml(project.customer_phone)}</a>` : ''}
              ${project.address ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                  <a href="${getNavigationUrl(project.address, project.city, project.state, project.zip)}" target="_blank" style="font-size: 12px; color: #3b82f6; text-decoration: none; display: flex; align-items: flex-start; gap: 6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>${escapeHtml(project.address)}${project.city ? ', ' + escapeHtml(project.city) : ''}${project.state ? ', ' + escapeHtml(project.state) : ''} ${escapeHtml(project.zip || '')}</span>
                  </a>
                  <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button onclick="openInGoogleMaps('${escapeHtml(project.address)}', '${escapeHtml(project.city || '')}', '${escapeHtml(project.state || '')}', '${escapeHtml(project.zip || '')}')" class="btn-modern ghost" style="font-size: 11px; padding: 6px 10px; flex: 1;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                      Directions
                    </button>
                    <button onclick="shareEnRouteStatus('${project.id}', '${escapeHtml(project.customer_name || '')}', '${escapeHtml(project.address || '')}', '${escapeHtml(project.city || '')}', '${escapeHtml(project.state || '')}', '${escapeHtml(project.zip || '')}')" class="btn-modern primary" style="font-size: 11px; padding: 6px 10px; flex: 1;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                      En Route
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>
            <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Financials</div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Value</span>
                <span style="font-weight: 600; color: var(--gold-primary);">$${value.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Cost</span>
                <span style="font-weight: 600; color: var(--error-color);">$${cost.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; border-top: 1px solid var(--dark-border); padding-top: 4px; margin-top: 4px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Profit</span>
                <span style="font-weight: 600; color: ${profit >= 0 ? '#22c55e' : '#ef4444'};">$${profit.toLocaleString()}</span>
              </div>
            </div>
          </div>

          ${project.start_date || project.end_date ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Schedule</div>
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
              ${project.start_date ? `<div><span style="font-size: 12px; color: var(--text-secondary);">Start: </span><span style="font-weight: 600; color: var(--text-primary);">${new Date(project.start_date).toLocaleDateString()}</span></div>` : ''}
              ${project.end_date ? `<div><span style="font-size: 12px; color: var(--text-secondary);">End: </span><span style="font-weight: 600; color: var(--text-primary);">${new Date(project.end_date).toLocaleDateString()}</span></div>` : ''}
              ${project.estimated_duration ? `<div><span style="font-size: 12px; color: var(--text-secondary);">Duration: </span><span style="font-weight: 600; color: var(--text-primary);">${project.estimated_duration} days</span></div>` : ''}
            </div>
          </div>` : ''}

          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Estimates & Invoices</div>
              <button class="btn-modern primary small" onclick="createEstimateFromProject('${project.id}')" style="font-size: 11px; padding: 4px 10px;">+ Estimate</button>
            </div>
            ${linkedEstimates.length > 0 ? linkedEstimates.map(function(est) {
              var estColor = est.status === 'approved' ? '#22c55e' : est.status === 'sent' ? '#3b82f6' : est.status === 'draft' ? '#6b7280' : '#f59e0b';
              return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">' +
                '<div><span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">#' + escapeHtml(est.estimate_number || 'Draft') + '</span>' +
                '<span style="font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; background: ' + estColor + '20; color: ' + estColor + ';">' + escapeHtml(est.status || 'draft') + '</span></div>' +
                '<span style="font-weight: 600; color: var(--gold-primary);">$' + (est.total || 0).toLocaleString() + '</span></div>';
            }).join('') : '<div style="font-size: 12px; color: var(--text-muted); padding: 8px 0;">No linked estimates</div>'}
            ${linkedInvoices.length > 0 ? '<div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--dark-border);">' +
              '<div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Invoices</div>' +
              linkedInvoices.map(function(inv) {
                var invColor = inv.status === 'paid' ? '#22c55e' : inv.status === 'open' ? '#3b82f6' : '#6b7280';
                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">' +
                  '<div><span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">#' + escapeHtml(inv.invoice_number || 'Draft') + '</span>' +
                  '<span style="font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; background: ' + invColor + '20; color: ' + invColor + ';">' + escapeHtml(inv.status || 'draft') + '</span></div>' +
                  '<span style="font-weight: 600; color: var(--gold-primary);">$' + (inv.total || 0).toLocaleString() + '</span></div>';
              }).join('') + '</div>' : ''}
          </div>

          ${project.description ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Description</div>
            <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">${escapeHtml(project.description)}</div>
          </div>` : ''}

          ${project.notes ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Internal Notes</div>
            <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">${escapeHtml(project.notes)}</div>
          </div>` : ''}

          <!-- Team Members (Quick-Assign from Network) -->
          <div id="project-team-section" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Team Members</div>
              <button class="btn-modern primary" style="font-size: 11px; padding: 4px 10px;" onclick="openQuickAssignModal('${project.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 2px;"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                Assign
              </button>
            </div>
            <div id="project-team-list" data-project-id="${project.id}" style="min-height: 40px;">
              <div style="text-align: center; padding: 8px; color: var(--text-muted); font-size: 12px;">Loading team...</div>
            </div>
          </div>

          ${collaborators.length > 0 ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">External Collaborators (${collaborators.length})</div>
              <button class="btn-modern secondary" style="font-size: 11px; padding: 4px 10px;" onclick="closeProjectDetail(); openInviteToProjectModal('${project.id}');">+ Invite</button>
            </div>
            ${collaborators.map(c => `<div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--gold-primary); color: var(--dark-primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">${(c.collaborator_name || c.collaborator_email || '?').charAt(0).toUpperCase()}</div>
              <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">${escapeHtml(c.collaborator_name || c.collaborator_email || 'Unknown')}</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${c.role || 'Member'} - ${c.invitation_status || 'pending'}</div>
              </div>
            </div>`).join('')}
          </div>` : ''}

          <div id="project-handoffs-section" data-project-id="${project.id}" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Design Handoffs</div>
              <button class="btn-modern secondary" style="font-size: 11px; padding: 4px 10px; color: #22c55e;" onclick="closeProjectDetail(); openStartHandoffModal(null, '', '${project.id}');">+ New Handoff</button>
            </div>
            <div id="project-handoffs-list" style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 8px;">Loading handoffs...</div>
          </div>

          <div id="project-collab-listings" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Collaborator Marketplace</div>
              <a href="/remnants/" target="_blank" class="btn-modern secondary" style="font-size: 11px; padding: 4px 10px;">Browse All</a>
            </div>
            <div id="project-collab-listings-content" style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 8px;">Loading listings...</div>
          </div>

          <!-- Comments Feed -->
          <div id="project-comments-section" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="none" stroke="var(--gold-primary)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Comments</span>
              </div>
            </div>
            <div id="project-comments-list" data-project-id="${project.id}" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
              <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">Loading comments...</div>
            </div>
            <form onsubmit="addProjectComment('${project.id}', this); return false;" style="display: flex; gap: 8px;">
              <input type="text" name="comment" placeholder="Add a comment..." required
                     style="flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--dark-border); background: var(--dark-surface); color: var(--text-primary); font-size: 13px;">
              <button type="submit" class="btn-modern primary" style="padding: 10px 16px;">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              </button>
            </form>
          </div>

          ${activity.filter(a => a.action !== 'comment').length > 0 ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Recent Activity</div>
            ${activity.filter(a => a.action !== 'comment').slice(0, 10).map(a => `<div style="display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">
              <div style="width: 6px; height: 6px; border-radius: 50%; background: var(--gold-primary); margin-top: 6px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="font-size: 12px; color: var(--text-primary);">${escapeHtml(a.description || a.action || 'Activity')}</div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${a.created_at ? new Date(a.created_at).toLocaleString() : ''}</div>
              </div>
            </div>`).join('')}
          </div>` : ''}

          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button class="btn-modern secondary" onclick="scheduleForProject('${project.id}')" style="flex: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              Schedule
            </button>
            <button class="btn-modern primary" onclick="editCurrentProject()" style="flex: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              Edit
            </button>
            <button class="btn-modern secondary" onclick="deleteProject('${project.id}')" style="flex: 1; color: var(--error-color);">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              Delete
            </button>
          </div>
        `;

        // Load team members, design handoffs, comments and collaborator listings for this project
        loadProjectTeam(projectId);
        loadProjectHandoffs(projectId);
        loadProjectComments(projectId);
        loadCollaboratorListings(projectId);

      } catch (err) {
        console.error('Error loading project detail:', err);
        body.innerHTML = '<div class="empty-state"><h3>Error loading project</h3><p>' + (err.message || 'Please try again') + '</p></div>';
      }
    }

    function closeProjectDetail() {
      document.getElementById('project-detail-modal').classList.remove('active');
      currentProjectId = null;
    }

    // =============================================
    // PROJECT TASK CHECKLIST
    // =============================================

    // Task templates for quick setup
    const PROJECT_TASK_TEMPLATES = {
      kitchen: [
        { title: 'Initial consultation', sort_order: 1 },
        { title: 'Measure completed', sort_order: 2 },
        { title: 'Material selected', sort_order: 3 },
        { title: 'Estimate approved', sort_order: 4 },
        { title: 'Deposit received', sort_order: 5 },
        { title: 'Material ordered', sort_order: 6 },
        { title: 'Material received', sort_order: 7 },
        { title: 'Template created', sort_order: 8 },
        { title: 'Fabrication complete', sort_order: 9 },
        { title: 'Installation scheduled', sort_order: 10 },
        { title: 'Installation complete', sort_order: 11 },
        { title: 'Final walkthrough', sort_order: 12 }
      ],
      bathroom: [
        { title: 'Initial consultation', sort_order: 1 },
        { title: 'Measure completed', sort_order: 2 },
        { title: 'Material selected', sort_order: 3 },
        { title: 'Estimate approved', sort_order: 4 },
        { title: 'Deposit received', sort_order: 5 },
        { title: 'Material ordered', sort_order: 6 },
        { title: 'Installation scheduled', sort_order: 7 },
        { title: 'Installation complete', sort_order: 8 },
        { title: 'Final inspection', sort_order: 9 }
      ],
      simple: [
        { title: 'Contact customer', sort_order: 1 },
        { title: 'Schedule appointment', sort_order: 2 },
        { title: 'Create estimate', sort_order: 3 },
        { title: 'Get approval', sort_order: 4 },
        { title: 'Complete work', sort_order: 5 },
        { title: 'Collect payment', sort_order: 6 }
      ]
    };

    function renderProjectTaskItem(task) {
      const isCompleted = task.status === 'completed';
      const checkboxStyle = isCompleted
        ? 'background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-color: #22c55e;'
        : 'background: transparent; border-color: var(--border-light);';

      return `
        <div class="task-item" data-task-id="${task.id}" style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); ${isCompleted ? 'opacity: 0.6;' : ''}">
          <button onclick="toggleProjectTask('${task.id}', ${!isCompleted})"
                  style="width: 22px; height: 22px; border-radius: 6px; border: 2px solid; ${checkboxStyle} cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;">
            ${isCompleted ? '<svg width="14" height="14" fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' : ''}
          </button>
          <span style="flex: 1; font-size: 14px; color: var(--text-primary); ${isCompleted ? 'text-decoration: line-through;' : ''}">${escapeHtml(task.title)}</span>
          ${task.assigned_to ? `<span style="font-size: 11px; color: var(--text-muted); background: var(--dark-surface); padding: 2px 8px; border-radius: 4px;">${escapeHtml(task.assigned_to)}</span>` : ''}
          <button onclick="deleteProjectTask('${task.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'; this.style.color='#ef4444'" onmouseout="this.style.opacity='0.5'; this.style.color='var(--text-muted)'">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          </button>
        </div>
      `;
    }

    async function toggleProjectTask(taskId, completed) {
      try {
        const newStatus = completed ? 'completed' : 'pending';
        const completedAt = completed ? new Date().toISOString() : null;

        const { error } = await supabaseClient
          .from('project_tasks')
          .update({ status: newStatus, completed_at: completedAt })
          .eq('id', taskId);

        if (error) throw error;

        // Refresh project detail to show updated progress
        if (currentProjectId) {
          openProjectDetail(currentProjectId);
        }
        showToast(completed ? 'Task completed!' : 'Task reopened', 'success');
      } catch (err) {
        console.error('Error toggling task:', err);
        showToast('Failed to update task', 'error');
      }
    }

    async function addProjectTask(projectId, title) {
      if (!title) {
        title = prompt('Enter task name:');
        if (!title || !title.trim()) return;
      }

      try {
        // Get current max sort_order
        const { data: existingTasks } = await supabaseClient
          .from('project_tasks')
          .select('sort_order')
          .eq('project_id', projectId)
          .order('sort_order', { ascending: false })
          .limit(1);

        const sortOrder = (existingTasks && existingTasks[0]?.sort_order || 0) + 1;

        const { error } = await supabaseClient
          .from('project_tasks')
          .insert({
            project_id: projectId,
            title: title.trim(),
            status: 'pending',
            sort_order: sortOrder
          });

        if (error) throw error;

        // Refresh project detail
        openProjectDetail(projectId);
        showToast('Task added', 'success');
      } catch (err) {
        console.error('Error adding task:', err);
        showToast('Failed to add task', 'error');
      }
    }

    async function deleteProjectTask(taskId) {
      if (!confirm('Delete this task?')) return;

      try {
        const { error } = await supabaseClient
          .from('project_tasks')
          .delete()
          .eq('id', taskId);

        if (error) throw error;

        // Refresh project detail
        if (currentProjectId) {
          openProjectDetail(currentProjectId);
        }
        showToast('Task deleted', 'success');
      } catch (err) {
        console.error('Error deleting task:', err);
        showToast('Failed to delete task', 'error');
      }
    }

    function showAddTaskTemplates(projectId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'task-templates-modal';
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
            <h2 class="modal-title">Add Task Template</h2>
            <button class="modal-close" onclick="document.getElementById('task-templates-modal').remove()">&times;</button>
          </div>
          <div class="modal-body" style="padding: 20px;">
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 13px;">Choose a template to quickly add common tasks:</p>

            <div onclick="applyTaskTemplate('${projectId}', 'kitchen')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--gold-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Kitchen Remodel</div>
                <div style="font-size: 12px; color: var(--text-muted);">12 tasks: consultation to walkthrough</div>
              </div>
            </div>

            <div onclick="applyTaskTemplate('${projectId}', 'bathroom')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--gold-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Bathroom Project</div>
                <div style="font-size: 12px; color: var(--text-muted);">9 tasks: consultation to inspection</div>
              </div>
            </div>

            <div onclick="applyTaskTemplate('${projectId}', 'simple')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--gold-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Simple Project</div>
                <div style="font-size: 12px; color: var(--text-muted);">6 tasks: contact to payment</div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function applyTaskTemplate(projectId, templateKey) {
      const template = PROJECT_TASK_TEMPLATES[templateKey];
      if (!template) return;

      document.getElementById('task-templates-modal')?.remove();

      try {
        // Get current max sort_order
        const { data: existingTasks } = await supabaseClient
          .from('project_tasks')
          .select('sort_order')
          .eq('project_id', projectId)
          .order('sort_order', { ascending: false })
          .limit(1);

        const startOrder = (existingTasks && existingTasks[0]?.sort_order || 0) + 1;

        // Insert all template tasks
        const tasks = template.map((t, i) => ({
          project_id: projectId,
          title: t.title,
          status: 'pending',
          sort_order: startOrder + i
        }));

        const { error } = await supabaseClient
          .from('project_tasks')
          .insert(tasks);

        if (error) throw error;

        // Refresh project detail
        openProjectDetail(projectId);
        showToast(`Added ${template.length} tasks from template`, 'success');
      } catch (err) {
        console.error('Error applying template:', err);
        showToast('Failed to apply template', 'error');
      }
    }

    // =============================================
    // PROJECT COMMENTS FEED
    // =============================================

    async function loadProjectComments(projectId) {
      const list = document.getElementById('project-comments-list');
      if (!list || list.dataset.projectId !== projectId) return;

      try {
        const { data: comments, error } = await supabaseClient
          .from('project_activity')
          .select('*')
          .eq('project_id', projectId)
          .eq('action', 'comment')
          .order('created_at', { ascending: true });

        if (error) throw error;

        if (!comments || comments.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom: 8px; opacity: 0.5;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
              <p style="font-size: 13px; margin: 0;">No comments yet. Start the conversation!</p>
            </div>
          `;
          return;
        }

        list.innerHTML = comments.map(comment => renderProjectComment(comment)).join('');

        // Scroll to bottom
        list.scrollTop = list.scrollHeight;

      } catch (err) {
        console.error('Error loading comments:', err);
        list.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--error-color); font-size: 13px;">Failed to load comments</div>';
      }
    }

    function renderProjectComment(comment) {
      const initial = (comment.user_name || 'U').charAt(0).toUpperCase();
      const timeAgo = getTimeAgo(new Date(comment.created_at));
      const isOwnComment = currentUser && comment.user_id === currentUser.id;

      return `
        <div class="comment-item" style="display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); ${isOwnComment ? 'background: rgba(212, 175, 55, 0.05); margin: 0 -12px; padding-left: 12px; padding-right: 12px; border-radius: 6px;' : ''}">
          <div style="width: 32px; height: 32px; border-radius: 50%; background: ${isOwnComment ? 'var(--gold-primary)' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'}; color: ${isOwnComment ? 'var(--dark-primary)' : '#fff'}; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; flex-shrink: 0;">
            ${initial}
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${escapeHtml(comment.user_name || 'Team Member')}</span>
              <span style="font-size: 11px; color: var(--text-muted);">${timeAgo}</span>
            </div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4; word-wrap: break-word;">${escapeHtml(comment.description || '')}</div>
          </div>
        </div>
      `;
    }

    async function addProjectComment(projectId, form) {
      const input = form.querySelector('input[name="comment"]');
      const commentText = input.value.trim();

      if (!commentText) return;

      // Disable form while submitting
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      input.disabled = true;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get user's display name
        const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';

        const { error } = await supabaseClient
          .from('project_activity')
          .insert({
            project_id: projectId,
            action: 'comment',
            description: commentText,
            user_id: user.id,
            user_name: userName
          });

        if (error) throw error;

        // Clear input and reload comments
        input.value = '';
        await loadProjectComments(projectId);

      } catch (err) {
        console.error('Error adding comment:', err);
        showToast('Failed to add comment', 'error');
      } finally {
        submitBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    // =============================================
    // QUICK-ASSIGN TEAM MEMBERS TO PROJECT
    // =============================================

    let quickAssignNetworkCache = [];
    let selectedQuickAssignCollaborator = null;

    async function openQuickAssignModal(projectId) {
      const modal = document.getElementById('quick-assign-modal');
      if (!modal) return;

      document.getElementById('quick-assign-project-id').value = projectId;
      selectedQuickAssignCollaborator = null;
      document.getElementById('quick-assign-btn').disabled = true;
      document.getElementById('quick-assign-search').value = '';

      modal.classList.add('active');

      // Load network collaborators
      const listEl = document.getElementById('quick-assign-list');
      listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading network...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load collaborators and already-assigned team members
        const [collabResult, assignedResult] = await Promise.all([
          supabaseClient
            .from('general_collaborators')
            .select('id, name, email, phone, role, company, status')
            .eq('user_id', user.id)
            .eq('status', 'active')
            .order('name', { ascending: true }),
          supabaseClient
            .from('project_contractors')
            .select('contractor_id')
            .eq('project_id', projectId)
        ]);

        if (collabResult.error) throw collabResult.error;

        const assignedIds = new Set((assignedResult.data || []).map(a => a.contractor_id));
        quickAssignNetworkCache = (collabResult.data || []).map(c => ({
          ...c,
          alreadyAssigned: assignedIds.has(c.id)
        }));

        renderQuickAssignList(quickAssignNetworkCache);

      } catch (err) {
        console.error('Error loading network:', err);
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Failed to load network</div>';
      }
    }

    function renderQuickAssignList(collaborators) {
      const listEl = document.getElementById('quick-assign-list');

      if (!collaborators || collaborators.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No collaborators in your network yet.<br><small>Add collaborators from the Collaborators page.</small></div>';
        return;
      }

      const roleColors = {
        contractor: '#3b82f6',
        fabricator: '#8b5cf6',
        installer: '#f59e0b',
        plumber: '#06b6d4',
        designer: '#ec4899',
        measurer: '#84cc16',
        vendor: '#14b8a6',
        other: '#6b7280'
      };

      listEl.innerHTML = collaborators.map(c => {
        const color = roleColors[c.role] || roleColors.other;
        const isSelected = selectedQuickAssignCollaborator === c.id;

        return '<div class="quick-assign-item' + (isSelected ? ' selected' : '') + '" data-id="' + c.id + '" onclick="' + (c.alreadyAssigned ? '' : 'selectQuickAssignCollaborator(\'' + c.id + '\')') + '" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: ' + (c.alreadyAssigned ? 'not-allowed' : 'pointer') + '; background: ' + (isSelected ? 'var(--gold-primary)11' : 'transparent') + '; ' + (c.alreadyAssigned ? 'opacity: 0.5;' : '') + ' transition: background 0.2s;">' +
          '<div style="width: 36px; height: 36px; border-radius: 50%; background: ' + color + '22; color: ' + color + '; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">' + (c.name || '?').charAt(0).toUpperCase() + '</div>' +
          '<div style="flex: 1; min-width: 0;">' +
            '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(c.name) + (c.alreadyAssigned ? ' <span style="font-size: 10px; color: var(--success); background: #22c55e22; padding: 2px 6px; border-radius: 4px;">Assigned</span>' : '') + '</div>' +
            '<div style="font-size: 12px; color: var(--text-secondary);">' + (c.company ? escapeHtml(c.company) + '  ' : '') + escapeHtml(c.email || 'No email') + '</div>' +
          '</div>' +
          '<span style="font-size: 11px; padding: 3px 8px; border-radius: 12px; background: ' + color + '22; color: ' + color + '; text-transform: uppercase;">' + (c.role || 'other') + '</span>' +
        '</div>';
      }).join('');
    }

    function filterQuickAssignList(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderQuickAssignList(quickAssignNetworkCache);
        return;
      }
      const filtered = quickAssignNetworkCache.filter(c =>
        (c.name && c.name.toLowerCase().includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q)) ||
        (c.role && c.role.toLowerCase().includes(q)) ||
        (c.company && c.company.toLowerCase().includes(q))
      );
      renderQuickAssignList(filtered);
    }

    function selectQuickAssignCollaborator(id) {
      selectedQuickAssignCollaborator = id;
      document.getElementById('quick-assign-btn').disabled = false;
      filterQuickAssignList(document.getElementById('quick-assign-search').value);
    }

    async function confirmQuickAssign() {
      const projectId = document.getElementById('quick-assign-project-id').value;
      const collaboratorId = selectedQuickAssignCollaborator;
      const role = document.querySelector('input[name="quick-assign-role"]:checked')?.value || 'contractor';

      if (!projectId || !collaboratorId) {
        showToast('Please select a collaborator', 'warning');
        return;
      }

      const btn = document.getElementById('quick-assign-btn');
      btn.disabled = true;
      btn.textContent = 'Assigning...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Insert into project_contractors
        const { error } = await supabaseClient
          .from('project_contractors')
          .insert({
            project_id: projectId,
            contractor_id: collaboratorId,
            user_id: user.id,
            role: role,
            status: 'assigned'
          });

        if (error) throw error;

        showToast('Team member assigned successfully', 'success');
        closeQuickAssignModal();

        // Reload project team if detail is open
        loadProjectTeam(projectId);

      } catch (err) {
        console.error('Error assigning collaborator:', err);
        showToast(err.message || 'Failed to assign team member', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Assign Selected';
      }
    }

    function closeQuickAssignModal() {
      const modal = document.getElementById('quick-assign-modal');
      if (modal) modal.classList.remove('active');
    }

    // Load project team members
    async function loadProjectTeam(projectId) {
      const listEl = document.getElementById('project-team-list');
      if (!listEl) return;

      try {
        const { data: contractors, error } = await supabaseClient
          .from('project_contractors')
          .select('id, role, status, contractor_id, general_collaborators(id, name, email, phone, role, company)')
          .eq('project_id', projectId);

        if (error) throw error;

        if (!contractors || contractors.length === 0) {
          listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">No team members assigned yet<br><small>Click "Assign" to add from your network</small></div>';
          return;
        }

        const roleColors = {
          contractor: '#3b82f6',
          fabricator: '#8b5cf6',
          installer: '#f59e0b',
          plumber: '#06b6d4',
          designer: '#ec4899',
          measurer: '#84cc16',
          other: '#6b7280'
        };

        listEl.innerHTML = contractors.map(pc => {
          const c = pc.general_collaborators;
          if (!c) return '';
          const color = roleColors[pc.role] || roleColors.other;

          return '<div style="display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--dark-border);">' +
            '<div style="width: 36px; height: 36px; border-radius: 50%; background: ' + color + '22; color: ' + color + '; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px;">' + (c.name || '?').charAt(0).toUpperCase() + '</div>' +
            '<div style="flex: 1; min-width: 0;">' +
              '<div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">' + escapeHtml(c.name || 'Unknown') + '</div>' +
              '<div style="font-size: 11px; color: var(--text-secondary);">' + (c.company ? escapeHtml(c.company) + '  ' : '') + (c.email || c.phone || '') + '</div>' +
            '</div>' +
            '<span style="font-size: 10px; padding: 3px 8px; border-radius: 10px; background: ' + color + '22; color: ' + color + '; text-transform: uppercase;">' + (pc.role || c.role || 'team') + '</span>' +
            '<button onclick="removeProjectTeamMember(\'' + pc.id + '\', \'' + projectId + '\')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;" title="Remove from team">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
            '</button>' +
          '</div>';
        }).join('');

      } catch (err) {
        console.error('Error loading project team:', err);
        listEl.innerHTML = '<div style="text-align: center; padding: 8px; color: var(--error); font-size: 12px;">Failed to load team</div>';
      }
    }

    async function removeProjectTeamMember(contractorRecordId, projectId) {
      if (!confirm('Remove this team member from the project?')) return;

      try {
        const { error } = await supabaseClient
          .from('project_contractors')
          .delete()
          .eq('id', contractorRecordId);

        if (error) throw error;

        showToast('Team member removed', 'success');
        loadProjectTeam(projectId);

      } catch (err) {
        console.error('Error removing team member:', err);
        showToast('Failed to remove team member', 'error');
      }
    }

    function editCurrentProject() {
      const project = allProjects.find(p => p.id === currentProjectId);
      if (project) {
        closeProjectDetail();
        openEditProjectModal(project);
      }
    }

    async function quickUpdateProjectStatus(id, status) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { error } = await supabaseClient
          .from('projects')
          .update({ status })
          .eq('id', id)
          .eq('user_id', user.id);

        if (error) throw error;

        showToast('Status updated to ' + (PROJECT_STATUS_LABELS[status] || status), 'success');
        await loadProjects();

        // Refresh detail if open
        if (currentProjectId === id) {
          openProjectDetail(id);
        }
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Error: ' + (err.message || 'Failed to update status'), 'error');
      }
    }

    async function deleteProject(projectId) {
      if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { error } = await supabaseClient
          .from('projects')
          .delete()
          .eq('id', projectId)
          .eq('user_id', user.id);

        if (error) throw error;

        closeProjectDetail();
        showToast('Project deleted', 'success');
        await loadProjects();
      } catch (err) {
        console.error('Error deleting project:', err);
        showToast('Error: ' + (err.message || 'Failed to delete project'), 'error');
      }
    }

    // =============================================
    // JOBS & PROJECT MANAGEMENT
    // =============================================

    let allJobs = [];
    let allCollaborators = [];
    // allCustomers already declared above
    let currentJobId = null;
    let jobFilter = 'all';
    let contractorFilter = 'all';

    async function loadJobs() {
      const jobsList = document.getElementById('jobs-list');
      if (!jobsList) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        jobsList.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        // Load from PROJECTS table (single source of truth)
        const { data: jobs, error } = await supabaseClient
          .from('projects')
          .select(`
            *,
            project_contractors (
              id, contractor_id, role, agreed_rate, status,
              contractors:contractor_id (id, name, email, phone)
            )
          `)
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allJobs = jobs || [];
        updateJobsCount();
        updateJobStats();
        renderJobs();
        renderKanbanBoard();
      } catch (err) {
        console.error('Load jobs error:', err);
        jobsList.innerHTML = `<div class="empty-state"><p>Error loading jobs: ${escapeHtml(err.message || 'Unknown error')}</p></div>`;
      }
    }

    function updateJobsCount() {
      const badge = document.getElementById('jobs-count');
      if (badge) {
        const activeJobs = allJobs.filter(j => !['completed', 'cancelled'].includes(j.status)).length;
        badge.textContent = activeJobs;
        badge.dataset.count = activeJobs;
      }
    }

    function filterJobs(status) {
      jobFilter = status;
      document.querySelectorAll('[data-job-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.jobStatus === status);
      });
      renderJobs();
      renderKanbanBoard();
    }

    let currentJobsView = 'list';

    function setJobsView(view) {
      currentJobsView = view;
      const listView = document.getElementById('jobs-list-view');
      const kanbanView = document.getElementById('jobs-kanban-view');
      const listBtn = document.getElementById('jobsListBtn');
      const kanbanBtn = document.getElementById('jobsKanbanBtn');

      if (view === 'list') {
        listView.style.display = 'block';
        kanbanView.style.display = 'none';
        listBtn.style.background = 'var(--gold-primary)';
        listBtn.style.color = 'var(--dark-primary)';
        kanbanBtn.style.background = 'transparent';
        kanbanBtn.style.color = 'var(--text-secondary)';
      } else {
        listView.style.display = 'none';
        kanbanView.style.display = 'block';
        kanbanBtn.style.background = 'var(--gold-primary)';
        kanbanBtn.style.color = 'var(--dark-primary)';
        listBtn.style.background = 'transparent';
        listBtn.style.color = 'var(--text-secondary)';
        renderKanbanBoard();
      }
    }

    function renderKanbanBoard() {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed'];

      // Map existing statuses to kanban columns
      const statusMapping = {
        'new': 'lead',
        'reviewing': 'lead',
        'lead': 'lead',
        'approved': 'approved',
        'assigned': 'approved',
        'scheduled': 'scheduled',
        'measured': 'scheduled',
        'material_ordered': 'in_progress',
        'material_received': 'in_progress',
        'in_production': 'in_progress',
        'ready': 'in_progress',
        'installing': 'in_progress',
        'completed': 'completed',
        'on_hold': 'lead',
        'cancelled': 'completed'
      };

      // Clear all columns
      statuses.forEach(status => {
        const container = document.getElementById(`kanban-cards-${status}`);
        if (container) container.innerHTML = '';
      });

      // Group jobs by kanban status
      const grouped = { lead: [], approved: [], scheduled: [], in_progress: [], completed: [] };

      allJobs.forEach(job => {
        const kanbanStatus = statusMapping[job.status] || 'lead';
        grouped[kanbanStatus].push(job);
      });

      // Render cards and update counts
      statuses.forEach(status => {
        const container = document.getElementById(`kanban-cards-${status}`);
        const countEl = document.getElementById(`kanban-count-${status}`);

        if (countEl) countEl.textContent = grouped[status].length;

        if (container) {
          if (grouped[status].length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">No jobs</div>';
          } else {
            container.innerHTML = grouped[status].map(job => `
              <div class="kanban-card" onclick="openJobDetail('${job.id}')" style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <span style="font-weight: 600; font-size: 13px;">#${job.job_number || job.id.slice(0,8)}</span>
                  <span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-muted);">${job.status?.replace('_', ' ') || 'new'}</span>
                </div>
                <div style="font-size: 14px; font-weight: 500; margin-bottom: 6px;">${job.customers?.name || job.customer_name || 'Unknown'}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${job.description || job.project_type || 'No description'}</div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                  <span style="font-size: 13px; font-weight: 600; color: var(--gold-primary);">$${(job.total || job.contract_amount || 0).toLocaleString()}</span>
                  <span style="font-size: 11px; color: var(--text-muted);">${job.created_at ? new Date(job.created_at).toLocaleDateString() : ''}</span>
                </div>
              </div>
            `).join('');
          }
        }
      });

      // Update job stats
      updateJobStats();
    }

    function updateJobStats() {
      const activeJobs = allJobs.filter(j => !['completed', 'cancelled'].includes(j.status)).length;
      const totalRevenue = allJobs.reduce((sum, j) => sum + (j.total || j.contract_amount || 0), 0);
      const totalCosts = allJobs.reduce((sum, j) => sum + (j.total_cost || 0), 0);
      const netProfit = totalRevenue - totalCosts;

      const statActive = document.getElementById('stat-active-jobs');
      const statRevenue = document.getElementById('stat-jobs-revenue');
      const statCosts = document.getElementById('stat-total-costs');
      const statProfit = document.getElementById('stat-net-profit');

      if (statActive) statActive.textContent = activeJobs;
      if (statRevenue) statRevenue.textContent = '$' + totalRevenue.toLocaleString();
      if (statCosts) statCosts.textContent = '$' + totalCosts.toLocaleString();
      if (statProfit) statProfit.textContent = '$' + netProfit.toLocaleString();
    }

    function renderJobs() {
      const jobsList = document.getElementById('jobs-list');
      if (!jobsList) return;

      let filtered = allJobs;
      if (jobFilter !== 'all') {
        filtered = filtered.filter(job => job.status === jobFilter);
      }

      if (filtered.length === 0) {
        jobsList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <h3>${jobFilter !== 'all' ? 'No ' + jobFilter.replace('_', ' ') + ' jobs' : 'No jobs yet'}</h3>
            <p>Jobs are created automatically when invoices are paid.</p>
          </div>`;
        return;
      }

      const statusColors = {
        new: '#f59e0b',
        reviewing: '#f59e0b',
        material_ordered: '#06b6d4',
        material_received: '#06b6d4',
        assigned: '#3b82f6',
        scheduled: '#3b82f6',
        measured: '#8b5cf6',
        in_production: '#8b5cf6',
        ready: '#10b981',
        installing: '#10b981',
        completed: '#22c55e',
        on_hold: '#6b7280',
        cancelled: '#ef4444'
      };

      // Modern card-based list for better mobile experience
      jobsList.innerHTML = `
        <div class="list-modern">
          ${filtered.map(job => `
            <div class="list-item-modern"
                 data-context-menu="job"
                 data-item-id="${job.id}"
                 data-item-data='${JSON.stringify({ job_number: job.job_number, status: job.status, customer_name: job.customers?.name }).replace(/'/g, "&#39;")}'
                 onclick="openJobDetail('${job.id}')">
              <div class="list-item-icon" style="background: ${statusColors[job.status] || '#6b7280'}15;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${statusColors[job.status] || '#6b7280'}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">${job.job_number || 'New Job'}  ${job.customers?.name || 'Unknown'}</div>
                <div class="list-item-subtitle">${job.description || 'No description'}</div>
              </div>
              <div class="list-item-meta">
                <div class="list-item-amount">$${(job.contract_amount || 0).toLocaleString()}</div>
                <span class="badge-modern badge-${job.status || 'new'}">${(job.status || 'new').replace('_', ' ')}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function openNewJobModal() {
      document.getElementById('new-job-modal').classList.add('active');
      document.getElementById('new-job-form').reset();
      document.getElementById('new-customer-fields').style.display = 'none';
      loadCustomersForSelect();
    }

    function closeNewJobModal() {
      document.getElementById('new-job-modal').classList.remove('active');
    }

    function toggleNewCustomerFields() {
      const select = document.getElementById('job-customer-select');
      const fields = document.getElementById('new-customer-fields');
      fields.style.display = select.value === 'new' ? 'block' : 'none';
    }

    async function loadCustomersForSelect() {
      const select = document.getElementById('job-customer-select');
      if (!select) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state, zip')
          .eq('user_id', user.id)
          .order('name');

        allCustomers = customers || [];

        // Keep first two options and rebuild
        select.innerHTML = `
          <option value="">-- Select Customer --</option>
          <option value="new">+ Add New Customer</option>
          ${(customers || []).map(c => `<option value="${c.id}">${c.name}${c.email ? ' (' + c.email + ')' : ''}</option>`).join('')}
        `;
      } catch (err) {
        console.error('Load customers error:', err);
      }
    }

    async function createJob(event) {
      event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        let customerId = document.getElementById('job-customer-select').value;
        let customerName = '';
        let customerEmail = '';
        let customerPhone = '';
        let customerAddress = '';

        // Create new customer if needed
        if (customerId === 'new') {
          customerName = document.getElementById('job-customer-name').value.trim();
          customerEmail = document.getElementById('job-customer-email').value.trim() || null;
          customerPhone = document.getElementById('job-customer-phone').value.trim() || null;
          const addr = document.getElementById('job-customer-address').value.trim() || '';
          const city = document.getElementById('job-customer-city').value.trim() || '';
          const state = document.getElementById('job-customer-state').value.trim() || '';
          const zip = document.getElementById('job-customer-zip').value.trim() || '';
          customerAddress = [addr, city, state, zip].filter(Boolean).join(', ');

          if (!customerName) throw new Error('Customer name is required');

          const customerData = {
            user_id: user.id,
            name: customerName,
            email: customerEmail,
            phone: customerPhone,
            address: addr || null,
            city: city || null,
            state: state || null,
            zip: zip || null
          };

          const { data: newCustomer, error: custError } = await supabaseClient
            .from('customers')
            .insert([customerData])
            .select()
            .single();

          if (custError) throw custError;
          customerId = newCustomer.id;
        } else {
          // Get existing customer info
          const customer = allCustomers.find(c => c.id === customerId);
          if (customer) {
            customerName = customer.name || '';
            customerEmail = customer.email || '';
            customerPhone = customer.phone || '';
            customerAddress = [customer.address, customer.city, customer.state, customer.zip].filter(Boolean).join(', ');
          }
        }

        if (!customerId) throw new Error('Please select or create a customer');
        if (!customerName) throw new Error('Customer name is required');

        // Get next job number (fallback if RPC not available)
        let jobNumber = null;
        try {
          const { data } = await supabaseClient.rpc('get_next_job_number', { p_user_id: user.id });
          jobNumber = data;
        } catch { /* RPC may not exist yet */ }

        const scheduledDate = document.getElementById('job-scheduled-date').value || null;
        const depositAmount = parseFloat(document.getElementById('job-deposit').value) || 0;

        const jobData = {
          user_id: user.id,
          customer_id: customerId,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          customer_address: customerAddress,
          job_number: jobNumber || `JOB-${Date.now()}`,
          description: document.getElementById('job-title').value.trim(),
          project_type: document.getElementById('job-type').value,
          contract_amount: parseFloat(document.getElementById('job-total').value) || 0,
          deposit_amount: depositAmount,
          deposit_paid: depositAmount > 0,
          internal_notes: document.getElementById('job-notes').value.trim() || null,
          estimated_start_date: scheduledDate,
          status: scheduledDate ? 'scheduled' : 'new'
        };

        const { error } = await supabaseClient.from('projects').insert([jobData]);
        if (error) throw error;

        closeNewJobModal();
        showToast('Job created successfully!');
        loadJobs();
      } catch (err) {
        console.error('Create job error:', err);
        alert('Error creating job: ' + err.message);
      }
    }

    async function openJobDetail(jobId) {
      currentJobId = jobId;
      const modal = document.getElementById('job-detail-modal');
      modal.classList.add('active');

      // Find job in allJobs
      const job = allJobs.find(j => j.id === jobId);
      if (!job) {
        alert('Job not found');
        return;
      }

      // Populate job details
      document.getElementById('job-detail-number').textContent = job.job_number || 'N/A';
      document.getElementById('job-detail-status').value = job.status || 'new';
      document.getElementById('job-detail-type').textContent = (job.project_type || 'N/A').replace('_', ' ');
      document.getElementById('job-detail-priority').textContent = job.description || '-';
      document.getElementById('job-detail-total').textContent = '$' + (job.contract_amount || 0).toFixed(2);
      document.getElementById('job-detail-balance').textContent = '$' + ((job.contract_amount || 0) - (job.total_paid || 0)).toFixed(2);
      document.getElementById('job-detail-notes').textContent = job.internal_notes || '-';

      // Customer info - use relation if available, otherwise use denormalized fields
      const customerName = job.customers?.name || job.customer_name || 'Unknown';
      const customerEmail = job.customers?.email || job.customer_email || '';
      const customerPhone = job.customers?.phone || job.customer_phone || '';
      const customerAddr = job.customers
        ? [job.customers.address, job.customers.city, job.customers.state, job.customers.zip].filter(Boolean).join(', ')
        : job.customer_address || '';
      document.getElementById('job-customer-name-display').textContent = customerName;
      document.getElementById('job-customer-email-display').textContent = customerEmail;
      document.getElementById('job-customer-phone-display').textContent = customerPhone;
      document.getElementById('job-customer-address-display').textContent = customerAddr;

      // Assigned collaborators
      const collaboratorsList = document.getElementById('job-collaborators-list');
      if (job.project_contractors && job.project_contractors.length > 0) {
        collaboratorsList.innerHTML = job.project_contractors.map(jc => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 8px;">
            <div style="flex: 1; cursor: pointer;" onclick="openContractorProfile('${jc.contractor_id}')">
              <div style="font-weight: 500;">${jc.collaborators?.name || 'Unknown'}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${jc.role || jc.collaborators?.type || ''} - $${(jc.amount_quoted || 0).toFixed(2)}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button class="action-btn" onclick="sendContractorPortalLink('${jc.contractor_id}')" title="Send Portal Link" style="padding: 4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
              </button>
              <button class="action-btn" onclick="inviteJobContractorAsCollaborator('${jc.contractor_id}')" title="Invite as Collaborator" style="padding: 4px; color: var(--gold-primary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
              </button>
              <span class="status-badge" style="font-size: 10px; background: ${jc.contractor_status === 'accepted' ? 'rgba(34,197,94,0.15)' : jc.contractor_status === 'declined' ? 'rgba(239,68,68,0.15)' : 'rgba(245,158,11,0.15)'}; color: ${jc.contractor_status === 'accepted' ? '#22c55e' : jc.contractor_status === 'declined' ? '#ef4444' : '#f59e0b'};">${jc.contractor_status || 'pending'}</span>
            </div>
          </div>
        `).join('');
      } else {
        collaboratorsList.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No collaborators assigned yet.</div>';
      }

      // Populate schedule fields
      const fieldMeasureInput = document.getElementById('job-field-measure-date');
      const installDateInput = document.getElementById('job-install-date');

      if (fieldMeasureInput) {
        fieldMeasureInput.value = job.field_measure_date ? job.field_measure_date.slice(0, 16) : '';
      }
      if (installDateInput) {
        installDateInput.value = job.install_date ? job.install_date.slice(0, 16) : '';
      }

      // Load files
      loadJobFiles(jobId);

      // Load timeline
      loadJobTimeline(jobId);
    }

    function closeJobDetailModal() {
      document.getElementById('job-detail-modal').classList.remove('active');
      currentJobId = null;
    }

    async function updateJobStatus() {
      if (!currentJobId) return;

      const newStatus = document.getElementById('job-detail-status').value;

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', currentJobId);

        if (error) throw error;

        showToast('Status updated');
        loadJobs();
        // Refresh calendar if it's been loaded
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update status error:', err);
        alert('Error updating status: ' + err.message);
      }
    }

    // Update job status by ID (for context menu)
    async function updateJobStatusById(jobId, newStatus) {
      if (!jobId || !newStatus) return;

      try {
        // Get job details first for notification
        const { data: job } = await supabaseClient
          .from('projects')
          .select('*')
          .eq('id', jobId)
          .single();

        const { error } = await supabaseClient
          .from('projects')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', jobId);

        if (error) throw error;

        // Send status update notification (email + SMS)
        if (job && (job.customer_email || job.customer_phone)) {
          sendNotification('job', 'status_change', job, {
            email: job.customer_email,
            phone: job.customer_phone,
            name: job.customer_name
          }, newStatus);
        }

        showToast(`Job status updated to ${newStatus.replace('_', ' ')}`);
        loadJobs();
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update job status error:', err);
        showToast('Error updating status: ' + err.message, 'error');
      }
    }

    // Archive a job
    async function archiveJob(jobId) {
      if (!jobId) return;

      if (!confirm('Archive this job? It will be moved to archived status.')) return;

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', jobId);

        if (error) throw error;

        showToast('Job archived');
        loadJobs();
      } catch (err) {
        console.error('Archive job error:', err);
        showToast('Error archiving job: ' + err.message, 'error');
      }
    }

    // Delete a job
    async function deleteJob(jobId) {
      if (!jobId) return;

      if (!confirm('Delete this job? This action cannot be undone.')) return;

      try {
        // First delete related records
        await supabaseClient.from('project_contractors').delete().eq('project_id', jobId);
        await supabaseClient.from('project_files').delete().eq('project_id', jobId);
        await supabaseClient.from('project_activity').delete().eq('project_id', jobId);

        // Then delete the job
        const { error } = await supabaseClient
          .from('projects')
          .delete()
          .eq('id', jobId);

        if (error) throw error;

        showToast('Job deleted');
        loadJobs();
        closeJobDetailModal();
      } catch (err) {
        console.error('Delete job error:', err);
        showToast('Error deleting job: ' + err.message, 'error');
      }
    }

    async function updateJobSchedule(field) {
      if (!currentJobId) return;

      const fieldMeasureInput = document.getElementById('job-field-measure-date');
      const installDateInput = document.getElementById('job-install-date');

      const updateData = {
        updated_at: new Date().toISOString()
      };

      if (field === 'field_measure_date' && fieldMeasureInput) {
        updateData.field_measure_date = fieldMeasureInput.value ? new Date(fieldMeasureInput.value).toISOString() : null;
      }

      if (field === 'install_date' && installDateInput) {
        updateData.install_date = installDateInput.value ? new Date(installDateInput.value).toISOString() : null;
      }

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update(updateData)
          .eq('id', currentJobId);

        if (error) throw error;

        showToast('Schedule updated');
        loadJobs();
        // Refresh calendar to show the new event
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update schedule error:', err);
        alert('Error updating schedule: ' + err.message);
      }
    }

    async function loadJobFiles(jobId) {
      const container = document.getElementById('job-files-list');
      if (!container) return;

      try {
        const { data: files, error } = await supabaseClient
          .from('project_files')
          .select('*')
          .eq('project_id', jobId)
          .order('uploaded_at', { ascending: false });

        if (error) throw error;

        if (!files || files.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No files uploaded yet.<br>
              <span style="font-size: 12px;">Drop files here or click Upload</span>
            </div>`;
          return;
        }

        container.innerHTML = files.map(file => `
          <div style="display: flex; align-items: center; gap: 12px; padding: 8px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 8px;">
            <div style="width: 40px; height: 40px; background: var(--dark-surface); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
              ${file.file_type?.includes('image') ? `<img src="${file.file_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">` :
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.file_name || 'File'}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${file.category || 'Document'} - ${new Date(file.created_at).toLocaleDateString()}</div>
            </div>
            <a href="${file.file_url}" target="_blank" class="action-btn" title="Download">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            </a>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load files error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Error loading files</div>';
      }
    }

    async function uploadJobFiles(event) {
      if (!currentJobId) return;

      const files = event.target.files;
      if (!files || files.length === 0) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        showToast('Uploading files...', 'info');

        for (const file of files) {
          const fileExt = file.name.split('.').pop();
          const fileName = `jobs/${currentJobId}/${Date.now()}-${file.name}`;

          // Upload to storage
          const { data, error: uploadError } = await supabaseClient.storage
            .from('lead-images')
            .upload(fileName, file);

          if (uploadError) throw uploadError;

          // Get public URL
          const { data: urlData } = supabaseClient.storage
            .from('lead-images')
            .getPublicUrl(fileName);

          // Save file record
          const { error: dbError } = await supabaseClient
            .from('project_files')
            .insert([{
              project_id: currentJobId,
              user_id: user.id,
              file_name: file.name,
              file_url: urlData.publicUrl,
              file_type: file.type,
              file_size: file.size,
              category: file.type.includes('image') ? 'photo' : 'document'
            }]);

          if (dbError) throw dbError;
        }

        showToast('Files uploaded successfully!');
        loadJobFiles(currentJobId);
        event.target.value = '';
      } catch (err) {
        console.error('Upload error:', err);
        alert('Error uploading files: ' + err.message);
      }
    }

    async function loadJobTimeline(jobId) {
      const container = document.getElementById('job-timeline');
      if (!container) return;

      try {
        const { data: history, error } = await supabaseClient
          .from('project_status_history')
          .select('*')
          .eq('project_id', jobId)
          .order('changed_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        if (!history || history.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No activity yet.</div>';
          return;
        }

        container.innerHTML = history.map(h => `
          <div style="display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
            <div style="width: 8px; height: 8px; background: var(--gold-primary); border-radius: 50%; margin-top: 6px;"></div>
            <div>
              <div style="font-size: 13px;">Status changed from <strong>${h.from_status || 'new'}</strong> to <strong>${h.to_status}</strong></div>
              <div style="font-size: 11px; color: var(--text-muted);">${new Date(h.changed_at).toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load timeline error:', err);
      }
    }

    async function sendCustomerPortalLink() {
      if (!currentJobId) return;

      const job = allJobs.find(j => j.id === currentJobId);
      if (!job || !job.customer_id) {
        alert('No customer associated with this job');
        return;
      }

      try {
        // Get or create customer portal token
        const { data: customer, error: fetchError } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, portal_token')
          .eq('id', job.customer_id)
          .single();

        if (fetchError) throw fetchError;
        if (!customer) throw new Error('Customer not found');

        let token = customer.portal_token;
        if (!token) {
          // Generate new token
          token = btoa(customer.id + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);

          const { error: updateError } = await supabaseClient
            .from('customers')
            .update({ portal_token: token })
            .eq('id', customer.id);

          if (updateError) throw updateError;
        }

        const portalUrl = `${window.location.origin}/customer-portal/?token=${token}`;

        // Show options modal
        const action = prompt(
          `Customer Portal Link for ${customer.name}:\n\n${portalUrl}\n\nOptions:\n1. Copy link (type "copy")\n2. Email link (type "email")\n3. Text link (type "text")\n4. Invite as collaborator (type "collab")`,
          'copy'
        );

        if (action === 'copy') {
          navigator.clipboard.writeText(portalUrl);
          showToast('Portal link copied to clipboard!');
        } else if (action === 'email' && customer.email) {
          try {
            await apiCall('/api/customers/send-portal-link', {
              method: 'POST',
              body: JSON.stringify({
                customer_id: customer.id,
                email: customer.email,
                portal_link: portalUrl,
                job_number: job.job_number
              })
            });
            showToast('Portal link sent via email!');
          } catch (err) {
            navigator.clipboard.writeText(portalUrl);
            showToast('Could not send email. Link copied instead.');
          }
        } else if (action === 'text' && customer.phone) {
          const message = encodeURIComponent(`Track your project with Surprise Granite: ${portalUrl}`);
          window.open(`sms:${customer.phone}?body=${message}`, '_blank');
        } else if (action === 'collab') {
          inviteCustomerAsCollaborator();
        } else if (action) {
          navigator.clipboard.writeText(portalUrl);
          showToast('Link copied to clipboard!');
        }

      } catch (err) {
        console.error('Send portal link error:', err);
        alert('Error generating portal link: ' + err.message);
      }
    }

    async function sendContractorPortalLink(contractorId) {
      try {
        // Get or create contractor portal token
        const { data: contractor, error: fetchError } = await supabaseClient
          .from('collaborators')
          .select('id, name, company_name, email, phone, invite_token')
          .eq('id', contractorId)
          .single();

        if (fetchError) throw fetchError;
        if (!contractor) throw new Error('Contractor not found');

        let token = contractor.invite_token;
        if (!token) {
          token = btoa(contractor.id + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);

          const { error: updateError } = await supabaseClient
            .from('collaborators')
            .update({ invite_token: token })
            .eq('id', contractor.id);

          if (updateError) throw updateError;
        }

        const portalUrl = `${window.location.origin}/contractor-portal/?token=${token}`;

        const action = prompt(
          `Contractor Portal Link for ${contractor.company_name || contractor.name}:\n\n${portalUrl}\n\nOptions:\n1. Copy link (type "copy")\n2. Email link (type "email")\n3. Text link (type "text")\n4. Invite as collaborator (type "collab")`,
          'copy'
        );

        if (action === 'copy') {
          navigator.clipboard.writeText(portalUrl);
          showToast('Portal link copied!');
        } else if (action === 'email' && contractor.email) {
          try {
            await apiCall('/api/collaborators/send-invite', {
              method: 'POST',
              body: JSON.stringify({
                contractor_id: contractor.id,
                email: contractor.email,
                invite_link: portalUrl
              })
            });
            showToast('Portal link sent via email!');
          } catch (err) {
            navigator.clipboard.writeText(portalUrl);
            showToast('Could not send email. Link copied instead.');
          }
        } else if (action === 'text' && contractor.phone) {
          const message = encodeURIComponent(`Access your contractor portal at Surprise Granite: ${portalUrl}`);
          window.open(`sms:${contractor.phone}?body=${message}`, '_blank');
        } else if (action === 'collab') {
          inviteContractorAsCollaborator(contractorId);
        } else if (action) {
          navigator.clipboard.writeText(portalUrl);
          showToast('Link copied!');
        }

      } catch (err) {
        console.error('Send contractor portal link error:', err);
        alert('Error generating portal link: ' + err.message);
      }
    }

    // =============================================
    // COLLABORATION INVITATIONS
    // =============================================

    async function checkForInviteToken() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('accept_invite');
      if (!token) return;

      // Clean URL
      const cleanUrl = new URL(window.location);
      cleanUrl.searchParams.delete('accept_invite');
      history.replaceState(null, '', cleanUrl.toString());

      // Show modal
      document.getElementById('accept-invite-modal').classList.add('active');
      const body = document.getElementById('accept-invite-body');

      try {
        const verifyResp = await fetch(API_BASE + '/api/collaboration/invite/verify/' + encodeURIComponent(token));
        const verifyData = await verifyResp.json();

        if (!verifyResp.ok || !verifyData.success) {
          body.innerHTML =
            '<div style="text-align: center; padding: 20px 0;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="var(--error)" stroke-width="1.5" style="margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' +
              '<h3 style="margin-bottom: 8px; color: var(--error);">Invitation Invalid or Expired</h3>' +
              '<p style="color: var(--text-muted); font-size: 14px;">' + escapeHtml(verifyData.error || 'This invitation link is no longer valid.') + '</p>' +
              '<button class="btn-modern secondary" onclick="closeAcceptInviteModal()" style="margin-top: 16px;">Close</button>' +
            '</div>';
          return;
        }

        const inv = verifyData.invitation;
        const roleLabel = inv.role.charAt(0).toUpperCase() + inv.role.slice(1);
        const accessLabel = (inv.access_level || 'read').charAt(0).toUpperCase() + (inv.access_level || 'read').slice(1);

        body.innerHTML =
          '<div style="text-align: center; padding: 12px 0;">' +
            '<div style="width: 64px; height: 64px; background: rgba(249, 203, 0, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 28px;">&#x1F91D;</div>' +
            '<h3 style="margin-bottom: 4px;">You\'re invited to collaborate</h3>' +
            '<p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">on <strong style="color: var(--text-primary);">"' + escapeHtmlAttr(inv.projectTitle || 'Untitled Project') + '"</strong></p>' +
          '</div>' +
          '<div style="background: var(--dark-surface); border-radius: 10px; padding: 16px; margin-bottom: 20px;">' +
            '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
              '<span style="color: var(--text-muted); font-size: 13px;">Role</span>' +
              '<span style="font-weight: 600; font-size: 13px;">' + roleLabel + '</span>' +
            '</div>' +
            '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
              '<span style="color: var(--text-muted); font-size: 13px;">Access</span>' +
              '<span style="font-weight: 600; font-size: 13px;">' + accessLabel + '</span>' +
            '</div>' +
            '<div style="display: flex; justify-content: space-between;">' +
              '<span style="color: var(--text-muted); font-size: 13px;">Invited by</span>' +
              '<span style="font-weight: 600; font-size: 13px;">' + escapeHtmlAttr(inv.inviterName || 'Unknown') + '</span>' +
            '</div>' +
          '</div>' +
          '<div style="display: flex; gap: 12px;">' +
            '<button class="btn-modern secondary" onclick="closeAcceptInviteModal()" style="flex: 1;">Decline</button>' +
            '<button class="btn-modern primary" onclick="acceptInvitation(\'' + token + '\')" id="accept-invite-btn" style="flex: 1;">Accept Invitation</button>' +
          '</div>';

      } catch (err) {
        body.innerHTML =
          '<div style="text-align: center; padding: 20px 0;">' +
            '<p style="color: var(--error);">Failed to load invitation details. Please try again.</p>' +
            '<button class="btn-modern secondary" onclick="closeAcceptInviteModal()" style="margin-top: 16px;">Close</button>' +
          '</div>';
        console.error('Accept invite error:', err);
      }
    }

    async function acceptInvitation(token) {
      const btn = document.getElementById('accept-invite-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-top-color: var(--dark-primary);"></div>';
      }

      try {
        const resp = await apiCall('/api/collaboration/invite/accept', {
          method: 'POST',
          body: JSON.stringify({ token: token })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to accept invitation');

        const body = document.getElementById('accept-invite-body');
        body.innerHTML =
          '<div style="text-align: center; padding: 20px 0;">' +
            '<div style="width: 64px; height: 64px; background: rgba(16, 185, 129, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="var(--success)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' +
            '</div>' +
            '<h3 style="color: var(--success); margin-bottom: 8px;">Invitation Accepted!</h3>' +
            '<p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">You\'re now a collaborator on this project.</p>' +
            '<button class="btn-modern primary" onclick="closeAcceptInviteModal(); showPage(\'collaborations\');">View My Collaborations</button>' +
          '</div>';

        showToast('Invitation accepted successfully!');

      } catch (err) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Accept Invitation';
        }
        showToast(err.message || 'Failed to accept invitation');
      }
    }

    // Network (general collaborator) invite handling
    async function checkForNetworkInviteToken() {
      const params = new URLSearchParams(window.location.search);
      // Check URL parameter first, then stored token from signup
      let token = params.get('accept_network');
      let fromStorage = false;

      if (!token) {
        token = sessionStorage.getItem('sg_network_invite_token') || localStorage.getItem('sg_network_invite_token');
        fromStorage = true;
      }

      if (!token) return;

      // Clear stored token
      sessionStorage.removeItem('sg_network_invite_token');
      localStorage.removeItem('sg_network_invite_token');

      // Clean URL
      const cleanUrl = new URL(window.location);
      cleanUrl.searchParams.delete('accept_network');
      history.replaceState(null, '', cleanUrl.toString());

      try {
        // Verify the token first
        const verifyResp = await fetch(API_BASE + '/api/collaboration/network/verify/' + encodeURIComponent(token));
        const verifyData = await verifyResp.json();

        if (!verifyResp.ok || !verifyData.success) {
          showToast(verifyData.error || 'Invalid or expired invitation', 'error');
          return;
        }

        // Auto-accept the network invite
        const acceptResp = await apiCall('/api/collaboration/network/accept', {
          method: 'POST',
          body: JSON.stringify({ token })
        });

        const acceptData = await acceptResp.json();
        if (!acceptResp.ok) throw new Error(acceptData.error || 'Failed to accept');

        showToast(`You're now connected with ${verifyData.invitation.inviterName}!`, 'success');
        showPage('collaborators');
        switchCollabTab('network');

      } catch (err) {
        console.error('Network invite accept error:', err);
        showToast(err.message || 'Failed to accept network invitation', 'error');
      }
    }

    function closeAcceptInviteModal() {
      document.getElementById('accept-invite-modal').classList.remove('active');
    }

    function escapeHtmlAttr(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // ============ INVITE TO PROJECT ============

    function openInviteToProjectModal(projectId, prefillEmail, prefillRole) {
      document.getElementById('invite-collaborator-form').reset();
      document.getElementById('invite-project-id').value = projectId || '';

      // Show/hide project selector
      const projectSelector = document.getElementById('invite-project-selector');
      const projectSelect = document.getElementById('invite-project-select');
      if (projectId) {
        projectSelector.style.display = 'none';
        projectSelect.removeAttribute('required');
      } else {
        projectSelector.style.display = 'block';
        projectSelect.setAttribute('required', 'required');
        loadProjectsForInvite();
      }

      // Pre-fill email
      if (prefillEmail) {
        document.getElementById('invite-email').value = prefillEmail;
      }

      // Pre-fill role
      if (prefillRole) {
        const roleSelect = document.getElementById('invite-role');
        for (let i = 0; i < roleSelect.options.length; i++) {
          if (roleSelect.options[i].value === prefillRole) {
            roleSelect.selectedIndex = i;
            break;
          }
        }
      }

      document.getElementById('invite-to-project-modal').classList.add('active');
      if (projectId) loadPendingInvitations(projectId);
    }

    function onInviteProjectSelected() {
      const projectId = document.getElementById('invite-project-select').value;
      const inlineForm = document.getElementById('inline-create-project-form');
      if (projectId === '__create_new__') {
        document.getElementById('invite-project-id').value = '';
        if (inlineForm) inlineForm.style.display = '';
      } else {
        document.getElementById('invite-project-id').value = projectId;
        if (inlineForm) inlineForm.style.display = 'none';
        if (projectId) loadPendingInvitations(projectId);
      }
    }

    async function loadProjectsForInvite() {
      const select = document.getElementById('invite-project-select');
      select.innerHTML = '<option value="">Loading projects...</option>';

      try {
        const resp = await apiCall('/api/collaboration/my-projects');
        const data = await resp.json();
        let projects = [];

        if (resp.ok && data.collaborations) {
          projects = data.collaborations.filter(function(c) {
            return c.access_level === 'admin' || c.access_level === 'write';
          });
        }

        // Also try to load owned projects from Supabase
        if (supabaseClient && currentUser) {
          try {
            const result = await supabaseClient.from('projects').select('id, name').eq('user_id', currentUser.id).order('created_at', { ascending: false }).limit(50);
            if (result.data) {
              const existingIds = projects.map(function(p) { return p.project_id; });
              result.data.forEach(function(proj) {
                if (existingIds.indexOf(proj.id) === -1) {
                  projects.push({ project_id: proj.id, project: { name: proj.name } });
                }
              });
            }
          } catch (e) { /* projects table may not exist */ }
        }

        // Also add jobs as invitable contexts
        if (allJobs && allJobs.length > 0) {
          allJobs.forEach(function(job) {
            projects.push({ project_id: job.id, project: { title: (job.job_number ? '#' + job.job_number + ' - ' : '') + (job.customer_name || job.title || 'Job') }, isJob: true });
          });
        }

        select.innerHTML = '<option value="">Select a Project</option>';
        if (projects.length === 0) {
          select.innerHTML += '<option value="" disabled>No projects available</option>';
        } else {
          projects.forEach(function(p) {
            const title = (p.project && (p.project.name || p.project.title)) || 'Untitled Project';
            const opt = document.createElement('option');
            opt.value = p.project_id;
            opt.textContent = title;
            select.appendChild(opt);
          });
        }
        // Add "Create New Project" option
        const createOpt = document.createElement('option');
        createOpt.value = '__create_new__';
        createOpt.textContent = '+ Create New Project';
        createOpt.style.fontWeight = '600';
        select.appendChild(createOpt);
      } catch (err) {
        console.error('Error loading projects for invite:', err);
        select.innerHTML = '<option value="">Could not load projects</option>';
      }
    }

    function cancelInlineProjectCreate() {
      const inlineForm = document.getElementById('inline-create-project-form');
      if (inlineForm) inlineForm.style.display = 'none';
      const select = document.getElementById('invite-project-select');
      if (select) select.value = '';
      document.getElementById('invite-project-id').value = '';
    }

    async function submitInlineProjectCreate() {
      const nameInput = document.getElementById('inline-project-name');
      const customerInput = document.getElementById('inline-project-customer');
      const descInput = document.getElementById('inline-project-description');
      const btn = document.getElementById('inline-create-project-btn');

      const name = (nameInput.value || '').trim();
      const customerName = (customerInput.value || '').trim();
      const description = (descInput.value || '').trim();

      if (!name) { nameInput.focus(); showToast('Project name is required', 'warning'); return; }
      if (!customerName) { customerInput.focus(); showToast('Customer name is required', 'warning'); return; }

      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const userData = await supabaseClient.auth.getUser();
        const user = userData.data && userData.data.user;
        if (!user) throw new Error('Not authenticated');

        const result = await supabaseClient.from('projects').insert({
          name: name,
          customer_name: customerName,
          description: description || null,
          user_id: user.id,
          status: 'lead',
          priority: 'medium'
        }).select().single();

        if (result.error) throw result.error;

        const project = result.data;
        console.log('[InlineCreate] Project created:', project.id, project.name);

        // Add new option to select and auto-select it
        const select = document.getElementById('invite-project-select');
        const opt = document.createElement('option');
        opt.value = project.id;
        opt.textContent = name;
        // Insert before the last option (Create New Project)
        const lastOpt = select.querySelector('option[value="__create_new__"]');
        if (lastOpt) {
          select.insertBefore(opt, lastOpt);
        } else {
          select.appendChild(opt);
        }
        select.value = project.id;
        document.getElementById('invite-project-id').value = project.id;

        // Hide inline form and clear inputs
        document.getElementById('inline-create-project-form').style.display = 'none';
        nameInput.value = '';
        customerInput.value = '';
        descInput.value = '';

        showToast('Project created and selected', 'success');

        // Refresh projects list if on that page
        if (typeof allProjects !== 'undefined') {
          allProjects.push(project);
          updateProjectsCount();
        }
      } catch (err) {
        console.error('Error creating inline project:', err);
        showToast('Error: ' + (err.message || 'Failed to create project'), 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create & Select';
      }
    }

    function closeInviteToProjectModal() {
      document.getElementById('invite-to-project-modal').classList.remove('active');
      // Also hide inline form when modal closes
      const inlineForm = document.getElementById('inline-create-project-form');
      if (inlineForm) inlineForm.style.display = 'none';
    }

    async function sendCollaborationInvite(event) {
      event.preventDefault();
      const btn = document.getElementById('send-project-invite-btn');
      const projectId = document.getElementById('invite-project-id').value || document.getElementById('invite-project-select').value;
      const email = document.getElementById('invite-email').value.trim().toLowerCase();
      const role = document.getElementById('invite-role').value;
      const accessLevel = document.getElementById('invite-access-level').value;
      const notes = document.getElementById('invite-notes').value.trim();

      if (!projectId || projectId === '__create_new__') {
        showToast('Please select a project first', 'warning');
        return false;
      }
      if (!email || !role) {
        showToast('Please fill in email and role', 'warning');
        return false;
      }

      // Client-side self-invite check
      if (currentUser && currentUser.email && email === currentUser.email.toLowerCase()) {
        showToast('You cannot invite yourself as a collaborator', 'warning');
        return false;
      }

      console.log('[Invite] Sending:', { projectId, email, role, accessLevel, notes: notes || '(none)' });

      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/invite', {
          method: 'POST',
          body: JSON.stringify({ email: email, role: role, access_level: accessLevel, notes: notes || undefined })
        });

        let data;
        try {
          data = await resp.json();
        } catch (parseErr) {
          console.error('[Invite] Failed to parse response:', parseErr);
          throw new Error('Server returned an invalid response (status ' + resp.status + ')');
        }

        console.log('[Invite] Response:', resp.status, data);
        if (!resp.ok) {
          let errMsg = data.error || 'Failed to send invitation';
          if (data.details && Array.isArray(data.details)) {
            errMsg += ': ' + data.details.map(function(d) { return d.message || d.field; }).join(', ');
          }
          throw new Error(errMsg);
        }

        showToast(data.message || 'Invitation sent successfully!', 'success');
        document.getElementById('invite-collaborator-form').reset();
        closeInviteToProjectModal();

        // Log activity
        logProjectActivity(projectId, 'collaborator_invited', 'Invited ' + email + ' as ' + role);

        // Bridge 6: Show role-specific guidance about what happens next
        var roleGuidance = {
          fabricator: 'They\'ll be guided to set up a vendor profile to list inventory and receive handoffs.',
          designer: 'They\'ll get access to design tools and can collaborate on project layouts.',
          contractor: 'They\'ll be able to view project details and get assigned to installation handoffs.',
          installer: 'They\'ll receive installation scheduling notifications for this project.',
          viewer: 'They\'ll be able to view project progress and updates.'
        };
        var guidance = roleGuidance[role];
        if (guidance) {
          setTimeout(function() { showToast(guidance, 'info'); }, 2000);
        }

      } catch (err) {
        console.error('[Invite] Error:', err);
        showToast(err.message || 'Error sending invitation', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> Send Invitation';
      }

      return false;
    }

    async function loadPendingInvitations(projectId) {
      const section = document.getElementById('pending-invitations-section');
      const list = document.getElementById('pending-invitations-list');

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/pending-invitations');
        const data = await resp.json();

        if (!resp.ok || !data.invitations || !data.invitations.length) {
          section.style.display = 'none';
          return;
        }

        const pending = data.invitations.filter(function(i) { return i.status === 'pending'; });
        if (!pending.length) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        list.innerHTML = pending.map(function(inv) {
          return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--dark-surface); border-radius: 8px; margin-bottom: 8px;">' +
            '<div>' +
              '<div style="font-size: 13px; font-weight: 500;">' + escapeHtmlAttr(inv.email) + '</div>' +
              '<div style="font-size: 11px; color: var(--text-muted);">' + escapeHtmlAttr(inv.role) + ' &middot; ' + escapeHtmlAttr(inv.access_level) + '</div>' +
            '</div>' +
            '<button class="btn-modern secondary" onclick="cancelPendingInvitation(\'' + projectId + '\', \'' + inv.id + '\')" title="Cancel" style="padding: 6px 10px; min-width: auto;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
            '</button>' +
          '</div>';
        }).join('');

      } catch (err) {
        console.error('Error loading pending invitations:', err);
        section.style.display = 'none';
      }
    }

    async function cancelPendingInvitation(projectId, invitationId) {
      if (!confirm('Cancel this invitation?')) return;

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/pending-invitations/' + invitationId, {
          method: 'DELETE'
        });

        if (resp.ok) {
          showToast('Invitation cancelled');
          loadPendingInvitations(projectId);
        } else {
          showToast('Failed to cancel invitation');
        }
      } catch (err) {
        showToast('Error cancelling invitation');
      }
    }

    // ============ MY COLLABORATIONS ============

    async function loadCollaborations() {
      const container = document.getElementById('collaborations-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const resp = await apiCall('/api/collaboration/my-projects?status=accepted');
        const data = await resp.json();

        if (!resp.ok) {
          if (resp.status === 403) {
            container.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><h3>No collaborations yet</h3><p>When you\'re invited to collaborate on projects, they\'ll appear here.</p></div>';
            return;
          }
          throw new Error(data.error || 'Failed to load');
        }

        const collabs = data.collaborations || [];

        // Update badge
        const badge = document.getElementById('collaborations-count');
        if (badge) {
          badge.textContent = collabs.length;
          badge.dataset.count = collabs.length;
          badge.style.display = collabs.length > 0 ? 'inline-flex' : 'none';
        }

        if (!collabs.length) {
          container.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><h3>No collaborations yet</h3><p>When you\'re invited to collaborate on projects, they\'ll appear here.</p></div>';
          return;
        }

        container.innerHTML = collabs.map(function(c) {
          const roleLabel = (c.role || 'viewer').charAt(0).toUpperCase() + (c.role || 'viewer').slice(1);
          const accessLabel = (c.access_level || 'read').charAt(0).toUpperCase() + (c.access_level || 'read').slice(1);
          const projectTitle = (c.project && (c.project.name || c.project.title)) || 'Untitled Project';
          const customerName = (c.project && c.project.customer_name) || '';
          const dateStr = c.accepted_at ? new Date(c.accepted_at).toLocaleDateString() : '';
          const pId = c.project_id || '';
          const showHandoff = (c.role === 'designer' || c.role === 'fabricator');
          const isViewer = (c.role === 'viewer');
          const projStatus = (c.project && c.project.status) || '';
          const projStatusLabel = PROJECT_STATUS_LABELS[projStatus] || projStatus;
          const projStatusColor = PROJECT_STATUS_COLORS[projStatus] || '#6b7280';

          return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; gap: 12px;">' +
            '<div style="flex: 1; min-width: 0;">' +
              '<div style="font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + escapeHtmlAttr(projectTitle) + '</div>' +
              '<div style="display: flex; gap: 12px; margin-top: 6px; flex-wrap: wrap;">' +
                '<span style="font-size: 12px; padding: 2px 8px; background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); border-radius: 4px; font-weight: 500;">' + roleLabel + '</span>' +
                '<span style="font-size: 12px; padding: 2px 8px; background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border-radius: 4px;">' + accessLabel + ' access</span>' +
                (projStatus ? '<span style="font-size: 12px; padding: 2px 8px; background: ' + projStatusColor + '15; color: ' + projStatusColor + '; border-radius: 4px; font-weight: 500;">' + projStatusLabel + '</span>' : '') +
                (dateStr ? '<span style="font-size: 12px; color: var(--text-muted);">Joined ' + dateStr + '</span>' : '') +
              '</div>' +
              (customerName ? '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Customer: ' + escapeHtmlAttr(customerName) + '</div>' : '') +
            '</div>' +
            '<div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">' +
              (pId ? '<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="' + (isViewer ? 'openCustomerProjectView(\'' + pId + '\')' : 'viewCollaborationProject(\'' + pId + '\')') + '">View Project</button>' : '') +
              (showHandoff && pId ? '<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px; color: #22c55e;" onclick="openStartHandoffModal(null, \'\', \'' + pId + '\')">Start Handoff</button>' : '') +
            '</div>' +
          '</div>';
        }).join('');

      } catch (err) {
        console.error('Error loading collaborations:', err);
        container.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load collaborations.</p></div>';
      }
    }

    // =============================================
    // MY NETWORK (GENERAL COLLABORATORS)
    // =============================================

    // Track event participants being added
    let eventParticipants = [];
    let networkCollaboratorsCache = [];
    let selectedPickerParticipants = new Set();

    // =============================================
    // ENHANCED PARTICIPANT MANAGEMENT (Group Events)
    // =============================================

    function renderEventParticipantChips() {
      const container = document.getElementById('event-participants-chips');
      const noMsg = document.getElementById('no-participants-msg');
      const countEl = document.getElementById('participant-count');

      if (!container) return;

      if (eventParticipants.length === 0) {
        container.innerHTML = '<span style="color: var(--text-muted); font-size: 12px; padding: 4px 0;" id="no-participants-msg">No participants added</span>';
        if (countEl) countEl.textContent = '0 added';
        return;
      }

      const roleColors = {
        customer: '#10b981',
        contractor: '#3b82f6',
        fabricator: '#8b5cf6',
        installer: '#f59e0b',
        plumber: '#06b6d4',
        designer: '#ec4899',
        other: '#6b7280'
      };

      container.innerHTML = eventParticipants.map((p, i) => {
        const color = roleColors[p.role] || roleColors.other;
        return '<div class="participant-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px 4px 12px; background: ' + color + '22; border: 1px solid ' + color + '44; border-radius: 16px; font-size: 12px;">' +
          '<span style="color: var(--text-primary); font-weight: 500;">' + escapeHtml(p.name || p.email) + '</span>' +
          '<span style="color: ' + color + '; font-size: 10px; text-transform: uppercase;">' + p.role + '</span>' +
          '<button type="button" onclick="removeEventParticipantChip(' + i + ')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px; line-height: 0;" title="Remove">' +
            '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
          '</button>' +
        '</div>';
      }).join('');

      if (countEl) countEl.textContent = eventParticipants.length + ' added';
    }

    function removeEventParticipantChip(index) {
      eventParticipants.splice(index, 1);
      renderEventParticipantChips();
    }

    function addParticipantToEvent(participant) {
      // Check for duplicates by email
      if (participant.email && eventParticipants.some(p => p.email && p.email.toLowerCase() === participant.email.toLowerCase())) {
        showToast('This participant is already added', 'warning');
        return false;
      }
      eventParticipants.push(participant);
      renderEventParticipantChips();
      return true;
    }

    // Toggle manual participant form
    function toggleManualParticipantForm() {
      const form = document.getElementById('manual-participant-form');
      if (form) {
        form.style.display = form.style.display === 'none' ? '' : 'none';
        if (form.style.display !== 'none') {
          document.getElementById('manual-participant-name').value = '';
          document.getElementById('manual-participant-email').value = '';
          document.getElementById('manual-participant-phone').value = '';
          document.getElementById('manual-participant-role').value = 'customer';
          document.getElementById('manual-participant-name').focus();
        }
      }
    }

    function addManualParticipant() {
      const name = document.getElementById('manual-participant-name').value.trim();
      const email = document.getElementById('manual-participant-email').value.trim();
      const phone = document.getElementById('manual-participant-phone').value.trim();
      const role = document.getElementById('manual-participant-role').value;

      if (!name) {
        showToast('Please enter a name', 'warning');
        return;
      }

      const added = addParticipantToEvent({
        name: name,
        email: email || '',
        phone: phone || '',
        role: role,
        participant_type: 'attendee'
      });

      if (added) {
        toggleManualParticipantForm();
        showToast('Participant added', 'success');
      }
    }

    // Open participant picker modal
    async function openParticipantPicker() {
      const modal = document.getElementById('participant-picker-modal');
      if (!modal) return;

      modal.classList.add('active');
      selectedPickerParticipants.clear();
      document.getElementById('selected-participants-count').textContent = '0';
      document.getElementById('participant-search').value = '';

      // Load network collaborators
      const listEl = document.getElementById('participant-picker-list');
      listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading network...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load general collaborators from Supabase directly
        const { data: collaborators, error } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, email, phone, role, company, status')
          .eq('user_id', user.id)
          .eq('status', 'active')
          .order('name', { ascending: true });

        if (error) throw error;

        networkCollaboratorsCache = collaborators || [];
        renderParticipantPicker(networkCollaboratorsCache);

      } catch (err) {
        console.error('Error loading network:', err);
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Failed to load network</div>';
      }
    }

    function renderParticipantPicker(collaborators) {
      const listEl = document.getElementById('participant-picker-list');

      if (!collaborators || collaborators.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No collaborators in your network yet.<br><small>Add collaborators from the Collaborators page.</small></div>';
        return;
      }

      const roleColors = {
        contractor: '#3b82f6',
        fabricator: '#8b5cf6',
        installer: '#f59e0b',
        plumber: '#06b6d4',
        designer: '#ec4899',
        vendor: '#84cc16',
        partner: '#14b8a6',
        other: '#6b7280'
      };

      listEl.innerHTML = collaborators.map(c => {
        const isAlreadyAdded = eventParticipants.some(p => p.email && c.email && p.email.toLowerCase() === c.email.toLowerCase());
        const isSelected = selectedPickerParticipants.has(c.id);
        const color = roleColors[c.role] || roleColors.other;

        return '<div class="picker-item" data-id="' + c.id + '" onclick="togglePickerParticipant(\'' + c.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: ' + (isSelected ? 'var(--gold-primary)11' : 'transparent') + '; ' + (isAlreadyAdded ? 'opacity: 0.5; pointer-events: none;' : '') + '">' +
          '<input type="checkbox" ' + (isSelected ? 'checked' : '') + ' ' + (isAlreadyAdded ? 'disabled' : '') + ' style="accent-color: var(--gold-primary); width: 18px; height: 18px;" onclick="event.stopPropagation(); togglePickerParticipant(\'' + c.id + '\')" />' +
          '<div style="flex: 1; min-width: 0;">' +
            '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(c.name) + (isAlreadyAdded ? ' <span style="font-size: 10px; color: var(--text-muted);">(already added)</span>' : '') + '</div>' +
            '<div style="font-size: 12px; color: var(--text-secondary);">' + escapeHtml(c.email || 'No email') + (c.company ? '  ' + escapeHtml(c.company) : '') + '</div>' +
          '</div>' +
          '<span style="font-size: 11px; padding: 3px 8px; border-radius: 12px; background: ' + color + '22; color: ' + color + '; text-transform: uppercase;">' + (c.role || 'other') + '</span>' +
        '</div>';
      }).join('');
    }

    function filterParticipantPicker(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderParticipantPicker(networkCollaboratorsCache);
        return;
      }
      const filtered = networkCollaboratorsCache.filter(c =>
        (c.name && c.name.toLowerCase().includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q)) ||
        (c.role && c.role.toLowerCase().includes(q)) ||
        (c.company && c.company.toLowerCase().includes(q))
      );
      renderParticipantPicker(filtered);
    }

    function togglePickerParticipant(id) {
      if (selectedPickerParticipants.has(id)) {
        selectedPickerParticipants.delete(id);
      } else {
        selectedPickerParticipants.add(id);
      }
      document.getElementById('selected-participants-count').textContent = selectedPickerParticipants.size.toString();
      // Re-render to update checkboxes
      filterParticipantPicker(document.getElementById('participant-search').value);
    }

    function confirmSelectedParticipants() {
      let addedCount = 0;
      selectedPickerParticipants.forEach(id => {
        const collab = networkCollaboratorsCache.find(c => c.id === id);
        if (collab) {
          const added = addParticipantToEvent({
            name: collab.name,
            email: collab.email || '',
            phone: collab.phone || '',
            role: collab.role || 'other',
            participant_type: 'attendee'
          });
          if (added) addedCount++;
        }
      });

      closeParticipantPicker();
      if (addedCount > 0) {
        showToast(addedCount + ' participant' + (addedCount > 1 ? 's' : '') + ' added', 'success');
      }
    }

    function closeParticipantPicker() {
      const modal = document.getElementById('participant-picker-modal');
      if (modal) modal.classList.remove('active');
    }

    // Add all project team members to event
    async function addProjectTeamToEvent() {
      const projectSelect = document.getElementById('cal-event-project-select');
      const projectId = projectSelect?.value;

      if (!projectId) {
        showToast('Please select a project first', 'warning');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Load project contractors
        const { data: contractors, error } = await supabaseClient
          .from('project_contractors')
          .select('contractor_id, role, general_collaborators(id, name, email, phone, role)')
          .eq('project_id', projectId);

        if (error) throw error;

        if (!contractors || contractors.length === 0) {
          showToast('No team members assigned to this project', 'info');
          return;
        }

        let addedCount = 0;
        contractors.forEach(pc => {
          const collab = pc.general_collaborators;
          if (collab && collab.email) {
            const added = addParticipantToEvent({
              name: collab.name,
              email: collab.email,
              phone: collab.phone || '',
              role: pc.role || collab.role || 'contractor',
              participant_type: 'attendee'
            });
            if (added) addedCount++;
          }
        });

        if (addedCount > 0) {
          showToast(addedCount + ' team member' + (addedCount > 1 ? 's' : '') + ' added', 'success');
        } else {
          showToast('All team members already added', 'info');
        }

      } catch (err) {
        console.error('Error loading project team:', err);
        showToast('Failed to load project team', 'error');
      }
    }

    // Enable/disable "Add Project Team" button based on project selection
    function onProjectSelectChange() {
      const projectSelect = document.getElementById('cal-event-project-select');
      const addTeamBtn = document.getElementById('add-project-team-btn');
      if (addTeamBtn) {
        addTeamBtn.disabled = !projectSelect?.value;
      }
    }

    function switchCollabTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.collab-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--dark-surface)';
        btn.style.color = 'var(--text-secondary)';
        btn.style.border = '1px solid var(--border-subtle)';
      });
      const activeTab = document.getElementById('tab-' + tab);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'var(--gold-primary)';
        activeTab.style.color = '#1a1a2e';
        activeTab.style.border = 'none';
      }

      // Show/hide content
      document.querySelectorAll('.collab-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      const activeContent = document.getElementById('collab-tab-' + tab);
      if (activeContent) activeContent.style.display = 'block';

      // Load data for the active tab
      if (tab === 'network') loadMyNetwork();
      else if (tab === 'invitations') loadReceivedInvitations();
      else if (tab === 'collaborations') loadCollaborations();
    }

    function switchTeamTab(tab) {
      // Update tab buttons
      document.querySelectorAll('#page-collaborators .filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeTab = document.getElementById('team-tab-' + tab);
      if (activeTab) activeTab.classList.add('active');

      // Show/hide content
      document.getElementById('team-content-my-team').style.display = tab === 'my-team' ? 'block' : 'none';
      document.getElementById('team-content-invitations').style.display = tab === 'invitations' ? 'block' : 'none';

      // Load data for invitations tab
      if (tab === 'invitations') loadTeamInvitations();
    }

    async function loadTeamInvitations() {
      const container = document.getElementById('team-invitations-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const resp = await apiCall('/api/collaboration/invitations');
        const data = await resp.json();

        if (!resp.ok || !data.received || data.received.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              <h3>No pending invitations</h3>
              <p>When you're invited to collaborate on projects, they'll appear here.</p>
            </div>`;
          return;
        }

        container.innerHTML = data.received.map(inv => `
          <div class="list-item" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 8px;">
            <div>
              <div style="font-weight: 600;">${escapeHtml(inv.project?.name || 'Project')}</div>
              <div style="font-size: 13px; color: var(--text-muted);">From: ${escapeHtml(inv.inviter?.full_name || inv.inviter?.email || 'Unknown')}</div>
              <div style="font-size: 12px; color: var(--text-muted);">Role: ${inv.role || 'Collaborator'}</div>
            </div>
            <div style="display: flex; gap: 8px;">
              <button class="btn-modern primary" onclick="respondToInvitation('${inv.id}', 'accepted', false)">Accept</button>
              <button class="btn-modern ghost" onclick="respondToInvitation('${inv.id}', 'declined', false)">Decline</button>
            </div>
          </div>
        `).join('');

        // Update badge
        const badge = document.getElementById('team-invites-badge');
        if (badge && data.received.length > 0) {
          badge.textContent = data.received.length;
          badge.style.display = 'inline';
        }
      } catch (err) {
        console.error('Load team invitations error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading invitations</div>';
      }
    }

    async function loadMyNetwork() {
      const container = document.getElementById('network-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const resp = await apiCall('/api/collaboration/my-collaborators');
        const data = await resp.json();

        if (!resp.ok) {
          throw new Error(data.error || 'Failed to load network');
        }

        const collaborators = data.collaborators || [];

        // Update badge
        const badge = document.getElementById('network-count-badge');
        if (badge) {
          badge.textContent = collaborators.length;
          badge.style.display = collaborators.length > 0 ? 'inline' : 'none';
        }

        if (collaborators.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
              <h3>No network contacts yet</h3>
              <p>Invite colleagues, vendors, and partners to build your professional network.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = collaborators.map(c => {
          const roleLabel = (c.role || 'partner').charAt(0).toUpperCase() + (c.role || 'partner').slice(1);
          const statusColor = c.status === 'accepted' ? '#10b981' : c.status === 'pending' ? '#f59e0b' : '#6b7280';
          const statusLabel = c.status === 'accepted' ? 'Connected' : c.status === 'pending' ? 'Pending' : c.status;
          const userName = c.user?.full_name || c.user?.email || c.email;
          const dateStr = c.accepted_at ? new Date(c.accepted_at).toLocaleDateString() : (c.invited_at ? 'Invited ' + new Date(c.invited_at).toLocaleDateString() : '');

          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                  <span style="font-size: 15px; font-weight: 600;">${escapeHtml(userName)}</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); border-radius: 4px; font-weight: 500;">${roleLabel}</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-weight: 500;">${statusLabel}</span>
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(c.email)}${dateStr ? '  ' + dateStr : ''}</div>
                ${c.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">${escapeHtml(c.notes)}</div>` : ''}
              </div>
              <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                ${c.status === 'accepted' ? `
                  <button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openAssignToProjectModal('${c.id}', '${escapeHtml(userName)}')">
                    Assign to Project
                  </button>
                ` : ''}
                <button class="btn-modern ghost" style="padding: 6px 10px; color: var(--error);" onclick="removeNetworkCollaborator('${c.id}')" title="Remove">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading network:', err);
        container.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load network.</p></div>';
      }
    }

    async function loadReceivedInvitations() {
      const container = document.getElementById('received-invitations-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const resp = await apiCall('/api/collaboration/my-invitations');
        const data = await resp.json();

        if (!resp.ok) {
          throw new Error(data.error || 'Failed to load invitations');
        }

        const invitations = data.invitations || [];

        // Update badge
        const badge = document.getElementById('invitations-count-badge');
        if (badge) {
          badge.textContent = invitations.length;
          badge.style.display = invitations.length > 0 ? 'inline' : 'none';
        }

        if (invitations.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              <h3>No pending invitations</h3>
              <p>When someone invites you to collaborate, it will appear here.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = invitations.map(inv => {
          const roleLabel = (inv.role || 'collaborator').charAt(0).toUpperCase() + (inv.role || 'collaborator').slice(1);
          const inviterName = inv.inviter?.full_name || inv.inviter?.email || 'Someone';
          const isNetwork = !inv.project_id;
          const dateStr = inv.invited_at ? new Date(inv.invited_at).toLocaleDateString() : '';

          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">
                  ${isNetwork ? 'Network Invitation' : `Project: ${escapeHtml(inv.project?.name || 'Unknown')}`}
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                  From: ${escapeHtml(inviterName)}  Role: ${roleLabel}
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${dateStr}</div>
                ${inv.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 6px; font-style: italic;">"${escapeHtml(inv.notes)}"</div>` : ''}
              </div>
              <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                <button class="btn-modern primary" style="padding: 8px 16px; font-size: 13px;" onclick="respondToInvitation('${inv.id}', 'accepted', ${isNetwork})">
                  Accept
                </button>
                <button class="btn-modern secondary" style="padding: 8px 16px; font-size: 13px;" onclick="respondToInvitation('${inv.id}', 'declined', ${isNetwork})">
                  Decline
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading invitations:', err);
        container.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load invitations.</p></div>';
      }
    }

    async function respondToInvitation(invitationId, response, isNetwork) {
      try {
        const endpoint = isNetwork
          ? `/api/collaboration/network/respond/${invitationId}`
          : `/api/collaboration/invitations/${invitationId}/respond`;

        const resp = await apiCall(endpoint, {
          method: 'POST',
          body: JSON.stringify({ response })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to respond');

        showToast(response === 'accepted' ? 'Invitation accepted!' : 'Invitation declined', 'success');
        loadReceivedInvitations();

        // Refresh the relevant list
        if (response === 'accepted') {
          if (isNetwork) loadMyNetwork();
          else loadCollaborations();
        }
      } catch (err) {
        console.error('Error responding to invitation:', err);
        showToast(err.message || 'Failed to respond to invitation', 'error');
      }
    }

    function openInviteToNetworkModal() {
      document.getElementById('invite-network-form').reset();
      document.getElementById('invite-to-network-modal').classList.add('active');
    }

    function closeInviteToNetworkModal() {
      document.getElementById('invite-to-network-modal').classList.remove('active');
    }

    async function sendNetworkInvite(event) {
      event.preventDefault();
      const btn = document.getElementById('send-network-invite-btn');
      const name = document.getElementById('network-invite-name').value.trim();
      const contact = document.getElementById('network-invite-contact').value.trim();
      const roleInput = document.querySelector('input[name="invite-role"]:checked');
      const role = roleInput ? roleInput.value : '';

      if (!name) {
        showToast('Please enter their name', 'warning');
        return false;
      }

      if (!contact) {
        showToast('Please enter their email or phone', 'warning');
        return false;
      }

      if (!role) {
        showToast('Please select what they do', 'warning');
        return false;
      }

      // Determine if contact is email or phone
      const isEmail = contact.includes('@');
      const email = isEmail ? contact.toLowerCase() : null;
      const phone = !isEmail ? contact : null;

      if (email && currentUser && currentUser.email && email === currentUser.email.toLowerCase()) {
        showToast('You cannot invite yourself', 'warning');
        return false;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-small"></span> Sending...';

      try {
        const resp = await apiCall('/api/collaboration/invite-general', {
          method: 'POST',
          body: JSON.stringify({ email, phone, name, role })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to send invitation');

        showToast(data.message || `Invite sent to ${name}!`, 'success');
        closeInviteToNetworkModal();

        // Reset form
        document.getElementById('invite-network-form').reset();
        document.querySelectorAll('.role-option').forEach(o => o.querySelector('input').checked = false);

        loadMyNetwork();

      } catch (err) {
        console.error('Error sending network invite:', err);
        showToast(err.message || 'Failed to send invitation', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 10px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Send Invite';
      }

      return false;
    }

    async function removeNetworkCollaborator(collaboratorId) {
      if (!confirm('Remove this contact from your network?')) return;

      try {
        const resp = await apiCall(`/api/collaboration/collaborators/${collaboratorId}`, {
          method: 'DELETE'
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to remove');

        showToast('Contact removed from network', 'success');
        loadMyNetwork();
      } catch (err) {
        console.error('Error removing collaborator:', err);
        showToast(err.message || 'Failed to remove contact', 'error');
      }
    }

    function openAssignToProjectModal(collaboratorId, collaboratorName) {
      document.getElementById('assign-collaborator-id').value = collaboratorId;
      document.getElementById('assign-collaborator-name').textContent = collaboratorName;
      loadProjectsForAssignment();
      document.getElementById('assign-to-project-modal').classList.add('active');
    }

    function closeAssignToProjectModal() {
      document.getElementById('assign-to-project-modal').classList.remove('active');
    }

    async function loadProjectsForAssignment() {
      const select = document.getElementById('assign-project-select');
      select.innerHTML = '<option value="">Loading projects...</option>';

      try {
        // Load owned projects
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: projects } = await supabaseClient
          .from('projects')
          .select('id, name')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        select.innerHTML = '<option value="">-- Select Project --</option>';

        if (projects && projects.length > 0) {
          projects.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
          });
        }

        // Also add jobs
        if (allJobs && allJobs.length > 0) {
          allJobs.forEach(job => {
            const label = (job.job_number || 'Job') + ' - ' + (job.customer_name || job.description || 'Untitled');
            select.innerHTML += `<option value="${job.id}">${escapeHtml(label)}</option>`;
          });
        }

        if (select.options.length === 1) {
          select.innerHTML = '<option value="">No projects available</option>';
        }
      } catch (err) {
        console.error('Error loading projects:', err);
        select.innerHTML = '<option value="">Failed to load projects</option>';
      }
    }

    async function submitAssignToProject(event) {
      event.preventDefault();
      const collaboratorId = document.getElementById('assign-collaborator-id').value;
      const projectId = document.getElementById('assign-project-select').value;
      const accessLevel = document.getElementById('assign-access-level').value;

      if (!collaboratorId || !projectId) {
        showToast('Please select a project', 'warning');
        return false;
      }

      try {
        const resp = await apiCall(`/api/collaboration/collaborators/${collaboratorId}/assign-project`, {
          method: 'POST',
          body: JSON.stringify({ project_id: projectId, access_level: accessLevel })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to assign');

        showToast('Collaborator assigned to project!', 'success');
        closeAssignToProjectModal();
        loadCollaborations();
      } catch (err) {
        console.error('Error assigning to project:', err);
        showToast(err.message || 'Failed to assign to project', 'error');
      }

      return false;
    }

    // =============================================
    // UNIVERSAL QUICK SCHEDULE SYSTEM
    // Works from anywhere: leads, jobs, customers, collaborators, projects, estimates
    // =============================================

    function quickSchedule(entityType, entityData = {}) {
      // Build prefill data based on entity type
      let prefillData = {};
      let suggestedTitle = 'Appointment';

      switch (entityType) {
        case 'lead':
          suggestedTitle = `Appointment - ${entityData.full_name || entityData.name || entityData.email || 'Lead'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'appointment',
            contactName: entityData.full_name || entityData.name || '',
            contactEmail: entityData.email || '',
            contactPhone: entityData.phone || '',
            location: entityData.address || '',
            leadId: entityData.id
          };
          break;

        case 'customer':
          suggestedTitle = `Appointment - ${entityData.name || entityData.email || 'Customer'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'appointment',
            contactName: entityData.name || '',
            contactEmail: entityData.email || '',
            contactPhone: entityData.phone || '',
            location: entityData.address || '',
            customerId: entityData.id
          };
          break;

        case 'job':
          suggestedTitle = `${entityData.job_number || 'Job'} - ${entityData.customer_name || entityData.description || ''}`;
          prefillData = {
            title: suggestedTitle,
            type: entityData.eventType || 'measurement',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            contactPhone: entityData.customer_phone || '',
            location: entityData.job_site_address || entityData.address || '',
            jobId: entityData.id,
            customerId: entityData.customer_id
          };
          break;

        case 'contractor':
          suggestedTitle = `Meeting - ${entityData.company_name || entityData.name || 'Contractor'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'meeting',
            contactName: entityData.contact_name || entityData.name || '',
            contactEmail: entityData.email || '',
            contactPhone: entityData.phone || ''
          };
          break;

        case 'project':
          suggestedTitle = `${entityData.name || entityData.title || 'Project'} - Meeting`;
          prefillData = {
            title: suggestedTitle,
            type: 'meeting',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            location: entityData.address || '',
            projectId: entityData.id,
            customerId: entityData.customer_id
          };
          break;

        case 'estimate':
          suggestedTitle = `Follow-up: ${entityData.estimate_number || 'Estimate'} - ${entityData.customer_name || ''}`;
          prefillData = {
            title: suggestedTitle,
            type: 'follow_up',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            contactPhone: entityData.customer_phone || '',
            customerId: entityData.customer_id
          };
          break;

        case 'invoice':
          suggestedTitle = `Payment Follow-up: ${entityData.invoice_number || 'Invoice'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'follow_up',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            contactPhone: entityData.customer_phone || '',
            customerId: entityData.customer_id
          };
          break;

        default:
          // Generic scheduling
          prefillData = {
            title: entityData.title || '',
            type: entityData.type || 'appointment',
            contactName: entityData.contactName || entityData.name || '',
            contactEmail: entityData.contactEmail || entityData.email || '',
            contactPhone: entityData.contactPhone || entityData.phone || '',
            location: entityData.location || entityData.address || ''
          };
      }

      // Open the calendar modal with prefilled data
      openCalendarEventModal(null, null, prefillData);
    }

    // Quick schedule from current context (uses global selected* variables)
    function quickScheduleFromContext() {
      if (selectedLead) {
        quickSchedule('lead', selectedLead);
      } else if (selectedCustomer) {
        quickSchedule('customer', selectedCustomer);
      } else if (selectedJob) {
        quickSchedule('job', selectedJob);
      } else {
        // Just open empty modal
        openCalendarEventModal();
      }
    }

    // Schedule for current job (from job detail modal)
    function scheduleForCurrentJob() {
      const jobData = {
        id: document.getElementById('job-detail-id')?.value,
        job_number: document.getElementById('job-detail-number')?.textContent,
        customer_name: document.getElementById('job-customer-name-display')?.textContent,
        customer_email: document.getElementById('job-customer-email-display')?.textContent,
        customer_phone: document.getElementById('job-customer-phone-display')?.textContent,
        job_site_address: document.getElementById('job-customer-address-display')?.textContent
      };
      quickSchedule('job', jobData);
    }

    // Schedule with contractor
    function scheduleWithContractor(contractorId) {
      const contractor = allCollaborators.find(c => c.id === contractorId);
      if (contractor) {
        quickSchedule('contractor', contractor);
      }
    }

    // Schedule follow-up for estimate
    function scheduleForEstimate(estimateId, estimateNumber, customerName, customerEmail) {
      quickSchedule('estimate', {
        id: estimateId,
        estimate_number: estimateNumber,
        customer_name: customerName,
        customer_email: customerEmail
      });
    }

    // Schedule follow-up for invoice
    function scheduleForInvoice(invoiceId, invoiceNumber, customerName, customerEmail) {
      quickSchedule('invoice', {
        id: invoiceId,
        invoice_number: invoiceNumber,
        customer_name: customerName,
        customer_email: customerEmail
      });
    }

    // Schedule for project
    function scheduleForProject(projectId) {
      const project = allProjects?.find(p => p.id === projectId);
      if (project) {
        quickSchedule('project', project);
      }
    }

    // Quick change project status
    function quickChangeProjectStatus(projectId, currentStatus) {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed', 'on_hold', 'cancelled'];

      const modal = document.createElement('div');
      modal.id = 'quick-project-status-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; min-width: 260px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin: 0 0 16px; font-size: 14px; color: var(--text-primary);">Change Project Status</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${statuses.map(s => {
              const color = PROJECT_STATUS_COLORS[s] || '#6b7280';
              return `
                <button onclick="setProjectStatusQuick('${projectId}', '${s}')"
                        style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: ${s === currentStatus ? color + '20' : 'var(--dark-elevated)'}; border: 1px solid ${s === currentStatus ? color : 'var(--border-subtle)'}; border-radius: 8px; cursor: pointer; transition: all 0.15s; color: ${s === currentStatus ? color : 'var(--text-secondary)'};"
                        onmouseover="this.style.borderColor='${color}'"
                        onmouseout="this.style.borderColor='${s === currentStatus ? color : 'var(--border-subtle)'}'"
                >
                  <span style="width: 10px; height: 10px; border-radius: 50%; background: ${color};"></span>
                  <span style="font-weight: 500;">${PROJECT_STATUS_LABELS[s] || s}</span>
                  ${s === currentStatus ? '<span style="margin-left: auto; font-size: 11px;">Current</span>' : ''}
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function setProjectStatusQuick(projectId, newStatus) {
      document.getElementById('quick-project-status-modal')?.remove();

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', projectId);

        if (error) throw error;

        // Update local data
        const project = allProjects?.find(p => p.id === projectId);
        if (project) project.status = newStatus;

        renderProjectsList();
        renderProjectsKanban();
        showToast(`Project status changed to ${PROJECT_STATUS_LABELS[newStatus] || newStatus}`, 'success');
      } catch (err) {
        console.error('Error updating project status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    // Quick add task to project
    function quickAddProjectTask(projectId) {
      const modal = document.createElement('div');
      modal.id = 'quick-add-task-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; min-width: 340px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin: 0 0 16px; font-size: 14px; color: var(--text-primary);">Add Task</h3>
          <form onsubmit="submitQuickTask('${projectId}', this); return false;">
            <input type="text" name="title" placeholder="Task title..." required autofocus
                   style="width: 100%; padding: 10px 14px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark-elevated); color: var(--text-primary); font-size: 14px; margin-bottom: 12px; box-sizing: border-box;">
            <div style="display: flex; gap: 8px;">
              <button type="button" onclick="document.getElementById('quick-add-task-modal').remove()"
                      style="flex: 1; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark-elevated); color: var(--text-secondary); cursor: pointer; font-size: 13px;">
                Cancel
              </button>
              <button type="submit"
                      style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: var(--gold-primary); color: var(--dark-primary); cursor: pointer; font-weight: 600; font-size: 13px;">
                Add Task
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
      setTimeout(() => modal.querySelector('input')?.focus(), 100);
    }

    async function submitQuickTask(projectId, form) {
      const title = form.querySelector('input[name="title"]').value.trim();
      if (!title) return;

      document.getElementById('quick-add-task-modal')?.remove();

      try {
        // Get max sort order
        const { data: existingTasks } = await supabaseClient
          .from('project_tasks')
          .select('sort_order')
          .eq('project_id', projectId)
          .order('sort_order', { ascending: false })
          .limit(1);

        const sortOrder = (existingTasks?.[0]?.sort_order || 0) + 1;

        const { error } = await supabaseClient
          .from('project_tasks')
          .insert({
            project_id: projectId,
            title,
            status: 'pending',
            sort_order: sortOrder
          });

        if (error) throw error;

        showToast('Task added', 'success');

        // If project detail is open, refresh it
        if (currentProjectId === projectId) {
          openProjectDetail(projectId);
        }

      } catch (err) {
        console.error('Error adding task:', err);
        showToast('Failed to add task', 'error');
      }
    }

    // =============================================
    // CALENDAR EVENTS (MULTI-PARTICIPANT)
    // =============================================

    async function openCalendarEventModal(eventId = null, preselectedDate = null, prefillData = null) {
      const form = document.getElementById('calendar-event-form');
      const title = document.getElementById('calendar-event-modal-title');
      form.reset();

      // Clear hidden ID fields
      document.getElementById('cal-event-id').value = eventId || '';
      document.getElementById('cal-event-lead').value = '';
      document.getElementById('cal-event-customer').value = '';
      document.getElementById('cal-event-job').value = '';
      document.getElementById('cal-event-project').value = '';

      // Reset participants
      eventParticipants = [];
      renderEventParticipantChips();

      // Reset contact search
      clearCalEventContact();

      // Reset meeting format to in_person and initialize location section
      const meetingFormatSelect = document.getElementById('cal-event-meeting-format');
      if (meetingFormatSelect) {
        meetingFormatSelect.value = 'in_person';
      }
      handleMeetingFormatChange();

      // Hide contact address option (will show if contact with address is selected)
      const contactAddressOption = document.getElementById('contact-address-option');
      const useContactCheckbox = document.getElementById('use-contact-address');
      if (contactAddressOption) contactAddressOption.style.display = 'none';
      if (useContactCheckbox) useContactCheckbox.checked = false;

      // Clear video/conference fields
      const videoLink = document.getElementById('cal-event-video-link');
      const videoPlatform = document.getElementById('cal-event-video-platform');
      const confNumber = document.getElementById('cal-event-conference-number');
      const confCode = document.getElementById('cal-event-conference-code');
      const confPin = document.getElementById('cal-event-conference-pin');
      if (videoLink) videoLink.value = '';
      if (videoPlatform) videoPlatform.value = '';
      if (confNumber) confNumber.value = '';
      if (confCode) confCode.value = '';
      if (confPin) confPin.value = '';

      // Hide manual participant form
      const manualForm = document.getElementById('manual-participant-form');
      if (manualForm) manualForm.style.display = 'none';

      // Load contractors if not already loaded
      if (!allContractors || allContractors.length === 0) {
        await loadContractors();
      }

      // Populate dropdowns
      populateEventProjectDropdown();
      populateEventContractorsDropdown();

      // Add project change listener for "Add Project Team" button
      const projectSelect = document.getElementById('cal-event-project-select');
      if (projectSelect) {
        projectSelect.onchange = onProjectSelectChange;
        onProjectSelectChange(); // Initial state
      }

      if (eventId) {
        title.textContent = 'Edit Event';
        loadCalendarEventForEditSimple(eventId);
      } else {
        title.textContent = 'New Event';
        // Set default date/time
        const today = preselectedDate || new Date().toISOString().split('T')[0];
        document.getElementById('cal-event-start-date').value = today;
        document.getElementById('cal-event-end-date').value = today;
        document.getElementById('cal-event-start-time').value = '09:00';
        document.getElementById('cal-event-end-time').value = '10:00';

        // Apply prefill data if provided
        if (prefillData) {
          if (prefillData.title) document.getElementById('cal-event-title').value = prefillData.title;
          if (prefillData.type) document.getElementById('cal-event-type').value = prefillData.type;
          if (prefillData.meetingFormat) {
            document.getElementById('cal-event-meeting-format').value = prefillData.meetingFormat;
            handleMeetingFormatChange();
          }
          // If prefill has contact info, set as selected contact
          if (prefillData.contactName) {
            selectCalEventContact(
              prefillData.contactType || 'lead',
              prefillData.contactId || prefillData.leadId || null,
              prefillData.contactName,
              prefillData.contactEmail || '',
              prefillData.contactPhone || '',
              prefillData.contactAddress || prefillData.location || ''
            );
            // selectCalEventContact already handles showing the contact address option
            // and auto-filling the location field
          }
          if (prefillData.location && !prefillData.contactName) {
            document.getElementById('cal-event-location').value = prefillData.location;
          }
          if (prefillData.leadId) document.getElementById('cal-event-lead').value = prefillData.leadId;
          if (prefillData.customerId) document.getElementById('cal-event-customer').value = prefillData.customerId;
          if (prefillData.jobId) document.getElementById('cal-event-job').value = prefillData.jobId;
          if (prefillData.projectId) document.getElementById('cal-event-project').value = prefillData.projectId;
        }
      }

      document.getElementById('calendar-event-modal').classList.add('active');

      // Initialize Google Places autocomplete on location input
      if (googleMapsReady && !locationAutocomplete) {
        const locationInput = document.getElementById('cal-event-location');
        if (locationInput) {
          initLocationAutocomplete(locationInput);
        }
      }

      // Hide map preview when opening modal (will show when address selected)
      hideLocationMapPreview();
    }

    // ============================================
    // CALENDAR EVENT CONTACT SEARCH
    // Search leads, customers, and contractors for contact auto-fill
    // ============================================
    let calEventContactsCache = [];

    async function loadCalEventContacts() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return [];

        calEventContactsCache = [];

        // Load leads (RLS handles user filtering)
        const { data: leads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, phone, address, city, state')
          .limit(200);

        (leads || []).forEach(l => {
          const address = [l.address, l.city, l.state].filter(Boolean).join(', ');
          calEventContactsCache.push({
            id: l.id,
            type: 'lead',
            name: l.full_name || l.email || 'Unknown Lead',
            email: l.email || '',
            phone: l.phone || '',
            address: address,
            label: 'Lead'
          });
        });

        // Load customers
        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state')
          .eq('user_id', user.id)
          .limit(200);

        (customers || []).forEach(c => {
          const address = [c.address, c.city, c.state].filter(Boolean).join(', ');
          calEventContactsCache.push({
            id: c.id,
            type: 'customer',
            name: c.name || c.email || 'Unknown Customer',
            email: c.email || '',
            phone: c.phone || '',
            address: address,
            label: 'Customer'
          });
        });

        // Load collaborators/contractors
        try {
          const { data: collaborators } = await supabaseClient
            .from('general_collaborators')
            .select('id, name, email, phone, company, role')
            .eq('user_id', user.id)
            .eq('status', 'active')
            .limit(200);

          (collaborators || []).forEach(c => {
            calEventContactsCache.push({
              id: c.id,
              type: 'contractor',
              name: c.name || c.email || 'Unknown',
              email: c.email || '',
              phone: c.phone || '',
              address: c.company || '',
              label: c.role ? c.role.charAt(0).toUpperCase() + c.role.slice(1) : 'Contractor'
            });
          });
        } catch (e) {
          console.warn('[CalEvent] Collaborators table not available');
        }

        console.log('[CalEvent] Loaded', calEventContactsCache.length, 'contacts for search');
        return calEventContactsCache;

      } catch (err) {
        console.error('[CalEvent] Failed to load contacts:', err);
        return [];
      }
    }

    async function searchCalEventContacts(query) {
      const suggestionsEl = document.getElementById('cal-event-contact-suggestions');
      if (!suggestionsEl) return;

      // Load contacts if not cached
      if (calEventContactsCache.length === 0) {
        suggestionsEl.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted);">Loading contacts...</div>';
        suggestionsEl.style.display = 'block';
        await loadCalEventContacts();
      }

      const q = (query || '').toLowerCase().trim();

      // Filter contacts
      let filtered = calEventContactsCache.filter(c => {
        if (!q) return true;
        return (c.name || '').toLowerCase().includes(q) ||
               (c.email || '').toLowerCase().includes(q) ||
               (c.phone || '').includes(q) ||
               (c.label || '').toLowerCase().includes(q);
      }).slice(0, 10);

      // Build suggestions HTML
      let html = '';

      const labelColors = {
        Lead: '#f59e0b',
        Customer: '#10b981',
        Contractor: '#3b82f6',
        Fabricator: '#8b5cf6',
        Installer: '#f97316',
        Plumber: '#06b6d4',
        Designer: '#ec4899'
      };

      if (filtered.length > 0) {
        filtered.forEach(c => {
          const initials = (c.name || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          const color = labelColors[c.label] || '#6b7280';
          const addressStr = c.address ? c.address : '';
          html += `
            <div class="cal-contact-suggestion" onclick="selectCalEventContact('${c.type}', '${c.id}', '${escapeHtml(c.name)}', '${escapeHtml(c.email)}', '${escapeHtml(c.phone)}', '${escapeHtml(addressStr)}')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.15s;" onmouseover="this.style.background='var(--dark-tertiary)'" onmouseout="this.style.background='transparent'">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: ${color}22; color: ${color}; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px;">${initials}</div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(c.name)}</div>
                <div style="font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.email || c.phone || 'No contact info'}</div>
              </div>
              <span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ${color}22; color: ${color}; text-transform: uppercase; white-space: nowrap;">${c.label}</span>
            </div>
          `;
        });
      } else if (q) {
        // Allow manual entry
        html = `
          <div style="padding: 12px; text-align: center; color: var(--text-muted);">
            No contacts found matching "${escapeHtml(q)}"<br>
            <small>Type email or phone, or fill fields manually below</small>
          </div>
        `;
      } else {
        html = '<div style="padding: 12px; text-align: center; color: var(--text-muted);">Type to search leads, customers, contractors...</div>';
      }

      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = 'block';
    }

    // Store selected contact data for location display
    let selectedContactData = {
      name: '',
      email: '',
      phone: '',
      address: ''
    };

    function selectCalEventContact(type, id, name, email, phone, address) {
      // Store contact data
      selectedContactData = { name, email, phone, address };

      // Set hidden fields
      document.getElementById('cal-event-contact-type').value = type || '';
      document.getElementById('cal-event-contact-id').value = id || '';

      // Set visible fields
      document.getElementById('cal-event-contact-email').value = email || '';
      document.getElementById('cal-event-contact-phone').value = phone || '';

      // Update contact address option visibility
      updateContactAddressOption();

      // Auto-fill location if contact has address
      const locationField = document.getElementById('cal-event-location');
      if (address && locationField) {
        locationField.value = address;
        // Check the "use contact address" checkbox
        const useContactCheckbox = document.getElementById('use-contact-address');
        if (useContactCheckbox) useContactCheckbox.checked = true;
        // Show map preview for the address
        if (googleMapsReady) {
          geocodeAndShowMapPreview(address);
        }
      }

      // Update phone call display
      updatePhoneCallDisplay(phone);

      // Show selected contact chip
      const chip = document.getElementById('cal-event-contact-chip');
      const chipName = document.getElementById('cal-event-contact-chip-name');
      const chipBadge = document.getElementById('cal-event-contact-chip-badge');
      const searchInput = document.getElementById('cal-event-contact-search');
      const suggestions = document.getElementById('cal-event-contact-suggestions');

      chipName.textContent = name;
      chipBadge.textContent = type === 'lead' ? 'Lead' : type === 'customer' ? 'Customer' : type === 'contractor' ? 'Contractor' : 'Contact';
      chip.style.display = 'block';
      searchInput.style.display = 'none';
      suggestions.style.display = 'none';

      // Also link to lead/customer if appropriate
      if (type === 'lead' && id) {
        document.getElementById('cal-event-lead').value = id;
      } else if (type === 'customer' && id) {
        document.getElementById('cal-event-customer').value = id;
      }

      console.log('[CalEvent] Selected contact:', { type, id, name, email, phone, address });
    }

    // Handle meeting format change
    function handleMeetingFormatChange() {
      const format = document.getElementById('cal-event-meeting-format').value;

      // Hide all location sections
      document.getElementById('location-in-person').style.display = 'none';
      document.getElementById('location-phone-call').style.display = 'none';
      document.getElementById('location-video-call').style.display = 'none';
      document.getElementById('location-conference-call').style.display = 'none';

      // Show appropriate section
      switch (format) {
        case 'in_person':
          document.getElementById('location-in-person').style.display = 'block';
          break;
        case 'phone_call':
          document.getElementById('location-phone-call').style.display = 'block';
          // Update phone display with current contact phone
          const phoneField = document.getElementById('cal-event-contact-phone');
          updatePhoneCallDisplay(phoneField ? phoneField.value : '');
          break;
        case 'video_call':
          document.getElementById('location-video-call').style.display = 'block';
          break;
        case 'conference_call':
          document.getElementById('location-conference-call').style.display = 'block';
          break;
        default:
          document.getElementById('location-in-person').style.display = 'block';
      }
    }

    // Handle "Use contact address" checkbox change
    function handleUseContactAddress() {
      const checkbox = document.getElementById('use-contact-address');
      const locationField = document.getElementById('cal-event-location');

      if (checkbox && checkbox.checked && selectedContactData.address) {
        // Fill location with contact address
        if (locationField) {
          locationField.value = selectedContactData.address;
        }
        // Show map preview for the address
        if (googleMapsReady) {
          geocodeAndShowMapPreview(selectedContactData.address);
        }
      } else {
        // If unchecked, hide map preview
        hideLocationMapPreview();
      }
    }

    // Geocode address and show map preview
    function geocodeAndShowMapPreview(address) {
      if (!googleMapsReady || !google?.maps) return;

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          updateLocationMapPreview({
            formatted_address: results[0].formatted_address,
            geometry: { location: results[0].geometry.location }
          });
        }
      });
    }

    // Show/hide contact address option based on whether contact has address
    function updateContactAddressOption() {
      const contactAddressOption = document.getElementById('contact-address-option');
      const contactAddressText = document.getElementById('contact-address-text');
      const useContactCheckbox = document.getElementById('use-contact-address');

      if (selectedContactData.address && contactAddressOption) {
        contactAddressOption.style.display = 'block';
        if (contactAddressText) {
          contactAddressText.textContent = selectedContactData.address;
        }
      } else if (contactAddressOption) {
        contactAddressOption.style.display = 'none';
        if (useContactCheckbox) useContactCheckbox.checked = false;
      }
    }

    // Update phone call display
    function updatePhoneCallDisplay(phone) {
      const phoneDisplay = document.getElementById('phone-call-display');
      const phoneHidden = document.getElementById('cal-event-location-phone');
      if (phoneDisplay) {
        if (phone) {
          phoneDisplay.innerHTML = `<a href="tel:${phone}" style="color: var(--gold-primary); text-decoration: none;">${phone}</a>`;
        } else {
          phoneDisplay.textContent = 'No phone number set - add in contact fields above';
        }
      }
      if (phoneHidden) phoneHidden.value = phone || '';
    }

    // Handle video platform change
    function handleVideoPlatformChange() {
      const platform = document.getElementById('cal-event-video-platform').value;
      const linkField = document.getElementById('cal-event-video-link');
      if (linkField) {
        switch (platform) {
          case 'zoom':
            linkField.placeholder = 'Paste Zoom meeting link';
            break;
          case 'google_meet':
            linkField.placeholder = 'Paste Google Meet link';
            break;
          case 'teams':
            linkField.placeholder = 'Paste Teams meeting link';
            break;
          case 'facetime':
            linkField.placeholder = 'FaceTime will use contact phone/email';
            break;
          default:
            linkField.placeholder = 'Meeting link (optional)';
        }
      }
    }

    // Watch for phone field changes to update phone call display
    document.addEventListener('DOMContentLoaded', function() {
      const phoneField = document.getElementById('cal-event-contact-phone');
      if (phoneField) {
        phoneField.addEventListener('input', function() {
          updatePhoneCallDisplay(this.value);
        });
      }

      // Add meeting format change listener
      const meetingFormatSelect = document.getElementById('cal-event-meeting-format');
      if (meetingFormatSelect) {
        meetingFormatSelect.addEventListener('change', handleMeetingFormatChange);
      }
    });

    function clearCalEventContact() {
      // Clear stored contact data
      selectedContactData = { name: '', email: '', phone: '', address: '' };

      // Clear hidden fields
      const typeField = document.getElementById('cal-event-contact-type');
      const idField = document.getElementById('cal-event-contact-id');
      if (typeField) typeField.value = '';
      if (idField) idField.value = '';

      // Clear visible fields
      const emailField = document.getElementById('cal-event-contact-email');
      const phoneField = document.getElementById('cal-event-contact-phone');
      if (emailField) emailField.value = '';
      if (phoneField) phoneField.value = '';

      // Hide contact address option and uncheck
      const contactAddressOption = document.getElementById('contact-address-option');
      const useContactCheckbox = document.getElementById('use-contact-address');
      if (contactAddressOption) contactAddressOption.style.display = 'none';
      if (useContactCheckbox) useContactCheckbox.checked = false;

      // Clear phone call display
      updatePhoneCallDisplay('');

      // Hide chip, show search
      const chip = document.getElementById('cal-event-contact-chip');
      const searchInput = document.getElementById('cal-event-contact-search');
      const suggestions = document.getElementById('cal-event-contact-suggestions');

      if (chip) chip.style.display = 'none';
      if (searchInput) {
        searchInput.style.display = 'block';
        searchInput.value = '';
      }
      if (suggestions) suggestions.style.display = 'none';
    }

    // Close contact suggestions when clicking outside
    document.addEventListener('click', function(e) {
      const suggestions = document.getElementById('cal-event-contact-suggestions');
      const searchInput = document.getElementById('cal-event-contact-search');
      if (suggestions && searchInput && !suggestions.contains(e.target) && e.target !== searchInput) {
        suggestions.style.display = 'none';
      }
    });

    // Load event for editing (simplified version)
    async function loadCalendarEventForEditSimple(eventId) {
      try {
        const { data: event, error } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('id', eventId)
          .single();

        if (error) throw error;

        document.getElementById('cal-event-title').value = event.title || '';
        document.getElementById('cal-event-type').value = event.event_type || 'appointment';

        if (event.start_time) {
          const start = new Date(event.start_time);
          // Use local date/time (not UTC) for form fields
          const startYear = start.getFullYear();
          const startMonth = String(start.getMonth() + 1).padStart(2, '0');
          const startDay = String(start.getDate()).padStart(2, '0');
          const startHours = String(start.getHours()).padStart(2, '0');
          const startMins = String(start.getMinutes()).padStart(2, '0');
          document.getElementById('cal-event-start-date').value = `${startYear}-${startMonth}-${startDay}`;
          document.getElementById('cal-event-start-time').value = `${startHours}:${startMins}`;
        }
        if (event.end_time) {
          const end = new Date(event.end_time);
          // Use local date/time (not UTC) for form fields
          const endYear = end.getFullYear();
          const endMonth = String(end.getMonth() + 1).padStart(2, '0');
          const endDay = String(end.getDate()).padStart(2, '0');
          const endHours = String(end.getHours()).padStart(2, '0');
          const endMins = String(end.getMinutes()).padStart(2, '0');
          document.getElementById('cal-event-end-date').value = `${endYear}-${endMonth}-${endDay}`;
          document.getElementById('cal-event-end-time').value = `${endHours}:${endMins}`;
        }

        document.getElementById('cal-event-description').value = event.description || '';

        // Load meeting format from metadata and trigger change handler
        const meetingFormat = event.metadata?.meeting_format || 'in_person';
        document.getElementById('cal-event-meeting-format').value = meetingFormat;
        handleMeetingFormatChange();

        // Load meeting details from metadata
        if (event.metadata && event.metadata.meeting_details) {
          const details = event.metadata.meeting_details;
          // Video call details
          if (details.video_platform) {
            const videoPlatform = document.getElementById('cal-event-video-platform');
            if (videoPlatform) videoPlatform.value = details.video_platform;
          }
          if (details.video_link) {
            const videoLink = document.getElementById('cal-event-video-link');
            if (videoLink) videoLink.value = details.video_link;
          }
          // Conference call details
          if (details.conference_number) {
            const confNumber = document.getElementById('cal-event-conference-number');
            if (confNumber) confNumber.value = details.conference_number;
          }
          if (details.conference_code) {
            const confCode = document.getElementById('cal-event-conference-code');
            if (confCode) confCode.value = details.conference_code;
          }
          if (details.conference_pin) {
            const confPin = document.getElementById('cal-event-conference-pin');
            if (confPin) confPin.value = details.conference_pin;
          }
        }

        // Set location for in-person meetings
        document.getElementById('cal-event-location').value = event.location || '';

        // Load contact info from metadata
        if (event.metadata) {
          const contactName = event.metadata.contact_name || '';
          const contactEmail = event.metadata.contact_email || '';
          const contactPhone = event.metadata.contact_phone || '';
          const contactType = event.metadata.contact_type || 'manual';
          const contactId = event.metadata.contact_id || null;

          if (contactName || contactEmail || contactPhone) {
            // Extract address from location for in-person meetings
            const contactAddress = (meetingFormat === 'in_person') ? (event.location || '') : '';
            selectCalEventContact(contactType, contactId, contactName, contactEmail, contactPhone, contactAddress);
          }
        }

        // Set linked entity IDs
        if (event.lead_id) document.getElementById('cal-event-lead').value = event.lead_id;
        if (event.customer_id) document.getElementById('cal-event-customer').value = event.customer_id;
        if (event.job_id) document.getElementById('cal-event-job').value = event.job_id;
        // Use project_id if available, fallback to job_id for backward compatibility
        const projectIdToUse = event.project_id || event.job_id;
        if (projectIdToUse) {
          document.getElementById('cal-event-project').value = projectIdToUse;
          const projectSelect = document.getElementById('cal-event-project-select');
          if (projectSelect) {
            projectSelect.value = projectIdToUse;
            onProjectSelectChange();
          }
        }

        // Load existing participants
        const { data: participants } = await supabaseClient
          .from('calendar_event_participants')
          .select('id, name, email, phone, participant_type, response_status')
          .eq('event_id', eventId);

        if (participants && participants.length > 0) {
          eventParticipants = participants.map(p => ({
            name: p.name || p.email,
            email: p.email,
            phone: p.phone || '',
            role: p.participant_type === 'customer' ? 'customer' : 'contractor',
            participant_type: p.participant_type || 'attendee'
          }));
          renderEventParticipantChips();
        }

      } catch (err) {
        console.error('Error loading event:', err);
        showToast('Failed to load event', 'error');
      }
    }

    // Quick schedule from lead card (without opening lead detail first)
    function openScheduleLeadModal(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const leadName = lead.full_name || lead.homeowner_name || lead.name || lead.email || 'Lead';
      const leadEmail = lead.email || lead.homeowner_email || '';
      const leadPhone = lead.phone || lead.homeowner_phone || '';
      // Build full address from available fields
      const addressParts = [
        lead.address || lead.project_address,
        lead.city,
        lead.state,
        lead.zip
      ].filter(Boolean);
      const leadAddress = addressParts.join(', ');

      openCalendarEventModal(null, null, {
        title: `Appointment - ${leadName}`,
        type: 'appointment',
        meetingFormat: 'in_person',
        contactType: 'lead',
        contactId: leadId,
        contactName: leadName,
        contactEmail: leadEmail,
        contactPhone: leadPhone,
        contactAddress: leadAddress,
        location: leadAddress,
        leadId: leadId
      });
    }

    // Schedule appointment for a specific lead (called from lead modal)
    function scheduleAppointmentForLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'warning');
        return;
      }

      closeLeadModal();

      // Get lead name from various possible field names
      const leadName = selectedLead.full_name || selectedLead.homeowner_name || selectedLead.name || selectedLead.email || 'Lead';
      const leadEmail = selectedLead.email || selectedLead.homeowner_email || '';
      const leadPhone = selectedLead.phone || selectedLead.homeowner_phone || '';
      const leadAddress = formatAddressFromData(selectedLead);

      // Open modal with pre-filled data
      openCalendarEventModal(null, null, {
        title: `Appointment - ${leadName}`,
        type: 'appointment',
        contactName: leadName,
        contactEmail: leadEmail,
        contactPhone: leadPhone,
        location: leadAddress,
        leadId: selectedLead.id
      });
    }

    function closeCalendarEventModal() {
      document.getElementById('calendar-event-modal').classList.remove('active');
    }

    // =============================================
    // WORKFLOW SCHEDULING (Multi-Event)
    // =============================================
    let workflowLeadData = null;
    let workflowSelectedContractors = [];

    async function openWorkflowScheduleModal(leadOrCustomer = null) {
      const modal = document.getElementById('workflow-schedule-modal');
      if (!modal) return;

      // Load contractors if needed
      if (!allContractors || allContractors.length === 0) {
        await loadContractors();
      }

      // Use provided data or selected lead
      workflowLeadData = leadOrCustomer || selectedLead;
      if (!workflowLeadData) {
        showToast('No lead or customer selected', 'warning');
        return;
      }

      // Reset form
      document.getElementById('workflow-schedule-form').reset();
      document.getElementById('workflow-lead-id').value = workflowLeadData.id || '';
      workflowSelectedContractors = [];

      // Populate customer info
      const name = workflowLeadData.full_name || workflowLeadData.name || workflowLeadData.homeowner_name || 'Customer';
      const email = workflowLeadData.email || workflowLeadData.homeowner_email || '';
      const phone = workflowLeadData.phone || workflowLeadData.homeowner_phone || '';
      const address = formatAddressFromData(workflowLeadData);

      document.getElementById('workflow-customer-avatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('workflow-customer-name').textContent = name;
      document.getElementById('workflow-customer-details').textContent = [email, phone].filter(Boolean).join('  ') || 'No contact info';
      document.getElementById('workflow-customer-address').textContent = address || 'No address provided';
      document.getElementById('workflow-homeowner-email').textContent = email || 'No email';

      // Setup event toggle listeners
      const eventTypes = ['template', 'demo', 'fabrication', 'installation', 'plumbing', 'sealer'];
      eventTypes.forEach(type => {
        const checkbox = document.getElementById(`workflow-include-${type}`);
        if (checkbox) {
          checkbox.onchange = updateWorkflowDates;
        }
      });

      // Render date inputs
      updateWorkflowDates();

      // Render contractors list
      renderWorkflowContractors();

      // Update summary
      updateWorkflowSummary();

      modal.classList.add('active');
    }

    function closeWorkflowScheduleModal() {
      document.getElementById('workflow-schedule-modal').classList.remove('active');
      workflowLeadData = null;
      workflowSelectedContractors = [];
    }

    function updateWorkflowDates() {
      const container = document.getElementById('workflow-dates-container');
      if (!container) return;

      const events = getSelectedWorkflowEvents();
      const today = new Date();
      let currentDate = new Date(today);

      container.innerHTML = events.map((evt, idx) => {
        // Suggest dates based on typical workflow
        if (idx > 0) {
          if (evt.type === 'fabrication') {
            currentDate.setDate(currentDate.getDate() + 5); // 5 days after template
          } else if (evt.type === 'installation') {
            currentDate.setDate(currentDate.getDate() + 1); // Day after fabrication
          } else {
            currentDate.setDate(currentDate.getDate() + 1);
          }
        }
        const dateStr = currentDate.toISOString().split('T')[0];

        return `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="font-size: 20px;">${evt.icon}</div>
            <div style="flex: 1;">
              <div style="font-weight: 500; font-size: 13px; color: var(--text-primary);">${evt.label}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${evt.description}</div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="date" id="workflow-date-${evt.type}" class="input-modern" value="${dateStr}" style="width: 140px; font-size: 13px; padding: 6px 10px;" onchange="updateWorkflowSummary()">
              <input type="time" id="workflow-time-${evt.type}" class="input-modern" value="${evt.defaultTime}" style="width: 100px; font-size: 13px; padding: 6px 10px;">
            </div>
          </div>
        `;
      }).join('');

      updateWorkflowSummary();
    }

    function getSelectedWorkflowEvents() {
      const events = [];

      if (document.getElementById('workflow-include-template')?.checked) {
        events.push({ type: 'template', icon: '', label: 'Template/Measure', description: 'On-site measurement', defaultTime: '09:00', eventType: 'template' });
      }
      if (document.getElementById('workflow-include-demo')?.checked) {
        events.push({ type: 'demo', icon: '', label: 'Demo/Tear-out', description: 'Remove existing countertops', defaultTime: '08:00', eventType: 'site_visit' });
      }
      if (document.getElementById('workflow-include-fabrication')?.checked) {
        events.push({ type: 'fabrication', icon: '', label: 'Fabrication', description: 'Cut & polish at shop', defaultTime: '07:00', eventType: 'fabrication' });
      }
      if (document.getElementById('workflow-include-installation')?.checked) {
        events.push({ type: 'installation', icon: '', label: 'Installation', description: 'Install at customer site', defaultTime: '08:00', eventType: 'installation' });
      }
      if (document.getElementById('workflow-include-plumbing')?.checked) {
        events.push({ type: 'plumbing', icon: '', label: 'Plumbing', description: 'Disconnect & reconnect', defaultTime: '07:30', eventType: 'plumbing_disconnect' });
      }
      if (document.getElementById('workflow-include-sealer')?.checked) {
        events.push({ type: 'sealer', icon: '', label: 'Sealer Application', description: 'Apply protective sealer', defaultTime: '10:00', eventType: 'sealer_application' });
      }

      return events;
    }

    function renderWorkflowContractors() {
      const container = document.getElementById('workflow-contractors-list');
      if (!container) return;

      if (!allContractors || allContractors.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">
            <div style="font-size: 12px;">No contractors found</div>
            <button type="button" class="btn-modern ghost" style="margin-top: 8px; font-size: 11px; padding: 6px 12px;" onclick="openAddContractorFromWorkflow()">+ Add Contractor</button>
          </div>
        `;
        return;
      }

      container.innerHTML = allContractors.map(c => {
        const name = c.name || c.company_name || c.email || 'Unknown';
        const specialty = c.specialty || 'Contractor';
        const email = c.email || '';
        const phone = c.phone || '';

        return `
          <label style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
            <input type="checkbox" class="workflow-contractor-checkbox" data-id="${c.id}" data-name="${escapeHtml(name)}" data-email="${escapeHtml(email)}" data-phone="${escapeHtml(phone)}" data-specialty="${escapeHtml(specialty)}" style="width: 16px; height: 16px; accent-color: var(--primary);" onchange="updateWorkflowParticipantCount()">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; font-size: 13px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(email || phone || 'No contact')}</div>
            </div>
            <span style="font-size: 10px; padding: 2px 6px; background: var(--dark-tertiary); color: var(--text-muted); border-radius: 4px;">${escapeHtml(specialty)}</span>
          </label>
        `;
      }).join('');
    }

    function updateWorkflowParticipantCount() {
      const checkboxes = document.querySelectorAll('.workflow-contractor-checkbox:checked');
      const homeownerChecked = document.getElementById('workflow-invite-homeowner')?.checked ? 1 : 0;
      const count = checkboxes.length + homeownerChecked;
      document.getElementById('workflow-participant-count').textContent = `${count} selected`;
    }

    function updateWorkflowSummary() {
      const events = getSelectedWorkflowEvents();
      const summary = document.getElementById('workflow-event-summary');
      if (summary) {
        summary.textContent = `${events.length} event${events.length !== 1 ? 's' : ''} will be created`;
      }
    }

    async function submitWorkflowSchedule(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('workflow-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div> Creating events...';

      try {
        const events = getSelectedWorkflowEvents();
        if (events.length === 0) {
          showToast('Please select at least one event type', 'warning');
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get participant info
        const participants = [];
        const homeownerEmail = workflowLeadData.email || workflowLeadData.homeowner_email;
        const homeownerName = workflowLeadData.full_name || workflowLeadData.name || workflowLeadData.homeowner_name || 'Customer';
        const homeownerPhone = workflowLeadData.phone || workflowLeadData.homeowner_phone || '';

        if (document.getElementById('workflow-invite-homeowner')?.checked && homeownerEmail) {
          participants.push({
            email: homeownerEmail,
            name: homeownerName,
            phone: homeownerPhone,
            role: 'customer',
            participant_type: 'attendee'
          });
        }

        // Add selected contractors
        document.querySelectorAll('.workflow-contractor-checkbox:checked').forEach(cb => {
          if (cb.dataset.email) {
            participants.push({
              email: cb.dataset.email,
              name: cb.dataset.name,
              phone: cb.dataset.phone || '',
              role: cb.dataset.specialty || 'contractor',
              participant_type: 'attendee'
            });
          }
        });

        const notes = document.getElementById('workflow-notes')?.value || '';
        const address = workflowLeadData.address || workflowLeadData.project_address || '';
        const sendEmail = document.getElementById('workflow-send-email')?.checked;
        const sendSms = document.getElementById('workflow-send-sms')?.checked;

        const createdEvents = [];

        // Create each event
        for (const evt of events) {
          const dateInput = document.getElementById(`workflow-date-${evt.type}`);
          const timeInput = document.getElementById(`workflow-time-${evt.type}`);
          if (!dateInput?.value) continue;

          const startTime = new Date(`${dateInput.value}T${timeInput?.value || '09:00'}:00`);
          const endTime = new Date(startTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours default

          const eventData = {
            title: `${evt.label} - ${homeownerName}`,
            event_type: evt.eventType,
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: evt.type === 'fabrication' ? 'Shop' : address,
            lead_id: workflowLeadData.id,
            notes: notes,
            status: 'scheduled',
            user_id: user.id,
            metadata: {
              contact_name: homeownerName,
              contact_email: homeownerEmail,
              contact_phone: homeownerPhone,
              workflow_type: evt.type
            }
          };

          // Insert event
          const { data: newEvent, error: eventError } = await supabaseClient
            .from('calendar_events')
            .insert(eventData)
            .select()
            .single();

          if (eventError) {
            console.error('Error creating event:', eventError);
            continue;
          }

          createdEvents.push({ ...newEvent, eventInfo: evt });

          // Add participants
          if (participants.length > 0 && newEvent) {
            const participantRecords = participants.map(p => ({
              event_id: newEvent.id,
              email: p.email,
              name: p.name,
              phone: p.phone,
              role: p.role,
              participant_type: p.participant_type,
              response_status: 'pending'
            }));

            await supabaseClient.from('calendar_event_participants').insert(participantRecords);
          }
        }

        // Send email invites if enabled
        if (sendEmail && createdEvents.length > 0) {
          await sendWorkflowInviteEmails(createdEvents, participants, homeownerName, address);
        }

        // Send SMS if enabled
        if (sendSms && createdEvents.length > 0) {
          await sendWorkflowSmsNotifications(createdEvents, participants);
        }

        showToast(`Created ${createdEvents.length} events and sent invitations!`, 'success');
        closeWorkflowScheduleModal();

        // Refresh calendar if visible
        if (typeof loadCalendarEvents === 'function') {
          loadCalendarEvents();
        }

      } catch (err) {
        console.error('Workflow schedule error:', err);
        showToast('Error creating events: ' + err.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Schedule & Send Invites
        `;
      }
    }

    async function sendWorkflowInviteEmails(events, participants, customerName, address) {
      try {
        const API_BASE = window.API_BASE_URL || '';

        // Format events for email
        const eventsList = events.map(e => {
          const date = new Date(e.start_time);
          return {
            type: e.eventInfo.label,
            icon: e.eventInfo.icon,
            date: date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }),
            time: date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
            location: e.location || address
          };
        });

        // Send to each participant
        for (const participant of participants) {
          if (!participant.email) continue;

          const emailData = {
            to: participant.email,
            subject: ` Project Schedule - ${customerName}`,
            customerName: participant.name || participant.email,
            projectAddress: address,
            events: eventsList,
            role: participant.role
          };

          await fetch(`${API_BASE}/api/email/workflow-invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(emailData)
          });
        }

        console.log(`Sent workflow invite emails to ${participants.length} participants`);
      } catch (err) {
        console.error('Error sending workflow emails:', err);
      }
    }

    async function sendWorkflowSmsNotifications(events, participants) {
      try {
        const API_BASE = window.API_BASE_URL || '';

        for (const participant of participants) {
          if (!participant.phone) continue;

          const firstEvent = events[0];
          const date = new Date(firstEvent.start_time);
          const message = ` You've been scheduled for ${events.length} event(s) starting ${date.toLocaleDateString()}. Check your email for details.`;

          await fetch(`${API_BASE}/api/sms/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: participant.phone,
              message: message
            })
          });
        }

        console.log(`Sent SMS notifications to ${participants.filter(p => p.phone).length} participants`);
      } catch (err) {
        console.error('Error sending SMS:', err);
      }
    }

    // Update the lead schedule button to use workflow modal
    function scheduleWorkflowForLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'warning');
        return;
      }
      closeLeadModal();
      openJobScheduler(selectedLead);
    }

    // =============================================
    // PROFILE PANEL FUNCTIONS
    // =============================================
    let currentProfileData = null;
    let currentProfileType = 'lead'; // 'lead', 'customer', 'contractor'

    // Helper function to format address from JSON object or string
    function formatAddressFromData(data) {
      if (!data) return '';

      // Check for string addresses first (most common in older leads)
      if (data.project_address && typeof data.project_address === 'string' && data.project_address.trim()) {
        return data.project_address.trim();
      }
      if (data.address && typeof data.address === 'string' && data.address.trim()) {
        return data.address.trim();
      }

      // Check for JSON object addresses (newer leads)
      let addrObj = data.service_address || data.billing_address;

      // If it's a string (could be JSON string), try to parse it
      if (typeof addrObj === 'string' && addrObj.trim()) {
        try {
          addrObj = JSON.parse(addrObj);
        } catch (e) {
          // It's a plain string address, use it directly
          return addrObj.trim();
        }
      }

      // If it's an object, format it
      if (addrObj && typeof addrObj === 'object') {
        const parts = [];
        if (addrObj.street) parts.push(addrObj.street);
        if (addrObj.street2) parts.push(addrObj.street2);
        if (addrObj.city || addrObj.state || addrObj.zip) {
          const cityStateZip = [
            addrObj.city,
            addrObj.state,
            addrObj.zip
          ].filter(Boolean).join(addrObj.city && addrObj.state ? ', ' : ' ');
          if (cityStateZip) parts.push(cityStateZip);
        }
        if (parts.length > 0) return parts.join(', ');
      }

      // Build from individual fields if available (some forms use these)
      if (data.street || data.city) {
        const parts = [];
        if (data.street) parts.push(data.street);
        if (data.city) parts.push(data.city);
        if (data.state) parts.push(data.state);
        if (data.zip || data.zip_code) parts.push(data.zip || data.zip_code);
        if (parts.length > 0) return parts.join(', ');
      }

      return '';
    }

    function openProfilePanel(data, type = 'lead') {
      currentProfileData = data;
      currentProfileType = type;

      const name = data.full_name || data.name || data.homeowner_name || 'Unknown';
      const email = data.email || data.homeowner_email || '';
      const phone = data.phone || data.homeowner_phone || '';
      const address = formatAddressFromData(data);
      const status = data.status || 'new';
      const source = data.source || data.lead_source || '';
      const message = data.message || data.notes || '';


      // Set header info - Avatar with initials
      const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
      document.getElementById('profile-avatar').innerHTML = initials;

      // Show badge for qualified/won leads
      const badge = document.getElementById('profile-avatar-badge');
      if (badge) {
        badge.style.display = (status === 'qualified' || status === 'won') ? 'flex' : 'none';
      }

      document.getElementById('panel-profile-name').textContent = name;

      // Email with clickable link
      const emailLink = document.getElementById('panel-profile-email-link');
      const emailContainer = document.getElementById('panel-profile-email');
      if (email) {
        emailLink.textContent = email;
        emailLink.href = `mailto:${email}`;
        emailContainer.style.display = 'flex';
      } else {
        emailLink.textContent = 'No email';
        emailLink.href = '#';
        emailContainer.style.display = 'flex';
      }

      // Phone with clickable link
      const phoneLink = document.getElementById('panel-profile-phone-link');
      const phoneContainer = document.getElementById('panel-profile-phone');
      if (phone) {
        phoneLink.textContent = phone;
        phoneLink.href = `tel:${phone.replace(/\D/g, '')}`;
        phoneContainer.style.display = 'flex';
      } else {
        phoneLink.textContent = 'No phone';
        phoneLink.href = '#';
        phoneContainer.style.display = 'flex';
      }

      // Set status badge
      const statusEl = document.getElementById('profile-status');
      statusEl.className = 'profile-status-badge ' + status;
      const statusLabels = {
        'new': 'New Lead',
        'contacted': 'Contacted',
        'qualified': 'Qualified',
        'quoted': 'Quoted',
        'won': 'Won',
        'lost': 'Lost',
        'archived': 'Archived'
      };
      statusEl.textContent = statusLabels[status] || status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');

      // Source tag
      const sourceTag = document.getElementById('profile-source-tag');
      const sourceText = document.getElementById('profile-source-text');
      if (source && sourceTag && sourceText) {
        sourceTag.style.display = 'inline-flex';
        sourceText.textContent = source;
      } else if (sourceTag) {
        sourceTag.style.display = 'none';
      }

      // Calculate days in pipeline
      const createdDate = data.created_at ? new Date(data.created_at) : new Date();
      const daysInPipeline = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
      document.getElementById('profile-stat-days').textContent = daysInPipeline;

      // Estimate value (from budget or default)
      const budget = data.budget_range || data.budget || '';
      let estValue = '$0';
      if (budget) {
        const match = budget.match(/\$?([\d,]+)/);
        if (match) estValue = '$' + match[1];
        else estValue = budget;
      }
      document.getElementById('profile-stat-value').textContent = estValue;

      // Set detail fields
      document.getElementById('profile-detail-email').textContent = email || '';
      document.getElementById('profile-detail-phone').textContent = phone || '';
      document.getElementById('profile-detail-address').textContent = address || '';

      // Set address link and actions
      const addressLink = document.getElementById('profile-detail-address-link');
      const addressActions = document.getElementById('profile-address-actions');
      if (address && address !== '') {
        addressLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        addressLink.style.color = '#3b82f6';
        addressActions.style.display = 'flex';
        // Store address data for navigation functions
        window.currentProfileAddress = address;
      } else {
        addressLink.href = '#';
        addressLink.style.color = 'inherit';
        addressActions.style.display = 'none';
        window.currentProfileAddress = null;
      }

      const projectType = data.project_type || data.service_type || '';
      document.getElementById('profile-detail-project-type').textContent = projectType || '';

      // Format project type nicely
      if (projectType) {
        const projectTypeEl = document.getElementById('profile-detail-project-type');
        const typeLabels = {
          'kitchen': 'Kitchen Countertops',
          'bathroom': 'Bathroom Vanity',
          'flooring': 'Flooring',
          'fireplace': 'Fireplace',
          'outdoor': 'Outdoor Kitchen',
          'commercial': 'Commercial Project'
        };
        projectTypeEl.textContent = typeLabels[projectType] || projectType;
      }

      document.getElementById('profile-detail-budget').textContent = budget || '';
      document.getElementById('profile-detail-timeline').textContent = data.timeline || data.preferred_timeline || '';
      document.getElementById('profile-detail-source').textContent = source || '';

      // Show original message if present
      const messageSection = document.getElementById('profile-message-section');
      const messageEl = document.getElementById('profile-detail-message');
      if (message && messageSection && messageEl) {
        messageSection.style.display = 'block';
        messageEl.textContent = message;
      } else if (messageSection) {
        messageSection.style.display = 'none';
      }

      // Load appointments, notes, etc. and update tab badges
      loadProfileAppointments(data.id);
      loadProfileNotes(data.id);
      loadProfileActivity(data.id);
      loadProfileMessages(data.id);

      // Reset tab badges (will be updated by load functions)
      document.getElementById('tab-badge-appointments').textContent = '0';
      document.getElementById('tab-badge-notes').textContent = '0';
      document.getElementById('tab-badge-files').textContent = '0';
      document.getElementById('tab-badge-messages').textContent = '0';
      document.getElementById('profile-stat-appointments').textContent = '0';
      document.getElementById('profile-stat-messages').textContent = '0';

      // Switch to overview tab
      switchProfileTab('overview');

      // Update archive button based on current status
      updateArchiveButton(status === 'archived');

      // Show panel
      document.getElementById('profile-panel-overlay').classList.add('active');
    }

    // Helper function for copying to clipboard
    function copyToClipboard(text, successMessage) {
      if (!text || text === '') return;
      navigator.clipboard.writeText(text).then(() => {
        showToast(successMessage || 'Copied to clipboard', 'success');
      }).catch(err => {
        console.error('Copy failed:', err);
      });
    }

    // Copy profile link
    function copyProfileLink() {
      if (currentProfileData) {
        const link = `${window.location.origin}/account/#leads?id=${currentProfileData.id}`;
        copyToClipboard(link, 'Link copied to clipboard');
      }
    }

    // Print profile (simple version)
    function printProfile() {
      showToast('Print feature coming soon', 'info');
    }

    // Load messages for profile
    async function loadProfileMessages(entityId) {
      // Placeholder - will be enhanced with actual email history
      const msgCount = 0;
      document.getElementById('tab-badge-messages').textContent = msgCount;
      document.getElementById('profile-stat-messages').textContent = msgCount;
    }

    function closeProfilePanel() {
      document.getElementById('profile-panel-overlay').classList.remove('active');
      currentProfileData = null;
      window.currentProfileAddress = null;
    }

    // Open directions from profile panel
    function openDirectionsFromProfile() {
      if (!window.currentProfileAddress) {
        showToast('No address available', 'warning');
        return;
      }
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if (isIOS && confirm('Open in Apple Maps instead of Google Maps?')) {
        window.open(`https://maps.apple.com/?daddr=${encodeURIComponent(window.currentProfileAddress)}`, '_blank');
      } else {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(window.currentProfileAddress)}`, '_blank');
      }
    }

    // Share en route status from profile panel (for leads)
    async function shareEnRouteFromProfile() {
      if (!currentProfileData || !window.currentProfileAddress) {
        showToast('No address available', 'warning');
        return;
      }

      const name = currentProfileData.full_name || currentProfileData.name || currentProfileData.homeowner_name || 'Customer';
      const address = window.currentProfileAddress;

      // Simple version for leads - just navigate and optionally notify
      const choice = await showEnRouteOptions(name, address);
      if (!choice) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Log activity for the lead
        if (choice !== 'navigate_only' && currentProfileData.id) {
          await supabaseClient.from('lead_activity').insert({
            lead_id: currentProfileData.id,
            user_id: user.id,
            type: 'en_route',
            message: `${userProfile?.full_name || 'Team member'} is en route to visit`,
            created_at: new Date().toISOString()
          }).then(() => {}).catch(() => {}); // Don't fail if table doesn't exist

          showToast('En Route status logged!', 'success');
        }

        // Open navigation
        if (choice === 'navigate_notify' || choice === 'navigate_only') {
          openDirectionsFromProfile();
        }

        // Send notification to customer if they have email
        if (choice === 'navigate_notify' && currentProfileData.email) {
          try {
            await fetch(`${API_BASE}/api/notifications/en-route`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                customer_email: currentProfileData.email,
                customer_name: name,
                team_member: userProfile?.full_name || 'Our team',
                project_address: address
              })
            });
            showToast('Customer notified!', 'success');
          } catch (e) {
            console.warn('Could not send en route notification:', e);
          }
        }
      } catch (err) {
        console.error('Error with en route:', err);
        showToast('Error updating status', 'error');
      }
    }

    function switchProfileTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Show/hide content
      document.querySelectorAll('.profile-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      const targetContent = document.getElementById(`profile-tab-${tabName}`);
      if (targetContent) targetContent.style.display = 'block';
    }

    async function loadProfileAppointments(entityId) {
      const container = document.getElementById('profile-appointments-list');
      try {
        const { data: events, error } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('lead_id', entityId)
          .order('start_time', { ascending: true });

        // Update badge counts
        const count = events?.length || 0;
        document.getElementById('tab-badge-appointments').textContent = count;
        document.getElementById('tab-badge-appointments').className = count > 0 ? 'tab-badge' : 'tab-badge muted';
        document.getElementById('profile-stat-appointments').textContent = count;

        if (error || !events || events.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Appointments Yet</div>
              <div style="font-size: 13px; max-width: 280px; margin: 0 auto;">Click "Schedule" to plan job phases like templating, fabrication, and installation</div>
            </div>
          `;
          return;
        }

        const typeIcons = {
          'template': '', 'measurement': '', 'fabrication': '',
          'installation': '', 'plumbing_disconnect': '', 'plumbing_reconnect': '',
          'appointment': '', 'consultation': '', 'sealer_application': '',
          'walk_through': '', 'final_inspection': '', 'delivery': '', 'demo': ''
        };

        container.innerHTML = events.map(evt => {
          const date = new Date(evt.start_time);
          const endDate = evt.end_time ? new Date(evt.end_time) : null;
          const now = new Date();
          const isPast = date < now;
          const isToday = date.toDateString() === now.toDateString();

          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

          const statusClass = evt.status === 'completed' ? 'completed' : (evt.status === 'cancelled' ? 'cancelled' : 'scheduled');

          return `
            <div class="appointment-card ${isPast ? 'past' : ''}" style="${isPast ? 'opacity: 0.7;' : ''}">
              <div class="appointment-date-box">
                <div class="appointment-month">${monthNames[date.getMonth()]}</div>
                <div class="appointment-day">${date.getDate()}</div>
                <div class="appointment-weekday">${dayNames[date.getDay()]}</div>
              </div>
              <div class="appointment-info">
                <div class="appointment-title">${typeIcons[evt.event_type] || ''} ${escapeHtml(evt.title)}</div>
                <div class="appointment-time">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}${endDate ? ' - ' + endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : ''}
                  ${isToday ? '<span style="background: var(--primary); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; margin-left: 8px;">TODAY</span>' : ''}
                </div>
                <div class="appointment-meta">
                  ${evt.location ? `<span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${escapeHtml(evt.location.substring(0, 30))}${evt.location.length > 30 ? '...' : ''}</span>` : ''}
                  <span class="appointment-status ${statusClass}">${evt.status || 'Scheduled'}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading appointments:', err);
      }
    }

    async function loadProfileNotes(entityId) {
      const container = document.getElementById('profile-notes-list');
      if (!currentProfileData) return;

      // Check for notes in the lead data (stored as JSON array or string)
      let notes = [];
      try {
        if (currentProfileData.notes_history) {
          notes = typeof currentProfileData.notes_history === 'string'
            ? JSON.parse(currentProfileData.notes_history)
            : currentProfileData.notes_history;
        }
      } catch (e) {
        console.warn('Error parsing notes:', e);
      }

      // Also check for legacy notes field (plain text)
      const legacyNote = currentProfileData.notes || currentProfileData.message;

      // Update badge count
      const noteCount = notes.length + (legacyNote ? 1 : 0);
      document.getElementById('tab-badge-notes').textContent = noteCount;
      document.getElementById('tab-badge-notes').className = noteCount > 0 ? 'tab-badge' : 'tab-badge muted';

      if (notes.length === 0 && !legacyNote) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Notes Yet</div>
            <div style="font-size: 13px;">Add notes to track important details about this lead</div>
          </div>
        `;
        return;
      }

      let html = '';

      // Show structured notes first
      if (Array.isArray(notes) && notes.length > 0) {
        html += notes.map(note => `
          <div class="note-card">
            <div class="note-header">
              <span class="note-author">${escapeHtml(note.author || 'Staff')}</span>
              <span class="note-time">${note.created_at ? new Date(note.created_at).toLocaleString() : 'Unknown date'}</span>
            </div>
            <div class="note-content">${escapeHtml(note.text || note.content || '')}</div>
          </div>
        `).join('');
      }

      // Show legacy notes
      if (legacyNote) {
        html += `
          <div class="note-card" style="border-left-color: #3b82f6;">
            <div class="note-header">
              <span class="note-author">Original Message</span>
              <span class="note-time">${currentProfileData.created_at ? new Date(currentProfileData.created_at).toLocaleString() : ''}</span>
            </div>
            <div class="note-content">${escapeHtml(legacyNote)}</div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function loadProfileActivity(entityId) {
      const container = document.getElementById('profile-activity-list');
      try {
        const { data: activities, error } = await supabaseClient
          .from('portal_activity')
          .select('*')
          .eq('lead_id', entityId)
          .order('created_at', { ascending: false })
          .limit(20);

        if (error || !activities || activities.length === 0) {
          return; // Keep placeholder
        }

        const activityIcons = {
          'portal_viewed': '', 'estimate_viewed': '', 'estimate_approved': '',
          'message_sent': '', 'appointment_confirmed': '', 'payment_made': ''
        };

        container.innerHTML = activities.map(act => `
          <div class="activity-item">
            <div class="activity-icon">${activityIcons[act.action_type] || ''}</div>
            <div class="activity-content">
              <div class="activity-text">${escapeHtml(act.action_type.replace(/_/g, ' '))}</div>
              <div class="activity-time">${new Date(act.created_at).toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    function addNewNote() {
      document.getElementById('profile-notes-input').style.display = 'block';
      document.getElementById('new-note-text').focus();
    }

    function cancelNewNote() {
      document.getElementById('profile-notes-input').style.display = 'none';
      document.getElementById('new-note-text').value = '';
    }

    async function saveNewNote() {
      const text = document.getElementById('new-note-text').value.trim();
      if (!text || !currentProfileData) {
        showToast('No note text entered', 'warning');
        return;
      }

      try {
        // Get current user
        const { data: { user } } = await supabaseClient.auth.getUser();
        const authorName = user?.email || 'Staff';

        // Get existing notes or create new array
        let notesHistory = [];
        try {
          if (currentProfileData.notes_history) {
            notesHistory = typeof currentProfileData.notes_history === 'string'
              ? JSON.parse(currentProfileData.notes_history)
              : currentProfileData.notes_history;
          }
        } catch (e) {
          notesHistory = [];
        }

        // Add new note
        const newNote = {
          id: Date.now().toString(),
          text: text,
          author: authorName,
          created_at: new Date().toISOString()
        };
        notesHistory.unshift(newNote);

        // Determine table based on profile type
        const table = currentProfileType === 'customer' ? 'customers' : 'leads';

        // Save to database
        const { error } = await supabaseClient
          .from(table)
          .update({ notes_history: notesHistory })
          .eq('id', currentProfileData.id);

        if (error) throw error;

        // Update local data
        currentProfileData.notes_history = notesHistory;

        // Update allLeads array if it's a lead
        if (currentProfileType === 'lead') {
          const leadIndex = allLeads.findIndex(l => l.id === currentProfileData.id);
          if (leadIndex !== -1) {
            allLeads[leadIndex].notes_history = notesHistory;
          }
        }

        showToast('Note saved', 'success');
        cancelNewNote();

        // Refresh notes display
        loadProfileNotes(currentProfileData.id);

      } catch (err) {
        console.error('Error saving note:', err);
        showToast('Error saving note: ' + err.message, 'error');
      }
    }

    // File Upload functionality
    function uploadAttachment() {
      if (!currentProfileData) {
        showToast('No profile selected', 'warning');
        return;
      }

      // Create file input dynamically
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*,.pdf,.doc,.docx,.xls,.xlsx';
      fileInput.multiple = true;
      fileInput.style.display = 'none';

      fileInput.onchange = async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        showToast(`Uploading ${files.length} file(s)...`, 'info');

        for (const file of files) {
          try {
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
              showToast(`${file.name} is too large (max 10MB)`, 'error');
              continue;
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            const fileName = `${currentProfileType}_${currentProfileData.id}/${Date.now()}_${file.name}`;

            // Upload to Supabase Storage
            const { data, error } = await supabaseClient.storage
              .from('attachments')
              .upload(fileName, file);

            if (error) throw error;

            // Get public URL
            const { data: urlData } = supabaseClient.storage
              .from('attachments')
              .getPublicUrl(fileName);

            // Add to attachments display
            addAttachmentToDisplay(file.name, urlData.publicUrl, file.type);

            showToast(`${file.name} uploaded`, 'success');
          } catch (err) {
            console.error('Upload error:', err);
            showToast(`Error uploading ${file.name}: ${err.message}`, 'error');
          }
        }
      };

      document.body.appendChild(fileInput);
      fileInput.click();
      document.body.removeChild(fileInput);
    }

    function addAttachmentToDisplay(name, url, type) {
      const container = document.getElementById('profile-attachments-list');
      const icon = type.includes('image') ? '' : type.includes('pdf') ? '' : '';

      const attachmentHtml = `
        <div class="attachment-card" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 8px;">
          <span style="font-size: 24px;">${icon}</span>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
            <div style="font-size: 12px; color: var(--text-muted);">Just now</div>
          </div>
          <a href="${url}" target="_blank" class="btn-modern ghost" style="padding: 6px 12px; font-size: 12px;">View</a>
        </div>
      `;

      // Remove empty state if present
      if (container.querySelector('svg')) {
        container.innerHTML = attachmentHtml;
      } else {
        container.insertAdjacentHTML('afterbegin', attachmentHtml);
      }
    }

    // Message composer
    function composeMessage() {
      if (!currentProfileData) {
        showToast('No profile selected', 'warning');
        return;
      }

      const email = currentProfileData.email || currentProfileData.homeowner_email;
      if (!email) {
        showToast('No email address available', 'warning');
        return;
      }

      // Save profile data before closing
      const data = currentProfileData;
      closeProfilePanel();

      // Open email modal for the lead
      if (currentProfileType === 'lead') {
        selectedLead = data;
        openLeadEmailModal(data.id);
      } else {
        // For customers, use mailto as fallback
        window.location.href = `mailto:${email}`;
      }
    }

    function openJobSchedulerFromProfile() {
      // Save data before closing (closeProfilePanel sets currentProfileData to null)
      const data = currentProfileData;
      closeProfilePanel();
      if (data) {
        openJobScheduler(data);
      }
    }

    function createEstimateFromProfile() {
      // Save data before closing
      const data = currentProfileData;
      closeProfilePanel();
      if (data) {
        // Navigate to estimates and create new
        showPage('estimates');
        setTimeout(() => {
          if (typeof openNewEstimateModal === 'function') {
            openNewEstimateModal(data);
          }
        }, 300);
      }
    }

    function sendMessageFromProfile() {
      composeMessage();
    }

    function openPortalFromProfile() {
      if (currentProfileData && currentProfileData.portal_token) {
        window.open(`/portal/?token=${currentProfileData.portal_token}`, '_blank');
      } else {
        showToast('No portal access configured', 'warning');
      }
    }

    async function archiveLeadFromProfile() {
      if (!currentProfileData) return;

      const isArchived = currentProfileData.status === 'archived';
      const newStatus = isArchived ? 'new' : 'archived';
      const action = isArchived ? 'restore' : 'archive';

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus })
          .eq('id', currentProfileData.id);

        if (error) throw error;

        // Update local data
        currentProfileData.status = newStatus;
        const index = allLeads.findIndex(l => l.id === currentProfileData.id);
        if (index !== -1) {
          allLeads[index].status = newStatus;
        }

        // Update archive button text
        updateArchiveButton(newStatus === 'archived');

        // Refresh display
        updateStats();
        renderLeads();

        showToast(isArchived ? 'Lead restored successfully' : 'Lead archived successfully', 'success');
      } catch (err) {
        console.error('Error archiving lead:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function updateArchiveButton(isArchived) {
      const titleEl = document.getElementById('archive-btn-title');
      const descEl = document.getElementById('archive-btn-desc');
      if (titleEl) titleEl.textContent = isArchived ? 'Restore Lead' : 'Archive Lead';
      if (descEl) descEl.textContent = isArchived ? 'Move back to active' : 'Hide from active list';
    }

    async function quickArchiveLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const isArchived = lead.status === 'archived';
      const newStatus = isArchived ? 'new' : 'archived';

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus })
          .eq('id', leadId);

        if (error) throw error;

        // Update local data
        lead.status = newStatus;

        // Refresh display
        updateStats();
        renderLeads();

        showToast(isArchived ? 'Lead restored' : 'Lead archived', 'success');
      } catch (err) {
        console.error('Error archiving lead:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickDeleteLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const leadName = lead.full_name || lead.homeowner_name || lead.name || 'this lead';

      // Show confirmation dialog
      if (!confirm(`Are you sure you want to permanently delete "${leadName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', leadId);

        if (error) throw error;

        // Remove from local data
        const index = allLeads.findIndex(l => l.id === leadId);
        if (index !== -1) {
          allLeads.splice(index, 1);
        }

        // Close profile panel if this lead was open
        if (currentProfileData && currentProfileData.id === leadId) {
          closeProfilePanel();
        }

        // Refresh display
        updateStats();
        renderLeads();

        showToast('Lead deleted permanently', 'success');
      } catch (err) {
        console.error('Error deleting lead:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function editProfileRecord() {
      // Save data before closing (closeProfilePanel sets currentProfileData to null)
      const data = currentProfileData;
      const type = currentProfileType;
      closeProfilePanel();
      if (type === 'lead' && data) {
        selectedLead = data;
        openEditLeadModal(data);
      }
    }

    function openEditLeadModal(lead) {
      editingLeadId = lead.id;

      // Update modal title for edit mode
      const modalTitle = document.querySelector('#add-lead-modal .modal-title');
      if (modalTitle) modalTitle.textContent = 'Edit Lead';

      // Parse name into first/last
      const fullName = lead.full_name || lead.name || '';
      const nameParts = fullName.trim().split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      // Populate basic fields
      document.getElementById('new-lead-first-name').value = firstName;
      document.getElementById('new-lead-last-name').value = lastName;
      document.getElementById('new-lead-email').value = lead.email || '';
      document.getElementById('new-lead-phone').value = lead.phone || '';
      document.getElementById('new-lead-project-type').value = lead.project_type || '';
      document.getElementById('new-lead-zip').value = lead.zip_code || '';

      // Populate billing address
      const billing = lead.billing_address || {};
      if (typeof billing === 'object') {
        document.getElementById('new-lead-billing-street').value = billing.street || '';
        document.getElementById('new-lead-billing-street2').value = billing.street2 || '';
        document.getElementById('new-lead-billing-city').value = billing.city || '';
        document.getElementById('new-lead-billing-state').value = billing.state || 'AZ';
        document.getElementById('new-lead-billing-zip').value = billing.zip || '';
      }

      // Handle service address
      const addressSame = lead.address_same !== false;
      document.getElementById('new-lead-address-same').checked = addressSame;
      toggleNewLeadServiceAddress();

      if (!addressSame && lead.service_address) {
        const service = lead.service_address;
        if (typeof service === 'object') {
          document.getElementById('new-lead-service-street').value = service.street || '';
          document.getElementById('new-lead-service-street2').value = service.street2 || '';
          document.getElementById('new-lead-service-city').value = service.city || '';
          document.getElementById('new-lead-service-state').value = service.state || 'AZ';
          document.getElementById('new-lead-service-zip').value = service.zip || '';
        }
      }

      // Populate status and source
      const statusSelect = document.getElementById('new-lead-status');
      const sourceSelect = document.getElementById('new-lead-source');
      if (statusSelect) statusSelect.value = lead.status || 'new';
      if (sourceSelect) sourceSelect.value = lead.source || 'manual';

      // Populate message (strip any appointment info if present)
      let message = lead.message || '';
      const apptInfoIndex = message.indexOf('\n\nSCHEDULED APPOINTMENT:');
      if (apptInfoIndex > -1) message = message.substring(0, apptInfoIndex);
      document.getElementById('new-lead-message').value = message;

      // Open the modal
      document.getElementById('add-lead-modal').classList.add('active');
    }

    // =============================================
    // JOB PHASE SCHEDULER FUNCTIONS
    // =============================================
    let schedulerData = null;
    let jobPhases = [];
    let schedulerContractors = [];

    const DEFAULT_JOB_PHASES = [
      { id: 'template', name: 'Template/Measure', icon: '', type: 'template', duration: 60, defaultTime: '09:00', daysBeforeInstall: null, enabled: true },
      { id: 'demo', name: 'Demo/Tear-out', icon: '', type: 'site_visit', duration: 120, defaultTime: '08:00', daysBeforeInstall: 1, enabled: false },
      { id: 'plumbing_disconnect', name: 'Plumbing Disconnect', icon: '', type: 'plumbing_disconnect', duration: 60, defaultTime: '07:30', daysBeforeInstall: 0, enabled: false },
      { id: 'fabrication', name: 'Fabrication', icon: '', type: 'fabrication', duration: 480, defaultTime: '07:00', daysBeforeInstall: null, enabled: true, isShopWork: true },
      { id: 'installation', name: 'Installation', icon: '', type: 'installation', duration: 240, defaultTime: '08:00', daysBeforeInstall: 0, enabled: true, isAnchor: true },
      { id: 'plumbing_reconnect', name: 'Plumbing Reconnect', icon: '', type: 'plumbing_reconnect', duration: 60, defaultTime: '14:00', daysBeforeInstall: 0, enabled: false },
      { id: 'sealer', name: 'Sealer Application', icon: '', type: 'sealer_application', duration: 60, defaultTime: '10:00', daysBeforeInstall: -1, enabled: false },
      { id: 'walkthrough', name: 'Final Walk-through', icon: '', type: 'walk_through', duration: 30, defaultTime: '16:00', daysBeforeInstall: -1, enabled: false }
    ];

    function openJobScheduler(data) {
      schedulerData = data;
      jobPhases = JSON.parse(JSON.stringify(DEFAULT_JOB_PHASES));
      schedulerContractors = [];

      const name = data.full_name || data.name || data.homeowner_name || 'Customer';
      const address = formatAddressFromData(data);
      const phone = data.phone || data.homeowner_phone || '';
      const email = data.email || data.homeowner_email || '';

      // Set avatar initials
      const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
      const avatarEl = document.getElementById('scheduler-avatar');
      if (avatarEl) avatarEl.textContent = initials;

      document.getElementById('scheduler-customer-name').textContent = name;
      document.getElementById('scheduler-detail-name').textContent = name;
      document.getElementById('scheduler-detail-address').textContent = address || '';
      document.getElementById('scheduler-detail-phone').textContent = phone || '';

      // Set default install date (7 days from now)
      const installDate = new Date();
      installDate.setDate(installDate.getDate() + 7);
      document.getElementById('scheduler-install-date').value = installDate.toISOString().split('T')[0];

      recalculatePhases();
      renderJobPhases();
      renderSchedulerTimeline();

      document.getElementById('job-scheduler-panel').classList.add('active');
    }

    function closeJobScheduler() {
      document.getElementById('job-scheduler-panel').classList.remove('active');
      schedulerData = null;
    }

    function recalculatePhases() {
      const installDateStr = document.getElementById('scheduler-install-date').value;
      if (!installDateStr) return;

      const installDate = new Date(installDateStr + 'T00:00:00');
      const leadTimeFab = parseInt(document.getElementById('lead-time-fab').value) || 3;
      const leadTimeTemplate = parseInt(document.getElementById('lead-time-template').value) || 5;

      jobPhases.forEach(phase => {
        if (phase.id === 'installation') {
          phase.date = new Date(installDate);
        } else if (phase.id === 'fabrication') {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - leadTimeFab);
        } else if (phase.id === 'template') {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - leadTimeFab - leadTimeTemplate);
        } else if (phase.id === 'demo') {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - 1);
        } else if (phase.daysBeforeInstall !== null) {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - phase.daysBeforeInstall);
        }
      });

      renderJobPhases();
      renderSchedulerTimeline();
    }

    function renderJobPhases() {
      const container = document.getElementById('job-phases-container');
      container.innerHTML = jobPhases.map(phase => `
        <div class="phase-card ${phase.enabled ? 'selected' : ''}" onclick="togglePhase('${phase.id}')">
          <div class="phase-header">
            <div class="phase-icon">${phase.icon}</div>
            <div style="flex: 1;">
              <div class="phase-title">${phase.name}</div>
              <div class="phase-subtitle">${phase.isShopWork ? 'Shop work' : 'On-site'}  ${Math.floor(phase.duration / 60)}h ${phase.duration % 60}m</div>
            </div>
            <label style="display: flex; align-items: center;" onclick="event.stopPropagation()">
              <input type="checkbox" ${phase.enabled ? 'checked' : ''} onchange="togglePhase('${phase.id}')" style="accent-color: var(--primary); width: 18px; height: 18px;">
            </label>
          </div>
          ${phase.enabled ? `
            <div class="phase-date-row">
              <input type="date" value="${phase.date ? phase.date.toISOString().split('T')[0] : ''}"
                onchange="updatePhaseDate('${phase.id}', this.value)"
                onclick="event.stopPropagation()"
                class="input-modern" style="flex: 1; font-size: 13px; padding: 8px;">
              <input type="time" value="${phase.defaultTime}"
                onchange="updatePhaseTime('${phase.id}', this.value)"
                onclick="event.stopPropagation()"
                class="input-modern" style="width: 100px; font-size: 13px; padding: 8px;">
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function togglePhase(phaseId) {
      const phase = jobPhases.find(p => p.id === phaseId);
      if (phase && !phase.isAnchor) {
        phase.enabled = !phase.enabled;
        if (phase.enabled) recalculatePhases();
        renderJobPhases();
        renderSchedulerTimeline();
      }
    }

    function updatePhaseDate(phaseId, dateStr) {
      const phase = jobPhases.find(p => p.id === phaseId);
      if (phase) {
        phase.date = new Date(dateStr + 'T00:00:00');
        renderSchedulerTimeline();
      }
    }

    function updatePhaseTime(phaseId, timeStr) {
      const phase = jobPhases.find(p => p.id === phaseId);
      if (phase) {
        phase.defaultTime = timeStr;
      }
    }

    function renderSchedulerTimeline() {
      const container = document.getElementById('scheduler-timeline-preview');
      const enabledPhases = jobPhases.filter(p => p.enabled && p.date).sort((a, b) => a.date - b.date);

      if (enabledPhases.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 30px 0; color: var(--text-muted);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.4; margin-bottom: 10px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <div style="font-size: 13px;">Enable phases to see timeline</div>
          </div>
        `;
        return;
      }

      container.innerHTML = enabledPhases.map((phase, idx) => {
        const isLast = idx === enabledPhases.length - 1;
        const isInstall = phase.id === 'installation';
        return `
          <div class="timeline-preview-item">
            <div class="timeline-preview-dot ${isInstall ? 'active' : ''}">${phase.icon}</div>
            <div class="timeline-preview-content">
              <div class="timeline-preview-date">${phase.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
              <div class="timeline-preview-title">${phase.name}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function resetPhases() {
      jobPhases = JSON.parse(JSON.stringify(DEFAULT_JOB_PHASES));
      recalculatePhases();
    }

    async function saveJobPhases() {
      const enabledPhases = jobPhases.filter(p => p.enabled && p.date);
      if (enabledPhases.length === 0) {
        showToast('Please enable at least one phase', 'warning');
        return;
      }

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        showToast('Not authenticated', 'error');
        return;
      }

      const name = schedulerData.full_name || schedulerData.name || schedulerData.homeowner_name || 'Customer';
      const email = schedulerData.email || schedulerData.homeowner_email || '';
      const phone = schedulerData.phone || schedulerData.homeowner_phone || '';
      const address = formatAddressFromData(schedulerData);

      const createdEvents = [];

      for (const phase of enabledPhases) {
        const startTime = new Date(phase.date);
        const [hours, mins] = phase.defaultTime.split(':');
        startTime.setHours(parseInt(hours), parseInt(mins), 0, 0);

        const endTime = new Date(startTime.getTime() + phase.duration * 60 * 1000);

        const eventData = {
          title: `${phase.name} - ${name}`,
          event_type: phase.type,
          start_time: startTime.toISOString(),
          end_time: endTime.toISOString(),
          location: phase.isShopWork ? 'Shop' : address,
          lead_id: schedulerData.id,
          status: 'scheduled',
          user_id: user.id,
          metadata: {
            contact_name: name,
            contact_email: email,
            contact_phone: phone,
            phase_id: phase.id
          }
        };

        const { data: newEvent, error } = await supabaseClient
          .from('calendar_events')
          .insert(eventData)
          .select()
          .single();

        if (!error && newEvent) {
          createdEvents.push({ ...newEvent, phaseInfo: phase });
        }
      }

      // Send notifications
      const notifyCustomer = document.getElementById('scheduler-notify-customer').checked;
      const notifyContractors = document.getElementById('scheduler-notify-contractors').checked;

      if (notifyCustomer && email) {
        await sendWorkflowInviteEmails(createdEvents, [{ email, name, phone, role: 'customer' }], name, address);
      }

      showToast(`Created ${createdEvents.length} job phases!`, 'success');
      closeJobScheduler();

      // Refresh calendar if visible
      if (typeof loadCalendarEvents === 'function') {
        loadCalendarEvents();
      }
    }

    function openContractorPicker() {
      // Create contractor picker modal dynamically
      let modal = document.getElementById('contractor-picker-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'contractor-picker-modal';
        modal.className = 'modal-overlay';
        modal.style.zIndex = '100001';
        modal.innerHTML = `
          <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
              <h2 class="modal-title">Assign Contractor</h2>
              <button class="modal-close" onclick="closeContractorPicker()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="modal-body" id="contractor-picker-list" style="max-height: 400px; overflow-y: auto;">
              <div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading contractors...</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-modern secondary" onclick="closeContractorPicker()">Cancel</button>
            </div>
          </div>
        `;
        modal.onclick = (e) => { if (e.target === modal) closeContractorPicker(); };
        document.body.appendChild(modal);
      }

      // Populate contractor list
      const listContainer = document.getElementById('contractor-picker-list');
      if (allContractors && allContractors.length > 0) {
        listContainer.innerHTML = allContractors.map(c => {
          const name = c.name || c.company_name || c.email || 'Unknown';
          const specialty = c.specialty ? c.specialty.replace('_', ' ') : '';
          const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
          const isAssigned = schedulerContractors.some(sc => sc.id === c.id);
          return `
            <div class="contractor-picker-item" style="display: flex; align-items: center; padding: 14px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; ${isAssigned ? 'opacity: 0.5; pointer-events: none;' : ''}" onclick="assignContractorToJob('${c.id}')">
              <div style="width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #e6b800); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #000; margin-right: 14px;">${initials}</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(name)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${specialty}${c.email ? '  ' + c.email : ''}</div>
              </div>
              ${isAssigned ? '<span style="color: var(--success); font-size: 12px; font-weight: 600;">Assigned</span>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>'}
            </div>
          `;
        }).join('');
      } else {
        listContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.5;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <div style="font-weight: 600; margin-bottom: 4px;">No Contractors Available</div>
            <div style="font-size: 13px;">Add contractors in the Team section first.</div>
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeContractorPicker() {
      const modal = document.getElementById('contractor-picker-modal');
      if (modal) modal.classList.remove('active');
    }

    function openAddContractorFromWorkflow() {
      // Open the contractor picker from workflow context
      openContractorPicker();
    }

    function assignContractorToJob(contractorId) {
      const contractor = allContractors.find(c => c.id === contractorId);
      if (!contractor) return;

      // Add to scheduler contractors list
      if (!schedulerContractors.some(c => c.id === contractorId)) {
        schedulerContractors.push(contractor);
        updateSchedulerContractorsList();
      }

      closeContractorPicker();
      showToast(`${contractor.name || 'Contractor'} assigned to job`, 'success');
    }

    function removeContractorFromJob(contractorId) {
      schedulerContractors = schedulerContractors.filter(c => c.id !== contractorId);
      updateSchedulerContractorsList();
    }

    function updateSchedulerContractorsList() {
      const container = document.getElementById('scheduler-contractors-list');
      if (!container) return;

      if (schedulerContractors.length === 0) {
        container.innerHTML = `
          <button class="btn-modern ghost" style="width: 100%; font-size: 13px; padding: 14px;" onclick="openContractorPicker()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            Add Contractor
          </button>
        `;
        return;
      }

      container.innerHTML = schedulerContractors.map(c => {
        const name = c.name || c.company_name || 'Contractor';
        const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
        const specialty = c.specialty ? c.specialty.replace('_', ' ') : '';
        return `
          <div style="display: flex; align-items: center; padding: 10px 12px; background: var(--dark-elevated); border-radius: 10px; margin-bottom: 8px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #e6b800); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #000; margin-right: 12px;">${initials}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${escapeHtml(name)}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${specialty}</div>
            </div>
            <button onclick="removeContractorFromJob('${c.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;" title="Remove">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('') + `
        <button class="btn-modern ghost" style="width: 100%; font-size: 12px; padding: 10px; margin-top: 4px;" onclick="openContractorPicker()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Another
        </button>
      `;
    }

    function showAddPhaseOptions() {
      // TODO: Show custom phase options
      showToast('Custom phases coming soon', 'info');
    }

    // Connect lead row clicks to open profile panel
    function openLeadProfile(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (lead) {
        openProfilePanel(lead, 'lead');
      }
    }

    function populateEventCustomerDropdown() {
      const select = document.getElementById('cal-event-customer');
      select.innerHTML = '<option value="">-- None --</option>';
      if (allCustomers && allCustomers.length > 0) {
        allCustomers.forEach(c => {
          select.innerHTML += `<option value="${c.id}">${escapeHtml(c.name)}${c.email ? ' (' + c.email + ')' : ''}</option>`;
        });
      }
    }

    function populateEventJobDropdown() {
      const select = document.getElementById('cal-event-job');
      select.innerHTML = '<option value="">-- None --</option>';
      if (allJobs && allJobs.length > 0) {
        allJobs.forEach(j => {
          const label = (j.job_number || 'Job') + ' - ' + (j.customer_name || j.description || 'Untitled');
          select.innerHTML += `<option value="${j.id}">${escapeHtml(label)}</option>`;
        });
      }
    }

    function populateEventLeadDropdown() {
      const select = document.getElementById('cal-event-lead');
      if (!select) return;
      select.innerHTML = '<option value="">-- None --</option>';
      if (allLeads && allLeads.length > 0) {
        // Show recent leads first (up to 50)
        const recentLeads = allLeads.slice(0, 50);
        recentLeads.forEach(l => {
          const name = l.full_name || l.email || 'Unknown';
          const statusBadge = l.status ? ` [${l.status}]` : '';
          select.innerHTML += `<option value="${l.id}">${escapeHtml(name)}${statusBadge}</option>`;
        });
      }
    }

    function populateEventProjectDropdown() {
      const select = document.getElementById('cal-event-project-select');
      const hiddenInput = document.getElementById('cal-event-project');
      if (!select) return;
      select.innerHTML = '<option value="">-- None --</option>';
      // allJobs now contains projects (single source of truth)
      if (allJobs && allJobs.length > 0) {
        allJobs.forEach(p => {
          const name = p.customer_name || p.name || p.description || 'Untitled Project';
          const jobNum = p.job_number ? `${p.job_number} - ` : '';
          select.innerHTML += `<option value="${p.id}">${escapeHtml(jobNum + name)}</option>`;
        });
      }
      // Sync with hidden input
      select.addEventListener('change', function() {
        if (hiddenInput) hiddenInput.value = this.value;
      });
      // Set initial value from hidden input
      if (hiddenInput && hiddenInput.value) {
        select.value = hiddenInput.value;
      }
    }

    // Load contractors from database
    async function loadContractors() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Load from contractors table
        const { data: contractors, error } = await supabaseClient
          .from('contractors')
          .select('id, name, company_name, email, phone, specialty, status')
          .order('name');

        if (error) {
          console.warn('Could not load contractors:', error.message);
          // Try loading from sg_users with contractor account type as fallback
          const { data: teamUsers, error: teamError } = await supabaseClient
            .from('sg_users')
            .select('id, full_name, email, phone, account_type')
            .in('account_type', ['contractor', 'fabricator', 'installer', 'admin', 'staff']);

          if (!teamError && teamUsers) {
            allContractors = teamUsers.map(u => ({
              id: u.id,
              name: u.full_name || u.email,
              email: u.email,
              phone: u.phone,
              specialty: u.account_type
            }));
          }
        } else {
          allContractors = contractors || [];
        }

        console.log('[Contractors] Loaded', allContractors.length, 'contractors');
      } catch (err) {
        console.error('Error loading contractors:', err);
        allContractors = [];
      }
    }

    function populateEventContractorsDropdown() {
      const select = document.getElementById('cal-event-contractors');
      if (!select) return;
      select.innerHTML = '';
      // Add contractors from allContractors
      if (allContractors && allContractors.length > 0) {
        allContractors.forEach(c => {
          const name = c.name || c.company_name || c.email || 'Unknown';
          const specialty = c.specialty ? ` (${c.specialty})` : '';
          select.innerHTML += `<option value="${c.id}" data-email="${c.email || ''}" data-phone="${c.phone || ''}" data-name="${escapeHtml(name)}">${escapeHtml(name)}${specialty}</option>`;
        });
      }
    }

    function getSelectedContractorsAsParticipants() {
      const select = document.getElementById('cal-event-contractors');
      if (!select) return [];
      const participants = [];
      const selectedOptions = Array.from(select.selectedOptions);
      selectedOptions.forEach(opt => {
        participants.push({
          email: opt.dataset.email || '',
          name: opt.dataset.name || opt.text,
          phone: opt.dataset.phone || '',
          role: 'contractor',
          participant_type: 'attendee'
        });
      });
      return participants;
    }

    function addEventParticipant() {
      document.getElementById('add-participant-row').style.display = 'block';
      document.getElementById('participant-source').value = 'manual';
      document.getElementById('participant-preset').style.display = 'none';
      document.getElementById('participant-manual-fields').style.display = 'block';
      // Clear fields
      document.getElementById('participant-name').value = '';
      document.getElementById('participant-email').value = '';
      document.getElementById('participant-phone').value = '';
    }

    function cancelAddParticipant() {
      document.getElementById('add-participant-row').style.display = 'none';
    }

    function onParticipantSourceChange() {
      const source = document.getElementById('participant-source').value;
      const preset = document.getElementById('participant-preset');
      const manualFields = document.getElementById('participant-manual-fields');

      if (source === 'manual') {
        preset.style.display = 'none';
        manualFields.style.display = 'block';
      } else {
        preset.style.display = 'block';
        manualFields.style.display = 'none';
        populateParticipantPreset(source);
      }
    }

    async function populateParticipantPreset(source) {
      const preset = document.getElementById('participant-preset');
      preset.innerHTML = '<option value="">-- Select --</option>';

      if (source === 'customer' && allCustomers) {
        allCustomers.forEach(c => {
          if (c.email) {
            preset.innerHTML += `<option value="${c.id}" data-name="${escapeHtml(c.name || '')}" data-email="${escapeHtml(c.email)}" data-phone="${escapeHtml(c.phone || '')}">${escapeHtml(c.name || c.email)}</option>`;
          }
        });
      } else if (source === 'lead' && allLeads) {
        allLeads.forEach(l => {
          if (l.email) {
            preset.innerHTML += `<option value="${l.id}" data-name="${escapeHtml(l.name || '')}" data-email="${escapeHtml(l.email)}" data-phone="${escapeHtml(l.phone || '')}">${escapeHtml(l.name || l.email)}</option>`;
          }
        });
      } else if (source === 'collaborator') {
        // Load network collaborators
        try {
          const resp = await apiCall('/api/collaboration/my-collaborators');
          const data = await resp.json();
          if (data.collaborators) {
            data.collaborators.filter(c => c.status === 'accepted').forEach(c => {
              const name = c.user?.full_name || c.email;
              preset.innerHTML += `<option value="${c.id}" data-name="${escapeHtml(name)}" data-email="${escapeHtml(c.email)}" data-phone="" data-role="${c.role}">${escapeHtml(name)} (${c.role})</option>`;
            });
          }
        } catch (e) {
          console.error('Error loading collaborators for participant:', e);
        }
      }
    }

    function confirmAddParticipant() {
      const source = document.getElementById('participant-source').value;
      let name, email, phone, role, participantType;

      if (source === 'manual') {
        name = document.getElementById('participant-name').value.trim();
        email = document.getElementById('participant-email').value.trim().toLowerCase();
        phone = document.getElementById('participant-phone').value.trim();
        role = document.getElementById('participant-role').value;
        participantType = document.getElementById('participant-type').value;

        if (!email) {
          showToast('Email is required', 'warning');
          return;
        }
      } else {
        const preset = document.getElementById('participant-preset');
        const option = preset.options[preset.selectedIndex];
        if (!option || !option.value) {
          showToast('Please select a person', 'warning');
          return;
        }
        name = option.dataset.name;
        email = option.dataset.email;
        phone = option.dataset.phone || '';
        role = option.dataset.role || (source === 'customer' ? 'customer' : source === 'lead' ? 'customer' : 'other');
        participantType = 'attendee';
      }

      // Check for duplicates
      if (eventParticipants.some(p => p.email.toLowerCase() === email.toLowerCase())) {
        showToast('This email is already added', 'warning');
        return;
      }

      eventParticipants.push({ name, email, phone, role, participant_type: participantType });
      renderEventParticipants();
      cancelAddParticipant();
    }

    function removeEventParticipant(index) {
      eventParticipants.splice(index, 1);
      renderEventParticipants();
    }

    function renderEventParticipants() {
      const container = document.getElementById('event-participants-list');
      if (eventParticipants.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">No participants added yet</div>';
        return;
      }

      container.innerHTML = eventParticipants.map((p, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 6px;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 13px; font-weight: 500;">${escapeHtml(p.name || p.email)}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(p.email)}  ${p.role}${p.participant_type === 'optional' ? ' (optional)' : ''}</div>
          </div>
          <button type="button" class="btn-modern ghost" onclick="removeEventParticipant(${i})" style="padding: 4px 8px; color: var(--error);">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');
    }

    async function submitCalendarEvent(event) {
      event.preventDefault();
      const btn = document.getElementById('save-calendar-event-btn');
      const eventId = document.getElementById('cal-event-id').value;

      const title = document.getElementById('cal-event-title').value.trim();
      const eventType = document.getElementById('cal-event-type').value;
      const status = document.getElementById('cal-event-status').value;
      const startDate = document.getElementById('cal-event-start-date').value;
      const startTime = document.getElementById('cal-event-start-time').value;
      const endDate = document.getElementById('cal-event-end-date').value || startDate;
      const endTime = document.getElementById('cal-event-end-time').value || startTime;
      const location = document.getElementById('cal-event-location').value.trim();
      const description = document.getElementById('cal-event-description').value.trim();
      const leadId = document.getElementById('cal-event-lead').value;
      const customerId = document.getElementById('cal-event-customer').value;
      // Get project from visible dropdown (preferred) or hidden input
      const projectId = document.getElementById('cal-event-project-select')?.value ||
                        document.getElementById('cal-event-project').value;

      // Reminders
      const reminders = [];
      if (document.getElementById('cal-reminder-24h').checked) reminders.push(1440);
      if (document.getElementById('cal-reminder-1h').checked) reminders.push(60);
      const notifyParticipants = document.getElementById('cal-notify-participants').checked;

      if (!title || !startDate || !startTime) {
        showToast('Please fill in required fields', 'warning');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        // Create proper ISO timestamps with local timezone
        const startDateTime = new Date(`${startDate}T${startTime}:00`);
        const endDateTime = new Date(`${endDate}T${endTime}:00`);

        const payload = {
          title,
          event_type: eventType,
          status,
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          location: location || undefined,
          description: description || undefined,
          lead_id: leadId || undefined,
          customer_id: customerId || undefined,
          project_id: projectId || undefined,
          reminder_minutes: reminders,
          notify_participants: notifyParticipants,
          participants: eventParticipants
        };

        const url = eventId ? `/api/calendar/events/${eventId}` : '/api/calendar/events';
        const method = eventId ? 'PUT' : 'POST';

        const resp = await apiCall(url, {
          method,
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to save event');

        showToast(eventId ? 'Event updated!' : 'Event created!', 'success');
        closeCalendarEventModal();
        loadCalendarEvents();
        loadFullCalendarEvents(); // Load the new calendar events

      } catch (err) {
        console.error('Error saving calendar event:', err);
        showToast(err.message || 'Failed to save event', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Event';
      }
    }

    // Simplified calendar event submission (saves directly to Supabase)
    async function submitCalendarEventSimple(event) {
      event.preventDefault();
      const btn = document.getElementById('save-calendar-event-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please sign in to create events');

        const title = document.getElementById('cal-event-title').value.trim();
        const eventType = document.getElementById('cal-event-type').value;
        const meetingFormat = document.getElementById('cal-event-meeting-format')?.value || 'in_person';
        const startDate = document.getElementById('cal-event-start-date').value;
        const startTime = document.getElementById('cal-event-start-time').value || '09:00';
        const endTime = document.getElementById('cal-event-end-time').value || '10:00';
        const description = document.getElementById('cal-event-description').value.trim();

        // Get contact info - from selected contact or manual entry
        const contactType = document.getElementById('cal-event-contact-type')?.value || 'manual';
        const contactId = document.getElementById('cal-event-contact-id')?.value || null;
        const contactName = document.getElementById('cal-event-contact-chip-name')?.textContent?.trim() ||
                           document.getElementById('cal-event-contact-search')?.value?.trim() || '';
        const contactEmail = document.getElementById('cal-event-contact-email')?.value?.trim() || '';
        const contactPhone = document.getElementById('cal-event-contact-phone')?.value?.trim() || '';

        // Get location based on meeting format
        let location = '';
        let meetingDetails = {};

        switch (meetingFormat) {
          case 'in_person':
            location = document.getElementById('cal-event-location').value.trim();
            break;
          case 'phone_call':
            location = contactPhone ? `Phone: ${contactPhone}` : 'Phone Call';
            meetingDetails.phone = contactPhone;
            break;
          case 'video_call':
            const videoPlatform = document.getElementById('cal-event-video-platform')?.value || '';
            const videoLink = document.getElementById('cal-event-video-link')?.value?.trim() || '';
            const platformNames = {
              zoom: 'Zoom',
              google_meet: 'Google Meet',
              teams: 'Microsoft Teams',
              facetime: 'FaceTime',
              other: 'Video Call'
            };
            location = platformNames[videoPlatform] || 'Video Call';
            if (videoLink) location += `: ${videoLink}`;
            meetingDetails.video_platform = videoPlatform;
            meetingDetails.video_link = videoLink;
            break;
          case 'conference_call':
            const confNumber = document.getElementById('cal-event-conference-number')?.value?.trim() || '';
            const confCode = document.getElementById('cal-event-conference-code')?.value?.trim() || '';
            const confPin = document.getElementById('cal-event-conference-pin')?.value?.trim() || '';
            location = confNumber ? `Conference: ${confNumber}` : 'Conference Call';
            if (confCode) location += ` (Code: ${confCode})`;
            meetingDetails.conference_number = confNumber;
            meetingDetails.conference_code = confCode;
            meetingDetails.conference_pin = confPin;
            break;
          default:
            location = document.getElementById('cal-event-location').value.trim();
        }

        if (!title || !startDate) {
          showToast('Please enter a title and date', 'warning');
          btn.disabled = false;
          btn.textContent = 'Save Event';
          return;
        }

        // Create proper ISO timestamps with local timezone
        const startDateTime = new Date(`${startDate}T${startTime}:00`);
        const endDateTime = new Date(`${startDate}T${endTime}:00`);

        const eventData = {
          created_by: user.id,
          title,
          event_type: eventType,
          status: 'scheduled',
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          location: location || null,
          description: description || null,
          metadata: {
            meeting_format: meetingFormat,
            contact_name: contactName,
            contact_email: contactEmail,
            contact_phone: contactPhone,
            contact_type: contactType,
            contact_id: contactId,
            meeting_details: meetingDetails
          }
        };

        // Add optional links
        const leadId = document.getElementById('cal-event-lead')?.value;
        const customerId = document.getElementById('cal-event-customer')?.value;
        // Get project from visible dropdown (preferred) or hidden input
        const projectId = document.getElementById('cal-event-project-select')?.value ||
                          document.getElementById('cal-event-project')?.value;
        if (leadId) eventData.lead_id = leadId;
        if (customerId) eventData.customer_id = customerId;
        if (projectId) eventData.project_id = projectId;

        const eventId = document.getElementById('cal-event-id').value;
        let result;

        if (eventId) {
          // Update existing
          result = await supabaseClient
            .from('calendar_events')
            .update(eventData)
            .eq('id', eventId)
            .select();
        } else {
          // Create new
          result = await supabaseClient
            .from('calendar_events')
            .insert(eventData)
            .select();
        }

        if (result.error) throw result.error;

        const savedEvent = result.data?.[0];

        // Add participants to the event
        if (savedEvent) {
          // Combine enhanced eventParticipants with legacy contractor select
          const allParticipants = [...eventParticipants];
          const legacyContractors = getSelectedContractorsAsParticipants();
          legacyContractors.forEach(lc => {
            if (!allParticipants.some(p => p.email && lc.email && p.email.toLowerCase() === lc.email.toLowerCase())) {
              allParticipants.push(lc);
            }
          });

          // Also add customer contact as participant if provided and not already in list
          if (contactEmail && !allParticipants.some(p => p.email && p.email.toLowerCase() === contactEmail.toLowerCase())) {
            allParticipants.push({
              email: contactEmail,
              name: contactName || 'Customer',
              phone: contactPhone || '',
              role: 'customer',
              participant_type: 'attendee'
            });
          }

          // Insert participants
          if (allParticipants.length > 0) {
            const participantRecords = allParticipants
              .filter(p => p.email) // Only add those with emails
              .map(p => ({
                event_id: savedEvent.id,
                email: p.email.toLowerCase(),
                name: p.name,
                phone: p.phone || null,
                participant_type: p.participant_type || 'attendee',
                response_status: 'pending'
              }));
            if (participantRecords.length > 0) {
              // Clear existing participants first if updating
              if (eventId) {
                await supabaseClient
                  .from('calendar_event_participants')
                  .delete()
                  .eq('event_id', savedEvent.id);
              }
              await supabaseClient
                .from('calendar_event_participants')
                .insert(participantRecords);
              console.log('[Calendar] Added', participantRecords.length, 'participants to event');
            }
          }
        }

        // If linked to a lead, update the lead's appointment status
        if (leadId && !eventId) {
          try {
            await supabaseClient
              .from('leads')
              .update({
                appointment_status: 'scheduled',
                appointment_date: startDate,
                appointment_time: startTime,
                updated_at: new Date().toISOString()
              })
              .eq('id', leadId);
            console.log('Lead appointment status updated');
          } catch (leadErr) {
            console.warn('Could not update lead status:', leadErr.message);
          }
        }

        showToast(eventId ? 'Event updated!' : 'Event created!', 'success');
        closeCalendarEventModal();
        // IMPORTANT: Load events sequentially to avoid race condition
        // loadCalendarEvents clears the array, then loadAllCalendarEvents adds API events
        await loadCalendarEvents();
        await loadAllCalendarEvents();
        console.log('[Calendar] Events reloaded after save, total:', calendarEvents.length);

      } catch (err) {
        console.error('Error saving event:', err);
        showToast(err.message || 'Failed to save event', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Event';
      }
    }

    // Full calendar events from Supabase (faster than API)
    let fullCalendarEvents = [];

    async function loadAllCalendarEvents() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Use global isAdmin variable set by loadUserProfile()
        // Note: Don't create local const - global isAdmin is already set correctly
        console.log('[Calendar] isAdmin check:', isAdmin, 'isSuperAdmin:', isSuperAdmin);

        // Build query - admins see all, others see only their own
        let query = supabaseClient
          .from('calendar_events')
          .select('id, title, event_type, status, start_time, end_time, location, lead_id, customer_id, project_id, metadata, created_by')
          .neq('status', 'cancelled')
          .gte('start_time', new Date(Date.now() - 30*24*60*60*1000).toISOString()) // Last 30 days
          .lte('start_time', new Date(Date.now() + 90*24*60*60*1000).toISOString()) // Next 90 days
          .order('start_time', { ascending: true });

        // Only filter by created_by if NOT admin
        if (!isAdmin) {
          query = query.eq('created_by', user.id);
        }

        const { data: events, error } = await query;

        console.log('[Calendar] Loading events, isAdmin:', isAdmin, 'events found:', events?.length || 0);

        if (error) {
          console.warn('Calendar events load error:', error.message);
          // Just use jobs-based events
          renderCalendar();
          renderUpcomingEvents();
          return;
        }

        if (events && events.length > 0) {
          console.log('[Calendar] Events:', events.map(e => ({ id: e.id, title: e.title, date: e.start_time?.split('T')[0], status: e.status })));
        }

        // IMPORTANT: Remove all API-sourced events first (to handle deletions)
        // Keep only job-based events (those without apiEventId)
        calendarEvents = calendarEvents.filter(e => !e.apiEventId);

        // Add fresh events from database
        (events || []).forEach(event => {
          // Convert to local date (not UTC) for calendar display
          const eventDate = new Date(event.start_time);
          const year = eventDate.getFullYear();
          const month = String(eventDate.getMonth() + 1).padStart(2, '0');
          const day = String(eventDate.getDate()).padStart(2, '0');
          const date = `${year}-${month}-${day}`;

          calendarEvents.push({
            date,
            title: event.title,
            type: event.event_type,
            apiEventId: event.id,
            status: event.status,
            location: event.location,
            metadata: event.metadata
          });
        });

        renderCalendar();
        renderUpcomingEvents();
      } catch (err) {
        console.error('Error loading calendar events:', err);
      }
    }

    // Legacy function for compatibility
    async function loadFullCalendarEvents() {
      return loadAllCalendarEvents();
    }

    function mergeCalendarEvents() {
      renderCalendar();
      renderUpcomingEvents();
    }

    function openCalendarEventDetailModal(eventId) {
      const modal = document.getElementById('calendar-event-detail-modal');
      const content = document.getElementById('event-detail-content');
      const actions = document.getElementById('event-detail-actions');

      modal.classList.add('active');
      content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      loadCalendarEventDetail(eventId, content, actions);
    }

    function closeCalendarEventDetailModal() {
      document.getElementById('calendar-event-detail-modal').classList.remove('active');
    }

    async function loadCalendarEventDetail(eventId, content, actions) {
      try {
        // Load directly from Supabase for speed
        const { data: event, error } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('id', eventId)
          .single();

        if (error) throw error;
        const typeColors = {
          appointment: '#3b82f6',
          measurement: '#f59e0b',
          installation: '#10b981',
          delivery: '#06b6d4',
          meeting: '#8b5cf6',
          follow_up: '#6b7280',
          consultation: '#ec4899',
          site_visit: '#f97316',
          other: '#6b7280'
        };
        const color = typeColors[event.event_type] || '#6b7280';

        const startTime = new Date(event.start_time);
        const endTime = new Date(event.end_time);
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const timeOptions = { hour: 'numeric', minute: '2-digit' };

        // Status colors
        const statusColors = {
          scheduled: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b', label: 'Pending Confirmation' },
          confirmed: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981', label: 'Confirmed' },
          completed: { bg: 'rgba(99, 102, 241, 0.15)', color: '#6366f1', label: 'Completed' },
          cancelled: { bg: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', label: 'Cancelled' },
          rescheduled: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6', label: 'Rescheduled' },
          no_show: { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280', label: 'No Show' }
        };
        const statusStyle = statusColors[event.status] || statusColors.scheduled;

        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <span style="display: inline-block; padding: 4px 12px; background: ${color}20; color: ${color}; border-radius: 16px; font-size: 12px; font-weight: 600; text-transform: capitalize;">${event.event_type.replace('_', ' ')}</span>
            <span style="display: inline-block; padding: 4px 12px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 16px; font-size: 12px; margin-left: 8px; font-weight: 500;">${statusStyle.label}</span>
          </div>

          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; text-align: center;">${escapeHtml(event.title)}</h3>

          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <span style="font-size: 14px;">${startTime.toLocaleDateString('en-US', dateOptions)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span style="font-size: 14px;">${startTime.toLocaleTimeString('en-US', timeOptions)} - ${endTime.toLocaleTimeString('en-US', timeOptions)}</span>
            </div>
            ${event.location ? `
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              <span style="font-size: 14px;">${escapeHtml(event.location)}</span>
              <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(event.location)}" target="_blank" style="color: var(--gold-primary); font-size: 12px; margin-left: auto;">
                <i class="fa-solid fa-arrow-up-right-from-square"></i> Map
              </a>
            </div>
            <div id="event-detail-map" style="margin-top: 10px; border-radius: 8px; overflow: hidden; height: 120px;"></div>
            ` : ''}
          </div>

          ${event.description ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Description</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${escapeHtml(event.description)}</div>
          </div>
          ` : ''}

          ${(event.metadata?.contact_name || event.metadata?.contact_email || event.metadata?.contact_phone) ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Contact</div>
            <div style="padding: 12px; background: var(--dark-surface); border-radius: 8px;">
              ${event.metadata.contact_name ? `<div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">${escapeHtml(event.metadata.contact_name)}</div>` : ''}
              ${event.metadata.contact_email ? `
              <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <a href="mailto:${escapeHtml(event.metadata.contact_email)}" style="color: var(--accent);">${escapeHtml(event.metadata.contact_email)}</a>
              </div>
              ` : ''}
              ${event.metadata.contact_phone ? `
              <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                <a href="tel:${escapeHtml(event.metadata.contact_phone)}" style="color: var(--accent);">${escapeHtml(event.metadata.contact_phone)}</a>
              </div>
              ` : ''}
            </div>
          </div>
          ` : ''}
        `;

        // Store event for Google Calendar link
        window.currentDetailEvent = event;

        // Actions - with confirm button for scheduled events
        const isScheduled = event.status === 'scheduled';
        const isConfirmed = event.status === 'confirmed';

        // Generate Google Calendar URL
        const gcalUrl = generateGoogleCalendarUrl(event);

        actions.innerHTML = `
          <button type="button" class="btn-modern ghost" onclick="deleteCalendarEvent('${event.id}')" style="color: #ef4444;">
            <i class="fa-solid fa-trash" style="margin-right: 4px;"></i>
            Delete
          </button>
          <a href="${gcalUrl}" target="_blank" class="btn-modern ghost" style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
            <i class="fa-brands fa-google" style="color: #4285f4;"></i>
            Add to Calendar
          </a>
          <div style="flex: 1;"></div>
          ${isScheduled ? `
          <button type="button" class="btn-modern" onclick="confirmCalendarEvent('${event.id}')" style="background: #10b981; color: white;">
            <i class="fa-solid fa-check" style="margin-right: 4px;"></i>
            Confirm
          </button>
          ` : ''}
          <button type="button" class="btn-modern secondary" onclick="closeCalendarEventDetailModal()">Close</button>
          <button type="button" class="btn-modern primary" onclick="closeCalendarEventDetailModal(); openCalendarEventModal('${event.id}')">
            <i class="fa-solid fa-pen-to-square" style="margin-right: 4px;"></i>
            Edit
          </button>
        `;

        // Initialize map for location if Google Maps is ready
        if (event.location && googleMapsReady) {
          initEventDetailMap(event.location);
        }

      } catch (err) {
        console.error('Error loading event detail:', err);
        content.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load event details</p></div>';
      }
    }

    async function notifyEventParticipants(eventId) {
      try {
        const resp = await apiCall(`/api/calendar/events/${eventId}/notify`, { method: 'POST' });
        const data = await resp.json();

        if (!resp.ok) throw new Error(data.error || 'Failed to send notifications');

        showToast(`Notifications sent to ${data.notified || 0} participants`, 'success');
      } catch (err) {
        console.error('Error notifying participants:', err);
        showToast(err.message || 'Failed to send notifications', 'error');
      }
    }

    async function deleteCalendarEvent(eventId) {
      if (!confirm('Delete this event? This cannot be undone.')) return;

      try {
        const { error } = await supabaseClient
          .from('calendar_events')
          .delete()
          .eq('id', eventId);

        if (error) throw error;

        showToast('Event deleted', 'success');
        closeCalendarEventDetailModal();
        loadAllCalendarEvents();
      } catch (err) {
        console.error('Error deleting event:', err);
        showToast('Failed to delete event', 'error');
      }
    }

    // Confirm a scheduled calendar event
    async function confirmCalendarEvent(eventId) {
      try {
        showToast('Confirming event...', 'info');

        // Update event status to confirmed
        const { data: event, error } = await supabaseClient
          .from('calendar_events')
          .update({
            status: 'confirmed',
            updated_at: new Date().toISOString()
          })
          .eq('id', eventId)
          .select('*, calendar_event_participants(*)')
          .single();

        if (error) throw error;

        // Mark as confirmed in state manager
        if (typeof StateManager !== 'undefined') {
          StateManager.markEventConfirmed(eventId, currentUser?.id, new Date().toISOString());
        }

        // Send confirmation notification to participants
        const participants = event.calendar_event_participants || [];
        const customerParticipant = participants.find(p => p.participant_type === 'attendee');

        if (customerParticipant?.email) {
          try {
            const eventDate = new Date(event.start_time).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const eventTime = new Date(event.start_time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const confirmationMessage = `
              <p>Hi ${customerParticipant.name || 'there'},</p>
              <p>Great news! Your appointment has been <strong>confirmed</strong>.</p>
              <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 16px; margin: 20px 0;">
                <p style="margin: 0 0 8px; font-weight: 600;">${event.title}</p>
                <p style="margin: 0 0 4px;"> ${eventDate}</p>
                <p style="margin: 0 0 4px;"> ${eventTime}</p>
                ${event.location ? `<p style="margin: 0;"> ${event.location}</p>` : ''}
              </div>
              <p>We look forward to seeing you!</p>
              <p>If you need to reschedule, please call us at <a href="tel:+16028333189">(602) 833-3189</a>.</p>
            `;

            await apiCall('/api/email/notify', {
              method: 'POST',
              body: JSON.stringify({
                to: customerParticipant.email,
                subject: 'Your Appointment is Confirmed - ' + event.title,
                message: confirmationMessage,
                type: 'success',
                rawHtml: true
              })
            });
          } catch (notifyErr) {
            console.warn('Failed to send confirmation notification:', notifyErr);
          }
        }

        // Update participant response status
        if (customerParticipant) {
          await supabaseClient
            .from('calendar_event_participants')
            .update({
              response_status: 'accepted',
              responded_at: new Date().toISOString()
            })
            .eq('id', customerParticipant.id);
        }

        showToast('Event confirmed!', 'success');
        closeCalendarEventDetailModal();
        loadAllCalendarEvents();

        // Also refresh dashboard widgets
        if (typeof loadDashboardWidgets === 'function') {
          loadDashboardWidgets();
        }

      } catch (err) {
        console.error('Error confirming event:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    async function loadCalendarEventForEdit(eventId) {
      try {
        const resp = await apiCall(`/api/calendar/events/${eventId}`);
        const data = await resp.json();

        if (!resp.ok) throw new Error(data.error || 'Failed to load event');

        const event = data.event;

        document.getElementById('cal-event-title').value = event.title || '';
        document.getElementById('cal-event-type').value = event.event_type || 'appointment';
        document.getElementById('cal-event-status').value = event.status || 'scheduled';

        const startTime = new Date(event.start_time);
        const endTime = new Date(event.end_time);
        // Use local date/time (not UTC) for form fields
        const startYear = startTime.getFullYear();
        const startMonth = String(startTime.getMonth() + 1).padStart(2, '0');
        const startDay = String(startTime.getDate()).padStart(2, '0');
        const startHours = String(startTime.getHours()).padStart(2, '0');
        const startMins = String(startTime.getMinutes()).padStart(2, '0');
        document.getElementById('cal-event-start-date').value = `${startYear}-${startMonth}-${startDay}`;
        document.getElementById('cal-event-start-time').value = `${startHours}:${startMins}`;

        const endYear = endTime.getFullYear();
        const endMonth = String(endTime.getMonth() + 1).padStart(2, '0');
        const endDay = String(endTime.getDate()).padStart(2, '0');
        const endHours = String(endTime.getHours()).padStart(2, '0');
        const endMins = String(endTime.getMinutes()).padStart(2, '0');
        document.getElementById('cal-event-end-date').value = `${endYear}-${endMonth}-${endDay}`;
        document.getElementById('cal-event-end-time').value = `${endHours}:${endMins}`;

        document.getElementById('cal-event-location').value = event.location || '';
        document.getElementById('cal-event-description').value = event.description || '';
        document.getElementById('cal-event-customer').value = event.customer_id || '';
        // Use project_id with fallback to job_id for backward compatibility
        const projectIdToUse = event.project_id || event.job_id || '';
        document.getElementById('cal-event-project').value = projectIdToUse;
        const projectSelect = document.getElementById('cal-event-project-select');
        if (projectSelect) projectSelect.value = projectIdToUse;

        // Load participants
        if (event.participants) {
          eventParticipants = event.participants.map(p => ({
            name: p.name,
            email: p.email,
            phone: p.phone || '',
            role: p.role || 'attendee',
            participant_type: p.participant_type || 'attendee'
          }));
          renderEventParticipants();
        }

        // Reminders
        const reminders = event.reminder_minutes || [];
        document.getElementById('cal-reminder-24h').checked = reminders.includes(1440);
        document.getElementById('cal-reminder-1h').checked = reminders.includes(60);

      } catch (err) {
        console.error('Error loading event for edit:', err);
        showToast('Failed to load event', 'error');
        closeCalendarEventModal();
      }
    }

    // Bridge 3: Navigate to a collaboration project
    function viewCollaborationProject(projectId) {
      if (!projectId) return;
      if (typeof openProjectDetail === 'function') {
        openProjectDetail(projectId);
      } else {
        showPage('projects');
        setTimeout(function() {
          if (typeof openProjectDetail === 'function') {
            openProjectDetail(projectId);
          }
        }, 500);
      }
    }

    // Bridge 3b: Customer/viewer read-only project view
    async function openCustomerProjectView(projectId) {
      var modal = document.getElementById('project-detail-modal');
      var body = document.getElementById('project-detail-body');
      modal.classList.add('active');
      body.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        var result = await supabaseClient.from('projects').select('*').eq('id', projectId).single();
        var project = result.data;

        if (!project) {
          body.innerHTML = '<div class="empty-state"><h3>Project not accessible</h3><p>You may not have permission to view this project.</p></div>';
          return;
        }

        var statusColor = PROJECT_STATUS_COLORS[project.status] || '#6b7280';
        var statusLabel = PROJECT_STATUS_LABELS[project.status] || project.status;
        var progress = project.progress || 0;

        body.innerHTML =
          '<div style="text-align: center; margin-bottom: 24px;">' +
            '<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">' + escapeHtml(project.name) + '</h2>' +
            '<span style="display: inline-block; padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ' + statusColor + '20; color: ' + statusColor + ';">' + statusLabel + '</span>' +
            (progress > 0 ? '<div style="margin-top: 12px; max-width: 300px; margin-left: auto; margin-right: auto;"><div style="height: 6px; background: var(--dark-surface); border-radius: 3px; overflow: hidden;"><div style="width: ' + progress + '%; height: 100%; background: var(--gold-primary); border-radius: 3px;"></div></div><div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">' + progress + '% complete</div></div>' : '') +
          '</div>' +
          (project.description ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">' + escapeHtml(project.description) + '</div>' : '') +
          '<div id="customer-view-handoffs" style="margin-bottom: 16px;"><div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">Loading handoff status...</div></div>' +
          (project.customer_notes ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Notes</div><div style="font-size: 13px; color: var(--text-secondary);">' + escapeHtml(project.customer_notes) + '</div></div>' : '') +
          '<div style="text-align: center; padding: 12px; font-size: 11px; color: var(--text-muted);">Read-only view</div>';

        // Load handoffs for read-only stage display
        loadCustomerViewHandoffs(projectId);
      } catch (err) {
        body.innerHTML = '<div class="empty-state"><h3>Error loading project</h3><p>' + escapeHtml(err.message || 'Unknown error') + '</p></div>';
      }
    }

    async function loadCustomerViewHandoffs(projectId) {
      var container = document.getElementById('customer-view-handoffs');
      if (!container) return;

      try {
        var resp = await apiCall('/api/collaboration/projects/' + projectId + '/handoffs');
        var data = await resp.json();
        if (!resp.ok || !data.handoffs || !data.handoffs.length) {
          container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">No active handoffs</div>';
          return;
        }

        container.innerHTML = '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Handoff Progress</div>' +
          data.handoffs.map(function(h) {
            var stageIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === h.stage; });
            var stageLabel = HANDOFF_STAGES[stageIdx] ? HANDOFF_STAGES[stageIdx].label : h.stage;
            var pct = Math.round(((stageIdx + 1) / HANDOFF_STAGES.length) * 100);
            return '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 12px; margin-bottom: 8px;">' +
              '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
                '<span style="font-size: 13px; font-weight: 600; color: var(--text-primary);">' + escapeHtml(h.title) + '</span>' +
                '<span style="font-size: 11px; color: var(--gold-primary); font-weight: 500;">' + stageLabel + '</span>' +
              '</div>' +
              '<div style="height: 4px; background: var(--dark-surface); border-radius: 2px; overflow: hidden;"><div style="width: ' + pct + '%; height: 100%; background: var(--gold-primary); border-radius: 2px;"></div></div>' +
            '</div>';
          }).join('');
      } catch (err) {
        container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">Could not load handoffs</div>';
      }
    }

    // =============================================
    // PROJECT ACTIVITY LOGGING
    // =============================================

    async function logProjectActivity(projectId, action, description) {
      if (!projectId || !currentUser) return;
      try {
        await supabaseClient.from('project_activity').insert({
          project_id: projectId,
          action: action,
          description: description,
          user_id: currentUser.id,
          user_name: userProfile ? (userProfile.full_name || userProfile.email) : currentUser.email
        });
      } catch (err) {
        console.warn('[Activity] Failed to log:', err);
      }
    }

    // =============================================
    // COLLABORATION HELPERS (unified invite wiring)
    // =============================================

    /** Open invite modal for the current job context */
    function inviteCollaboratorForJob() {
      if (!currentJobId) {
        showToast('Please open a job first', 'warning');
        return;
      }
      // Use the job ID as the project context
      openInviteToProjectModal(currentJobId);
    }

    /** Invite a contractor (from contractor cards or contractor profile) as collaborator */
    function inviteContractorAsCollaborator(contractorIdParam) {
      const cId = contractorIdParam || currentContractorId;
      const contractor = allCollaborators.find(function(c) { return c.id === cId; });
      if (!contractor) {
        showToast('Contractor not found', 'error');
        return;
      }
      const roleMap = { fabricator: 'fabricator', installer: 'installer', plumber: 'contractor', electrician: 'contractor', template: 'contractor', other: 'contractor' };
      const role = roleMap[contractor.type] || 'contractor';
      openInviteToProjectModal(null, contractor.email || '', role);
    }

    /** Invite a contractor assigned to the current job as collaborator */
    function inviteJobContractorAsCollaborator(contractorId) {
      if (!currentJobId) return;
      let jc = null;
      const job = allJobs.find(function(j) { return j.id === currentJobId; });
      if (job && job.project_contractors) {
        jc = job.project_contractors.find(function(c) { return c.contractor_id === contractorId; });
      }
      const contractor = allCollaborators.find(function(c) { return c.id === contractorId; });
      const email = contractor ? contractor.email : '';
      let role = (jc && jc.role) || (contractor && contractor.type) || 'contractor';
      const roleMap = { fabricator: 'fabricator', installer: 'installer', plumber: 'contractor', electrician: 'contractor', template: 'contractor', other: 'contractor' };
      role = roleMap[role] || 'contractor';
      openInviteToProjectModal(currentJobId, email, role);
    }

    /** Invite the current job's customer as a collaborator (viewer) */
    function inviteCustomerAsCollaborator() {
      if (!currentJobId) return;
      const job = allJobs.find(function(j) { return j.id === currentJobId; });
      if (!job) return;
      const email = (job.customers && job.customers.email) || job.customer_email || '';
      openInviteToProjectModal(currentJobId, email, 'viewer');
    }

    /** Invite a collaborator for a design project */
    function inviteDesignCollaborator(designId) {
      openInviteToProjectModal(designId, '', 'designer');
    }

    /** Invite collaborator from an estimate (pre-fills customer email) */
    function inviteFromEstimate(estimateId) {
      const estimate = allEstimates.find(function(e) { return e.id === estimateId; });
      const email = (estimate && estimate.customer_email) || '';
      openInviteToProjectModal(null, email, 'viewer');
    }

    /** Invite a lead to collaborate on a project */
    function inviteLeadAsCollaborator() {
      if (!selectedLead) {
        showToast('Please open a lead first', 'warning');
        return;
      }
      openInviteToProjectModal(null, selectedLead.email || '', 'viewer');
    }

    /** Invite a customer to collaborate on a project */
    function inviteCustomerToProject() {
      if (!selectedCustomer) {
        showToast('Please open a customer first', 'warning');
        return;
      }
      openInviteToProjectModal(null, selectedCustomer.email || '', 'viewer');
    }

    // =============================================
    // DESIGN HANDOFF FUNCTIONS
    // =============================================

    const HANDOFF_STAGES = [
      { key: 'design_created', label: 'Created' },
      { key: 'design_review', label: 'Review' },
      { key: 'design_approved', label: 'Approved' },
      { key: 'fabrication_quote_requested', label: 'Quote Req' },
      { key: 'fabrication_quote_received', label: 'Quote Recv' },
      { key: 'fabrication_approved', label: 'Fab Approved' },
      { key: 'materials_ordered', label: 'Ordered' },
      { key: 'fabrication_in_progress', label: 'Fabricating' },
      { key: 'fabrication_complete', label: 'Fab Done' },
      { key: 'install_scheduled', label: 'Scheduled' },
      { key: 'install_in_progress', label: 'Installing' },
      { key: 'install_complete', label: 'Installed' },
      { key: 'final_review', label: 'Final Review' }
    ];

    function renderHandoffStages(currentStage) {
      const currentIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === currentStage; });
      return '<div class="handoff-stage-tracker">' + HANDOFF_STAGES.map(function(stage, i) {
        let cls = 'future';
        if (i < currentIdx) cls = 'completed';
        else if (i === currentIdx) cls = 'current';
        return '<div class="handoff-stage ' + cls + '">' + stage.label + '</div>';
      }).join('') + '</div>';
    }

    function openStartHandoffModal(designId, designName, preselectedProjectId) {
      document.getElementById('start-handoff-form').reset();
      document.getElementById('handoff-design-id').value = designId || '';
      if (designName) {
        document.getElementById('handoff-title').value = designName + ' - Fabrication Handoff';
      }
      document.getElementById('start-handoff-modal').classList.add('active');
      loadHandoffProjectOptions(preselectedProjectId);
      loadHandoffParticipants();
    }

    function closeStartHandoffModal() {
      document.getElementById('start-handoff-modal').classList.remove('active');
    }

    async function loadHandoffProjectOptions(preselectedId) {
      const select = document.getElementById('handoff-project-select');
      select.innerHTML = '<option value="">Loading projects...</option>';
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { select.innerHTML = '<option value="">Not authenticated</option>'; return; }
        const { data: projects } = await supabaseClient
          .from('projects')
          .select('id, name')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        select.innerHTML = '<option value="">Select a Project</option>';
        if (projects && projects.length > 0) {
          projects.forEach(function(p) {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name || 'Untitled';
            if (preselectedId && p.id === preselectedId) opt.selected = true;
            select.appendChild(opt);
          });
        }
      } catch (err) {
        console.error('Error loading projects for handoff:', err);
        select.innerHTML = '<option value="">Error loading projects</option>';
      }
    }

    async function loadHandoffParticipants() {
      const fabSelect = document.getElementById('handoff-fabricator');
      const conSelect = document.getElementById('handoff-contractor');
      fabSelect.innerHTML = '<option value="">None (assign later)</option>';
      conSelect.innerHTML = '<option value="">None (assign later)</option>';

      try {
        // Use allCollaborators if available, otherwise load
        let collaborators = typeof allCollaborators !== 'undefined' ? allCollaborators : [];
        if (collaborators.length === 0 && typeof loadCollaborators === 'function') {
          await loadCollaborators();
          collaborators = typeof allCollaborators !== 'undefined' ? allCollaborators : [];
        }
        collaborators.forEach(function(c) {
          const name = c.name || c.company_name || c.email || 'Unknown';
          const cType = (c.type || c.contractor_type || '').toLowerCase();
          if (cType === 'fabricator' || cType === 'stone_fabricator') {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = name;
            fabSelect.appendChild(opt);
          }
          if (cType === 'installer' || cType === 'general_contractor' || cType === 'contractor') {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = name;
            conSelect.appendChild(opt);
          }
        });
      } catch (err) {
        console.error('Error loading handoff participants:', err);
      }
    }

    async function submitStartHandoff(event) {
      event.preventDefault();
      const btn = document.getElementById('submit-handoff-btn');
      const projectId = document.getElementById('handoff-project-select').value;
      const title = document.getElementById('handoff-title').value.trim();
      const description = document.getElementById('handoff-description').value.trim();
      const fabricatorId = document.getElementById('handoff-fabricator').value;
      const contractorId = document.getElementById('handoff-contractor').value;
      const notes = document.getElementById('handoff-notes').value.trim();

      if (!projectId) {
        showToast('Please select a project', 'warning');
        return false;
      }
      if (!title) {
        showToast('Please enter a handoff title', 'warning');
        return false;
      }

      btn.disabled = true;
      btn.textContent = 'Starting Handoff...';

      try {
        const body = { title: title, description: description || undefined, notes: notes || undefined };
        if (fabricatorId) body.fabricator_id = fabricatorId;
        if (contractorId) body.contractor_id = contractorId;

        const designId = document.getElementById('handoff-design-id').value;
        if (designId) body.design_file_url = '/tools/room-designer/?p=' + designId;

        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/handoffs', {
          method: 'POST',
          body: JSON.stringify(body)
        });

        let data;
        try { data = await resp.json(); } catch (e) {
          throw new Error('Server returned invalid response (status ' + resp.status + ')');
        }

        if (!resp.ok) {
          throw new Error(data.error || 'Failed to create handoff');
        }

        showToast('Design handoff started!', 'success');
        closeStartHandoffModal();

        // Log activity
        logProjectActivity(projectId, 'handoff_created', 'Design handoff "' + title + '" created');

        // If fabricator or contractor was assigned, suggest inviting them
        if (fabricatorId || contractorId) {
          showToast('Tip: Invite your fabricator/contractor as a collaborator so they can track progress', 'info');
        }

      } catch (err) {
        console.error('[Handoff] Error creating:', err);
        showToast(err.message || 'Error starting handoff', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg> Start Handoff';
      }
      return false;
    }

    // Store current handoff for cross-system bridges (e.g., convert to estimate)
    let currentHandoffData = null;

    async function openHandoffDetailModal(handoffId) {
      const modal = document.getElementById('handoff-detail-modal');
      const content = document.getElementById('handoff-detail-content');
      modal.classList.add('active');
      content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="color: var(--text-muted); margin-top: 12px;">Loading handoff...</p></div>';

      try {
        const resp = await apiCall('/api/collaboration/handoffs/' + handoffId);
        let data;
        try { data = await resp.json(); } catch (e) {
          throw new Error('Invalid server response');
        }
        if (!resp.ok) throw new Error(data.error || 'Failed to load handoff');

        const h = data.handoff || data;
        currentHandoffData = h;
        document.getElementById('handoff-detail-title').textContent = h.title || 'Design Handoff';

        const stage = h.stage || 'design_created';
        const stageIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === stage; });
        const stageLabel = HANDOFF_STAGES[stageIdx] ? HANDOFF_STAGES[stageIdx].label : stage;
        const isComplete = stage === 'final_review' && h.completed_at;

        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 16px;">
            <span style="display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; background: ${isComplete ? 'rgba(34,197,94,0.15)' : 'rgba(212,175,55,0.2)'}; color: ${isComplete ? '#22c55e' : 'var(--gold-primary)'};">
              ${isComplete ? 'Completed' : stageLabel}
            </span>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">Stage ${stageIdx + 1} of ${HANDOFF_STAGES.length}</div>
          </div>
          ${renderHandoffStages(stage)}
          ${h.description ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">' + escapeHtml(h.description) + '</div>' : ''}
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div class="handoff-participant">
              <div class="handoff-participant-avatar">${h.designer_name ? h.designer_name.charAt(0).toUpperCase() : 'D'}</div>
              <div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Designer</div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${escapeHtml(h.designer_name || h.designer_email || 'You')}</div>
              </div>
            </div>
            <div class="handoff-participant">
              <div class="handoff-participant-avatar" style="background: #3b82f6;">${h.fabricator_name ? h.fabricator_name.charAt(0).toUpperCase() : '?'}</div>
              <div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Fabricator</div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${escapeHtml(h.fabricator_name || h.fabricator_email || 'Not assigned')}</div>
              </div>
            </div>
            <div class="handoff-participant">
              <div class="handoff-participant-avatar" style="background: #8b5cf6;">${h.contractor_name ? h.contractor_name.charAt(0).toUpperCase() : '?'}</div>
              <div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Installer</div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${escapeHtml(h.contractor_name || h.contractor_email || 'Not assigned')}</div>
              </div>
            </div>
          </div>
          ${h.notes ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Notes</div><div style="font-size: 13px; color: var(--text-secondary);">' + escapeHtml(h.notes) + '</div></div>' : ''}
          ${h.quote_amount
            ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
                  '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Fabrication Quote</div>' +
                  '<button class="btn-modern secondary" style="padding: 4px 10px; font-size: 11px;" onclick="document.getElementById(\'handoff-quote-edit-section\').style.display=document.getElementById(\'handoff-quote-edit-section\').style.display===\'none\'?\'block\':\'none\'">Edit Quote</button>' +
                '</div>' +
                '<div style="font-size: 20px; font-weight: 700; color: var(--gold-primary); margin-bottom: 4px;">$' + parseFloat(h.quote_amount).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>' +
                (h.scheduled_date ? '<div style="font-size: 12px; color: var(--text-secondary);">Install: ' + new Date(h.scheduled_date).toLocaleDateString() + '</div>' : '') +
                '<div id="handoff-quote-edit-section" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">' +
                  '<div style="display: flex; gap: 10px; align-items: flex-end;">' +
                    '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Quote Amount ($)</label><input type="number" id="handoff-quote-input" min="0" step="0.01" value="' + (parseFloat(h.quote_amount) || '') + '" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                    '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Install Date</label><input type="date" id="handoff-date-input" value="' + (h.scheduled_date ? new Date(h.scheduled_date).toISOString().split('T')[0] : '') + '" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                    '<button class="btn-modern primary" style="padding: 8px 16px; white-space: nowrap;" onclick="saveHandoffQuote(\'' + h.id + '\')">Update</button>' +
                  '</div>' +
                '</div>' +
                '<button class="btn-modern secondary" style="margin-top: 10px; font-size: 12px; width: 100%;" onclick="convertHandoffToEstimate()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Convert to Estimate</button>' +
              '</div>'
            : '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;">' +
                '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Fabrication Quote</div>' +
                '<div style="display: flex; gap: 10px; align-items: flex-end;">' +
                  '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Quote Amount ($)</label><input type="number" id="handoff-quote-input" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                  '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Install Date</label><input type="date" id="handoff-date-input" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                  '<button class="btn-modern primary" style="padding: 8px 16px; white-space: nowrap;" onclick="saveHandoffQuote(\'' + h.id + '\')">Save</button>' +
                '</div>' +
              '</div>'
          }
          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;">
            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Design Files</div>
            ${h.design_file_url
              ? '<a href="' + escapeHtml(h.design_file_url) + '" target="_blank" rel="noopener" style="display: flex; align-items: center; gap: 8px; color: var(--gold-primary); text-decoration: none; font-size: 13px; margin-bottom: 10px;">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg> View Design File' +
                '</a>' +
                '<input type="file" id="handoff-file-input" accept="image/*,.pdf,.dxf,.dwg" style="display:none" onchange="handleHandoffFileUpload(\'' + h.id + '\')"/>' +
                '<button onclick="document.getElementById(\'handoff-file-input\').click()" class="btn-modern secondary" style="width: 100%; font-size: 12px;">Replace File</button>'
              : '<input type="file" id="handoff-file-input" accept="image/*,.pdf,.dxf,.dwg" style="display:none" onchange="handleHandoffFileUpload(\'' + h.id + '\')"/>' +
                '<button onclick="document.getElementById(\'handoff-file-input\').click()" class="btn-modern secondary" style="width: 100%; font-size: 12px;">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>' +
                  'Upload Design File</button>'
            }
          </div>
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 16px;">
            Created: ${new Date(h.created_at).toLocaleDateString()}
            ${h.scheduled_date ? ' | Install: ' + new Date(h.scheduled_date).toLocaleDateString() : ''}
          </div>
          ${!isComplete ? '<button class="btn-modern primary" style="width: 100%;" onclick="advanceHandoff(\'' + h.id + '\')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg> Advance to Next Stage</button>' : '<div style="text-align: center; padding: 12px; color: #22c55e; font-weight: 600;">Handoff Complete</div>'}
        `;
      } catch (err) {
        console.error('[Handoff] Error loading detail:', err);
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--error-color);">' + escapeHtml(err.message || 'Error loading handoff') + '</div>';
      }
    }

    function closeHandoffDetailModal() {
      document.getElementById('handoff-detail-modal').classList.remove('active');
    }

    async function advanceHandoff(handoffId) {
      try {
        const resp = await apiCall('/api/collaboration/handoffs/' + handoffId + '/advance', {
          method: 'POST',
          body: JSON.stringify({})
        });
        let data;
        try { data = await resp.json(); } catch (e) {
          throw new Error('Invalid server response');
        }
        if (!resp.ok) throw new Error(data.error || 'Failed to advance stage');

        showToast(data.message || 'Stage advanced!', 'success');
        // Refresh the handoff detail
        openHandoffDetailModal(handoffId);

        // Log activity
        if (currentHandoffData && currentHandoffData.project_id) {
          var newStage = (data.handoff && data.handoff.stage) || 'next stage';
          var stageObj = HANDOFF_STAGES.find(function(s) { return s.key === newStage; });
          logProjectActivity(currentHandoffData.project_id, 'handoff_advanced', 'Handoff "' + (currentHandoffData.title || 'Untitled') + '" advanced to ' + (stageObj ? stageObj.label : newStage));
        }
      } catch (err) {
        console.error('[Handoff] Advance error:', err);
        showToast(err.message || 'Error advancing stage', 'error');
      }
    }

    async function saveHandoffQuote(handoffId) {
      var quoteEl = document.getElementById('handoff-quote-input');
      var dateEl = document.getElementById('handoff-date-input');
      var quote = parseFloat(quoteEl.value);
      var schedDate = dateEl.value || null;

      if (!quote || quote <= 0) {
        showToast('Enter a valid quote amount', 'warning');
        return;
      }

      try {
        var resp = await apiCall('/api/collaboration/handoffs/' + handoffId, {
          method: 'PUT',
          body: JSON.stringify({
            quote_amount: quote,
            scheduled_date: schedDate ? new Date(schedDate).toISOString() : null
          })
        });
        var data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to save quote');

        showToast('Quote saved!', 'success');
        openHandoffDetailModal(handoffId);

        if (currentHandoffData && currentHandoffData.project_id) {
          logProjectActivity(currentHandoffData.project_id, 'quote_submitted', 'Fabrication quote of $' + quote.toFixed(2) + ' submitted');
        }
      } catch (err) {
        showToast(err.message || 'Error saving quote', 'error');
      }
    }

    async function handleHandoffFileUpload(handoffId) {
      var fileInput = document.getElementById('handoff-file-input');
      var file = fileInput && fileInput.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        showToast('File must be under 10MB', 'warning');
        return;
      }

      showToast('Uploading file...', 'info');

      try {
        var ext = file.name.split('.').pop();
        var fileName = 'handoff-files/' + handoffId + '-' + Date.now() + '.' + ext;

        var uploadResult = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file, { contentType: file.type, upsert: true });

        if (uploadResult.error) throw uploadResult.error;

        var urlResult = supabaseClient.storage.from('lead-images').getPublicUrl(fileName);
        var publicUrl = urlResult.data.publicUrl;

        var resp = await apiCall('/api/collaboration/handoffs/' + handoffId, {
          method: 'PUT',
          body: JSON.stringify({ design_file_url: publicUrl })
        });
        var data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to update handoff');

        showToast('Design file uploaded!', 'success');
        openHandoffDetailModal(handoffId);

        if (currentHandoffData && currentHandoffData.project_id) {
          logProjectActivity(currentHandoffData.project_id, 'file_uploaded', 'Design file uploaded to handoff');
        }
      } catch (err) {
        showToast('Upload failed: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function loadProjectHandoffs(projectId) {
      const container = document.getElementById('project-handoffs-list');
      if (!container) return;

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/handoffs');
        let data;
        try { data = await resp.json(); } catch (e) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">Could not load handoffs</div>';
          return;
        }
        if (!resp.ok) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">No handoffs yet</div>';
          return;
        }

        const handoffs = data.handoffs || data || [];
        if (!Array.isArray(handoffs) || handoffs.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">No handoffs yet. Start one from the My Designs page.</div>';
          return;
        }

        container.innerHTML = handoffs.map(function(h) {
          const stage = h.stage || 'design_created';
          const stageObj = HANDOFF_STAGES.find(function(s) { return s.key === stage; });
          const stageLabel = stageObj ? stageObj.label : stage;
          const stageIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === stage; });
          const isComplete = stage === 'final_review' && h.completed_at;
          return '<div onclick="closeProjectDetail(); openHandoffDetailModal(\'' + h.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.15s; border-bottom: 1px solid var(--dark-border);" onmouseover="this.style.background=\'var(--dark-card)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<div style="width: 36px; height: 36px; border-radius: 50%; background: ' + (isComplete ? 'rgba(34,197,94,0.15)' : 'rgba(212,175,55,0.2)') + '; display: flex; align-items: center; justify-content: center;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="' + (isComplete ? '#22c55e' : 'var(--gold-primary)') + '" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">' + escapeHtml(h.title || 'Untitled Handoff') + '</div>' +
              '<div style="font-size: 11px; color: var(--text-secondary);">Stage ' + (stageIdx + 1) + '/13: ' + stageLabel + '</div>' +
            '</div>' +
            '<span style="font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 12px; background: ' + (isComplete ? 'rgba(34,197,94,0.15)' : 'rgba(212,175,55,0.15)') + '; color: ' + (isComplete ? '#22c55e' : 'var(--gold-primary)') + ';">' + (isComplete ? 'Done' : stageLabel) + '</span>' +
          '</div>';
        }).join('');
      } catch (err) {
        console.error('[Handoff] Error loading project handoffs:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">Error loading handoffs</div>';
      }
    }

    // =============================================
    // BRIDGE 5: Collaborator Marketplace Listings in Project Detail
    // =============================================

    async function loadCollaboratorListings(projectId) {
      var container = document.getElementById('project-collab-listings-content');
      if (!container) return;

      try {
        // Get collaborator user IDs for this project
        var resp = await apiCall('/api/collaboration/projects/' + projectId + '/collaborators');
        var data;
        try { data = await resp.json(); } catch (e) { data = {}; }

        if (!resp.ok || !data.collaborators || !data.collaborators.length) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No collaborator listings yet. Invite fabricators to see their inventory here.</div>';
          return;
        }

        var userIds = data.collaborators.map(function(c) { return c.user_id; }).filter(Boolean);
        if (!userIds.length) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No collaborator listings available.</div>';
          return;
        }

        // Query stone_listings for collaborating users
        var result = await supabaseClient
          .from('stone_listings')
          .select('id, title, stone_name, material_type, price, image_url, city, state')
          .in('user_id', userIds)
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(6);

        if (result.error || !result.data || !result.data.length) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No active listings from collaborators.</div>';
          return;
        }

        container.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">' +
          result.data.map(function(l) {
            var name = escapeHtml(l.stone_name || l.title || 'Listing');
            var type = escapeHtml(l.material_type || '');
            var priceStr = l.price ? '<div style="font-size: 11px; color: var(--gold-primary); font-weight: 600;">$' + parseFloat(l.price).toFixed(2) + '</div>' : '<div style="font-size: 10px; color: var(--text-muted);">Contact for pricing</div>';
            var img = l.image_url ? '<img src="' + l.image_url + '" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px; margin-bottom: 6px;" loading="lazy" alt="' + escapeHtmlAttr(name) + '"/>' : '<div style="width: 100%; height: 80px; background: var(--dark-border); border-radius: 6px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 10px;">No Image</div>';
            return '<a href="/remnants/?listing=' + l.id + '" target="_blank" style="background: var(--dark-surface); border-radius: 8px; padding: 8px; text-decoration: none; color: inherit; display: block; border: 1px solid var(--border-subtle); transition: border-color 0.15s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
              img +
              '<div style="font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + name + '</div>' +
              '<div style="font-size: 10px; color: var(--text-muted);">' + type + '</div>' +
              priceStr +
            '</a>';
          }).join('') + '</div>';

      } catch (err) {
        console.error('[CollabListings] Error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">Could not load listings.</div>';
      }
    }

    // =============================================
    // BRIDGE 2: Convert Handoff Quote to Estimate
    // =============================================

    function fillField(id, value) {
      var el = document.getElementById(id);
      if (el && value) el.value = value;
    }

    async function convertHandoffToEstimate() {
      var handoff = currentHandoffData;
      if (!handoff || !handoff.quote_amount) {
        showToast('No handoff quote data available', 'warning');
        return;
      }

      closeHandoffDetailModal();

      // Fetch project details for customer info
      var project = null;
      if (handoff.project_id) {
        try {
          var result = await supabaseClient
            .from('projects')
            .select('*')
            .eq('id', handoff.project_id)
            .single();
          project = result.data;
        } catch (e) {
          console.warn('[Bridge2] Could not fetch project:', e);
        }
      }

      // Navigate to estimates page
      showPage('estimates');

      // Set up estimate modal state
      estimateModalState = {
        customerId: null,
        leadId: null,
        editingEstimateId: null
      };

      // Open modal after page renders
      setTimeout(function() {
        openCreateEstimateModal(false);

        // Pre-fill from project
        if (project) {
          fillField('estimate-customer-name', project.customer_name);
          fillField('estimate-customer-email', project.customer_email);
          fillField('estimate-customer-phone', project.customer_phone);
          fillField('estimate-customer-address', project.address);
          fillField('estimate-customer-city', project.city);
          fillField('estimate-customer-state', project.state);
          fillField('estimate-customer-zip', project.zip);
          fillField('estimate-project-name', project.name);
        }

        fillField('estimate-project-desc', (handoff.title || '') + (handoff.description ? ' - ' + handoff.description : ''));

        // Add the quote as a line item
        if (typeof addEstimateLineItem === 'function') {
          addEstimateLineItem();
          var lastItem = document.querySelector('#estimate-line-items .estimate-line-item:last-child');
          if (lastItem) {
            var nameEl = lastItem.querySelector('.item-name');
            var descEl = lastItem.querySelector('.item-desc');
            var qtyEl = lastItem.querySelector('.item-qty');
            var priceEl = lastItem.querySelector('.item-price');
            if (nameEl) nameEl.value = 'Fabrication & Installation';
            if (descEl) descEl.value = 'Per handoff quote - ' + (handoff.title || 'Design Handoff');
            if (qtyEl) qtyEl.value = '1';
            if (priceEl) priceEl.value = parseFloat(handoff.quote_amount) || 0;
            if (typeof updateEstimateTotals === 'function') updateEstimateTotals();
          }
        }

        fillField('estimate-notes', 'Converted from design handoff' + (handoff.id ? ' #' + handoff.id.substring(0, 8) : ''));

        showToast('Handoff quote loaded into estimate form', 'success');

        // Log activity
        if (handoff.project_id) {
          logProjectActivity(handoff.project_id, 'estimate_from_handoff', 'Created estimate from handoff quote');
        }
      }, 400);
    }

    // =============================================
    // CONTRACTORS
    // =============================================

    async function loadCollaborators() {
      const container = document.getElementById('collaborators-list');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: collaborators, error } = await supabaseClient
          .from('collaborators')
          .select('*')
          .eq('user_id', user.id)
          .order('name');

        if (error) throw error;

        allCollaborators = collaborators || [];
        renderCollaborators();
      } catch (err) {
        console.error('Load collaborators error:', err);
        container.innerHTML = `<div class="empty-state"><p>Error loading collaborators</p></div>`;
      }
    }

    function filterCollaborators(type) {
      contractorFilter = type;
      document.querySelectorAll('[data-collaborator-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.contractorStatus === type);
      });
      renderCollaborators();
    }

    function renderCollaborators() {
      const container = document.getElementById('collaborators-list');
      if (!container) return;

      let filtered = allCollaborators;
      if (contractorFilter !== 'all') {
        filtered = filtered.filter(c => c.type === contractorFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <h3>No collaborators found</h3>
            <p>Add your team members to assign them to jobs.</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewCollaboratorModal()">Add Collaborator</button>
          </div>`;
        return;
      }

      const getTrustBadgeColor = (score) => {
        if (score >= 70) return { bg: 'rgba(34, 197, 94, 0.15)', color: '#22c55e', label: 'Verified' };
        if (score >= 40) return { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b', label: 'Partial' };
        return { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280', label: 'New' };
      };

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          ${filtered.map(c => {
            const trust = getTrustBadgeColor(c.trust_score || 0);
            const isClaimed = !!c.claimed_by;
            return `
            <div class="contractor-card" onclick="openContractorProfile('${c.id}')" style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid ${isClaimed ? 'var(--gold-primary)' : 'var(--border-subtle)'}; cursor: pointer; transition: all 0.2s;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: 600; font-size: 15px;">${c.name}</span>
                    ${isClaimed ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="var(--gold-primary)" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>' : ''}
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted);">${c.company_name || ''}</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                  <span class="status-badge" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; font-size: 10px; padding: 4px 10px;">${c.type || 'other'}</span>
                  <div style="display: flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 10px; background: ${trust.bg};">
                    <span style="font-size: 11px; font-weight: 700; color: ${trust.color};">${c.trust_score || 0}</span>
                    <span style="font-size: 9px; color: ${trust.color};">${trust.label}</span>
                  </div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; min-height: 36px;">
                ${c.email ? `<div style="display: flex; align-items: center; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${c.email}</div>` : ''}
                ${c.phone ? `<div style="display: flex; align-items: center; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${c.phone}</div>` : ''}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
                <div style="font-size: 12px; color: var(--text-muted);">
                  ${c.total_jobs || 0} jobs assigned
                </div>
                <div style="display: flex; gap: 6px;" onclick="event.stopPropagation();">
                  <button class="action-btn" onclick="scheduleWithContractor('${c.id}')" title="Schedule Meeting" style="color: var(--accent);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  </button>
                  <button class="action-btn" onclick="openContractorProfile('${c.id}')" title="View Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                  </button>
                  <button class="action-btn" onclick="quickInviteContractor('${c.id}')" title="Send Portal Invite" style="color: var(--gold-primary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                  </button>
                  <button class="action-btn" onclick="inviteContractorAsCollaborator('${c.id}')" title="Invite as Collaborator">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  </button>
                </div>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function openNewCollaboratorModal() {
      document.getElementById('new-collaborator-modal').classList.add('active');
      document.getElementById('new-contractor-form').reset();
    }

    async function quickInviteContractor(contractorId) {
      const contractor = allCollaborators.find(c => c.id === contractorId);
      if (!contractor) return;

      // Generate invite link
      let token = contractor.invite_token;
      if (!token) {
        token = btoa(contractorId + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);
        try {
          await supabaseClient.from('collaborators').update({ invite_token: token }).eq('id', contractorId);
        } catch (e) { console.log('Could not save token:', e); }
      }

      const inviteUrl = `${window.location.origin}/contractor-portal/?token=${token}`;

      // Copy to clipboard
      try {
        await navigator.clipboard.writeText(inviteUrl);
        showToast('Invite link copied!');
      } catch (e) {
        // Fallback
        const input = document.createElement('input');
        input.value = inviteUrl;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('Invite link copied!');
      }

      // If they have email, offer to send or invite as collaborator
      if (contractor.email) {
        const action = prompt(
          `Portal link copied for ${contractor.company_name || contractor.name}!\n\nAdditional actions:\n1. Send email invite (type "email")\n2. Invite as project collaborator (type "collab")\n3. Done (press Enter)`,
          ''
        );
        if (action === 'email') {
          try {
            await apiCall('/api/collaborators/send-invite', {
              method: 'POST',
              body: JSON.stringify({
                contractor_id: contractorId,
                email: contractor.email,
                invite_link: inviteUrl
              })
            });
            showToast('Email sent!');
          } catch (err) {
            console.log('Could not send email:', err);
          }
        } else if (action === 'collab') {
          inviteContractorAsCollaborator(contractorId);
        }
      }
    }

    function closeNewCollaboratorModal() {
      document.getElementById('new-collaborator-modal').classList.remove('active');
    }

    function openInviteCollaboratorModal() {
      document.getElementById('invite-collaborator-modal').classList.add('active');
      document.getElementById('invite-contractor-form').reset();
    }

    function closeInviteCollaboratorModal() {
      document.getElementById('invite-collaborator-modal').classList.remove('active');
      // Reset the quick share link
      const linkInput = document.getElementById('quick-share-link');
      if (linkInput) linkInput.value = '';
      const copyBtn = document.getElementById('copy-link-btn');
      if (copyBtn) copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy Link';
    }

    async function generateAndCopyShareLink() {
      const linkInput = document.getElementById('quick-share-link');
      const copyBtn = document.getElementById('copy-link-btn');
      const originalBtnHtml = copyBtn.innerHTML;

      // If we already have a link, just copy it
      if (linkInput.value && linkInput.value.startsWith('http')) {
        try {
          await navigator.clipboard.writeText(linkInput.value);
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Copied!';
          showToast('Link copied to clipboard!', 'success');
          setTimeout(() => { copyBtn.innerHTML = originalBtnHtml; }, 2000);
          return;
        } catch (err) {
          showToast('Failed to copy', 'error');
          return;
        }
      }

      // Generate a new link
      copyBtn.disabled = true;
      copyBtn.innerHTML = '<span>Generating...</span>';

      try {
        const response = await apiCall('/api/collaboration/quick-share', { method: 'POST' });
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to generate link');
        }

        linkInput.value = data.link;

        // Copy to clipboard
        await navigator.clipboard.writeText(data.link);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Copied!';
        showToast('Link generated and copied!', 'success');
        setTimeout(() => { copyBtn.innerHTML = originalBtnHtml; }, 2000);

      } catch (err) {
        console.error('Quick share error:', err);
        showToast(err.message || 'Failed to generate link', 'error');
        copyBtn.innerHTML = originalBtnHtml;
      } finally {
        copyBtn.disabled = false;
      }
    }

    async function sendContractorInvitation(event) {
      event.preventDefault();

      const btn = document.getElementById('send-invite-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span>Sending...</span>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const email = document.getElementById('invite-contractor-email').value.trim();
        const message = document.getElementById('invite-contractor-message').value.trim();

        console.log('[Invite] Sending to:', email);

        // Use unified collaboration invite API - handles email sending properly
        const response = await apiCall('/api/collaboration/invite-general', {
          method: 'POST',
          body: JSON.stringify({
            email: email,
            notes: message || null
          })
        });

        console.log('[Invite] Response status:', response.status);
        const data = await response.json();
        console.log('[Invite] Response data:', data);

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Failed to send invitation');
        }

        closeInviteCollaboratorModal();
        showToast('Invitation sent to ' + email + '!', 'success');

        // Refresh collaborators list
        if (typeof loadMyNetwork === 'function') loadMyNetwork();

      } catch (err) {
        console.error('Send invitation error:', err);
        // User-friendly error messages
        let msg = err.message;
        if (msg.includes('already invited')) {
          msg = 'This person has already been invited';
        }
        showToast(msg, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function createContractor(event) {
      event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const contractorData = {
          user_id: user.id,
          name: document.getElementById('contractor-name').value.trim(),
          type: document.getElementById('contractor-type').value,
          email: document.getElementById('contractor-email').value.trim() || null,
          phone: document.getElementById('contractor-phone').value.trim() || null,
          company_name: document.getElementById('contractor-company').value.trim() || null,
          hourly_rate: parseFloat(document.getElementById('contractor-rate').value) || null,
          license_number: document.getElementById('contractor-license').value.trim() || null,
          notes: document.getElementById('contractor-notes').value.trim() || null
        };

        const { error } = await supabaseClient.from('collaborators').insert([contractorData]);
        if (error) throw error;

        closeNewCollaboratorModal();
        showToast('Contractor added!');
        loadCollaborators();
      } catch (err) {
        console.error('Create contractor error:', err);
        alert('Error adding contractor: ' + err.message);
      }
    }

    function openAssignCollaboratorModal(jobId = null) {
      // Use provided jobId or fall back to currentJobId
      if (jobId) {
        currentJobId = jobId;
      }
      if (!currentJobId) {
        showToast('Please select a job first', 'warning');
        return;
      }
      document.getElementById('assign-collaborator-modal').classList.add('active');
      // Reset inline form
      document.getElementById('new-contractor-inline').style.display = 'none';
      document.getElementById('assign-contractor-select').style.display = 'block';
      document.getElementById('assign-contractor-select').removeAttribute('disabled');
      loadCollaboratorsForSelect();
    }

    function closeAssignCollaboratorModal() {
      document.getElementById('assign-collaborator-modal').classList.remove('active');
      cancelNewContractorInline();
    }

    function toggleNewContractorInAssign() {
      const select = document.getElementById('assign-contractor-select');
      const inlineForm = document.getElementById('new-contractor-inline');

      if (select.value === '__new__') {
        inlineForm.style.display = 'block';
        // Clear inline form fields
        document.getElementById('inline-contractor-name').value = '';
        document.getElementById('inline-contractor-company').value = '';
        document.getElementById('inline-contractor-email').value = '';
        document.getElementById('inline-contractor-phone').value = '';
        // Set role based on selection
        const role = document.getElementById('assign-contractor-role').value;
        document.getElementById('inline-contractor-name').focus();
      } else {
        inlineForm.style.display = 'none';
      }
    }

    function cancelNewContractorInline() {
      const select = document.getElementById('assign-contractor-select');
      const inlineForm = document.getElementById('new-contractor-inline');
      inlineForm.style.display = 'none';
      select.value = '';
    }

    async function loadCollaboratorsForSelect() {
      const select = document.getElementById('assign-contractor-select');
      if (!select) return;

      select.innerHTML = `
        <option value="">-- Select Contractor --</option>
        <option value="__new__" style="color: var(--gold-primary); font-weight: 600;">+ Add New Contractor</option>
      `;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: collaborators } = await supabaseClient
          .from('collaborators')
          .select('id, name, type, company_name')
          .eq('user_id', user.id)
          .order('name');

        if (collaborators && collaborators.length > 0) {
          select.innerHTML += '<option disabled></option>';
          (collaborators || []).forEach(c => {
            const displayName = c.company_name ? `${c.name} - ${c.company_name}` : c.name;
            select.innerHTML += `<option value="${c.id}">${displayName} (${c.type})</option>`;
          });
        }
      } catch (err) {
        console.error('Load collaborators for select error:', err);
      }
    }

    async function assignContractor(event) {
      event.preventDefault();

      if (!currentJobId) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        let contractorId = document.getElementById('assign-contractor-select').value;

        // Check if we need to create a new contractor first
        if (contractorId === '__new__') {
          const newName = document.getElementById('inline-contractor-name').value.trim();
          if (!newName) throw new Error('Please enter contractor name');

          const role = document.getElementById('assign-contractor-role').value;
          const contractorData = {
            user_id: user.id,
            name: newName,
            type: role, // Use the selected role as the contractor type
            company_name: document.getElementById('inline-contractor-company').value.trim() || null,
            email: document.getElementById('inline-contractor-email').value.trim() || null,
            phone: document.getElementById('inline-contractor-phone').value.trim() || null
          };

          const { data: newContractor, error: createError } = await supabaseClient
            .from('collaborators')
            .insert([contractorData])
            .select()
            .single();

          if (createError) throw createError;
          contractorId = newContractor.id;
          showToast('Contractor created!');
        }

        if (!contractorId || contractorId === '__new__') {
          throw new Error('Please select or create a contractor');
        }

        const assignData = {
          project_id: currentJobId,
          contractor_id: contractorId,
          user_id: user.id,
          role: document.getElementById('assign-contractor-role').value,
          agreed_rate: parseFloat(document.getElementById('assign-contractor-amount').value) || 0,
          status: 'pending'
        };

        const { error } = await supabaseClient.from('project_contractors').insert([assignData]);
        if (error) throw error;

        const shouldNotify = document.getElementById('assign-contractor-notify').checked;
        if (shouldNotify) {
          // Send invite email via API
          try {
            await apiCall(`/api/projects/${currentJobId}/contractors`, {
              method: 'POST',
              body: JSON.stringify({ contractor_id: contractorId, send_invite: true })
            });
          } catch (apiErr) {
            console.log('Could not send invite email:', apiErr);
          }
        }

        closeAssignCollaboratorModal();
        showToast('Contractor assigned!');
        loadJobs();
        loadCollaborators(); // Refresh collaborators list too
        if (currentJobId) {
          const job = allJobs.find(j => j.id === currentJobId);
          if (job) openJobDetail(currentJobId);
        }

        // Offer to also invite as project collaborator
        const assignedContractor = allCollaborators.find(c => c.id === contractorId);
        if (assignedContractor && assignedContractor.email) {
          const alsoCollab = confirm(`Contractor assigned! Also invite ${assignedContractor.email} as a project collaborator?`);
          if (alsoCollab) {
            inviteJobContractorAsCollaborator(contractorId);
          }
        }
      } catch (err) {
        console.error('Assign contractor error:', err);
        alert('Error assigning contractor: ' + err.message);
      }
    }

    // =============================================
    // CALENDAR
    // =============================================

    let currentCalendarDate = new Date();
    let calendarEvents = [];

    async function initCalendar() {
      renderCalendar();
      // Ensure jobs and customers are loaded for scheduling
      if (allJobs.length === 0) await loadJobs();
      if (allCustomers.length === 0) await loadCustomers();
      loadCalendarEvents();
    }

    function changeCalendarMonth(delta) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
      renderCalendar();
      loadCalendarEvents();
    }

    function goToToday() {
      currentCalendarDate = new Date();
      renderCalendar();
      loadCalendarEvents();
    }

    // Calendar Scheduling Variables
    let selectedScheduleDate = null;

    // Open Quick Schedule Modal
    function openQuickScheduleModal(preselectedDate = null, preselectedJobId = null) {
      const modal = document.getElementById('quick-schedule-modal');
      if (!modal) return;

      // Reset form
      document.getElementById('quick-schedule-form').reset();

      // Populate customers dropdown
      const customerSelect = document.getElementById('schedule-customer-select');
      customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';
      allCustomers.forEach(c => {
        customerSelect.innerHTML += `<option value="${c.id}">${c.name} ${c.email ? '(' + c.email + ')' : ''}</option>`;
      });

      // Populate jobs dropdown
      const jobSelect = document.getElementById('schedule-job-select');
      jobSelect.innerHTML = '<option value="">-- Create New or Select Existing --</option>';
      allJobs.filter(j => j.status !== 'completed' && j.status !== 'cancelled').forEach(j => {
        jobSelect.innerHTML += `<option value="${j.id}">${j.job_number || 'Job'} - ${j.customer_name || j.description}</option>`;
      });

      // Preselect job if provided
      if (preselectedJobId) {
        jobSelect.value = preselectedJobId;
      }

      // Set date if preselected
      if (preselectedDate) {
        document.getElementById('schedule-date').value = preselectedDate;
        selectedScheduleDate = preselectedDate;
      } else {
        // Default to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('schedule-date').value = today;
      }

      toggleScheduleFields();
      modal.classList.add('active');
    }

    function closeQuickScheduleModal() {
      document.getElementById('quick-schedule-modal').classList.remove('active');
      selectedScheduleDate = null;
    }

    function toggleScheduleFields() {
      const jobSelect = document.getElementById('schedule-job-select');
      const newJobFields = document.getElementById('schedule-new-job-fields');
      const descInput = document.getElementById('schedule-description');
      const customerSelect = document.getElementById('schedule-customer-select');

      if (jobSelect.value) {
        // Existing job selected - hide new job fields
        newJobFields.style.display = 'none';
        descInput.removeAttribute('required');
        customerSelect.removeAttribute('required');
      } else {
        // Creating new - show fields
        newJobFields.style.display = 'block';
        descInput.setAttribute('required', 'required');
      }
    }

    async function submitQuickSchedule(e) {
      e.preventDefault();

      const eventType = document.getElementById('schedule-event-type').value;
      const jobId = document.getElementById('schedule-job-select').value;
      const customerId = document.getElementById('schedule-customer-select').value;
      const description = document.getElementById('schedule-description').value;
      const scheduleDate = document.getElementById('schedule-date').value;
      const scheduleTime = document.getElementById('schedule-time').value;
      const duration = document.getElementById('schedule-duration').value;
      const notes = document.getElementById('schedule-notes').value;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        let targetJobId = jobId;

        // If no existing job selected, create a new one
        if (!jobId) {
          if (!customerId) {
            showToast('Please select a customer', 'error');
            return;
          }

          const customer = allCustomers.find(c => c.id === customerId);

          // Generate job number
          const { count } = await supabaseClient
            .from('projects')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', user.id);

          const jobNumber = `JOB-${String((count || 0) + 1).padStart(4, '0')}`;

          // Create the job
          const { data: newJob, error: jobError } = await supabaseClient
            .from('projects')
            .insert({
              user_id: user.id,
              customer_id: customerId,
              customer_name: customer?.name || 'Customer',
              customer_email: customer?.email || null,
              customer_phone: customer?.phone || null,
              job_number: jobNumber,
              description: description,
              status: 'scheduled',
              estimated_start_date: scheduleDate,
              notes: notes
            })
            .select()
            .single();

          if (jobError) throw jobError;
          targetJobId = newJob.id;

          // Add to local array
          allJobs.unshift(newJob);
        }

        // Update the job with the scheduled date/time based on event type
        const updateData = { updated_at: new Date().toISOString() };

        if (eventType === 'measure') {
          updateData.field_measure_date = scheduleTime ? `${scheduleDate}T${scheduleTime}:00` : scheduleDate;
        } else if (eventType === 'job' || eventType === 'consultation') {
          updateData.estimated_start_date = scheduleDate;
          if (scheduleTime) {
            updateData.scheduled_time = scheduleTime;
          }
        } else {
          updateData.estimated_start_date = scheduleDate;
        }

        if (notes && targetJobId) {
          updateData.notes = notes;
        }

        if (targetJobId) {
          await supabaseClient
            .from('projects')
            .update(updateData)
            .eq('id', targetJobId);

          // Update local array
          const jobIdx = allJobs.findIndex(j => j.id === targetJobId);
          if (jobIdx !== -1) {
            Object.assign(allJobs[jobIdx], updateData);
          }
        }

        showToast('Event scheduled successfully!');
        closeQuickScheduleModal();
        closeDayEventsModal();
        loadCalendarEvents();
        renderCalendar();

      } catch (err) {
        console.error('Schedule error:', err);
        showToast('Error scheduling: ' + err.message, 'error');
      }
    }

    // Day Events Modal
    function showDayEvents(dateStr) {
      selectedScheduleDate = dateStr;
      const modal = document.getElementById('day-events-modal');
      if (!modal) return;

      const date = new Date(dateStr + 'T12:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('day-events-title').textContent = date.toLocaleDateString('en-US', options);

      const dayEvents = calendarEvents.filter(e => e.date === dateStr);
      const content = document.getElementById('day-events-content');

      if (dayEvents.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 12px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p>No events scheduled</p>
            <p style="font-size: 13px; margin-top: 8px;">Click "Add Event" to schedule something</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="list-modern">
            ${dayEvents.map(evt => {
              const typeColors = {
                job: '#3b82f6',
                appointment: '#3b82f6',
                measure: '#f59e0b',
                measurement: '#f59e0b',
                install: '#10b981',
                installation: '#10b981',
                consultation: '#ec4899',
                delivery: '#06b6d4',
                meeting: '#8b5cf6',
                follow_up: '#6b7280',
                production: '#8b5cf6',
                other: '#6b7280'
              };
              const statusInfo = {
                scheduled: { color: '#f59e0b', label: 'Pending' },
                confirmed: { color: '#10b981', label: 'Confirmed' },
                completed: { color: '#6366f1', label: 'Completed' },
                cancelled: { color: '#ef4444', label: 'Cancelled' },
                rescheduled: { color: '#3b82f6', label: 'Rescheduled' },
                no_show: { color: '#6b7280', label: 'No Show' }
              };
              const color = typeColors[evt.type] || '#3b82f6';
              const status = statusInfo[evt.status] || { color: '#f59e0b', label: 'Pending' };
              const clickHandler = evt.apiEventId
                ? `openCalendarEventDetailModal('${evt.apiEventId}')`
                : (evt.jobId ? `openJobDetail('${evt.jobId}')` : '');
              const eventData = JSON.stringify({
                title: evt.title,
                type: evt.type,
                date: evt.date,
                apiEventId: evt.apiEventId || null,
                jobId: evt.jobId || null,
                status: evt.status || 'scheduled'
              }).replace(/"/g, '&quot;');
              return `
                <div class="list-item-modern"
                     data-context-menu="calendar_event"
                     data-item-id="${evt.apiEventId || evt.jobId || ''}"
                     data-item-data="${eventData}"
                     onclick="${clickHandler}" style="cursor: pointer;">
                  <div class="list-item-icon" style="background: ${color}20; color: ${color};">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="list-item-content">
                    <div class="list-item-title">${escapeHtml(evt.title)}</div>
                    <div class="list-item-subtitle">${evt.type.charAt(0).toUpperCase() + evt.type.slice(1).replace('_', ' ')}</div>
                  </div>
                  <div class="list-item-meta">
                    <span class="badge-modern" style="background: ${status.color}20; color: ${status.color};">${status.label}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeDayEventsModal() {
      document.getElementById('day-events-modal').classList.remove('active');
    }

    function openQuickScheduleForDate() {
      closeDayEventsModal();
      openCalendarEventModal(null, selectedScheduleDate);
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const monthYearEl = document.getElementById('calendar-month-year');
      if (!grid || !monthYearEl) return;

      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      monthYearEl.textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and total days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const totalDays = lastDay.getDate();

      // Get previous month's days to show
      const prevMonthLastDay = new Date(year, month, 0).getDate();

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      let html = '';
      let dayCount = 1;
      let nextMonthDay = 1;

      // Generate 6 weeks (42 days)
      for (let i = 0; i < 42; i++) {
        let dayNumber, dateStr, isOtherMonth = false;

        if (i < startDayOfWeek) {
          // Previous month days
          dayNumber = prevMonthLastDay - startDayOfWeek + i + 1;
          const prevMonth = month === 0 ? 12 : month;
          const prevYear = month === 0 ? year - 1 : year;
          dateStr = `${prevYear}-${String(prevMonth).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          isOtherMonth = true;
        } else if (dayCount <= totalDays) {
          // Current month days
          dayNumber = dayCount;
          dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          dayCount++;
        } else {
          // Next month days
          dayNumber = nextMonthDay;
          const nextMonth = month === 11 ? 1 : month + 2;
          const nextYear = month === 11 ? year + 1 : year;
          dateStr = `${nextYear}-${String(nextMonth).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          nextMonthDay++;
          isOtherMonth = true;
        }

        const isToday = dateStr === todayStr;
        const dayEvents = calendarEvents.filter(e => e.date === dateStr);

        html += `
          <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"
               data-date="${dateStr}"
               onclick="showDayEvents('${dateStr}')"
               ondragover="handleCalendarDragOver(event)"
               ondragleave="handleCalendarDragLeave(event)"
               ondrop="handleCalendarDrop(event, '${dateStr}')">
            <div class="calendar-day-number">${dayNumber}</div>
            <div class="calendar-events">
              ${dayEvents.slice(0, 3).map(e => {
                const clickHandler = e.apiEventId
                  ? `openCalendarEventDetailModal('${e.apiEventId}')`
                  : (e.jobId ? `openJobDetail('${e.jobId}')` : `showDayEvents('${dateStr}')`);
                const eventData = JSON.stringify({
                  title: e.title,
                  type: e.type,
                  date: e.date,
                  apiEventId: e.apiEventId || null,
                  jobId: e.jobId || null,
                  status: e.status || 'scheduled'
                }).replace(/"/g, '&quot;');
                return `
                <div class="calendar-event ${e.type}"
                     data-context-menu="calendar_event"
                     data-item-id="${e.apiEventId || e.jobId || ''}"
                     data-item-data="${eventData}"
                     data-event-id="${e.apiEventId || ''}"
                     data-job-id="${e.jobId || ''}"
                     draggable="true"
                     ondragstart="handleCalendarDragStart(event, '${e.apiEventId || ''}', '${e.jobId || ''}', '${e.date}')"
                     ondragend="handleCalendarDragEnd(event)"
                     onclick="event.stopPropagation(); ${clickHandler}">
                  ${escapeHtml(e.title)}
                </div>
              `}).join('')}
              ${dayEvents.length > 3 ? `<div class="calendar-event-more">+${dayEvents.length - 3} more</div>` : ''}
            </div>
          </div>
        `;
      }

      grid.innerHTML = html;
    }

    // ============================================
    // CALENDAR DRAG AND DROP
    // ============================================
    let draggedEventId = null;
    let draggedJobId = null;
    let draggedEventOriginalDate = null;

    function handleCalendarDragStart(event, eventId, jobId, originalDate) {
      draggedEventId = eventId || null;
      draggedJobId = jobId || null;
      draggedEventOriginalDate = originalDate;

      event.target.classList.add('dragging');
      document.body.classList.add('dragging-active');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', JSON.stringify({ eventId, jobId, originalDate }));

      console.log('[DragDrop] handleCalendarDragStart - existing event:', { eventId, jobId, originalDate });

      // Add visual feedback
      setTimeout(() => {
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.add('drop-target-ready');
        });
      }, 0);
    }

    function handleCalendarDragEnd(event) {
      event.target.classList.remove('dragging');
      document.body.classList.remove('dragging-active');
      draggedEventId = null;
      draggedJobId = null;
      draggedEventOriginalDate = null;

      // Remove visual feedback
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('drop-target-ready', 'drag-over');
      });
    }

    function handleCalendarDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      // Check if this is a quick add (copy) or event move
      const effectAllowed = event.dataTransfer.effectAllowed;
      if (effectAllowed === 'copy' || effectAllowed === 'copyMove') {
        event.dataTransfer.dropEffect = 'copy';
      } else {
        event.dataTransfer.dropEffect = 'move';
      }
      event.currentTarget.classList.add('drag-over');
      console.log('[DragDrop] DragOver on:', event.currentTarget.dataset?.date || 'unknown');
    }

    function handleCalendarDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    // ============================================
    // QUICK ADD - DRAG EVENT TYPES TO CALENDAR
    // ============================================
    let quickAddEventType = null;
    let quickAddEventTitle = null;
    let quickAddEventColor = null;

    function handleQuickAddDragStart(event, eventType, eventTitle, eventColor) {
      console.log('[DragDrop] handleQuickAddDragStart called:', eventType);
      quickAddEventType = eventType;
      quickAddEventTitle = eventTitle;
      quickAddEventColor = eventColor;

      event.target.classList.add('dragging');
      document.body.classList.add('dragging-active');
      event.dataTransfer.effectAllowed = 'copyMove';

      // Set data in multiple formats for cross-browser compatibility
      const dragData = JSON.stringify({
        isQuickAdd: true,
        eventType,
        eventTitle,
        eventColor
      });
      event.dataTransfer.setData('application/json', dragData);
      event.dataTransfer.setData('text/plain', dragData); // Fallback for some browsers

      console.log('[DragDrop] Data set, adding visual feedback');
      // Add visual feedback to calendar days
      setTimeout(() => {
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.add('drop-target-ready');
        });
        console.log('[DragDrop] Visual feedback added to calendar days');
      }, 0);
    }

    function handleQuickAddDragEnd(event) {
      event.target.classList.remove('dragging');
      document.body.classList.remove('dragging-active');
      quickAddEventType = null;
      quickAddEventTitle = null;
      quickAddEventColor = null;

      // Remove visual feedback
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('drop-target-ready', 'drag-over', 'drop-new-event');
      });
    }

    // Handle calendar drop - supports both event moves and quick add drops
    async function handleCalendarDrop(event, newDate) {
      console.log('[DragDrop] handleCalendarDrop called:', newDate);
      event.preventDefault();
      event.stopPropagation();

      const targetDay = event.currentTarget;
      targetDay.classList.remove('drag-over', 'drop-new-event');

      // Check if this is a quick add drop - try both data formats
      try {
        let dragData = event.dataTransfer.getData('application/json');
        // Fallback to text/plain for browser compatibility
        if (!dragData) {
          dragData = event.dataTransfer.getData('text/plain');
        }
        console.log('[DragDrop] Retrieved drag data:', dragData ? 'yes' : 'no');

        if (dragData) {
          const data = JSON.parse(dragData);
          console.log('[DragDrop] Parsed data:', data);
          if (data.isQuickAdd) {
            console.log('[DragDrop] Quick add detected, opening modal');
            // Open event modal with prefilled data
            openCalendarEventModal(null, newDate, {
              type: data.eventType,
              title: data.eventTitle
            });

            // Clean up
            document.body.classList.remove('dragging-active');
            document.querySelectorAll('.calendar-day').forEach(day => {
              day.classList.remove('drop-target-ready', 'drag-over', 'drop-new-event');
            });
            return;
          }
        }
      } catch (e) {
        console.log('[DragDrop] Error parsing drag data:', e.message);
        // Not JSON data, continue with regular drop
      }

      // Check if this is a quick add from state
      if (quickAddEventType) {
        openCalendarEventModal(null, newDate, {
          type: quickAddEventType,
          title: quickAddEventTitle
        });

        // Clean up
        quickAddEventType = null;
        quickAddEventTitle = null;
        quickAddEventColor = null;
        document.body.classList.remove('dragging-active');
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('drop-target-ready', 'drag-over', 'drop-new-event');
        });
        return;
      }

      // Otherwise, handle as event move
      // Parse drag data for event move
      let eventId = draggedEventId;
      let jobId = draggedJobId;

      try {
        const plainData = event.dataTransfer.getData('text/plain');
        if (plainData) {
          const parsed = JSON.parse(plainData);
          eventId = parsed.eventId || eventId;
          jobId = parsed.jobId || jobId;
        }
      } catch (e) {
        // Use fallback values
      }

      if (newDate === draggedEventOriginalDate) {
        return;
      }

      // Handle API event (calendar_events table)
      if (eventId) {
        try {
          const { data: original, error: fetchError } = await supabaseClient
            .from('calendar_events')
            .select('start_time, end_time')
            .eq('id', eventId)
            .single();

          if (fetchError) throw fetchError;

          const oldStart = new Date(original.start_time);
          const oldEnd = new Date(original.end_time);
          const duration = oldEnd - oldStart;

          const newStart = new Date(newDate + 'T' + oldStart.toTimeString().slice(0, 8));
          const newEnd = new Date(newStart.getTime() + duration);

          const { error: updateError } = await supabaseClient
            .from('calendar_events')
            .update({
              start_time: newStart.toISOString(),
              end_time: newEnd.toISOString(),
              updated_at: new Date().toISOString()
            })
            .eq('id', eventId);

          if (updateError) throw updateError;

          showToast('Event moved to ' + new Date(newDate).toLocaleDateString(), 'success');
          await loadCalendarEvents();
          await loadAllCalendarEvents();

        } catch (err) {
          console.error('Error moving event:', err);
          showToast('Failed to move event', 'error');
        }
        return;
      }

      // Handle job-based event (projects table)
      if (jobId) {
        const draggedEvent = calendarEvents.find(e => e.jobId === jobId && e.date === draggedEventOriginalDate);

        if (!draggedEvent) {
          showToast('Could not find event to move', 'error');
          return;
        }

        try {
          let updateField = null;
          if (draggedEvent.type === 'measure') {
            updateField = 'field_measure_date';
          } else if (draggedEvent.type === 'install') {
            updateField = 'install_date';
          } else if (draggedEvent.type === 'job') {
            updateField = 'estimated_start_date';
          }

          if (!updateField) {
            showToast('Cannot reschedule this event type', 'warning');
            return;
          }

          const { error: updateError } = await supabaseClient
            .from('projects')
            .update({ [updateField]: newDate })
            .eq('id', jobId);

          if (updateError) throw updateError;

          showToast(`${draggedEvent.type.charAt(0).toUpperCase() + draggedEvent.type.slice(1)} moved to ${new Date(newDate).toLocaleDateString()}`, 'success');
          await loadCalendarEvents();
          await loadAllCalendarEvents();

        } catch (err) {
          console.error('Error moving job event:', err);
          showToast('Failed to move event', 'error');
        }
      }
    };

    async function loadCalendarEvents() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Get projects with dates
        const { data: jobs, error } = await supabaseClient
          .from('projects')
          .select('id, job_number, customer_name, name, description, status, estimated_start_date, field_measure_date, install_date')
          .eq('user_id', user.id)
          .not('status', 'in', '("completed","cancelled")');

        if (error) throw error;

        // Keep API events (appointments), clear only job-based events
        // This prevents API appointments from disappearing when this function is called alone
        calendarEvents = calendarEvents.filter(e => e.apiEventId);

        (jobs || []).forEach(job => {
          const title = job.customer_name || job.name || job.description || job.job_number;

          if (job.estimated_start_date) {
            calendarEvents.push({
              date: job.estimated_start_date,
              title: title,
              type: 'job',
              jobId: job.id,
              status: job.status
            });
          }

          if (job.field_measure_date) {
            const measureDate = job.field_measure_date.split('T')[0];
            calendarEvents.push({
              date: measureDate,
              title: `Measure: ${title}`,
              type: 'measure',
              jobId: job.id,
              status: job.status
            });
          }

          if (job.install_date) {
            const installDate = job.install_date.split('T')[0];
            calendarEvents.push({
              date: installDate,
              title: `Install: ${title}`,
              type: 'install',
              jobId: job.id,
              status: job.status
            });
          }
        });

        renderCalendar();
        renderUpcomingEvents();
      } catch (err) {
        console.error('Load calendar events error:', err);
      }
    }

    function renderUpcomingEvents() {
      const container = document.getElementById('upcoming-events-list');
      if (!container) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const upcoming = calendarEvents
        .filter(e => new Date(e.date) >= today)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 10);

      if (upcoming.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 30px;">
            <p style="color: var(--text-muted);">No upcoming events scheduled</p>
          </div>
        `;
        return;
      }

      const typeColors = {
        job: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' },
        appointment: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' },
        install: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981' },
        installation: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981' },
        measure: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' },
        measurement: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' },
        production: { bg: 'rgba(139, 92, 246, 0.15)', color: '#8b5cf6' },
        meeting: { bg: 'rgba(139, 92, 246, 0.15)', color: '#8b5cf6' },
        consultation: { bg: 'rgba(236, 72, 153, 0.15)', color: '#ec4899' },
        delivery: { bg: 'rgba(6, 182, 212, 0.15)', color: '#06b6d4' },
        follow_up: { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280' },
        site_visit: { bg: 'rgba(249, 115, 22, 0.15)', color: '#f97316' },
        other: { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280' }
      };

      const typeNames = {
        job: 'Scheduled',
        appointment: 'Appointment',
        install: 'Installation',
        installation: 'Installation',
        measure: 'Field Measure',
        measurement: 'Measurement',
        production: 'In Production',
        meeting: 'Meeting',
        consultation: 'Consultation',
        delivery: 'Delivery',
        follow_up: 'Follow-up',
        site_visit: 'Site Visit',
        other: 'Event'
      };

      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      container.innerHTML = upcoming.map(event => {
        const date = new Date(event.date + 'T00:00:00');
        const colors = typeColors[event.type] || typeColors.job;
        const typeName = typeNames[event.type] || 'Event';

        // Determine click handler based on event source
        const clickHandler = event.apiEventId
          ? `openCalendarEventDetailModal('${event.apiEventId}')`
          : (event.jobId ? `openJobDetail('${event.jobId}')` : '');

        return `
          <div class="upcoming-event-item" onclick="${clickHandler}" style="${clickHandler ? 'cursor: pointer;' : ''}">
            <div class="upcoming-event-date">
              <span class="day">${date.getDate()}</span>
              <span class="month">${monthNames[date.getMonth()]}</span>
            </div>
            <div class="upcoming-event-info">
              <div class="upcoming-event-title">${escapeHtml(event.title)}</div>
              <div class="upcoming-event-details">
                <span class="upcoming-event-type" style="background: ${colors.bg}; color: ${colors.color};">${typeName}</span>
                ${event.hasParticipants ? '<span style="margin-left: 6px; font-size: 11px; color: var(--text-muted);"></span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // =============================================
    // CUSTOMERS MODAL
    // =============================================

    function openCustomersModal() {
      document.getElementById('customers-modal').classList.add('active');
      loadCustomersModal();
    }

    function closeCustomersModal() {
      document.getElementById('customers-modal').classList.remove('active');
    }

    function openAddCustomerModal(customerId = null) {
      const modal = document.getElementById('add-customer-modal');
      const form = document.getElementById('add-customer-form');
      const title = document.getElementById('add-customer-modal-title');

      // Reset form
      form.reset();
      document.getElementById('edit-customer-id').value = '';

      if (customerId) {
        // Edit mode - find customer and populate form
        title.textContent = 'Edit Customer';
        const customer = allCustomers?.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('edit-customer-id').value = customer.id;
          document.getElementById('cust-name').value = customer.name || '';
          document.getElementById('cust-email').value = customer.email || '';
          document.getElementById('cust-phone').value = customer.phone || '';
          document.getElementById('cust-company').value = customer.company || '';
          document.getElementById('cust-address').value = customer.address || '';
          document.getElementById('cust-city').value = customer.city || '';
          document.getElementById('cust-state').value = customer.state || 'AZ';
          document.getElementById('cust-zip').value = customer.zip || '';
          const notesField = document.getElementById('cust-notes');
          if (notesField) notesField.value = customer.notes || '';
        }
      } else {
        title.textContent = 'Add New Customer';
      }

      modal.classList.add('active');
    }

    function closeAddCustomerModal() {
      document.getElementById('add-customer-modal').classList.remove('active');
    }

    async function saveCustomer(event) {
      event.preventDefault();

      const customerId = document.getElementById('edit-customer-id').value;
      const notesField = document.getElementById('cust-notes');
      const customerData = {
        name: document.getElementById('cust-name').value.trim(),
        email: document.getElementById('cust-email').value.trim() || null,
        phone: document.getElementById('cust-phone').value.trim() || null,
        company: document.getElementById('cust-company').value.trim() || null,
        address: document.getElementById('cust-address').value.trim() || null,
        city: document.getElementById('cust-city').value.trim() || null,
        state: document.getElementById('cust-state').value.trim() || null,
        zip: document.getElementById('cust-zip').value.trim() || null,
        notes: notesField ? notesField.value.trim() || null : null
      };

      if (!customerData.name) {
        showToast('Customer name is required', 'error');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          showToast('Please log in first', 'error');
          return;
        }

        let result;
        if (customerId) {
          // Update existing customer
          result = await supabaseClient
            .from('customers')
            .update(customerData)
            .eq('id', customerId)
            .eq('user_id', user.id)
            .select()
            .single();
        } else {
          // Create new customer
          result = await supabaseClient
            .from('customers')
            .insert({ ...customerData, user_id: user.id })
            .select()
            .single();
        }

        if (result.error) throw result.error;

        showToast(customerId ? 'Customer updated!' : 'Customer created!');
        closeAddCustomerModal();
        loadCustomersModal(); // Refresh the list
      } catch (err) {
        console.error('Save customer error:', err);
        showToast('Error saving customer: ' + err.message, 'error');
      }
    }

    // UNIFIED: Start estimate from customer - uses centralized state
    async function startEstimateFromCustomer(customerId) {
      // Use helper to fetch customer (handles cache and DB lookup)
      const customer = await getCustomer(customerId) || selectedCustomer;

      if (!customer) {
        showToast('Customer not found. Please select a customer first.', 'error');
        return;
      }

      // Update unified workflow state
      workflowState.currentCustomer = customer;
      selectedCustomer = customer;

      // Close any open modals
      if (typeof closeCustomersModal === 'function') closeCustomersModal();
      if (typeof closeCustomerModal === 'function') closeCustomerModal();

      // Navigate to estimates page
      showPage('estimates');

      // Small delay to ensure page is rendered
      setTimeout(() => {
        // Set modal state with proper customer linkage (no more dataset attributes)
        estimateModalState = {
          customerId: customer.id,
          leadId: null,
          editingEstimateId: null
        };

        // Open estimate modal (preserveState=true since we set estimateModalState above)
        openCreateEstimateModal(true);

        // Pre-fill customer info using helper
        fillEstimateCustomerFields(customer);

        showToast(`Creating estimate for ${customer.name}`);
      }, 100);
    }

    // Backward compatibility alias
    async function createEstimateForCustomer(customerId) {
      return startEstimateFromCustomer(customerId);
    }

    async function loadCustomersModal() {
      const container = document.getElementById('customers-list-modal');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .order('name');

        if (error) throw error;

        // Store in global array for other functions
        allCustomers = customers || [];

        if (!customers || customers.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No customers yet. Click "Add Customer" to create one.</div>';
          return;
        }

        container.innerHTML = `
          <table style="width: 100%;">
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Jobs</th>
                <th>Total Spent</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${customers.map(c => `
                <tr>
                  <td>
                    <strong>${c.name}</strong>
                    ${c.company ? `<div style="font-size: 12px; color: var(--text-muted);">${c.company}</div>` : ''}
                  </td>
                  <td>
                    <div style="font-size: 13px;">${c.email || '-'}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">${c.phone || ''}</div>
                  </td>
                  <td>${c.total_jobs || 0}</td>
                  <td style="color: var(--gold-primary); font-weight: 600;">$${(c.total_spent || 0).toFixed(2)}</td>
                  <td>
                    <div style="display: flex; gap: 8px;">
                      <button onclick="createEstimateForCustomer('${c.id}')" class="btn-modern small" style="font-size: 12px; padding: 6px 10px;">
                        <i class="fas fa-file-invoice"></i> Estimate
                      </button>
                      <button onclick="openAddCustomerModal('${c.id}')" class="btn-modern secondary small" style="font-size: 12px; padding: 6px 10px;">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Load customers error:', err);
        container.innerHTML = '<div style="color: var(--text-muted);">Error loading customers</div>';
      }
    }

    function searchCustomers() {
      // Simple client-side search
      const query = document.getElementById('customer-search').value.toLowerCase();
      const rows = document.querySelectorAll('#customers-list-modal tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
      });
    }

    async function sendCustomerUpdate() {
      // Placeholder for sending customer update email
      showToast('Customer update feature coming soon!', 'info');
    }

    async function orderMaterials() {
      // Placeholder for material ordering
      showToast('Material ordering feature coming soon!', 'info');
    }

    function saveJobChanges() {
      showToast('Changes saved!');
      closeJobDetailModal();
    }

    let currentContractorId = null;

    function editContractor(contractorId) {
      openContractorProfile(contractorId);
    }

    async function openContractorProfile(contractorId) {
      currentContractorId = contractorId;
      const modal = document.getElementById('contractor-profile-modal');
      modal.classList.add('active');

      // Find contractor in allCollaborators
      let contractor = allCollaborators.find(c => c.id === contractorId);

      // If not found, fetch from database
      if (!contractor) {
        try {
          const { data, error } = await supabaseClient
            .from('collaborators')
            .select('*')
            .eq('id', contractorId)
            .single();
          if (error) throw error;
          contractor = data;
        } catch (err) {
          console.error('Load contractor error:', err);
          alert('Could not load contractor');
          return;
        }
      }

      // Populate profile
      document.getElementById('contractor-profile-name').textContent = contractor.name || 'Unknown';
      document.getElementById('contractor-profile-company').textContent = contractor.company_name || '';
      document.getElementById('contractor-profile-email').textContent = contractor.email || '-';
      document.getElementById('contractor-profile-phone').textContent = contractor.phone || '-';
      document.getElementById('contractor-profile-type').textContent = (contractor.type || '-').replace('_', ' ');
      document.getElementById('contractor-profile-license').textContent = contractor.license_number || '-';

      // Trust score
      const trustScore = contractor.trust_score || 0;
      document.getElementById('contractor-trust-score').textContent = trustScore;
      const badge = document.getElementById('contractor-trust-badge');
      badge.classList.toggle('verified', trustScore >= 70);

      // Generate invite link
      generateInviteLink(contractorId, contractor);

      // Render verification checklist
      renderVerificationChecklist(contractor);

      // Load documents
      loadContractorDocuments(contractorId);

      // Load job history
      loadContractorJobHistory(contractorId);
    }

    function closeContractorProfileModal() {
      document.getElementById('contractor-profile-modal').classList.remove('active');
      currentContractorId = null;
    }

    // Bridge: Assign contractor to a project
    async function assignContractorToProject(contractorId) {
      if (!contractorId) { showToast('No contractor selected', 'warning'); return; }

      var activeProjects = (allProjects || []).filter(function(p) {
        return p.status !== 'completed' && p.status !== 'cancelled';
      });

      if (!activeProjects.length) { showToast('No active projects available', 'warning'); return; }

      var projectNames = activeProjects.map(function(p, i) {
        return (i + 1) + '. ' + p.name + ' (' + (PROJECT_STATUS_LABELS[p.status] || p.status) + ')';
      }).join('\n');

      var choice = prompt('Assign contractor to project:\n' + projectNames + '\n\nEnter number:');
      if (!choice) return;

      var idx = parseInt(choice) - 1;
      var project = activeProjects[idx];
      if (!project) { showToast('Invalid selection', 'warning'); return; }

      try {
        await supabaseClient.from('project_crew').insert({
          project_id: project.id,
          contractor_id: contractorId,
          role: 'contractor',
          assigned_at: new Date().toISOString()
        });
        showToast('Contractor assigned to ' + project.name, 'success');
        logProjectActivity(project.id, 'contractor_assigned', 'Contractor assigned to project');
      } catch (err) {
        showToast('Error assigning contractor: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function generateInviteLink(contractorId, contractor) {
      const linkInput = document.getElementById('contractor-invite-link');
      const qrContainer = document.getElementById('contractor-qr-code');

      // Generate a simple token if not exists
      let token = contractor.invite_token;
      if (!token) {
        token = btoa(contractorId + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);

        // Save token to database
        try {
          await supabaseClient
            .from('collaborators')
            .update({ invite_token: token })
            .eq('id', contractorId);
        } catch (err) {
          console.log('Could not save invite token:', err);
        }
      }

      const inviteUrl = `${window.location.origin}/contractor-portal/?token=${token}`;
      linkInput.value = inviteUrl;

      // Generate QR code (using a simple QR code API)
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(inviteUrl)}`;
      qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 100px; height: 100px; border-radius: 4px;">`;
    }

    function copyInviteLink() {
      const linkInput = document.getElementById('contractor-invite-link');
      linkInput.select();
      document.execCommand('copy');
      showToast('Link copied to clipboard!');
    }

    async function sendInviteEmail() {
      if (!currentContractorId) return;

      const contractor = allCollaborators.find(c => c.id === currentContractorId);
      if (!contractor?.email) {
        alert('No email address for this contractor');
        return;
      }

      try {
        const inviteLink = document.getElementById('contractor-invite-link').value;
        await apiCall('/api/collaborators/send-invite', {
          method: 'POST',
          body: JSON.stringify({
            contractor_id: currentContractorId,
            email: contractor.email,
            invite_link: inviteLink
          })
        });
        showToast('Invite email sent!');
      } catch (err) {
        console.error('Send invite error:', err);
        showToast('Could not send email. Link copied instead.');
        copyInviteLink();
      }
    }

    function sendInviteSMS() {
      const contractor = allCollaborators.find(c => c.id === currentContractorId);
      const inviteLink = document.getElementById('contractor-invite-link').value;

      if (contractor?.phone) {
        // Open SMS app with pre-filled message
        const message = encodeURIComponent(`You've been invited to join Surprise Granite's contractor network! Complete your profile here: ${inviteLink}`);
        window.open(`sms:${contractor.phone}?body=${message}`, '_blank');
      } else {
        copyInviteLink();
        showToast('No phone number. Link copied instead.');
      }
    }

    function renderVerificationChecklist(contractor) {
      const container = document.getElementById('contractor-verification-checklist');

      const checklistItems = [
        { key: 'email', label: 'Email Address', subtitle: 'Contact information', points: 5, completed: !!contractor.email },
        { key: 'phone', label: 'Phone Number', subtitle: 'Contact information', points: 5, completed: !!contractor.phone },
        { key: 'company_name', label: 'Business Name', subtitle: 'Company details', points: 5, completed: !!contractor.company_name },
        { key: 'license', label: 'License Number', subtitle: 'Trade license', points: 10, completed: !!contractor.license_number },
        { key: 'claimed', label: 'Profile Claimed', subtitle: 'Account linked', points: 10, completed: !!contractor.claimed_by },
        { key: 'insurance', label: 'Insurance Certificate', subtitle: 'General liability', points: 25, completed: false }, // Check docs
        { key: 'w9', label: 'W-9 Form', subtitle: 'Tax documentation', points: 10, completed: false }, // Check docs
      ];

      container.innerHTML = checklistItems.map(item => `
        <div class="verification-item ${item.completed ? 'completed' : 'pending'}">
          <div class="verification-icon ${item.completed ? 'completed' : 'pending'}">
            ${item.completed
              ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
              : '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>'
            }
          </div>
          <div class="verification-item-text">
            <div class="verification-item-title">${item.label}</div>
            <div class="verification-item-subtitle">${item.subtitle}</div>
          </div>
          <div class="verification-item-points">+${item.points} pts</div>
        </div>
      `).join('');
    }

    async function loadContractorDocuments(contractorId) {
      const container = document.getElementById('contractor-documents-list');

      try {
        const { data: docs, error } = await supabaseClient
          .from('contractor_documents')
          .select('*')
          .eq('contractor_id', contractorId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!docs || docs.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No documents uploaded yet.<br>
              <span style="font-size: 12px;">Upload insurance, license, W-9, and other documents.</span>
            </div>
          `;
          return;
        }

        const docTypeLabels = {
          'insurance_general_liability': 'General Liability Insurance',
          'insurance_workers_comp': 'Workers Comp Insurance',
          'insurance_auto': 'Auto Insurance',
          'license_contractor': 'Contractor License',
          'license_trade': 'Trade License',
          'w9': 'W-9 Form',
          'certification': 'Certification',
          'bond': 'Bond',
          'other': 'Other Document'
        };

        container.innerHTML = docs.map(doc => `
          <div class="document-card">
            <div class="doc-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="doc-info">
              <div class="doc-name">${doc.document_name}</div>
              <div class="doc-meta">${docTypeLabels[doc.document_type] || doc.document_type}${doc.expiration_date ? ' | Exp: ' + new Date(doc.expiration_date).toLocaleDateString() : ''}</div>
            </div>
            <span class="doc-status ${doc.status}">${doc.status}</span>
            <a href="${doc.file_url}" target="_blank" class="action-btn" title="View">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            </a>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load contractor documents error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Could not load documents</div>';
      }
    }

    async function loadContractorJobHistory(contractorId) {
      const container = document.getElementById('contractor-job-history');

      try {
        const { data: jobs, error } = await supabaseClient
          .from('project_contractors')
          .select(`
            id, role, amount_quoted, status,
            jobs (id, job_number, customer_name, status)
          `)
          .eq('contractor_id', contractorId)
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        if (!jobs || jobs.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No jobs assigned yet</div>';
          return;
        }

        container.innerHTML = jobs.map(jc => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 6px; cursor: pointer;" onclick="openJobDetail('${jc.jobs?.id}')">
            <div>
              <div style="font-weight: 500; font-size: 13px;">${jc.jobs?.job_number || 'Unknown'}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${jc.jobs?.customer_name || ''} - ${jc.role}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600; font-size: 13px; color: var(--gold-primary);">$${(jc.amount_quoted || 0).toFixed(0)}</div>
              <span class="status-badge job-${jc.jobs?.status || 'new'}" style="font-size: 9px; padding: 2px 8px;">${jc.jobs?.status || 'new'}</span>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load job history error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Could not load job history</div>';
      }
    }

    async function uploadContractorDocument(event) {
      const file = event.target.files[0];
      if (!file || !currentContractorId) return;

      // Ask for document type
      const docType = prompt('Document type? (insurance, license, w9, certification, other)', 'insurance');
      if (!docType) return;

      const docTypeMap = {
        'insurance': 'insurance_general_liability',
        'workers comp': 'insurance_workers_comp',
        'license': 'license_contractor',
        'w9': 'w9',
        'certification': 'certification',
        'bond': 'bond',
        'other': 'other'
      };

      const documentType = docTypeMap[docType.toLowerCase()] || 'other';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Upload file to storage
        const fileExt = file.name.split('.').pop();
        const fileName = `collaborators/${currentContractorId}/${Date.now()}.${fileExt}`;

        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file);

        if (uploadError) throw uploadError;

        const { data: urlData } = supabaseClient.storage.from('lead-images').getPublicUrl(fileName);

        // Create document record
        const { error: docError } = await supabaseClient.from('contractor_documents').insert([{
          contractor_id: currentContractorId,
          user_id: user.id,
          document_type: documentType,
          document_name: file.name,
          file_url: urlData.publicUrl,
          file_type: fileExt,
          status: 'pending'
        }]);

        if (docError) throw docError;

        showToast('Document uploaded!');
        loadContractorDocuments(currentContractorId);

        // Recalculate trust score
        try {
          await supabaseClient.rpc('calculate_contractor_trust_score', { contractor_uuid: currentContractorId });
        } catch (e) {
          console.log('Could not update trust score:', e);
        }
      } catch (err) {
        console.error('Upload document error:', err);
        alert('Error uploading document: ' + err.message);
      }

      event.target.value = '';
    }

    function editContractorDetails() {
      showToast('Edit feature coming soon!', 'info');
    }

    function openNewCustomerModal() {
      // Use the job modal's new customer feature
      openNewJobModal();
      document.getElementById('job-customer-select').value = 'new';
      toggleNewCustomerFields();
    }

    // =============================================
    // SERVICE CATALOG
    // =============================================

    function openServiceCatalog() {
      const modal = document.getElementById('service-catalog-modal');
      modal.classList.add('active');
      loadServiceCatalog();
    }

    function closeServiceCatalog() {
      const modal = document.getElementById('service-catalog-modal');
      modal.classList.remove('active');
    }

    async function loadServiceCatalog() {
      const container = document.getElementById('catalog-items-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: items, error } = await supabaseClient
          .from('service_catalog')
          .select('*')
          .eq('user_id', user.id)
          .order('category', { ascending: true });

        if (error) throw error;

        serviceCatalog = items || [];

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <p>No catalog items yet</p>
              <button class="btn-modern primary small" onclick="openAddCatalogItem()" style="margin-top: 12px;">Add First Item</button>
            </div>`;
          return;
        }

        // Group by category
        const grouped = items.reduce((acc, item) => {
          const cat = item.category || 'Uncategorized';
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        container.innerHTML = Object.entries(grouped).map(([category, catItems]) => `
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 13px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${category}</h4>
            ${catItems.map(item => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px;">
                <div>
                  <div style="font-weight: 500;">${item.name}</div>
                  ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="color: var(--gold-primary); font-weight: 600;">$${item.default_price}/${item.unit}</span>
                  <button onclick="deleteCatalogItem('${item.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (err) {
        console.error('Load catalog error:', err);
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Error loading catalog</div>';
      }
    }

    function filterCatalog(type) {
      // Update active filter button
      document.querySelectorAll('#service-catalog-modal .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type === 'all' ? 'all' : type));
      });

      // Filter catalog items
      const items = document.querySelectorAll('.catalog-item');
      items.forEach(item => {
        if (type === 'all') {
          item.style.display = '';
        } else {
          const itemType = item.dataset.type || '';
          item.style.display = itemType === type ? '' : 'none';
        }
      });
    }

    function openAddCatalogItem() {
      const modal = document.getElementById('add-catalog-item-modal');
      modal.classList.add('active');
      document.getElementById('add-catalog-item-form').reset();
    }

    function closeAddCatalogItem() {
      const modal = document.getElementById('add-catalog-item-modal');
      modal.classList.remove('active');
    }

    async function saveCatalogItem(event) {
      if (event) event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const itemData = {
          user_id: user.id,
          name: document.getElementById('catalog-item-name').value.trim(),
          description: document.getElementById('catalog-item-desc').value.trim() || null,
          category: document.getElementById('catalog-item-category').value.trim() || 'General',
          unit: document.getElementById('catalog-item-unit').value,
          default_price: parseFloat(document.getElementById('catalog-item-price').value) || 0
        };

        if (!itemData.name) throw new Error('Please enter an item name');

        const { error } = await supabaseClient
          .from('service_catalog')
          .insert([itemData]);

        if (error) throw error;

        closeAddCatalogItem();
        loadServiceCatalog();
        showToast('Catalog item added!');
      } catch (err) {
        console.error('Save catalog item error:', err);
        alert('Error: ' + err.message);
      }

      return false;
    }

    async function deleteCatalogItem(itemId) {
      if (!confirm('Delete this catalog item?')) return;

      try {
        await supabaseClient.from('service_catalog').delete().eq('id', itemId);
        loadServiceCatalog();
        showToast('Item deleted');
      } catch (err) {
        console.error('Delete catalog item error:', err);
        alert('Error deleting item');
      }
    }

    // =============================================
    // CATALOG PICKER FOR ESTIMATES
    // =============================================

    function openCatalogPicker() {
      // Load catalog items and show picker
      const modal = document.createElement('div');
      modal.id = 'catalog-picker-modal';
      modal.className = 'modal-overlay';
      modal.style.display = 'flex';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div class="modal-header">
            <h2 class="modal-title">Add from Catalog</h2>
            <button class="modal-close" onclick="document.getElementById('catalog-picker-modal').remove()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" id="catalog-picker-list">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading catalog...</div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      loadCatalogPicker();
    }

    async function loadCatalogPicker() {
      const container = document.getElementById('catalog-picker-list');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: items } = await supabaseClient
          .from('service_catalog')
          .select('*')
          .eq('user_id', user.id)
          .order('category', { ascending: true });

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: var(--text-muted); margin-bottom: 16px;">No catalog items. Add services and materials to your catalog for quick estimate creation.</p>
              <button class="btn-modern primary" onclick="document.getElementById('catalog-picker-modal').remove(); openServiceCatalog();">
                Set Up Catalog
              </button>
            </div>`;
          return;
        }

        const grouped = items.reduce((acc, item) => {
          const cat = item.category || 'Uncategorized';
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        container.innerHTML = Object.entries(grouped).map(([category, catItems]) => `
          <div style="margin-bottom: 16px;">
            <h4 style="font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${category}</h4>
            ${catItems.map(item => `
              <div onclick="addCatalogItemToEstimate(${JSON.stringify(item).replace(/"/g, '&quot;')})" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(249,203,0,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                <div>
                  <div style="font-weight: 500;">${item.name}</div>
                  ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                </div>
                <span style="color: var(--gold-primary); font-weight: 600;">$${item.default_price}/${item.unit}</span>
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (err) {
        console.error('Load catalog picker error:', err);
        container.innerHTML = '<div style="padding: 20px; color: var(--error);">Error loading catalog</div>';
      }
    }

    function addCatalogItemToEstimate(item) {
      addEstimateLineItem({
        name: item.name,
        description: item.description,
        unit_type: item.unit,
        quantity: 1,
        price: item.default_price
      });
      document.getElementById('catalog-picker-modal')?.remove();
    }

    // ==================== GOD MODE FUNCTIONS ====================
    // Only accessible to joshb@surprisegranite.com

    // GOD MODE state
    let godModeUsers = [];
    let godModeUsersPage = 0;
    let godModeUsersPerPage = 50;
    let godModeAllUsers = [];
    let godModeLogs = [];

    // Initialize GOD MODE page
    async function initGodModePage(page) {
      if (!isGodMode()) {
        showToast('Access denied - GOD MODE only', 'error');
        showPage('dashboard');
        return;
      }

      console.log(' GOD MODE: Initializing page:', page);

      switch(page) {
        case 'god-mode':
          await loadGodModeDashboard();
          break;
        case 'god-users':
          await godRefreshUsers();
          break;
        case 'god-marketplace':
          await godRefreshMarketplace();
          break;
        case 'god-database':
          await loadGodDatabaseStats();
          break;
        case 'god-api':
          initGodApiTester();
          break;
        case 'god-logs':
          await godRefreshLogs();
          break;
        case 'god-analytics':
          await godLoadAnalytics();
          break;
        case 'god-site':
          await godLoadSiteManager();
          break;
        case 'god-config':
          await godLoadConfig();
          break;
        case 'god-designs':
          await godLoadDesigns();
          break;
      }
    }

    // GOD MODE Dashboard
    async function loadGodModeDashboard() {
      // Update environment info
      document.getElementById('god-api-base').textContent = API_BASE || 'Not configured';
      document.getElementById('god-user-agent').textContent = navigator.userAgent.substring(0, 80) + '...';
      document.getElementById('god-session-id').textContent = currentUser?.id?.substring(0, 8) + '...' || 'N/A';
      document.getElementById('god-auth-status').textContent = currentUser ? 'Authenticated' : 'Not authenticated';

      await refreshSystemHealth();
    }

    async function refreshSystemHealth() {
      try {
        // Check API
        document.getElementById('god-api-status').textContent = 'Checking...';
        try {
          const apiRes = await fetch(`${API_BASE}/api/stripe-status`);
          document.getElementById('god-api-status').textContent = apiRes.ok ? 'Online' : 'Error';
          document.getElementById('god-api-status').style.color = apiRes.ok ? 'var(--success)' : 'var(--error)';
        } catch { document.getElementById('god-api-status').textContent = 'Offline'; document.getElementById('god-api-status').style.color = 'var(--error)'; }

        // Check Supabase
        document.getElementById('god-supabase-status').textContent = 'Checking...';
        try {
          const { count } = await supabaseClient.from('sg_users').select('*', { count: 'exact', head: true });
          document.getElementById('god-supabase-status').textContent = 'Connected';
          document.getElementById('god-supabase-status').style.color = 'var(--success)';
          document.getElementById('god-total-users').textContent = count || 0;
        } catch { document.getElementById('god-supabase-status').textContent = 'Error'; document.getElementById('god-supabase-status').style.color = 'var(--error)'; }

        // Check Stripe via API
        document.getElementById('god-stripe-status').textContent = 'Checking...';
        try {
          const stripeRes = await fetch(`${API_BASE}/api/stripe-status`);
          const stripeData = await stripeRes.json();
          document.getElementById('god-stripe-status').textContent = stripeData.connected ? 'Connected' : 'Error';
          document.getElementById('god-stripe-status').style.color = stripeData.connected ? 'var(--success)' : 'var(--error)';
        } catch { document.getElementById('god-stripe-status').textContent = 'Unknown'; }

        // Load counts
        try {
          const { count: subCount } = await supabaseClient.from('sg_users').select('*', { count: 'exact', head: true }).eq('subscription_status', 'active');
          document.getElementById('god-active-subs').textContent = subCount || 0;
        } catch {}

        try {
          const { count: distCount } = await supabaseClient.from('distributor_profiles').select('*', { count: 'exact', head: true });
          document.getElementById('god-total-distributors').textContent = distCount || 0;
        } catch {}

      } catch (error) {
        console.error('GOD MODE health check error:', error);
      }
    }

    // Quick Actions
    async function godClearCache() {
      if (!isGodMode()) return;
      localStorage.clear();
      sessionStorage.clear();
      showToast('Cache cleared successfully', 'success');
    }

    async function godSendTestEmail() {
      if (!isGodMode()) return;
      try {
        const res = await fetch(`${API_BASE}/api/test-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: currentUser.email, subject: 'GOD MODE Test Email', body: 'This is a test email from GOD MODE.' })
        });
        showToast(res.ok ? 'Test email sent' : 'Failed to send email', res.ok ? 'success' : 'error');
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function godSyncShopify() {
      if (!isGodMode()) return;
      showToast('Shopify sync initiated...', 'info');
      // This would trigger a backend sync
      try {
        const res = await fetch(`${API_BASE}/api/shopify/sync`, { method: 'POST' });
        showToast(res.ok ? 'Sync complete' : 'Sync failed', res.ok ? 'success' : 'error');
      } catch { showToast('Sync endpoint not available', 'warning'); }
    }

    async function godBackupDatabase() {
      if (!isGodMode()) return;
      showToast('Generating database export...', 'info');
      // Export key tables as JSON
      try {
        const tables = ['sg_users', 'customers', 'jobs', 'leads', 'estimates'];
        const backup = {};
        for (const table of tables) {
          const { data } = await supabaseClient.from(table).select('*').limit(1000);
          backup[table] = data || [];
        }
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sg-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showToast('Backup downloaded', 'success');
      } catch (e) { showToast('Backup failed: ' + e.message, 'error'); }
    }

    async function godToggleMaintenanceMode() {
      if (!isGodMode()) return;
      const inMaintenance = document.body.classList.toggle('maintenance-mode');
      showToast(inMaintenance ? 'Maintenance mode ON' : 'Maintenance mode OFF', 'warning');
    }

    async function godReindexProducts() {
      if (!isGodMode()) return;
      showToast('Reindexing products...', 'info');
      setTimeout(() => showToast('Products reindexed', 'success'), 2000);
    }

    // GOD MODE Users Management
    async function godRefreshUsers() {
      if (!isGodMode()) return;
      try {
        const { data, error, count } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact' })
          .order('created_at', { ascending: false })
          .range(godModeUsersPage * godModeUsersPerPage, (godModeUsersPage + 1) * godModeUsersPerPage - 1);

        if (error) throw error;
        godModeAllUsers = data || [];

        // Update stats
        document.getElementById('god-users-total').textContent = count || 0;

        // Count by role
        const { data: allUsers } = await supabaseClient.from('sg_users').select('account_type, subscription_status');
        const roleCounts = { admin: 0, pro: 0, contractor: 0, vendor: 0, homeowner: 0 };
        (allUsers || []).forEach(u => {
          const type = u.account_type || 'homeowner';
          if (type.includes('admin')) roleCounts.admin++;
          else if (type.includes('contractor') || type.includes('fabricator')) roleCounts.contractor++;
          else if (type.includes('vendor')) roleCounts.vendor++;
          else roleCounts.homeowner++;
          // Count pro separately by subscription status
          if (u.subscription_status === 'active' || u.subscription_status === 'trialing') roleCounts.pro++;
        });
        document.getElementById('god-users-admins').textContent = roleCounts.admin;
        document.getElementById('god-users-pro').textContent = roleCounts.pro;
        document.getElementById('god-users-collaborators').textContent = roleCounts.contractor;

        // Also fetch Shopify and Leads counts for summary
        try {
          const { count: shopifyCount } = await supabaseClient.from('shopify_customers').select('*', { count: 'exact', head: true });
          document.getElementById('god-users-shopify').textContent = shopifyCount || 0;
        } catch (e) {
          document.getElementById('god-users-shopify').textContent = '0';
        }
        try {
          const { count: leadsCount } = await supabaseClient.from('leads').select('*', { count: 'exact', head: true });
          document.getElementById('god-users-leads').textContent = leadsCount || 0;
        } catch (e) {
          document.getElementById('god-users-leads').textContent = '0';
        }

        renderGodUsersTable();
        document.getElementById('god-users-count').textContent = `Showing ${data.length} of ${count} users`;

      } catch (error) {
        console.error('GOD MODE users error:', error);
        showToast('Failed to load users', 'error');
      }
    }

    function renderGodUsersTable() {
      const tbody = document.getElementById('god-users-table-body');
      if (!tbody) return;

      if (!godModeAllUsers.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = godModeAllUsers.map(user => `
        <tr style="border-bottom: 1px solid var(--border-subtle);">
          <td style="padding: 12px 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">${(user.full_name || user.email || '?')[0].toUpperCase()}</div>
              <div>
                <div style="font-weight: 500;">${escapeHtml(user.full_name || 'No name')}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(user.email || 'No email')}</div>
              </div>
            </div>
          </td>
          <td style="padding: 12px 16px;"><span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #a855f7; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${escapeHtml(user.account_type || 'homeowner')}</span></td>
          <td style="padding: 12px 16px;"><span style="color: ${user.subscription_status === 'active' ? 'var(--success)' : 'var(--text-muted)'};">${user.subscription_status || 'none'}</span></td>
          <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
          <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString() : '-'}</td>
          <td style="padding: 12px 16px; text-align: center;">
            <button class="btn-modern secondary" onclick="godEditUser('${user.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
            <button class="btn-modern secondary" onclick="godImpersonateUser('${user.id}')" style="padding: 6px 12px; font-size: 12px; margin-left: 4px;">View As</button>
          </td>
        </tr>
      `).join('');
    }

    function godSearchUsers() {
      const search = document.getElementById('god-users-search')?.value?.toLowerCase() || '';
      const filtered = godModeAllUsers.filter(u =>
        (u.email || '').toLowerCase().includes(search) ||
        (u.full_name || '').toLowerCase().includes(search) ||
        (u.id || '').toLowerCase().includes(search)
      );
      const tbody = document.getElementById('god-users-table-body');
      if (tbody && filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No users match your search</td></tr>';
      } else {
        godModeAllUsers = filtered;
        renderGodUsersTable();
      }
    }

    function godFilterUsers() {
      godModeUsersPage = 0;
      godRefreshUsers();
    }

    async function godEditUser(userId) {
      if (!isGodMode()) return;
      const { data: user, error } = await supabaseClient.from('sg_users').select('*').eq('id', userId).single();
      if (error || !user) { showToast('User not found', 'error'); return; }

      const newRole = prompt(`Edit role for ${user.email}\nCurrent: ${user.account_type}\n\nEnter new role (homeowner, contractor, fabricator, vendor, admin):`, user.account_type);
      if (newRole && newRole !== user.account_type) {
        const { error: updateError } = await supabaseClient.from('sg_users').update({ account_type: newRole }).eq('id', userId);
        if (updateError) { showToast('Failed to update: ' + updateError.message, 'error'); }
        else { showToast('User role updated', 'success'); godRefreshUsers(); }
      }
    }

    function godImpersonateUser(userId) {
      if (!isGodMode()) return;
      showToast('Impersonation not yet implemented', 'warning');
    }

    function godExportUsers() {
      if (!isGodMode() || !godModeAllUsers.length) return;
      const csv = 'Email,Name,Role,Subscription,Created\n' + godModeAllUsers.map(u =>
        `"${u.email || ''}","${u.full_name || ''}","${u.account_type || ''}","${u.subscription_status || ''}","${u.created_at || ''}"`
      ).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'users-export.csv';
      a.click();
    }

    function godUsersPagePrev() { if (godModeUsersPage > 0) { godModeUsersPage--; godRefreshUsers(); } }
    function godUsersPageNext() { godModeUsersPage++; godRefreshUsers(); }

    // GOD MODE Customer Hub Tabs
    let godShopifyPage = 0;
    let godLeadsPage = 0;
    let godProPage = 0;
    let godCollaboratorsPage = 0;
    const godTabPageSize = 25;

    function godShowCustomerTab(tabName) {
      // Hide all customer tabs
      document.querySelectorAll('.god-customer-tab').forEach(el => el.style.display = 'none');
      // Show selected tab
      const selectedTab = document.getElementById('god-customer-tab-' + tabName);
      if (selectedTab) selectedTab.style.display = 'block';
      // Update active tab button
      const tabsContainer = selectedTab?.closest('section')?.querySelector('.tabs-modern');
      if (tabsContainer) {
        tabsContainer.querySelectorAll('.tab-modern').forEach(btn => btn.classList.remove('active'));
        const activeBtn = Array.from(tabsContainer.querySelectorAll('.tab-modern')).find(btn =>
          btn.textContent.toLowerCase().includes(tabName.replace('-', ' ').split(' ')[0])
        );
        if (activeBtn) activeBtn.classList.add('active');
      }
      // Load tab data
      switch(tabName) {
        case 'all-users': godRefreshUsers(); break;
        case 'shopify': godLoadShopifyCustomers(); break;
        case 'leads': godLoadLeads(); break;
        case 'pro': godLoadProUsers(); break;
        case 'collaborators': godLoadCollaborators(); break;
      }
    }

    // Shopify Customers
    async function godLoadShopifyCustomers() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-shopify-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('god-shopify-filter')?.value || 'all';

        let query = supabaseClient.from('shopify_customers').select('*', { count: 'exact' });

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`);
        }
        if (filter === 'with-orders') query = query.gt('orders_count', 0);
        if (filter === 'no-orders') query = query.eq('orders_count', 0);
        if (filter === 'marketing-opted') query = query.eq('accepts_marketing', true);

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godShopifyPage * godTabPageSize, (godShopifyPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-shopify').textContent = count || 0;
        document.getElementById('god-shopify-count').textContent = `Showing ${data?.length || 0} of ${count || 0} customers`;

        const tbody = document.getElementById('god-shopify-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No Shopify customers found</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(c => `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <div style="font-weight: 500;">${escapeHtml((c.first_name || '') + ' ' + (c.last_name || ''))}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(c.email || '')}</div>
            </td>
            <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(c.phone || '-')}</td>
            <td style="padding: 12px 16px;"><span style="font-weight: 600; color: var(--accent);">${c.orders_count || 0}</span></td>
            <td style="padding: 12px 16px; font-weight: 500; color: var(--success);">$${parseFloat(c.total_spent || 0).toFixed(2)}</td>
            <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${c.created_at ? new Date(c.created_at).toLocaleDateString() : '-'}</td>
            <td style="padding: 12px 16px; text-align: center;">
              <button class="btn-modern secondary" onclick="godViewUnifiedProfile('${escapeHtml(c.email)}')" style="padding: 6px 12px; font-size: 12px;">Profile</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('god-shopify-prev').disabled = godShopifyPage === 0;
        document.getElementById('god-shopify-next').disabled = (godShopifyPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading Shopify customers:', error);
        document.getElementById('god-shopify-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading customers</td></tr>';
      }
    }

    function godSearchShopifyCustomers() { godShopifyPage = 0; godLoadShopifyCustomers(); }
    function godFilterShopifyCustomers() { godShopifyPage = 0; godLoadShopifyCustomers(); }
    function godShopifyPagePrev() { if (godShopifyPage > 0) { godShopifyPage--; godLoadShopifyCustomers(); } }
    function godShopifyPageNext() { godShopifyPage++; godLoadShopifyCustomers(); }

    // Leads Management
    async function godLoadLeads() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-leads-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('god-leads-status')?.value || 'all';
        const sourceFilter = document.getElementById('god-leads-source')?.value || 'all';

        let query = supabaseClient.from('leads').select('*', { count: 'exact' });

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
        }
        if (statusFilter !== 'all') query = query.eq('status', statusFilter);
        if (sourceFilter !== 'all') query = query.eq('source', sourceFilter);

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godLeadsPage * godTabPageSize, (godLeadsPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-leads').textContent = count || 0;
        document.getElementById('god-leads-count').textContent = `Showing ${data?.length || 0} of ${count || 0} leads`;

        const tbody = document.getElementById('god-leads-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No leads found</td></tr>';
          return;
        }

        const statusColors = {
          'new': { bg: 'rgba(59, 130, 246, 0.2)', color: 'var(--info)' },
          'contacted': { bg: 'rgba(249, 203, 0, 0.2)', color: 'var(--accent)' },
          'qualified': { bg: 'rgba(16, 185, 129, 0.2)', color: 'var(--success)' },
          'converted': { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7' },
          'lost': { bg: 'rgba(239, 68, 68, 0.2)', color: 'var(--error)' }
        };

        tbody.innerHTML = data.map(l => {
          const sc = statusColors[l.status] || statusColors['new'];
          return `
            <tr style="border-bottom: 1px solid var(--border-subtle);">
              <td style="padding: 12px 16px;">
                <div style="font-weight: 500;">${escapeHtml(l.name || 'Unknown')}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(l.email || '')}</div>
              </td>
              <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(l.phone || '-')}</td>
              <td style="padding: 12px 16px;"><span style="background: ${sc.bg}; color: ${sc.color}; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${l.status || 'new'}</span></td>
              <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(l.source || '-')}</td>
              <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${l.created_at ? new Date(l.created_at).toLocaleDateString() : '-'}</td>
              <td style="padding: 12px 16px; text-align: center;">
                <button class="btn-modern secondary" onclick="godEditLead('${l.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
              </td>
            </tr>
          `;
        }).join('');

        document.getElementById('god-leads-prev').disabled = godLeadsPage === 0;
        document.getElementById('god-leads-next').disabled = (godLeadsPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading leads:', error);
        document.getElementById('god-leads-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading leads</td></tr>';
      }
    }

    function godSearchLeads() { godLeadsPage = 0; godLoadLeads(); }
    function godFilterLeads() { godLeadsPage = 0; godLoadLeads(); }
    function godLeadsPagePrev() { if (godLeadsPage > 0) { godLeadsPage--; godLoadLeads(); } }
    function godLeadsPageNext() { godLeadsPage++; godLoadLeads(); }

    async function godEditLead(leadId) {
      const newStatus = prompt('Enter new status (new, contacted, qualified, converted, lost):');
      if (newStatus && ['new', 'contacted', 'qualified', 'converted', 'lost'].includes(newStatus)) {
        const { error } = await supabaseClient.from('leads').update({ status: newStatus }).eq('id', leadId);
        if (error) showToast('Failed to update lead', 'error');
        else { showToast('Lead status updated', 'success'); godLoadLeads(); }
      }
    }

    // Pro Users Management
    async function godLoadProUsers() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-pro-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('god-pro-filter')?.value || 'all';

        // Query sg_users with pro/premium subscription
        let query = supabaseClient.from('sg_users').select('*', { count: 'exact' }).in('subscription_status', ['active', 'trialing', 'cancelled']);

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,full_name.ilike.%${searchTerm}%`);
        }
        if (filter === 'active') query = query.eq('subscription_status', 'active');
        if (filter === 'cancelled') query = query.eq('subscription_status', 'cancelled');
        if (filter === 'trial') query = query.eq('subscription_status', 'trialing');

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godProPage * godTabPageSize, (godProPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-pro').textContent = count || 0;
        document.getElementById('god-pro-count').textContent = `Showing ${data?.length || 0} of ${count || 0} pro users`;

        const tbody = document.getElementById('god-pro-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No pro users found</td></tr>';
          return;
        }

        const statusColors = {
          'active': { bg: 'rgba(16, 185, 129, 0.2)', color: 'var(--success)' },
          'trialing': { bg: 'rgba(59, 130, 246, 0.2)', color: 'var(--info)' },
          'cancelled': { bg: 'rgba(239, 68, 68, 0.2)', color: 'var(--error)' }
        };

        tbody.innerHTML = data.map(u => {
          const sc = statusColors[u.subscription_status] || statusColors['active'];
          return `
            <tr style="border-bottom: 1px solid var(--border-subtle);">
              <td style="padding: 12px 16px;">
                <div style="font-weight: 500;">${escapeHtml(u.full_name || u.email)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(u.email || '')}</div>
              </td>
              <td style="padding: 12px 16px;"><span style="background: var(--accent); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">PRO</span></td>
              <td style="padding: 12px 16px;"><span style="background: ${sc.bg}; color: ${sc.color}; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${u.subscription_status || 'active'}</span></td>
              <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
              <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${u.subscription_end_date ? new Date(u.subscription_end_date).toLocaleDateString() : '-'}</td>
              <td style="padding: 12px 16px; text-align: center;">
                <button class="btn-modern secondary" onclick="godViewUnifiedProfile('${escapeHtml(u.email)}')" style="padding: 6px 12px; font-size: 12px;">Profile</button>
              </td>
            </tr>
          `;
        }).join('');

        document.getElementById('god-pro-prev').disabled = godProPage === 0;
        document.getElementById('god-pro-next').disabled = (godProPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading pro users:', error);
        document.getElementById('god-pro-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading pro users</td></tr>';
      }
    }

    function godSearchProUsers() { godProPage = 0; godLoadProUsers(); }
    function godFilterProUsers() { godProPage = 0; godLoadProUsers(); }
    function godProPagePrev() { if (godProPage > 0) { godProPage--; godLoadProUsers(); } }
    function godProPageNext() { godProPage++; godLoadProUsers(); }

    // Collaborators Management
    async function godLoadCollaborators() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-collaborators-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('god-collaborators-filter')?.value || 'all';

        // Query sg_users with contractor role
        let query = supabaseClient.from('sg_users').select('*', { count: 'exact' }).eq('account_type', 'contractor');

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,full_name.ilike.%${searchTerm}%,company_name.ilike.%${searchTerm}%`);
        }

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godCollaboratorsPage * godTabPageSize, (godCollaboratorsPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-collaborators').textContent = count || 0;
        document.getElementById('god-collaborators-count').textContent = `Showing ${data?.length || 0} of ${count || 0} collaborators`;

        const tbody = document.getElementById('god-collaborators-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No collaborators found</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(c => `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <div style="font-weight: 500;">${escapeHtml(c.full_name || c.email)}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(c.email || '')}</div>
            </td>
            <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(c.company_name || '-')}</td>
            <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(c.specialty || 'General')}</td>
            <td style="padding: 12px 16px;"><span style="background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 4px 8px; border-radius: 4px; font-size: 11px;">Active</span></td>
            <td style="padding: 12px 16px; font-weight: 500; color: var(--accent);">-</td>
            <td style="padding: 12px 16px; text-align: center;">
              <button class="btn-modern secondary" onclick="godViewUnifiedProfile('${escapeHtml(c.email)}')" style="padding: 6px 12px; font-size: 12px;">Profile</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('god-collaborators-prev').disabled = godCollaboratorsPage === 0;
        document.getElementById('god-collaborators-next').disabled = (godCollaboratorsPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading collaborators:', error);
        document.getElementById('god-collaborators-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading collaborators</td></tr>';
      }
    }

    function godSearchCollaborators() { godCollaboratorsPage = 0; godLoadCollaborators(); }
    function godFilterCollaborators() { godCollaboratorsPage = 0; godLoadCollaborators(); }
    function godCollaboratorsPagePrev() { if (godCollaboratorsPage > 0) { godCollaboratorsPage--; godLoadCollaborators(); } }
    function godCollaboratorsPageNext() { godCollaboratorsPage++; godLoadCollaborators(); }

    // Unified Customer Profile Modal
    async function godViewUnifiedProfile(email) {
      if (!email) return;

      showToast('Loading profile...', 'info');

      try {
        // Fetch from all sources - handle errors gracefully
        const safeQuery = async (query) => {
          try { return await query; } catch (e) { return { data: null }; }
        };

        const [sgUser, shopifyCustomer, shopifyOrders, leads] = await Promise.all([
          safeQuery(supabaseClient.from('sg_users').select('*').eq('email', email).single()),
          safeQuery(supabaseClient.from('shopify_customers').select('*').eq('email', email).single()),
          safeQuery(supabaseClient.from('shopify_orders').select('*').eq('email', email).order('created_at', { ascending: false }).limit(5)),
          safeQuery(supabaseClient.from('leads').select('*').eq('email', email))
        ]);

        const profile = {
          sgUser: sgUser.data,
          shopifyCustomer: shopifyCustomer.data,
          shopifyOrders: shopifyOrders.data || [],
          leads: leads.data || []
        };

        // Build modal content
        let modalHtml = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
            <div style="background: var(--surface-primary); border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
              <div style="padding: 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h2 style="margin: 0; font-size: 20px;">Unified Customer Profile</h2>
                  <p style="margin: 4px 0 0; color: var(--text-muted);">${escapeHtml(email)}</p>
                </div>
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px;">&times;</button>
              </div>
              <div style="padding: 24px;">
        `;

        // SG User Section
        if (profile.sgUser) {
          modalHtml += `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                <span style="background: #a855f7; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">SG USER</span>
                Account Details
              </h3>
              <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                  <div><span style="color: var(--text-muted); font-size: 12px;">Name</span><div style="font-weight: 500;">${escapeHtml(profile.sgUser.full_name || '-')}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Role</span><div><span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${profile.sgUser.account_type || 'homeowner'}</span></div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Subscription</span><div style="color: ${profile.sgUser.subscription_status === 'active' ? 'var(--success)' : 'var(--text-muted)'}">${profile.sgUser.subscription_status || 'none'}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Created</span><div>${profile.sgUser.created_at ? new Date(profile.sgUser.created_at).toLocaleDateString() : '-'}</div></div>
                </div>
              </div>
            </div>
          `;
        }

        // Shopify Section
        if (profile.shopifyCustomer) {
          modalHtml += `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                <span style="background: #96bf48; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px;">SHOPIFY</span>
                Customer Data
              </h3>
              <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                  <div><span style="color: var(--text-muted); font-size: 12px;">Orders</span><div style="font-weight: 600; color: var(--accent);">${profile.shopifyCustomer.orders_count || 0}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Total Spent</span><div style="font-weight: 600; color: var(--success);">$${parseFloat(profile.shopifyCustomer.total_spent || 0).toFixed(2)}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Marketing</span><div>${profile.shopifyCustomer.accepts_marketing ? ' Opted-in' : 'Not opted-in'}</div></div>
                </div>
                ${profile.shopifyOrders.length > 0 ? `
                  <div style="border-top: 1px solid var(--border-subtle); padding-top: 12px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Recent Orders</div>
                    ${profile.shopifyOrders.slice(0, 3).map(o => `
                      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                        <span style="font-size: 13px;">${o.name || o.id}</span>
                        <span style="font-weight: 500; color: var(--success);">$${parseFloat(o.total_price || 0).toFixed(2)}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        // Leads Section
        if (profile.leads.length > 0) {
          modalHtml += `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                <span style="background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px;">LEADS</span>
                Lead History (${profile.leads.length})
              </h3>
              <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                ${profile.leads.map(l => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                    <div>
                      <div style="font-size: 13px;">${l.source || 'Direct'}</div>
                      <div style="font-size: 11px; color: var(--text-muted);">${l.created_at ? new Date(l.created_at).toLocaleDateString() : ''}</div>
                    </div>
                    <span style="background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${l.status || 'new'}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        // No data found
        if (!profile.sgUser && !profile.shopifyCustomer && profile.leads.length === 0) {
          modalHtml += `<div style="padding: 40px; text-align: center; color: var(--text-muted);">No data found for this email</div>`;
        }

        modalHtml += `
              </div>
              <div style="padding: 16px 24px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-modern secondary" onclick="this.closest('[style*=\"position: fixed\"]').remove()">Close</button>
              </div>
            </div>
          </div>
        `;

        // Insert modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (error) {
        console.error('Error loading unified profile:', error);
        showToast('Failed to load profile', 'error');
      }
    }

    // GOD MODE Marketplace
    async function godRefreshMarketplace() {
      if (!isGodMode()) return;
      try {
        // Load distributors
        const { data: distributors, count: distCount } = await supabaseClient.from('distributor_profiles').select('*', { count: 'exact' });
        document.getElementById('god-mp-distributors').textContent = distCount || 0;

        // Load listings count (stone_listings is the active table)
        const { count: listingsCount } = await supabaseClient.from('stone_listings').select('*', { count: 'exact', head: true }).eq('status', 'active');
        document.getElementById('god-mp-listings').textContent = listingsCount || 0;

        // Load slabs count (use stone_listings as inventory source)
        const { count: slabsCount } = await supabaseClient.from('stone_listings').select('*', { count: 'exact', head: true });
        document.getElementById('god-mp-slabs').textContent = slabsCount || 0;

        // Load inquiries (use listing_inquiries if it exists)
        let inquiriesCount = 0;
        try {
          const { count } = await supabaseClient.from('listing_inquiries').select('*', { count: 'exact', head: true }).eq('status', 'pending');
          inquiriesCount = count || 0;
        } catch { /* table may not exist yet */ }
        document.getElementById('god-mp-inquiries').textContent = inquiriesCount;

        // Render distributors list
        const distList = document.getElementById('god-distributors-list');
        if (distList && distributors) {
          distList.innerHTML = distributors.map(d => `
            <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 500;">${escapeHtml(d.company_name || 'Unnamed')}</div>
                <div style="font-size: 13px; color: var(--text-muted);">${escapeHtml(d.contact_email || '')} | ${escapeHtml(d.city || '')}, ${escapeHtml(d.state || '')}</div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="badge" style="background: ${d.subscription_status === 'active' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${d.subscription_status === 'active' ? 'var(--success)' : 'var(--error)'}; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${d.subscription_status || 'inactive'}</span>
                <button class="btn-modern secondary" onclick="godViewDistributor('${d.id}')" style="padding: 6px 12px; font-size: 12px;">View</button>
              </div>
            </div>
          `).join('') || '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No distributors found</div>';
        }

      } catch (error) {
        console.error('GOD MODE marketplace error:', error);
      }
    }

    function godShowMarketplaceTab(tab) {
      document.querySelectorAll('.god-mp-tab').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tabs-modern .tab-modern').forEach(el => el.classList.remove('active'));
      document.getElementById(`god-mp-tab-${tab}`).style.display = 'block';
      event.target.classList.add('active');
    }

    function godSearchDistributors(query) {
      // Filter distributors by search query
    }

    function godViewDistributor(id) {
      showToast('Distributor details coming soon', 'info');
    }

    // GOD MODE Database
    async function loadGodDatabaseStats() {
      if (!isGodMode()) return;
      try {
        const tables = ['sg_users', 'customers', 'jobs', 'leads', 'estimates', 'shopify_products', 'shopify_orders', 'distributor_profiles'];
        let totalRows = 0;
        for (const table of tables) {
          try {
            const { count } = await supabaseClient.from(table).select('*', { count: 'exact', head: true });
            totalRows += count || 0;
          } catch {}
        }
        document.getElementById('god-db-tables').textContent = tables.length;
        document.getElementById('god-db-rows').textContent = totalRows.toLocaleString();
        document.getElementById('god-db-size').textContent = 'N/A';
      } catch {}
    }

    async function godRunSqlQuery() {
      if (!isGodMode()) return;
      const query = document.getElementById('god-sql-query')?.value;
      if (!query) return;

      try {
        // For safety, we'll use Supabase's RPC or direct table queries
        // This simulates SQL execution
        showToast('Executing query...', 'info');

        // Parse simple SELECT queries
        const selectMatch = query.match(/SELECT\s+\*\s+FROM\s+(\w+)/i);
        if (selectMatch) {
          const table = selectMatch[1];
          const limitMatch = query.match(/LIMIT\s+(\d+)/i);
          const limit = limitMatch ? parseInt(limitMatch[1]) : 100;

          const { data, error } = await supabaseClient.from(table).select('*').limit(limit);
          if (error) throw error;

          const resultsEl = document.getElementById('god-sql-results');
          const preEl = resultsEl.querySelector('pre');
          resultsEl.style.display = 'block';
          preEl.textContent = JSON.stringify(data, null, 2);
          showToast(`Query returned ${data.length} rows`, 'success');
        } else {
          showToast('Only SELECT queries supported in browser', 'warning');
        }
      } catch (e) {
        showToast('Query error: ' + e.message, 'error');
      }
    }

    function godClearQueryResults() {
      const resultsEl = document.getElementById('god-sql-results');
      if (resultsEl) {
        resultsEl.style.display = 'none';
        resultsEl.querySelector('pre').textContent = '';
      }
    }

    function godLoadSqlPreset(preset) {
      const presets = {
        users: 'SELECT * FROM sg_users LIMIT 100',
        admins: 'SELECT * FROM sg_users WHERE account_type = \'admin\'',
        distributors: 'SELECT * FROM distributor_profiles LIMIT 100',
        recent_orders: 'SELECT * FROM shopify_orders ORDER BY created_at DESC LIMIT 50',
        active_subs: 'SELECT * FROM sg_users WHERE subscription_status = \'active\'',
        table_sizes: '-- Table sizes not available via browser'
      };
      if (presets[preset]) {
        document.getElementById('god-sql-query').value = presets[preset];
      }
    }

    async function godBrowseTable(table) {
      if (!isGodMode() || !table) return;
      try {
        const { data, error } = await supabaseClient.from(table).select('*').limit(50);
        if (error) throw error;

        const browser = document.getElementById('god-table-browser');
        if (!data || data.length === 0) {
          browser.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">Table is empty</div>';
          return;
        }

        const columns = Object.keys(data[0]);
        browser.innerHTML = `
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead><tr style="background: rgba(255,255,255,0.03);">${columns.map(c => `<th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-subtle); white-space: nowrap;">${escapeHtml(c)}</th>`).join('')}</tr></thead>
            <tbody>${data.map(row => `<tr>${columns.map(c => `<td style="padding: 8px; border-bottom: 1px solid var(--border-subtle); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(String(row[c] ?? ''))}</td>`).join('')}</tr>`).join('')}</tbody>
          </table>
        `;
      } catch (e) {
        document.getElementById('god-table-browser').innerHTML = `<div style="padding: 20px; color: var(--error);">Error: ${escapeHtml(e.message)}</div>`;
      }
    }

    // GOD MODE API Tester
    function initGodApiTester() {
      document.getElementById('god-api-endpoint').value = '/api/stripe-status';
    }

    async function godTestApiEndpoint() {
      if (!isGodMode()) return;
      const method = document.getElementById('god-api-method').value;
      const endpoint = document.getElementById('god-api-endpoint').value;
      const body = document.getElementById('god-api-body').value;
      const includeAuth = document.getElementById('god-api-auth').checked;

      if (!endpoint) { showToast('Enter an endpoint', 'warning'); return; }

      const startTime = Date.now();
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (includeAuth && supabaseClient) {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session?.access_token) {
            headers['Authorization'] = `Bearer ${session.access_token}`;
          }
        }

        const options = { method, headers };
        if (['POST', 'PATCH', 'PUT'].includes(method) && body) {
          options.body = body;
        }

        const fullUrl = endpoint.startsWith('http') ? endpoint : `${API_BASE}${endpoint}`;
        const response = await fetch(fullUrl, options);
        const elapsed = Date.now() - startTime;

        let responseData;
        const contentType = response.headers.get('content-type');
        if (contentType?.includes('application/json')) {
          responseData = await response.json();
        } else {
          responseData = await response.text();
        }

        // Display results
        document.getElementById('god-api-response').style.display = 'block';
        const statusEl = document.getElementById('god-api-status-code');
        statusEl.textContent = response.status;
        statusEl.style.background = response.ok ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        statusEl.style.color = response.ok ? 'var(--success)' : 'var(--error)';
        document.getElementById('god-api-time').textContent = `${elapsed}ms`;
        document.getElementById('god-api-response-body').textContent = typeof responseData === 'object' ? JSON.stringify(responseData, null, 2) : responseData;

      } catch (e) {
        document.getElementById('god-api-response').style.display = 'block';
        document.getElementById('god-api-status-code').textContent = 'ERR';
        document.getElementById('god-api-status-code').style.background = 'rgba(239, 68, 68, 0.2)';
        document.getElementById('god-api-status-code').style.color = 'var(--error)';
        document.getElementById('god-api-time').textContent = '-';
        document.getElementById('god-api-response-body').textContent = e.message;
      }
    }

    function godLoadApiPreset(preset) {
      const presets = {
        health: { method: 'GET', endpoint: '/api/stripe-status', body: '' },
        users: { method: 'GET', endpoint: '/api/customers-list', body: '' },
        products: { method: 'GET', endpoint: '/api/products', body: '' },
        orders: { method: 'GET', endpoint: '/api/orders', body: '' },
        stripe: { method: 'GET', endpoint: '/api/stripe-status', body: '' },
        distributors: { method: 'GET', endpoint: '/api/marketplace/stone-yards', body: '' }
      };
      if (presets[preset]) {
        document.getElementById('god-api-method').value = presets[preset].method;
        document.getElementById('god-api-endpoint').value = presets[preset].endpoint;
        document.getElementById('god-api-body').value = presets[preset].body;
      }
    }

    // GOD MODE Logs
    async function godRefreshLogs() {
      if (!isGodMode()) return;
      try {
        // Try to load from audit logs table
        const { data: logs } = await supabaseClient
          .from('auth_audit_logs')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        godModeLogs = logs || [];
        renderGodLogs();
      } catch (e) {
        // Generate mock logs if table doesn't exist
        godModeLogs = [
          { created_at: new Date().toISOString(), event_type: 'login', event_status: 'success', details: { email: currentUser?.email }, ip_address: '127.0.0.1' },
          { created_at: new Date(Date.now() - 60000).toISOString(), event_type: 'api_request', event_status: 'success', details: { endpoint: '/api/products' }, ip_address: '127.0.0.1' }
        ];
        renderGodLogs();
      }
    }

    function renderGodLogs() {
      const container = document.getElementById('god-logs-container');
      if (!container) return;

      if (!godModeLogs.length) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No logs available</div>';
        return;
      }

      container.innerHTML = godModeLogs.map(log => {
        const statusColor = log.event_status === 'success' ? 'var(--success)' : log.event_status === 'failed' ? 'var(--error)' : 'var(--warning)';
        return `
          <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; gap: 16px; align-items: flex-start;">
            <span style="color: var(--text-muted); white-space: nowrap;">${new Date(log.created_at).toLocaleString()}</span>
            <span style="color: ${statusColor}; min-width: 70px;">[${log.event_status || 'INFO'}]</span>
            <span style="color: var(--accent); min-width: 100px;">${log.event_type || 'event'}</span>
            <span style="color: var(--text-secondary); flex: 1;">${JSON.stringify(log.details || {})}</span>
            <span style="color: var(--text-muted);">${log.ip_address || ''}</span>
          </div>
        `;
      }).join('');
    }

    function godFilterLogs() { renderGodLogs(); }
    function godSearchLogs() { renderGodLogs(); }
    function godExportLogs() {
      if (!isGodMode() || !godModeLogs.length) return;
      const blob = new Blob([JSON.stringify(godModeLogs, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'system-logs.json';
      a.click();
    }

    // ==================== ANALYTICS FUNCTIONS ====================

    let godAnalyticsData = { visitors: 0, pageviews: 0, sessions: 0, bounce: 0, duration: 0, conversions: 0 };

    async function godLoadAnalytics() {
      if (!isGodMode()) return;
      console.log(' GOD MODE: Loading analytics...');

      const range = document.getElementById('god-analytics-range')?.value || 30;

      // Check for saved GA token and update status
      const savedToken = localStorage.getItem('ga_access_token');
      if (savedToken) {
        gaAccessToken = savedToken;
        updateGAStatus(true);
        // Load GA data
        await godLoadGAData();
      } else {
        updateGAStatus(false);
      }

      // Load local analytics data
      try {
        // Get user activity from database
        const { data: activity, error } = await supabaseClient
          .from('customer_activity_log')
          .select('*')
          .gte('created_at', new Date(Date.now() - range * 24 * 60 * 60 * 1000).toISOString())
          .order('created_at', { ascending: false })
          .limit(1000);

        if (!error && activity) {
          // Calculate stats
          const uniqueUsers = new Set(activity.map(a => a.customer_user_id || a.customer_email)).size;
          const pageViews = activity.filter(a => a.activity_type === 'page_view').length;

          document.getElementById('god-analytics-visitors').textContent = uniqueUsers.toLocaleString();
          document.getElementById('god-analytics-pageviews').textContent = pageViews.toLocaleString();
          document.getElementById('god-analytics-sessions').textContent = Math.round(pageViews / 3).toLocaleString();

          // Render user activity table
          renderGodUserActivity(activity);
        }

        // Get sg_users stats
        const { count: totalUsers } = await supabaseClient.from('sg_users').select('*', { count: 'exact', head: true });
        const { count: activeUsers } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact', head: true })
          .gte('updated_at', new Date(Date.now() - range * 24 * 60 * 60 * 1000).toISOString());

        document.getElementById('god-analytics-conversions').textContent = (activeUsers || 0).toLocaleString();

        // Placeholder for bounce rate and duration (would need GA integration)
        document.getElementById('god-analytics-bounce').textContent = '-';
        document.getElementById('god-analytics-duration').textContent = '-';

        // Load top pages
        await godLoadTopPages();
        // Load traffic sources
        await godLoadTrafficSources();

      } catch (error) {
        console.error('Analytics load error:', error);
        showToast('Failed to load analytics', 'error');
      }
    }

    function renderGodUserActivity(activity) {
      const container = document.getElementById('god-user-activity');
      if (!container || !activity.length) {
        if (container) container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No activity recorded</div>';
        return;
      }

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Time</th>
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">User</th>
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Activity</th>
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Page</th>
            </tr>
          </thead>
          <tbody>
            ${activity.slice(0, 100).map(a => `
              <tr style="border-bottom: 1px solid var(--border-subtle);">
                <td style="padding: 10px 16px; font-size: 12px; color: var(--text-muted);">${new Date(a.created_at).toLocaleString()}</td>
                <td style="padding: 10px 16px; font-size: 13px;">${escapeHtml(a.customer_email || a.customer_user_id?.substring(0,8) || 'Anonymous')}</td>
                <td style="padding: 10px 16px;"><span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #a855f7; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${escapeHtml(a.activity_type || 'view')}</span></td>
                <td style="padding: 10px 16px; font-size: 12px; color: var(--text-secondary); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(a.page_url || '-')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function godLoadTopPages() {
      const container = document.getElementById('god-top-pages');
      if (!container) return;

      // Sample top pages data (would need actual analytics)
      const topPages = [
        { path: '/', views: 12450, title: 'Home' },
        { path: '/countertops/', views: 8234, title: 'Countertops' },
        { path: '/account/', views: 5621, title: 'Account Portal' },
        { path: '/get-a-free-estimate/', views: 4532, title: 'Free Estimate' },
        { path: '/shop/', views: 3421, title: 'Shop' },
        { path: '/vendors/msi-quartz/', views: 2845, title: 'MSI Quartz' },
        { path: '/virtual-designer/', views: 2156, title: 'Virtual Designer' },
        { path: '/collaborators/', views: 1923, title: 'Find Collaborators' }
      ];

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Page</th>
              <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Views</th>
            </tr>
          </thead>
          <tbody>
            ${topPages.map((p, i) => `
              <tr style="border-bottom: 1px solid var(--border-subtle);">
                <td style="padding: 12px 16px;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 24px; height: 24px; border-radius: 4px; background: rgba(139, 92, 246, 0.2); color: #a855f7; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${i + 1}</span>
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(p.title)}</div>
                      <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(p.path)}</div>
                    </div>
                  </div>
                </td>
                <td style="padding: 12px 16px; text-align: right; font-weight: 600;">${p.views.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function godLoadTrafficSources() {
      const container = document.getElementById('god-traffic-sources');
      if (!container) return;

      // Sample traffic sources (would need actual analytics)
      const sources = [
        { source: 'Google', medium: 'organic', sessions: 8450, percent: 45 },
        { source: 'Direct', medium: 'none', sessions: 4230, percent: 22 },
        { source: 'Facebook', medium: 'social', sessions: 2840, percent: 15 },
        { source: 'Bing', medium: 'organic', sessions: 1520, percent: 8 },
        { source: 'Google', medium: 'cpc', sessions: 980, percent: 5 },
        { source: 'Instagram', medium: 'social', sessions: 560, percent: 3 },
        { source: 'Yelp', medium: 'referral', sessions: 380, percent: 2 }
      ];

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Source / Medium</th>
              <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Sessions</th>
              <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">%</th>
            </tr>
          </thead>
          <tbody>
            ${sources.map(s => `
              <tr style="border-bottom: 1px solid var(--border-subtle);">
                <td style="padding: 12px 16px;">
                  <span style="font-weight: 500;">${escapeHtml(s.source)}</span>
                  <span style="color: var(--text-muted);"> / ${escapeHtml(s.medium)}</span>
                </td>
                <td style="padding: 12px 16px; text-align: right; font-weight: 500;">${s.sessions.toLocaleString()}</td>
                <td style="padding: 12px 16px; text-align: right;">
                  <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                    <div style="width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                      <div style="width: ${s.percent}%; height: 100%; background: var(--accent);"></div>
                    </div>
                    <span style="font-size: 12px; color: var(--text-muted); min-width: 30px;">${s.percent}%</span>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function godShowAnalyticsTab(tab) {
      document.querySelectorAll('.god-analytics-tab').forEach(t => t.style.display = 'none');
      document.querySelectorAll('#page-god-analytics .tab-modern').forEach(t => t.classList.remove('active'));

      const tabEl = document.getElementById(`god-analytics-tab-${tab}`);
      if (tabEl) tabEl.style.display = 'block';

      event.target.classList.add('active');
    }

    // Google Analytics OAuth and API Integration
    let gaAccessToken = null;
    let gaTokenClient = null;

    function godConnectGoogleAnalytics() {
      if (gaAccessToken) {
        // Already connected, refresh data
        godLoadGAData();
        return;
      }

      // Check if Google API is loaded
      if (typeof google === 'undefined' || !google.accounts) {
        showToast('Loading Google API...', 'info');
        loadGoogleAPI().then(() => initGoogleAuth());
        return;
      }

      initGoogleAuth();
    }

    function loadGoogleAPI() {
      return new Promise((resolve) => {
        if (document.getElementById('google-gsi-script')) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.id = 'google-gsi-script';
        script.src = 'https://accounts.google.com/gsi/client';
        script.onload = resolve;
        document.head.appendChild(script);
      });
    }

    function initGoogleAuth() {
      const clientId = window.SG_CONFIG?.GOOGLE_CLIENT_ID || '46783393854-3bclu7oh0l6t6fem91mj9jj681aep4cs.apps.googleusercontent.com';

      gaTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: [
          'https://www.googleapis.com/auth/analytics.readonly',
          'https://www.googleapis.com/auth/webmasters.readonly',
          'https://www.googleapis.com/auth/business.manage'
        ].join(' '),
        callback: (response) => {
          if (response.access_token) {
            gaAccessToken = response.access_token;
            localStorage.setItem('ga_access_token', gaAccessToken);
            updateGAStatus(true);
            showToast('Google Analytics connected!', 'success');
            godLoadGAData();
          } else {
            showToast('Failed to connect to Google Analytics', 'error');
          }
        },
      });

      // Check for existing token
      const savedToken = localStorage.getItem('ga_access_token');
      if (savedToken) {
        gaAccessToken = savedToken;
        updateGAStatus(true);
        godLoadGAData();
      } else {
        gaTokenClient.requestAccessToken();
      }
    }

    function updateGAStatus(connected) {
      const indicator = document.getElementById('god-ga-indicator');
      const text = document.getElementById('god-ga-text');
      const btn = document.getElementById('god-ga-connect-btn');

      if (connected) {
        indicator.style.background = 'var(--success)';
        text.textContent = 'GA4 Connected';
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M9 12l2 2 4-4"/></svg> Refresh GA4';
      } else {
        indicator.style.background = 'var(--warning)';
        text.textContent = 'GA4 Not Connected';
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Connect GA4';
      }
    }

    async function godLoadGAData() {
      if (!gaAccessToken) {
        console.log('No GA access token, skipping GA data load');
        return;
      }

      const propertyId = window.SG_CONFIG?.GOOGLE_ANALYTICS_PROPERTY || 'properties/495413683';
      const range = document.getElementById('god-analytics-range')?.value || 30;

      const startDate = new Date();
      startDate.setDate(startDate.getDate() - parseInt(range));
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = new Date().toISOString().split('T')[0];

      try {
        // Fetch main metrics
        const metricsResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gaAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dateRanges: [{ startDate: startDateStr, endDate: endDateStr }],
            metrics: [
              { name: 'activeUsers' },
              { name: 'screenPageViews' },
              { name: 'sessions' },
              { name: 'bounceRate' },
              { name: 'averageSessionDuration' },
              { name: 'conversions' }
            ]
          })
        });

        if (!metricsResponse.ok) {
          if (metricsResponse.status === 401) {
            // Token expired, clear and reconnect
            localStorage.removeItem('ga_access_token');
            gaAccessToken = null;
            updateGAStatus(false);
            showToast('GA4 session expired. Please reconnect.', 'warning');
            return;
          }
          throw new Error('Failed to fetch GA data');
        }

        const metricsData = await metricsResponse.json();
        const row = metricsData.rows?.[0]?.metricValues || [];

        // Update stats
        document.getElementById('god-analytics-visitors').textContent = parseInt(row[0]?.value || 0).toLocaleString();
        document.getElementById('god-analytics-pageviews').textContent = parseInt(row[1]?.value || 0).toLocaleString();
        document.getElementById('god-analytics-sessions').textContent = parseInt(row[2]?.value || 0).toLocaleString();
        document.getElementById('god-analytics-bounce').textContent = (parseFloat(row[3]?.value || 0) * 100).toFixed(1) + '%';

        const avgDuration = parseFloat(row[4]?.value || 0);
        const mins = Math.floor(avgDuration / 60);
        const secs = Math.round(avgDuration % 60);
        document.getElementById('god-analytics-duration').textContent = `${mins}m ${secs}s`;

        document.getElementById('god-analytics-conversions').textContent = parseInt(row[5]?.value || 0).toLocaleString();

        // Fetch top pages
        await godLoadGATopPages(propertyId, startDateStr, endDateStr);
        // Fetch traffic sources
        await godLoadGATrafficSources(propertyId, startDateStr, endDateStr);
        // Fetch Search Console data
        await godLoadSearchConsole();
        // Fetch Google Business data
        await godLoadGoogleBusiness();

        showToast('Analytics data updated from GA4', 'success');

      } catch (error) {
        console.error('GA Data API error:', error);
        showToast('Failed to load GA4 data: ' + error.message, 'error');
      }
    }

    async function godLoadGATopPages(propertyId, startDate, endDate) {
      try {
        const response = await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gaAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dateRanges: [{ startDate, endDate }],
            dimensions: [{ name: 'pagePath' }],
            metrics: [{ name: 'screenPageViews' }, { name: 'activeUsers' }],
            orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
            limit: 10
          })
        });

        if (!response.ok) return;
        const data = await response.json();

        const container = document.getElementById('god-top-pages');
        if (container && data.rows) {
          container.innerHTML = data.rows.map((row, i) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="width: 24px; height: 24px; background: rgba(168, 85, 247, 0.2); color: #a855f7; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${i + 1}</span>
                <span style="font-size: 13px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(row.dimensionValues[0].value)}</span>
              </div>
              <div style="display: flex; gap: 16px; align-items: center;">
                <span style="font-weight: 600; color: var(--accent);">${parseInt(row.metricValues[0].value).toLocaleString()} views</span>
                <span style="font-size: 12px; color: var(--text-muted);">${parseInt(row.metricValues[1].value).toLocaleString()} users</span>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading top pages:', error);
      }
    }

    async function godLoadGATrafficSources(propertyId, startDate, endDate) {
      try {
        const response = await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gaAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dateRanges: [{ startDate, endDate }],
            dimensions: [{ name: 'sessionDefaultChannelGroup' }],
            metrics: [{ name: 'sessions' }, { name: 'activeUsers' }],
            orderBys: [{ metric: { metricName: 'sessions' }, desc: true }],
            limit: 8
          })
        });

        if (!response.ok) return;
        const data = await response.json();

        const container = document.getElementById('god-traffic-sources');
        if (container && data.rows) {
          const total = data.rows.reduce((sum, row) => sum + parseInt(row.metricValues[0].value), 0);
          const colors = ['#a855f7', '#f9cb00', '#10b981', '#3b82f6', '#ef4444', '#f97316', '#06b6d4', '#8b5cf6'];

          container.innerHTML = data.rows.map((row, i) => {
            const sessions = parseInt(row.metricValues[0].value);
            const pct = ((sessions / total) * 100).toFixed(1);
            return `
              <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                  <span style="font-size: 13px; font-weight: 500;">${escapeHtml(row.dimensionValues[0].value)}</span>
                  <span style="font-size: 13px; color: var(--text-muted);">${sessions.toLocaleString()} (${pct}%)</span>
                </div>
                <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                  <div style="height: 100%; width: ${pct}%; background: ${colors[i % colors.length]}; border-radius: 4px;"></div>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading traffic sources:', error);
      }
    }

    function godDisconnectGA() {
      localStorage.removeItem('ga_access_token');
      gaAccessToken = null;
      updateGAStatus(false);
      showToast('Disconnected from Google Analytics', 'info');
    }

    // Google Search Console API
    async function godLoadSearchConsole() {
      if (!gaAccessToken) {
        showToast('Please connect Google first', 'warning');
        return;
      }

      // Try different URL formats - Search Console can be verified different ways
      const siteUrls = [
        'https://www.surprisegranite.com/',
        'https://surprisegranite.com/',
        'sc-domain:surprisegranite.com'
      ];
      const range = document.getElementById('god-analytics-range')?.value || 30;
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - parseInt(range));
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = new Date().toISOString().split('T')[0];

      let data = null;
      let successUrl = null;

      // Try each URL format until one works
      for (const siteUrl of siteUrls) {
        try {
          const response = await fetch(`https://www.googleapis.com/webmasters/v3/sites/${encodeURIComponent(siteUrl)}/searchAnalytics/query`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${gaAccessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              startDate: startDateStr,
              endDate: endDateStr,
              dimensions: ['query'],
              rowLimit: 20
            })
          });

          if (response.ok) {
            data = await response.json();
            successUrl = siteUrl;
            console.log('Search Console connected with:', siteUrl);
            break;
          }
        } catch (e) {
          console.log('Search Console URL failed:', siteUrl);
        }
      }

      if (!data) {
        document.getElementById('god-gsc-queries').innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <p style="color: var(--warning); margin-bottom: 16px;">Search Console access not configured</p>
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Make sure your site is verified in Search Console with the same Google account</p>
            <a href="https://search.google.com/search-console" target="_blank" class="btn-modern secondary">Open Search Console</a>
          </div>
        `;
        return;
      }

      try {

        // Update summary stats
        let totalClicks = 0, totalImpressions = 0, totalCtr = 0, totalPosition = 0;
        if (data.rows) {
          data.rows.forEach(row => {
            totalClicks += row.clicks || 0;
            totalImpressions += row.impressions || 0;
            totalPosition += row.position || 0;
          });
          totalCtr = totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : 0;
        }

        document.getElementById('god-gsc-clicks').textContent = totalClicks.toLocaleString();
        document.getElementById('god-gsc-impressions').textContent = totalImpressions.toLocaleString();
        document.getElementById('god-gsc-ctr').textContent = totalCtr.toFixed(1) + '%';
        document.getElementById('god-gsc-position').textContent = data.rows?.length > 0 ? (totalPosition / data.rows.length).toFixed(1) : '-';

        // Render queries
        const container = document.getElementById('god-gsc-queries');
        if (data.rows && data.rows.length > 0) {
          container.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
                  <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Query</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Clicks</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Impressions</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">CTR</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Position</th>
                </tr>
              </thead>
              <tbody>
                ${data.rows.map(row => `
                  <tr style="border-bottom: 1px solid var(--border-subtle);">
                    <td style="padding: 10px 16px; font-size: 13px;">${escapeHtml(row.keys[0])}</td>
                    <td style="padding: 10px 16px; text-align: right; font-weight: 600; color: var(--accent);">${row.clicks}</td>
                    <td style="padding: 10px 16px; text-align: right; color: var(--text-muted);">${row.impressions.toLocaleString()}</td>
                    <td style="padding: 10px 16px; text-align: right; color: var(--success);">${(row.ctr * 100).toFixed(1)}%</td>
                    <td style="padding: 10px 16px; text-align: right;">${row.position.toFixed(1)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No search data found for this period</div>';
        }

      } catch (error) {
        console.error('Search Console error:', error);
        document.getElementById('god-gsc-queries').innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--error);">Failed to load Search Console data</div>
        `;
      }
    }

    // Google Business Profile API
    async function godLoadGoogleBusiness() {
      if (!gaAccessToken) {
        showToast('Please connect Google first', 'warning');
        return;
      }

      try {
        // First, get the list of accounts
        const accountsResponse = await fetch('https://mybusinessaccountmanagement.googleapis.com/v1/accounts', {
          headers: { 'Authorization': `Bearer ${gaAccessToken}` }
        });

        if (!accountsResponse.ok) {
          if (accountsResponse.status === 403) {
            document.getElementById('god-gmb-reviews').innerHTML = `
              <div style="padding: 40px; text-align: center;">
                <p style="color: var(--warning); margin-bottom: 16px;">Google Business Profile access not configured</p>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Enable the Business Profile API in Google Cloud Console</p>
                <a href="https://console.cloud.google.com/apis/library/mybusinessaccountmanagement.googleapis.com" target="_blank" class="btn-modern secondary">Enable API</a>
              </div>
            `;
            return;
          }
          throw new Error('Failed to fetch Business Profile');
        }

        const accountsData = await accountsResponse.json();

        if (!accountsData.accounts || accountsData.accounts.length === 0) {
          document.getElementById('god-gmb-reviews').innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No Google Business Profile found</div>';
          return;
        }

        const accountName = accountsData.accounts[0].name;

        // Get locations
        const locationsResponse = await fetch(`https://mybusinessbusinessinformation.googleapis.com/v1/${accountName}/locations`, {
          headers: { 'Authorization': `Bearer ${gaAccessToken}` }
        });

        if (locationsResponse.ok) {
          const locationsData = await locationsResponse.json();

          if (locationsData.locations && locationsData.locations.length > 0) {
            const locationName = locationsData.locations[0].name;

            // Get reviews
            const reviewsResponse = await fetch(`https://mybusiness.googleapis.com/v4/${locationName}/reviews`, {
              headers: { 'Authorization': `Bearer ${gaAccessToken}` }
            });

            if (reviewsResponse.ok) {
              const reviewsData = await reviewsResponse.json();
              renderGMBReviews(reviewsData.reviews || []);
            }
          }
        }

        // Update with placeholder metrics for now (actual metrics require specific API calls)
        document.getElementById('god-gmb-actions').innerHTML = `
          <div style="display: grid; gap: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
              <span>Website Clicks</span>
              <span style="font-weight: 600; color: var(--accent);">View in GMB</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
              <span>Photo Views</span>
              <span style="font-weight: 600; color: var(--info);">View in GMB</span>
            </div>
            <a href="https://business.google.com" target="_blank" class="btn-modern primary" style="margin-top: 12px; justify-content: center;">Open Google Business Profile</a>
          </div>
        `;

      } catch (error) {
        console.error('Google Business error:', error);
        document.getElementById('god-gmb-reviews').innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--error);">Failed to load Google Business data</div>
        `;
      }
    }

    function renderGMBReviews(reviews) {
      const container = document.getElementById('god-gmb-reviews');

      if (!reviews || reviews.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No recent reviews</div>';
        return;
      }

      const starColors = { 'FIVE': '#fbbf24', 'FOUR': '#fbbf24', 'THREE': '#9ca3af', 'TWO': '#f87171', 'ONE': '#ef4444' };
      const starCounts = { 'FIVE': 5, 'FOUR': 4, 'THREE': 3, 'TWO': 2, 'ONE': 1 };

      container.innerHTML = reviews.slice(0, 10).map(review => `
        <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="font-weight: 500;">${escapeHtml(review.reviewer?.displayName || 'Anonymous')}</div>
            <div style="color: ${starColors[review.starRating] || '#fbbf24'};">
              ${''.repeat(starCounts[review.starRating] || 5)}${''.repeat(5 - (starCounts[review.starRating] || 5))}
            </div>
          </div>
          <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">${escapeHtml(review.comment || 'No comment')}</p>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">${new Date(review.createTime).toLocaleDateString()}</div>
        </div>
      `).join('');
    }

    function godExportUserActivity() {
      showToast('Exporting user activity...', 'info');
      // Implementation would export activity data to CSV
    }

    // ==================== SITE MANAGER FUNCTIONS ====================

    async function godLoadSiteManager() {
      if (!isGodMode()) return;
      console.log(' GOD MODE: Loading site manager...');

      // Update site stats
      document.getElementById('god-site-status').textContent = 'Online';
      document.getElementById('god-site-status').style.color = 'var(--success)';

      // Count pages (approximate based on sitemap)
      document.getElementById('god-site-pages').textContent = '~150';
      document.getElementById('god-site-images').textContent = '~500';
      document.getElementById('god-site-lighthouse').textContent = '85+';
    }

    function godClearSiteCache() {
      if (!confirm('Clear all browser caches? This will log you out.')) return;
      localStorage.clear();
      sessionStorage.clear();
      showToast('Cache cleared. Reloading...', 'success');
      setTimeout(() => location.reload(), 1500);
    }

    function godTriggerDeploy() {
      showToast('To trigger a deploy, push to main branch or use Netlify dashboard.', 'info');
      window.open('https://app.netlify.com/sites/surprise-granite-site/deploys', '_blank');
    }

    function godCheckSitemap() {
      window.open('/sitemap.xml', '_blank');
    }

    function godRunLighthouse() {
      const url = encodeURIComponent('https://surprisegranite.com');
      window.open(`https://pagespeed.web.dev/analysis?url=${url}`, '_blank');
    }

    // ==================== CONFIG FUNCTIONS ====================

    async function godLoadConfig() {
      if (!isGodMode()) return;
      console.log(' GOD MODE: Loading config...');

      // Set API URL
      const apiUrl = window.SG_CONFIG?.API_BASE_URL || 'Not configured';
      document.getElementById('god-config-api-url').textContent = apiUrl;

      // Load feature flags from localStorage
      document.getElementById('god-flag-maintenance').checked = localStorage.getItem('sg_maintenance') === 'true';
      document.getElementById('god-flag-debug').checked = localStorage.getItem('sg_debug') === 'true';
      document.getElementById('god-flag-beta').checked = localStorage.getItem('sg_beta') === 'true';
      document.getElementById('god-flag-ai').checked = localStorage.getItem('sg_ai') !== 'false';

      // Check integrations
      godCheckIntegrations();
    }

    async function godCheckIntegrations() {
      // Supabase check
      try {
        const { error } = await supabaseClient.from('sg_users').select('id').limit(1);
        document.getElementById('god-int-supabase').style.background = error ? 'var(--error)' : 'var(--success)';
      } catch {
        document.getElementById('god-int-supabase').style.background = 'var(--error)';
      }

      // Stripe check (via API)
      try {
        const res = await fetch(`${window.SG_CONFIG?.API_BASE_URL || ''}/api/health`);
        document.getElementById('god-int-stripe').style.background = res.ok ? 'var(--success)' : 'var(--warning)';
      } catch {
        document.getElementById('god-int-stripe').style.background = 'var(--warning)';
      }

      // GA check
      document.getElementById('god-int-ga').style.background = typeof gtag === 'function' ? 'var(--success)' : 'var(--warning)';

      // Shopify - check if products exist
      try {
        const { count } = await supabaseClient.from('shopify_products').select('*', { count: 'exact', head: true });
        document.getElementById('god-int-shopify').style.background = count > 0 ? 'var(--success)' : 'var(--warning)';
      } catch {
        document.getElementById('god-int-shopify').style.background = 'var(--warning)';
      }

      // Netlify - assume online if page loads
      document.getElementById('god-int-netlify').style.background = 'var(--success)';

      // Email - can't easily check
      document.getElementById('god-int-email').style.background = 'var(--warning)';
    }

    function godToggleFeature(feature, enabled) {
      localStorage.setItem(`sg_${feature}`, enabled.toString());
      showToast(`${feature} ${enabled ? 'enabled' : 'disabled'}`, 'success');

      if (feature === 'maintenance' && enabled) {
        document.body.classList.add('maintenance-mode');
      } else if (feature === 'maintenance') {
        document.body.classList.remove('maintenance-mode');
      }

      if (feature === 'debug') {
        console.log('Debug mode:', enabled);
      }
    }

    function godPurgeAllData() {
      if (!confirm(' This will clear ALL local data including saved preferences. Continue?')) return;
      if (!confirm('Are you absolutely sure? This cannot be undone.')) return;

      localStorage.clear();
      sessionStorage.clear();

      // Clear IndexedDB if exists
      if (window.indexedDB) {
        indexedDB.databases().then(dbs => {
          dbs.forEach(db => indexedDB.deleteDatabase(db.name));
        }).catch(() => {});
      }

      showToast('All local data purged. Reloading...', 'success');
      setTimeout(() => location.reload(), 1500);
    }

    function godResetAnalytics() {
      if (!confirm('Reset all local analytics data?')) return;

      // Clear analytics-related localStorage
      Object.keys(localStorage).forEach(key => {
        if (key.includes('analytics') || key.includes('tracking') || key.includes('engagement')) {
          localStorage.removeItem(key);
        }
      });

      showToast('Local analytics reset', 'success');
    }

    // Hook GOD MODE page initialization into showPage
    const originalShowPageForGod = showPage;
    showPage = function(pageId) {
      originalShowPageForGod(pageId);
      if (pageId.startsWith('god-')) {
        initGodModePage(pageId);
      }
    };

    // GOD MODE Designs Management
    let godDesignsPage = 0;
    const godDesignsPageSize = 50;
    let godDesignsSearchTimeout = null;

    async function godLoadDesigns() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-designs-search')?.value?.trim().toLowerCase() || '';
        const typeFilter = document.getElementById('god-designs-type-filter')?.value || 'all';
        const statusFilter = document.getElementById('god-designs-status-filter')?.value || 'all';

        // Build query - join with sg_users to get creator info
        let query = supabaseClient
          .from('room_designs')
          .select('*, sg_users(email, full_name)', { count: 'exact' });

        // Apply room type filter
        if (typeFilter !== 'all') {
          query = query.eq('room_type', typeFilter);
        }

        // Apply status filter
        if (statusFilter === 'shared') {
          query = query.not('share_token', 'is', null);
        } else if (statusFilter === 'private') {
          query = query.is('share_token', null);
        }

        // Apply search filter
        if (searchTerm) {
          query = query.or(`name.ilike.%${searchTerm}%,project_name.ilike.%${searchTerm}%`);
        }

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godDesignsPage * godDesignsPageSize, (godDesignsPage + 1) * godDesignsPageSize - 1);

        if (error) throw error;

        // Update summary stats
        await godUpdateDesignStats();

        // Update count text
        const total = count || 0;
        document.getElementById('god-designs-count').textContent =
          `Showing ${data?.length || 0} of ${total} designs`;

        // Render table
        godRenderDesignsTable(data || []);

        // Update pagination buttons
        document.getElementById('god-designs-prev').disabled = godDesignsPage === 0;
        document.getElementById('god-designs-next').disabled = (godDesignsPage + 1) * godDesignsPageSize >= total;

      } catch (error) {
        console.error('Error loading designs:', error);
        document.getElementById('god-designs-table-body').innerHTML =
          '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--error);">Error loading designs</td></tr>';
      }
    }

    async function godUpdateDesignStats() {
      try {
        // Total designs
        const { count: totalCount } = await supabaseClient
          .from('room_designs')
          .select('*', { count: 'exact', head: true });

        // Shared designs (have share_token)
        const { count: sharedCount } = await supabaseClient
          .from('room_designs')
          .select('*', { count: 'exact', head: true })
          .not('share_token', 'is', null);

        // Unique users
        const { data: usersData } = await supabaseClient
          .from('room_designs')
          .select('user_id');

        const uniqueUsers = new Set((usersData || []).map(d => d.user_id)).size;

        document.getElementById('god-designs-total').textContent = totalCount || 0;
        document.getElementById('god-designs-shared').textContent = sharedCount || 0;
        document.getElementById('god-designs-private').textContent = (totalCount || 0) - (sharedCount || 0);
        document.getElementById('god-designs-users').textContent = uniqueUsers;
      } catch (err) {
        console.error('Error updating design stats:', err);
      }
    }

    function godRenderDesignsTable(designs) {
      const tbody = document.getElementById('god-designs-table-body');
      if (!designs || designs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);">No designs found</td></tr>';
        return;
      }

      const roomTypeColors = {
        'kitchen': '#3b82f6',
        'bathroom': '#14b8a6',
        'laundry': '#a855f7',
        'outdoor': '#f59e0b',
        'other': '#6b7280'
      };

      tbody.innerHTML = designs.map(d => {
        const name = escapeHtml(d.name || d.project_name || 'Untitled Design');
        const creatorEmail = escapeHtml(d.sg_users?.email || 'Unknown');
        const creatorName = escapeHtml(d.sg_users?.full_name || '');
        const roomType = (d.room_type || 'other').toLowerCase();
        const roomColor = roomTypeColors[roomType] || roomTypeColors['other'];
        const elementsCount = Array.isArray(d.elements) ? d.elements.length : 0;
        const quoteTotal = d.quote_total != null ? `$${parseFloat(d.quote_total).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '';
        const isShared = !!d.share_token;
        const createdDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '';
        const designLink = d.share_token
          ? `/tools/room-designer/?p=${d.share_token}`
          : `/tools/room-designer/?id=${d.id}`;

        return `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <div style="font-weight: 500;">${name}</div>
              <div style="font-size: 12px; color: var(--text-muted);">ID: ${escapeHtml(String(d.id).substring(0, 8))}...</div>
            </td>
            <td style="padding: 12px 16px;">
              <div style="font-size: 13px;">${creatorName || creatorEmail}</div>
              ${creatorName ? `<div style="font-size: 12px; color: var(--text-muted);">${creatorEmail}</div>` : ''}
            </td>
            <td style="padding: 12px 16px;">
              <span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${roomColor}22; color: ${roomColor};">${escapeHtml(roomType.charAt(0).toUpperCase() + roomType.slice(1))}</span>
            </td>
            <td style="padding: 12px 16px; font-size: 13px; text-align: center;">${elementsCount}</td>
            <td style="padding: 12px 16px; font-size: 13px; font-weight: 500;">${quoteTotal}</td>
            <td style="padding: 12px 16px;">
              ${isShared
                ? '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; background: rgba(34,197,94,0.15); color: var(--success);">Shared</span>'
                : '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; background: rgba(107,114,128,0.15); color: var(--text-muted);">Private</span>'}
            </td>
            <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${createdDate}</td>
            <td style="padding: 12px 16px; text-align: center;">
              <div style="display: flex; gap: 6px; justify-content: center;">
                <a href="${designLink}" target="_blank" class="btn-modern secondary" style="padding: 6px 10px; font-size: 12px;" title="Open design">Open</a>
                <button class="btn-modern secondary" onclick="godCopyDesignLink('${escapeHtml(d.share_token || '')}', '${escapeHtml(String(d.id))}')" style="padding: 6px 10px; font-size: 12px;" title="Copy link">Link</button>
                <button class="btn-modern secondary" onclick="godDeleteDesign('${escapeHtml(String(d.id))}', '${name.replace(/'/g, "\\'")}')" style="padding: 6px 10px; font-size: 12px; color: var(--error);" title="Delete design">Del</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    function godSearchDesigns() {
      clearTimeout(godDesignsSearchTimeout);
      godDesignsSearchTimeout = setTimeout(() => {
        godDesignsPage = 0;
        godLoadDesigns();
      }, 300);
    }

    function godFilterDesignsType() {
      godDesignsPage = 0;
      godLoadDesigns();
    }

    function godFilterDesignsStatus() {
      godDesignsPage = 0;
      godLoadDesigns();
    }

    function godDesignsPagePrev() {
      if (godDesignsPage > 0) {
        godDesignsPage--;
        godLoadDesigns();
      }
    }

    function godDesignsPageNext() {
      godDesignsPage++;
      godLoadDesigns();
    }

    async function godDeleteDesign(id, name) {
      if (!isGodMode()) return;
      if (!confirm(`Delete design "${name}"?\n\nThis action cannot be undone.`)) return;

      try {
        const { error } = await supabaseClient
          .from('room_designs')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('Design deleted successfully', 'success');
        godLoadDesigns();
      } catch (err) {
        console.error('Error deleting design:', err);
        showToast('Error deleting design: ' + err.message, 'error');
      }
    }

    function godCopyDesignLink(token, id) {
      const baseUrl = window.location.origin;
      const url = token
        ? `${baseUrl}/tools/room-designer/?p=${token}`
        : `${baseUrl}/tools/room-designer/?id=${id}`;

      navigator.clipboard.writeText(url).then(() => {
        showToast('Design link copied to clipboard', 'success');
      }).catch(() => {
        // Fallback
        const input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('Design link copied to clipboard', 'success');
      });
    }

    function godExportDesigns() {
      if (!isGodMode()) return;
      showToast('Exporting designs...', 'info');

      supabaseClient
        .from('room_designs')
        .select('*, sg_users(email, full_name)')
        .order('created_at', { ascending: false })
        .then(({ data, error }) => {
          if (error) {
            showToast('Export failed: ' + error.message, 'error');
            return;
          }
          if (!data || data.length === 0) {
            showToast('No designs to export', 'warning');
            return;
          }

          const headers = ['ID', 'Name', 'Creator Email', 'Creator Name', 'Room Type', 'Elements Count', 'Quote Total', 'Status', 'Share Token', 'Created At', 'Updated At'];
          const rows = data.map(d => [
            d.id,
            d.name || d.project_name || '',
            d.sg_users?.email || '',
            d.sg_users?.full_name || '',
            d.room_type || '',
            Array.isArray(d.elements) ? d.elements.length : 0,
            d.quote_total != null ? d.quote_total : '',
            d.share_token ? 'Shared' : 'Private',
            d.share_token || '',
            d.created_at || '',
            d.updated_at || ''
          ]);

          const csv = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `all-designs-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          showToast('Designs exported successfully', 'success');
        });
    }

    console.log(' GOD MODE functions loaded');
    // ==================== END GOD MODE FUNCTIONS ====================

  </script>
<script src="/js/user-tracking.js"></script>
<script src="/js/site-search.js"></script>

<!-- Remodely.ai Integration -->
<script src="/remodely-platform/config/tenants.js"></script>
<script>
  // Initialize Remodely tenant integration
  document.addEventListener('DOMContentLoaded', function() {
    if (window.REMODELY_TENANTS) {
      const tenant = window.REMODELY_TENANTS.initializeTenant();
      console.log('Remodely tenant initialized:', tenant.name);
    }
  });
</script>

<!-- Pro-Customer Referral Tracking -->
<script src="/js/referral-tracking.js?v=20260118"></script>

</body>
</html>
