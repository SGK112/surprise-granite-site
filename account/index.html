<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Account | Surprise Granite</title>
  <meta name="description" content="Manage your Surprise Granite account, view leads, and access your dashboard."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-light: rgba(255, 255, 255, 0.15);
      --success: #4dff82;
      --warning: #ffb84d;
      --error: #ff6b6b;
      --info: #4da6ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* Unified Nav Offset - account for fixed header */
    :root {
      --unified-nav-height: 140px; /* Match unified-nav desktop height */
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 72px;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: var(--unified-nav-height);
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: width 0.3s ease, transform 0.3s ease;
    }

    /* Collapsed Sidebar State */
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
    }

    .sidebar.collapsed .sidebar-header {
      padding: 0 12px 24px;
    }

    .sidebar.collapsed .sidebar-logo-text,
    .sidebar.collapsed .sidebar-logo-sub {
      display: none;
    }

    .sidebar.collapsed .nav-section-title {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 12px;
    }

    .sidebar.collapsed .nav-item-text {
      display: none;
    }

    .sidebar.collapsed .nav-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 16px;
      padding: 2px 5px;
      font-size: 9px;
    }

    .sidebar.collapsed .nav-item {
      position: relative;
    }

    .sidebar.collapsed .sidebar-footer {
      padding: 16px 12px;
    }

    .sidebar.collapsed .user-info,
    .sidebar.collapsed .logout-btn {
      display: none;
    }

    .sidebar.collapsed .user-menu {
      justify-content: center;
    }

    /* Sidebar Toggle Button */
    .sidebar-toggle {
      position: absolute;
      top: 50%;
      right: -12px;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--gold-primary);
      border: 2px solid var(--dark-surface);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--dark-primary);
      z-index: 101;
      transition: transform 0.3s ease;
    }

    .sidebar-toggle:hover {
      transform: translateY(-50%) scale(1.1);
    }

    .sidebar-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform 0.3s ease;
    }

    .sidebar.collapsed .sidebar-toggle svg {
      transform: rotate(180deg);
    }

    /* Hide zero badges */
    .nav-badge.empty,
    .nav-badge[data-count="0"] {
      display: none;
    }

    .sidebar-header {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 24px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-primary);
    }

    .sidebar-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: var(--dark-primary);
    }

    .sidebar-logo-text {
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-logo-sub {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* FORCE SIDEBAR NAV VISIBILITY - Override any interference */
    .sidebar-nav,
    nav.sidebar-nav,
    .sidebar .sidebar-nav,
    #sidebar .sidebar-nav {
      flex: 1;
      padding: 0 12px;
      overflow-y: auto;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      max-height: none !important;
      position: relative !important;
      transform: none !important;
      left: auto !important;
      top: auto !important;
    }

    .nav-section,
    .sidebar-nav .nav-section {
      margin-bottom: 24px;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .nav-item,
    .sidebar-nav .nav-item {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(249, 203, 0, 0.1);
      color: var(--gold-primary);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    .nav-badge {
      margin-left: auto;
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      font-size: 11px;
      font-weight: 800;
      padding: 3px 10px;
      border-radius: 100px;
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 20px;
      text-align: center;
    }

    .nav-badge.empty {
      background: var(--border-subtle);
      color: var(--text-muted);
      box-shadow: none;
      border: none;
    }

    /* Account type badges */
    .account-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .account-badge.homeowner {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .account-badge.pro {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.3);
    }

    .account-badge.pro::before {
      content: '\2605';
      font-size: 10px;
    }

    .account-badge.admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .account-badge.admin::before {
      content: '\2699';
      font-size: 10px;
    }

    /* Stat value styling */
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-primary);
      text-shadow: 0 0 20px rgba(249, 203, 0, 0.3);
    }

    .stat-card:hover .stat-value {
      text-shadow: 0 0 30px rgba(249, 203, 0, 0.5);
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--dark-primary);
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
      /* padding-top handled by body.unified-nav-active in unified-nav.css */
    }

    body.sidebar-collapsed .main-content {
      margin-left: var(--sidebar-collapsed-width);
    }

    .topbar {
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 40px; /* Increased padding for better spacing */
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .topbar-title {
      font-size: 20px;
      font-weight: 700;
    }

    .topbar-actions {
      display: flex;
      gap: 12px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      padding: 8px;
      cursor: pointer;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .content-area {
      padding: 32px 40px; /* Match topbar horizontal padding */
      max-width: 1400px; /* Optimal reading width on large screens */
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
    }

    /* Cards */
    .card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
    }

    .card-body {
      padding: 24px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .action-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 20px;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .action-card:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: var(--gold-primary);
      transform: translateY(-2px);
    }

    /* Highlighted Action Card */
    .action-card.action-highlight {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.15) 0%, rgba(249, 203, 0, 0.08) 100%);
      border-color: var(--gold-primary);
    }

    .action-card.action-highlight:hover {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.25) 0%, rgba(249, 203, 0, 0.15) 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(249, 203, 0, 0.2);
    }

    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
      flex-shrink: 0;
    }

    .action-icon.action-icon-gold {
      background: var(--gold-primary);
      color: #1a1a2e;
    }

    .action-icon svg {
      width: 24px;
      height: 24px;
    }

    .action-text h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Stat Cards with icons */
    .stat-card {
      position: relative;
    }

    .stat-card.clickable {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-card.clickable:hover {
      transform: translateY(-2px);
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.08);
    }

    .stat-icon {
      margin-bottom: 8px;
    }

    /* Profile Form */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    /* Saved Floors Grid */
    .saved-floors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .saved-floor-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .saved-floor-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .saved-floor-image {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .saved-floor-content {
      padding: 12px;
    }

    .saved-floor-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .saved-floor-material {
      font-size: 11px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .saved-floor-specs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .saved-floor-spec {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .saved-floor-actions {
      display: flex;
      gap: 8px;
    }

    .saved-floor-actions a,
    .saved-floor-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .saved-floor-view {
      background: var(--primary);
      color: var(--dark);
    }

    .saved-floor-remove {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    .saved-floor-remove:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    /* Quote Request Modal */
    .quote-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .quote-modal-content {
      background: var(--dark-elevated);
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .quote-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quote-modal-body {
      padding: 20px;
    }

    .quote-items-list {
      margin-bottom: 20px;
    }

    .quote-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .quote-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }

    .quote-item-info {
      flex: 1;
    }

    .quote-item-title {
      font-size: 14px;
      font-weight: 600;
    }

    .quote-item-material {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Leads Table */
    .table-container {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .table-title {
      font-size: 16px;
      font-weight: 700;
    }

    .table-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-secondary);
    }

    .filter-btn:hover {
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 8px 16px;
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 14px;
      width: 200px;
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 24px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid var(--border-subtle);
    }

    td {
      padding: 16px 24px;
      font-size: 14px;
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: middle;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .lead-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .lead-email {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-project {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-new { background: rgba(77, 166, 255, 0.15); color: var(--info); }
    .status-new::before { background: var(--info); }

    .status-contacted { background: rgba(255, 184, 77, 0.15); color: var(--warning); }
    .status-contacted::before { background: var(--warning); }

    .status-qualified { background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); }
    .status-qualified::before { background: var(--gold-primary); }

    .status-quoted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .status-quoted::before { background: #a855f7; }

    .status-won { background: rgba(77, 255, 130, 0.15); color: var(--success); }
    .status-won::before { background: var(--success); }

    .status-lost { background: rgba(255, 107, 107, 0.15); color: var(--error); }
    .status-lost::before { background: var(--error); }

    .lead-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      text-decoration: none;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Coming Soon */
    .coming-soon {
      text-align: center;
      padding: 80px 24px;
    }

    .coming-soon-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 20px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
    }

    .coming-soon-icon svg {
      width: 40px;
      height: 40px;
    }

    .coming-soon h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .coming-soon p {
      color: var(--text-muted);
      max-width: 400px;
      margin: 0 auto;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    .modal-body {
      padding: 24px;
    }

    .detail-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Invoice Template Selector */
    .template-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .template-option {
      cursor: pointer;
    }

    .template-option input {
      display: none;
    }

    .template-preview {
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s;
      background: var(--dark-surface);
    }

    .template-option input:checked + .template-preview {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.1);
    }

    .template-preview:hover {
      border-color: var(--border-light);
    }

    .template-header-preview {
      height: 24px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .template-body-preview {
      height: 40px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .classic-preview .template-header-preview {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
    }
    .classic-preview .template-body-preview {
      background: #f4f4f4;
    }

    .modern-preview .template-header-preview {
      background: linear-gradient(90deg, #000, #333);
    }
    .modern-preview .template-body-preview {
      background: #ffffff;
      border: 1px solid #eee;
    }

    .premium-preview .template-header-preview {
      background: linear-gradient(135deg, #0a0a12, #12121a);
    }
    .premium-preview .template-body-preview {
      background: linear-gradient(135deg, #f9cb00, #d4a800);
    }

    .template-name {
      display: block;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .template-desc {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .template-selector {
        grid-template-columns: 1fr;
      }
    }

    /* Template Preview Modal */
    .template-tabs {
      display: flex;
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
    }

    .template-tab {
      flex: 1;
      padding: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .template-tab:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .template-tab.active {
      background: rgba(249, 203, 0, 0.1);
      border-bottom-color: var(--gold-primary);
    }

    .template-tab .tab-icon {
      display: block;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .template-tab .tab-label {
      display: block;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .template-tab .tab-desc {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
    }

    .template-tab.active .tab-label {
      color: var(--gold-primary);
    }

    .template-preview-container {
      background: #888;
      height: 500px;
      overflow: hidden;
    }

    .template-preview-frame {
      width: 100%;
      height: 100%;
    }

    .template-preview-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #f4f4f4;
    }

    @media (max-width: 768px) {
      .template-tabs {
        flex-direction: column;
      }

      .template-tab {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .template-tab .tab-icon {
        margin-bottom: 0;
        font-size: 20px;
      }

      .template-preview-container {
        height: 400px;
      }
    }

    .status-select {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .status-select:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    /* Auth Screens */
    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-deep);
      padding: 20px;
    }

    .auth-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 48px 40px;
      width: 100%;
      max-width: 440px;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-weight: 800;
      font-size: 24px;
      color: var(--dark-primary);
    }

    .auth-header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: var(--text-muted);
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 24px;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
    }

    .auth-message {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .auth-message.visible {
      display: block;
    }

    .auth-message.error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--error);
    }

    .auth-message.success {
      background: rgba(77, 255, 130, 0.1);
      border: 1px solid rgba(77, 255, 130, 0.3);
      color: var(--success);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      color: var(--dark-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .auth-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Signup Steps */
    .signup-step {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .step-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .step-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
    }

    .step-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 16px;
      transition: color 0.2s;
    }

    .step-back:hover {
      color: var(--gold-primary);
    }

    .step-back svg {
      color: inherit;
    }

    /* Account Type Cards */
    .account-type-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .account-type-card {
      position: relative;
      background: var(--dark-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .account-type-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .account-type-card.selected {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .account-type-card.selected::before {
      content: '';
      position: absolute;
      top: 12px;
      right: 70px;
      width: 24px;
      height: 24px;
      background: var(--gold-primary);
      border-radius: 50%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%231a1a2e'%3E%3Cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-size: 16px;
      background-position: center;
      background-repeat: no-repeat;
    }

    .type-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .type-icon svg {
      width: 28px;
      height: 28px;
      color: var(--text-secondary);
    }

    .type-icon.pro {
      background: rgba(249, 203, 0, 0.1);
    }

    .type-icon.pro svg {
      color: var(--gold-primary);
    }

    .type-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .type-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .type-features {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .type-features li {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .type-features .check-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--success);
    }

    .type-features .check-icon.gold {
      color: var(--gold-primary);
    }

    .type-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-badge.free {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .type-badge.pro {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
    }

    /* Signup Terms */
    .signup-terms {
      margin-bottom: 20px;
    }

    .checkbox-label {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 2px;
      accent-color: var(--gold-primary);
      flex-shrink: 0;
    }

    .checkbox-label a {
      color: var(--gold-primary);
      text-decoration: none;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    /* Pro Note */
    .pro-note {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: rgba(249, 203, 0, 0.1);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .pro-note svg {
      color: var(--gold-primary);
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* Responsive adjustments */
    @media (min-width: 600px) {
      .account-type-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .account-type-card {
        padding: 24px 20px;
      }
    }

    /* Loading */
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Product Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .product-image {
      height: 180px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .product-placeholder svg {
      width: 48px;
      height: 48px;
    }

    .product-info {
      padding: 16px;
    }

    .product-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .product-status.status-active {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .product-status.status-draft {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .product-status.status-sold {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .product-category {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .product-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold-primary);
    }

    .product-dims {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .product-actions {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.02);
    }

    /* Wallet Balance Cards */
    .wallet-balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .balance-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .balance-card.available::before {
      background: linear-gradient(90deg, var(--success), #2dd4bf);
    }

    .balance-card.pending::before {
      background: linear-gradient(90deg, var(--warning), #fb923c);
    }

    .balance-card.total::before {
      background: linear-gradient(90deg, var(--gold-primary), var(--gold-dark));
    }

    .balance-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .balance-card.available .balance-amount {
      color: var(--success);
    }

    .balance-card.pending .balance-amount {
      color: var(--warning);
    }

    .balance-card.total .balance-amount {
      color: var(--gold-primary);
    }

    .balance-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .transaction-row:last-child {
      border-bottom: none;
    }

    .transaction-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .transaction-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .transaction-icon.income {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .transaction-icon.payout {
      background: rgba(77, 166, 255, 0.15);
      color: var(--info);
    }

    .transaction-icon.fee {
      background: rgba(255, 107, 107, 0.15);
      color: var(--error);
    }

    .transaction-details h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .transaction-details p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-amount {
      text-align: right;
    }

    .transaction-amount .amount {
      font-size: 16px;
      font-weight: 600;
    }

    .transaction-amount .amount.positive {
      color: var(--success);
    }

    .transaction-amount .amount.negative {
      color: var(--error);
    }

    .transaction-amount .date {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Fees Grid */
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .fee-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
    }

    .fee-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .fee-header svg {
      color: var(--gold-primary);
    }

    .fee-rate {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .fee-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .fee-note {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: rgba(249, 203, 0, 0.05);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .fee-note svg {
      flex-shrink: 0;
      color: var(--gold-primary);
      margin-top: 2px;
    }

    .fee-note strong {
      color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 1024px) {
      :root {
        --unified-nav-height: 64px; /* Match unified-nav mobile height */
      }

      .sidebar {
        transform: translateX(-100%);
        top: var(--unified-nav-height);
        width: var(--sidebar-width); /* Always full width on mobile */
      }

      .sidebar.open {
        transform: translateX(0);
      }

      /* Disable collapsed state on mobile */
      .sidebar.collapsed {
        width: var(--sidebar-width);
      }

      .sidebar.collapsed .sidebar-logo-text,
      .sidebar.collapsed .sidebar-logo-sub,
      .sidebar.collapsed .nav-section-title,
      .sidebar.collapsed .nav-item-text,
      .sidebar.collapsed .user-info,
      .sidebar.collapsed .logout-btn {
        display: block;
        opacity: 1;
        height: auto;
      }

      .sidebar.collapsed .nav-item {
        justify-content: flex-start;
        padding: 12px 16px;
      }

      .sidebar.collapsed .nav-badge {
        position: static;
        min-width: 20px;
        padding: 3px 10px;
        font-size: 11px;
      }

      /* Hide the collapse toggle on mobile */
      .sidebar-toggle {
        display: none;
      }

      .main-content {
        margin-left: 0;
      }

      body.sidebar-collapsed .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: block;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: var(--unified-nav-height);
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .sidebar-overlay.active {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .content-area {
        padding: 20px;
      }

      .topbar {
        padding: 16px 20px;
      }

      .auth-card {
        padding: 32px 24px;
      }

      th, td {
        padding: 12px 16px;
      }
    }

    /* ============================================
       LISTINGS GRID & CARDS
       ============================================ */
    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .listing-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .listing-image {
      position: relative;
      width: 100%;
      height: 160px;
      background: var(--dark-surface);
    }

    .listing-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .listing-status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .listing-status-badge.active {
      background: rgba(77, 255, 130, 0.2);
      color: var(--success);
    }

    .listing-status-badge.sold {
      background: rgba(255, 71, 87, 0.2);
      color: var(--error);
    }

    .listing-status-badge.expired {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .listing-content {
      padding: 16px;
    }

    .listing-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .listing-stone {
      font-size: 12px;
      color: var(--gold-primary);
      margin-bottom: 10px;
    }

    .listing-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .listing-meta-item {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .listing-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-primary);
      margin-bottom: 12px;
    }

    .listing-price.contact {
      font-size: 13px;
      color: var(--text-muted);
    }

    .listing-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .listing-actions {
      display: flex;
      gap: 8px;
    }

    .listing-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .listing-actions .btn-edit {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
    }

    .listing-actions .btn-edit:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .listing-actions .btn-delete {
      background: transparent;
      border: 1px solid var(--error);
      color: var(--error);
    }

    .listing-actions .btn-delete:hover {
      background: rgba(255, 71, 87, 0.1);
    }

    /* Listing Category Grid */
    .listing-category-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 8px;
    }

    @media (max-width: 600px) {
      .listing-category-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .listing-category-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
      background: var(--dark-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      gap: 6px;
    }

    .listing-category-option:hover {
      border-color: var(--text-muted);
      background: var(--dark-surface);
    }

    .listing-category-option.selected {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.1);
    }

    .listing-category-option svg {
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .listing-category-option.selected svg {
      color: var(--gold-primary);
    }

    .listing-category-option span {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .listing-category-option small {
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.2;
    }

    .listing-category-option.selected span {
      color: var(--gold-primary);
    }

    /* Category badge on listing cards */
    .listing-category-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.7);
      color: var(--text-primary);
      backdrop-filter: blur(4px);
    }

    .listing-category-badge.countertops { color: #60a5fa; }
    .listing-category-badge.tile { color: #f472b6; }
    .listing-category-badge.flooring { color: #4ade80; }
    .listing-category-badge.cabinets { color: #fb923c; }
    .listing-category-badge.supplies { color: #a78bfa; }
    .listing-category-badge.other { color: #94a3b8; }

    /* Inquiry Items */
    .inquiry-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: background 0.2s;
    }

    .inquiry-item.unread {
      border-left: 3px solid var(--gold-primary);
    }

    .inquiry-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .inquiry-listing {
      font-size: 13px;
      color: var(--gold-primary);
      margin-bottom: 4px;
    }

    .inquiry-sender {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .inquiry-contact {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .inquiry-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .inquiry-message {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .inquiry-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .inquiry-actions .btn {
      padding: 8px 14px;
      font-size: 12px;
    }

    .inquiry-actions .btn-email {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .inquiry-actions .btn-email:hover {
      background: rgba(59, 130, 246, 0.25);
    }

    .inquiry-actions .btn-payment {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .inquiry-actions .btn-payment:hover {
      background: rgba(16, 185, 129, 0.25);
    }

    /* Payment Request Modal */
    .payment-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .payment-modal-content {
      background: var(--dark-surface);
      border-radius: 16px;
      max-width: 420px;
      width: 100%;
      overflow: hidden;
    }

    .payment-modal-header {
      background: linear-gradient(135deg, var(--dark-primary) 0%, #16213e 100%);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payment-modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .payment-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 24px;
      padding: 4px;
    }

    .payment-modal-body {
      padding: 24px;
    }

    .payment-modal-body .form-group {
      margin-bottom: 16px;
    }

    .payment-modal-body label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .payment-modal-body input,
    .payment-modal-body textarea {
      width: 100%;
      padding: 12px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .payment-modal-body input:focus,
    .payment-modal-body textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    .payment-modal-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
    }

    .payment-modal-info p {
      margin: 0;
      font-size: 12px;
      color: #60a5fa;
    }

    .payment-modal-footer {
      padding: 16px 24px;
      background: var(--dark-elevated);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Create Listing Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      background: var(--dark-surface);
      z-index: 1;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .modal-body {
      padding: 24px;
    }

    .form-section {
      margin-bottom: 24px;
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold-primary);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Stone Autocomplete */
    .stone-autocomplete {
      position: relative;
    }

    .stone-autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .stone-autocomplete-results.active {
      display: block;
    }

    .stone-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .stone-result-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .stone-result-thumb {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
    }

    .stone-result-info {
      flex: 1;
    }

    .stone-result-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .stone-result-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Image Upload Grid */
    .image-upload-section {
      margin-top: 8px;
    }

    .image-upload-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .image-upload-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .image-upload-slot {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      background: var(--dark-elevated);
      border: 2px dashed var(--border-light);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .image-upload-slot:first-child {
      aspect-ratio: 4/3;
    }

    @media (max-width: 600px) {
      .image-upload-slot:first-child {
        grid-column: span 2;
      }
    }

    .image-upload-slot:hover {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .image-upload-slot.has-image {
      border-style: solid;
      border-color: var(--gold-primary);
    }

    .upload-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-muted);
    }

    .upload-placeholder svg {
      color: var(--gold-primary);
      opacity: 0.7;
    }

    .upload-placeholder span {
      font-size: 12px;
      font-weight: 500;
    }

    .upload-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-image-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.95);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      z-index: 10;
    }

    .remove-image-btn:hover {
      background: #ff4747;
      transform: scale(1.1);
    }

    .upload-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(0, 0, 0, 0.5);
    }

    .upload-progress-bar {
      height: 100%;
      background: var(--gold-primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Legacy image preview for backward compatibility */
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .image-preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: var(--dark-elevated);
      border: 1px dashed var(--border-light);
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-item .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.9);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
  </style>
<!-- Unified Navigation -->
<link rel="stylesheet" href="/css/unified-nav.css?v=20260110b">
<script defer src="/js/unified-nav.js?v=20260110d"></script>

</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f9cb00, #cca600); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: #1a1a2e; margin: 0 auto 16px;">SG</div>
      <h1 style="color: #f9cb00; font-size: 24px; font-weight: 700; margin: 0;">Surprise Granite</h1>
      <p style="color: rgba(255,255,255,0.75); font-size: 14px; margin: 4px 0 0;">Client Portal</p>
    </div>
    <div class="spinner"></div>
    <p style="color: rgba(255,255,255,0.75);">Loading your account...</p>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen" style="display: none;">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">SG</div>
        <h1 id="auth-title">Welcome Back</h1>
        <p id="auth-subtitle">Sign in to access your account</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showAuthTab('signup')">Create Account</button>
      </div>

      <div id="auth-message" class="auth-message"></div>

      <!-- Login Form -->
      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required placeholder="you@example.com"/>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required placeholder="Enter your password"/>
        </div>
        <button type="submit" class="auth-submit" id="login-btn">Sign In</button>
      </form>

      <!-- Signup Form -->
      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <!-- Step 1: Account Type Selection -->
        <div class="signup-step" id="signup-step-1">
          <div class="step-header">
            <h3 class="step-title">Choose Your Account Type</h3>
            <p class="step-subtitle">Select the option that best describes you</p>
          </div>

          <div class="account-type-grid">
            <div class="account-type-card" data-type="homeowner" onclick="selectAccountType('homeowner')">
              <div class="type-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
              </div>
              <div class="type-name">Homeowner</div>
              <div class="type-desc">Shopping for countertops, tile, or flooring for your home</div>
              <ul class="type-features">
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Save favorite materials</li>
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Get free estimates</li>
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> List up to 3 remnants</li>
              </ul>
              <div class="type-badge free">Free</div>
            </div>

            <div class="account-type-card" data-type="pro_fabricator" onclick="selectAccountType('pro_fabricator')">
              <div class="type-icon pro">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                </svg>
              </div>
              <div class="type-name">Pro Fabricator</div>
              <div class="type-desc">Countertop fabricators, installers, and stone professionals</div>
              <ul class="type-features">
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> <strong>Unlimited</strong> remnant listings</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Pro verified badge</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Priority in marketplace</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Business profile page</li>
              </ul>
              <div class="type-badge pro">Pro</div>
            </div>

            <div class="account-type-card" data-type="pro_designer" onclick="selectAccountType('pro_designer')">
              <div class="type-icon pro">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402M6.75 21A3.75 3.75 0 013 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 003.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008z"/>
                </svg>
              </div>
              <div class="type-name">Designer / Architect</div>
              <div class="type-desc">Interior designers, architects, and design professionals</div>
              <ul class="type-features">
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Create client mood boards</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Trade pricing access</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Designer verified badge</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Project management tools</li>
              </ul>
              <div class="type-badge pro">Pro</div>
            </div>
          </div>

          <input type="hidden" id="signup-account-type" value="homeowner"/>
          <button type="button" class="auth-submit" id="continue-to-details" onclick="goToSignupStep(2)">Continue</button>
        </div>

        <!-- Step 2: Account Details -->
        <div class="signup-step" id="signup-step-2" style="display: none;">
          <div class="step-header">
            <button type="button" class="step-back" onclick="goToSignupStep(1)">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
              Back
            </button>
            <h3 class="step-title">Create Your Account</h3>
            <p class="step-subtitle" id="selected-type-label">Homeowner Account</p>
          </div>

          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="signup-name" required placeholder="John Smith"/>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="signup-email" required placeholder="you@example.com"/>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="signup-password" required minlength="6" placeholder="At least 6 characters"/>
          </div>
          <div class="form-group">
            <label>Phone (Optional)</label>
            <input type="tel" id="signup-phone" placeholder="(555) 123-4567"/>
          </div>

          <!-- Pro account fields -->
          <div id="pro-fields" style="display: none;">
            <div class="form-group">
              <label>Business Name</label>
              <input type="text" id="signup-business-name" placeholder="Your Company Name"/>
            </div>
            <div class="form-group">
              <label>Business Location</label>
              <input type="text" id="signup-business-location" placeholder="City, State"/>
            </div>
          </div>

          <div class="signup-terms">
            <label class="checkbox-label">
              <input type="checkbox" id="signup-terms" required/>
              <span>I agree to the <a href="/terms/" target="_blank">Terms of Service</a> and <a href="/privacy/" target="_blank">Privacy Policy</a></span>
            </label>
          </div>

          <button type="submit" class="auth-submit" id="signup-btn">Create Account</button>

          <div class="pro-note" id="pro-upgrade-note" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Pro accounts require verification. You'll receive an email to complete your business verification.</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-app" style="display: none;">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <!-- Toggle Button -->
      <button class="sidebar-toggle" onclick="toggleSidebarCollapse()" title="Toggle Sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      </button>

      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub">Account</div>
          </div>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Menu</div>
          <a class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="nav-item-text">Dashboard</span>
          </a>
          <a class="nav-item" data-page="profile" onclick="showPage('profile')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <span class="nav-item-text">My Profile</span>
          </a>
          <a class="nav-item" data-page="favorites" onclick="showPage('favorites')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            <span class="nav-item-text">Favorites</span>
            <span class="nav-badge" id="favorites-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="listings" onclick="showPage('listings')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            <span class="nav-item-text">My Listings</span>
            <span class="nav-badge" id="listings-count" data-count="0">0</span>
          </a>
        </div>

        <div class="nav-section" id="admin-nav" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a class="nav-item" data-page="leads" onclick="showPage('leads')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            <span class="nav-item-text">Leads</span>
            <span class="nav-badge" id="leads-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="invoices" onclick="showPage('invoices')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span class="nav-item-text">Invoices</span>
          </a>
          <a class="nav-item" data-page="wallet" onclick="showPage('wallet')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
            <span class="nav-item-text">Wallet</span>
          </a>
          <a class="nav-item" data-page="admin-users" onclick="showPage('admin-users')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span class="nav-item-text">Manage Admins</span>
          </a>
        </div>

        <div class="nav-section" id="vendor-nav" style="display: none;">
          <div class="nav-section-title">Store</div>
          <a class="nav-item" data-page="products" onclick="showPage('products')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <span class="nav-item-text">Products</span>
          </a>
          <a class="nav-item" data-page="orders" onclick="showPage('orders')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            <span class="nav-item-text">Orders</span>
          </a>
          <a class="nav-item" data-page="messages" onclick="showPage('messages')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            <span class="nav-item-text">Messages</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Quick Links</div>
          <a class="nav-item" href="/" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            <span class="nav-item-text">View Website</span>
          </a>
          <a class="nav-item" href="/get-a-free-estimate/">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Get Estimate</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-menu">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">User</div>
            <div class="user-role" id="user-role">Member</div>
          </div>
          <button class="logout-btn" onclick="handleLogout()" title="Sign Out">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="topbar">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <h1 class="topbar-title" id="page-title">Dashboard</h1>
        <div class="topbar-actions">
          <a href="/get-a-free-estimate/" class="btn btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Get Quote
          </a>
        </div>
      </div>

      <div class="content-area">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page-section active">
          <div class="stats-grid" id="dashboard-stats">
            <!-- Filled by JS based on role -->
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="quick-actions" id="quick-actions">
                <!-- Filled by JS based on role -->
              </div>
            </div>
          </div>
        </section>

        <!-- Profile Page -->
        <section id="page-profile" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Profile Information</h3>
              <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
            <div class="card-body">
              <form id="profile-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profile-name" placeholder="Your name"/>
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profile-email" readonly style="opacity: 0.6;"/>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="profile-phone" placeholder="(555) 123-4567"/>
                  </div>
                  <div class="form-group">
                    <label>Company (Optional)</label>
                    <input type="text" id="profile-company" placeholder="Your company"/>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- Favorites Page -->
        <section id="page-favorites" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Your Favorites</h3>
              <button class="btn btn-primary" onclick="requestQuoteForFavorites()" id="request-quote-btn" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Request Quote
              </button>
            </div>
            <div class="card-body">
              <p style="color: #666; margin-bottom: 20px;">Browse materials on your phone and swipe right to save your favorites. They'll appear here!</p>

              <div id="favorites-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your favorites...</p>
              </div>

              <div id="favorites-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <h3 style="color: #666; margin: 16px 0 8px;">No Favorites Yet</h3>
                <p style="color: #999; margin-bottom: 20px;">Browse our collections on your phone and swipe right to save your favorites!</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                  <a href="/materials/flooring/" class="btn btn-primary">Browse Flooring</a>
                  <a href="/materials/all-countertops/" class="btn btn-secondary">Browse Countertops</a>
                </div>
              </div>

              <!-- Countertops Section -->
              <div id="favorites-countertops" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
                  Countertops
                  <span id="countertops-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-countertops-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Flooring Section -->
              <div id="favorites-flooring" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                  Flooring
                  <span id="flooring-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-flooring-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Tile Section -->
              <div id="favorites-tile" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><path d="M3 3h7v7H3z M14 3h7v7h-7z M3 14h7v7H3z M14 14h7v7h-7z"/></svg>
                  Tile
                  <span id="tile-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-tile-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Shop Section -->
              <div id="favorites-shop" style="display: none;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                  Shop Products
                  <span id="shop-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-shop-grid" class="saved-floors-grid"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- My Listings Page (Remnants Marketplace) -->
        <section id="page-listings" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Listings</h3>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span id="listing-limit-indicator" style="font-size: 13px; color: var(--text-muted);"></span>
                <button class="btn btn-primary" onclick="openCreateListingModal()" id="create-listing-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Listing
                </button>
              </div>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">
                List your stone remnants here. Other users can find and contact you about materials you have available.
                <a href="/remnants/" style="color: var(--gold-primary);">Browse the marketplace </a>
              </p>

              <div id="listings-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your listings...</p>
              </div>

              <div id="listings-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <h3 style="color: var(--text-secondary); margin: 16px 0 8px;">No Listings Yet</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Have materials to sell? List countertops, tile, flooring, cabinets, or supplies!</p>
                <button class="btn btn-primary" onclick="openCreateListingModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Your First Listing
                </button>
              </div>

              <div id="listings-grid" class="listings-grid" style="display: none;"></div>
            </div>
          </div>

          <!-- Inquiries Section -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Incoming Inquiries</h3>
              <span class="nav-badge" id="inquiries-badge" style="display: none;">0</span>
            </div>
            <div class="card-body">
              <div id="inquiries-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading inquiries...</p>
              </div>
              <div id="inquiries-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                <h3 style="color: var(--text-secondary); margin: 16px 0 8px;">No Inquiries Yet</h3>
                <p style="color: var(--text-muted); margin-bottom: 0;">When someone contacts you about a listing, it will appear here.</p>
              </div>
              <div id="inquiries-list" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- Leads Page (Admin Only) -->
        <section id="page-leads" class="page-section">
          <div class="table-container">
            <div class="table-header">
              <h2 class="table-title">All Leads</h2>
              <div class="table-filters">
                <button class="filter-btn active" data-status="all">All</button>
                <button class="filter-btn" data-status="new">New</button>
                <button class="filter-btn" data-status="contacted">Contacted</button>
                <button class="filter-btn" data-status="qualified">Qualified</button>
                <button class="filter-btn" data-status="won">Won</button>
              </div>
              <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="leads-search" placeholder="Search leads...">
              </div>
            </div>
            <div id="leads-table">
              <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading leads...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Invoices Page (Admin Only) -->
        <section id="page-invoices" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Invoices</h3>
              <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="openTemplatePreview()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                  Email Templates
                </button>
                <button class="btn btn-primary" onclick="openInvoiceModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Invoice
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-invoice-status="all" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn" data-invoice-status="draft" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn" data-invoice-status="open" onclick="filterInvoices('open')">Open</button>
                <button class="filter-btn" data-invoice-status="paid" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn" data-invoice-status="void" onclick="filterInvoices('void')">Voided</button>
              </div>
              <div id="invoices-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Wallet Page (Admin Only) -->
        <section id="page-wallet" class="page-section">
          <!-- Balance Cards -->
          <div class="wallet-balance-grid">
            <div class="balance-card available">
              <div class="balance-label">Available Balance</div>
              <div class="balance-amount" id="available-balance">$0.00</div>
              <div class="balance-sub">Ready to withdraw</div>
            </div>
            <div class="balance-card pending">
              <div class="balance-label">Pending Balance</div>
              <div class="balance-amount" id="pending-balance">$0.00</div>
              <div class="balance-sub">Processing payments</div>
            </div>
            <div class="balance-card total">
              <div class="balance-label">Total Revenue</div>
              <div class="balance-amount" id="total-revenue">$0.00</div>
              <div class="balance-sub">All time</div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body" style="display: flex; gap: 12px; flex-wrap: wrap;">
              <a href="https://dashboard.stripe.com" target="_blank" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                Open Stripe Dashboard
              </a>
              <button class="btn btn-secondary" onclick="loadWalletData()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
            </div>
          </div>

          <!-- Recent Transactions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Transactions</h3>
            </div>
            <div class="card-body">
              <div id="transactions-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Recent Payouts -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Payouts to Your Bank</h3>
            </div>
            <div class="card-body">
              <div id="payouts-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Fees & Rates Disclosure -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Processing Fees & Rates</h3>
            </div>
            <div class="card-body">
              <div class="fees-grid">
                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    <span>Credit/Debit Cards</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">Per successful transaction</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span>Invoices (Card Payment)</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">When customer pays by card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
                    <span>ACH Bank Transfer</span>
                  </div>
                  <div class="fee-rate">0.8% (max $5)</div>
                  <div class="fee-desc">Direct bank payments</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>Payouts to Bank</span>
                  </div>
                  <div class="fee-rate">Free</div>
                  <div class="fee-desc">Standard 2-day transfer</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span>Instant Payouts</span>
                  </div>
                  <div class="fee-rate">1.5% (min $0.50)</div>
                  <div class="fee-desc">Funds in minutes to debit card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Vendor Payouts</span>
                  </div>
                  <div class="fee-rate">0.25% + $0.25</div>
                  <div class="fee-desc">Per transfer to vendor accounts</div>
                </div>
              </div>

              <div class="fee-note">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div>
                  <strong>How Vendor Payouts Work:</strong>
                  All customer payments are collected through Surprise Granite's Stripe account. Vendors receive payouts after their sales are processed, minus applicable platform and processing fees. Payouts are processed weekly or upon request.
                </div>
              </div>

              <div class="fee-note" style="margin-top: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                <div>
                  <strong>Secure Payments:</strong>
                  All transactions are processed securely through Stripe. We never store credit card numbers on our servers.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin Users Page -->
        <section id="page-admin-users" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Manage Admin Users</h3>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">Add or remove admin access for users. Super admins (joshb@surprisegranite.com, info@surprisegranite.com) always have access.</p>
              <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <input type="email" id="new-admin-email" placeholder="Enter email address" style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <button class="btn btn-primary" onclick="addAdminUser()">Add Admin</button>
              </div>
              <div id="admin-users-list">
                <div class="spinner" style="margin: 20px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Products Page -->
        <section id="page-products" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Products</h3>
              <button class="btn btn-primary" onclick="openProductModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Add Product
              </button>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-product-status="all" onclick="filterProducts('all')">All</button>
                <button class="filter-btn" data-product-status="active" onclick="filterProducts('active')">Active</button>
                <button class="filter-btn" data-product-status="draft" onclick="filterProducts('draft')">Draft</button>
                <button class="filter-btn" data-product-status="sold" onclick="filterProducts('sold')">Sold</button>
              </div>
              <div id="products-grid" class="products-grid">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Orders Page (Coming Soon) -->
        <section id="page-orders" class="page-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            </div>
            <h2>Order Management Coming Soon</h2>
            <p>Track and manage customer orders, quotes, and project timelines all in one place.</p>
          </div>
        </section>

        <!-- Messages Page (Coming Soon) -->
        <section id="page-messages" class="page-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            </div>
            <h2>Messaging Coming Soon</h2>
            <p>Stay connected with customers, vendors, and the Surprise Granite team through our upcoming messaging feature.</p>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Lead Detail Modal -->
  <div class="modal-overlay" id="lead-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Lead Details</h2>
        <button class="modal-close" onclick="closeLeadModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="lead-details"></div>
      <div class="modal-footer">
        <select class="status-select" id="lead-status-select">
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="quoted">Quoted</option>
          <option value="won">Won</option>
          <option value="lost">Lost</option>
        </select>
        <button class="btn btn-secondary" onclick="closeLeadModal()">Close</button>
        <button class="btn btn-primary" onclick="updateLeadStatus()">Update Status</button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal-overlay" id="product-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="product-modal-title">Add New Product</h2>
        <button class="modal-close" onclick="closeProductModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="product-form" onsubmit="saveProduct(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="product-name" required placeholder="e.g., Calacatta Gold Marble Slab"/>
            </div>
            <div class="form-group">
              <label>Category</label>
              <select id="product-category">
                <option value="">Select Category</option>
                <option value="granite">Granite</option>
                <option value="marble">Marble</option>
                <option value="quartz">Quartz</option>
                <option value="quartzite">Quartzite</option>
                <option value="porcelain">Porcelain</option>
                <option value="soapstone">Soapstone</option>
                <option value="remnant">Remnant</option>
                <option value="tile">Tile</option>
                <option value="sink">Sink</option>
                <option value="faucet">Faucet</option>
                <option value="accessory">Accessory</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="product-description" rows="3" placeholder="Describe your product..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price ($) *</label>
              <input type="number" id="product-price" required min="0" step="0.01" placeholder="0.00"/>
            </div>
            <div class="form-group">
              <label>Dimensions</label>
              <input type="text" id="product-dimensions" placeholder='e.g., 120" x 60" x 3cm'/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Material Type</label>
              <input type="text" id="product-material" placeholder="e.g., Natural Stone"/>
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="text" id="product-color" placeholder="e.g., White with Gold Veining"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Stock Quantity</label>
              <input type="number" id="product-stock" min="0" value="1" placeholder="1"/>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="product-status">
                <option value="draft">Draft (Not Listed)</option>
                <option value="active">Active (Listed for Sale)</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="product-image-url" placeholder="https://example.com/image.jpg"/>
            <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
              Paste a direct link to your product image. Tip: Upload images to Imgur or similar service.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="product-save-btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal-overlay" id="invoice-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Invoice</h2>
        <button class="modal-close" onclick="closeInvoiceModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="invoice-form" onsubmit="createInvoice(event)">
        <div class="modal-body">
          <h4 style="margin-bottom: 16px; color: var(--text-secondary);">Customer Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Customer Email *</label>
              <input type="email" id="invoice-email" required placeholder="customer@example.com"/>
            </div>
            <div class="form-group">
              <label>Customer Name</label>
              <input type="text" id="invoice-name" placeholder="John Smith"/>
            </div>
          </div>
          <div class="form-group">
            <label>Customer Phone</label>
            <input type="tel" id="invoice-phone" placeholder="(555) 123-4567"/>
          </div>

          <h4 style="margin: 24px 0 16px; color: var(--text-secondary);">Invoice Items</h4>
          <div id="invoice-items">
            <div class="invoice-item" data-index="0">
              <div class="form-row" style="align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                  <label>Description *</label>
                  <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Qty</label>
                  <input type="number" class="item-qty" value="1" min="1"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Amount ($) *</label>
                  <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00"/>
                </div>
                <button type="button" class="btn btn-secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
          <button type="button" class="btn btn-secondary" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Line Item
          </button>

          <div class="form-row">
            <div class="form-group">
              <label>Due In (Days)</label>
              <select id="invoice-due-days">
                <option value="7">7 days</option>
                <option value="14">14 days</option>
                <option value="30" selected>30 days</option>
                <option value="60">60 days</option>
              </select>
            </div>
            <div class="form-group">
              <label>Invoice Total</label>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary); padding: 10px 0;" id="invoice-total">$0.00</div>
            </div>
          </div>

          <div class="form-group">
            <label>Email Template</label>
            <div class="template-selector">
              <label class="template-option">
                <input type="radio" name="invoice-template" value="classic" checked>
                <div class="template-preview classic-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Classic</span>
                  <span class="template-desc">Professional & Clean</span>
                </div>
              </label>
              <label class="template-option">
                <input type="radio" name="invoice-template" value="modern">
                <div class="template-preview modern-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Modern</span>
                  <span class="template-desc">Minimal & Elegant</span>
                </div>
              </label>
              <label class="template-option">
                <input type="radio" name="invoice-template" value="premium">
                <div class="template-preview premium-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Premium</span>
                  <span class="template-desc">Luxury Dark Theme</span>
                </div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea id="invoice-notes" rows="2" placeholder="Add any additional notes for the customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeInvoiceModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" id="invoice-send-btn">Create & Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Template Preview Modal -->
  <div class="modal-overlay" id="template-preview-modal">
    <div class="modal" style="max-width: 1200px; max-height: 90vh;">
      <div class="modal-header">
        <h2 class="modal-title">Invoice Email Templates</h2>
        <button class="modal-close" onclick="closeTemplatePreview()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="padding: 0; overflow: hidden;">
        <div class="template-tabs">
          <button class="template-tab active" data-template="classic" onclick="showTemplatePreview('classic')">
            <span class="tab-icon"></span>
            <span class="tab-label">Classic</span>
            <span class="tab-desc">Professional & Clean</span>
          </button>
          <button class="template-tab" data-template="modern" onclick="showTemplatePreview('modern')">
            <span class="tab-icon"></span>
            <span class="tab-label">Modern</span>
            <span class="tab-desc">Minimal & Elegant</span>
          </button>
          <button class="template-tab" data-template="premium" onclick="showTemplatePreview('premium')">
            <span class="tab-icon"></span>
            <span class="tab-label">Premium</span>
            <span class="tab-desc">Luxury Dark Theme</span>
          </button>
        </div>
        <div class="template-preview-container">
          <div class="template-preview-frame" id="template-frame-classic" style="display: block;">
            <iframe id="preview-iframe-classic" srcdoc=""></iframe>
          </div>
          <div class="template-preview-frame" id="template-frame-modern" style="display: none;">
            <iframe id="preview-iframe-modern" srcdoc=""></iframe>
          </div>
          <div class="template-preview-frame" id="template-frame-premium" style="display: none;">
            <iframe id="preview-iframe-premium" srcdoc=""></iframe>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <p style="color: var(--text-muted); font-size: 13px; margin: 0;">Select a template when creating an invoice</p>
        <button class="btn btn-primary" onclick="closeTemplatePreview(); openInvoiceModal();">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Create New Invoice
        </button>
      </div>
    </div>
  </div>

  <!-- Create Listing Modal -->
  <div id="create-listing-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateListingModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Listing</h2>
        <button class="modal-close" onclick="closeCreateListingModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="create-listing-form" onsubmit="return handleCreateListing(event)">
          <!-- Category Selection -->
          <div class="form-section">
            <div class="form-section-title">What are you listing?</div>
            <div class="listing-category-grid" id="listing-category-grid">
              <div class="listing-category-option selected" data-category="countertops" onclick="selectListingCategory('countertops')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M5 12v6M19 12v6M8 8V5a1 1 0 011-1h6a1 1 0 011 1v3"/></svg>
                <span>Countertops</span>
                <small>Granite, Marble, Quartz</small>
              </div>
              <div class="listing-category-option" data-category="tile" onclick="selectListingCategory('tile')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="3" width="8" height="8" rx="1"/><rect x="3" y="13" width="8" height="8" rx="1"/><rect x="13" y="13" width="8" height="8" rx="1"/></svg>
                <span>Tile</span>
                <small>Ceramic, Porcelain, Natural</small>
              </div>
              <div class="listing-category-option" data-category="flooring" onclick="selectListingCategory('flooring')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M3 21h18M3 21V8l4-4h10l4 4v13M7 21v-8h10v8M7 13h10"/></svg>
                <span>Flooring</span>
                <small>Hardwood, LVP, Laminate</small>
              </div>
              <div class="listing-category-option" data-category="cabinets" onclick="selectListingCategory('cabinets')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="3" y1="12" x2="21" y2="12"/><circle cx="8" cy="8" r="1"/><circle cx="16" cy="8" r="1"/><circle cx="8" cy="16" r="1"/><circle cx="16" cy="16" r="1"/></svg>
                <span>Cabinets</span>
                <small>Kitchen, Bath, Storage</small>
              </div>
              <div class="listing-category-option" data-category="supplies" onclick="selectListingCategory('supplies')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <span>Supplies</span>
                <small>Tools, Adhesives, Sealers</small>
              </div>
              <div class="listing-category-option" data-category="other" onclick="selectListingCategory('other')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 8v4M12 16h.01"/></svg>
                <span>Other</span>
                <small>Fixtures, Hardware, etc.</small>
              </div>
            </div>
            <input type="hidden" id="listing-category" value="countertops">
          </div>

          <!-- Product Selection (dynamic based on category) -->
          <div class="form-section" id="product-selection-section">
            <div class="form-section-title" id="product-selection-title">Select Product</div>
            <div class="form-group stone-autocomplete">
              <label id="product-search-label">Search our catalog (optional)</label>
              <input type="text" id="listing-stone-search" placeholder="Start typing product name..." autocomplete="off">
              <div id="stone-autocomplete-results" class="stone-autocomplete-results"></div>
              <input type="hidden" id="listing-stone-slug">
              <input type="hidden" id="listing-stone-name">
              <input type="hidden" id="listing-material-type">
              <input type="hidden" id="listing-brand">
              <input type="hidden" id="listing-color">
            </div>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Link to our catalog so buyers can see the full product details, or skip to create a custom listing.</p>
            <div id="selected-stone-preview" style="display: none; margin-top: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <img id="selected-stone-img" src="" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">
                <div>
                  <div id="selected-stone-name" style="font-weight: 600; color: var(--text-primary);"></div>
                  <div id="selected-stone-meta" style="font-size: 12px; color: var(--text-muted);"></div>
                </div>
                <button type="button" onclick="clearSelectedStone()" style="margin-left: auto; background: none; border: none; color: var(--error); cursor: pointer;">Clear</button>
              </div>
            </div>
          </div>

          <!-- Listing Details -->
          <div class="form-section">
            <div class="form-section-title">Listing Details</div>
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="listing-title" placeholder="e.g., Calacatta Gold Remnant 24x36, White Subway Tile 200 sqft" required>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="listing-description" rows="3" placeholder="Describe your item - condition, origin, why selling, any defects, etc."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Condition</label>
                <select id="listing-condition">
                  <option value="new">New / Unused</option>
                  <option value="remnant">Remnant / Leftover</option>
                  <option value="overstock">Overstock</option>
                  <option value="used">Used / Reclaimed</option>
                  <option value="refurbished">Refurbished</option>
                </select>
              </div>
              <div class="form-group">
                <label>Brand (optional)</label>
                <input type="text" id="listing-brand-input" placeholder="e.g., MSI, Daltile, Shaw">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Dimensions / Size</label>
                <input type="text" id="listing-dimensions" placeholder="e.g., 24x36 in, 200 sqft, 10x20 cm">
              </div>
              <div class="form-group" id="thickness-group">
                <label>Thickness</label>
                <select id="listing-thickness">
                  <option value="">Select...</option>
                  <option value="2cm">2cm (3/4")</option>
                  <option value="3cm">3cm (1 1/4")</option>
                  <option value="1cm">1cm (3/8")</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="listing-quantity" value="1" min="1">
              </div>
              <div class="form-group">
                <label>Price ($)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" id="listing-price" placeholder="0.00" step="0.01" min="0" style="flex: 1;">
                  <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; white-space: nowrap;">
                    <input type="checkbox" id="listing-price-contact" onchange="togglePriceField()">
                    Contact for price
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="form-section">
            <div class="form-section-title">Images (up to 4)</div>

            <!-- Image Upload Area -->
            <div class="image-upload-section">
              <div class="image-upload-grid" id="image-upload-grid">
                <!-- Image Slot 1 -->
                <div class="image-upload-slot" id="image-slot-1" onclick="triggerImageUpload(1)">
                  <input type="file" id="image-file-1" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(1, this)">
                  <input type="hidden" id="listing-image-1">
                  <div class="upload-placeholder" id="upload-placeholder-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Add Photo</span>
                  </div>
                  <img id="image-preview-1" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-1" onclick="removeImage(event, 1)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-1" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-1"></div>
                  </div>
                </div>

                <!-- Image Slot 2 -->
                <div class="image-upload-slot" id="image-slot-2" onclick="triggerImageUpload(2)">
                  <input type="file" id="image-file-2" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(2, this)">
                  <input type="hidden" id="listing-image-2">
                  <div class="upload-placeholder" id="upload-placeholder-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-2" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-2" onclick="removeImage(event, 2)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-2" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-2"></div>
                  </div>
                </div>

                <!-- Image Slot 3 -->
                <div class="image-upload-slot" id="image-slot-3" onclick="triggerImageUpload(3)">
                  <input type="file" id="image-file-3" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(3, this)">
                  <input type="hidden" id="listing-image-3">
                  <div class="upload-placeholder" id="upload-placeholder-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-3" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-3" onclick="removeImage(event, 3)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-3" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-3"></div>
                  </div>
                </div>

                <!-- Image Slot 4 -->
                <div class="image-upload-slot" id="image-slot-4" onclick="triggerImageUpload(4)">
                  <input type="file" id="image-file-4" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(4, this)">
                  <input type="hidden" id="listing-image-4">
                  <div class="upload-placeholder" id="upload-placeholder-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-4" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-4" onclick="removeImage(event, 4)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-4" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-4"></div>
                  </div>
                </div>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; text-align: center;">
                Tap to take a photo or upload from your gallery. First image will be the main photo.
              </p>
            </div>
          </div>

          <!-- Location -->
          <div class="form-section">
            <div class="form-section-title">Location</div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="listing-city" placeholder="Phoenix">
              </div>
              <div class="form-group">
                <label>State</label>
                <select id="listing-state">
                  <option value="">Select State...</option>
                  <option value="AZ">Arizona</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="NV">Nevada</option>
                  <option value="NM">New Mexico</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>ZIP Code</label>
              <input type="text" id="listing-zip" placeholder="85374" maxlength="10">
            </div>
          </div>

          <!-- Contact Preferences -->
          <div class="form-section">
            <div class="form-section-title">Contact Preferences</div>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">How should interested buyers contact you?</p>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="listing-show-email">
                Show my email address
              </label>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="listing-show-phone">
                Show my phone number
              </label>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="listing-contact-form" checked>
                Allow contact through inquiry form
              </label>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeCreateListingModal()">Cancel</button>
        <button type="submit" form="create-listing-form" class="btn btn-primary" id="submit-listing-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Request Modal -->
  <div id="payment-request-modal" class="payment-modal" style="display: none;" onclick="if(event.target === this) closePaymentModal()">
    <div class="payment-modal-content">
      <div class="payment-modal-header">
        <h3>Send Payment Request</h3>
        <button class="payment-modal-close" onclick="closePaymentModal()">&times;</button>
      </div>
      <div class="payment-modal-body">
        <div class="payment-modal-info">
          <p><strong>To:</strong> <span id="payment-recipient-name"></span></p>
          <p><strong>Email:</strong> <span id="payment-recipient-email"></span></p>
        </div>
        <form id="payment-request-form" onsubmit="return sendPaymentRequest(event)">
          <input type="hidden" id="payment-inquiry-id">
          <input type="hidden" id="payment-customer-email">
          <input type="hidden" id="payment-customer-name">
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="payment-amount" step="0.01" min="1" required placeholder="500.00">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="payment-description" required placeholder="Stone remnant - Calacatta Gold 24x36">
          </div>
          <div class="form-group">
            <label>Note to Customer (optional)</label>
            <textarea id="payment-note" rows="3" placeholder="Thank you for your interest! Here's the payment link for your purchase..."></textarea>
          </div>
        </form>
      </div>
      <div class="payment-modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancel</button>
        <button type="submit" form="payment-request-form" class="btn btn-primary" id="send-payment-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Send Payment Link
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';

    const SUPER_ADMIN_EMAILS = ['joshb@surprisegranite.com', 'info@surprisegranite.com'];

    let supabaseClient;
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let allLeads = [];
    let currentFilter = 'all';
    let selectedLead = null;

    // Initialize with timeout fallback
    document.addEventListener('DOMContentLoaded', async () => {
      // Fallback timer - show dashboard/auth if things take too long
      const fallbackTimer = setTimeout(() => {
        console.warn('Init timeout - forcing display');
        // Check if we have a cached session indicator
        const hasSession = localStorage.getItem('sb-ypeypgwsycxcagncgdur-auth-token');
        if (hasSession) {
          showDashboard();
        } else {
          showAuth();
        }
      }, 5000);

      try {
        // Wait for Supabase to be available (max 3 seconds)
        let attempts = 0;
        while (!window.supabase && attempts < 30) {
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }

        if (!window.supabase) {
          console.error('Supabase library failed to load after', attempts * 100, 'ms');
          clearTimeout(fallbackTimer);
          showAuth();
          return;
        }

        const { createClient } = window.supabase;
        supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();

        clearTimeout(fallbackTimer);

        if (sessionError) {
          console.error('Session error:', sessionError);
          showAuth();
          return;
        }

        if (session) {
          currentUser = session.user;
          // Load profile but don't block on it
          loadUserProfile().catch(err => console.warn('Profile load failed:', err));
          showDashboard();
        } else {
          showAuth();
        }
      } catch (err) {
        clearTimeout(fallbackTimer);
        console.error('Init error:', err);
        showAuth();
      }
    });

    function showAuth() {
      // Redirect to unified login page instead of showing embedded auth
      window.location.href = '/log-in/?redirect=' + encodeURIComponent(window.location.pathname + window.location.hash);
    }

    function showDashboard() {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-app').style.display = 'block';
      setupDashboard();

      // Initialize sidebar collapsed state from localStorage
      initSidebarState();

      // Update badge visibility (hide zeros)
      updateBadgeVisibility();

      // Handle hash navigation (e.g., /account/#favorites)
      handleHashNavigation();

      // Listen for hash changes
      window.addEventListener('hashchange', handleHashNavigation);
    }

    function handleHashNavigation() {
      const hash = window.location.hash.replace('#', '');
      const validPages = ['favorites', 'profile', 'leads', 'invoices', 'products', 'dashboard', 'wallet', 'orders', 'messages', 'listings', 'admin-users'];
      if (hash && validPages.includes(hash)) {
        showPage(hash);
      }
    }

    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

      document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tab}-form`).classList.add('active');

      document.getElementById('auth-title').textContent = tab === 'login' ? 'Welcome Back' : 'Create Account';
      document.getElementById('auth-subtitle').textContent = tab === 'login' ? 'Sign in to access your account' : 'Join us to get started';
      hideAuthMessage();

      // Reset signup to step 1 when switching tabs
      if (tab === 'signup') {
        goToSignupStep(1);
        selectAccountType('homeowner');
      }
    }

    // Signup step functions
    function selectAccountType(type) {
      // Update hidden input
      document.getElementById('signup-account-type').value = type;

      // Update card selection UI
      document.querySelectorAll('.account-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`.account-type-card[data-type="${type}"]`).classList.add('selected');
    }

    function goToSignupStep(step) {
      const step1 = document.getElementById('signup-step-1');
      const step2 = document.getElementById('signup-step-2');
      const accountType = document.getElementById('signup-account-type').value;

      if (step === 1) {
        step1.style.display = 'block';
        step2.style.display = 'none';
        document.getElementById('auth-title').textContent = 'Create Account';
        document.getElementById('auth-subtitle').textContent = 'Join us to get started';
      } else {
        step1.style.display = 'none';
        step2.style.display = 'block';

        // Update labels based on account type
        const typeLabels = {
          'homeowner': 'Homeowner Account',
          'pro_fabricator': 'Pro Fabricator Account',
          'pro_designer': 'Designer / Architect Account'
        };
        document.getElementById('selected-type-label').textContent = typeLabels[accountType] || 'Your Account';

        // Show/hide pro fields
        const proFields = document.getElementById('pro-fields');
        const proNote = document.getElementById('pro-upgrade-note');
        const isPro = accountType.startsWith('pro_');

        proFields.style.display = isPro ? 'block' : 'none';
        proNote.style.display = isPro ? 'flex' : 'none';

        // Update header for pro accounts
        if (isPro) {
          document.getElementById('auth-title').textContent = 'Pro Account Setup';
          document.getElementById('auth-subtitle').textContent = 'Unlock unlimited features';
        } else {
          document.getElementById('auth-title').textContent = 'Create Account';
          document.getElementById('auth-subtitle').textContent = 'Almost there!';
        }
      }
    }

    // Initialize account type selection on page load
    document.addEventListener('DOMContentLoaded', function() {
      const homeownerCard = document.querySelector('.account-type-card[data-type="homeowner"]');
      if (homeownerCard) {
        homeownerCard.classList.add('selected');
      }
    });

    function showAuthMessage(msg, type) {
      const el = document.getElementById('auth-message');
      el.textContent = msg;
      el.className = `auth-message visible ${type}`;
    }

    function hideAuthMessage() {
      document.getElementById('auth-message').classList.remove('visible');
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();
        showDashboard();
      } catch (err) {
        showAuthMessage(err.message || 'Failed to sign in', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      try {
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const phone = document.getElementById('signup-phone').value;
        const accountType = document.getElementById('signup-account-type').value;
        const businessName = document.getElementById('signup-business-name')?.value || null;
        const businessLocation = document.getElementById('signup-business-location')?.value || null;

        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: name,
              phone,
              account_type: accountType,
              business_name: businessName,
              business_location: businessLocation
            }
          }
        });

        if (error) throw error;

        // Store in sg_users
        await supabaseClient.from('sg_users').insert([{
          id: data.user.id,
          email,
          full_name: name,
          phone: phone || null,
          account_type: accountType,
          business_name: businessName,
          business_location: businessLocation,
          verified: accountType === 'homeowner' // Homeowners auto-verified, pros need verification
        }]);

        // Show success message based on account type
        const isPro = accountType.startsWith('pro_');
        const successMsg = isPro
          ? 'Pro account created! Check your email to verify. Our team will review your business details.'
          : 'Account created! Check your email to verify, then sign in.';

        showAuthMessage(successMsg, 'success');
        showAuthTab('login');
      } catch (err) {
        showAuthMessage(err.message || 'Failed to create account', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return;

      try {
        // Use maybeSingle() to handle missing profiles gracefully
        const { data: profile, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (error) {
          console.warn('Profile query error:', error);
        }

        userProfile = profile;

        const meta = currentUser.user_metadata || {};
        const name = profile?.full_name || meta.full_name || currentUser.email?.split('@')[0] || 'User';
        const accountType = profile?.account_type || 'homeowner';

        // Check admin status
        isSuperAdmin = SUPER_ADMIN_EMAILS.includes((currentUser.email || '').toLowerCase());
        isAdmin = isSuperAdmin || ['admin', 'super_admin'].includes(accountType);

        // Safely update sidebar user info
        const avatarEl = document.getElementById('user-avatar');
        const nameEl = document.getElementById('user-name');
        const roleEl = document.getElementById('user-role');

        if (avatarEl) avatarEl.textContent = name.charAt(0).toUpperCase();
        if (nameEl) nameEl.textContent = name;
        if (roleEl) roleEl.textContent = isSuperAdmin ? 'Super Admin' : (isAdmin ? 'Admin' : (accountType === 'homeowner' ? 'Member' : accountType.replace('pro_', 'Pro ')));

        // Safely update profile form
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const profilePhoneEl = document.getElementById('profile-phone');
        const profileCompanyEl = document.getElementById('profile-company');

        if (profileNameEl) profileNameEl.value = name;
        if (profileEmailEl) profileEmailEl.value = currentUser.email || '';
        if (profilePhoneEl) profilePhoneEl.value = profile?.phone || meta.phone || '';
        if (profileCompanyEl) profileCompanyEl.value = profile?.company_name || '';

        // Show admin nav if admin
        const adminNavEl = document.getElementById('admin-nav');
        if (isAdmin && adminNavEl) {
          adminNavEl.style.display = 'block';
        }

        // Show store/vendor nav for admins and pro accounts
        const vendorNavEl = document.getElementById('vendor-nav');
        if ((isAdmin || accountType.startsWith('pro_')) && vendorNavEl) {
          vendorNavEl.style.display = 'block';
        }

      } catch (err) {
        console.warn('Profile load error:', err);
      }

      // Load favorites count (non-blocking)
      loadFavoritesCount().catch(err => console.warn('Favorites count error:', err));
    }

    // ============ FAVORITES FUNCTIONS ============

    let allFavorites = [];
    let flooringFavorites = [];
    let countertopFavorites = [];

    async function loadFavoritesCount() {
      if (!currentUser) return;

      try {
        const { count } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = count || 0;
          countEl.style.display = count > 0 ? 'inline' : 'none';
        }
      } catch (err) {
        console.warn('Error loading favorites count:', err);
      }
    }

    async function loadFavorites() {
      if (!currentUser) return;

      const loadingEl = document.getElementById('favorites-loading');
      const emptyEl = document.getElementById('favorites-empty');
      const flooringSection = document.getElementById('favorites-flooring');
      const countertopsSection = document.getElementById('favorites-countertops');
      const tileSection = document.getElementById('favorites-tile');
      const shopSection = document.getElementById('favorites-shop');
      const quoteBtn = document.getElementById('request-quote-btn');

      try {
        const { data, error } = await supabaseClient
          .from('user_favorites')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allFavorites = data || [];
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');
        const tileFavorites = allFavorites.filter(f => f.product_type === 'tile');
        const shopFavorites = allFavorites.filter(f => f.product_type === 'shop');

        loadingEl.style.display = 'none';

        if (allFavorites.length === 0) {
          emptyEl.style.display = 'block';
          flooringSection.style.display = 'none';
          countertopsSection.style.display = 'none';
          if (tileSection) tileSection.style.display = 'none';
          if (shopSection) shopSection.style.display = 'none';
          quoteBtn.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          quoteBtn.style.display = 'inline-flex';

          // Show/render countertops section
          if (countertopFavorites.length > 0) {
            countertopsSection.style.display = 'block';
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            countertopsSection.style.display = 'none';
          }

          // Show/render flooring section
          if (flooringFavorites.length > 0) {
            flooringSection.style.display = 'block';
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            flooringSection.style.display = 'none';
          }

          // Show/render tile section
          if (tileFavorites.length > 0 && tileSection) {
            tileSection.style.display = 'block';
            document.getElementById('tile-section-count').textContent = tileFavorites.length;
            renderFavoritesGrid('favorites-tile-grid', tileFavorites);
          } else if (tileSection) {
            tileSection.style.display = 'none';
          }

          // Show/render shop section
          if (shopFavorites.length > 0 && shopSection) {
            shopSection.style.display = 'block';
            document.getElementById('shop-section-count').textContent = shopFavorites.length;
            renderFavoritesGrid('favorites-shop-grid', shopFavorites);
          } else if (shopSection) {
            shopSection.style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

      } catch (err) {
        console.error('Error loading favorites:', err);
        loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading favorites. Please try again.</p>';
      }
    }

    function renderFavoritesGrid(gridId, items) {
      const gridEl = document.getElementById(gridId);
      if (!gridEl) return;

      gridEl.innerHTML = items.map(item => `
        <div class="saved-floor-item" data-id="${item.id}">
          <img class="saved-floor-image" src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}" loading="lazy">
          <div class="saved-floor-content">
            <div class="saved-floor-title">${item.product_title}</div>
            ${item.product_material ? `<div class="saved-floor-material">${item.product_material}</div>` : ''}
            <div class="saved-floor-specs">
              ${item.product_color ? `<span class="saved-floor-spec">${item.product_color}</span>` : ''}
              ${item.product_thickness ? `<span class="saved-floor-spec">${item.product_thickness}</span>` : ''}
              ${item.product_wear_layer ? `<span class="saved-floor-spec">${item.product_wear_layer}</span>` : ''}
            </div>
            <div class="saved-floor-actions">
              <a href="${item.product_url}" class="saved-floor-view" target="_blank">View</a>
              <button class="saved-floor-remove" onclick="removeFavorite('${item.id}', '${item.product_type}')">Remove</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function removeFavorite(id, productType) {
      if (!confirm('Remove this from your favorites?')) return;

      try {
        const { error } = await supabaseClient
          .from('user_favorites')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);

        if (error) throw error;

        // Remove from local arrays
        allFavorites = allFavorites.filter(f => f.id !== id);
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');

        // Re-render the appropriate grid
        if (productType === 'countertop') {
          if (countertopFavorites.length > 0) {
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            document.getElementById('favorites-countertops').style.display = 'none';
          }
        } else {
          if (flooringFavorites.length > 0) {
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            document.getElementById('favorites-flooring').style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

        // Show empty state if no more favorites
        if (allFavorites.length === 0) {
          document.getElementById('favorites-empty').style.display = 'block';
          document.getElementById('request-quote-btn').style.display = 'none';
        }

        showToast('Removed from favorites', 'success');

      } catch (err) {
        console.error('Error removing favorite:', err);
        showToast('Error removing item', 'error');
      }
    }

    function requestQuoteForFavorites() {
      if (allFavorites.length === 0) {
        showToast('No favorites saved yet!', 'error');
        return;
      }

      // Build quote modal
      const modal = document.createElement('div');
      modal.className = 'quote-modal';
      modal.id = 'quote-modal';
      modal.innerHTML = `
        <div class="quote-modal-content">
          <div class="quote-modal-header">
            <h3>Request a Quote</h3>
            <button onclick="closeQuoteModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div class="quote-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">We'll prepare a quote for these ${allFavorites.length} items:</p>

            <div class="quote-items-list">
              ${allFavorites.map(item => `
                <div class="quote-item">
                  <img src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}">
                  <div class="quote-item-info">
                    <div class="quote-item-title">${item.product_title}</div>
                    <div class="quote-item-material">${item.product_type || ''} ${item.product_material ? '- ' + item.product_material : ''} ${item.product_color ? '- ' + item.product_color : ''}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Additional Notes (Optional)</label>
              <textarea id="quote-notes" rows="3" placeholder="Tell us about your project, room size, timeline, etc." style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark); color: var(--text-primary); resize: vertical;"></textarea>
            </div>

            <button class="btn btn-primary" style="width: 100%;" onclick="submitQuoteRequest()">
              Submit Quote Request
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeQuoteModal() {
      const modal = document.getElementById('quote-modal');
      if (modal) modal.remove();
    }

    async function submitQuoteRequest() {
      const notes = document.getElementById('quote-notes')?.value || '';

      // Group favorites by type for the quote
      const groupedFavorites = allFavorites.reduce((acc, f) => {
        const type = f.product_type || 'other';
        if (!acc[type]) acc[type] = [];
        acc[type].push(f);
        return acc;
      }, {});

      // Build formatted list
      const itemsList = Object.entries(groupedFavorites).map(([type, items]) => {
        return `${type.charAt(0).toUpperCase() + type.slice(1)}:\n${items.map(f => `  - ${f.product_title} (${f.product_material || 'N/A'})`).join('\n')}`;
      }).join('\n\n');

      try {
        // Create lead/quote request in Supabase
        const quoteData = {
          user_id: currentUser.id,
          email: currentUser.email,
          full_name: userProfile?.full_name || currentUser.email.split('@')[0],
          phone: userProfile?.phone || '',
          status: 'new',
          source: 'favorites_quote',
          notes: `Quote Request from Favorites:\n\n${itemsList}\n\nAdditional Notes: ${notes || 'None'}`,
          created_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
          .from('leads')
          .insert(quoteData);

        if (error) {
          console.warn('Lead insert error (table may not exist):', error);
        }

        // Send email notification via API
        try {
          await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'info@surprisegranite.com',
              counterSqft: 'Quote Request from Favorites',
              splashSqft: '',
              totalSqft: `${allFavorites.length} items selected`,
              edgeProfile: `Customer: ${userProfile?.full_name || currentUser.email}`,
              edgeLF: `Phone: ${userProfile?.phone || 'N/A'}`,
              priceBudget: allFavorites.map(f => f.product_title).join(', '),
              pricePopular: notes || 'No additional notes',
              pricePremium: `Email: ${currentUser.email}`
            })
          });
        } catch (emailErr) {
          console.warn('Email notification error:', emailErr);
        }

        closeQuoteModal();
        showToast('Quote request submitted! We\'ll contact you soon.', 'success');

      } catch (err) {
        console.error('Quote submit error:', err);
        showToast('Error submitting quote. Please try again.', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#333'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function setupDashboard() {
      // Setup stats and quick actions based on role
      const statsEl = document.getElementById('dashboard-stats');
      const actionsEl = document.getElementById('quick-actions');

      if (isAdmin) {
        loadLeads();
        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Leads</div>
            <div class="stat-value" id="stat-new">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Contacted</div>
            <div class="stat-value" id="stat-contacted">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Won</div>
            <div class="stat-value" id="stat-won">-</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="#" class="action-card" onclick="showPage('leads'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>View Leads</h4>
              <p>Manage incoming leads from the website</p>
            </div>
          </a>
          <a href="/get-a-free-estimate/" class="action-card" target="_blank">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            </div>
            <div class="action-text">
              <h4>Quote Form</h4>
              <p>View the customer quote request form</p>
            </div>
          </a>
          <a href="/" class="action-card" target="_blank">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            </div>
            <div class="action-text">
              <h4>View Website</h4>
              <p>Open the main website in a new tab</p>
            </div>
          </a>
        `;
      } else {
        // Enhanced user stats
        statsEl.innerHTML = `
          <div class="stat-card clickable" onclick="showPage('favorites')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></div>
            <div class="stat-label">My Favorites</div>
            <div class="stat-value" id="stat-favorites">0</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('listings')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></div>
            <div class="stat-label">My Listings</div>
            <div class="stat-value" id="stat-listings">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
            <div class="stat-label">Quotes Sent</div>
            <div class="stat-value" id="stat-quotes">0</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="/get-a-free-estimate/" class="action-card action-highlight">
            <div class="action-icon action-icon-gold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Get Free Estimate</h4>
              <p>Request a quote for your project</p>
            </div>
          </a>
          <a href="#" onclick="showPage('favorites'); return false;" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>My Favorites</h4>
              <p>View saved materials</p>
            </div>
          </a>
          <a href="/remnants/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            </div>
            <div class="action-text">
              <h4>Stone Marketplace</h4>
              <p>Buy & sell remnants</p>
            </div>
          </a>
          <a href="/materials/all-countertops/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Countertops</h4>
              <p>Granite, quartz, marble</p>
            </div>
          </a>
          <a href="/materials/flooring/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-width="2" d="M4 4h16v16H4z M4 10h16 M10 4v16"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Flooring</h4>
              <p>LVP, hardwood, tile</p>
            </div>
          </a>
          <a href="/tools/countertop-calculator/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Calculator</h4>
              <p>Estimate your project</p>
            </div>
          </a>
        `;
      }

      // Setup filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          renderLeads();
        });
      });

      // Setup search
      document.getElementById('leads-search')?.addEventListener('input', () => {
        renderLeads();
      });

      // Load admin users if admin
      if (isSuperAdmin) {
        loadAdminUsers();
      }

      // Load user stats from database
      if (!isAdmin) {
        loadUserStats();
      }
    }

    // Load real user stats from database
    async function loadUserStats() {
      if (!currentUser) return;

      try {
        // Load favorites count
        const { count: favCount, error: favError } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!favError) {
          const favEl = document.getElementById('stat-favorites');
          if (favEl) favEl.textContent = favCount || 0;
        }

        // Load listings count
        const { count: listCount, error: listError } = await supabaseClient
          .from('marketplace_listings')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!listError) {
          const listEl = document.getElementById('stat-listings');
          if (listEl) listEl.textContent = listCount || 0;
        }

        // Load quotes count
        const { count: quoteCount, error: quoteError } = await supabaseClient
          .from('quote_requests')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!quoteError) {
          const quoteEl = document.getElementById('stat-quotes');
          if (quoteEl) quoteEl.textContent = quoteCount || 0;
        }

        console.log('Dashboard: Loaded user stats', { favorites: favCount, listings: listCount, quotes: quoteCount });

      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    function showPage(page) {
      // Update URL hash without triggering hashchange
      if (window.location.hash !== `#${page}`) {
        history.replaceState(null, '', `#${page}`);
      }

      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update page sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === `page-${page}`);
      });

      // Update title
      const titles = {
        'dashboard': 'Dashboard',
        'profile': 'My Profile',
        'favorites': 'My Favorites',
        'listings': 'My Listings',
        'leads': 'Leads',
        'invoices': 'Invoices',
        'wallet': 'Wallet',
        'admin-users': 'Manage Admins',
        'products': 'Products',
        'orders': 'Orders',
        'messages': 'Messages'
      };
      document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

      // Load favorites when that page is shown
      if (page === 'favorites') {
        loadFavorites();
      }

      // Load listings when that page is shown
      if (page === 'listings') {
        loadMyListings();
      }

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('open');
      document.querySelector('.sidebar-overlay').classList.remove('active');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('active');
    }

    // Toggle sidebar collapse state (desktop)
    function toggleSidebarCollapse() {
      const sidebar = document.getElementById('sidebar');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      document.body.classList.toggle('sidebar-collapsed', isCollapsed);

      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
    }

    // Initialize sidebar state from localStorage
    function initSidebarState() {
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
      }
    }

    // Update badge visibility based on count
    function updateBadgeVisibility() {
      document.querySelectorAll('.nav-badge').forEach(badge => {
        const count = parseInt(badge.textContent) || 0;
        badge.setAttribute('data-count', count);
        if (count === 0) {
          badge.style.display = 'none';
        } else {
          badge.style.display = '';
        }
      });
    }

    async function saveProfile() {
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;
      const company = document.getElementById('profile-company').value;

      try {
        const { error } = await supabaseClient
          .from('sg_users')
          .update({
            full_name: name,
            phone: phone || null,
            company_name: company || null,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentUser.id);

        if (error) throw error;

        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        alert('Profile saved successfully!');
      } catch (err) {
        alert('Error saving profile: ' + err.message);
      }
    }

    async function handleLogout() {
      await supabaseClient.auth.signOut();
      currentUser = null;
      userProfile = null;
      showAuth();
    }

    // Leads Functions
    async function loadLeads() {
      try {
        const { data, error } = await supabaseClient
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allLeads = data || [];
        updateStats();
        renderLeads();
      } catch (err) {
        console.error('Error loading leads:', err);
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <h3>Error loading leads</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function updateStats() {
      const stats = {
        total: allLeads.length,
        new: allLeads.filter(l => l.status === 'new').length,
        contacted: allLeads.filter(l => l.status === 'contacted').length,
        won: allLeads.filter(l => l.status === 'won').length
      };

      if (document.getElementById('stat-total')) {
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-new').textContent = stats.new;
        document.getElementById('stat-contacted').textContent = stats.contacted;
        document.getElementById('stat-won').textContent = stats.won;
      }
      const leadsCountEl = document.getElementById('leads-count');
      if (leadsCountEl) {
        leadsCountEl.textContent = stats.new;
        leadsCountEl.setAttribute('data-count', stats.new);
        leadsCountEl.style.display = stats.new > 0 ? '' : 'none';
      }
    }

    function renderLeads() {
      const searchTerm = document.getElementById('leads-search')?.value.toLowerCase() || '';

      let filtered = allLeads;

      if (currentFilter !== 'all') {
        filtered = filtered.filter(l => l.status === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(l =>
          (l.full_name || '').toLowerCase().includes(searchTerm) ||
          (l.email || '').toLowerCase().includes(searchTerm) ||
          (l.phone || '').toLowerCase().includes(searchTerm)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <h3>No leads found</h3>
            <p>${currentFilter !== 'all' ? 'No leads with this status.' : 'Leads from your website forms will appear here.'}</p>
          </div>
        `;
        return;
      }

      document.getElementById('leads-table').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Contact</th>
              <th>Project</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(lead => `
              <tr>
                <td>
                  <div class="lead-name">${lead.full_name || 'Unknown'}</div>
                  <div class="lead-email">${lead.email || lead.phone || 'No contact'}</div>
                </td>
                <td><span class="lead-project">${lead.project_type || 'General'}</span></td>
                <td><span class="status-badge status-${lead.status}">${lead.status}</span></td>
                <td><div class="lead-date">${formatDate(lead.created_at)}</div></td>
                <td>
                  <div class="lead-actions">
                    <button class="action-btn" onclick="viewLead('${lead.id}')" title="View">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </button>
                    ${lead.email ? `<a class="action-btn" href="mailto:${lead.email}" title="Email"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></a>` : ''}
                    ${lead.phone ? `<a class="action-btn" href="tel:${lead.phone}" title="Call"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg></a>` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) return 'Just now';
        return `${hours}h ago`;
      } else if (days === 1) return 'Yesterday';
      else if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function viewLead(id) {
      selectedLead = allLeads.find(l => l.id === id);
      if (!selectedLead) return;

      document.getElementById('lead-details').innerHTML = `
        <div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">${selectedLead.full_name || 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${selectedLead.email ? `<a href="mailto:${selectedLead.email}" style="color: var(--gold-primary);">${selectedLead.email}</a>` : 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">${selectedLead.phone ? `<a href="tel:${selectedLead.phone}" style="color: var(--gold-primary);">${selectedLead.phone}</a>` : 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Project</div><div class="detail-value">${selectedLead.project_type || 'Not specified'}</div></div>
        <div class="detail-row"><div class="detail-label">Message</div><div class="detail-value">${selectedLead.message || 'No message'}</div></div>
        <div class="detail-row"><div class="detail-label">Source</div><div class="detail-value">${selectedLead.form_name || 'Website'}</div></div>
        <div class="detail-row"><div class="detail-label">Submitted</div><div class="detail-value">${new Date(selectedLead.created_at).toLocaleString()}</div></div>
      `;

      document.getElementById('lead-status-select').value = selectedLead.status;
      document.getElementById('lead-modal').classList.add('active');
    }

    function closeLeadModal() {
      document.getElementById('lead-modal').classList.remove('active');
      selectedLead = null;
    }

    async function updateLeadStatus() {
      if (!selectedLead) return;

      const newStatus = document.getElementById('lead-status-select').value;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = newStatus;

        updateStats();
        renderLeads();
        closeLeadModal();
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Admin Users Functions
    let adminUsers = [];

    async function loadAdminUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .or('account_type.eq.admin,account_type.eq.super_admin')
          .order('created_at', { ascending: false });

        if (error) throw error;
        adminUsers = data || [];
        renderAdminUsers();
      } catch (err) {
        document.getElementById('admin-users-list').innerHTML = `<p style="color: var(--error);">Error: ${err.message}</p>`;
      }
    }

    function renderAdminUsers() {
      const allAdmins = [
        ...SUPER_ADMIN_EMAILS.map(email => ({ email, full_name: email.split('@')[0], isSuperAdmin: true })),
        ...adminUsers.filter(u => !SUPER_ADMIN_EMAILS.includes(u.email?.toLowerCase()))
      ];

      document.getElementById('admin-users-list').innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allAdmins.map(user => `
              <tr>
                <td>${user.email}</td>
                <td>${user.full_name || '-'}</td>
                <td><span class="status-badge ${user.isSuperAdmin ? 'status-won' : 'status-qualified'}">${user.isSuperAdmin ? 'Super Admin' : 'Admin'}</span></td>
                <td style="text-align: right;">
                  ${user.isSuperAdmin ? '<span style="color: var(--text-muted); font-size: 12px;">Protected</span>' :
                    `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeAdminUser('${user.id}', '${user.email}')">Remove</button>`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function addAdminUser() {
      const email = document.getElementById('new-admin-email').value.trim().toLowerCase();
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
      }

      if (SUPER_ADMIN_EMAILS.includes(email)) {
        alert('Already a super admin');
        return;
      }

      try {
        const { data: existing } = await supabaseClient.from('sg_users').select('*').eq('email', email).single();

        if (existing) {
          await supabaseClient.from('sg_users').update({ account_type: 'admin' }).eq('id', existing.id);
        } else {
          await supabaseClient.from('sg_users').insert([{ email, account_type: 'admin', full_name: email.split('@')[0] }]);
        }

        document.getElementById('new-admin-email').value = '';
        loadAdminUsers();
        alert(`Admin access granted to ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeAdminUser(userId, email) {
      if (!confirm(`Remove admin access for ${email}?`)) return;

      try {
        await supabaseClient.from('sg_users').update({ account_type: 'homeowner' }).eq('id', userId);
        loadAdminUsers();
        alert(`Admin removed: ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLeadModal();
        closeProductModal();
        closeInvoiceModal();
      }
    });

    document.getElementById('lead-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeLeadModal();
    });

    // ============ PRODUCT MANAGEMENT ============
    let allProducts = [];
    let productFilter = 'all';
    let editingProduct = null;

    async function loadProducts() {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      try {
        let query = supabaseClient
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });

        // Non-super admins only see their own products
        if (!isSuperAdmin) {
          query = query.eq('vendor_id', currentUser.id);
        }

        const { data, error } = await query;

        if (error) {
          // Table might not exist yet
          if (error.code === '42P01') {
            productsGrid.innerHTML = `
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <h3>Products Table Not Set Up</h3>
                <p>The products table needs to be created in Supabase. Contact your administrator.</p>
              </div>
            `;
            return;
          }
          throw error;
        }

        allProducts = data || [];
        renderProducts();
      } catch (err) {
        console.error('Error loading products:', err);
        productsGrid.innerHTML = `
          <div class="empty-state">
            <h3>Error loading products</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function filterProducts(status) {
      productFilter = status;
      document.querySelectorAll('[data-product-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.productStatus === status);
      });
      renderProducts();
    }

    function renderProducts() {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      let filtered = allProducts;
      if (productFilter !== 'all') {
        filtered = filtered.filter(p => p.status === productFilter);
      }

      if (filtered.length === 0) {
        productsGrid.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <h3>No products found</h3>
            <p>${productFilter !== 'all' ? 'No products with this status.' : 'Add your first product to get started.'}</p>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="openProductModal()">Add Product</button>
          </div>
        `;
        return;
      }

      productsGrid.innerHTML = filtered.map(product => `
        <div class="product-card" data-id="${product.id}">
          <div class="product-image">
            ${product.image_url ?
              `<img src="${product.image_url}" alt="${product.name}" onerror="this.style.display='none';this.parentElement.querySelector('.product-placeholder').style.display='flex';">
               <div class="product-placeholder" style="display:none;">` :
              `<div class="product-placeholder">`}
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
          </div>
          <div class="product-info">
            <div class="product-status status-${product.status}">${product.status}</div>
            <h4 class="product-name">${product.name}</h4>
            <p class="product-category">${product.category || 'Uncategorized'}</p>
            <div class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
            ${product.dimensions ? `<p class="product-dims">${product.dimensions}</p>` : ''}
          </div>
          <div class="product-actions">
            <button class="action-btn" onclick="editProduct('${product.id}')" title="Edit">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
            <button class="action-btn" onclick="deleteProduct('${product.id}')" title="Delete" style="color: var(--error);">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    function openProductModal(product = null) {
      editingProduct = product;
      const modal = document.getElementById('product-modal');
      const title = document.getElementById('product-modal-title');
      const form = document.getElementById('product-form');

      title.textContent = product ? 'Edit Product' : 'Add New Product';
      form.reset();

      if (product) {
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('product-category').value = product.category || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-dimensions').value = product.dimensions || '';
        document.getElementById('product-image-url').value = product.image_url || '';
        document.getElementById('product-status').value = product.status || 'draft';
        document.getElementById('product-material').value = product.material_type || '';
        document.getElementById('product-color').value = product.color || '';
        document.getElementById('product-stock').value = product.stock_quantity || 1;
      }

      modal.classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('active');
      editingProduct = null;
    }

    async function editProduct(id) {
      const product = allProducts.find(p => p.id === id);
      if (product) {
        openProductModal(product);
      }
    }

    async function saveProduct(e) {
      e.preventDefault();
      const btn = document.getElementById('product-save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const productData = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        category: document.getElementById('product-category').value,
        price: parseFloat(document.getElementById('product-price').value) || 0,
        dimensions: document.getElementById('product-dimensions').value,
        image_url: document.getElementById('product-image-url').value,
        status: document.getElementById('product-status').value,
        material_type: document.getElementById('product-material').value,
        color: document.getElementById('product-color').value,
        stock_quantity: parseInt(document.getElementById('product-stock').value) || 1,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingProduct) {
          // Update existing
          const { error } = await supabaseClient
            .from('products')
            .update(productData)
            .eq('id', editingProduct.id);
          if (error) throw error;
        } else {
          // Create new
          productData.vendor_id = currentUser.id;
          productData.vendor_email = currentUser.email;
          productData.created_at = new Date().toISOString();

          const { error } = await supabaseClient
            .from('products')
            .insert([productData]);
          if (error) throw error;
        }

        closeProductModal();
        loadProducts();
        alert(editingProduct ? 'Product updated!' : 'Product added!');
      } catch (err) {
        alert('Error saving product: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Product';
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const { error } = await supabaseClient
          .from('products')
          .delete()
          .eq('id', id);
        if (error) throw error;

        allProducts = allProducts.filter(p => p.id !== id);
        renderProducts();
        alert('Product deleted.');
      } catch (err) {
        alert('Error deleting product: ' + err.message);
      }
    }

    // Load products when showing products page
    const originalShowPage = showPage;
    showPage = function(page) {
      originalShowPage(page);
      if (page === 'products' && (isAdmin || userProfile?.account_type?.startsWith('pro_'))) {
        loadProducts();
      }
    };

    // Product modal click-outside to close
    document.getElementById('product-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeProductModal();
    });

    // ============ INVOICE MANAGEMENT ============
    const API_URL = 'https://surprise-granite-email-api.onrender.com';

    let allInvoices = [];
    let invoiceFilter = 'all';
    let invoiceItemCount = 1;

    async function loadInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      try {
        const response = await fetch(`${API_URL}/api/invoices?limit=50`);

        if (!response.ok) {
          throw new Error('API not available. Please deploy the Stripe API backend first.');
        }

        const data = await response.json();
        allInvoices = data.invoices || [];
        renderInvoices();
      } catch (err) {
        console.error('Error loading invoices:', err);
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>Invoice API Not Connected</h3>
            <p>The Stripe invoice API needs to be deployed. See /api folder for setup instructions.</p>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice Anyway</button>
          </div>
        `;
      }
    }

    function filterInvoices(status) {
      invoiceFilter = status;
      document.querySelectorAll('[data-invoice-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.invoiceStatus === status);
      });
      renderInvoices();
    }

    function renderInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      let filtered = allInvoices;
      if (invoiceFilter !== 'all') {
        filtered = filtered.filter(inv => inv.status === invoiceFilter);
      }

      if (filtered.length === 0) {
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>No invoices found</h3>
            <p>${invoiceFilter !== 'all' ? 'No invoices with this status.' : 'Create your first invoice to get started.'}</p>
            <button class="btn btn-primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
        return;
      }

      invoicesList.innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Due Date</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(inv => `
              <tr>
                <td><strong>${inv.number || inv.id.slice(-8)}</strong></td>
                <td>
                  <div>${inv.customer_name || 'N/A'}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">${inv.customer_email}</div>
                </td>
                <td style="font-weight: 600; color: var(--gold-primary);">$${inv.amount_due.toFixed(2)}</td>
                <td><span class="status-badge status-${inv.status === 'paid' ? 'won' : inv.status === 'open' ? 'new' : inv.status === 'void' ? 'lost' : 'qualified'}">${inv.status}</span></td>
                <td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'N/A'}</td>
                <td style="text-align: right;">
                  <div class="lead-actions" style="justify-content: flex-end;">
                    ${inv.hosted_invoice_url ? `<a class="action-btn" href="${inv.hosted_invoice_url}" target="_blank" title="View Invoice"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>` : ''}
                    ${inv.pdf ? `<a class="action-btn" href="${inv.pdf}" target="_blank" title="Download PDF"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></a>` : ''}
                    ${inv.status === 'open' ? `<button class="action-btn" onclick="sendReminder('${inv.id}')" title="Send Reminder"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg></button>` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function openInvoiceModal() {
      document.getElementById('invoice-modal').classList.add('active');
      document.getElementById('invoice-form').reset();
      document.getElementById('invoice-items').innerHTML = `
        <div class="invoice-item" data-index="0">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn btn-secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      invoiceItemCount = 1;
      updateInvoiceTotal();
    }

    function closeInvoiceModal() {
      document.getElementById('invoice-modal').classList.remove('active');
    }

    // Template Preview Modal Functions
    const templatePreviews = {
      classic: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #f4f4f4;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <tr>
            <td style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; text-align: center;">
              <h1 style="color: #f9cb00; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 1px;">Surprise Granite</h1>
              <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0; font-size: 14px;">Premium Countertops & Expert Installation</p>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 40px 20px; border-bottom: 2px solid #f9cb00;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h2 style="margin: 0; color: #1a1a2e; font-size: 32px; font-weight: 300;">INVOICE</h2>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px;"><strong>Date:</strong> Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #1a1a2e; font-size: 14px;"><strong>Due:</strong> Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Bill To</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 16px; font-weight: 600;">John Smith</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">From</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px; font-weight: 600;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 13px;">14155 W. Bell Road, Suite 100</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 30px;">
              <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: collapse;">
                <tr style="background-color: #1a1a2e;">
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Description</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: center;">Qty</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: right;">Amount</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Kitchen Countertop - Granite</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$2,500.00</td>
                </tr>
                <tr style="background-color: #ffffff;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Installation Labor</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$800.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" style="background-color: #1a1a2e; padding: 20px; border-radius: 8px;">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700;">TOTAL</td>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700; text-align: right;">$3,300.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px; text-align: center;">
              <a href="#" style="display: inline-block; background: linear-gradient(135deg, #f9cb00 0%, #e6b800 100%); color: #1a1a2e; text-decoration: none; padding: 18px 50px; border-radius: 50px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(249, 203, 0, 0.4);">Pay Now</a>
            </td>
          </tr>
          <tr>
            <td style="background-color: #f9f9f9; padding: 30px 40px; text-align: center; border-top: 1px solid #eee;">
              <p style="margin: 0 0 10px; color: #666; font-size: 14px;">Questions? Contact us at <a href="#" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a></p>
              <p style="margin: 0; color: #999; font-size: 12px;">Surprise Granite Marble & Quartz</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      modern: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="center" style="padding: 60px 20px;">
        <table role="presentation" width="550" cellspacing="0" cellpadding="0">
          <tr>
            <td style="padding-bottom: 40px; border-bottom: 1px solid #eee;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h1 style="margin: 0; color: #000; font-size: 24px; font-weight: 800; letter-spacing: -0.5px;">SURPRISE<span style="color: #f9cb00;">GRANITE</span></h1>
                    <p style="margin: 4px 0 0; color: #888; font-size: 12px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #000; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;">Invoice</p>
                    <p style="margin: 4px 0 0; color: #f9cb00; font-size: 20px; font-weight: 700;">#INV-2024-001</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Billed To</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 18px; font-weight: 600;">John Smith</p>
                    <p style="margin: 4px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" align="right">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Invoice Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">January 7, 2025</p>
                    <p style="margin: 20px 0 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Due Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">February 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Kitchen Countertop - Granite</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$2,500.00</p>
                  </td>
                </tr>
              </table>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Installation Labor</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$800.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" align="right">
                    <p style="margin: 0; padding: 15px 0; color: #000; font-size: 20px; font-weight: 700;">Total</p>
                    <p style="margin: 0; color: #000; font-size: 24px; font-weight: 700;">$3,300.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 20px 0 50px; text-align: center;">
              <a href="#" style="display: inline-block; background-color: #000; color: #fff; text-decoration: none; padding: 16px 60px; font-size: 14px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;">Pay Invoice </a>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0; border-top: 1px solid #eee; text-align: center;">
              <p style="margin: 0; color: #888; font-size: 13px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;"><a href="#" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a>  <a href="#" style="color: #f9cb00; text-decoration: none;">(623) 466-2424</a></p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      premium: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #0a0a12; font-family: 'Georgia', 'Times New Roman', serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #0a0a12;">
    <tr>
      <td align="center" style="padding: 50px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0">
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 12px; letter-spacing: 4px; text-transform: uppercase;">Premium Quality</p>
              <h1 style="margin: 15px 0 0; color: #ffffff; font-size: 36px; font-weight: 400; letter-spacing: 3px;">SURPRISE GRANITE</h1>
              <p style="margin: 10px 0 0; color: #888; font-size: 14px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 3px; text-transform: uppercase;">Invoice Number</p>
                    <p style="margin: 8px 0 0; color: #ffffff; font-size: 24px; font-weight: 300;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #888; font-size: 13px;">Issue Date: Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">Due: Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Bill To</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 20px; font-weight: 400;">John Smith</p>
                    <p style="margin: 8px 0 0; color: #888; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">From</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 14px;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">(623) 466-2424</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="padding: 20px 50px; border-bottom: 1px solid rgba(249, 203, 0, 0.2);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Description</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: center;" width="80">Qty</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: right;" width="120">Amount</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Kitchen Countertop - Granite</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$2,500.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Installation Labor</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$800.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background: linear-gradient(135deg, #f9cb00 0%, #d4a800 100%); padding: 30px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="color: #1a1a2e; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">Total Amount</td>
                  <td align="right" style="color: #1a1a2e; font-size: 32px; font-weight: 700;">$3,300.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <a href="#" style="display: inline-block; border: 2px solid #f9cb00; color: #f9cb00; text-decoration: none; padding: 18px 60px; font-size: 13px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase;">PAY INVOICE</a>
              <p style="margin: 30px 0 0; color: #666; font-size: 13px;">Secure payment powered by Stripe</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #0a0a12; padding: 40px 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 2px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 15px 0 0; color: #666; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 10px 0 0; color: #666; font-size: 12px;">info@surprisegranite.com  (623) 466-2424</p>
              <p style="margin: 20px 0 0; color: #444; font-size: 11px;">Thank you for choosing Surprise Granite for your project.</p>
            </td>
          </tr>
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`
    };

    function openTemplatePreview() {
      document.getElementById('template-preview-modal').classList.add('active');
      // Load the classic template by default
      showTemplatePreview('classic');
    }

    function closeTemplatePreview() {
      document.getElementById('template-preview-modal').classList.remove('active');
    }

    function showTemplatePreview(templateName) {
      // Update active tab
      document.querySelectorAll('.template-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.template === templateName) {
          tab.classList.add('active');
        }
      });

      // Show corresponding preview frame
      document.querySelectorAll('.template-preview-frame').forEach(frame => {
        frame.style.display = 'none';
      });
      const activeFrame = document.getElementById('template-frame-' + templateName);
      if (activeFrame) {
        activeFrame.style.display = 'block';
        // Load the template content into the iframe
        const iframe = document.getElementById('preview-iframe-' + templateName);
        if (iframe && templatePreviews[templateName]) {
          iframe.srcdoc = templatePreviews[templateName];
        }
      }
    }

    // Close template preview modal on click outside
    document.getElementById('template-preview-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeTemplatePreview();
    });

    function addInvoiceItem() {
      const container = document.getElementById('invoice-items');
      const itemHTML = `
        <div class="invoice-item" data-index="${invoiceItemCount}">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Installation Labor"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn btn-secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', itemHTML);
      invoiceItemCount++;
    }

    function removeInvoiceItem(btn) {
      const items = document.querySelectorAll('.invoice-item');
      if (items.length > 1) {
        btn.closest('.invoice-item').remove();
        updateInvoiceTotal();
      }
    }

    function updateInvoiceTotal() {
      const items = document.querySelectorAll('.invoice-item');
      let total = 0;
      items.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
        const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
        total += qty * amount;
      });
      document.getElementById('invoice-total').textContent = `$${total.toFixed(2)}`;
    }

    async function createInvoice(e) {
      e.preventDefault();
      const btn = document.getElementById('invoice-send-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      const items = [];
      document.querySelectorAll('.invoice-item').forEach(item => {
        items.push({
          description: item.querySelector('.item-description').value,
          quantity: parseInt(item.querySelector('.item-qty').value) || 1,
          amount: parseFloat(item.querySelector('.item-amount').value) || 0
        });
      });

      // Get selected template
      const selectedTemplate = document.querySelector('input[name="invoice-template"]:checked')?.value || 'classic';

      const invoiceData = {
        customer_email: document.getElementById('invoice-email').value,
        customer_name: document.getElementById('invoice-name').value,
        customer_phone: document.getElementById('invoice-phone').value,
        items,
        due_days: parseInt(document.getElementById('invoice-due-days').value),
        notes: document.getElementById('invoice-notes').value,
        auto_send: true,
        template: selectedTemplate
      };

      try {
        const response = await fetch(`${API_URL}/api/invoices`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create invoice');
        }

        closeInvoiceModal();
        loadInvoices();
        alert(`Invoice #${data.invoice.number} created and sent to ${invoiceData.customer_email}!`);
      } catch (err) {
        alert('Error creating invoice: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create & Send Invoice';
      }
    }

    async function sendReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        const response = await fetch(`${API_URL}/api/invoices/${invoiceId}/remind`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to send reminder');
        }

        alert('Payment reminder sent!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Invoice modal click-outside to close
    document.getElementById('invoice-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeInvoiceModal();
    });

    // Update showPage to load invoices and wallet
    const _originalShowPage = showPage;
    showPage = function(page) {
      _originalShowPage(page);
      if (page === 'invoices' && isAdmin) {
        loadInvoices();
      }
      if (page === 'wallet' && isAdmin) {
        loadWalletData();
      }
    };

    // ============ WALLET MANAGEMENT ============
    let totalRevenue = 0;

    async function loadWalletData() {
      await Promise.all([
        loadBalance(),
        loadTransactions(),
        loadPayouts()
      ]);
    }

    async function loadBalance() {
      try {
        const response = await fetch(`${API_URL}/api/balance`);
        if (!response.ok) throw new Error('Failed to load balance');

        const data = await response.json();

        document.getElementById('available-balance').textContent = `$${data.total_available.toFixed(2)}`;
        document.getElementById('pending-balance').textContent = `$${data.total_pending.toFixed(2)}`;

      } catch (err) {
        console.error('Balance error:', err);
        document.getElementById('available-balance').textContent = '$--.--';
        document.getElementById('pending-balance').textContent = '$--.--';
      }
    }

    async function loadTransactions() {
      const container = document.getElementById('transactions-list');
      if (!container) return;

      try {
        const response = await fetch(`${API_URL}/api/balance-transactions?limit=15`);
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();

        if (data.transactions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No transactions yet</p>
            </div>
          `;
          return;
        }

        // Calculate total revenue from charges
        totalRevenue = data.transactions
          .filter(t => t.type === 'charge' && t.amount > 0)
          .reduce((sum, t) => sum + t.amount, 0);

        document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;

        container.innerHTML = data.transactions.map(t => {
          const isPositive = t.amount > 0 && t.type !== 'payout' && t.type !== 'stripe_fee';
          const iconClass = t.type === 'payout' ? 'payout' : (t.type === 'stripe_fee' ? 'fee' : 'income');
          const icon = t.type === 'payout'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>'
            : t.type === 'stripe_fee'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>';

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon ${iconClass}">${icon}</div>
                <div class="transaction-details">
                  <h4>${t.description || t.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                  <p>${t.type} ${t.fee > 0 ? ` Fee: $${t.fee.toFixed(2)}` : ''}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                <div class="date">${new Date(t.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Transactions error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load transactions</p>
          </div>
        `;
      }
    }

    async function loadPayouts() {
      const container = document.getElementById('payouts-list');
      if (!container) return;

      try {
        const response = await fetch(`${API_URL}/api/payouts?limit=10`);
        if (!response.ok) throw new Error('Failed to load payouts');

        const data = await response.json();

        if (data.payouts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No payouts yet. Funds are automatically transferred to your bank account.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = data.payouts.map(p => {
          const statusColor = p.status === 'paid' ? 'var(--success)' : (p.status === 'pending' ? 'var(--warning)' : 'var(--text-muted)');

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon payout">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <div class="transaction-details">
                  <h4>Bank Transfer</h4>
                  <p style="color: ${statusColor};">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}  Arrives ${new Date(p.arrival_date).toLocaleDateString()}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount">$${p.amount.toFixed(2)}</div>
                <div class="date">${new Date(p.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Payouts error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load payouts</p>
          </div>
        `;
      }
    }

    // ============================================
    // STONE LISTINGS - Remnants Marketplace
    // ============================================

    let countertopsData = [];
    const MAX_FREE_LISTINGS = 3;

    // Load countertops data for autocomplete
    async function loadCountertopsData() {
      try {
        const response = await fetch('/data/countertops.json');
        countertopsData = await response.json();
      } catch (err) {
        console.error('Failed to load countertops data:', err);
      }
    }

    // Initialize listings functionality
    loadCountertopsData();

    // Stone autocomplete
    const stoneSearchInput = document.getElementById('listing-stone-search');
    const autocompleteResults = document.getElementById('stone-autocomplete-results');

    if (stoneSearchInput) {
      stoneSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 2) {
          autocompleteResults.classList.remove('active');
          return;
        }

        const matches = countertopsData
          .filter(stone =>
            stone.name.toLowerCase().includes(query) ||
            (stone.brand && stone.brand.toLowerCase().includes(query)) ||
            (stone.color && stone.color.toLowerCase().includes(query))
          )
          .slice(0, 8);

        if (matches.length === 0) {
          autocompleteResults.innerHTML = '<div style="padding: 12px; color: var(--text-muted);">No matching stones found</div>';
        } else {
          autocompleteResults.innerHTML = matches.map(stone => `
            <div class="stone-result-item" onclick="selectStone(${JSON.stringify(stone).replace(/"/g, '&quot;')})">
              <img src="${stone.image || '/images/placeholder.svg'}" alt="" class="stone-result-thumb">
              <div class="stone-result-info">
                <div class="stone-result-name">${stone.name}</div>
                <div class="stone-result-meta">${stone.brand || ''}  ${stone.type || ''}  ${stone.color || ''}</div>
              </div>
            </div>
          `).join('');
        }
        autocompleteResults.classList.add('active');
      });

      // Close autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.stone-autocomplete')) {
          autocompleteResults.classList.remove('active');
        }
      });
    }

    function selectStone(stone) {
      document.getElementById('listing-stone-slug').value = stone.slug || '';
      document.getElementById('listing-stone-name').value = stone.name || '';
      document.getElementById('listing-material-type').value = stone.type || '';
      document.getElementById('listing-brand').value = stone.brand || '';
      document.getElementById('listing-color').value = stone.color || '';
      document.getElementById('listing-stone-search').value = stone.name;

      // Update preview
      document.getElementById('selected-stone-preview').style.display = 'block';
      document.getElementById('selected-stone-img').src = stone.image || '/images/placeholder.svg';
      document.getElementById('selected-stone-name').textContent = stone.name;
      document.getElementById('selected-stone-meta').textContent = `${stone.brand || ''}  ${stone.type || ''}  ${stone.color || ''}`;

      // Auto-fill title if empty
      const titleInput = document.getElementById('listing-title');
      if (!titleInput.value) {
        titleInput.value = `${stone.name} Remnant`;
      }

      autocompleteResults.classList.remove('active');
    }

    function clearSelectedStone() {
      document.getElementById('listing-stone-slug').value = '';
      document.getElementById('listing-stone-name').value = '';
      document.getElementById('listing-material-type').value = '';
      document.getElementById('listing-brand').value = '';
      document.getElementById('listing-color').value = '';
      document.getElementById('listing-stone-search').value = '';
      document.getElementById('selected-stone-preview').style.display = 'none';
    }

    function togglePriceField() {
      const priceInput = document.getElementById('listing-price');
      const contactCheckbox = document.getElementById('listing-price-contact');
      priceInput.disabled = contactCheckbox.checked;
      if (contactCheckbox.checked) {
        priceInput.value = '';
        priceInput.placeholder = 'Contact for price';
      } else {
        priceInput.placeholder = '0.00';
      }
    }

    // Image Upload Functions
    function triggerImageUpload(slotNum) {
      const fileInput = document.getElementById(`image-file-${slotNum}`);
      fileInput.click();
    }

    async function handleImageUpload(slotNum, input) {
      const file = input.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB');
        return;
      }

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const progress = document.getElementById(`upload-progress-${slotNum}`);
      const progressBar = document.getElementById(`upload-bar-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);

      // Show progress
      progress.style.display = 'block';
      progressBar.style.width = '10%';

      try {
        // Get current user
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          alert('Please log in to upload images');
          return;
        }

        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

        progressBar.style.width = '30%';

        // Compress image if needed
        const compressedFile = await compressImage(file, 1200, 0.8);

        progressBar.style.width = '50%';

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('listing-images')
          .upload(fileName, compressedFile, {
            cacheControl: '3600',
            upsert: false
          });

        progressBar.style.width = '80%';

        if (error) {
          // Fallback: use data URL for preview and let user know to use URL input
          console.warn('Storage upload failed, using local preview:', error);
          const dataUrl = await readFileAsDataUrl(file);
          preview.src = dataUrl;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
          removeBtn.style.display = 'flex';
          slot.classList.add('has-image');
          // Store data URL temporarily (won't persist to DB, but shows preview)
          hiddenInput.value = dataUrl;
          progressBar.style.width = '100%';
          setTimeout(() => { progress.style.display = 'none'; }, 500);
          return;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('listing-images')
          .getPublicUrl(fileName);

        progressBar.style.width = '100%';

        // Update UI
        preview.src = urlData.publicUrl;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        removeBtn.style.display = 'flex';
        slot.classList.add('has-image');
        hiddenInput.value = urlData.publicUrl;

        setTimeout(() => { progress.style.display = 'none'; }, 500);

      } catch (err) {
        console.error('Upload error:', err);
        alert('Failed to upload image. Please try again or paste an image URL.');
        progress.style.display = 'none';
      }
    }

    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressImage(file, maxWidth, quality) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function removeImage(event, slotNum) {
      event.stopPropagation();

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);
      const fileInput = document.getElementById(`image-file-${slotNum}`);

      // Reset UI
      preview.src = '';
      preview.style.display = 'none';
      placeholder.style.display = 'flex';
      removeBtn.style.display = 'none';
      slot.classList.remove('has-image');
      hiddenInput.value = '';
      fileInput.value = '';
    }

    function updateImagePreviews() {
      const previewGrid = document.getElementById('image-preview-grid');
      const images = [
        document.getElementById('listing-image-1').value,
        document.getElementById('listing-image-2').value,
        document.getElementById('listing-image-3').value,
        document.getElementById('listing-image-4').value
      ].filter(url => url);

      previewGrid.innerHTML = images.map((url, i) => `
        <div class="image-preview-item">
          <img src="${url}" alt="Preview ${i + 1}" onerror="this.src='/images/placeholder.svg'">
        </div>
      `).join('');
    }

    // Modal functions
    async function openCreateListingModal() {
      // Check listing limit first
      const canCreate = await checkListingLimit();
      if (!canCreate.allowed) {
        alert(`You've reached your limit of ${canCreate.max} free listings. Upgrade to Pro for unlimited listings!`);
        return;
      }

      document.getElementById('create-listing-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCreateListingModal() {
      document.getElementById('create-listing-modal').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('create-listing-form').reset();
      clearSelectedStone();
      // Reset category to default
      selectListingCategory('countertops');
    }

    function selectListingCategory(category) {
      // Update hidden input
      document.getElementById('listing-category').value = category;

      // Update visual selection
      document.querySelectorAll('.listing-category-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.category === category);
      });

      // Update product selection section based on category
      const productSection = document.getElementById('product-selection-section');
      const titleEl = document.getElementById('product-selection-title');
      const labelEl = document.getElementById('product-search-label');
      const searchInput = document.getElementById('listing-stone-search');

      // Category-specific labels
      const categoryConfig = {
        countertops: {
          title: 'Select Stone',
          label: 'Search countertops catalog (optional)',
          placeholder: 'Start typing stone name...',
          showCatalog: true
        },
        tile: {
          title: 'Select Tile',
          label: 'Search tile catalog (optional)',
          placeholder: 'Start typing tile name...',
          showCatalog: true
        },
        flooring: {
          title: 'Select Flooring',
          label: 'Search flooring catalog (optional)',
          placeholder: 'Start typing flooring name...',
          showCatalog: true
        },
        cabinets: {
          title: 'Cabinet Details',
          label: 'Describe your cabinets',
          placeholder: 'e.g., Shaker White 36" Base Cabinet',
          showCatalog: false
        },
        supplies: {
          title: 'Product Details',
          label: 'Describe your product',
          placeholder: 'e.g., Mapei Kerabond Thinset 50lb',
          showCatalog: false
        },
        other: {
          title: 'Product Details',
          label: 'Describe your item',
          placeholder: 'e.g., Delta Faucet, Cabinet Hardware',
          showCatalog: false
        }
      };

      const config = categoryConfig[category] || categoryConfig.other;
      titleEl.textContent = config.title;
      labelEl.textContent = config.label;
      searchInput.placeholder = config.placeholder;

      // Show/hide autocomplete for categories without catalog
      const autocompleteResults = document.getElementById('stone-autocomplete-results');
      if (!config.showCatalog) {
        autocompleteResults.style.display = 'none';
      }

      // Clear previous selection when switching categories
      clearSelectedStone();
    }

    async function checkListingLimit() {
      const user = await supabaseClient.auth.getUser();
      if (!user.data.user) return { allowed: false, remaining: 0 };

      // Check if pro account
      const { data: profile } = await supabaseClient
        .from('sg_users')
        .select('account_type')
        .eq('id', user.data.user.id)
        .single();

      const accountType = profile?.account_type || 'homeowner';
      if (accountType.startsWith('pro_') || accountType === 'admin') {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Count active listings
      const { count } = await supabaseClient
        .from('stone_listings')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.data.user.id)
        .eq('status', 'active');

      return {
        allowed: (count || 0) < MAX_FREE_LISTINGS,
        remaining: MAX_FREE_LISTINGS - (count || 0),
        current: count || 0,
        max: MAX_FREE_LISTINGS,
        isPro: false
      };
    }

    async function handleCreateListing(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submit-listing-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Creating...';

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          throw new Error('Please sign in to create a listing');
        }

        // Get category and determine product name
        const category = document.getElementById('listing-category').value;
        const catalogStoneName = document.getElementById('listing-stone-name').value;
        const userBrandInput = document.getElementById('listing-brand-input').value;

        const listingData = {
          user_id: user.data.user.id,
          category: category,
          condition: document.getElementById('listing-condition').value || 'new',
          stone_name: catalogStoneName || document.getElementById('listing-title').value,
          stone_slug: document.getElementById('listing-stone-slug').value || null,
          material_type: document.getElementById('listing-material-type').value || category,
          brand: document.getElementById('listing-brand').value || userBrandInput || null,
          color: document.getElementById('listing-color').value || null,
          title: document.getElementById('listing-title').value,
          description: document.getElementById('listing-description').value || null,
          dimensions: document.getElementById('listing-dimensions').value || null,
          thickness: document.getElementById('listing-thickness').value || null,
          quantity: parseInt(document.getElementById('listing-quantity').value) || 1,
          price: document.getElementById('listing-price-contact').checked ? null : (parseFloat(document.getElementById('listing-price').value) || null),
          image_url: document.getElementById('listing-image-1').value || null,
          image_url_2: document.getElementById('listing-image-2').value || null,
          image_url_3: document.getElementById('listing-image-3').value || null,
          image_url_4: document.getElementById('listing-image-4').value || null,
          city: document.getElementById('listing-city').value || null,
          state: document.getElementById('listing-state').value || null,
          zip_code: document.getElementById('listing-zip').value || null,
          show_email: document.getElementById('listing-show-email').checked,
          show_phone: document.getElementById('listing-show-phone').checked,
          contact_form_only: document.getElementById('listing-contact-form').checked,
          status: 'active'
        };

        const { data, error } = await supabaseClient
          .from('stone_listings')
          .insert([listingData])
          .select()
          .single();

        if (error) throw error;

        closeCreateListingModal();
        await loadMyListings();
        alert('Listing created successfully!');

      } catch (err) {
        console.error('Create listing error:', err);
        alert('Failed to create listing: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        `;
      }
    }

    async function loadMyListings() {
      const loadingEl = document.getElementById('listings-loading');
      const emptyEl = document.getElementById('listings-empty');
      const gridEl = document.getElementById('listings-grid');
      const limitIndicator = document.getElementById('listing-limit-indicator');

      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      gridEl.style.display = 'none';

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          loadingEl.innerHTML = '<p style="color: var(--text-muted);">Please sign in to view your listings</p>';
          return;
        }

        // Update listing count and limit indicator
        const limitInfo = await checkListingLimit();
        if (limitInfo.isPro) {
          limitIndicator.textContent = 'Unlimited listings (Pro)';
          limitIndicator.style.color = 'var(--gold-primary)';
        } else {
          limitIndicator.textContent = `${limitInfo.current}/${limitInfo.max} listings used`;
          limitIndicator.style.color = limitInfo.remaining === 0 ? 'var(--error)' : 'var(--text-muted)';
        }

        // Update nav badge
        const listingsCountEl = document.getElementById('listings-count');
        if (listingsCountEl) {
          const count = limitInfo.current || 0;
          listingsCountEl.textContent = count;
          listingsCountEl.setAttribute('data-count', count);
          listingsCountEl.style.display = count > 0 ? '' : 'none';
        }

        const { data: listings, error } = await supabaseClient
          .from('stone_listings')
          .select('*')
          .eq('user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        loadingEl.style.display = 'none';

        if (!listings || listings.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }

        gridEl.style.display = 'grid';
        gridEl.innerHTML = listings.map(listing => {
          const category = listing.category || 'countertops';
          const categoryLabels = { countertops: 'Countertops', tile: 'Tile', flooring: 'Flooring', cabinets: 'Cabinets', supplies: 'Supplies', other: 'Other' };
          const conditionLabels = { new: 'New', remnant: 'Remnant', overstock: 'Overstock', used: 'Used', refurbished: 'Refurb' };
          return `
          <div class="listing-card">
            <div class="listing-image">
              ${listing.image_url ? `<img src="${listing.image_url}" alt="${listing.title}">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>'}
              <span class="listing-category-badge ${category}">${categoryLabels[category] || category}</span>
              <span class="listing-status-badge ${listing.status}">${listing.status}</span>
            </div>
            <div class="listing-content">
              <div class="listing-title">${listing.title}</div>
              <div class="listing-stone">${listing.stone_name || listing.brand || ''}</div>
              <div class="listing-meta">
                ${listing.condition ? `<span class="listing-meta-item">${conditionLabels[listing.condition] || listing.condition}</span>` : ''}
                ${listing.dimensions ? `<span class="listing-meta-item">${listing.dimensions}</span>` : ''}
                ${listing.thickness ? `<span class="listing-meta-item">${listing.thickness}</span>` : ''}
              </div>
              <div class="listing-price ${listing.price === null ? 'contact' : ''}">
                ${listing.price !== null ? '$' + listing.price.toFixed(2) : 'Contact for price'}
              </div>
              <div class="listing-stats">
                <span>${listing.views || 0} views</span>
                <span>${listing.inquiries || 0} inquiries</span>
              </div>
              <div class="listing-actions">
                <button class="btn-edit" onclick="editListing('${listing.id}')">Edit</button>
                ${listing.status === 'active' ?
                  `<button class="btn-edit" onclick="markListingSold('${listing.id}')">Mark Sold</button>` :
                  `<button class="btn-edit" onclick="reactivateListing('${listing.id}')">Reactivate</button>`
                }
                <button class="btn-delete" onclick="deleteListing('${listing.id}')">Delete</button>
              </div>
            </div>
          </div>
        `}).join('');

        // Also load inquiries
        await loadMyInquiries();

      } catch (err) {
        console.error('Load listings error:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
      }
    }

    async function loadMyInquiries() {
      const loadingEl = document.getElementById('inquiries-loading');
      const emptyEl = document.getElementById('inquiries-empty');
      const listEl = document.getElementById('inquiries-list');
      const badgeEl = document.getElementById('inquiries-badge');

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) return;

        // Get all inquiries for user's listings
        const { data: inquiries, error } = await supabaseClient
          .from('listing_inquiries')
          .select(`
            *,
            stone_listings!inner(title, user_id)
          `)
          .eq('stone_listings.user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        loadingEl.style.display = 'none';

        if (error || !inquiries || inquiries.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }

        const unreadCount = inquiries.filter(i => !i.read).length;
        if (unreadCount > 0) {
          badgeEl.textContent = unreadCount;
          badgeEl.style.display = 'flex';
        } else {
          badgeEl.style.display = 'none';
        }

        listEl.style.display = 'block';
        listEl.innerHTML = inquiries.map(inquiry => `
          <div class="inquiry-item ${inquiry.read ? '' : 'unread'}" onclick="markInquiryRead('${inquiry.id}')">
            <div class="inquiry-header">
              <div>
                <div class="inquiry-listing">Re: ${inquiry.stone_listings.title}</div>
                <div class="inquiry-sender">${inquiry.sender_name}</div>
                <div class="inquiry-contact">
                  ${inquiry.sender_email}
                  ${inquiry.sender_phone ? `  ${inquiry.sender_phone}` : ''}
                </div>
              </div>
              <div class="inquiry-date">${new Date(inquiry.created_at).toLocaleDateString()}</div>
            </div>
            <div class="inquiry-message">${inquiry.message}</div>
            <div class="inquiry-actions" onclick="event.stopPropagation()">
              <a href="mailto:${inquiry.sender_email}?subject=Re: ${encodeURIComponent(inquiry.stone_listings.title)}" class="btn btn-email">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Reply via Email
              </a>
              <button class="btn btn-payment" onclick="openPaymentModal('${inquiry.id}', '${inquiry.sender_name.replace(/'/g, "\\'")}', '${inquiry.sender_email}', '${inquiry.stone_listings.title.replace(/'/g, "\\'")}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Send Payment Link
              </button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Load inquiries error:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
      }
    }

    async function markInquiryRead(id) {
      try {
        await supabaseClient
          .from('listing_inquiries')
          .update({ read: true })
          .eq('id', id);
        await loadMyInquiries();
      } catch (err) {
        console.error('Mark read error:', err);
      }
    }

    // Payment Request Modal Functions
    function openPaymentModal(inquiryId, customerName, customerEmail, listingTitle) {
      document.getElementById('payment-inquiry-id').value = inquiryId;
      document.getElementById('payment-customer-email').value = customerEmail;
      document.getElementById('payment-customer-name').value = customerName;
      document.getElementById('payment-recipient-name').textContent = customerName;
      document.getElementById('payment-recipient-email').textContent = customerEmail;
      document.getElementById('payment-description').value = listingTitle;
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-request-modal').style.display = 'flex';
    }

    function closePaymentModal() {
      document.getElementById('payment-request-modal').style.display = 'none';
    }

    async function sendPaymentRequest(event) {
      event.preventDefault();

      const sendBtn = document.getElementById('send-payment-btn');
      const originalText = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Creating...';

      try {
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const description = document.getElementById('payment-description').value;
        const customerEmail = document.getElementById('payment-customer-email').value;
        const customerName = document.getElementById('payment-customer-name').value;
        const note = document.getElementById('payment-note').value;

        // Create payment link via API
        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/payment-links', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: amount,
            description: description,
            customer_email: customerEmail
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create payment link');
        }

        // Send email with payment link
        const emailResponse = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: customerName,
            email: customerEmail,
            subject: `Payment Request for ${description}`,
            message: `
              <p>Hello ${customerName},</p>
              ${note ? `<p>${note}</p>` : '<p>Thank you for your interest in our stone remnant!</p>'}
              <p><strong>Amount Due:</strong> $${amount.toFixed(2)}</p>
              <p><strong>Description:</strong> ${description}</p>
              <p style="margin: 24px 0;">
                <a href="${result.payment_link.url}" style="display: inline-block; background: #f9cb00; color: #1a1a2e; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600;">Pay Now</a>
              </p>
              <p style="font-size: 13px; color: #666;">Or copy this link: ${result.payment_link.url}</p>
            `,
            source: 'marketplace-payment-request'
          })
        });

        closePaymentModal();
        showToast('Payment link sent to ' + customerEmail);

      } catch (err) {
        console.error('Payment request error:', err);
        alert('Failed to send payment request: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }

      return false;
    }

    function showToast(message) {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(16, 185, 129, 0.95);
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        z-index: 100000;
        animation: toastSlideUp 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function deleteListing(id) {
      if (!confirm('Are you sure you want to delete this listing?')) return;

      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .delete()
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Delete listing error:', err);
        alert('Failed to delete listing');
      }
    }

    async function markListingSold(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({ status: 'sold' })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Mark sold error:', err);
        alert('Failed to update listing');
      }
    }

    async function reactivateListing(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({
            status: 'active',
            expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString()
          })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Reactivate error:', err);
        alert('Failed to reactivate listing');
      }
    }

    function editListing(id) {
      // TODO: Implement edit listing modal
      alert('Edit functionality coming soon!');
    }
  </script>
<script src="/js/user-tracking.js"></script>
<script src="/js/site-search.js"></script>
</body>
</html>
