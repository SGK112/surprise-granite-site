<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Account | Surprise Granite</title>
  <meta name="description" content="Manage your Surprise Granite account, view leads, and access your dashboard."/>
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link href="/css/account/mobile-nav.css?v=20260119" rel="stylesheet"/>
  <script src="/js/config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3"></script>
  <script src="/js/supabase-init.js"></script>
  <script src="/js/sg-auth.js"></script>
  <script src="/js/auth-state.js"></script>
  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --border-light: rgba(255, 255, 255, 0.15);
      --success: #4dff82;
      --warning: #ffb84d;
      --error: #ff6b6b;
      --info: #4da6ff;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Unified Nav Offset - account for fixed header */
    :root {
      --unified-nav-height: 155px; /* Actual measured height of unified nav */
      --sidebar-width: 260px;
      --sidebar-collapsed-width: 72px;
    }

    @media (max-width: 991px) {
      :root {
        --unified-nav-height: 64px; /* Match unified-nav.css --nav-height-mobile */
      }
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text-primary);
      padding-top: var(--unified-nav-height); /* Space for fixed unified nav */
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: var(--unified-nav-height);
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      z-index: 100;
      transition: width 0.3s ease, transform 0.3s ease;
      /* Position context for toggle button */
      isolation: isolate;
    }

    /* Collapsed Sidebar State */
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
    }

    .sidebar.collapsed .sidebar-header {
      padding: 0 12px 24px;
    }

    .sidebar.collapsed .sidebar-logo-text,
    .sidebar.collapsed .sidebar-logo-sub {
      display: none;
    }

    .sidebar.collapsed .nav-section-title {
      opacity: 0;
      height: 0;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 12px;
    }

    .sidebar.collapsed .nav-item-text {
      display: none;
    }

    .sidebar.collapsed .nav-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      min-width: 16px;
      padding: 2px 5px;
      font-size: 9px;
    }

    .sidebar.collapsed .nav-item {
      position: relative;
    }

    .sidebar.collapsed .sidebar-footer {
      padding: 16px 12px;
    }

    .sidebar.collapsed .user-info,
    .sidebar.collapsed .logout-btn {
      display: none;
    }

    .sidebar.collapsed .user-menu {
      justify-content: center;
    }

    /* Sidebar Toggle Button */
    .sidebar > .sidebar-toggle,
    .sidebar-toggle {
      position: absolute !important;
      top: 50% !important;
      right: -14px !important;
      transform: translateY(-50%) !important;
      width: 28px !important;
      height: 28px !important;
      border-radius: 50% !important;
      background: var(--gold-primary) !important;
      border: 3px solid var(--dark-deep) !important;
      cursor: pointer !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      color: var(--dark-primary) !important;
      z-index: 200 !important;
      transition: all 0.3s ease !important;
      flex-shrink: 0 !important;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    }

    .sidebar-toggle:hover {
      transform: translateY(-50%) scale(1.15) !important;
      box-shadow: 0 4px 12px rgba(249, 203, 0, 0.4) !important;
    }

    .sidebar-toggle svg {
      width: 14px !important;
      height: 14px !important;
      transition: transform 0.3s ease !important;
      flex-shrink: 0 !important;
    }

    .sidebar.collapsed .sidebar-toggle svg {
      transform: rotate(180deg) !important;
    }

    /* Hide zero badges */
    .nav-badge.empty,
    .nav-badge[data-count="0"] {
      display: none;
    }

    .sidebar-header {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 24px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-primary);
    }

    .sidebar-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      color: var(--dark-primary);
    }

    .sidebar-logo-text {
      font-weight: 700;
      font-size: 16px;
    }

    .sidebar-logo-sub {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* FORCE SIDEBAR NAV VISIBILITY - Override any interference */
    .sidebar-nav,
    nav.sidebar-nav,
    .sidebar .sidebar-nav,
    #sidebar .sidebar-nav {
      flex: 1;
      padding: 0 12px;
      overflow-y: auto;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      height: auto !important;
      max-height: none !important;
      position: relative !important;
      transform: none !important;
      left: auto !important;
      top: auto !important;
    }

    .nav-section,
    .sidebar-nav .nav-section {
      margin-bottom: 24px;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .nav-item,
    .sidebar-nav .nav-item {
      display: flex !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(249, 203, 0, 0.1);
      color: var(--gold-primary);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      opacity: 0.7;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    .nav-badge {
      margin-left: auto;
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      font-size: 11px;
      font-weight: 800;
      padding: 3px 10px;
      border-radius: 100px;
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
      min-width: 20px;
      text-align: center;
    }

    .nav-badge.empty {
      background: var(--border-subtle);
      color: var(--text-muted);
      box-shadow: none;
      border: none;
    }

    /* Account type badges */
    .account-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .account-badge.homeowner {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .account-badge.pro {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
      box-shadow: 0 2px 8px rgba(249, 203, 0, 0.3);
    }

    .account-badge.pro::before {
      content: '\2605';
      font-size: 10px;
    }

    .account-badge.admin {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .account-badge.admin::before {
      content: '\2699';
      font-size: 10px;
    }

    /* Stat value styling */
    .stat-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-primary);
      text-shadow: 0 0 20px rgba(249, 203, 0, 0.3);
    }

    .stat-card:hover .stat-value {
      text-shadow: 0 0 30px rgba(249, 203, 0, 0.5);
    }

    .sidebar-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 16px;
      color: var(--dark-primary);
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 11px;
      color: var(--gold-primary);
      text-transform: uppercase;
    }

    .logout-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    /* Main Content */
    .main-content {
      margin-left: var(--sidebar-width);
      min-height: 100vh;
      transition: margin-left 0.3s ease;
      padding-top: 24px; /* Slight offset below sidebar logo */
    }

    body.sidebar-collapsed .main-content {
      margin-left: var(--sidebar-collapsed-width);
    }

    .topbar {
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 40px; /* Increased padding for better spacing */
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: var(--unified-nav-height); /* Stick below unified nav */
      z-index: 50;
    }

    .topbar-title {
      font-size: 20px;
      font-weight: 700;
    }

    .topbar-actions {
      display: flex;
      gap: 12px;
    }

    .mobile-menu-btn {
      display: none;
      background: none;
      border: none;
      color: var(--text-primary);
      padding: 8px;
      cursor: pointer;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .content-area {
      padding: 32px 40px; /* Match topbar horizontal padding */
      max-width: 1400px; /* Optimal reading width on large screens */
    }

    /* Page Sections */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
    }

    /* Cards - Standardized (14px radius, 24px padding) */
    .card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      overflow: hidden;
      margin-bottom: 24px;
    }

    .card-header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
    }

    .card-body {
      padding: 24px;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .action-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      padding: 20px;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .action-card:hover {
      background: rgba(249, 203, 0, 0.1);
      border-color: var(--gold-primary);
      transform: translateY(-2px);
    }

    /* Highlighted Action Card */
    .action-card.action-highlight {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.15) 0%, rgba(249, 203, 0, 0.08) 100%);
      border-color: var(--gold-primary);
    }

    .action-card.action-highlight:hover {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.25) 0%, rgba(249, 203, 0, 0.15) 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(249, 203, 0, 0.2);
    }

    .action-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
      flex-shrink: 0;
    }

    .action-icon.action-icon-gold {
      background: var(--gold-primary);
      color: #1a1a2e;
    }

    .action-icon svg {
      width: 24px;
      height: 24px;
    }

    .action-text h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .action-text p {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Stat Cards with icons */
    .stat-card {
      position: relative;
    }

    .stat-card.clickable {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .stat-card.clickable:hover {
      transform: translateY(-2px);
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.08);
    }

    .stat-icon {
      margin-bottom: 8px;
    }

    /* Profile Form */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 18px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      font-size: 15px;
      color: var(--text-primary);
      transition: all 0.3s;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
      background: var(--dark-elevated);
    }

    .form-group input::placeholder {
      color: var(--text-muted);
    }

    /* Fix select dropdowns to be visible */
    select,
    .form-section select,
    .estimate-line-item select,
    #create-estimate-modal select {
      background: var(--dark-elevated) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--border-subtle) !important;
      border-radius: 8px !important;
      padding: 10px 12px !important;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23f9cb00' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E") !important;
      background-repeat: no-repeat !important;
      background-position: right 12px center !important;
      padding-right: 36px !important;
    }

    select option,
    .form-section select option,
    #create-estimate-modal select option {
      background: #1e1e2d !important;
      color: #ffffff !important;
      padding: 12px !important;
    }

    select:focus {
      outline: none;
      border-color: var(--gold-primary) !important;
      box-shadow: 0 0 0 2px rgba(249, 203, 0, 0.2);
    }

    /* Estimate form specific input styling */
    #create-estimate-modal input,
    #create-estimate-modal textarea {
      background: var(--dark-elevated) !important;
      border: 1px solid var(--border-subtle) !important;
      color: var(--text-primary) !important;
    }

    #create-estimate-modal input:focus,
    #create-estimate-modal textarea:focus {
      border-color: var(--gold-primary) !important;
      box-shadow: 0 0 0 2px rgba(249, 203, 0, 0.2);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    /* Saved Floors Grid */
    .saved-floors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
    }

    .saved-floor-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .saved-floor-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .saved-floor-image {
      width: 100%;
      height: 140px;
      object-fit: cover;
    }

    .saved-floor-content {
      padding: 12px;
    }

    .saved-floor-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .saved-floor-material {
      font-size: 11px;
      color: var(--primary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .saved-floor-specs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .saved-floor-spec {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 3px 8px;
      border-radius: 4px;
    }

    .saved-floor-actions {
      display: flex;
      gap: 8px;
    }

    .saved-floor-actions a,
    .saved-floor-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .saved-floor-view {
      background: var(--primary);
      color: var(--dark);
    }

    .saved-floor-remove {
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    .saved-floor-remove:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }

    /* My Designs Grid */
    .designs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .design-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .design-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    .design-preview {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #1a1a2e 0%, #2d2d44 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .design-preview svg {
      width: 48px;
      height: 48px;
      color: var(--text-muted);
      opacity: 0.5;
    }

    .design-preview-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .design-preview-badge.shared {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .design-preview-badge.private {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .design-content {
      padding: 16px;
    }

    .design-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .design-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .design-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .design-actions {
      display: flex;
      gap: 8px;
    }

    .design-actions button,
    .design-actions a {
      flex: 1;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .design-btn-open {
      background: var(--primary);
      color: var(--dark);
    }

    .design-btn-open:hover {
      background: var(--primary-hover);
    }

    .design-btn-share {
      background: transparent;
      border: 1px solid var(--primary) !important;
      color: var(--primary);
    }

    .design-btn-share:hover {
      background: rgba(249, 203, 0, 0.1);
    }

    .design-btn-delete {
      background: transparent;
      border: 1px solid var(--border-subtle) !important;
      color: var(--text-secondary);
      flex: 0 0 auto;
      padding: 10px 12px;
    }

    .design-btn-delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444 !important;
      color: #ef4444;
    }

    /* Quote Request Modal */
    .quote-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .quote-modal-content {
      background: var(--dark-elevated);
      border-radius: 16px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .quote-modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .quote-modal-body {
      padding: 20px;
    }

    .quote-items-list {
      margin-bottom: 20px;
    }

    .quote-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .quote-item img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }

    .quote-item-info {
      flex: 1;
    }

    .quote-item-title {
      font-size: 14px;
      font-weight: 600;
    }

    .quote-item-material {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Leads Table */
    .table-container {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .table-title {
      font-size: 16px;
      font-weight: 700;
    }

    .table-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-subtle);
      background: transparent;
      color: var(--text-secondary);
    }

    .filter-btn:hover {
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .tab-btn {
      padding: 10px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .tab-btn:hover {
      color: var(--text-primary);
    }

    .tab-btn.active {
      color: var(--gold-primary);
      border-bottom-color: var(--gold-primary);
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 8px 16px;
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 14px;
      width: 200px;
    }

    .search-box input::placeholder {
      color: var(--text-muted);
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px 24px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      border-bottom: 1px solid var(--border-subtle);
    }

    td {
      padding: 16px 24px;
      font-size: 14px;
      border-bottom: 1px solid var(--border-subtle);
      vertical-align: middle;
    }

    tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .lead-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .lead-email {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-project {
      display: inline-block;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: capitalize;
      white-space: nowrap;
      letter-spacing: 0.3px;
      line-height: 1.2;
      vertical-align: middle;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Job Status Styles */
    .status-badge.job-new { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-badge.job-new::before { background: #f59e0b; }

    .status-badge.job-reviewing { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .status-badge.job-reviewing::before { background: #f59e0b; }

    .status-badge.job-material_ordered { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .status-badge.job-material_ordered::before { background: #06b6d4; }

    .status-badge.job-material_received { background: rgba(6, 182, 212, 0.15); color: #06b6d4; }
    .status-badge.job-material_received::before { background: #06b6d4; }

    .status-badge.job-assigned { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-badge.job-assigned::before { background: #3b82f6; }

    .status-badge.job-scheduled { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-badge.job-scheduled::before { background: #3b82f6; }

    .status-badge.job-measured { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .status-badge.job-measured::before { background: #8b5cf6; }

    .status-badge.job-in_production { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }
    .status-badge.job-in_production::before { background: #8b5cf6; }

    .status-badge.job-ready { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-badge.job-ready::before { background: #10b981; }

    .status-badge.job-installing { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-badge.job-installing::before { background: #10b981; }

    .status-badge.job-completed { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-badge.job-completed::before { background: #22c55e; }

    .status-badge.job-on_hold { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-badge.job-on_hold::before { background: #6b7280; }

    .status-badge.job-cancelled { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-badge.job-cancelled::before { background: #ef4444; }

    .status-new { background: rgba(77, 166, 255, 0.15); color: var(--info); }
    .status-new::before { background: var(--info); }

    .status-contacted { background: rgba(255, 184, 77, 0.15); color: var(--warning); }
    .status-contacted::before { background: var(--warning); }

    .status-qualified { background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); }
    .status-qualified::before { background: var(--gold-primary); }

    .status-quoted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .status-quoted::before { background: #a855f7; }

    .status-won { background: rgba(77, 255, 130, 0.15); color: var(--success); }
    .status-won::before { background: var(--success); }

    .status-lost { background: rgba(255, 107, 107, 0.15); color: var(--error); }
    .status-lost::before { background: var(--error); }

    .status-archived { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-archived::before { background: #6b7280; }

    /* Estimate statuses */
    .status-draft { background: rgba(156, 163, 175, 0.15); color: #9ca3af; }
    .status-draft::before { background: #9ca3af; }

    .status-sent { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-sent::before { background: #3b82f6; }

    .status-approved { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .status-approved::before { background: #22c55e; }

    .status-rejected { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
    .status-rejected::before { background: #ef4444; }

    .status-converted { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .status-converted::before { background: #a855f7; }

    .lead-date {
      font-size: 13px;
      color: var(--text-muted);
    }

    .lead-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      text-decoration: none;
    }

    .action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 18px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    /* Coming Soon */
    .coming-soon {
      text-align: center;
      padding: 80px 24px;
    }

    .coming-soon-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 24px;
      border-radius: 20px;
      background: rgba(249, 203, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold-primary);
    }

    .coming-soon-icon svg {
      width: 40px;
      height: 40px;
    }

    .coming-soon h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .coming-soon p {
      color: var(--text-muted);
      max-width: 400px;
      margin: 0 auto;
    }

    /* Modal - base styles, visibility controlled by .active class */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }

    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: none;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 107, 107, 0.1);
      color: var(--error);
    }

    .modal-body {
      padding: 24px;
    }

    .detail-row {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      width: 120px;
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-value {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    /* Invoice Template Selector */
    .template-selector {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .template-option {
      cursor: pointer;
    }

    .template-option input {
      display: none;
    }

    .template-preview {
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s;
      background: var(--dark-surface);
    }

    .template-option input:checked + .template-preview {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.1);
    }

    .template-preview:hover {
      border-color: var(--border-light);
    }

    .template-header-preview {
      height: 24px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .template-body-preview {
      height: 40px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .classic-preview .template-header-preview {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
    }
    .classic-preview .template-body-preview {
      background: #f4f4f4;
    }

    .modern-preview .template-header-preview {
      background: linear-gradient(90deg, #000, #333);
    }
    .modern-preview .template-body-preview {
      background: #ffffff;
      border: 1px solid #eee;
    }

    .premium-preview .template-header-preview {
      background: linear-gradient(135deg, #0a0a12, #12121a);
    }
    .premium-preview .template-body-preview {
      background: linear-gradient(135deg, #f9cb00, #d4a800);
    }

    .template-name {
      display: block;
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .template-desc {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
    }

    @media (max-width: 600px) {
      .template-selector {
        grid-template-columns: 1fr;
      }
    }

    /* Template Preview Modal */
    .template-tabs {
      display: flex;
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
    }

    .template-tab {
      flex: 1;
      padding: 20px;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }

    .template-tab:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .template-tab.active {
      background: rgba(249, 203, 0, 0.1);
      border-bottom-color: var(--gold-primary);
    }

    .template-tab .tab-icon {
      display: block;
      font-size: 24px;
      margin-bottom: 8px;
    }

    .template-tab .tab-label {
      display: block;
      font-weight: 700;
      font-size: 14px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .template-tab .tab-desc {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
    }

    .template-tab.active .tab-label {
      color: var(--gold-primary);
    }

    .template-preview-container {
      background: #888;
      height: 500px;
      overflow: hidden;
    }

    .template-preview-frame {
      width: 100%;
      height: 100%;
    }

    .template-preview-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #f4f4f4;
    }

    @media (max-width: 768px) {
      .template-tabs {
        flex-direction: column;
      }

      .template-tab {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        text-align: left;
      }

      .template-tab .tab-icon {
        margin-bottom: 0;
        font-size: 20px;
      }

      .template-preview-container {
        height: 400px;
      }
    }

    .status-select {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .status-select:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    /* Auth Screens */
    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--dark-deep);
      padding: 20px;
    }

    .auth-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-light);
      border-radius: 24px;
      padding: 48px 40px;
      width: 100%;
      max-width: 440px;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-weight: 800;
      font-size: 24px;
      color: var(--dark-primary);
    }

    .auth-header h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: var(--text-muted);
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 24px;
    }

    .auth-tab {
      flex: 1;
      padding: 10px;
      text-align: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: var(--text-muted);
      transition: all 0.2s;
    }

    .auth-tab.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
    }

    .auth-message {
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .auth-message.visible {
      display: block;
    }

    .auth-message.error {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.3);
      color: var(--error);
    }

    .auth-message.success {
      background: rgba(77, 255, 130, 0.1);
      border: 1px solid rgba(77, 255, 130, 0.3);
      color: var(--success);
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .auth-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 700;
      color: var(--dark-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .auth-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(249, 203, 0, 0.3);
    }

    .auth-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .auth-divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 13px;
    }

    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-subtle);
    }

    .auth-divider span {
      padding: 0 12px;
    }

    .btn-google {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      color: #3c4043;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-google:hover {
      background: #f8f9fa;
      border-color: #c6c6c6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .btn-google:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-google svg {
      flex-shrink: 0;
    }

    /* Signup Steps */
    .signup-step {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .step-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .step-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .step-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin: 0;
    }

    .step-back {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      padding: 8px 0;
      margin-bottom: 16px;
      transition: color 0.2s;
    }

    .step-back:hover {
      color: var(--gold-primary);
    }

    .step-back svg {
      color: inherit;
    }

    /* Account Type Cards */
    .account-type-grid {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .account-type-card {
      position: relative;
      background: var(--dark-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .account-type-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .account-type-card.selected {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .account-type-card.selected::before {
      content: '';
      position: absolute;
      top: 12px;
      right: 70px;
      width: 24px;
      height: 24px;
      background: var(--gold-primary);
      border-radius: 50%;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='%231a1a2e'%3E%3Cpath fill-rule='evenodd' d='M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z' clip-rule='evenodd'/%3E%3C/svg%3E");
      background-size: 16px;
      background-position: center;
      background-repeat: no-repeat;
    }

    .type-icon {
      width: 48px;
      height: 48px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    .type-icon svg {
      width: 28px;
      height: 28px;
      color: var(--text-secondary);
    }

    .type-icon.pro {
      background: rgba(249, 203, 0, 0.1);
    }

    .type-icon.pro svg {
      color: var(--gold-primary);
    }

    .type-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .type-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
      line-height: 1.4;
    }

    .type-features {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .type-features li {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .type-features .check-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      color: var(--success);
    }

    .type-features .check-icon.gold {
      color: var(--gold-primary);
    }

    .type-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .type-badge.free {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .type-badge.pro {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
    }

    /* Signup Terms */
    .signup-terms {
      margin-bottom: 20px;
    }

    .checkbox-label {
      display: flex !important;
      align-items: center !important;
      gap: 12px !important;
      cursor: pointer;
      font-size: 14px !important;
      color: var(--text-secondary) !important;
      line-height: 1.5;
      text-transform: none !important;
      margin-bottom: 0 !important;
    }

    .checkbox-label input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
      accent-color: var(--gold-primary);
      flex-shrink: 0;
      cursor: pointer;
    }

    .checkbox-label span {
      text-transform: none !important;
      font-weight: 400 !important;
    }

    .checkbox-label a {
      color: var(--gold-primary);
      text-decoration: none;
    }

    .checkbox-label a:hover {
      text-decoration: underline;
    }

    /* Pro Note */
    .pro-note {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      background: rgba(249, 203, 0, 0.1);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 10px;
      padding: 12px 14px;
      margin-top: 16px;
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .pro-note svg {
      color: var(--gold-primary);
      flex-shrink: 0;
      margin-top: 1px;
    }

    /* Responsive adjustments */
    @media (min-width: 600px) {
      .account-type-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .account-type-card {
        padding: 24px 20px;
      }
    }

    /* Loading */
    .loading-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 20px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .spin {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    /* Product Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .product-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: var(--border-light);
      transform: translateY(-2px);
    }

    .product-image {
      height: 180px;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
      overflow: hidden;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .product-placeholder svg {
      width: 48px;
      height: 48px;
    }

    .product-info {
      padding: 16px;
    }

    .product-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .product-status.status-active {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .product-status.status-draft {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .product-status.status-sold {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .product-category {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .product-price {
      font-size: 20px;
      font-weight: 700;
      color: var(--gold-primary);
    }

    .product-dims {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .product-actions {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      border-top: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.02);
    }

    /* Calendar Styles */
    .calendar-container {
      background: var(--dark-elevated);
      border-radius: 0 0 12px 12px;
      overflow: hidden;
    }

    .calendar-header-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: var(--dark-surface);
      border-bottom: 1px solid var(--border-subtle);
    }

    .calendar-header-cell {
      padding: 16px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
    }

    .calendar-day {
      min-height: 120px;
      padding: 8px;
      border-right: 1px solid var(--border-subtle);
      border-bottom: 1px solid var(--border-subtle);
      background: var(--dark-elevated);
      transition: background 0.2s;
      cursor: pointer;
      position: relative;
    }

    .calendar-day:nth-child(7n) {
      border-right: none;
    }

    .calendar-day:hover {
      background: var(--dark-surface);
    }

    .calendar-day.other-month {
      background: rgba(0, 0, 0, 0.2);
      opacity: 0.5;
    }

    .calendar-day.today {
      background: rgba(212, 175, 55, 0.1);
    }

    .calendar-day.today .calendar-day-number {
      background: var(--gold-primary);
      color: var(--dark-bg);
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .calendar-events {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .calendar-event {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }

    .calendar-event:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .calendar-event.job {
      background: rgba(59, 130, 246, 0.2);
      color: #60a5fa;
      border-left: 3px solid #3b82f6;
    }

    .calendar-event.install {
      background: rgba(16, 185, 129, 0.2);
      color: #34d399;
      border-left: 3px solid #10b981;
    }

    .calendar-event.measure {
      background: rgba(245, 158, 11, 0.2);
      color: #fbbf24;
      border-left: 3px solid #f59e0b;
    }

    .calendar-event.production {
      background: rgba(139, 92, 246, 0.2);
      color: #a78bfa;
      border-left: 3px solid #8b5cf6;
    }

    .calendar-event-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    /* Trust Score Badge */
    .trust-score-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 20px;
      background: linear-gradient(135deg, var(--dark-elevated) 0%, var(--dark-surface) 100%);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      min-width: 80px;
    }

    .trust-score-badge.verified {
      border-color: var(--gold-primary);
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.1) 0%, var(--dark-surface) 100%);
    }

    .trust-score-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--gold-primary);
      line-height: 1;
    }

    .trust-score-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      margin-top: 4px;
    }

    /* Verification Checklist Item */
    .verification-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--dark-elevated);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }

    .verification-item.completed {
      border-color: rgba(34, 197, 94, 0.3);
      background: rgba(34, 197, 94, 0.05);
    }

    .verification-item.pending {
      border-color: rgba(245, 158, 11, 0.3);
      background: rgba(245, 158, 11, 0.05);
    }

    .verification-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .verification-icon.completed {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .verification-icon.pending {
      background: rgba(107, 114, 128, 0.2);
      color: #6b7280;
    }

    .verification-item-text {
      flex: 1;
    }

    .verification-item-title {
      font-weight: 500;
      font-size: 13px;
    }

    .verification-item-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .verification-item-points {
      font-size: 11px;
      font-weight: 600;
      color: var(--gold-primary);
    }

    /* Document Card */
    .document-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--dark-elevated);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 8px;
    }

    .document-card .doc-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--dark-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .document-card .doc-info {
      flex: 1;
      min-width: 0;
    }

    .document-card .doc-name {
      font-weight: 500;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .document-card .doc-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .document-card .doc-status {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }

    .document-card .doc-status.approved {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .document-card .doc-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: #f59e0b;
    }

    .document-card .doc-status.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .calendar-event-more {
      font-size: 10px;
      color: var(--text-muted);
      padding: 2px 4px;
      cursor: pointer;
    }

    .calendar-event-more:hover {
      color: var(--gold-primary);
    }

    /* Upcoming Events List */
    .upcoming-event-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.2s;
      cursor: pointer;
    }

    .upcoming-event-item:last-child {
      border-bottom: none;
    }

    .upcoming-event-item:hover {
      background: var(--dark-surface);
    }

    .upcoming-event-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-width: 60px;
      padding: 8px 12px;
      background: var(--dark-surface);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
    }

    .upcoming-event-date .day {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold-primary);
      line-height: 1;
    }

    .upcoming-event-date .month {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
    }

    .upcoming-event-info {
      flex: 1;
    }

    .upcoming-event-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .upcoming-event-details {
      font-size: 13px;
      color: var(--text-muted);
    }

    .upcoming-event-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    /* Wallet Balance Cards */
    .wallet-balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .balance-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .balance-card.available::before {
      background: linear-gradient(90deg, var(--success), #2dd4bf);
    }

    .balance-card.pending::before {
      background: linear-gradient(90deg, var(--warning), #fb923c);
    }

    .balance-card.total::before {
      background: linear-gradient(90deg, var(--gold-primary), var(--gold-dark));
    }

    .balance-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .balance-amount {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .balance-card.available .balance-amount {
      color: var(--success);
    }

    .balance-card.pending .balance-amount {
      color: var(--warning);
    }

    .balance-card.total .balance-amount {
      color: var(--gold-primary);
    }

    .balance-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .transaction-row:last-child {
      border-bottom: none;
    }

    .transaction-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .transaction-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .transaction-icon.income {
      background: rgba(77, 255, 130, 0.15);
      color: var(--success);
    }

    .transaction-icon.payout {
      background: rgba(77, 166, 255, 0.15);
      color: var(--info);
    }

    .transaction-icon.fee {
      background: rgba(255, 107, 107, 0.15);
      color: var(--error);
    }

    .transaction-details h4 {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .transaction-details p {
      font-size: 12px;
      color: var(--text-muted);
    }

    .transaction-amount {
      text-align: right;
    }

    .transaction-amount .amount {
      font-size: 16px;
      font-weight: 600;
    }

    .transaction-amount .amount.positive {
      color: var(--success);
    }

    .transaction-amount .amount.negative {
      color: var(--error);
    }

    .transaction-amount .date {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Fees Grid */
    .fees-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .fee-item {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
    }

    .fee-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .fee-header svg {
      color: var(--gold-primary);
    }

    .fee-rate {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .fee-desc {
      font-size: 12px;
      color: var(--text-muted);
    }

    .fee-note {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: rgba(249, 203, 0, 0.05);
      border: 1px solid rgba(249, 203, 0, 0.2);
      border-radius: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .fee-note svg {
      flex-shrink: 0;
      color: var(--gold-primary);
      margin-top: 2px;
    }

    .fee-note strong {
      color: var(--text-primary);
    }

    /* Responsive */
    @media (max-width: 991px) {
      .sidebar {
        transform: translateX(-100%);
        top: var(--unified-nav-height);
        width: var(--sidebar-width); /* Always full width on mobile */
      }

      .sidebar.open {
        transform: translateX(0);
      }

      /* Disable collapsed state on mobile */
      .sidebar.collapsed {
        width: var(--sidebar-width);
      }

      .sidebar.collapsed .sidebar-logo-text,
      .sidebar.collapsed .sidebar-logo-sub,
      .sidebar.collapsed .nav-section-title,
      .sidebar.collapsed .nav-item-text,
      .sidebar.collapsed .user-info,
      .sidebar.collapsed .logout-btn {
        display: block;
        opacity: 1;
        height: auto;
      }

      .sidebar.collapsed .nav-item {
        justify-content: flex-start;
        padding: 12px 16px;
      }

      .sidebar.collapsed .nav-badge {
        position: static;
        min-width: 20px;
        padding: 3px 10px;
        font-size: 11px;
      }

      /* Hide the collapse toggle on mobile */
      .sidebar-toggle {
        display: none;
      }

      .main-content {
        margin-left: 0;
      }

      body.sidebar-collapsed .main-content {
        margin-left: 0;
      }

      .mobile-menu-btn {
        display: block;
      }

      .sidebar-overlay {
        display: none;
        position: fixed;
        top: var(--unified-nav-height);
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .sidebar-overlay.active {
        display: block;
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .content-area {
        padding: 20px;
      }

      .topbar {
        padding: 16px 20px;
      }

      .auth-card {
        padding: 32px 24px;
      }

      th, td {
        padding: 12px 16px;
      }

      /* Estimate Modal Mobile Optimization */
      #create-estimate-modal .modal-content {
        max-width: 100%;
        max-height: 100vh;
        max-height: 100dvh;
        border-radius: 0;
        margin: 0;
      }

      #create-estimate-modal .modal-content > div[style*="grid-template-columns: 1fr 1fr"] {
        display: flex !important;
        flex-direction: column !important;
      }

      #create-estimate-modal .form-section {
        border-right: none !important;
        border-bottom: 1px solid var(--border-subtle);
        padding: 16px !important;
      }

      #create-estimate-modal .form-section:last-child {
        border-bottom: none;
      }

      #create-estimate-modal .modal-header {
        padding: 16px !important;
        position: sticky;
        top: 0;
        z-index: 10;
        background: var(--dark-surface);
      }

      #create-estimate-modal .modal-header > div {
        gap: 12px !important;
      }

      #create-estimate-modal .modal-header > div > div:first-child {
        width: 40px !important;
        height: 40px !important;
      }

      #create-estimate-modal .modal-title {
        font-size: 18px !important;
      }

      #create-estimate-modal .modal-footer {
        position: sticky;
        bottom: 0;
        background: var(--dark-surface);
        padding: 16px !important;
        border-top: 1px solid var(--border-subtle);
        flex-direction: column;
        gap: 8px !important;
      }

      #create-estimate-modal .modal-footer .btn {
        width: 100%;
        justify-content: center;
        padding: 14px !important;
      }

      /* Line items table mobile */
      #estimate-line-items {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .estimate-line-item {
        flex-wrap: wrap !important;
        gap: 8px !important;
        padding: 12px !important;
      }

      .estimate-line-item > div {
        flex: 1 1 45% !important;
        min-width: 100px !important;
      }

      .estimate-line-item > div:first-child {
        flex: 1 1 100% !important;
      }

      /* Invoice modal mobile */
      #invoice-modal .invoice-item .form-row {
        flex-direction: column;
      }

      #invoice-modal .invoice-item .form-group {
        flex: 1 1 100% !important;
      }

      /* General modal mobile improvements */
      .modal-overlay .modal,
      .modal-overlay .modal-content {
        max-width: 100% !important;
        max-height: 100vh !important;
        max-height: 100dvh !important;
        border-radius: 16px 16px 0 0 !important;
        margin: 0 !important;
        margin-top: auto !important;
      }

      .modal-overlay {
        align-items: flex-end !important;
      }

      .modal-overlay .modal-header {
        position: sticky;
        top: 0;
        background: var(--dark-surface);
        z-index: 5;
        padding: 16px 20px !important;
      }

      .modal-overlay .modal-footer {
        position: sticky;
        bottom: 0;
        background: var(--dark-surface);
        z-index: 5;
        padding: 16px 20px !important;
        padding-bottom: calc(16px + env(safe-area-inset-bottom)) !important;
      }

      .modal-overlay .modal-body {
        padding: 16px 20px !important;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Touch-friendly inputs */
      .modal-overlay input,
      .modal-overlay select,
      .modal-overlay textarea {
        min-height: 48px;
        font-size: 16px !important;
      }

      .modal-overlay .btn {
        min-height: 48px;
        font-size: 15px;
      }
    }

    /* ============================================
       LISTINGS GRID & CARDS
       ============================================ */
    .listings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .listing-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .listing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    .listing-image {
      position: relative;
      width: 100%;
      height: 160px;
      background: var(--dark-surface);
    }

    .listing-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .listing-status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .listing-status-badge.active {
      background: rgba(77, 255, 130, 0.2);
      color: var(--success);
    }

    .listing-status-badge.sold {
      background: rgba(255, 71, 87, 0.2);
      color: var(--error);
    }

    .listing-status-badge.expired {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .listing-content {
      padding: 16px;
    }

    .listing-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .listing-stone {
      font-size: 12px;
      color: var(--gold-primary);
      margin-bottom: 10px;
    }

    .listing-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .listing-meta-item {
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .listing-price {
      font-size: 18px;
      font-weight: 700;
      color: var(--gold-primary);
      margin-bottom: 12px;
    }

    .listing-price.contact {
      font-size: 13px;
      color: var(--text-muted);
    }

    .listing-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .listing-actions {
      display: flex;
      gap: 8px;
    }

    .listing-actions button {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .listing-actions .btn-edit {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
    }

    .listing-actions .btn-edit:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .listing-actions .btn-delete {
      background: transparent;
      border: 1px solid var(--error);
      color: var(--error);
    }

    .listing-actions .btn-delete:hover {
      background: rgba(255, 71, 87, 0.1);
    }

    /* Listing Category Grid */
    .listing-category-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 8px;
    }

    @media (max-width: 600px) {
      .listing-category-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .listing-category-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px 12px;
      background: var(--dark-elevated);
      border: 2px solid var(--border-subtle);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      gap: 6px;
    }

    .listing-category-option:hover {
      border-color: var(--text-muted);
      background: var(--dark-surface);
    }

    .listing-category-option.selected {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.1);
    }

    .listing-category-option svg {
      color: var(--text-muted);
      transition: color 0.2s;
    }

    .listing-category-option.selected svg {
      color: var(--gold-primary);
    }

    .listing-category-option span {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .listing-category-option small {
      font-size: 10px;
      color: var(--text-muted);
      line-height: 1.2;
    }

    .listing-category-option.selected span {
      color: var(--gold-primary);
    }

    /* Category badge on listing cards */
    .listing-category-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      background: rgba(0, 0, 0, 0.7);
      color: var(--text-primary);
      backdrop-filter: blur(4px);
    }

    .listing-category-badge.countertops { color: #60a5fa; }
    .listing-category-badge.tile { color: #f472b6; }
    .listing-category-badge.flooring { color: #4ade80; }
    .listing-category-badge.cabinets { color: #fb923c; }
    .listing-category-badge.supplies { color: #a78bfa; }
    .listing-category-badge.other { color: #94a3b8; }

    /* ============================================
       DESIGN TOOLS GRID
       ============================================ */
    .tools-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .tools-grid.calculators-grid {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }

    .tool-card {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 20px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .tool-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border-color: var(--border-light);
    }

    .tool-card.featured {
      background: linear-gradient(135deg, rgba(249, 203, 0, 0.1) 0%, rgba(249, 203, 0, 0.05) 100%);
      border-color: rgba(249, 203, 0, 0.3);
    }

    .tool-card.featured:hover {
      border-color: var(--gold-primary);
      box-shadow: 0 8px 24px rgba(249, 203, 0, 0.15);
    }

    .tool-card.calculator {
      padding: 16px;
    }

    .tool-icon {
      width: 48px;
      height: 48px;
      min-width: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }

    .tool-icon.small {
      width: 40px;
      height: 40px;
      min-width: 40px;
    }

    .tool-icon svg {
      width: 26px;
      height: 26px;
      color: var(--gold-primary);
    }

    .tool-icon.small svg {
      width: 22px;
      height: 22px;
      color: var(--text-secondary);
    }

    .tool-card.featured .tool-icon {
      background: rgba(249, 203, 0, 0.15);
    }

    .tool-info {
      flex: 1;
      min-width: 0;
    }

    .tool-info h4 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px 0;
    }

    .tool-info p {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
      line-height: 1.4;
    }

    .tool-badge {
      display: inline-block;
      margin-top: 8px;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .tool-badge.featured {
      background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
      color: var(--dark-primary);
    }

    @media (max-width: 600px) {
      .tools-grid {
        grid-template-columns: 1fr;
      }
      .tools-grid.calculators-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Inquiry Items */
    .inquiry-item {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: background 0.2s;
    }

    .inquiry-item.unread {
      border-left: 3px solid var(--gold-primary);
    }

    .inquiry-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .inquiry-listing {
      font-size: 13px;
      color: var(--gold-primary);
      margin-bottom: 4px;
    }

    .inquiry-sender {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .inquiry-contact {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .inquiry-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    .inquiry-message {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .inquiry-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
    }

    .inquiry-actions .btn {
      padding: 8px 14px;
      font-size: 12px;
    }

    .inquiry-actions .btn-email {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .inquiry-actions .btn-email:hover {
      background: rgba(59, 130, 246, 0.25);
    }

    .inquiry-actions .btn-payment {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .inquiry-actions .btn-payment:hover {
      background: rgba(16, 185, 129, 0.25);
    }

    /* Payment Request Modal */
    .payment-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }

    .payment-modal-content {
      background: var(--dark-surface);
      border-radius: 16px;
      max-width: 420px;
      width: 100%;
      overflow: hidden;
    }

    .payment-modal-header {
      background: linear-gradient(135deg, var(--dark-primary) 0%, #16213e 100%);
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .payment-modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: var(--text-primary);
    }

    .payment-modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 24px;
      padding: 4px;
    }

    .payment-modal-body {
      padding: 24px;
    }

    .payment-modal-body .form-group {
      margin-bottom: 16px;
    }

    .payment-modal-body label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .payment-modal-body input,
    .payment-modal-body textarea {
      width: 100%;
      padding: 12px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .payment-modal-body input:focus,
    .payment-modal-body textarea:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    .payment-modal-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
    }

    .payment-modal-info p {
      margin: 0;
      font-size: 12px;
      color: #60a5fa;
    }

    .payment-modal-footer {
      padding: 16px 24px;
      background: var(--dark-elevated);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    /* Create Listing Modal - Standardized styles */
    .modal-content {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 14px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      background: var(--dark-surface);
      z-index: 1;
      gap: 12px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .modal-body {
      padding: 24px;
    }

    .form-section {
      margin-bottom: 24px;
    }

    /* Contact Preferences Checkboxes */
    .contact-pref-item {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      gap: 12px !important;
      margin-bottom: 12px !important;
      cursor: pointer !important;
    }
    .contact-pref-item input[type="checkbox"] {
      width: 20px !important;
      height: 20px !important;
      min-width: 20px !important;
      padding: 0 !important;
      margin: 0 !important;
      accent-color: var(--gold-primary) !important;
      flex-shrink: 0 !important;
    }
    .contact-pref-item span {
      font-size: 14px !important;
      color: #ccc !important;
      text-transform: none !important;
      font-weight: 400 !important;
      display: inline !important;
    }

    .form-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gold-primary);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Stone Autocomplete */
    .stone-autocomplete {
      position: relative;
    }

    .stone-autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }

    .stone-autocomplete-results.active {
      display: block;
    }

    .stone-result-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .stone-result-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .stone-result-thumb {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
    }

    .stone-result-info {
      flex: 1;
    }

    .stone-result-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .stone-result-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Image Upload Grid */
    .image-upload-section {
      margin-top: 8px;
    }

    .image-upload-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 600px) {
      .image-upload-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .image-upload-slot {
      position: relative;
      aspect-ratio: 1;
      border-radius: 12px;
      overflow: hidden;
      background: var(--dark-elevated);
      border: 2px dashed var(--border-light);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .image-upload-slot:first-child {
      aspect-ratio: 4/3;
    }

    @media (max-width: 600px) {
      .image-upload-slot:first-child {
        grid-column: span 2;
      }
    }

    .image-upload-slot:hover {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .image-upload-slot.has-image {
      border-style: solid;
      border-color: var(--gold-primary);
    }

    .upload-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-muted);
    }

    .upload-placeholder svg {
      color: var(--gold-primary);
      opacity: 0.7;
    }

    .upload-placeholder span {
      font-size: 12px;
      font-weight: 500;
    }

    .upload-preview {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .remove-image-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.95);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.2s;
      z-index: 10;
    }

    .remove-image-btn:hover {
      background: #ff4747;
      transform: scale(1.1);
    }

    .upload-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(0, 0, 0, 0.5);
    }

    .upload-progress-bar {
      height: 100%;
      background: var(--gold-primary);
      width: 0%;
      transition: width 0.3s ease;
    }

    /* Legacy image preview for backward compatibility */
    .image-preview-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }

    .image-preview-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: var(--dark-elevated);
      border: 1px dashed var(--border-light);
    }

    .image-preview-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-preview-item .remove-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255, 71, 87, 0.9);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
  </style>
<!-- Unified Navigation -->
<link rel="stylesheet" href="/css/unified-nav.css?v=20260112b">
<link rel="stylesheet" href="/css/account/context-menu.css?v=20260119">
<link rel="stylesheet" href="/css/account/dashboard-modern.css?v=20260119">
<script defer src="/js/unified-nav.js?v=20260112b"></script>

</head>
<body>
  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f9cb00, #cca600); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: #1a1a2e; margin: 0 auto 16px;">SG</div>
      <h1 style="color: #f9cb00; font-size: 24px; font-weight: 700; margin: 0;">Surprise Granite</h1>
      <p style="color: rgba(255,255,255,0.75); font-size: 14px; margin: 4px 0 0;">Client Portal</p>
    </div>
    <div class="spinner"></div>
    <p style="color: rgba(255,255,255,0.75);">Loading your account...</p>
  </div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="auth-screen" style="display: none;">
    <div class="auth-card">
      <div class="auth-header">
        <div class="auth-logo">SG</div>
        <h1 id="auth-title">Welcome Back</h1>
        <p id="auth-subtitle">Sign in to access your account</p>
      </div>

      <div class="auth-tabs">
        <button class="auth-tab active" onclick="showAuthTab('login')">Sign In</button>
        <button class="auth-tab" onclick="showAuthTab('signup')">Create Account</button>
      </div>

      <div id="auth-message" class="auth-message"></div>

      <!-- Login Form -->
      <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" required placeholder="you@example.com"/>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" required placeholder="Enter your password"/>
        </div>
        <button type="submit" class="auth-submit" id="login-btn">Sign In</button>

        <div class="auth-divider">
          <span>or continue with</span>
        </div>

        <button type="button" class="btn-google" onclick="handleGoogleLogin()">
          <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </button>
      </form>

      <!-- Signup Form -->
      <form id="signup-form" class="auth-form" onsubmit="handleSignup(event)">
        <!-- Step 1: Account Type Selection -->
        <div class="signup-step" id="signup-step-1">
          <div class="step-header">
            <h3 class="step-title">Choose Your Account Type</h3>
            <p class="step-subtitle">Select the option that best describes you</p>
          </div>

          <div class="account-type-grid">
            <div class="account-type-card" data-type="homeowner" onclick="selectAccountType('homeowner')">
              <div class="type-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
              </div>
              <div class="type-name">Homeowner</div>
              <div class="type-desc">Shopping for countertops, tile, or flooring for your home</div>
              <ul class="type-features">
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Save favorite materials</li>
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Get free estimates</li>
                <li><svg class="check-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> List up to 3 remnants</li>
              </ul>
              <div class="type-badge free">Free</div>
            </div>

            <div class="account-type-card" data-type="pro_fabricator" onclick="selectAccountType('pro_fabricator')">
              <div class="type-icon pro">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                </svg>
              </div>
              <div class="type-name">Pro Fabricator</div>
              <div class="type-desc">Countertop fabricators, installers, and stone professionals</div>
              <ul class="type-features">
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> <strong>Unlimited</strong> remnant listings</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Pro verified badge</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Priority in marketplace</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Business profile page</li>
              </ul>
              <div class="type-badge pro">Pro</div>
            </div>

            <div class="account-type-card" data-type="pro_designer" onclick="selectAccountType('pro_designer')">
              <div class="type-icon pro">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 005.304 0l6.401-6.402M6.75 21A3.75 3.75 0 013 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 003.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008z"/>
                </svg>
              </div>
              <div class="type-name">Designer / Architect</div>
              <div class="type-desc">Interior designers, architects, and design professionals</div>
              <ul class="type-features">
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Create client mood boards</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Trade pricing access</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Designer verified badge</li>
                <li><svg class="check-icon gold" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg> Project management tools</li>
              </ul>
              <div class="type-badge pro">Pro</div>
            </div>
          </div>

          <input type="hidden" id="signup-account-type" value="homeowner"/>
          <button type="button" class="auth-submit" id="continue-to-details" onclick="goToSignupStep(2)">Continue</button>
        </div>

        <!-- Step 2: Account Details -->
        <div class="signup-step" id="signup-step-2" style="display: none;">
          <div class="step-header">
            <button type="button" class="step-back" onclick="goToSignupStep(1)">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
              </svg>
              Back
            </button>
            <h3 class="step-title">Create Your Account</h3>
            <p class="step-subtitle" id="selected-type-label">Homeowner Account</p>
          </div>

          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="signup-name" required placeholder="John Smith"/>
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="signup-email" required placeholder="you@example.com"/>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" id="signup-password" required minlength="6" placeholder="At least 6 characters"/>
          </div>
          <div class="form-group">
            <label>Phone (Optional)</label>
            <input type="tel" id="signup-phone" placeholder="(555) 123-4567"/>
          </div>

          <!-- Pro account fields -->
          <div id="pro-fields" style="display: none;">
            <div class="form-group">
              <label>Business Name</label>
              <input type="text" id="signup-business-name" placeholder="Your Company Name"/>
            </div>
            <div class="form-group">
              <label>Business Location</label>
              <input type="text" id="signup-business-location" placeholder="City, State"/>
            </div>
          </div>

          <div class="signup-terms">
            <label class="checkbox-label">
              <input type="checkbox" id="signup-terms" required/>
              <span>I agree to the <a href="/terms/" target="_blank">Terms of Service</a> and <a href="/privacy/" target="_blank">Privacy Policy</a></span>
            </label>
          </div>

          <button type="submit" class="auth-submit" id="signup-btn">Create Account</button>

          <div class="pro-note" id="pro-upgrade-note" style="display: none;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="16" height="16">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>Pro accounts require verification. You'll receive an email to complete your business verification.</span>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div id="dashboard-app" style="display: none;">
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <!-- Toggle Button -->
      <button class="sidebar-toggle" onclick="toggleSidebarCollapse()" title="Toggle Sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
      </button>

      <div class="sidebar-header">
        <a href="/" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub"><span id="account-type-label">Account</span></div>
          </div>
        </a>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Menu</div>
          <a class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="nav-item-text">Dashboard</span>
          </a>
          <a class="nav-item" data-page="profile" onclick="showPage('profile')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <span class="nav-item-text">My Profile</span>
          </a>
          <a class="nav-item" data-page="favorites" onclick="showPage('favorites')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            <span class="nav-item-text">Favorites</span>
            <span class="nav-badge" id="favorites-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="my-designs" onclick="showPage('my-designs')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            <span class="nav-item-text">My Designs</span>
            <span class="nav-badge" id="designs-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="listings" onclick="showPage('listings')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            <span class="nav-item-text">My Listings</span>
            <span class="nav-badge" id="listings-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="tools" onclick="showPage('tools')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
            <span class="nav-item-text">Design Tools</span>
          </a>
        </div>

        <div class="nav-section" id="admin-nav" style="display: none;">
          <div class="nav-section-title">Admin</div>
          <a class="nav-item" data-page="leads" onclick="showPage('leads')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            <span class="nav-item-text">Leads</span>
            <span class="nav-badge" id="leads-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="customers" onclick="showPage('customers')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span class="nav-item-text">Customers</span>
            <span class="nav-badge" id="customers-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="estimates" onclick="showPage('estimates')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Estimates</span>
            <span class="nav-badge" id="estimates-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="invoices" onclick="showPage('invoices')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <span class="nav-item-text">Invoices</span>
          </a>
          <a class="nav-item" data-page="jobs" onclick="showPage('jobs')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <span class="nav-item-text">Jobs</span>
            <span class="nav-badge" id="jobs-count" data-count="0">0</span>
          </a>
          <a class="nav-item" data-page="contractors" onclick="showPage('contractors')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            <span class="nav-item-text">Contractors</span>
          </a>
          <a class="nav-item" data-page="calendar" onclick="showPage('calendar')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Calendar</span>
          </a>
          <a class="nav-item" data-page="wallet" onclick="showPage('wallet')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
            <span class="nav-item-text">Wallet</span>
          </a>
          <a class="nav-item" data-page="admin-users" onclick="showPage('admin-users')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <span class="nav-item-text">Manage Admins</span>
          </a>
        </div>

        <div class="nav-section" id="vendor-nav" style="display: none;">
          <div class="nav-section-title">Store</div>
          <a class="nav-item" data-page="products" onclick="showPage('products')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <span class="nav-item-text">Products</span>
          </a>
          <a class="nav-item" data-page="orders" onclick="showPage('orders')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            <span class="nav-item-text">Orders</span>
          </a>
          <a class="nav-item" data-page="messages" onclick="showPage('messages')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            <span class="nav-item-text">Messages</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Quick Links</div>
          <a class="nav-item" href="/" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            <span class="nav-item-text">View Website</span>
          </a>
          <a class="nav-item" href="/get-a-free-estimate/">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            <span class="nav-item-text">Get Estimate</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-menu">
          <div class="user-avatar" id="user-avatar">?</div>
          <div class="user-info">
            <div class="user-name" id="user-name">User</div>
            <div class="user-role" id="user-role">Member</div>
          </div>
          <button class="logout-btn" onclick="handleLogout()" title="Sign Out">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="topbar">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        <h1 class="topbar-title" id="page-title">Dashboard</h1>
        <div class="topbar-actions">
          <!-- Role Switcher (for demo/testing - remove in production) -->
          <div id="role-switcher" style="display: none; margin-right: 12px;">
            <select id="role-select" onchange="switchRole(this.value)" style="padding: 8px 12px; border-radius: 6px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 13px; cursor: pointer;">
              <option value="customer">Customer View</option>
              <option value="contractor">Contractor View</option>
              <option value="fabricator">Fabricator View</option>
              <option value="vendor">Vendor View</option>
              <option value="admin">Admin View (GOD)</option>
            </select>
          </div>
          <button class="btn-modern primary" onclick="openAddLeadModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add New Lead
          </button>
        </div>
      </div>

      <div class="content-area">
        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page-section active">
          <div class="stats-grid" id="dashboard-stats">
            <!-- Filled by JS based on role -->
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="quick-actions" id="quick-actions">
                <!-- Filled by JS based on role -->
              </div>
            </div>
          </div>
        </section>

        <!-- Profile Page -->
        <section id="page-profile" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Profile Information</h3>
              <button class="btn-modern primary" onclick="saveProfile()">Save Changes</button>
            </div>
            <div class="card-body">
              <form id="profile-form">
                <div class="form-row">
                  <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profile-name" placeholder="Your name"/>
                  </div>
                  <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profile-email" readonly style="opacity: 0.6;"/>
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="profile-phone" placeholder="(555) 123-4567"/>
                  </div>
                  <div class="form-group">
                    <label>Company (Optional)</label>
                    <input type="text" id="profile-company" placeholder="Your company"/>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </section>

        <!-- Favorites Page -->
        <section id="page-favorites" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Your Favorites</h3>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn-modern danger" onclick="clearAllFavoritesConfirm()" id="clear-all-btn" style="display: none; background: #dc2626; border-color: #dc2626;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  Clear All
                </button>
                <button class="btn-modern primary" onclick="requestQuoteForFavorites()" id="request-quote-btn" style="display: none;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Request Quote
                </button>
              </div>
            </div>
            <div class="card-body">
              <p style="color: #666; margin-bottom: 20px;">Browse materials on your phone and swipe right to save your favorites. They'll appear here!</p>

              <div id="favorites-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your favorites...</p>
              </div>

              <div id="favorites-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <h3 style="color: #666; margin: 16px 0 8px;">No Favorites Yet</h3>
                <p style="color: #999; margin-bottom: 20px;">Browse our collections on your phone and swipe right to save your favorites!</p>
                <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                  <a href="/materials/flooring/" class="btn-modern primary">Browse Flooring</a>
                  <a href="/materials/all-countertops/" class="btn-modern secondary">Browse Countertops</a>
                </div>
              </div>

              <!-- Countertops Section -->
              <div id="favorites-countertops" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/></svg>
                  Countertops
                  <span id="countertops-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-countertops-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Flooring Section -->
              <div id="favorites-flooring" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                  Flooring
                  <span id="flooring-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-flooring-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Tile Section -->
              <div id="favorites-tile" style="display: none; margin-bottom: 32px;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><path d="M3 3h7v7H3z M14 3h7v7h-7z M3 14h7v7H3z M14 14h7v7h-7z"/></svg>
                  Tile
                  <span id="tile-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-tile-grid" class="saved-floors-grid"></div>
              </div>

              <!-- Shop Section -->
              <div id="favorites-shop" style="display: none;">
                <h4 style="color: #1a1a2e; margin-bottom: 16px; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/></svg>
                  Shop Products
                  <span id="shop-section-count" style="background: #f9cb00; color: #1a1a2e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                </h4>
                <div id="favorites-shop-grid" class="saved-floors-grid"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- My Designs Page (Room Designer) -->
        <section id="page-my-designs" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Designs</h3>
              <div style="display: flex; gap: 12px; align-items: center;">
                <select id="designs-filter" onchange="filterDesigns()" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-secondary);">
                  <option value="all">All Designs</option>
                  <option value="shared">Shared</option>
                  <option value="private">Private</option>
                </select>
                <a href="/tools/room-designer/" class="btn-modern primary">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Design
                </a>
              </div>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">
                Create kitchen and bathroom layouts with the Room Designer. Your saved designs appear here.
              </p>

              <div id="designs-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your designs...</p>
              </div>

              <div id="designs-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <h3 style="color: #666; margin: 16px 0 8px;">No Designs Yet</h3>
                <p style="color: #999; margin-bottom: 20px;">Create your first kitchen or bathroom design with our Room Designer tool!</p>
                <a href="/tools/room-designer/" class="btn-modern primary">Open Room Designer</a>
              </div>

              <div id="designs-grid" class="designs-grid" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- My Listings Page (Remnants Marketplace) -->
        <section id="page-listings" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Listings</h3>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span id="listing-limit-indicator" style="font-size: 13px; color: var(--text-muted);"></span>
                <button class="btn-modern primary" onclick="openCreateListingModal()" id="create-listing-btn">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Listing
                </button>
              </div>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">
                List your stone remnants here. Other users can find and contact you about materials you have available.
                <a href="/remnants/" style="color: var(--gold-primary);">Browse the marketplace </a>
              </p>

              <div id="listings-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading your listings...</p>
              </div>

              <div id="listings-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                <h3 style="color: var(--text-secondary); margin: 16px 0 8px;">No Listings Yet</h3>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Have materials to sell? List countertops, tile, flooring, cabinets, or supplies!</p>
                <button class="btn-modern primary" onclick="openCreateListingModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Your First Listing
                </button>
              </div>

              <div id="listings-grid" class="listings-grid" style="display: none;"></div>
            </div>
          </div>

          <!-- Inquiries Section -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Incoming Inquiries</h3>
              <span class="nav-badge" id="inquiries-badge" style="display: none;">0</span>
            </div>
            <div class="card-body">
              <div id="inquiries-loading" style="display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px;">
                <div class="spinner"></div>
                <p style="color: var(--text-muted); margin-top: 12px;">Loading inquiries...</p>
              </div>
              <div id="inquiries-empty" style="display: none; text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
                <h3 style="color: var(--text-secondary); margin: 16px 0 8px;">No Inquiries Yet</h3>
                <p style="color: var(--text-muted); margin-bottom: 0;">When someone contacts you about a listing, it will appear here.</p>
              </div>
              <div id="inquiries-list" style="display: none;"></div>
            </div>
          </div>
        </section>

        <!-- Design Tools Page -->
        <section id="page-tools" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Design Tools</h3>
              <p style="color: var(--text-muted); font-size: 14px; margin: 0;">Professional design tools for your projects</p>
            </div>
            <div class="card-body">
              <div class="tools-grid">
                <!-- Room Designer Pro -->
                <a href="/tools/room-designer/" class="tool-card featured">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Room Designer Pro</h4>
                    <p>2D/3D kitchen & bath design with instant quotes</p>
                    <span class="tool-badge featured">Featured</span>
                  </div>
                </a>

                <!-- Visualizer -->
                <a href="/tools/visualizer/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Stone Visualizer</h4>
                    <p>See how materials look in your space</p>
                  </div>
                </a>

                <!-- Blueprint Takeoff -->
                <a href="/tools/blueprint-takeoff/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Blueprint Takeoff</h4>
                    <p>Extract measurements from blueprints</p>
                  </div>
                </a>

                <!-- Virtual Kitchen -->
                <a href="/tools/virtual-kitchen-design-tool/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Virtual Kitchen</h4>
                    <p>Design your kitchen with drag & drop</p>
                  </div>
                </a>

                <!-- Virtual Bathroom -->
                <a href="/tools/virtual-bathroom-design-tool/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Virtual Bathroom</h4>
                    <p>Design your bathroom space</p>
                  </div>
                </a>

                <!-- Multi-Surface Visualizer -->
                <a href="/tools/multi-surface-room-visualizer/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Multi-Surface Visualizer</h4>
                    <p>Visualize counters, floors, and backsplash</p>
                  </div>
                </a>

                <!-- Edge Profile Visualizer -->
                <a href="/tools/countertop-edge-visualizer/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Edge Profile Visualizer</h4>
                    <p>Compare countertop edge profiles</p>
                  </div>
                </a>

                <!-- Interior Gallery -->
                <a href="/tools/interior-design-gallery/" class="tool-card">
                  <div class="tool-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                  </div>
                  <div class="tool-info">
                    <h4>Design Gallery</h4>
                    <p>Browse interior design inspiration</p>
                  </div>
                </a>
              </div>

              <!-- Calculators Section -->
              <div style="margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--border-subtle);">
                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-secondary);">Calculators</h3>
                <div class="tools-grid calculators-grid">
                  <a href="/tools/countertop-calculator/" class="tool-card calculator" target="_blank">
                    <div class="tool-icon small">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                      </svg>
                    </div>
                    <div class="tool-info">
                      <h4>Countertop Calculator</h4>
                      <p>Calculate material needs</p>
                    </div>
                  </a>
                  <a href="/tools/tile-calculator/" class="tool-card calculator" target="_blank">
                    <div class="tool-icon small">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                      </svg>
                    </div>
                    <div class="tool-info">
                      <h4>Tile Calculator</h4>
                      <p>Plan your tile project</p>
                    </div>
                  </a>
                  <a href="/tools/flooring-calculator/" class="tool-card calculator" target="_blank">
                    <div class="tool-icon small">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                      </svg>
                    </div>
                    <div class="tool-info">
                      <h4>Flooring Calculator</h4>
                      <p>Estimate flooring needs</p>
                    </div>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Leads Page (Admin Only) -->
        <section id="page-leads" class="page-section">
          <div class="table-container">
            <div class="table-header" style="flex-direction: column; align-items: stretch; gap: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h2 class="table-title">All Leads</h2>
                <div class="search-bar-modern" style="margin: 0; max-width: 300px; flex: 1;">
                  <span class="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                  </span>
                  <input type="text" id="leads-search" placeholder="Search leads..." class="input-modern">
                </div>
              </div>
              <div class="filter-pills">
                <button class="filter-pill active" data-status="all">All</button>
                <button class="filter-pill" data-status="new">New</button>
                <button class="filter-pill" data-status="contacted">Contacted</button>
                <button class="filter-pill" data-status="qualified">Qualified</button>
                <button class="filter-pill" data-status="quoted">Quoted</button>
                <button class="filter-pill" data-status="won">Won</button>
                <button class="filter-pill" data-status="lost">Lost</button>
              </div>
            </div>
            <div id="leads-table">
              <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading leads...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Customers Page (Admin Only) -->
        <section id="page-customers" class="page-section">
          <div class="table-container">
            <div class="table-header" style="flex-direction: column; align-items: stretch; gap: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                <h2 class="table-title">Customers</h2>
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                  <div class="search-bar-modern" style="margin: 0; max-width: 250px;">
                    <span class="search-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </span>
                    <input type="text" id="customers-search" placeholder="Search..." oninput="searchCustomersPage()" class="input-modern">
                  </div>
                  <button class="btn-modern primary" onclick="openAddCustomerModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    Add Customer
                  </button>
                </div>
              </div>
              <div class="filter-pills">
                <button class="filter-pill active" data-customer-filter="all" onclick="filterCustomers('all')">All</button>
                <button class="filter-pill" data-customer-filter="active" onclick="filterCustomers('active')">Active</button>
                <button class="filter-pill" data-customer-filter="recent" onclick="filterCustomers('recent')">Recent Jobs</button>
              </div>
            </div>
            <div id="customers-table">
              <div class="empty-state">
                <div class="spinner"></div>
                <p>Loading customers...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Estimates Page -->
        <section id="page-estimates" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Estimates</h3>
              <div style="display: flex; gap: 12px;">
                <button class="btn-modern secondary" onclick="openBusinessSettings()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Settings
                </button>
                <button class="btn-modern secondary" onclick="openServiceCatalog()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  Service Catalog
                </button>
                <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Estimate
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Stats Row - Modern -->
              <div class="stat-grid">
                <div class="stat-card gold" onclick="filterEstimates('draft')">
                  <div class="stat-value" id="stat-draft-estimates">0</div>
                  <div class="stat-label">Draft</div>
                </div>
                <div class="stat-card" onclick="filterEstimates('sent')" style="--accent: #3b82f6;">
                  <div class="stat-value" style="color: #3b82f6;" id="stat-sent-estimates">0</div>
                  <div class="stat-label">Sent</div>
                </div>
                <div class="stat-card success" onclick="filterEstimates('approved')">
                  <div class="stat-value" id="stat-approved-estimates">0</div>
                  <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card error" onclick="filterEstimates('rejected')">
                  <div class="stat-value" id="stat-rejected-estimates">0</div>
                  <div class="stat-label">Rejected</div>
                </div>
              </div>

              <!-- Filters - Modern Pills -->
              <div class="filter-pills">
                <button class="filter-pill active" data-estimate-status="all" onclick="filterEstimates('all')">All</button>
                <button class="filter-pill" data-estimate-status="draft" onclick="filterEstimates('draft')">Draft</button>
                <button class="filter-pill" data-estimate-status="sent" onclick="filterEstimates('sent')">Sent</button>
                <button class="filter-pill" data-estimate-status="approved" onclick="filterEstimates('approved')">Approved</button>
                <button class="filter-pill" data-estimate-status="rejected" onclick="filterEstimates('rejected')">Rejected</button>
                <button class="filter-pill" data-estimate-status="archived" onclick="filterEstimates('archived')">Archived</button>
              </div>

              <!-- Estimates List -->
              <div id="estimates-list">
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                  <h3 style="margin-bottom: 8px;">No estimates yet</h3>
                  <p style="color: var(--text-muted); margin-bottom: 16px;">Create your first estimate to send to customers</p>
                  <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    Create First Estimate
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Invoices Page (Admin Only) -->
        <section id="page-invoices" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Invoices</h3>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn-modern secondary" onclick="syncFromStripe()" id="sync-stripe-btn" title="Import paid invoices and customers from Stripe">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  Sync from Stripe
                </button>
                <button class="btn-modern secondary" onclick="openTemplatePreview()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                  Email Templates
                </button>
                <button class="btn-modern primary" onclick="openInvoiceModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Create Invoice
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-invoice-status="all" onclick="filterInvoices('all')">All</button>
                <button class="filter-btn" data-invoice-status="draft" onclick="filterInvoices('draft')">Draft</button>
                <button class="filter-btn" data-invoice-status="open" onclick="filterInvoices('open')">Open</button>
                <button class="filter-btn" data-invoice-status="viewed" onclick="filterInvoices('viewed')">Viewed</button>
                <button class="filter-btn" data-invoice-status="paid" onclick="filterInvoices('paid')">Paid</button>
                <button class="filter-btn" data-invoice-status="void" onclick="filterInvoices('void')">Voided</button>
              </div>
              <div id="invoices-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Jobs Page - Enhanced with Job Costing & Kanban -->
        <section id="page-jobs" class="page-section">
          <!-- Stats Row - Modern -->
          <div class="stat-grid">
            <div class="stat-card" style="cursor: default;">
              <div class="stat-value" style="color: #3b82f6;" id="stat-active-jobs">0</div>
              <div class="stat-label">Active Jobs</div>
            </div>
            <div class="stat-card success" style="cursor: default;">
              <div class="stat-value" id="stat-total-revenue">$0</div>
              <div class="stat-label">Revenue</div>
            </div>
            <div class="stat-card error" style="cursor: default;">
              <div class="stat-value" id="stat-total-costs">$0</div>
              <div class="stat-label">Costs</div>
            </div>
            <div class="stat-card gold" style="cursor: default;">
              <div class="stat-value" id="stat-net-profit">$0</div>
              <div class="stat-label">Net Profit</div>
            </div>
          </div>

          <div class="card">
            <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
              <h3 class="card-title">Jobs & Projects</h3>
              <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                <!-- View Toggle -->
                <div class="view-toggle" style="display: flex; background: var(--dark-elevated); border-radius: 8px; padding: 4px;">
                  <button class="view-btn active" onclick="setJobsView('list')" id="jobsListBtn" style="padding: 8px 12px; border: none; background: var(--gold-primary); color: var(--dark-primary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    List
                  </button>
                  <button class="view-btn" onclick="setJobsView('kanban')" id="jobsKanbanBtn" style="padding: 8px 12px; border: none; background: transparent; color: var(--text-secondary); border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Board
                  </button>
                </div>
                <button class="btn-modern secondary" onclick="openCustomersModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  Customers
                </button>
                <button class="btn-modern primary" onclick="openNewJobModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  New Job
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Filters - Modern Pills -->
              <div class="filter-pills">
                <button class="filter-pill active" data-job-status="all" onclick="filterJobs('all')">All</button>
                <button class="filter-pill" data-job-status="new" onclick="filterJobs('new')">New</button>
                <button class="filter-pill" data-job-status="approved" onclick="filterJobs('approved')">Approved</button>
                <button class="filter-pill" data-job-status="scheduled" onclick="filterJobs('scheduled')">Scheduled</button>
                <button class="filter-pill" data-job-status="in_progress" onclick="filterJobs('in_progress')">In Progress</button>
                <button class="filter-pill" data-job-status="completed" onclick="filterJobs('completed')">Completed</button>
              </div>

              <!-- List View -->
              <div id="jobs-list-view">
                <div id="jobs-list">
                  <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    <h3>No jobs yet</h3>
                    <p>Jobs are created when estimates are approved, or create one manually.</p>
                    <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewJobModal()">Create First Job</button>
                  </div>
                </div>
              </div>

              <!-- Kanban Board View (Hidden by default) -->
              <div id="jobs-kanban-view" style="display: none;">
                <div class="kanban-board" style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 400px;">
                  <div class="kanban-column" data-status="lead" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #f59e0b;">
                      <span style="font-weight: 600; color: #f59e0b;">Leads</span>
                      <span class="column-count" id="kanban-count-lead" style="background: rgba(245, 158, 11, 0.2); color: #f59e0b; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-lead" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="approved" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #3b82f6;">
                      <span style="font-weight: 600; color: #3b82f6;">Approved</span>
                      <span class="column-count" id="kanban-count-approved" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-approved" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="scheduled" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #8b5cf6;">
                      <span style="font-weight: 600; color: #8b5cf6;">Scheduled</span>
                      <span class="column-count" id="kanban-count-scheduled" style="background: rgba(139, 92, 246, 0.2); color: #8b5cf6; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-scheduled" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="in_progress" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #06b6d4;">
                      <span style="font-weight: 600; color: #06b6d4;">In Progress</span>
                      <span class="column-count" id="kanban-count-in_progress" style="background: rgba(6, 182, 212, 0.2); color: #06b6d4; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-in_progress" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                  <div class="kanban-column" data-status="completed" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px;">
                    <div class="column-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid #22c55e;">
                      <span style="font-weight: 600; color: #22c55e;">Completed</span>
                      <span class="column-count" id="kanban-count-completed" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">0</span>
                    </div>
                    <div class="column-cards" id="kanban-cards-completed" style="display: flex; flex-direction: column; gap: 12px;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Contractors Page -->
        <section id="page-contractors" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Contractors & Team</h3>
              <button class="btn-modern primary" onclick="openNewContractorModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Add Contractor
              </button>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-contractor-status="all" onclick="filterContractors('all')">All</button>
                <button class="filter-btn" data-contractor-status="fabricator" onclick="filterContractors('fabricator')">Fabricators</button>
                <button class="filter-btn" data-contractor-status="installer" onclick="filterContractors('installer')">Installers</button>
                <button class="filter-btn" data-contractor-status="plumber" onclick="filterContractors('plumber')">Plumbers</button>
                <button class="filter-btn" data-contractor-status="other" onclick="filterContractors('other')">Other</button>
              </div>
              <div id="contractors-list">
                <div class="empty-state">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <h3>No contractors yet</h3>
                  <p>Add your fabricators, installers, plumbers, and other team members.</p>
                  <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewContractorModal()">Add First Contractor</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Calendar Page -->
        <section id="page-calendar" class="page-section">
          <div class="card">
            <div class="card-header" style="flex-wrap: wrap; gap: 12px;">
              <h3 class="card-title">Calendar</h3>
              <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                <div style="display: flex; gap: 4px; align-items: center;">
                  <button class="btn-modern ghost" id="calendar-prev" onclick="changeCalendarMonth(-1)" style="padding: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                  </button>
                  <span id="calendar-month-year" style="font-weight: 600; min-width: 140px; text-align: center;">January 2026</span>
                  <button class="btn-modern ghost" id="calendar-next" onclick="changeCalendarMonth(1)" style="padding: 8px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                  </button>
                </div>
                <button class="btn-modern secondary" onclick="goToToday()">Today</button>
                <button class="btn-modern primary" onclick="openQuickScheduleModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Schedule
                </button>
              </div>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="calendar-container">
                <div class="calendar-header-row">
                  <div class="calendar-header-cell">Sun</div>
                  <div class="calendar-header-cell">Mon</div>
                  <div class="calendar-header-cell">Tue</div>
                  <div class="calendar-header-cell">Wed</div>
                  <div class="calendar-header-cell">Thu</div>
                  <div class="calendar-header-cell">Fri</div>
                  <div class="calendar-header-cell">Sat</div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                  <!-- Calendar days will be rendered here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar Legend -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">Legend</h3>
            </div>
            <div class="card-body">
              <div style="display: flex; flex-wrap: wrap; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="calendar-event-dot" style="background: #3b82f6;"></span>
                  <span style="font-size: 13px;">Scheduled</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="calendar-event-dot" style="background: #8b5cf6;"></span>
                  <span style="font-size: 13px;">In Production</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="calendar-event-dot" style="background: #10b981;"></span>
                  <span style="font-size: 13px;">Installing</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span class="calendar-event-dot" style="background: #f59e0b;"></span>
                  <span style="font-size: 13px;">Field Measure</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Upcoming Events -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">Upcoming Events</h3>
            </div>
            <div class="card-body">
              <div id="upcoming-events-list">
                <div class="empty-state" style="padding: 30px;">
                  <p style="color: var(--text-muted);">No upcoming events scheduled</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Wallet Page (Admin Only) -->
        <section id="page-wallet" class="page-section">
          <!-- Balance Cards -->
          <div class="wallet-balance-grid">
            <div class="balance-card available">
              <div class="balance-label">Available Balance</div>
              <div class="balance-amount" id="available-balance">$0.00</div>
              <div class="balance-sub">Ready to withdraw</div>
            </div>
            <div class="balance-card pending">
              <div class="balance-label">Pending Balance</div>
              <div class="balance-amount" id="pending-balance">$0.00</div>
              <div class="balance-sub">Processing payments</div>
            </div>
            <div class="balance-card total">
              <div class="balance-label">Total Revenue</div>
              <div class="balance-amount" id="total-revenue">$0.00</div>
              <div class="balance-sub">All time</div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
              <h3 class="card-title">Quick Actions</h3>
            </div>
            <div class="card-body" style="display: flex; gap: 12px; flex-wrap: wrap;">
              <a href="https://dashboard.stripe.com" target="_blank" class="btn-modern primary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
                Open Stripe Dashboard
              </a>
              <button class="btn-modern secondary" onclick="loadWalletData()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                Refresh
              </button>
            </div>
          </div>

          <!-- Recent Transactions -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Recent Transactions</h3>
            </div>
            <div class="card-body">
              <div id="transactions-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Recent Payouts -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Payouts to Your Bank</h3>
            </div>
            <div class="card-body">
              <div id="payouts-list">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>

          <!-- Fees & Rates Disclosure -->
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h3 class="card-title">Processing Fees & Rates</h3>
            </div>
            <div class="card-body">
              <div class="fees-grid">
                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                    <span>Credit/Debit Cards</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">Per successful transaction</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span>Invoices (Card Payment)</span>
                  </div>
                  <div class="fee-rate">2.9% + $0.30</div>
                  <div class="fee-desc">When customer pays by card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
                    <span>ACH Bank Transfer</span>
                  </div>
                  <div class="fee-rate">0.8% (max $5)</div>
                  <div class="fee-desc">Direct bank payments</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span>Payouts to Bank</span>
                  </div>
                  <div class="fee-rate">Free</div>
                  <div class="fee-desc">Standard 2-day transfer</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    <span>Instant Payouts</span>
                  </div>
                  <div class="fee-rate">1.5% (min $0.50)</div>
                  <div class="fee-desc">Funds in minutes to debit card</div>
                </div>

                <div class="fee-item">
                  <div class="fee-header">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>Vendor Payouts</span>
                  </div>
                  <div class="fee-rate">0.25% + $0.25</div>
                  <div class="fee-desc">Per transfer to vendor accounts</div>
                </div>
              </div>

              <div class="fee-note">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div>
                  <strong>How Vendor Payouts Work:</strong>
                  All customer payments are collected through Surprise Granite's Stripe account. Vendors receive payouts after their sales are processed, minus applicable platform and processing fees. Payouts are processed weekly or upon request.
                </div>
              </div>

              <div class="fee-note" style="margin-top: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                <div>
                  <strong>Secure Payments:</strong>
                  All transactions are processed securely through Stripe. We never store credit card numbers on our servers.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin Users Page -->
        <section id="page-admin-users" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Manage Admin Users</h3>
            </div>
            <div class="card-body">
              <p style="color: var(--text-muted); margin-bottom: 20px;">Add or remove admin access for users. Super admins (joshb@surprisegranite.com, info@surprisegranite.com) always have access.</p>
              <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                <input type="email" id="new-admin-email" placeholder="Enter email address" style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                <button class="btn-modern primary" onclick="addAdminUser()">Add Admin</button>
              </div>
              <div id="admin-users-list">
                <div class="spinner" style="margin: 20px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Products Page -->
        <section id="page-products" class="page-section">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">My Products</h3>
              <button class="btn-modern primary" onclick="openProductModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Add Product
              </button>
            </div>
            <div class="card-body">
              <div class="table-filters" style="margin-bottom: 20px;">
                <button class="filter-btn active" data-product-status="all" onclick="filterProducts('all')">All</button>
                <button class="filter-btn" data-product-status="active" onclick="filterProducts('active')">Active</button>
                <button class="filter-btn" data-product-status="draft" onclick="filterProducts('draft')">Draft</button>
                <button class="filter-btn" data-product-status="sold" onclick="filterProducts('sold')">Sold</button>
              </div>
              <div id="products-grid" class="products-grid">
                <div class="spinner" style="margin: 40px auto;"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Orders Page (Coming Soon) -->
        <section id="page-orders" class="page-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
            </div>
            <h2>Order Management Coming Soon</h2>
            <p>Track and manage customer orders, quotes, and project timelines all in one place.</p>
          </div>
        </section>

        <!-- Messages Page (Coming Soon) -->
        <section id="page-messages" class="page-section">
          <div class="coming-soon">
            <div class="coming-soon-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
            </div>
            <h2>Messaging Coming Soon</h2>
            <p>Stay connected with customers, vendors, and the Surprise Granite team through our upcoming messaging feature.</p>
          </div>
        </section>
      </div>

      <!-- Mobile Floating Action Buttons -->
      <button class="fab-modern" id="fab-leads" onclick="openAddLeadModal()" style="display: none;" title="Add Lead">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
      </button>
      <button class="fab-modern" id="fab-estimates" onclick="openCreateEstimateModal()" style="display: none;" title="New Estimate">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
      <button class="fab-modern" id="fab-invoices" onclick="openInvoiceModal()" style="display: none;" title="New Invoice">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
      <button class="fab-modern" id="fab-jobs" onclick="openNewJobModal()" style="display: none;" title="New Job">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
      <button class="fab-modern" id="fab-customers" onclick="openAddCustomerModal()" style="display: none;" title="Add Customer">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
      </button>
    </main>
  </div>

  <!-- Lead Detail Modal - Modern Sheet Style -->
  <div class="modal-modern-overlay" id="lead-modal" onclick="if(event.target === this) closeLeadModal()">
    <div class="modal-modern" style="max-width: 500px;">
      <div class="modal-drag-handle"></div>
      <div class="modal-modern-header">
        <h2>Lead Details</h2>
        <button class="btn-icon" onclick="closeLeadModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-modern-body" id="lead-details"></div>

      <!-- Linked Estimates Section -->
      <div class="detail-section" style="padding: 0 24px 16px;">
        <div class="detail-section-title">Linked Estimates</div>
        <div id="lead-estimates-list" class="list-modern">
          <div style="padding: 16px; color: var(--text-muted); font-size: 13px; text-align: center;">No estimates yet</div>
        </div>
      </div>

      <!-- Quick Actions Grid -->
      <div style="padding: 0 24px 16px;">
        <div class="detail-section-title">Status</div>
        <select class="input-modern select-modern" id="lead-status-select" onchange="updateLeadStatus()" style="margin-bottom: 16px;">
          <option value="new">New</option>
          <option value="contacted">Contacted</option>
          <option value="qualified">Qualified</option>
          <option value="quoted">Quoted</option>
          <option value="won">Won - Converted</option>
          <option value="lost">Lost</option>
        </select>

        <div class="detail-section-title">Actions</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
          <button class="btn-modern secondary" onclick="convertLeadToCustomer()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            Add Customer
          </button>
          <button class="btn-modern primary" onclick="createEstimateFromLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Create Estimate
          </button>
          <button class="btn-modern secondary" onclick="createDesignFromLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
            Create Design
          </button>
          <button class="btn-modern ghost" onclick="archiveLead()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
            Archive
          </button>
        </div>
      </div>

      <div class="modal-modern-footer">
        <button class="btn-modern danger" onclick="deleteLead()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          Delete Lead
        </button>
      </div>
    </div>
  </div>

  <!-- Add New Lead Modal -->
  <div class="modal-overlay" id="add-lead-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Add New Lead</h2>
        <button class="modal-close" onclick="closeAddLeadModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="add-lead-form" onsubmit="saveNewLead(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" id="new-lead-first-name" required placeholder="John"/>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" id="new-lead-last-name" required placeholder="Smith"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="new-lead-email" required placeholder="john@example.com"/>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="new-lead-phone" placeholder="(555) 123-4567"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Project Type</label>
              <select id="new-lead-project-type">
                <option value="">Select Type</option>
                <option value="kitchen">Kitchen Countertops</option>
                <option value="bathroom">Bathroom Vanity</option>
                <option value="flooring">Flooring</option>
                <option value="fireplace">Fireplace</option>
                <option value="outdoor">Outdoor Kitchen</option>
                <option value="commercial">Commercial</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>ZIP Code</label>
              <input type="text" id="new-lead-zip" placeholder="85374" maxlength="5"/>
            </div>
          </div>

          <!-- Billing Address Section -->
          <div class="form-section" style="margin: 20px 0; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#f9cb00" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
              </svg>
              <span style="font-size: 13px; font-weight: 600; color: #f9cb00; text-transform: uppercase; letter-spacing: 0.5px;">Billing Address</span>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Street Address</label>
                <input type="text" id="new-lead-billing-street" placeholder="123 Main St"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>Unit/Apt</label>
                <input type="text" id="new-lead-billing-street2" placeholder="Apt 4B"/>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>City</label>
                <input type="text" id="new-lead-billing-city" placeholder="Surprise"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>State</label>
                <select id="new-lead-billing-state">
                  <option value="AZ" selected>AZ</option>
                  <option value="CA">CA</option>
                  <option value="CO">CO</option>
                  <option value="NV">NV</option>
                  <option value="NM">NM</option>
                  <option value="TX">TX</option>
                  <option value="UT">UT</option>
                </select>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>ZIP</label>
                <input type="text" id="new-lead-billing-zip" placeholder="85374" maxlength="5"/>
              </div>
            </div>
          </div>

          <!-- Address Same Toggle -->
          <div class="form-group" style="margin: 16px 0; padding: 12px 16px; background: rgba(249,203,0,0.05); border: 1px solid rgba(249,203,0,0.2); border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
              <input type="checkbox" id="new-lead-address-same" checked onchange="toggleNewLeadServiceAddress()" style="width: 18px; height: 18px; accent-color: #f9cb00;"/>
              <span style="font-size: 14px;">Service address is the same as billing address</span>
            </label>
          </div>

          <!-- Service Address Section (hidden by default) -->
          <div id="new-lead-service-address-section" style="display: none; margin: 20px 0; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#f9cb00" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
              <span style="font-size: 13px; font-weight: 600; color: #f9cb00; text-transform: uppercase; letter-spacing: 0.5px;">Service Address</span>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>Street Address</label>
                <input type="text" id="new-lead-service-street" placeholder="456 Project Ave"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>Unit/Apt</label>
                <input type="text" id="new-lead-service-street2" placeholder=""/>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="flex: 2;">
                <label>City</label>
                <input type="text" id="new-lead-service-city" placeholder="Surprise"/>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>State</label>
                <select id="new-lead-service-state">
                  <option value="AZ" selected>AZ</option>
                  <option value="CA">CA</option>
                  <option value="CO">CO</option>
                  <option value="NV">NV</option>
                  <option value="NM">NM</option>
                  <option value="TX">TX</option>
                  <option value="UT">UT</option>
                </select>
              </div>
              <div class="form-group" style="flex: 1;">
                <label>ZIP</label>
                <input type="text" id="new-lead-service-zip" placeholder="85374" maxlength="5"/>
              </div>
            </div>
          </div>

          <!-- Appointment Scheduling Section -->
          <div class="form-section" style="margin: 20px 0; padding: 16px; background: rgba(34,197,94,0.05); border: 1px solid rgba(34,197,94,0.2); border-radius: 12px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#22c55e" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span style="font-size: 13px; font-weight: 600; color: #22c55e; text-transform: uppercase; letter-spacing: 0.5px;">Schedule Appointment (Optional)</span>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Appointment Date</label>
                <input type="date" id="new-lead-appt-date" min="" style="color-scheme: dark;"/>
              </div>
              <div class="form-group">
                <label>Appointment Time</label>
                <select id="new-lead-appt-time">
                  <option value="">Select Time</option>
                  <option value="8:00 AM">8:00 AM</option>
                  <option value="9:00 AM">9:00 AM</option>
                  <option value="10:00 AM">10:00 AM</option>
                  <option value="11:00 AM">11:00 AM</option>
                  <option value="12:00 PM">12:00 PM</option>
                  <option value="1:00 PM">1:00 PM</option>
                  <option value="2:00 PM">2:00 PM</option>
                  <option value="3:00 PM">3:00 PM</option>
                  <option value="4:00 PM">4:00 PM</option>
                  <option value="5:00 PM">5:00 PM</option>
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label>Appointment Type</label>
              <select id="new-lead-appt-type">
                <option value="estimate">Free In-Home Estimate</option>
                <option value="measure">Measurement Visit</option>
                <option value="showroom">Showroom Visit</option>
                <option value="consultation">Design Consultation</option>
                <option value="installation">Installation</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Project Details / Notes</label>
            <textarea id="new-lead-message" rows="3" placeholder="Describe the project or add notes..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Lead Source</label>
              <select id="new-lead-source">
                <option value="phone">Phone Call</option>
                <option value="walk-in">Walk-in</option>
                <option value="referral">Referral</option>
                <option value="website">Website</option>
                <option value="social">Social Media</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="new-lead-status">
                <option value="new">New</option>
                <option value="contacted">Contacted</option>
                <option value="qualified">Qualified</option>
              </select>
            </div>
          </div>

          <!-- Welcome Email Toggle -->
          <div class="form-group" style="margin: 16px 0; padding: 12px 16px; background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; margin: 0;">
              <input type="checkbox" id="new-lead-send-email" checked style="width: 18px; height: 18px; accent-color: #3b82f6;"/>
              <div>
                <span style="font-size: 14px; font-weight: 500;">Send welcome email to lead</span>
                <p style="font-size: 12px; color: var(--text-muted); margin: 2px 0 0 0;">A friendly confirmation email will be sent automatically</p>
              </div>
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeAddLeadModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="save-lead-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            Save Lead
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="modal-overlay" id="customer-modal">
    <div class="modal" style="max-width: 900px;">
      <div class="modal-header">
        <h2 class="modal-title" id="customer-modal-title">Customer Details</h2>
        <button class="modal-close" onclick="closeCustomerModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
        <!-- Customer Info Section -->
        <div id="customer-info" style="margin-bottom: 24px;"></div>

        <!-- Tabs -->
        <div class="customer-tabs" style="display: flex; gap: 8px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 16px;">
          <button class="tab-btn active" onclick="showCustomerTab('jobs')" data-tab="jobs">Jobs</button>
          <button class="tab-btn" onclick="showCustomerTab('estimates')" data-tab="estimates">Estimates</button>
          <button class="tab-btn" onclick="showCustomerTab('invoices')" data-tab="invoices">Invoices</button>
          <button class="tab-btn" onclick="showCustomerTab('notes')" data-tab="notes">Notes</button>
        </div>

        <!-- Tab Content -->
        <div id="customer-tab-content">
          <div class="empty-state">
            <div class="spinner"></div>
            <p>Loading...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modern secondary" onclick="editCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
          Edit Customer
        </button>
        <button class="btn-modern primary" onclick="createJobForCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          New Job
        </button>
        <button class="btn-modern primary" onclick="createEstimateForCustomer()">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          New Estimate
        </button>
        <div style="flex: 1;"></div>
        <button class="btn-modern danger" onclick="deleteCustomer()" style="background: #dc2626;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Customer Modal -->
  <div class="modal-overlay" id="edit-customer-modal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title" id="edit-customer-title">Add Customer</h2>
        <button class="modal-close" onclick="closeEditCustomerModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="edit-customer-form" onsubmit="saveCustomerForm(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="customer-name" required placeholder="John Smith"/>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="customer-email" placeholder="john@example.com"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="customer-phone" placeholder="(555) 123-4567"/>
            </div>
            <div class="form-group">
              <label>Source</label>
              <select id="customer-source">
                <option value="">Select Source</option>
                <option value="website">Website</option>
                <option value="referral">Referral</option>
                <option value="google">Google</option>
                <option value="walk-in">Walk-in</option>
                <option value="phone">Phone Call</option>
                <option value="social">Social Media</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Address</label>
            <input type="text" id="customer-address" placeholder="123 Main Street"/>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="customer-city" placeholder="Surprise"/>
            </div>
            <div class="form-group" style="width: 100px;">
              <label>State</label>
              <input type="text" id="customer-state" placeholder="AZ" maxlength="2"/>
            </div>
            <div class="form-group" style="width: 120px;">
              <label>ZIP</label>
              <input type="text" id="customer-zip" placeholder="85374"/>
            </div>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea id="customer-notes" rows="3" placeholder="Additional notes about this customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeEditCustomerModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="save-customer-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
            Save Customer
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal-overlay" id="product-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title" id="product-modal-title">Add New Product</h2>
        <button class="modal-close" onclick="closeProductModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="product-form" onsubmit="saveProduct(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Product Name *</label>
              <input type="text" id="product-name" required placeholder="e.g., Calacatta Gold Marble Slab"/>
            </div>
            <div class="form-group">
              <label>Category</label>
              <select id="product-category">
                <option value="">Select Category</option>
                <option value="granite">Granite</option>
                <option value="marble">Marble</option>
                <option value="quartz">Quartz</option>
                <option value="quartzite">Quartzite</option>
                <option value="porcelain">Porcelain</option>
                <option value="soapstone">Soapstone</option>
                <option value="remnant">Remnant</option>
                <option value="tile">Tile</option>
                <option value="sink">Sink</option>
                <option value="faucet">Faucet</option>
                <option value="accessory">Accessory</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="product-description" rows="3" placeholder="Describe your product..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Price ($) *</label>
              <input type="number" id="product-price" required min="0" step="0.01" placeholder="0.00"/>
            </div>
            <div class="form-group">
              <label>Dimensions</label>
              <input type="text" id="product-dimensions" placeholder='e.g., 120" x 60" x 3cm'/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Material Type</label>
              <input type="text" id="product-material" placeholder="e.g., Natural Stone"/>
            </div>
            <div class="form-group">
              <label>Color</label>
              <input type="text" id="product-color" placeholder="e.g., White with Gold Veining"/>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Stock Quantity</label>
              <input type="number" id="product-stock" min="0" value="1" placeholder="1"/>
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="product-status">
                <option value="draft">Draft (Not Listed)</option>
                <option value="active">Active (Listed for Sale)</option>
                <option value="sold">Sold</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Image URL</label>
            <input type="url" id="product-image-url" placeholder="https://example.com/image.jpg"/>
            <small style="color: var(--text-muted); font-size: 12px; margin-top: 4px; display: block;">
              Paste a direct link to your product image. Tip: Upload images to Imgur or similar service.
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeProductModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="product-save-btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div class="modal-overlay" id="invoice-modal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Invoice</h2>
        <button class="modal-close" onclick="closeInvoiceModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="invoice-form" onsubmit="createInvoice(event)">
        <div class="modal-body">
          <h4 style="margin-bottom: 16px; color: var(--text-secondary);">Customer Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Customer Email *</label>
              <input type="email" id="invoice-email" required placeholder="customer@example.com"/>
            </div>
            <div class="form-group">
              <label>Customer Name</label>
              <input type="text" id="invoice-name" placeholder="John Smith"/>
            </div>
          </div>
          <div class="form-group">
            <label>Customer Phone</label>
            <input type="tel" id="invoice-phone" placeholder="(555) 123-4567"/>
          </div>

          <h4 style="margin: 24px 0 16px; color: var(--text-secondary);">Invoice Items</h4>
          <div id="invoice-items">
            <div class="invoice-item" data-index="0">
              <div class="form-row" style="align-items: flex-end;">
                <div class="form-group" style="flex: 3;">
                  <label>Description *</label>
                  <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Qty</label>
                  <input type="number" class="item-qty" value="1" min="1"/>
                </div>
                <div class="form-group" style="flex: 1;">
                  <label>Amount ($) *</label>
                  <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00"/>
                </div>
                <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
          <button type="button" class="btn-modern secondary" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Line Item
          </button>

          <div class="form-row">
            <div class="form-group">
              <label>Due In (Days)</label>
              <select id="invoice-due-days">
                <option value="7">7 days</option>
                <option value="14">14 days</option>
                <option value="30" selected>30 days</option>
                <option value="60">60 days</option>
              </select>
            </div>
            <div class="form-group">
              <label>Invoice Total</label>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary); padding: 10px 0;" id="invoice-total">$0.00</div>
            </div>
          </div>

          <div class="form-group">
            <label>Email Template</label>
            <div class="template-selector">
              <label class="template-option">
                <input type="radio" name="invoice-template" value="classic" checked>
                <div class="template-preview classic-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Classic</span>
                  <span class="template-desc">Professional & Clean</span>
                </div>
              </label>
              <label class="template-option">
                <input type="radio" name="invoice-template" value="modern">
                <div class="template-preview modern-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Modern</span>
                  <span class="template-desc">Minimal & Elegant</span>
                </div>
              </label>
              <label class="template-option">
                <input type="radio" name="invoice-template" value="premium">
                <div class="template-preview premium-preview">
                  <div class="template-header-preview"></div>
                  <div class="template-body-preview"></div>
                  <span class="template-name">Premium</span>
                  <span class="template-desc">Luxury Dark Theme</span>
                </div>
              </label>
            </div>
          </div>

          <div class="form-group">
            <label>Notes (Optional)</label>
            <textarea id="invoice-notes" rows="2" placeholder="Add any additional notes for the customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeInvoiceModal()">Cancel</button>
          <button type="submit" class="btn-modern primary" id="invoice-send-btn">Create & Send Invoice</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Template Preview Modal -->
  <div class="modal-overlay" id="template-preview-modal">
    <div class="modal" style="max-width: 1200px; max-height: 90vh;">
      <div class="modal-header">
        <h2 class="modal-title">Invoice Email Templates</h2>
        <button class="modal-close" onclick="closeTemplatePreview()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" style="padding: 0; overflow: hidden;">
        <div class="template-tabs">
          <button class="template-tab active" data-template="classic" onclick="showTemplatePreview('classic')">
            <span class="tab-icon"></span>
            <span class="tab-label">Classic</span>
            <span class="tab-desc">Professional & Clean</span>
          </button>
          <button class="template-tab" data-template="modern" onclick="showTemplatePreview('modern')">
            <span class="tab-icon"></span>
            <span class="tab-label">Modern</span>
            <span class="tab-desc">Minimal & Elegant</span>
          </button>
          <button class="template-tab" data-template="premium" onclick="showTemplatePreview('premium')">
            <span class="tab-icon"></span>
            <span class="tab-label">Premium</span>
            <span class="tab-desc">Luxury Dark Theme</span>
          </button>
        </div>
        <div class="template-preview-container">
          <div class="template-preview-frame" id="template-frame-classic" style="display: block;">
            <iframe id="preview-iframe-classic" srcdoc=""></iframe>
          </div>
          <div class="template-preview-frame" id="template-frame-modern" style="display: none;">
            <iframe id="preview-iframe-modern" srcdoc=""></iframe>
          </div>
          <div class="template-preview-frame" id="template-frame-premium" style="display: none;">
            <iframe id="preview-iframe-premium" srcdoc=""></iframe>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <p style="color: var(--text-muted); font-size: 13px; margin: 0;">Select a template when creating an invoice</p>
        <button class="btn-modern primary" onclick="closeTemplatePreview(); openInvoiceModal();">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Create New Invoice
        </button>
      </div>
    </div>
  </div>

  <!-- Create Listing Modal -->
  <div id="create-listing-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateListingModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Listing</h2>
        <button class="modal-close" onclick="closeCreateListingModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="create-listing-form" onsubmit="return handleCreateListing(event)">
          <!-- Category Selection -->
          <div class="form-section">
            <div class="form-section-title">What are you listing?</div>
            <div class="listing-category-grid" id="listing-category-grid">
              <div class="listing-category-option selected" data-category="countertops" onclick="selectListingCategory('countertops')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="8" width="18" height="4" rx="1"/><path d="M5 12v6M19 12v6M8 8V5a1 1 0 011-1h6a1 1 0 011 1v3"/></svg>
                <span>Countertops</span>
                <small>Granite, Marble, Quartz</small>
              </div>
              <div class="listing-category-option" data-category="tile" onclick="selectListingCategory('tile')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="3" width="8" height="8" rx="1"/><rect x="3" y="13" width="8" height="8" rx="1"/><rect x="13" y="13" width="8" height="8" rx="1"/></svg>
                <span>Tile</span>
                <small>Ceramic, Porcelain, Natural</small>
              </div>
              <div class="listing-category-option" data-category="flooring" onclick="selectListingCategory('flooring')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M3 21h18M3 21V8l4-4h10l4 4v13M7 21v-8h10v8M7 13h10"/></svg>
                <span>Flooring</span>
                <small>Hardwood, LVP, Laminate</small>
              </div>
              <div class="listing-category-option" data-category="cabinets" onclick="selectListingCategory('cabinets')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="16" rx="2"/><line x1="12" y1="4" x2="12" y2="20"/><line x1="3" y1="12" x2="21" y2="12"/><circle cx="8" cy="8" r="1"/><circle cx="16" cy="8" r="1"/><circle cx="8" cy="16" r="1"/><circle cx="16" cy="16" r="1"/></svg>
                <span>Cabinets</span>
                <small>Kitchen, Bath, Storage</small>
              </div>
              <div class="listing-category-option" data-category="supplies" onclick="selectListingCategory('supplies')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <span>Supplies</span>
                <small>Tools, Adhesives, Sealers</small>
              </div>
              <div class="listing-category-option" data-category="other" onclick="selectListingCategory('other')">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="9"/><path d="M12 8v4M12 16h.01"/></svg>
                <span>Other</span>
                <small>Fixtures, Hardware, etc.</small>
              </div>
            </div>
            <input type="hidden" id="listing-category" value="countertops">
          </div>

          <!-- Product Selection (dynamic based on category) -->
          <div class="form-section" id="product-selection-section">
            <div class="form-section-title" id="product-selection-title">Select Product</div>
            <div class="form-group stone-autocomplete">
              <label id="product-search-label">Search our catalog (optional)</label>
              <input type="text" id="listing-stone-search" placeholder="Start typing product name..." autocomplete="off">
              <div id="stone-autocomplete-results" class="stone-autocomplete-results"></div>
              <input type="hidden" id="listing-stone-slug">
              <input type="hidden" id="listing-stone-name">
              <input type="hidden" id="listing-material-type">
              <input type="hidden" id="listing-brand">
              <input type="hidden" id="listing-color">
            </div>
            <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Link to our catalog so buyers can see the full product details, or skip to create a custom listing.</p>
            <div id="selected-stone-preview" style="display: none; margin-top: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <img id="selected-stone-img" src="" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;">
                <div>
                  <div id="selected-stone-name" style="font-weight: 600; color: var(--text-primary);"></div>
                  <div id="selected-stone-meta" style="font-size: 12px; color: var(--text-muted);"></div>
                </div>
                <button type="button" onclick="clearSelectedStone()" style="margin-left: auto; background: none; border: none; color: var(--error); cursor: pointer;">Clear</button>
              </div>
            </div>
          </div>

          <!-- Listing Details -->
          <div class="form-section">
            <div class="form-section-title">Listing Details</div>
            <div class="form-group">
              <label>Title *</label>
              <input type="text" id="listing-title" placeholder="e.g., Calacatta Gold Remnant 24x36, White Subway Tile 200 sqft" required>
            </div>
            <div class="form-group">
              <label>Description</label>
              <textarea id="listing-description" rows="3" placeholder="Describe your item - condition, origin, why selling, any defects, etc."></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Condition</label>
                <select id="listing-condition">
                  <option value="new">New / Unused</option>
                  <option value="remnant">Remnant / Leftover</option>
                  <option value="overstock">Overstock</option>
                  <option value="used">Used / Reclaimed</option>
                  <option value="refurbished">Refurbished</option>
                </select>
              </div>
              <div class="form-group">
                <label>Brand (optional)</label>
                <input type="text" id="listing-brand-input" placeholder="e.g., MSI, Daltile, Shaw">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Dimensions / Size</label>
                <input type="text" id="listing-dimensions" placeholder="e.g., 24x36 in, 200 sqft, 10x20 cm">
              </div>
              <div class="form-group" id="thickness-group">
                <label>Thickness</label>
                <select id="listing-thickness">
                  <option value="">Select...</option>
                  <option value="2cm">2cm (3/4")</option>
                  <option value="3cm">3cm (1 1/4")</option>
                  <option value="1cm">1cm (3/8")</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Quantity</label>
                <input type="number" id="listing-quantity" value="1" min="1">
              </div>
              <div class="form-group">
                <label>Price ($)</label>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <input type="number" id="listing-price" placeholder="0.00" step="0.01" min="0" style="flex: 1;">
                  <label style="display: flex; align-items: center; gap: 6px; font-size: 12px; white-space: nowrap;">
                    <input type="checkbox" id="listing-price-contact" onchange="togglePriceField()">
                    Contact for price
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Images -->
          <div class="form-section">
            <div class="form-section-title">Images (up to 4)</div>

            <!-- Image Upload Area -->
            <div class="image-upload-section">
              <div class="image-upload-grid" id="image-upload-grid">
                <!-- Image Slot 1 -->
                <div class="image-upload-slot" id="image-slot-1" onclick="triggerImageUpload(1)">
                  <input type="file" id="image-file-1" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(1, this)">
                  <input type="hidden" id="listing-image-1">
                  <div class="upload-placeholder" id="upload-placeholder-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Add Photo</span>
                  </div>
                  <img id="image-preview-1" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-1" onclick="removeImage(event, 1)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-1" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-1"></div>
                  </div>
                </div>

                <!-- Image Slot 2 -->
                <div class="image-upload-slot" id="image-slot-2" onclick="triggerImageUpload(2)">
                  <input type="file" id="image-file-2" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(2, this)">
                  <input type="hidden" id="listing-image-2">
                  <div class="upload-placeholder" id="upload-placeholder-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-2" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-2" onclick="removeImage(event, 2)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-2" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-2"></div>
                  </div>
                </div>

                <!-- Image Slot 3 -->
                <div class="image-upload-slot" id="image-slot-3" onclick="triggerImageUpload(3)">
                  <input type="file" id="image-file-3" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(3, this)">
                  <input type="hidden" id="listing-image-3">
                  <div class="upload-placeholder" id="upload-placeholder-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-3" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-3" onclick="removeImage(event, 3)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-3" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-3"></div>
                  </div>
                </div>

                <!-- Image Slot 4 -->
                <div class="image-upload-slot" id="image-slot-4" onclick="triggerImageUpload(4)">
                  <input type="file" id="image-file-4" accept="image/*" capture="environment" style="display: none;" onchange="handleImageUpload(4, this)">
                  <input type="hidden" id="listing-image-4">
                  <div class="upload-placeholder" id="upload-placeholder-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <img id="image-preview-4" class="upload-preview" src="" style="display: none;">
                  <button type="button" class="remove-image-btn" id="remove-btn-4" onclick="removeImage(event, 4)" style="display: none;">&times;</button>
                  <div class="upload-progress" id="upload-progress-4" style="display: none;">
                    <div class="upload-progress-bar" id="upload-bar-4"></div>
                  </div>
                </div>
              </div>
              <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; text-align: center;">
                Tap to take a photo or upload from your gallery. First image will be the main photo.
              </p>
            </div>
          </div>

          <!-- Location -->
          <div class="form-section">
            <div class="form-section-title">Location</div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="listing-city" placeholder="Phoenix">
              </div>
              <div class="form-group">
                <label>State</label>
                <select id="listing-state">
                  <option value="">Select State...</option>
                  <option value="AZ">Arizona</option>
                  <option value="CA">California</option>
                  <option value="CO">Colorado</option>
                  <option value="NV">Nevada</option>
                  <option value="NM">New Mexico</option>
                  <option value="TX">Texas</option>
                  <option value="UT">Utah</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>ZIP Code</label>
              <input type="text" id="listing-zip" placeholder="85374" maxlength="10">
            </div>
          </div>

          <!-- Contact Preferences -->
          <div class="form-section">
            <div class="form-section-title">Contact Preferences</div>
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">How should interested buyers contact you?</p>

            <div class="contact-pref-item" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;" onclick="document.getElementById('listing-show-email').click()">
              <input type="checkbox" id="listing-show-email" style="width: 20px; height: 20px; accent-color: #f9cb00; cursor: pointer;">
              <span style="font-size: 14px; color: #ccc; text-transform: none;">Show my email address</span>
            </div>

            <div class="contact-pref-item" style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;" onclick="document.getElementById('listing-show-phone').click()">
              <input type="checkbox" id="listing-show-phone" style="width: 20px; height: 20px; accent-color: #f9cb00; cursor: pointer;">
              <span style="font-size: 14px; color: #ccc; text-transform: none;">Show my phone number</span>
            </div>

            <div class="contact-pref-item" style="display: flex; align-items: center; gap: 12px; cursor: pointer;" onclick="document.getElementById('listing-contact-form').click()">
              <input type="checkbox" id="listing-contact-form" checked style="width: 20px; height: 20px; accent-color: #f9cb00; cursor: pointer;">
              <span style="font-size: 14px; color: #ccc; text-transform: none;">Allow contact through inquiry form</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeCreateListingModal()">Cancel</button>
        <button type="submit" form="create-listing-form" class="btn-modern primary" id="submit-listing-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        </button>
      </div>
    </div>
  </div>

  <!-- Create Estimate Modal - Professional Estimating System -->
  <div id="create-estimate-modal" class="modal-overlay" onclick="if(event.target === this) closeCreateEstimateModal()">
    <div class="modal-content" style="max-width: 1100px; max-height: 95vh; overflow-y: auto;">
      <!-- Professional Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, rgba(249,203,0,0.15), rgba(249,203,0,0.05)); border-bottom: 2px solid var(--gold-primary); padding: 20px 24px;">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="width: 50px; height: 50px; background: var(--gold-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="#1a1a1a" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
          </div>
          <div>
            <h2 class="modal-title" style="margin: 0; font-size: 22px;">Professional Estimate</h2>
            <div style="display: flex; align-items: center; gap: 16px; margin-top: 4px;">
              <span style="font-size: 13px; color: var(--text-muted);">Estimate #: <strong id="estimate-number-display" style="color: var(--gold-primary);">Loading...</strong></span>
              <span style="font-size: 13px; color: var(--text-muted);">Date: <strong id="estimate-date-display" style="color: #fff;"></strong></span>
            </div>
          </div>
        </div>
        <button class="modal-close" onclick="closeCreateEstimateModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="modal-body" style="padding: 0;">
        <form id="create-estimate-form" onsubmit="return handleCreateEstimate(event)">
          <!-- Two Column Layout for Customer & Project -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; border-bottom: 1px solid var(--border-subtle);">
            <!-- Customer Information -->
            <div class="form-section" style="padding: 20px 24px; border-right: 1px solid var(--border-subtle); margin: 0;">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                Customer Information
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Customer Name *</label>
                <input type="text" id="estimate-customer-name" required placeholder="John Smith" style="font-size: 15px;">
              </div>
              <div class="form-row" style="gap: 12px; margin-bottom: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Email</label>
                  <input type="email" id="estimate-customer-email" placeholder="customer@email.com">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Phone</label>
                  <input type="tel" id="estimate-customer-phone" placeholder="(602) 555-1234">
                </div>
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Address</label>
                <input type="text" id="estimate-customer-address" placeholder="123 Main St">
              </div>
              <div class="form-row" style="gap: 12px;">
                <div class="form-group" style="flex: 2; margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">City</label>
                  <input type="text" id="estimate-customer-city" placeholder="Phoenix">
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">State</label>
                  <input type="text" id="estimate-customer-state" placeholder="AZ" value="AZ">
                </div>
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">ZIP</label>
                  <input type="text" id="estimate-customer-zip" placeholder="85001">
                </div>
              </div>
            </div>

            <!-- Project Details -->
            <div class="form-section" style="padding: 20px 24px; margin: 0;">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                Project Details
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Name</label>
                <input type="text" id="estimate-project-name" placeholder="Kitchen Countertop Installation" style="font-size: 15px;">
              </div>
              <div class="form-row" style="gap: 12px; margin-bottom: 12px;">
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Project Type</label>
                  <select id="estimate-project-type">
                    <option value="countertops">Countertops</option>
                    <option value="tile">Tile Installation</option>
                    <option value="flooring">Flooring</option>
                    <option value="bathroom">Bathroom Remodel</option>
                    <option value="kitchen">Kitchen Remodel</option>
                    <option value="custom">Custom Project</option>
                  </select>
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                  <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Valid For (Days)</label>
                  <select id="estimate-valid-days" onchange="updateEstimateValidDate()">
                    <option value="15">15 Days</option>
                    <option value="30" selected>30 Days</option>
                    <option value="45">45 Days</option>
                    <option value="60">60 Days</option>
                    <option value="90">90 Days</option>
                  </select>
                </div>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Scope of Work</label>
                <textarea id="estimate-project-desc" rows="3" placeholder="Describe the project scope, including measurements, materials, and work to be performed..." style="resize: vertical;"></textarea>
              </div>
              <input type="hidden" id="estimate-valid-until">
            </div>
          </div>

          <!-- Line Items Section with Categories -->
          <div class="form-section" style="padding: 20px 24px; margin: 0; border-bottom: 1px solid var(--border-subtle);">
            <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
                Items & Services
              </div>
              <div style="display: flex; gap: 8px;">
                <button type="button" class="btn-modern secondary small" onclick="openCatalogPicker()" style="font-size: 12px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  From Catalog
                </button>
                <div class="dropdown" style="position: relative;">
                  <button type="button" class="btn-modern primary small" onclick="toggleAddItemMenu()" style="font-size: 12px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    Add Item
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
                  </button>
                  <div id="add-item-menu" class="dropdown-menu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 8px; min-width: 180px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <button type="button" onclick="addEstimateLineItem('material')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #3b82f6;"></span>
                      Material
                    </button>
                    <button type="button" onclick="addEstimateLineItem('labor')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e;"></span>
                      Labor
                    </button>
                    <button type="button" onclick="addEstimateLineItem('service')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #a855f7;"></span>
                      Service/Fee
                    </button>
                    <div style="border-top: 1px solid var(--border-subtle); margin: 4px 0;"></div>
                    <button type="button" onclick="addEstimateLineItem('other')" style="width: 100%; padding: 10px 14px; text-align: left; background: none; border: none; color: #fff; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 13px;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='none'">
                      <span style="width: 8px; height: 8px; border-radius: 50%; background: #6b7280;"></span>
                      Other
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Line Items Table Header -->
            <div style="display: grid; grid-template-columns: 30px 2fr 90px 70px 85px 85px 70px 90px 36px; gap: 6px; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 8px 8px 0 0; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); font-weight: 600;">
              <span></span>
              <span>Description</span>
              <span>Unit</span>
              <span style="text-align: center;">Qty</span>
              <span style="text-align: right; color: rgba(59,130,246,0.8);" title="Your cost (internal only)">Cost</span>
              <span style="text-align: right;">Price</span>
              <span style="text-align: center; color: rgba(59,130,246,0.8);" title="Margin % (internal only)">Margin</span>
              <span style="text-align: right;">Total</span>
              <span></span>
            </div>

            <div id="estimate-line-items" style="min-height: 60px; border: 1px solid var(--border-subtle); border-top: none; border-radius: 0 0 8px 8px; background: rgba(0,0,0,0.15);">
              <!-- Line items will be added here -->
              <div id="empty-line-items-msg" style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 13px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                <br>No items added yet. Click "Add Item" or "From Catalog" to begin.
              </div>
            </div>

            <!-- Hidden Template -->
            <div class="line-item-template" style="display: none;">
              <div class="estimate-line-item" data-category="material" style="display: grid; grid-template-columns: 30px 2fr 90px 70px 85px 85px 70px 90px 36px; gap: 6px; align-items: start; padding: 12px; border-bottom: 1px solid var(--border-subtle);">
                <div class="category-indicator" style="display: flex; align-items: center; justify-content: center; padding-top: 8px;">
                  <span class="category-dot" style="width: 10px; height: 10px; border-radius: 50%; background: #3b82f6;" title="Material"></span>
                </div>
                <div>
                  <input type="text" class="item-name" placeholder="Item name" style="width: 100%; margin-bottom: 4px; font-weight: 500;">
                  <input type="text" class="item-desc" placeholder="Description or specifications" style="width: 100%; font-size: 12px; opacity: 0.7; padding: 6px 10px;">
                </div>
                <select class="item-unit" style="height: 38px;">
                  <option value="sqft">Sq Ft</option>
                  <option value="lnft">Ln Ft</option>
                  <option value="each">Each</option>
                  <option value="slab">Slab</option>
                  <option value="hour">Hour</option>
                  <option value="day">Day</option>
                  <option value="job">Flat Rate</option>
                </select>
                <input type="number" class="item-qty" placeholder="Qty" value="1" min="0" step="0.01" style="text-align: center;">
                <input type="number" class="item-cost" placeholder="Cost" value="" min="0" step="0.01" style="text-align: right; background: rgba(59,130,246,0.1); border-color: rgba(59,130,246,0.3);" title="Your cost (internal only)">
                <input type="number" class="item-price" placeholder="Price" value="0" min="0" step="0.01" style="text-align: right;">
                <div class="item-margin" style="text-align: center; padding: 10px 4px; font-size: 12px; color: var(--text-muted); background: rgba(0,0,0,0.2); border-radius: 4px;" title="Margin % (internal only)">--%</div>
                <div class="item-total" style="text-align: right; padding: 10px 0; font-weight: 600; color: var(--gold-primary); font-size: 14px;">$0.00</div>
                <button type="button" class="btn-remove-item" onclick="removeEstimateLineItem(this)" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 8px; transition: color 0.2s;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#6b7280'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
                <input type="hidden" class="item-category" value="material">
              </div>
            </div>
          </div>

          <!-- Totals & Payment Section -->
          <div style="display: grid; grid-template-columns: 1fr 400px; gap: 0; border-bottom: 1px solid var(--border-subtle);">
            <!-- Left: Notes Section -->
            <div class="form-section" style="padding: 20px 24px; margin: 0; border-right: 1px solid var(--border-subtle);">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                Notes & Inclusions
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">This Estimate Includes</label>
                <textarea id="estimate-inclusions" rows="3" placeholder="- All materials as specified above&#10;- Professional installation&#10;- Cleanup and debris removal&#10;- 1-year workmanship warranty" style="font-size: 13px;"></textarea>
              </div>
              <div class="form-group" style="margin-bottom: 12px;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">This Estimate Does NOT Include</label>
                <textarea id="estimate-exclusions" rows="2" placeholder="- Plumbing/electrical modifications&#10;- Structural changes&#10;- Permits (if required)" style="font-size: 13px;"></textarea>
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Additional Notes</label>
                <textarea id="estimate-notes" rows="2" placeholder="Any additional notes for the customer..." style="font-size: 13px;"></textarea>
              </div>
            </div>

            <!-- Right: Totals -->
            <div class="form-section" style="padding: 20px 24px; margin: 0; background: rgba(0,0,0,0.15);">
              <div class="form-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Pricing Summary
              </div>
              <div class="estimate-totals" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Margin Summary (Internal Only) -->
                <div id="margin-summary" style="margin-bottom: 12px; padding: 12px; background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2); border-radius: 8px;">
                  <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: rgba(59,130,246,0.9); font-weight: 600;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>
                    Internal Only - Not shown to customer
                  </div>
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px;">
                    <span style="color: var(--text-muted);">Your Cost</span>
                    <span id="estimate-total-cost" style="font-weight: 500;">$0.00</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 6px;">
                    <span style="color: var(--text-muted);">Gross Profit</span>
                    <span id="estimate-total-profit" style="font-weight: 600; color: #22c55e;">$0.00</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; font-size: 14px; padding-top: 8px; border-top: 1px solid rgba(59,130,246,0.2);">
                    <span style="font-weight: 600; color: rgba(59,130,246,0.9);">Margin</span>
                    <span id="estimate-total-margin" style="font-weight: 700; color: #22c55e;">--%</span>
                  </div>
                </div>

                <!-- Category Subtotals -->
                <div id="category-subtotals" style="margin-bottom: 8px; padding-bottom: 12px; border-bottom: 1px solid var(--border-subtle);">
                  <div class="category-subtotal" data-category="material" style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 6px; height: 6px; border-radius: 50%; background: #3b82f6;"></span>Materials</span>
                    <span id="subtotal-material">$0.00</span>
                  </div>
                  <div class="category-subtotal" data-category="labor" style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 6px; height: 6px; border-radius: 50%; background: #22c55e;"></span>Labor</span>
                    <span id="subtotal-labor">$0.00</span>
                  </div>
                  <div class="category-subtotal" data-category="service" style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">
                    <span style="display: flex; align-items: center; gap: 6px;"><span style="width: 6px; height: 6px; border-radius: 50%; background: #a855f7;"></span>Services/Fees</span>
                    <span id="subtotal-service">$0.00</span>
                  </div>
                </div>

                <div style="display: flex; justify-content: space-between; padding: 6px 0;">
                  <span>Subtotal</span>
                  <span id="estimate-subtotal" style="font-weight: 500;">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span>Tax</span>
                    <input type="number" id="estimate-tax-rate" value="0" min="0" max="100" step="0.01" style="width: 55px; text-align: center; padding: 4px; font-size: 12px;">
                    <span style="font-size: 12px;">%</span>
                  </div>
                  <span id="estimate-tax-amount">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span>Discount</span>
                    <input type="number" id="estimate-discount-value" value="0" min="0" step="0.01" style="width: 55px; text-align: center; padding: 4px; font-size: 12px;">
                    <select id="estimate-discount-type" style="padding: 4px; font-size: 12px;">
                      <option value="amount">$</option>
                      <option value="percent">%</option>
                    </select>
                  </div>
                  <span id="estimate-discount-amount" style="color: #22c55e;">-$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 14px 0; border-top: 2px solid var(--gold-primary); margin-top: 8px; font-size: 20px; font-weight: 700;">
                  <span>TOTAL</span>
                  <span id="estimate-total" style="color: var(--gold-primary);">$0.00</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Schedule Section -->
          <div class="form-section" style="padding: 20px 24px; margin: 0; border-bottom: 1px solid var(--border-subtle);">
            <div class="form-section-title" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Payment Schedule
              </div>
              <select id="payment-schedule-type" onchange="updatePaymentSchedule()" style="padding: 6px 12px; font-size: 13px;">
                <option value="deposit-balance">Deposit + Balance</option>
                <option value="three-part">3-Part Payment</option>
                <option value="due-on-completion">Due on Completion</option>
                <option value="custom">Custom Schedule</option>
              </select>
            </div>

            <div id="payment-schedule-container">
              <!-- Default: Deposit + Balance -->
              <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div style="padding: 16px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">1. Deposit Required</span>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <input type="number" id="estimate-deposit-percent" value="50" min="0" max="100" style="width: 50px; text-align: center; padding: 4px; font-size: 13px;" onchange="updateEstimateTotals()">
                      <span style="font-size: 13px;">%</span>
                    </div>
                  </div>
                  <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
                  <div id="estimate-deposit-amount" style="font-size: 22px; font-weight: 700; color: var(--gold-primary);">$0.00</div>
                </div>
                <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-weight: 600; font-size: 14px;">2. Balance Due</span>
                    <span id="balance-percent" style="font-size: 13px; color: var(--text-muted);">50%</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon completion</div>
                  <div id="estimate-balance-amount" style="font-size: 22px; font-weight: 700;">$0.00</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Terms & Conditions Section -->
          <div class="form-section" style="padding: 20px 24px; margin: 0;">
            <div class="form-section-title" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                Terms & Conditions
              </div>
              <button type="button" class="btn-modern secondary small" onclick="loadTermsTemplate()" style="font-size: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                Load Default Terms
              </button>
            </div>
            <div class="form-row" style="gap: 16px; margin-bottom: 16px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Warranty</label>
                <input type="text" id="estimate-warranty" placeholder="1 year workmanship warranty">
              </div>
              <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Estimated Timeline</label>
                <input type="text" id="estimate-timeline" placeholder="2-3 weeks from approval">
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Terms & Conditions</label>
              <textarea id="estimate-terms" rows="4" placeholder="Enter your standard terms and conditions..." style="font-size: 13px;"></textarea>
            </div>
            <div class="form-group" style="margin-bottom: 0; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
              <label style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #93c5fd;">Internal Notes (Not shown to customer)</label>
              <textarea id="estimate-internal-notes" rows="2" placeholder="Private notes for your records..." style="font-size: 13px; background: transparent;"></textarea>
            </div>
          </div>
        </form>
      </div>

      <!-- Footer with Actions -->
      <div class="modal-footer" style="padding: 16px 24px; background: var(--bg-secondary); border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="button" class="btn-modern secondary" onclick="closeCreateEstimateModal()">Cancel</button>
          <button type="button" class="btn-modern secondary" onclick="previewEstimate()" style="display: flex; align-items: center; gap: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            Preview
          </button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="button" class="btn-modern secondary" onclick="saveEstimateDraft()" style="display: flex; align-items: center; gap: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            Save Draft
          </button>
          <button type="submit" form="create-estimate-form" class="btn-modern primary" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
            Create & Send Estimate
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Business Settings Modal -->
  <div id="business-settings-modal" class="modal-overlay" onclick="if(event.target === this) closeBusinessSettings()">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Business Settings</h2>
        <button class="modal-close" onclick="closeBusinessSettings()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="business-settings-form" onsubmit="return saveBusinessSettings(event)">
          <!-- Logo Upload Section -->
          <div class="form-section">
            <div class="form-section-title">Company Logo</div>
            <div style="display: flex; align-items: center; gap: 24px;">
              <div id="logo-preview" style="width: 120px; height: 120px; background: var(--dark-elevated); border: 2px dashed var(--border-subtle); border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                <span id="logo-placeholder" style="color: var(--text-muted); font-size: 12px; text-align: center; padding: 10px;">No logo<br>uploaded</span>
                <img id="logo-image" src="" alt="Company Logo" style="display: none; max-width: 100%; max-height: 100%; object-fit: contain;">
              </div>
              <div style="flex: 1;">
                <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                <button type="button" class="btn-modern secondary" onclick="document.getElementById('logo-upload').click()" style="margin-bottom: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                  Upload Logo
                </button>
                <button type="button" class="btn-modern secondary" onclick="removeLogo()" id="remove-logo-btn" style="display: none; margin-left: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  Remove
                </button>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Recommended: Square image, 200x200px or larger. PNG or JPG.</p>
                <input type="hidden" id="biz-logo-url" value="">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Company Information</div>
            <div class="form-group">
              <label>Company Name</label>
              <input type="text" id="biz-company-name" placeholder="Your Company Name">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="biz-phone" placeholder="(602) 555-1234">
              </div>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="biz-email" placeholder="info@company.com">
              </div>
            </div>
            <div class="form-group">
              <label>Address</label>
              <input type="text" id="biz-address" placeholder="123 Main St">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" id="biz-city" placeholder="Phoenix">
              </div>
              <div class="form-group" style="flex: 0.5;">
                <label>State</label>
                <input type="text" id="biz-state" placeholder="AZ">
              </div>
              <div class="form-group" style="flex: 0.5;">
                <label>ZIP</label>
                <input type="text" id="biz-zip" placeholder="85001">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>License Number</label>
                <input type="text" id="biz-license" placeholder="ROC #123456">
              </div>
              <div class="form-group">
                <label>Website</label>
                <input type="url" id="biz-website" placeholder="https://yoursite.com">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Default Settings</div>
            <div class="form-row">
              <div class="form-group">
                <label>Default Tax Rate (%)</label>
                <input type="number" id="biz-tax-rate" value="0" min="0" max="100" step="0.01">
              </div>
              <div class="form-group">
                <label>Default Deposit (%)</label>
                <input type="number" id="biz-deposit" value="50" min="0" max="100">
              </div>
            </div>
            <div class="form-group">
              <label>Default Payment Terms</label>
              <input type="text" id="biz-payment-terms" placeholder="50% deposit, balance due upon completion">
            </div>
            <div class="form-group">
              <label>Default Warranty</label>
              <input type="text" id="biz-warranty" placeholder="1 year workmanship warranty">
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Numbering</div>
            <div class="form-row">
              <div class="form-group">
                <label>Estimate Prefix</label>
                <input type="text" id="biz-estimate-prefix" value="EST-" maxlength="10">
              </div>
              <div class="form-group">
                <label>Invoice Prefix</label>
                <input type="text" id="biz-invoice-prefix" value="INV-" maxlength="10">
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Terms & Conditions</div>
            <div class="form-group">
              <label>Default Terms & Conditions for Estimates</label>
              <textarea id="biz-estimate-terms" rows="4" placeholder="Enter your standard terms and conditions..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeBusinessSettings()">Cancel</button>
        <button type="submit" form="business-settings-form" class="btn-modern primary">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- New Job Modal -->
  <div id="new-job-modal" class="modal-overlay" onclick="if(event.target === this) closeNewJobModal()">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Create New Job</h2>
        <button class="modal-close" onclick="closeNewJobModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="new-job-form" onsubmit="createJob(event)">
        <div class="modal-body">
          <div class="form-section">
            <div class="form-section-title">Customer Information</div>
            <div class="form-group">
              <label>Select Existing Customer or Create New</label>
              <select id="job-customer-select" onchange="toggleNewCustomerFields()">
                <option value="">-- Select Customer --</option>
                <option value="new">+ Add New Customer</option>
              </select>
            </div>
            <div id="new-customer-fields" style="display: none;">
              <div class="form-row">
                <div class="form-group">
                  <label>Customer Name *</label>
                  <input type="text" id="job-customer-name" placeholder="John Smith">
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" id="job-customer-email" placeholder="john@example.com">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Phone</label>
                  <input type="tel" id="job-customer-phone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                  <label>Address</label>
                  <input type="text" id="job-customer-address" placeholder="123 Main St">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>City</label>
                  <input type="text" id="job-customer-city" placeholder="Phoenix">
                </div>
                <div class="form-group" style="flex: 0.5;">
                  <label>State</label>
                  <input type="text" id="job-customer-state" placeholder="AZ" maxlength="2">
                </div>
                <div class="form-group" style="flex: 0.5;">
                  <label>ZIP</label>
                  <input type="text" id="job-customer-zip" placeholder="85001">
                </div>
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Job Details</div>
            <div class="form-group">
              <label>Job Title / Description *</label>
              <input type="text" id="job-title" required placeholder="Kitchen Countertop Installation">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Job Type</label>
                <select id="job-type">
                  <option value="installation">Installation</option>
                  <option value="fabrication">Fabrication</option>
                  <option value="repair">Repair</option>
                  <option value="template">Template/Measure</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Priority</label>
                <select id="job-priority">
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="urgent">Urgent</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Total Amount ($)</label>
                <input type="number" id="job-total" step="0.01" min="0" placeholder="0.00">
              </div>
              <div class="form-group">
                <label>Deposit Received ($)</label>
                <input type="number" id="job-deposit" step="0.01" min="0" placeholder="0.00">
              </div>
            </div>
            <div class="form-group">
              <label>Notes</label>
              <textarea id="job-notes" rows="3" placeholder="Special instructions, material details, etc."></textarea>
            </div>
          </div>

          <div class="form-section">
            <div class="form-section-title">Schedule (Optional)</div>
            <div class="form-row">
              <div class="form-group">
                <label>Scheduled Date</label>
                <input type="date" id="job-scheduled-date">
              </div>
              <div class="form-group">
                <label>Scheduled Time</label>
                <input type="time" id="job-scheduled-time">
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeNewJobModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Create Job</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Schedule Modal (Calendar) -->
  <div id="quick-schedule-modal" class="modal-overlay" onclick="if(event.target === this) closeQuickScheduleModal()">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Quick Schedule</h2>
        <button class="modal-close" onclick="closeQuickScheduleModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="quick-schedule-form" onsubmit="submitQuickSchedule(event)">
        <div class="modal-body">
          <div class="form-group">
            <label>Event Type</label>
            <select id="schedule-event-type" class="input-modern" required onchange="toggleScheduleFields()">
              <option value="job">Job/Installation</option>
              <option value="measure">Field Measure</option>
              <option value="consultation">Consultation</option>
              <option value="followup">Follow-up</option>
            </select>
          </div>

          <div class="form-group">
            <label>Select Job (Optional)</label>
            <select id="schedule-job-select" class="input-modern">
              <option value="">-- Create New or Select Existing --</option>
            </select>
          </div>

          <div id="schedule-new-job-fields">
            <div class="form-group">
              <label>Customer *</label>
              <select id="schedule-customer-select" class="input-modern">
                <option value="">-- Select Customer --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Description *</label>
              <input type="text" id="schedule-description" class="input-modern" placeholder="Kitchen countertop install" required>
            </div>
          </div>

          <div class="form-row-modern">
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="schedule-date" class="input-modern" required>
            </div>
            <div class="form-group">
              <label>Time</label>
              <select id="schedule-time" class="input-modern">
                <option value="">All Day</option>
                <option value="07:00">7:00 AM</option>
                <option value="08:00">8:00 AM</option>
                <option value="09:00">9:00 AM</option>
                <option value="10:00">10:00 AM</option>
                <option value="11:00">11:00 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:00">1:00 PM</option>
                <option value="14:00">2:00 PM</option>
                <option value="15:00">3:00 PM</option>
                <option value="16:00">4:00 PM</option>
                <option value="17:00">5:00 PM</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>Duration</label>
            <select id="schedule-duration" class="input-modern">
              <option value="1">1 hour</option>
              <option value="2" selected>2 hours</option>
              <option value="3">3 hours</option>
              <option value="4">4 hours (Half Day)</option>
              <option value="8">8 hours (Full Day)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea id="schedule-notes" class="input-modern" rows="2" placeholder="Access code, special instructions..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeQuickScheduleModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Schedule</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Day Events Modal (Calendar) -->
  <div id="day-events-modal" class="modal-overlay" onclick="if(event.target === this) closeDayEventsModal()">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title" id="day-events-title">Events for January 1</h2>
        <button class="modal-close" onclick="closeDayEventsModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body" id="day-events-content">
        <!-- Events will be rendered here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern primary" onclick="openQuickScheduleForDate()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Add Event
        </button>
      </div>
    </div>
  </div>

  <!-- Job Detail Modal -->
  <div id="job-detail-modal" class="modal-overlay" onclick="if(event.target === this) closeJobDetailModal()">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Job Details - <span id="job-detail-number">JOB-0001</span></h2>
        <button class="modal-close" onclick="closeJobDetailModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Job Status Bar -->
        <div style="display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap;">
          <select id="job-detail-status" onchange="updateJobStatus()" style="padding: 8px 16px; border-radius: 8px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);">
            <option value="new">New</option>
            <option value="reviewing">Reviewing</option>
            <option value="material_ordered">Material Ordered</option>
            <option value="material_received">Material Received</option>
            <option value="assigned">Assigned</option>
            <option value="scheduled">Scheduled</option>
            <option value="measured">Measured</option>
            <option value="in_production">In Production</option>
            <option value="ready">Ready</option>
            <option value="installing">Installing</option>
            <option value="completed">Completed</option>
            <option value="on_hold">On Hold</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <button class="btn-modern secondary small" onclick="sendCustomerUpdate()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Email Customer
          </button>
          <button class="btn-modern secondary small" onclick="openAssignContractorModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            Assign Contractor
          </button>
          <button class="btn-modern secondary small" onclick="orderMaterials()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            Order Materials
          </button>
        </div>

        <!-- Two Column Layout -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
          <!-- Left Column - Customer & Job Info -->
          <div>
            <div class="form-section">
              <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                Customer
                <button class="btn-modern secondary small" onclick="sendCustomerPortalLink()" title="Send portal access link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                  Portal Link
                </button>
              </div>
              <div id="job-detail-customer" style="padding: 12px; background: var(--dark-elevated); border-radius: 8px;">
                <div style="font-weight: 600;" id="job-customer-name-display">Loading...</div>
                <div style="font-size: 13px; color: var(--text-muted);" id="job-customer-email-display"></div>
                <div style="font-size: 13px; color: var(--text-muted);" id="job-customer-phone-display"></div>
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;" id="job-customer-address-display"></div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">Job Info</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Type</label>
                  <div id="job-detail-type" style="font-weight: 500;">Installation</div>
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Priority</label>
                  <div id="job-detail-priority" style="font-weight: 500;">Normal</div>
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Total</label>
                  <div id="job-detail-total" style="font-weight: 600; color: var(--gold-primary);">$0.00</div>
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Balance Due</label>
                  <div id="job-detail-balance" style="font-weight: 600;">$0.00</div>
                </div>
              </div>
              <div style="margin-top: 12px;">
                <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Notes</label>
                <div id="job-detail-notes" style="font-size: 14px; color: var(--text-secondary);">-</div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">Schedule</div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Field Measure</label>
                  <input type="datetime-local" id="job-field-measure-date" onchange="updateJobSchedule('field_measure_date')"
                         style="width: 100%; padding: 8px; border-radius: 6px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 13px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Install Date</label>
                  <input type="datetime-local" id="job-install-date" onchange="updateJobSchedule('install_date')"
                         style="width: 100%; padding: 8px; border-radius: 6px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary); font-size: 13px;">
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                Team & Contractors
                <button class="btn-modern secondary small" onclick="openAssignContractorModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                  Add
                </button>
              </div>
              <div id="job-contractors-list" style="min-height: 60px;">
                <div style="color: var(--text-muted); font-size: 13px;">No contractors assigned yet.</div>
              </div>
            </div>
          </div>

          <!-- Right Column - Files & Timeline -->
          <div>
            <div class="form-section">
              <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                Files & Drawings
                <label class="btn-modern secondary small" style="cursor: pointer;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                  Upload
                  <input type="file" id="job-file-upload" multiple accept="image/*,.pdf,.dxf,.dwg" style="display: none;" onchange="uploadJobFiles(event)">
                </label>
              </div>
              <div id="job-files-list" style="min-height: 100px; max-height: 300px; overflow-y: auto;">
                <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
                  No files uploaded yet.<br>
                  <span style="font-size: 12px;">Drop files here or click Upload</span>
                </div>
              </div>
            </div>

            <div class="form-section">
              <div class="form-section-title">Activity Timeline</div>
              <div id="job-timeline" style="max-height: 200px; overflow-y: auto;">
                <div style="color: var(--text-muted); font-size: 13px;">No activity yet.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeJobDetailModal()">Close</button>
        <button type="button" class="btn-modern primary" onclick="saveJobChanges()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Customers Modal -->
  <div id="customers-modal" class="modal-overlay" onclick="if(event.target === this) closeCustomersModal()">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Customer Database</h2>
        <button class="modal-close" onclick="closeCustomersModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
          <input type="text" id="customer-search" placeholder="Search customers..." style="flex: 1; max-width: 300px; padding: 8px 12px; border-radius: 8px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); color: var(--text-primary);" oninput="searchCustomers()">
          <button class="btn-modern primary small" onclick="openAddCustomerModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Customer
          </button>
        </div>
        <div id="customers-list-modal">
          <div class="spinner" style="margin: 40px auto;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Customer Modal -->
  <div id="add-customer-modal" class="modal-overlay" onclick="if(event.target === this) closeAddCustomerModal()">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title" id="customer-modal-title">Add New Customer</h2>
        <button class="modal-close" onclick="closeAddCustomerModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="add-customer-form" onsubmit="saveCustomer(event)">
        <input type="hidden" id="edit-customer-id">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="cust-name" required placeholder="John Smith">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="cust-email" placeholder="john@email.com">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="cust-phone" placeholder="(555) 123-4567">
            </div>
            <div class="form-group">
              <label>Company</label>
              <input type="text" id="cust-company" placeholder="Optional">
            </div>
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="cust-address" placeholder="123 Main St">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" id="cust-city" placeholder="Phoenix">
            </div>
            <div class="form-group" style="max-width: 80px;">
              <label>State</label>
              <input type="text" id="cust-state" value="AZ" maxlength="2">
            </div>
            <div class="form-group" style="max-width: 100px;">
              <label>ZIP</label>
              <input type="text" id="cust-zip" placeholder="85001">
            </div>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="cust-notes" rows="2" placeholder="Internal notes about this customer..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeAddCustomerModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Save Customer</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Contractor Modal -->
  <div id="new-contractor-modal" class="modal-overlay" onclick="if(event.target === this) closeNewContractorModal()">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Add Contractor</h2>
        <button class="modal-close" onclick="closeNewContractorModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="new-contractor-form" onsubmit="createContractor(event)">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="contractor-name" required placeholder="John's Fabrication">
            </div>
            <div class="form-group">
              <label>Type *</label>
              <select id="contractor-type" required>
                <option value="fabricator">Fabricator</option>
                <option value="installer">Installer</option>
                <option value="plumber">Plumber</option>
                <option value="electrician">Electrician</option>
                <option value="template">Template Tech</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="contractor-email" placeholder="john@fabrication.com">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="contractor-phone" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="form-group">
            <label>Company / Business Name</label>
            <input type="text" id="contractor-company" placeholder="ABC Stoneworks LLC">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Hourly Rate ($)</label>
              <input type="number" id="contractor-rate" step="0.01" min="0" placeholder="75.00">
            </div>
            <div class="form-group">
              <label>License #</label>
              <input type="text" id="contractor-license" placeholder="ROC #123456">
            </div>
          </div>
          <div class="form-group">
            <label>Notes</label>
            <textarea id="contractor-notes" rows="2" placeholder="Specialties, availability, etc."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeNewContractorModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Add Contractor</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Contractor Profile/Detail Modal -->
  <div id="contractor-profile-modal" class="modal-overlay" onclick="if(event.target === this) closeContractorProfileModal()">
    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Contractor Profile</h2>
        <button class="modal-close" onclick="closeContractorProfileModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Trust Score Badge -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: var(--dark-surface); border-radius: 12px;">
          <div>
            <div style="font-size: 20px; font-weight: 700;" id="contractor-profile-name">Contractor Name</div>
            <div style="font-size: 13px; color: var(--text-muted);" id="contractor-profile-company">Company Name</div>
          </div>
          <div style="text-align: center;">
            <div class="trust-score-badge" id="contractor-trust-badge">
              <span class="trust-score-value" id="contractor-trust-score">0</span>
              <span class="trust-score-label">Trust Score</span>
            </div>
          </div>
        </div>

        <!-- Invite Link Section -->
        <div class="form-section">
          <div class="form-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
            Invite to Join Platform
          </div>
          <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">
            Share this link or QR code so the contractor can claim their profile, upload documents, and build their trust score.
          </p>
          <div style="display: flex; gap: 12px; align-items: stretch;">
            <div style="flex: 1;">
              <div style="display: flex; gap: 8px;">
                <input type="text" id="contractor-invite-link" readonly
                       style="flex: 1; padding: 10px 12px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 12px;"
                       value="Generating link...">
                <button class="btn-modern secondary" onclick="copyInviteLink()" title="Copy Link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                </button>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="btn-modern secondary small" onclick="sendInviteEmail()" style="flex: 1;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Email Invite
                </button>
                <button class="btn-modern secondary small" onclick="sendInviteSMS()" style="flex: 1;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                  Text Invite
                </button>
              </div>
            </div>
            <div style="width: 100px; height: 100px; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center;" id="contractor-qr-code">
              <div style="color: #333; font-size: 10px; text-align: center;">QR Code</div>
            </div>
          </div>
        </div>

        <!-- Verification Checklist -->
        <div class="form-section">
          <div class="form-section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
            Verification Status
          </div>
          <div id="contractor-verification-checklist" style="display: grid; gap: 8px;">
            <!-- Checklist items will be rendered here -->
          </div>
        </div>

        <!-- Documents Section -->
        <div class="form-section">
          <div class="form-section-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 8px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Documents
            </span>
            <label class="btn-modern secondary small" style="cursor: pointer;">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
              Upload
              <input type="file" id="contractor-doc-upload" accept=".pdf,.jpg,.jpeg,.png" style="display: none;" onchange="uploadContractorDocument(event)">
            </label>
          </div>
          <div id="contractor-documents-list" style="min-height: 60px;">
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No documents uploaded yet
            </div>
          </div>
        </div>

        <!-- Contact Info -->
        <div class="form-section">
          <div class="form-section-title">Contact Information</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Email</label>
              <div id="contractor-profile-email" style="font-size: 14px;">-</div>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Phone</label>
              <div id="contractor-profile-phone" style="font-size: 14px;">-</div>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Type</label>
              <div id="contractor-profile-type" style="font-size: 14px;">-</div>
            </div>
            <div>
              <label style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">License #</label>
              <div id="contractor-profile-license" style="font-size: 14px;">-</div>
            </div>
          </div>
        </div>

        <!-- Job History -->
        <div class="form-section">
          <div class="form-section-title">Job History</div>
          <div id="contractor-job-history" style="max-height: 150px; overflow-y: auto;">
            <div style="color: var(--text-muted); font-size: 13px;">No jobs assigned yet</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeContractorProfileModal()">Close</button>
        <button type="button" class="btn-modern primary" onclick="editContractorDetails()">Edit Details</button>
      </div>
    </div>
  </div>

  <!-- Assign Contractor Modal -->
  <div id="assign-contractor-modal" class="modal-overlay" onclick="if(event.target === this) closeAssignContractorModal()">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title">Assign Contractor to Job</h2>
        <button class="modal-close" onclick="closeAssignContractorModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <form id="assign-contractor-form" onsubmit="assignContractor(event)">
        <div class="modal-body">
          <!-- Existing Contractor Selection -->
          <div id="select-existing-contractor">
            <div class="form-group">
              <label>Select Contractor *</label>
              <select id="assign-contractor-select" onchange="toggleNewContractorInAssign()">
                <option value="">-- Select Contractor --</option>
                <option value="__new__">+ Add New Contractor</option>
              </select>
            </div>
          </div>

          <!-- New Contractor Form (hidden by default) -->
          <div id="new-contractor-inline" style="display: none; padding: 16px; background: var(--dark-surface); border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--gold-primary);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 600; color: var(--gold-primary);">New Contractor Details</span>
              <button type="button" class="btn-modern secondary small" onclick="cancelNewContractorInline()" style="padding: 4px 8px; font-size: 11px;">Cancel</button>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Name *</label>
                <input type="text" id="inline-contractor-name" placeholder="John Smith">
              </div>
              <div class="form-group">
                <label>Company</label>
                <input type="text" id="inline-contractor-company" placeholder="ABC Stoneworks">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="inline-contractor-email" placeholder="john@example.com">
              </div>
              <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="inline-contractor-phone" placeholder="(555) 123-4567">
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Role on this Job</label>
            <select id="assign-contractor-role">
              <option value="fabricator">Fabricator</option>
              <option value="installer">Installer</option>
              <option value="plumber">Plumber</option>
              <option value="electrician">Electrician</option>
              <option value="template">Template Tech</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Amount to Pay ($)</label>
            <input type="number" id="assign-contractor-amount" step="0.01" min="0" placeholder="0.00">
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="assign-contractor-notify" checked style="width: 18px; height: 18px;">
              Send email invitation to contractor
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-modern secondary" onclick="closeAssignContractorModal()">Cancel</button>
          <button type="submit" class="btn-modern primary">Assign Contractor</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Service Catalog Modal -->
  <div id="service-catalog-modal" class="modal-overlay" onclick="if(event.target === this) closeServiceCatalog()">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Service & Material Catalog</h2>
        <button class="modal-close" onclick="closeServiceCatalog()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 20px;">Create reusable services and materials for quick estimate creation.</p>

        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
          <div class="table-filters">
            <button class="filter-btn active" onclick="filterCatalog('all')">All</button>
            <button class="filter-btn" onclick="filterCatalog('material')">Materials</button>
            <button class="filter-btn" onclick="filterCatalog('service')">Services</button>
            <button class="filter-btn" onclick="filterCatalog('labor')">Labor</button>
          </div>
          <button class="btn-modern primary small" onclick="openAddCatalogItem()">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            Add Item
          </button>
        </div>

        <div id="service-catalog-list">
          <div class="empty-state" style="padding: 40px;">
            <p style="color: var(--text-muted);">No catalog items yet. Add your first service or material.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeServiceCatalog()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add Catalog Item Modal -->
  <div id="add-catalog-item-modal" class="modal-overlay" onclick="if(event.target === this) closeAddCatalogItem()" style="z-index: 10001;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Add Catalog Item</h2>
        <button class="modal-close" onclick="closeAddCatalogItem()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="add-catalog-item-form" onsubmit="return saveCatalogItem(event)">
          <div class="form-group">
            <label>Item Name *</label>
            <input type="text" id="catalog-item-name" required placeholder="e.g., Granite Installation">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="catalog-item-desc" placeholder="Brief description">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Category</label>
              <select id="catalog-item-category">
                <option value="service">Service</option>
                <option value="material">Material</option>
                <option value="labor">Labor</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label>Unit Type</label>
              <select id="catalog-item-unit">
                <option value="each">Each</option>
                <option value="sqft">Sq Ft</option>
                <option value="lnft">Ln Ft</option>
                <option value="hour">Hour</option>
                <option value="day">Day</option>
                <option value="job">Job</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Unit Price ($) *</label>
              <input type="number" id="catalog-item-price" required min="0" step="0.01" placeholder="0.00">
            </div>
            <div class="form-group">
              <label>Your Cost ($)</label>
              <input type="number" id="catalog-item-cost" min="0" step="0.01" placeholder="0.00">
            </div>
          </div>
          <input type="hidden" id="catalog-item-id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closeAddCatalogItem()">Cancel</button>
        <button type="submit" form="add-catalog-item-form" class="btn-modern primary">Save Item</button>
      </div>
    </div>
  </div>

  <!-- Payment Request Modal -->
  <div id="payment-request-modal" class="payment-modal" style="display: none;" onclick="if(event.target === this) closePaymentModal()">
    <div class="payment-modal-content">
      <div class="payment-modal-header">
        <h3>Send Payment Request</h3>
        <button class="payment-modal-close" onclick="closePaymentModal()">&times;</button>
      </div>
      <div class="payment-modal-body">
        <div class="payment-modal-info">
          <p><strong>To:</strong> <span id="payment-recipient-name"></span></p>
          <p><strong>Email:</strong> <span id="payment-recipient-email"></span></p>
        </div>
        <form id="payment-request-form" onsubmit="return sendPaymentRequest(event)">
          <input type="hidden" id="payment-inquiry-id">
          <input type="hidden" id="payment-customer-email">
          <input type="hidden" id="payment-customer-name">
          <div class="form-group">
            <label>Amount ($)</label>
            <input type="number" id="payment-amount" step="0.01" min="1" required placeholder="500.00">
          </div>
          <div class="form-group">
            <label>Description</label>
            <input type="text" id="payment-description" required placeholder="Stone remnant - Calacatta Gold 24x36">
          </div>
          <div class="form-group">
            <label>Note to Customer (optional)</label>
            <textarea id="payment-note" rows="3" placeholder="Thank you for your interest! Here's the payment link for your purchase..."></textarea>
          </div>
        </form>
      </div>
      <div class="payment-modal-footer">
        <button type="button" class="btn-modern secondary" onclick="closePaymentModal()">Cancel</button>
        <button type="submit" form="payment-request-form" class="btn-modern primary" id="send-payment-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Send Payment Link
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase config
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';

    const SUPER_ADMIN_EMAILS = ['joshb@surprisegranite.com', 'info@surprisegranite.com'];

    let supabaseClient;
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let userRole = 'customer'; // customer, contractor, vendor, admin

    // Role-based feature permissions
    const ROLE_PERMISSIONS = {
      customer: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'calendar', 'messages'],
        features: ['view_own_jobs', 'view_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews']
      },
      contractor: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'estimates', 'invoices', 'jobs', 'contractors', 'calendar', 'wallet', 'products', 'orders', 'messages'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews', 'view_contractors', 'manage_customers', 'view_leads', 'hire_subcontractors', 'ai_tools', 'analytics']
      },
      fabricator: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'estimates', 'invoices', 'jobs', 'contractors', 'calendar', 'wallet', 'products', 'orders', 'messages', 'inventory', 'slabs'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews', 'view_contractors', 'manage_customers', 'view_leads', 'hire_subcontractors', 'ai_tools', 'analytics', 'manage_inventory', 'slab_management']
      },
      vendor: {
        nav: ['dashboard', 'profile', 'products', 'orders', 'messages', 'calendar', 'wallet'],
        features: ['list_products', 'receive_orders', 'view_analytics', 'message_team', 'manage_inventory', 'connect_contractors']
      },
      admin: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'estimates', 'invoices', 'jobs', 'contractors', 'calendar', 'wallet', 'admin-users', 'products', 'orders', 'messages', 'inventory', 'slabs', 'analytics', 'settings'],
        features: ['full_access']
      }
    };

    // Apply role-based navigation visibility
    function applyRoleBasedNav(role) {
      const permissions = ROLE_PERMISSIONS[role] || ROLE_PERMISSIONS.customer;
      const allowedNavItems = permissions.nav;

      // Get all nav items
      const navItems = document.querySelectorAll('.nav-item[data-page]');

      navItems.forEach(item => {
        const page = item.dataset.page;
        if (allowedNavItems.includes(page)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });

      // Show/hide nav sections based on role
      const adminNavEl = document.getElementById('admin-nav');
      const vendorNavEl = document.getElementById('vendor-nav');

      // Admin section - visible to contractors and admins
      if (adminNavEl) {
        const showAdminNav = ['contractor', 'admin'].includes(role);
        adminNavEl.style.display = showAdminNav ? 'block' : 'none';

        // Update section title based on role
        const adminTitle = adminNavEl.querySelector('.nav-section-title');
        if (adminTitle) {
          adminTitle.textContent = role === 'admin' ? 'Admin' : 'Business';
        }
      }

      // Vendor/Store section
      if (vendorNavEl) {
        const showVendorNav = ['contractor', 'vendor', 'admin'].includes(role);
        vendorNavEl.style.display = showVendorNav ? 'block' : 'none';
      }

      // Add role indicator to body for CSS targeting
      document.body.dataset.userRole = role;

      console.log('Applied role-based nav for:', role);
    }

    // Check if user has permission for a feature
    function hasPermission(feature) {
      const permissions = ROLE_PERMISSIONS[userRole] || ROLE_PERMISSIONS.customer;
      return permissions.features.includes('full_access') || permissions.features.includes(feature);
    }

    // Switch role (for demo/testing)
    function switchRole(newRole) {
      if (!ROLE_PERMISSIONS[newRole]) return;

      userRole = newRole;
      applyRoleBasedNav(newRole);

      // Update role display
      const roleEl = document.getElementById('user-role');
      const roleLabels = { homeowner: 'Homeowner', customer: 'Customer', contractor: 'Contractor', vendor: 'Vendor', pro: 'Pro', fabricator: 'Fabricator', admin: 'Admin' };
      if (roleEl) roleEl.textContent = roleLabels[newRole] || 'Customer';

      // Show notification
      showToast(`Switched to ${roleLabels[newRole]} view`);

      // Refresh dashboard to show role-specific content
      if (document.getElementById('page-dashboard').classList.contains('active')) {
        loadDashboardStats();
      }
    }

    // Show role switcher for admins or demo mode
    function enableRoleSwitcher() {
      const switcher = document.getElementById('role-switcher');
      const select = document.getElementById('role-select');
      if (switcher && select) {
        switcher.style.display = 'block';
        select.value = userRole;
      }
    }

    let allLeads = [];
    let currentFilter = 'all';
    let selectedLead = null;

    let allCustomers = [];
    let selectedCustomer = null;
    let customerFilter = 'all';
    let currentCustomerTab = 'jobs';

    // Global estimates state
    let allEstimates = [];
    let selectedEstimate = null;
    let currentEstimateFilter = 'all';

    // ============================================
    // UNIFIED WORKFLOW STATE
    // Centralized state management for lead  customer  estimate  invoice  job flow
    // ============================================
    const workflowState = {
      currentLead: null,
      currentCustomer: null,
      currentEstimate: null,
      currentInvoice: null,
      currentJob: null,
      reset() {
        this.currentLead = null;
        this.currentCustomer = null;
        this.currentEstimate = null;
        this.currentInvoice = null;
        this.currentJob = null;
      }
    };

    // Modal-specific state for estimate creation
    let estimateModalState = {
      customerId: null,
      leadId: null,
      editingEstimateId: null
    };

    // ============================================
    // UNIVERSAL CONTEXT MENU SYSTEM
    // Right-click menus for jobs, invoices, customers, estimates, leads
    // ============================================
    const ContextMenu = {
      menu: null,
      overlay: null,
      currentItem: null,
      currentType: null,

      init() {
        // Create menu container
        this.menu = document.createElement('div');
        this.menu.className = 'context-menu';
        this.menu.id = 'universal-context-menu';
        document.body.appendChild(this.menu);

        // Create overlay for closing
        this.overlay = document.createElement('div');
        this.overlay.className = 'context-menu-overlay';
        this.overlay.style.display = 'none';
        this.overlay.addEventListener('click', () => this.hide());
        this.overlay.addEventListener('contextmenu', (e) => { e.preventDefault(); this.hide(); });
        document.body.appendChild(this.overlay);

        // Global right-click listener
        document.addEventListener('contextmenu', (e) => this.handleContextMenu(e));

        // Close on scroll or escape
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.hide(); });
        document.addEventListener('scroll', () => this.hide(), true);
      },

      handleContextMenu(e) {
        const target = e.target.closest('[data-context-menu]');
        if (!target) return;

        e.preventDefault();

        const menuType = target.dataset.contextMenu;
        const itemId = target.dataset.itemId;
        const itemData = target.dataset.itemData ? JSON.parse(target.dataset.itemData) : {};

        this.show(e.clientX, e.clientY, menuType, itemId, itemData, target);
      },

      show(x, y, type, itemId, itemData, targetElement) {
        this.currentType = type;
        this.currentItem = { id: itemId, ...itemData };

        // Clear previous highlight
        document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));

        // Highlight current row
        if (targetElement) {
          targetElement.classList.add('context-active');
        }

        // Build menu content
        const menuContent = this.buildMenu(type, itemData);
        this.menu.innerHTML = menuContent;

        // Show overlay and menu
        this.overlay.style.display = 'block';
        this.menu.classList.add('visible');

        // Position menu
        this.position(x, y);

        // Attach click handlers
        this.attachHandlers();
      },

      hide() {
        this.menu.classList.remove('visible');
        this.overlay.style.display = 'none';
        document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));
        this.currentItem = null;
        this.currentType = null;
      },

      position(x, y) {
        const menuRect = this.menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        let posX = x;
        let posY = y;
        let originClass = '';

        // Adjust for right edge
        if (x + menuRect.width > viewportWidth - 10) {
          posX = x - menuRect.width;
          originClass = 'origin-right';
        }

        // Adjust for bottom edge
        if (y + menuRect.height > viewportHeight - 10) {
          posY = y - menuRect.height;
          originClass = originClass ? 'origin-bottom-right' : 'origin-bottom';
        }

        this.menu.style.left = Math.max(10, posX) + 'px';
        this.menu.style.top = Math.max(10, posY) + 'px';
        this.menu.className = 'context-menu visible ' + originClass;
      },

      buildMenu(type, itemData) {
        const menus = {
          job: this.buildJobMenu(itemData),
          invoice: this.buildInvoiceMenu(itemData),
          customer: this.buildCustomerMenu(itemData),
          estimate: this.buildEstimateMenu(itemData),
          lead: this.buildLeadMenu(itemData)
        };
        return menus[type] || '';
      },

      buildJobMenu(data) {
        const statusOptions = [
          { value: 'new', label: 'New' },
          { value: 'reviewing', label: 'Reviewing' },
          { value: 'material_ordered', label: 'Material Ordered' },
          { value: 'material_received', label: 'Material Received' },
          { value: 'scheduled', label: 'Scheduled' },
          { value: 'measured', label: 'Measured' },
          { value: 'in_production', label: 'In Production' },
          { value: 'ready', label: 'Ready' },
          { value: 'installing', label: 'Installing' },
          { value: 'completed', label: 'Completed' },
          { value: 'on_hold', label: 'On Hold' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">Job</div>
            <div class="subtitle">${data.job_number || 'Job'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Details
          </button>
          <button class="context-menu-item has-submenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <span class="status-dot ${s.value}"></span>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="schedule">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Schedule Job
          </button>
          <button class="context-menu-item" data-action="assign">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Assign Contractor
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item warning" data-action="archive">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
            Archive Job
          </button>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Job
          </button>
        `;
      },

      buildInvoiceMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Invoice</div>
            <div class="subtitle">${data.invoice_number || 'Invoice'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Invoice
          </button>
          <button class="context-menu-item" data-action="open-stripe">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            Open in Stripe
          </button>
          <button class="context-menu-item" data-action="download-pdf">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Download PDF
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="send-reminder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Reminder
          </button>
          <button class="context-menu-item" data-action="copy-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            Copy Payment Link
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="void">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
            Void Invoice
          </button>
        `;
      },

      buildCustomerMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Customer</div>
            <div class="subtitle">${data.name || 'Customer'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            View Profile
          </button>
          <button class="context-menu-item primary" data-action="create-estimate">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Create Estimate
          </button>
          <button class="context-menu-item" data-action="create-invoice">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Create Invoice
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="email">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Email
          </button>
          <button class="context-menu-item" data-action="call">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            Call Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Customer
          </button>
        `;
      },

      buildEstimateMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Estimate</div>
            <div class="subtitle">${data.estimate_number || 'Estimate'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Estimate
          </button>
          <button class="context-menu-item" data-action="edit">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            Edit Estimate
          </button>
          <button class="context-menu-item primary" data-action="convert-invoice">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Convert to Invoice
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="duplicate">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            Duplicate
          </button>
          <button class="context-menu-item" data-action="send">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send to Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Estimate
          </button>
        `;
      },

      buildLeadMenu(data) {
        const statusOptions = [
          { value: 'new', label: 'New' },
          { value: 'contacted', label: 'Contacted' },
          { value: 'qualified', label: 'Qualified' },
          { value: 'quoted', label: 'Quoted' },
          { value: 'won', label: 'Won' },
          { value: 'lost', label: 'Lost' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">Lead</div>
            <div class="subtitle">${data.name || 'Lead'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            View Lead
          </button>
          <button class="context-menu-item primary" data-action="create-estimate">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Create Estimate
          </button>
          <button class="context-menu-item has-submenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <span class="status-dot ${s.value}"></span>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item success" data-action="convert-customer">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            Convert to Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Lead
          </button>
        `;
      },

      attachHandlers() {
        this.menu.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            const status = btn.dataset.status;
            this.handleAction(action, status);
          });
        });
      },

      handleAction(action, status) {
        const item = this.currentItem;
        const type = this.currentType;

        this.hide();

        // Route to appropriate handler based on type and action
        switch (type) {
          case 'job':
            this.handleJobAction(action, item, status);
            break;
          case 'invoice':
            this.handleInvoiceAction(action, item);
            break;
          case 'customer':
            this.handleCustomerAction(action, item);
            break;
          case 'estimate':
            this.handleEstimateAction(action, item);
            break;
          case 'lead':
            this.handleLeadAction(action, item, status);
            break;
        }
      },

      async handleJobAction(action, item, status) {
        switch (action) {
          case 'view':
            openJobDetail(item.id);
            break;
          case 'status':
            await updateJobStatusById(item.id, status);
            break;
          case 'schedule':
            // TODO: Open schedule modal
            showToast('Schedule feature coming soon', 'info');
            break;
          case 'assign':
            // TODO: Open assign modal
            showToast('Assign feature coming soon', 'info');
            break;
          case 'archive':
            await archiveJob(item.id);
            break;
          case 'delete':
            await deleteJob(item.id);
            break;
        }
      },

      async handleInvoiceAction(action, item) {
        switch (action) {
          case 'view':
            if (item.hosted_invoice_url) {
              window.open(item.hosted_invoice_url, '_blank');
            }
            break;
          case 'open-stripe':
            if (item.hosted_invoice_url) {
              window.open(item.hosted_invoice_url, '_blank');
            }
            break;
          case 'download-pdf':
            if (item.pdf_url) {
              window.open(item.pdf_url, '_blank');
            }
            break;
          case 'send-reminder':
            await sendInvoiceReminder(item.id);
            break;
          case 'copy-link':
            if (item.hosted_invoice_url) {
              await navigator.clipboard.writeText(item.hosted_invoice_url);
              showToast('Payment link copied!', 'success');
            }
            break;
          case 'void':
            await voidInvoice(item.id);
            break;
        }
      },

      handleCustomerAction(action, item) {
        switch (action) {
          case 'view':
            selectCustomer(item.id);
            break;
          case 'create-estimate':
            startEstimateFromCustomer(item.id);
            break;
          case 'create-invoice':
            // TODO: Create invoice for customer
            showToast('Invoice creation coming soon', 'info');
            break;
          case 'email':
            if (item.email) {
              window.location.href = `mailto:${item.email}`;
            }
            break;
          case 'call':
            if (item.phone) {
              window.location.href = `tel:${item.phone}`;
            }
            break;
          case 'delete':
            deleteCustomer(item.id);
            break;
        }
      },

      handleEstimateAction(action, item) {
        switch (action) {
          case 'view':
            viewEstimate(item.id);
            break;
          case 'edit':
            editEstimate(item.id);
            break;
          case 'convert-invoice':
            convertEstimateToInvoice(item.id);
            break;
          case 'duplicate':
            // TODO: Duplicate estimate
            showToast('Duplicate feature coming soon', 'info');
            break;
          case 'send':
            sendEstimateEmail(item.id);
            break;
          case 'delete':
            deleteEstimate(item.id);
            break;
        }
      },

      async handleLeadAction(action, item, status) {
        switch (action) {
          case 'view':
            viewLead(item.id);
            break;
          case 'create-estimate':
            startEstimateFromLead(item.id);
            break;
          case 'status':
            await updateLeadStatus(item.id, status);
            break;
          case 'convert-customer':
            await convertLeadToCustomer(item.id);
            break;
          case 'delete':
            await deleteLead(item.id);
            break;
        }
      }
    };

    // Initialize context menu on page load
    document.addEventListener('DOMContentLoaded', () => {
      ContextMenu.init();
    });

    // ============================================
    // HELPER FUNCTIONS FOR UNIFIED FLOW
    // ============================================

    // Fetch customer from database (not just cached array)
    async function getCustomer(customerId) {
      if (!customerId) return null;

      // Try cache first
      let customer = allCustomers?.find(c => c.id === customerId);
      if (customer) return customer;

      // Fetch from database
      try {
        const { data, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('id', customerId)
          .single();

        if (!error && data) {
          // Add to cache
          if (!allCustomers) allCustomers = [];
          allCustomers.push(data);
          return data;
        }
      } catch (e) {
        console.error('Error fetching customer:', e);
      }
      return null;
    }

    // Find or create customer from lead data
    async function findOrCreateCustomerFromLead(lead) {
      if (!lead) {
        console.error('[findOrCreateCustomerFromLead] No lead provided');
        return null;
      }

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        console.error('[findOrCreateCustomerFromLead] No user logged in');
        return null;
      }

      console.log('[findOrCreateCustomerFromLead] Processing lead:', lead.id, lead.email);

      // Check if customer already exists with this email
      if (lead.email) {
        const { data: existing, error: findError } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .eq('email', lead.email)
          .maybeSingle();

        if (findError) {
          console.error('[findOrCreateCustomerFromLead] Error finding customer:', findError);
        }

        if (existing) {
          console.log('[findOrCreateCustomerFromLead] Found existing customer:', existing.id);
          // Update lead with customer_id reference
          const { error: updateError } = await supabaseClient.from('leads').update({ customer_id: existing.id }).eq('id', lead.id);
          if (updateError) console.error('[findOrCreateCustomerFromLead] Error updating lead:', updateError);
          return existing;
        }
      }

      // Parse name
      const nameParts = (lead.full_name || '').trim().split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      // Parse address
      let address = '', city = '', state = 'AZ', zip = '';
      if (lead.service_address) {
        // service_address could be string or object
        if (typeof lead.service_address === 'string') {
          address = lead.service_address;
        } else if (typeof lead.service_address === 'object') {
          address = lead.service_address.street || lead.service_address.address || '';
          city = lead.service_address.city || '';
          state = lead.service_address.state || 'AZ';
          zip = lead.service_address.zip || lead.service_address.zip_code || '';
        }
      } else if (lead.billing_address) {
        // billing_address could be string or object
        if (typeof lead.billing_address === 'string') {
          const parts = lead.billing_address.split(',').map(s => s.trim());
          address = parts[0] || '';
          city = parts[1] || '';
          const stateZip = (parts[2] || '').split(' ');
          state = stateZip[0] || 'AZ';
          zip = stateZip[1] || '';
        } else if (typeof lead.billing_address === 'object') {
          address = lead.billing_address.street || lead.billing_address.address || '';
          city = lead.billing_address.city || '';
          state = lead.billing_address.state || 'AZ';
          zip = lead.billing_address.zip || lead.billing_address.zip_code || '';
        }
      } else if (lead.project_address) {
        address = lead.project_address;
      }

      // Create new customer (with bidirectional lead_id reference)
      console.log('[findOrCreateCustomerFromLead] Creating new customer for:', lead.full_name, lead.email);
      const { data: newCustomer, error } = await supabaseClient
        .from('customers')
        .insert({
          user_id: user.id,
          name: lead.full_name || 'Customer',
          email: lead.email || null,
          phone: lead.phone || null,
          address: address || null,
          city: city || null,
          state: state || 'AZ',
          zip: zip || null,
          lead_id: lead.id, // Bidirectional reference back to lead
          source: 'lead_conversion',
          notes: `Converted from lead. Project: ${lead.project_type || 'N/A'}`
        })
        .select()
        .single();

      if (error) {
        console.error('[findOrCreateCustomerFromLead] Error creating customer:', error);
        showToast('Error creating customer: ' + (error.message || 'Unknown error'), 'error');
        return null;
      }

      if (newCustomer) {
        console.log('[findOrCreateCustomerFromLead] Created customer:', newCustomer.id);
        // Update lead with customer reference
        const { error: updateError } = await supabaseClient.from('leads').update({
          customer_id: newCustomer.id,
          status: 'qualified'
        }).eq('id', lead.id);

        if (updateError) {
          console.error('[findOrCreateCustomerFromLead] Error updating lead:', updateError);
        } else {
          console.log('[findOrCreateCustomerFromLead] Updated lead with customer_id');
        }

        // Add to cache
        if (!allCustomers) allCustomers = [];
        allCustomers.push(newCustomer);

        // Refresh leads list
        loadLeads();

        return newCustomer;
      }

      return null;
    }

    // Create customer from estimate form data
    async function createCustomerFromEstimateForm(formData) {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return null;

      // Check if customer exists with this email
      if (formData.customerEmail) {
        const { data: existing } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .eq('email', formData.customerEmail)
          .single();

        if (existing) return existing;
      }

      // Create new customer
      const { data: newCustomer, error } = await supabaseClient
        .from('customers')
        .insert({
          user_id: user.id,
          name: formData.customerName || 'Customer',
          email: formData.customerEmail,
          phone: formData.customerPhone,
          address: formData.customerAddress,
          city: formData.customerCity,
          state: formData.customerState || 'AZ',
          source: 'estimate_creation'
        })
        .select()
        .single();

      if (!error && newCustomer) {
        if (!allCustomers) allCustomers = [];
        allCustomers.push(newCustomer);
        return newCustomer;
      }

      return null;
    }

    // Pre-fill estimate form with customer data
    function fillEstimateCustomerFields(customer) {
      if (!customer) return;

      const fields = {
        'estimate-customer-name': customer.name,
        'estimate-customer-email': customer.email,
        'estimate-customer-phone': customer.phone,
        'estimate-customer-address': customer.address,
        'estimate-customer-city': customer.city,
        'estimate-customer-state': customer.state || 'AZ'
      };

      Object.entries(fields).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el && value) el.value = value;
      });
    }

    // Initialize with timeout fallback
    document.addEventListener('DOMContentLoaded', async () => {
      // Fallback timer - show dashboard/auth if things take too long
      const fallbackTimer = setTimeout(() => {
        console.warn('Init timeout - forcing display');
        // Check if we have a cached session indicator
        const hasSession = localStorage.getItem('sb-ypeypgwsycxcagncgdur-auth-token');
        if (hasSession) {
          showDashboard();
        } else {
          showAuth();
        }
      }, 5000);

      try {
        // Wait for Supabase to be available (max 3 seconds)
        let attempts = 0;
        while (!window.supabase && attempts < 30) {
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }

        if (!window.supabase) {
          console.error('Supabase library failed to load after', attempts * 100, 'ms');
          clearTimeout(fallbackTimer);
          showAuth();
          return;
        }

        const { createClient } = window.supabase;

        // Check localStorage availability (mobile Safari ITP workaround)
        let storageAvailable = true;
        try {
          localStorage.setItem('__storage_test__', '1');
          localStorage.removeItem('__storage_test__');
        } catch (e) {
          storageAvailable = false;
          console.warn('localStorage unavailable, using memory storage');
        }

        // Create custom storage that falls back gracefully
        const customStorage = storageAvailable ? window.localStorage : {
          _data: {},
          getItem(key) { return this._data[key] || null; },
          setItem(key, value) { this._data[key] = value; },
          removeItem(key) { delete this._data[key]; }
        };

        // Use global client or create our own
        supabaseClient = window._sgSupabaseClient;
        if (!supabaseClient) {
          console.log('Creating local Supabase client');
          const { createClient } = window.supabase;
          supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
              storage: customStorage,
              autoRefreshToken: true,
              persistSession: true
            }
          });
          window._sgSupabaseClient = supabaseClient;
        }

        // Listen for auth state changes (handles token refresh on mobile)
        let authChangeHandled = false;
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          console.log('Account Auth State:', event);

          // Prevent double-handling
          if (authChangeHandled && event === 'INITIAL_SESSION') return;

          if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
            currentUser = null;
            showAuth();
          } else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'INITIAL_SESSION') {
            if (session) {
              authChangeHandled = true;
              currentUser = session.user;
              // Refresh profile on token refresh
              loadUserProfile().catch(err => console.warn('Profile refresh failed:', err));
            }
          }
        });

        // Try to get session with retry for mobile
        let session = null;
        let sessionError = null;

        for (let retry = 0; retry < 2; retry++) {
          const result = await supabaseClient.auth.getSession();
          session = result.data?.session;
          sessionError = result.error;

          if (session || !sessionError) break;

          // Wait before retry
          await new Promise(r => setTimeout(r, 500));
        }

        clearTimeout(fallbackTimer);

        if (sessionError) {
          console.error('Session error:', sessionError);
          // Only redirect if this is a real error, not just missing session
          if (sessionError.message?.includes('refresh_token')) {
            showAuth();
            return;
          }
        }

        if (session) {
          currentUser = session.user;
          // Load profile BEFORE showing dashboard so isAdmin is set correctly
          try {
            await loadUserProfile();
          } catch (err) {
            console.warn('Profile load failed:', err);
          }
          showDashboard();
        } else {
          showAuth();
        }
      } catch (err) {
        clearTimeout(fallbackTimer);
        console.error('Init error:', err);
        showAuth();
      }
    });

    function showAuth() {
      // Check for incoming redirect parameter (e.g., from tools page auth check)
      const params = new URLSearchParams(window.location.search);
      const incomingRedirect = params.get('redirect');
      if (incomingRedirect) {
        // Store the original redirect destination for after login
        sessionStorage.setItem('auth_redirect', incomingRedirect);
      }
      // Redirect to unified login page instead of showing embedded auth
      window.location.href = '/log-in/?redirect=' + encodeURIComponent(window.location.pathname + window.location.hash);
    }

    function showDashboard() {
      // Check for stored redirect URL (e.g., from Room Designer auth flow)
      const authRedirect = sessionStorage.getItem('auth_redirect');
      if (authRedirect) {
        sessionStorage.removeItem('auth_redirect');
        window.location.href = authRedirect;
        return;
      }

      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-app').style.display = 'block';
      setupDashboard();

      // Initialize sidebar collapsed state from localStorage
      initSidebarState();

      // Update badge visibility (hide zeros)
      updateBadgeVisibility();

      // Handle hash navigation (e.g., /account/#favorites)
      handleHashNavigation();

      // Listen for hash changes
      window.addEventListener('hashchange', handleHashNavigation);
    }

    function handleHashNavigation() {
      const hash = window.location.hash.replace('#', '');
      const validPages = ['favorites', 'profile', 'leads', 'customers', 'estimates', 'invoices', 'jobs', 'contractors', 'products', 'dashboard', 'wallet', 'orders', 'messages', 'listings', 'admin-users', 'calendar', 'my-designs', 'tools'];
      if (hash && validPages.includes(hash)) {
        showPage(hash);
      }
    }

    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

      document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tab}-form`).classList.add('active');

      document.getElementById('auth-title').textContent = tab === 'login' ? 'Welcome Back' : 'Create Account';
      document.getElementById('auth-subtitle').textContent = tab === 'login' ? 'Sign in to access your account' : 'Join us to get started';
      hideAuthMessage();

      // Reset signup to step 1 when switching tabs
      if (tab === 'signup') {
        goToSignupStep(1);
        selectAccountType('homeowner');
      }
    }

    // Signup step functions
    function selectAccountType(type) {
      // Update hidden input
      document.getElementById('signup-account-type').value = type;

      // Update card selection UI
      document.querySelectorAll('.account-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`.account-type-card[data-type="${type}"]`).classList.add('selected');
    }

    function goToSignupStep(step) {
      const step1 = document.getElementById('signup-step-1');
      const step2 = document.getElementById('signup-step-2');
      const accountType = document.getElementById('signup-account-type').value;

      if (step === 1) {
        step1.style.display = 'block';
        step2.style.display = 'none';
        document.getElementById('auth-title').textContent = 'Create Account';
        document.getElementById('auth-subtitle').textContent = 'Join us to get started';
      } else {
        step1.style.display = 'none';
        step2.style.display = 'block';

        // Update labels based on account type
        const typeLabels = {
          'homeowner': 'Homeowner Account',
          'pro_fabricator': 'Pro Fabricator Account',
          'pro_designer': 'Designer / Architect Account'
        };
        document.getElementById('selected-type-label').textContent = typeLabels[accountType] || 'Your Account';

        // Show/hide pro fields
        const proFields = document.getElementById('pro-fields');
        const proNote = document.getElementById('pro-upgrade-note');
        const isPro = accountType.startsWith('pro_');

        proFields.style.display = isPro ? 'block' : 'none';
        proNote.style.display = isPro ? 'flex' : 'none';

        // Update header for pro accounts
        if (isPro) {
          document.getElementById('auth-title').textContent = 'Pro Account Setup';
          document.getElementById('auth-subtitle').textContent = 'Unlock unlimited features';
        } else {
          document.getElementById('auth-title').textContent = 'Create Account';
          document.getElementById('auth-subtitle').textContent = 'Almost there!';
        }
      }
    }

    // Initialize account type selection on page load
    document.addEventListener('DOMContentLoaded', function() {
      const homeownerCard = document.querySelector('.account-type-card[data-type="homeowner"]');
      if (homeownerCard) {
        homeownerCard.classList.add('selected');
      }
    });

    function showAuthMessage(msg, type) {
      const el = document.getElementById('auth-message');
      el.textContent = msg;
      el.className = `auth-message visible ${type}`;
    }

    function hideAuthMessage() {
      document.getElementById('auth-message').classList.remove('visible');
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();
        showDashboard();
      } catch (err) {
        showAuthMessage(err.message || 'Failed to sign in', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleGoogleLogin() {
      hideAuthMessage();

      const btn = document.querySelector('.btn-google');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="20"/></svg> Connecting...';
      }

      try {
        // Use SgAuth if available, otherwise use direct Supabase client
        if (window.SgAuth && window.SgAuth.signInWithGoogle) {
          await window.SgAuth.signInWithGoogle(window.location.origin + '/account/');
        } else {
          const { data, error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.origin + '/account/'
            }
          });
          if (error) throw error;
        }
        // OAuth redirects to Google, so we won't reach here unless there's an error
      } catch (err) {
        showAuthMessage(err.message || 'Failed to connect with Google', 'error');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google';
        }
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      try {
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const phone = document.getElementById('signup-phone').value;
        const accountType = document.getElementById('signup-account-type').value;
        const businessName = document.getElementById('signup-business-name')?.value || null;
        const businessLocation = document.getElementById('signup-business-location')?.value || null;

        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: name,
              phone,
              account_type: accountType,
              business_name: businessName,
              business_location: businessLocation
            }
          }
        });

        if (error) throw error;

        // Store in sg_users
        await supabaseClient.from('sg_users').insert([{
          id: data.user.id,
          email,
          full_name: name,
          phone: phone || null,
          account_type: accountType,
          business_name: businessName,
          business_location: businessLocation,
          verified: accountType === 'homeowner' // Homeowners auto-verified, pros need verification
        }]);

        // Show success message based on account type
        const isPro = accountType.startsWith('pro_');
        const successMsg = isPro
          ? 'Pro account created! Check your email to verify. Our team will review your business details.'
          : 'Account created! Check your email to verify, then sign in.';

        showAuthMessage(successMsg, 'success');
        showAuthTab('login');
      } catch (err) {
        showAuthMessage(err.message || 'Failed to create account', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return;

      try {
        // Use maybeSingle() to handle missing profiles gracefully
        const { data: profile, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (error) {
          console.warn('Profile query error:', error);
        }

        userProfile = profile;

        const meta = currentUser.user_metadata || {};
        const name = profile?.full_name || meta.full_name || currentUser.email?.split('@')[0] || 'User';
        const accountType = profile?.account_type || 'homeowner';

        // Check admin status
        isSuperAdmin = SUPER_ADMIN_EMAILS.includes((currentUser.email || '').toLowerCase());
        isAdmin = isSuperAdmin || ['admin', 'super_admin'].includes(accountType);

        // Determine user role (from profile or derived from account type)
        if (isAdmin) {
          userRole = 'admin';
        } else if (profile?.user_role) {
          userRole = profile.user_role;
        } else if (accountType.startsWith('pro_')) {
          userRole = 'contractor';
        } else {
          userRole = 'customer';
        }

        // Safely update sidebar user info
        const avatarEl = document.getElementById('user-avatar');
        const nameEl = document.getElementById('user-name');
        const roleEl = document.getElementById('user-role');

        const roleLabels = {
          homeowner: 'Homeowner',
          customer: 'Customer',
          contractor: 'Contractor',
          vendor: 'Vendor',
          pro: 'Pro',
          fabricator: 'Fabricator',
          admin: 'Admin'
        };

        if (avatarEl) avatarEl.textContent = name.charAt(0).toUpperCase();
        if (nameEl) nameEl.textContent = name;
        if (roleEl) roleEl.textContent = isSuperAdmin ? 'Super Admin' : roleLabels[userRole] || roleLabels[accountType] || 'Customer';

        // Update account type label in sidebar header
        const accountTypeLabel = document.getElementById('account-type-label');
        if (accountTypeLabel) {
          const typeLabels = {
            'customer': 'Customer Account',
            'contractor': 'Contractor Account',
            'vendor': 'Vendor Account',
            'admin': 'Admin Account',
            'homeowner': 'Customer Account',
            'pro_contractor': 'Contractor Account',
            'pro_fabricator': 'Fabricator Account',
            'pro_designer': 'Designer Account',
            'pro_builder': 'Builder Account',
            'super_admin': 'Admin Account'
          };
          accountTypeLabel.textContent = isSuperAdmin ? ' GOD MODE' : (typeLabels[userRole] || typeLabels[accountType] || 'Account');
        }

        // Safely update profile form
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const profilePhoneEl = document.getElementById('profile-phone');
        const profileCompanyEl = document.getElementById('profile-company');

        if (profileNameEl) profileNameEl.value = name;
        if (profileEmailEl) profileEmailEl.value = currentUser.email || '';
        if (profilePhoneEl) profilePhoneEl.value = profile?.phone || meta.phone || '';
        if (profileCompanyEl) profileCompanyEl.value = profile?.company_name || '';

        // Apply role-based navigation
        applyRoleBasedNav(userRole);

        // Enable role switcher for admins (for testing different views)
        if (isAdmin) {
          enableRoleSwitcher();
        }

      } catch (err) {
        console.warn('Profile load error:', err);
      }

      // Load favorites count (non-blocking)
      loadFavoritesCount().catch(err => console.warn('Favorites count error:', err));
    }

    // ============ FAVORITES FUNCTIONS ============

    let allFavorites = [];
    let flooringFavorites = [];
    let countertopFavorites = [];

    async function loadFavoritesCount() {
      if (!currentUser) return;

      try {
        const { count } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = count || 0;
          countEl.style.display = count > 0 ? 'inline' : 'none';
        }
      } catch (err) {
        console.warn('Error loading favorites count:', err);
      }
    }

    async function loadFavorites() {
      if (!currentUser) return;

      const loadingEl = document.getElementById('favorites-loading');
      const emptyEl = document.getElementById('favorites-empty');
      const flooringSection = document.getElementById('favorites-flooring');
      const countertopsSection = document.getElementById('favorites-countertops');
      const tileSection = document.getElementById('favorites-tile');
      const shopSection = document.getElementById('favorites-shop');
      const quoteBtn = document.getElementById('request-quote-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');

      try {
        const { data, error } = await supabaseClient
          .from('user_favorites')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allFavorites = data || [];
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');
        const tileFavorites = allFavorites.filter(f => f.product_type === 'tile');
        const shopFavorites = allFavorites.filter(f => f.product_type === 'shop');

        loadingEl.style.display = 'none';

        if (allFavorites.length === 0) {
          emptyEl.style.display = 'block';
          flooringSection.style.display = 'none';
          countertopsSection.style.display = 'none';
          if (tileSection) tileSection.style.display = 'none';
          if (shopSection) shopSection.style.display = 'none';
          quoteBtn.style.display = 'none';
          if (clearAllBtn) clearAllBtn.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          quoteBtn.style.display = 'inline-flex';
          if (clearAllBtn) clearAllBtn.style.display = 'inline-flex';

          // Show/render countertops section
          if (countertopFavorites.length > 0) {
            countertopsSection.style.display = 'block';
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            countertopsSection.style.display = 'none';
          }

          // Show/render flooring section
          if (flooringFavorites.length > 0) {
            flooringSection.style.display = 'block';
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            flooringSection.style.display = 'none';
          }

          // Show/render tile section
          if (tileFavorites.length > 0 && tileSection) {
            tileSection.style.display = 'block';
            document.getElementById('tile-section-count').textContent = tileFavorites.length;
            renderFavoritesGrid('favorites-tile-grid', tileFavorites);
          } else if (tileSection) {
            tileSection.style.display = 'none';
          }

          // Show/render shop section
          if (shopFavorites.length > 0 && shopSection) {
            shopSection.style.display = 'block';
            document.getElementById('shop-section-count').textContent = shopFavorites.length;
            renderFavoritesGrid('favorites-shop-grid', shopFavorites);
          } else if (shopSection) {
            shopSection.style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

      } catch (err) {
        console.error('Error loading favorites:', err);
        loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading favorites. Please try again.</p>';
      }
    }

    function renderFavoritesGrid(gridId, items) {
      const gridEl = document.getElementById(gridId);
      if (!gridEl) return;

      gridEl.innerHTML = items.map(item => `
        <div class="saved-floor-item" data-id="${item.id}">
          <img class="saved-floor-image" src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}" loading="lazy">
          <div class="saved-floor-content">
            <div class="saved-floor-title">${item.product_title}</div>
            ${item.product_material ? `<div class="saved-floor-material">${item.product_material}</div>` : ''}
            <div class="saved-floor-specs">
              ${item.product_color ? `<span class="saved-floor-spec">${item.product_color}</span>` : ''}
              ${item.product_thickness ? `<span class="saved-floor-spec">${item.product_thickness}</span>` : ''}
              ${item.product_wear_layer ? `<span class="saved-floor-spec">${item.product_wear_layer}</span>` : ''}
            </div>
            <div class="saved-floor-actions">
              <a href="${item.product_url}" class="saved-floor-view" target="_blank">View</a>
              <button class="saved-floor-remove" onclick="removeFavorite('${item.id}', '${item.product_type}')">Remove</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function removeFavorite(id, productType) {
      if (!confirm('Remove this from your favorites?')) return;

      try {
        const { error } = await supabaseClient
          .from('user_favorites')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);

        if (error) throw error;

        // Remove from local arrays
        allFavorites = allFavorites.filter(f => f.id !== id);
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');

        // Re-render the appropriate grid
        if (productType === 'countertop') {
          if (countertopFavorites.length > 0) {
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            document.getElementById('favorites-countertops').style.display = 'none';
          }
        } else {
          if (flooringFavorites.length > 0) {
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            document.getElementById('favorites-flooring').style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

        // Show empty state if no more favorites
        if (allFavorites.length === 0) {
          document.getElementById('favorites-empty').style.display = 'block';
          document.getElementById('request-quote-btn').style.display = 'none';
        }

        showToast('Removed from favorites', 'success');

      } catch (err) {
        console.error('Error removing favorite:', err);
        showToast('Error removing item', 'error');
      }
    }

    // Clear ALL favorites - permanent action
    async function clearAllFavoritesConfirm() {
      // Show confirmation modal
      const confirmModal = document.createElement('div');
      confirmModal.className = 'quote-modal';
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      confirmModal.innerHTML = `
        <div style="background: linear-gradient(180deg, #1a1a2e 0%, #0d0d15 100%); border-radius: 20px; padding: 32px; max-width: 400px; width: 100%; text-align: center; color: #fff;">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" style="margin-bottom: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <h3 style="margin: 0 0 12px; font-size: 22px;">Clear All Favorites?</h3>
          <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px; line-height: 1.5;">This will permanently delete <strong>${allFavorites.length}</strong> item${allFavorites.length !== 1 ? 's' : ''} from your favorites. This action cannot be undone.</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancel-clear" style="background: rgba(255,255,255,0.1); color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px;">Cancel</button>
            <button id="confirm-clear" style="background: #dc2626; color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px;">Yes, Clear All</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);

      // Handle cancel
      confirmModal.querySelector('#cancel-clear').addEventListener('click', () => {
        confirmModal.remove();
      });

      // Handle confirm
      confirmModal.querySelector('#confirm-clear').addEventListener('click', async () => {
        const confirmBtn = confirmModal.querySelector('#confirm-clear');
        confirmBtn.textContent = 'Clearing...';
        confirmBtn.disabled = true;

        try {
          // Delete from Supabase
          const { error } = await supabaseClient
            .from('user_favorites')
            .delete()
            .eq('user_id', currentUser.id);

          if (error) throw error;

          // Clear ALL localStorage keys related to favorites
          const keysToRemove = [
            'sg_all_favorites',
            'sg_flooring_favorites',
            'sg_countertop_favorites',
            'sg_tile_favorites',
            'sg_cabinet_favorites',
            'sg_sink_favorites',
            'sg_shop_favorites',
            'sg_general_favorites',
            'favorites',
            'userFavorites',
            'sg_favorites'
          ];
          keysToRemove.forEach(key => {
            try { localStorage.removeItem(key); } catch (e) {}
          });

          // Also clear any key containing 'favorite'
          Object.keys(localStorage).forEach(key => {
            if (key.toLowerCase().includes('favorite')) {
              try { localStorage.removeItem(key); } catch (e) {}
            }
          });

          // Clear local arrays
          allFavorites = [];
          flooringFavorites = [];
          countertopFavorites = [];
          tileFavorites = [];
          shopFavorites = [];

          // Hide all sections
          document.getElementById('favorites-countertops').style.display = 'none';
          document.getElementById('favorites-flooring').style.display = 'none';
          document.getElementById('favorites-tile').style.display = 'none';
          document.getElementById('favorites-shop').style.display = 'none';

          // Show empty state
          document.getElementById('favorites-empty').style.display = 'block';

          // Hide buttons
          document.getElementById('request-quote-btn').style.display = 'none';
          document.getElementById('clear-all-btn').style.display = 'none';

          // Update counts
          const countEl = document.getElementById('favorites-count');
          if (countEl) {
            countEl.textContent = '0';
            countEl.style.display = 'none';
          }

          // Update dashboard stat if visible
          const statEl = document.getElementById('stat-favorites');
          if (statEl) statEl.textContent = '0';

          // Update global favorites if available
          if (window.SGFavorites && typeof window.SGFavorites.clearAll === 'function') {
            // Already cleared above, but this ensures in-memory state is synced
          }

          confirmModal.remove();
          showToast('All favorites cleared permanently', 'success');

        } catch (err) {
          console.error('Error clearing favorites:', err);
          confirmBtn.textContent = 'Yes, Clear All';
          confirmBtn.disabled = false;
          showToast('Error clearing favorites. Please try again.', 'error');
        }
      });

      // Close on click outside
      confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
          confirmModal.remove();
        }
      });
    }

    // =============================================
    // MY DESIGNS (ROOM DESIGNER)
    // =============================================

    let allDesigns = [];
    let designsFilter = 'all';

    async function loadMyDesigns() {
      const loadingEl = document.getElementById('designs-loading');
      const emptyEl = document.getElementById('designs-empty');
      const gridEl = document.getElementById('designs-grid');

      if (!loadingEl || !emptyEl || !gridEl) return;

      // Show loading
      loadingEl.style.display = 'flex';
      emptyEl.style.display = 'none';
      gridEl.style.display = 'none';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          loadingEl.style.display = 'none';
          emptyEl.style.display = 'block';
          return;
        }

        // Load designs created by this user
        const { data: designs, error } = await supabaseClient
          .from('room_designs')
          .select('*')
          .eq('created_by', user.id)
          .order('updated_at', { ascending: false });

        if (error) throw error;

        allDesigns = designs || [];

        // Update count badge
        const countEl = document.getElementById('designs-count');
        if (countEl) {
          countEl.textContent = allDesigns.length;
          countEl.style.display = allDesigns.length > 0 ? 'inline-flex' : 'none';
        }

        loadingEl.style.display = 'none';

        if (allDesigns.length === 0) {
          emptyEl.style.display = 'block';
          gridEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          gridEl.style.display = 'grid';
          renderDesigns();
        }

      } catch (err) {
        console.error('Error loading designs:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        gridEl.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading designs. Please try again.</p>';
      }
    }

    function filterDesigns() {
      designsFilter = document.getElementById('designs-filter').value;
      renderDesigns();
    }

    function renderDesigns() {
      const gridEl = document.getElementById('designs-grid');
      if (!gridEl) return;

      let filtered = allDesigns;
      if (designsFilter === 'shared') {
        filtered = allDesigns.filter(d => d.share_token);
      } else if (designsFilter === 'private') {
        filtered = allDesigns.filter(d => !d.share_token);
      }

      if (filtered.length === 0) {
        gridEl.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 40px; grid-column: 1 / -1;">No ${designsFilter === 'all' ? '' : designsFilter + ' '}designs found.</p>`;
        return;
      }

      gridEl.innerHTML = filtered.map(design => {
        const isShared = !!design.share_token;
        const roomType = design.room_type || 'kitchen';
        const updatedDate = new Date(design.updated_at).toLocaleDateString();
        const elementCount = Array.isArray(design.elements) ? design.elements.length : 0;

        return `
          <div class="design-card" data-id="${design.id}">
            <div class="design-preview">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              <span class="design-preview-badge ${isShared ? 'shared' : 'private'}">${isShared ? 'Shared' : 'Private'}</span>
            </div>
            <div class="design-content">
              <div class="design-title">${escapeHtml(design.project_name || 'Untitled Design')}</div>
              <div class="design-meta">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                  ${roomType.charAt(0).toUpperCase() + roomType.slice(1)}
                </span>
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  ${elementCount} items
                </span>
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  ${updatedDate}
                </span>
              </div>
              <div class="design-actions">
                <a href="/tools/room-designer/?p=${design.share_token || design.id}" class="design-btn-open">Open</a>
                <button class="design-btn-share" onclick="copyDesignLink('${design.share_token || design.id}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                </button>
                <button class="design-btn-delete" onclick="deleteDesign('${design.id}', '${escapeHtml(design.project_name || 'Untitled')}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function copyDesignLink(token) {
      const url = `${window.location.origin}/tools/room-designer/?p=${token}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Design link copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    async function deleteDesign(designId, designName) {
      if (!confirm(`Are you sure you want to delete "${designName}"? This cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('room_designs')
          .delete()
          .eq('id', designId);

        if (error) throw error;

        // Remove from local array
        allDesigns = allDesigns.filter(d => d.id !== designId);

        // Update count badge
        const countEl = document.getElementById('designs-count');
        if (countEl) {
          countEl.textContent = allDesigns.length;
          countEl.style.display = allDesigns.length > 0 ? 'inline-flex' : 'none';
        }

        // Re-render or show empty
        if (allDesigns.length === 0) {
          document.getElementById('designs-empty').style.display = 'block';
          document.getElementById('designs-grid').style.display = 'none';
        } else {
          renderDesigns();
        }

        showToast('Design deleted successfully', 'success');

      } catch (err) {
        console.error('Error deleting design:', err);
        showToast('Failed to delete design', 'error');
      }
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function requestQuoteForFavorites() {
      if (allFavorites.length === 0) {
        showToast('No favorites saved yet!', 'error');
        return;
      }

      // Build quote modal
      const modal = document.createElement('div');
      modal.className = 'quote-modal';
      modal.id = 'quote-modal';
      modal.innerHTML = `
        <div class="quote-modal-content">
          <div class="quote-modal-header">
            <h3>Request a Quote</h3>
            <button onclick="closeQuoteModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div class="quote-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">We'll prepare a quote for these ${allFavorites.length} items:</p>

            <div class="quote-items-list">
              ${allFavorites.map(item => `
                <div class="quote-item">
                  <img src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}">
                  <div class="quote-item-info">
                    <div class="quote-item-title">${item.product_title}</div>
                    <div class="quote-item-material">${item.product_type || ''} ${item.product_material ? '- ' + item.product_material : ''} ${item.product_color ? '- ' + item.product_color : ''}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Additional Notes (Optional)</label>
              <textarea id="quote-notes" rows="3" placeholder="Tell us about your project, room size, timeline, etc." style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark); color: var(--text-primary); resize: vertical;"></textarea>
            </div>

            <button class="btn-modern primary" style="width: 100%;" onclick="submitQuoteRequest()">
              Submit Quote Request
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeQuoteModal() {
      const modal = document.getElementById('quote-modal');
      if (modal) modal.remove();
    }

    async function submitQuoteRequest() {
      const notes = document.getElementById('quote-notes')?.value || '';

      // Group favorites by type for the quote
      const groupedFavorites = allFavorites.reduce((acc, f) => {
        const type = f.product_type || 'other';
        if (!acc[type]) acc[type] = [];
        acc[type].push(f);
        return acc;
      }, {});

      // Build formatted list
      const itemsList = Object.entries(groupedFavorites).map(([type, items]) => {
        return `${type.charAt(0).toUpperCase() + type.slice(1)}:\n${items.map(f => `  - ${f.product_title} (${f.product_material || 'N/A'})`).join('\n')}`;
      }).join('\n\n');

      try {
        // Create lead/quote request in Supabase
        const quoteData = {
          user_id: currentUser.id,
          email: currentUser.email,
          full_name: userProfile?.full_name || currentUser.email.split('@')[0],
          phone: userProfile?.phone || '',
          status: 'new',
          source: 'favorites_quote',
          notes: `Quote Request from Favorites:\n\n${itemsList}\n\nAdditional Notes: ${notes || 'None'}`,
          created_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
          .from('leads')
          .insert(quoteData);

        if (error) {
          console.warn('Lead insert error (table may not exist):', error);
        }

        // Send email notification via API
        try {
          await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'info@surprisegranite.com',
              counterSqft: 'Quote Request from Favorites',
              splashSqft: '',
              totalSqft: `${allFavorites.length} items selected`,
              edgeProfile: `Customer: ${userProfile?.full_name || currentUser.email}`,
              edgeLF: `Phone: ${userProfile?.phone || 'N/A'}`,
              priceBudget: allFavorites.map(f => f.product_title).join(', '),
              pricePopular: notes || 'No additional notes',
              pricePremium: `Email: ${currentUser.email}`
            })
          });
        } catch (emailErr) {
          console.warn('Email notification error:', emailErr);
        }

        closeQuoteModal();
        showToast('Quote request submitted! We\'ll contact you soon.', 'success');

      } catch (err) {
        console.error('Quote submit error:', err);
        showToast('Error submitting quote. Please try again.', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#333'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ============ NOTIFICATION HELPER ============
    // Send email + SMS notifications via API
    async function sendNotification(type, action, entity, recipient, newStatus = null) {
      // Only send if we have recipient info
      if (!recipient?.email && !recipient?.phone) {
        console.log('[Notify] No recipient info, skipping notification');
        return { email: { sent: false }, sms: { sent: false } };
      }

      try {
        const response = await fetch('/api/workflow/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type,          // 'estimate', 'invoice', 'job', 'appointment'
            action,        // 'sent', 'approved', 'status_change', 'reminder', 'paid'
            entity,        // The data object
            recipient,     // { email, phone, name }
            new_status: newStatus
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('[Notify] Sent:', { type, action, result: result.notifications });
          return result.notifications;
        } else {
          console.log('[Notify] API error:', response.status);
          return { email: { sent: false }, sms: { sent: false } };
        }
      } catch (err) {
        console.log('[Notify] Error:', err.message);
        return { email: { sent: false }, sms: { sent: false } };
      }
    }

    function setupDashboard() {
      // Setup stats and quick actions based on role
      const statsEl = document.getElementById('dashboard-stats');
      const actionsEl = document.getElementById('quick-actions');

      if (isAdmin) {
        loadLeads();
        loadCustomers();
        setupLeadsRealtime();
        // Also refresh leads every 30 seconds to catch any missed updates
        setInterval(loadLeads, 30000);
        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Leads</div>
            <div class="stat-value" id="stat-new">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Contacted</div>
            <div class="stat-value" id="stat-contacted">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Won</div>
            <div class="stat-value" id="stat-won">-</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="#" class="action-card" onclick="showPage('leads'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>View Leads</h4>
              <p>Manage incoming leads from the website</p>
            </div>
          </a>
          <a href="/get-a-free-estimate/" class="action-card" target="_blank">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            </div>
            <div class="action-text">
              <h4>Quote Form</h4>
              <p>View the customer quote request form</p>
            </div>
          </a>
          <a href="/" class="action-card" target="_blank">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            </div>
            <div class="action-text">
              <h4>View Website</h4>
              <p>Open the main website in a new tab</p>
            </div>
          </a>
        `;
      } else {
        // Enhanced user stats
        statsEl.innerHTML = `
          <div class="stat-card clickable" onclick="showPage('favorites')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></div>
            <div class="stat-label">My Favorites</div>
            <div class="stat-value" id="stat-favorites">0</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('listings')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></div>
            <div class="stat-label">My Listings</div>
            <div class="stat-value" id="stat-listings">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
            <div class="stat-label">Quotes Sent</div>
            <div class="stat-value" id="stat-quotes">0</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="/get-a-free-estimate/" class="action-card action-highlight">
            <div class="action-icon action-icon-gold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Get Free Estimate</h4>
              <p>Request a quote for your project</p>
            </div>
          </a>
          <a href="#" onclick="showPage('favorites'); return false;" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>My Favorites</h4>
              <p>View saved materials</p>
            </div>
          </a>
          <a href="/remnants/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            </div>
            <div class="action-text">
              <h4>Stone Marketplace</h4>
              <p>Buy & sell remnants</p>
            </div>
          </a>
          <a href="/materials/all-countertops/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Countertops</h4>
              <p>Granite, quartz, marble</p>
            </div>
          </a>
          <a href="/materials/flooring/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-width="2" d="M4 4h16v16H4z M4 10h16 M10 4v16"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Flooring</h4>
              <p>LVP, hardwood, tile</p>
            </div>
          </a>
          <a href="/tools/countertop-calculator/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Calculator</h4>
              <p>Estimate your project</p>
            </div>
          </a>
        `;
      }

      // Setup filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          renderLeads();
        });
      });

      // Setup search
      document.getElementById('leads-search')?.addEventListener('input', () => {
        renderLeads();
      });

      // Load admin users if admin
      if (isSuperAdmin) {
        loadAdminUsers();
      }

      // Load user stats from database
      if (!isAdmin) {
        loadUserStats();
      }
    }

    // Load real user stats from database
    async function loadUserStats() {
      if (!currentUser) return;

      try {
        // Load favorites count
        const { count: favCount, error: favError } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!favError) {
          const favEl = document.getElementById('stat-favorites');
          if (favEl) favEl.textContent = favCount || 0;
        }

        // Load listings count
        const { count: listCount, error: listError } = await supabaseClient
          .from('marketplace_listings')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!listError) {
          const listEl = document.getElementById('stat-listings');
          if (listEl) listEl.textContent = listCount || 0;
        }

        // Load quotes count
        const { count: quoteCount, error: quoteError } = await supabaseClient
          .from('quote_requests')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!quoteError) {
          const quoteEl = document.getElementById('stat-quotes');
          if (quoteEl) quoteEl.textContent = quoteCount || 0;
        }

        console.log('Dashboard: Loaded user stats', { favorites: favCount, listings: listCount, quotes: quoteCount });

      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    function showPage(page) {
      // Update URL hash without triggering hashchange
      if (window.location.hash !== `#${page}`) {
        history.replaceState(null, '', `#${page}`);
      }

      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update page sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === `page-${page}`);
      });

      // Update title
      const titles = {
        'dashboard': 'Dashboard',
        'profile': 'My Profile',
        'favorites': 'My Favorites',
        'my-designs': 'My Designs',
        'listings': 'My Listings',
        'tools': 'Design Tools',
        'leads': 'Leads',
        'customers': 'Customers',
        'estimates': 'Estimates',
        'invoices': 'Invoices',
        'jobs': 'Jobs & Projects',
        'contractors': 'Contractors & Team',
        'calendar': 'Calendar',
        'wallet': 'Wallet',
        'admin-users': 'Manage Admins',
        'products': 'Products',
        'orders': 'Orders',
        'messages': 'Messages'
      };
      document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

      // Load estimates when that page is shown
      if (page === 'estimates') {
        loadEstimates();
      }

      // Load favorites when that page is shown
      if (page === 'favorites') {
        loadFavorites();
      }

      // Load my designs when that page is shown
      if (page === 'my-designs') {
        loadMyDesigns();
      }

      // Load listings when that page is shown
      if (page === 'listings') {
        loadMyListings();
      }

      // Load jobs when that page is shown
      if (page === 'jobs') {
        loadJobs();
      }

      // Load contractors when that page is shown
      if (page === 'contractors') {
        loadContractors();
      }

      // Load customers when that page is shown
      if (page === 'customers') {
        loadCustomers();
      }

      // Update FAB visibility based on current page
      updateFabVisibility(page);

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('open');
      document.querySelector('.sidebar-overlay').classList.remove('active');
    }

    // Show/hide the appropriate FAB based on current page
    function updateFabVisibility(page) {
      const fabMap = {
        'leads': 'fab-leads',
        'estimates': 'fab-estimates',
        'invoices': 'fab-invoices',
        'jobs': 'fab-jobs',
        'customers': 'fab-customers'
      };

      // Hide all FABs first
      document.querySelectorAll('.fab-modern').forEach(fab => {
        fab.style.display = 'none';
      });

      // Show the FAB for current page (mobile only)
      const fabId = fabMap[page];
      if (fabId && window.innerWidth <= 768) {
        const fab = document.getElementById(fabId);
        if (fab) {
          fab.style.display = 'flex';
        }
      }
    }

    // Update FAB visibility on window resize
    window.addEventListener('resize', () => {
      const currentPage = window.location.hash.slice(1) || 'dashboard';
      updateFabVisibility(currentPage);
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.querySelector('.sidebar-overlay').classList.toggle('active');
    }

    // Toggle sidebar collapse state (desktop)
    function toggleSidebarCollapse() {
      const sidebar = document.getElementById('sidebar');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      document.body.classList.toggle('sidebar-collapsed', isCollapsed);

      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
    }

    // Initialize sidebar state from localStorage
    function initSidebarState() {
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
      }
    }

    // Update badge visibility based on count
    function updateBadgeVisibility() {
      document.querySelectorAll('.nav-badge').forEach(badge => {
        const count = parseInt(badge.textContent) || 0;
        badge.setAttribute('data-count', count);
        if (count === 0) {
          badge.style.display = 'none';
        } else {
          badge.style.display = '';
        }
      });
    }

    async function saveProfile() {
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;
      const company = document.getElementById('profile-company').value;

      try {
        const { error } = await supabaseClient
          .from('sg_users')
          .update({
            full_name: name,
            phone: phone || null,
            company_name: company || null,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentUser.id);

        if (error) throw error;

        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        alert('Profile saved successfully!');
      } catch (err) {
        alert('Error saving profile: ' + err.message);
      }
    }

    async function handleLogout() {
      // Use SgAuth's comprehensive logout if available
      if (window.SgAuth && typeof window.SgAuth.signOut === 'function') {
        await window.SgAuth.signOut({ redirect: true, redirectUrl: '/' });
        return;
      }

      // Fallback logout
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.warn('Logout error:', e);
      }

      // Clear all state
      currentUser = null;
      userProfile = null;

      // Clear localStorage
      try {
        const storageKey = window._sgSupabaseConfig?.storageKey || 'sg-auth-token';
        localStorage.removeItem(storageKey);
        localStorage.removeItem('sb-ypeypgwsycxcagncgdur-auth-token');
        sessionStorage.removeItem('auth_redirect');
      } catch (e) {}

      // Dispatch logout event for other components
      window.dispatchEvent(new CustomEvent('sg-auth-logout', {
        detail: { timestamp: Date.now() }
      }));

      // Redirect to home
      window.location.href = '/';
    }

    // Leads Functions
    let leadsSubscription = null;

    function setupLeadsRealtime() {
      // Subscribe to new leads in real-time
      if (leadsSubscription) {
        leadsSubscription.unsubscribe();
      }

      leadsSubscription = supabaseClient
        .channel('leads-changes')
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'leads' },
          (payload) => {
            console.log('New lead received:', payload.new);
            // Add to beginning of array
            allLeads.unshift(payload.new);
            updateStats();
            renderLeads();
            // Show notification
            showNewLeadNotification(payload.new);
          }
        )
        .on('postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'leads' },
          (payload) => {
            const idx = allLeads.findIndex(l => l.id === payload.new.id);
            if (idx !== -1) {
              allLeads[idx] = payload.new;
              updateStats();
              renderLeads();
            }
          }
        )
        .subscribe();
    }

    function showNewLeadNotification(lead) {
      // Create floating notification
      const notification = document.createElement('div');
      notification.className = 'new-lead-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid var(--gold-primary);
        border-radius: 12px;
        padding: 16px 20px;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        animation: slideIn 0.3s ease;
        cursor: pointer;
        max-width: 350px;
      `;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; background: var(--gold-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="#1a1a2e" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
          </div>
          <div>
            <div style="font-weight: 700; color: var(--gold-primary); font-size: 12px; text-transform: uppercase;">New Lead!</div>
            <div style="font-weight: 600; color: #fff;">${lead.full_name || 'Unknown'}</div>
            <div style="font-size: 13px; color: var(--text-muted);">${lead.project_type || 'General Inquiry'} - ${lead.form_name || 'Website'}</div>
          </div>
        </div>
      `;

      notification.onclick = () => {
        notification.remove();
        showPage('leads');
        setTimeout(() => viewLead(lead.id), 100);
      };

      document.body.appendChild(notification);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, 10000);

      // Play notification sound if available
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleGw+AGql1O3NpFg+H1qfzunXuWBOQFaVx+PiyHxqV06Ow9fex4ZeUU2EudLYu4FbTEJ3q8jMsHhSTjtvob/CpWtMSWijt764hW9VWmqjwM26i3taYnamu8jIl4RramKYtcPJoJCHf3pijaS0t6OXkYqAdXWInaCmo5qTi4J4');
        audio.volume = 0.3;
        audio.play().catch(() => {});
      } catch (e) {}
    }

    async function loadLeads() {
      try {
        const { data, error } = await supabaseClient
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allLeads = data || [];
        updateStats();
        renderLeads();
      } catch (err) {
        console.error('Error loading leads:', err);
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <h3>Error loading leads</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function updateStats() {
      const stats = {
        total: allLeads.length,
        new: allLeads.filter(l => l.status === 'new').length,
        contacted: allLeads.filter(l => l.status === 'contacted').length,
        won: allLeads.filter(l => l.status === 'won').length
      };

      if (document.getElementById('stat-total')) {
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-new').textContent = stats.new;
        document.getElementById('stat-contacted').textContent = stats.contacted;
        document.getElementById('stat-won').textContent = stats.won;
      }
      const leadsCountEl = document.getElementById('leads-count');
      if (leadsCountEl) {
        leadsCountEl.textContent = stats.new;
        leadsCountEl.setAttribute('data-count', stats.new);
        leadsCountEl.style.display = stats.new > 0 ? '' : 'none';
      }
    }

    function renderLeads() {
      const searchTerm = document.getElementById('leads-search')?.value.toLowerCase() || '';

      let filtered = allLeads;

      if (currentFilter !== 'all') {
        filtered = filtered.filter(l => l.status === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(l =>
          (l.full_name || '').toLowerCase().includes(searchTerm) ||
          (l.email || '').toLowerCase().includes(searchTerm) ||
          (l.phone || '').toLowerCase().includes(searchTerm)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <h3>No leads found</h3>
            <p>${currentFilter !== 'all' ? 'No leads with this status.' : 'Leads from your website forms will appear here.'}</p>
          </div>
        `;
        return;
      }

      // Modern card-based list for better mobile experience
      document.getElementById('leads-table').innerHTML = `
        <div class="list-modern">
          ${filtered.map(lead => `
            <div class="list-item-modern"
                 data-context-menu="lead"
                 data-item-id="${lead.id}"
                 data-item-data='${JSON.stringify({ name: lead.full_name, email: lead.email, phone: lead.phone, status: lead.status }).replace(/'/g, "&#39;")}'
                 onclick="viewLead('${lead.id}')">
              <div class="list-item-icon" style="background: ${getStatusColor(lead.status)}15;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${getStatusColor(lead.status)}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">${lead.full_name || 'Unknown'}</div>
                <div class="list-item-subtitle">${lead.email || lead.phone || 'No contact'}  ${lead.project_type || 'General'}</div>
              </div>
              <div class="list-item-meta">
                <span class="badge-modern badge-${lead.status}">${lead.status}</span>
                <div class="list-item-date">${formatDate(lead.created_at)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Helper: Get color for status
    function getStatusColor(status) {
      const colors = {
        new: '#f9cb00',
        contacted: '#3b82f6',
        qualified: '#8b5cf6',
        quoted: '#06b6d4',
        won: '#22c55e',
        lost: '#ef4444',
        archived: '#6b7280',
        draft: '#6b7280',
        sent: '#3b82f6',
        approved: '#22c55e',
        paid: '#22c55e',
        scheduled: '#8b5cf6',
        in_progress: '#06b6d4',
        completed: '#22c55e',
        cancelled: '#ef4444',
        overdue: '#ef4444'
      };
      return colors[status] || '#6b7280';
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) return 'Just now';
        return `${hours}h ago`;
      } else if (days === 1) return 'Yesterday';
      else if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function viewLead(id) {
      selectedLead = allLeads.find(l => l.id === id);
      if (!selectedLead) return;

      // Build base details HTML
      let detailsHtml = `
        <div class="detail-row"><div class="detail-label">Name</div><div class="detail-value">${selectedLead.full_name || 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${selectedLead.email ? `<a href="mailto:${selectedLead.email}" style="color: var(--gold-primary);">${selectedLead.email}</a>` : 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">${selectedLead.phone ? `<a href="tel:${selectedLead.phone}" style="color: var(--gold-primary);">${selectedLead.phone}</a>` : 'Not provided'}</div></div>
        <div class="detail-row"><div class="detail-label">Project</div><div class="detail-value">${selectedLead.project_type || 'Not specified'}</div></div>
        <div class="detail-row"><div class="detail-label">Message</div><div class="detail-value">${selectedLead.message || 'No message'}</div></div>
        <div class="detail-row"><div class="detail-label">Source</div><div class="detail-value">${selectedLead.form_name || 'Website'}</div></div>
        <div class="detail-row"><div class="detail-label">Submitted</div><div class="detail-value">${new Date(selectedLead.created_at).toLocaleString()}</div></div>
      `;

      // Show linked customer if exists
      if (selectedLead.customer_id) {
        const customer = await getCustomer(selectedLead.customer_id);
        if (customer) {
          detailsHtml += `
            <div class="detail-row" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
              <div class="detail-label">Linked Customer</div>
              <div class="detail-value">
                <a href="#" onclick="event.preventDefault(); showPage('customers'); setTimeout(() => viewCustomer('${customer.id}'), 100);" style="color: var(--gold-primary);">
                  ${customer.name} ${customer.email ? `(${customer.email})` : ''}
                </a>
              </div>
            </div>
          `;
        }
      }

      document.getElementById('lead-details').innerHTML = detailsHtml;

      // Load linked estimates
      const estimatesContainer = document.getElementById('lead-estimates-list');
      if (estimatesContainer) {
        estimatesContainer.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px;">Loading estimates...</div>';

        const { data: estimates } = await supabaseClient
          .from('estimates')
          .select('id, estimate_number, total, status, created_at')
          .eq('lead_id', selectedLead.id)
          .order('created_at', { ascending: false });

        if (estimates && estimates.length > 0) {
          estimatesContainer.innerHTML = estimates.map(est => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--dark-bg); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; font-size: 14px;">${est.estimate_number || 'Draft'}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${new Date(est.created_at).toLocaleDateString()}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--gold-primary);">$${(est.total || 0).toLocaleString()}</div>
                <span class="status-badge status-${est.status}" style="font-size: 11px;">${est.status}</span>
              </div>
            </div>
          `).join('');
        } else {
          estimatesContainer.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px; text-align: center;">No estimates yet</div>';
        }
      }

      document.getElementById('lead-status-select').value = selectedLead.status || 'new';
      document.getElementById('lead-modal').classList.add('active');
    }

    function closeLeadModal() {
      document.getElementById('lead-modal').classList.remove('active');
      selectedLead = null;
    }

    function openAddLeadModal() {
      document.getElementById('add-lead-form').reset();
      document.getElementById('add-lead-modal').classList.add('active');

      // Set min date for appointment picker to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('new-lead-appt-date').min = today;

      // Reset service address visibility
      document.getElementById('new-lead-service-address-section').style.display = 'none';
      document.getElementById('new-lead-address-same').checked = true;
    }

    function closeAddLeadModal() {
      document.getElementById('add-lead-modal').classList.remove('active');
      // Reset service address section
      document.getElementById('new-lead-address-same').checked = true;
      document.getElementById('new-lead-service-address-section').style.display = 'none';
    }

    function toggleNewLeadServiceAddress() {
      const checkbox = document.getElementById('new-lead-address-same');
      const serviceSection = document.getElementById('new-lead-service-address-section');

      if (checkbox.checked) {
        serviceSection.style.display = 'none';
        // Clear service address fields
        document.getElementById('new-lead-service-street').value = '';
        document.getElementById('new-lead-service-street2').value = '';
        document.getElementById('new-lead-service-city').value = '';
        document.getElementById('new-lead-service-zip').value = '';
      } else {
        serviceSection.style.display = 'block';
        // Animate in
        serviceSection.style.animation = 'fadeSlideIn 0.3s ease';
      }
    }

    async function saveNewLead(event) {
      event.preventDefault();

      const btn = document.getElementById('save-lead-btn');
      const originalBtnHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Saving...';

      try {
        const firstName = document.getElementById('new-lead-first-name').value.trim();
        const lastName = document.getElementById('new-lead-last-name').value.trim();
        const fullName = `${firstName} ${lastName}`.trim();
        const email = document.getElementById('new-lead-email').value.trim();
        const phone = document.getElementById('new-lead-phone').value.trim() || null;
        const projectType = document.getElementById('new-lead-project-type').value || null;

        // Collect billing address
        const billingStreet = document.getElementById('new-lead-billing-street').value.trim();
        const billingAddress = billingStreet ? {
          street: billingStreet,
          street2: document.getElementById('new-lead-billing-street2').value.trim() || null,
          city: document.getElementById('new-lead-billing-city').value.trim() || null,
          state: document.getElementById('new-lead-billing-state').value || null,
          zip: document.getElementById('new-lead-billing-zip').value.trim() || null
        } : null;

        // Check if service address is same as billing
        const addressSame = document.getElementById('new-lead-address-same').checked;

        // Collect service address if different
        let serviceAddress = null;
        if (!addressSame) {
          const serviceStreet = document.getElementById('new-lead-service-street').value.trim();
          if (serviceStreet) {
            serviceAddress = {
              street: serviceStreet,
              street2: document.getElementById('new-lead-service-street2').value.trim() || null,
              city: document.getElementById('new-lead-service-city').value.trim() || null,
              state: document.getElementById('new-lead-service-state').value || null,
              zip: document.getElementById('new-lead-service-zip').value.trim() || null
            };
          }
        }

        // Collect appointment data
        const apptDate = document.getElementById('new-lead-appt-date').value;
        const apptTime = document.getElementById('new-lead-appt-time').value;
        const apptType = document.getElementById('new-lead-appt-type').value;
        const hasAppointment = apptDate && apptTime;

        // Format appointment string for message
        let appointmentInfo = '';
        if (hasAppointment) {
          const apptDateObj = new Date(apptDate + 'T12:00:00');
          const formattedDate = apptDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
          const apptTypeLabels = {
            'estimate': 'Free In-Home Estimate',
            'measure': 'Measurement Visit',
            'showroom': 'Showroom Visit',
            'consultation': 'Design Consultation',
            'installation': 'Installation'
          };
          appointmentInfo = `\n\nSCHEDULED APPOINTMENT:\n${apptTypeLabels[apptType] || apptType}\n${formattedDate} at ${apptTime}`;
        }

        const userMessage = document.getElementById('new-lead-message').value.trim() || '';
        const fullMessage = userMessage + appointmentInfo;

        const leadData = {
          full_name: fullName,
          first_name: firstName,
          last_name: lastName,
          email: email,
          phone: phone,
          project_type: projectType,
          zip_code: document.getElementById('new-lead-zip').value.trim() || null,
          message: fullMessage || null,
          source: document.getElementById('new-lead-source').value,
          status: document.getElementById('new-lead-status').value,
          form_name: 'manual-entry',
          created_at: new Date().toISOString(),
          // Address fields
          billing_address: billingAddress,
          service_address: serviceAddress,
          address_same: addressSame,
          // Appointment data in raw_data
          raw_data: hasAppointment ? {
            appointment: {
              date: apptDate,
              time: apptTime,
              type: apptType
            }
          } : null
        };

        const { data, error } = await supabaseClient
          .from('leads')
          .insert([leadData])
          .select()
          .single();

        if (error) throw error;

        // Send welcome email if checkbox is checked
        const sendEmail = document.getElementById('new-lead-send-email').checked;
        if (sendEmail && email) {
          try {
            await sendLeadWelcomeEmail({
              firstName,
              lastName,
              email,
              phone,
              projectType,
              hasAppointment,
              apptDate,
              apptTime,
              apptType
            });
          } catch (emailErr) {
            console.warn('Welcome email error (non-blocking):', emailErr);
          }
        }

        // Add to local array and refresh display
        allLeads.unshift(data);
        updateStats();
        renderLeads();
        closeAddLeadModal();

        let successMsg = 'Lead added successfully!';
        if (sendEmail && email) successMsg += ' Welcome email sent.';
        if (hasAppointment) successMsg += ' Appointment scheduled.';
        showToast(successMsg, 'success');

      } catch (err) {
        console.error('Error saving lead:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
      }
    }

    // Send welcome email to new lead
    async function sendLeadWelcomeEmail(leadInfo) {
      const { firstName, lastName, email, phone, projectType, hasAppointment, apptDate, apptTime, apptType, notes } = leadInfo;

      const projectTypeLabels = {
        'kitchen': 'Kitchen Countertops',
        'bathroom': 'Bathroom Vanity',
        'flooring': 'Flooring',
        'fireplace': 'Fireplace Surround',
        'outdoor': 'Outdoor Kitchen',
        'commercial': 'Commercial Project',
        'other': 'Home Improvement'
      };
      const projectLabel = projectTypeLabels[projectType] || 'Countertop Project';

      const apptTypeLabels = {
        'estimate': 'Free In-Home Estimate',
        'measure': 'Measurement Visit',
        'showroom': 'Showroom Visit',
        'consultation': 'Design Consultation',
        'installation': 'Installation'
      };

      // Format appointment date nicely
      let formattedDate = '';
      if (hasAppointment && apptDate) {
        const apptDateObj = new Date(apptDate + 'T12:00:00');
        formattedDate = apptDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      }

      try {
        // Use the dedicated lead welcome email endpoint
        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/lead-welcome', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            first_name: firstName,
            last_name: lastName,
            full_name: `${firstName} ${lastName}`.trim(),
            project_type: projectLabel,
            notes: notes || null,
            has_appointment: hasAppointment,
            appointment_date: hasAppointment ? formattedDate : null,
            appointment_time: hasAppointment ? apptTime : null,
            appointment_type: hasAppointment ? (apptTypeLabels[apptType] || 'Appointment') : null,
            source: 'Manual Entry - Account'
          })
        });

        const result = await response.json();
        if (!response.ok) {
          console.error('Welcome email failed:', result);
          return false;
        }
        console.log('Welcome email sent successfully to:', email);
        return true;
      } catch (error) {
        console.error('Failed to send welcome email:', error);
        return false;
      }
    }

    // Close add lead modal when clicking overlay
    document.getElementById('add-lead-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeAddLeadModal();
    });

    async function updateLeadStatus() {
      if (!selectedLead) return;

      const newStatus = document.getElementById('lead-status-select').value;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = newStatus;

        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Status updated', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteLead() {
      if (!selectedLead) return;

      const confirmed = confirm(`Are you sure you want to permanently delete this lead?\n\n${selectedLead.full_name || 'Unknown'}\n${selectedLead.email || ''}\n\nThis action cannot be undone.`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', selectedLead.id);

        if (error) throw error;

        // Remove from local array
        allLeads = allLeads.filter(l => l.id !== selectedLead.id);
        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Lead deleted', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function archiveLead() {
      if (!selectedLead) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        // Update local array
        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = 'archived';

        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Lead archived', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickDeleteLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const confirmed = confirm(`Delete this lead?\n\n${lead.full_name || 'Unknown'}\n${lead.email || ''}`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', leadId);

        if (error) throw error;

        allLeads = allLeads.filter(l => l.id !== leadId);
        updateStats();
        renderLeads();
        showToast('Lead deleted', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickArchiveLead(leadId) {
      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === leadId);
        if (idx !== -1) allLeads[idx].status = 'archived';

        updateStats();
        renderLeads();
        showToast('Lead archived', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function convertLeadToCustomer() {
      if (!selectedLead) {
        showToast('No lead selected', 'error');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Check if customer already exists with this email
        if (selectedLead.email) {
          const { data: existing, error: checkError } = await supabaseClient
            .from('customers')
            .select('id')
            .eq('email', selectedLead.email)
            .eq('user_id', user.id)
            .maybeSingle();

          // Ignore 406 errors (no rows found)
          if (existing && !checkError) {
            showToast('Customer with this email already exists', 'info');
            return;
          }
        }

        // Parse name into parts
        const nameParts = (selectedLead.full_name || '').trim().split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';

        // Get address from structured data or parse from string
        let address = null, city = null, state = 'AZ', zip = null;

        // Try structured service_address first, then billing_address
        const structuredAddr = selectedLead.service_address || selectedLead.billing_address;
        if (structuredAddr && typeof structuredAddr === 'object') {
          address = structuredAddr.street || null;
          if (structuredAddr.street2) address += ' ' + structuredAddr.street2;
          city = structuredAddr.city || null;
          state = structuredAddr.state || 'AZ';
          zip = structuredAddr.zip || selectedLead.zip_code || null;
        } else {
          // Fall back to parsing address string
          const addressParts = (selectedLead.project_address || selectedLead.address || '').split(',').map(s => s.trim());
          address = addressParts[0] || null;
          city = addressParts[1] || null;
          state = addressParts[2] || 'AZ';
          zip = selectedLead.zip_code || null;
        }

        // Build notes with appointment info if present
        let notes = `Lead source: ${selectedLead.form_name || 'Website'}\nProject type: ${selectedLead.project_type || 'Not specified'}`;
        if (selectedLead.raw_data?.appointment) {
          const appt = selectedLead.raw_data.appointment;
          const apptTypeLabels = {
            'estimate': 'Free In-Home Estimate',
            'measure': 'Measurement Visit',
            'showroom': 'Showroom Visit',
            'consultation': 'Design Consultation',
            'installation': 'Installation'
          };
          notes += `\n\nScheduled: ${apptTypeLabels[appt.type] || appt.type} on ${appt.date} at ${appt.time}`;
        }
        if (selectedLead.message) {
          notes += `\n\nOriginal message: ${selectedLead.message}`;
        }

        // Create customer with standard fields only (+ bidirectional lead_id reference)
        const customerData = {
          user_id: user.id,
          name: selectedLead.full_name || 'Unknown',
          email: selectedLead.email || null,
          phone: selectedLead.phone || null,
          address: address,
          city: city,
          state: state,
          zip: zip,
          notes: notes,
          lead_id: selectedLead.id, // Bidirectional reference back to lead
          source: selectedLead.form_name || 'lead_conversion'
        };

        console.log('Creating customer with data:', customerData);

        const { data: customer, error } = await supabaseClient
          .from('customers')
          .insert(customerData)
          .select()
          .single();

        if (error) {
          console.error('Customer insert error:', error);
          throw error;
        }

        // Update lead status to "qualified"
        await supabaseClient
          .from('leads')
          .update({ status: 'qualified', customer_id: customer.id, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        // Update local lead data (bidirectional sync)
        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) {
          allLeads[idx].status = 'qualified';
          allLeads[idx].customer_id = customer.id;
        }

        // Add new customer to global array (bidirectional sync)
        customer.lead_id = selectedLead.id;
        customer.total_jobs = 0;
        customer.total_spent = 0;
        allCustomers.unshift(customer);

        // Save appointment info before closing modal (which clears selectedLead)
        const hasAppointment = selectedLead?.raw_data?.appointment;
        const customerId = customer.id;

        showToast('Customer created successfully!');
        updateStats();
        renderLeads();
        closeLeadModal();

        // Offer to create estimate with appointment pre-filled
        const confirmMsg = hasAppointment
          ? 'Customer added! They have an appointment scheduled. Create an estimate for them now?'
          : 'Customer added! Would you like to create an estimate for them now?';

        if (confirm(confirmMsg)) {
          createEstimateForCustomer(customerId);
        }
      } catch (err) {
        console.error('Convert lead error:', err);
        showToast('Error creating customer: ' + err.message, 'error');
      }
    }

    // UNIFIED: Start estimate from lead - ensures customer is created/linked first
    async function startEstimateFromLead(leadId) {
      const lead = leadId ? allLeads.find(l => l.id === leadId) : selectedLead;
      if (!lead) {
        showToast('No lead selected', 'error');
        return;
      }

      // Close lead modal
      closeLeadModal();

      showToast('Creating customer record...', 'info');

      // ALWAYS create/find customer first - this ensures proper linkage
      const customer = await findOrCreateCustomerFromLead(lead);
      if (!customer) {
        showToast('Failed to create customer record', 'error');
        return;
      }

      // Update workflow state
      workflowState.currentLead = lead;
      workflowState.currentCustomer = customer;

      // Navigate to estimates page
      showPage('estimates');

      // Small delay to ensure page is rendered
      setTimeout(() => {
        // Set modal state with proper customer linkage
        estimateModalState = {
          customerId: customer.id,
          leadId: lead.id,
          editingEstimateId: null
        };

        // Open estimate modal (preserveState=true since we set estimateModalState above)
        openCreateEstimateModal(true);

        // Pre-fill customer info
        fillEstimateCustomerFields(customer);

        // Pre-fill project info from lead
        const projectNameField = document.getElementById('estimate-project-name');
        const projectDescField = document.getElementById('estimate-project-desc');
        if (projectNameField) projectNameField.value = lead.project_type ? `${lead.project_type} Project` : 'New Project';
        if (projectDescField) projectDescField.value = lead.message || lead.project_details || '';

        // Update lead status to "quoted"
        supabaseClient
          .from('leads')
          .update({ status: 'quoted', updated_at: new Date().toISOString() })
          .eq('id', lead.id);

        showToast(`Estimate linked to customer: ${customer.name}`);
      }, 150);
    }

    // Backward compatibility alias
    async function createEstimateFromLead() {
      return startEstimateFromLead(selectedLead?.id);
    }

    // Create room design from lead
    async function createDesignFromLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'error');
        return;
      }

      // Store lead info in sessionStorage for the room designer to read
      const leadInfo = {
        id: selectedLead.id,
        full_name: selectedLead.full_name || '',
        email: selectedLead.email || '',
        phone: selectedLead.phone || '',
        address: selectedLead.project_address || selectedLead.address || '',
        project_type: selectedLead.project_type || '',
        message: selectedLead.message || selectedLead.project_details || ''
      };

      sessionStorage.setItem('sg_lead_for_design', JSON.stringify(leadInfo));

      // Close lead modal
      closeLeadModal();

      // Open room designer in new tab with lead flag
      window.open('/tools/room-designer/?from_lead=1', '_blank');

      showToast('Opening Room Designer with lead info...');
    }

    // Quick convert from leads table
    async function quickConvertLead(leadId, action) {
      selectedLead = allLeads.find(l => l.id === leadId);
      if (!selectedLead) {
        showToast('Lead not found', 'error');
        return;
      }

      if (action === 'customer') {
        await convertLeadToCustomer();
      } else if (action === 'estimate') {
        await createEstimateFromLead();
      } else if (action === 'design') {
        await createDesignFromLead();
      }
    }

    // ==========================================
    // CUSTOMER MANAGEMENT FUNCTIONS
    // ==========================================

    async function loadCustomers() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .order('name');

        if (error) throw error;

        allCustomers = data || [];
        updateCustomersCount();
        renderCustomers();
      } catch (err) {
        console.error('Error loading customers:', err);
        document.getElementById('customers-table').innerHTML = `
          <div class="empty-state">
            <h3>Error loading customers</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function updateCustomersCount() {
      const countEl = document.getElementById('customers-count');
      if (countEl) {
        countEl.textContent = allCustomers.length;
        countEl.style.display = allCustomers.length > 0 ? '' : 'none';
      }
    }

    function filterCustomers(filter) {
      customerFilter = filter;
      document.querySelectorAll('[data-customer-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.customerFilter === filter);
      });
      renderCustomers();
    }

    function searchCustomersPage() {
      renderCustomers();
    }

    function renderCustomers() {
      const searchTerm = (document.getElementById('customers-search')?.value || '').toLowerCase();
      let filtered = allCustomers;

      // Apply filter
      if (customerFilter === 'active') {
        filtered = filtered.filter(c => c.total_jobs > 0);
      } else if (customerFilter === 'recent') {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        filtered = filtered.filter(c => new Date(c.updated_at) > thirtyDaysAgo);
      }

      // Apply search
      if (searchTerm) {
        filtered = filtered.filter(c =>
          (c.name || '').toLowerCase().includes(searchTerm) ||
          (c.email || '').toLowerCase().includes(searchTerm) ||
          (c.phone || '').toLowerCase().includes(searchTerm) ||
          (c.city || '').toLowerCase().includes(searchTerm)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('customers-table').innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
            <h3>No customers found</h3>
            <p>${allCustomers.length === 0 ? 'Convert leads to customers or add them manually.' : 'Try a different search term.'}</p>
            <button class="btn-modern primary" onclick="openAddCustomerModal()" style="margin-top: 16px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
              Add Customer
            </button>
          </div>
        `;
        return;
      }

      // Modern card-based list for customers
      document.getElementById('customers-table').innerHTML = `
        <div class="list-modern">
          ${filtered.map(c => {
            const hasJobs = c.total_jobs > 0;
            const jobsColor = hasJobs ? '#22c55e' : '#6b7280';
            return `
            <div class="list-item-modern"
                 onclick="viewCustomer('${c.id}')"
                 data-context-menu="customer"
                 data-item-id="${c.id}"
                 data-item-data='${JSON.stringify({ name: c.name, email: c.email, phone: c.phone }).replace(/'/g, "&#39;")}'>
              <div class="list-item-icon" style="background: rgba(249, 203, 0, 0.15); color: var(--gold-primary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">${c.name || 'Unknown'}</div>
                <div class="list-item-subtitle">${c.email || 'No email'} ${c.phone ? ' ' + c.phone : ''}</div>
                <div class="list-item-subtitle" style="margin-top: 2px;">
                  ${c.city || 'No location'}${c.state ? ', ' + c.state : ''}
                  <span style="color: var(--text-muted); margin-left: 8px;">${c.source || 'Direct'}</span>
                </div>
              </div>
              <div class="list-item-meta">
                <div style="font-weight: 700; font-size: 15px; color: var(--gold-primary); margin-bottom: 4px;">$${(c.total_spent || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</div>
                <span class="badge-modern" style="background: ${jobsColor}20; color: ${jobsColor};">${c.total_jobs || 0} jobs</span>
              </div>
            </div>
          `;}).join('')}
        </div>
      `;
    }

    async function viewCustomer(customerId) {
      selectedCustomer = allCustomers.find(c => c.id === customerId);
      if (!selectedCustomer) {
        // Try loading from database
        const { data } = await supabaseClient.from('customers').select('*').eq('id', customerId).single();
        if (data) selectedCustomer = data;
        else return;
      }

      // Update modal title
      document.getElementById('customer-modal-title').textContent = selectedCustomer.name || 'Customer Details';

      // Render customer info
      document.getElementById('customer-info').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${selectedCustomer.email ? `<a href="mailto:${selectedCustomer.email}" style="color: var(--gold-primary);">${selectedCustomer.email}</a>` : 'Not provided'}</div></div>
          <div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">${selectedCustomer.phone ? `<a href="tel:${selectedCustomer.phone}" style="color: var(--gold-primary);">${selectedCustomer.phone}</a>` : 'Not provided'}</div></div>
          <div class="detail-row"><div class="detail-label">Address</div><div class="detail-value">${selectedCustomer.address || '-'}</div></div>
          <div class="detail-row"><div class="detail-label">City/State/ZIP</div><div class="detail-value">${[selectedCustomer.city, selectedCustomer.state, selectedCustomer.zip].filter(Boolean).join(', ') || '-'}</div></div>
          <div class="detail-row"><div class="detail-label">Source</div><div class="detail-value">${selectedCustomer.source || 'Direct'}</div></div>
          <div class="detail-row"><div class="detail-label">Customer Since</div><div class="detail-value">${new Date(selectedCustomer.created_at).toLocaleDateString()}</div></div>
        </div>
      `;

      // Reset to jobs tab and load content
      currentCustomerTab = 'jobs';
      document.querySelectorAll('.customer-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === 'jobs');
      });
      loadCustomerTabContent('jobs');

      // Show modal
      document.getElementById('customer-modal').classList.add('active');
    }

    function closeCustomerModal() {
      document.getElementById('customer-modal').classList.remove('active');
      selectedCustomer = null;
    }

    function showCustomerTab(tab) {
      currentCustomerTab = tab;
      document.querySelectorAll('.customer-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      loadCustomerTabContent(tab);
    }

    async function loadCustomerTabContent(tab) {
      const container = document.getElementById('customer-tab-content');
      container.innerHTML = '<div class="empty-state"><div class="spinner"></div><p>Loading...</p></div>';

      if (!selectedCustomer) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        if (tab === 'jobs') {
          const { data: jobs } = await supabaseClient
            .from('jobs')
            .select('*')
            .eq('customer_id', selectedCustomer.id)
            .order('created_at', { ascending: false });

          if (!jobs || jobs.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No jobs for this customer yet.</p>
                <button class="btn-modern primary" onclick="createJobForCustomer()" style="margin-top: 12px;">Create First Job</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Job #</th><th>Description</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                <tbody>
                  ${jobs.map(j => `
                    <tr style="cursor: pointer;" onclick="viewJob && viewJob('${j.id}')">
                      <td style="font-weight: 600;">${j.job_number || '-'}</td>
                      <td>${j.project_description || '-'}</td>
                      <td><span class="status-badge job-${j.status || 'new'}">${(j.status || 'new').replace('_', ' ')}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(j.total_price || 0).toFixed(2)}</td>
                      <td>${new Date(j.created_at).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'estimates') {
          const { data: estimates } = await supabaseClient
            .from('estimates')
            .select('*')
            .or(`customer_email.eq.${selectedCustomer.email},customer_id.eq.${selectedCustomer.id}`)
            .order('created_at', { ascending: false });

          if (!estimates || estimates.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No estimates for this customer yet.</p>
                <button class="btn-modern primary" onclick="createEstimateForCustomer()" style="margin-top: 12px;">Create Estimate</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Estimate #</th><th>Project</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                <tbody>
                  ${estimates.map(e => `
                    <tr style="cursor: pointer;" onclick="viewEstimate && viewEstimate('${e.id}')">
                      <td style="font-weight: 600;">${e.estimate_number || 'Draft'}</td>
                      <td>${e.project_name || '-'}</td>
                      <td><span class="status-badge status-${e.status}">${e.status}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(e.total || 0).toFixed(2)}</td>
                      <td>${new Date(e.created_at).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'invoices') {
          const { data: invoices } = await supabaseClient
            .from('invoices')
            .select('*')
            .or(`customer_email.eq.${selectedCustomer.email},customer_id.eq.${selectedCustomer.id}`)
            .order('created_at', { ascending: false });

          if (!invoices || invoices.length === 0) {
            container.innerHTML = `<div class="empty-state"><p>No invoices for this customer yet.</p></div>`;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Invoice #</th><th>Status</th><th>Amount</th><th>Due Date</th></tr></thead>
                <tbody>
                  ${invoices.map(inv => `
                    <tr>
                      <td style="font-weight: 600;">${inv.invoice_number || '-'}</td>
                      <td><span class="status-badge status-${inv.status === 'paid' ? 'won' : inv.status === 'open' ? 'new' : 'lost'}">${inv.status}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(inv.amount_due || 0).toFixed(2)}</td>
                      <td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'notes') {
          container.innerHTML = `
            <div style="padding: 16px;">
              <textarea id="customer-notes-edit" rows="6" style="width: 100%; padding: 12px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); resize: vertical;">${selectedCustomer.notes || ''}</textarea>
              <button class="btn-modern primary" onclick="saveCustomerNotes()" style="margin-top: 12px;">Save Notes</button>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error loading tab content:', err);
        container.innerHTML = `<div class="empty-state"><p style="color: var(--error);">Error: ${err.message}</p></div>`;
      }
    }

    async function saveCustomerNotes() {
      if (!selectedCustomer) return;
      const notes = document.getElementById('customer-notes-edit')?.value || '';

      try {
        const { error } = await supabaseClient
          .from('customers')
          .update({ notes, updated_at: new Date().toISOString() })
          .eq('id', selectedCustomer.id);

        if (error) throw error;
        selectedCustomer.notes = notes;
        showToast('Notes saved!');
      } catch (err) {
        showToast('Error saving notes: ' + err.message, 'error');
      }
    }

    function openAddCustomerModal() {
      selectedCustomer = null;
      document.getElementById('edit-customer-title').textContent = 'Add Customer';
      document.getElementById('edit-customer-form').reset();
      document.getElementById('edit-customer-modal').classList.add('active');
    }

    function editCustomer() {
      if (!selectedCustomer) return;
      document.getElementById('edit-customer-title').textContent = 'Edit Customer';

      // Populate form
      document.getElementById('customer-name').value = selectedCustomer.name || '';
      document.getElementById('customer-email').value = selectedCustomer.email || '';
      document.getElementById('customer-phone').value = selectedCustomer.phone || '';
      document.getElementById('customer-source').value = selectedCustomer.source || '';
      document.getElementById('customer-address').value = selectedCustomer.address || '';
      document.getElementById('customer-city').value = selectedCustomer.city || '';
      document.getElementById('customer-state').value = selectedCustomer.state || '';
      document.getElementById('customer-zip').value = selectedCustomer.zip || '';
      document.getElementById('customer-notes').value = selectedCustomer.notes || '';

      closeCustomerModal();
      document.getElementById('edit-customer-modal').classList.add('active');
    }

    function closeEditCustomerModal() {
      document.getElementById('edit-customer-modal').classList.remove('active');
    }

    async function saveCustomerForm(event) {
      event.preventDefault();

      const btn = document.getElementById('save-customer-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        const customerData = {
          user_id: user.id,
          name: document.getElementById('customer-name').value.trim(),
          email: document.getElementById('customer-email').value.trim() || null,
          phone: document.getElementById('customer-phone').value.trim() || null,
          source: document.getElementById('customer-source').value || null,
          address: document.getElementById('customer-address').value.trim() || null,
          city: document.getElementById('customer-city').value.trim() || null,
          state: document.getElementById('customer-state').value.trim() || null,
          zip: document.getElementById('customer-zip').value.trim() || null,
          notes: document.getElementById('customer-notes').value.trim() || null,
          updated_at: new Date().toISOString()
        };

        let result;
        if (selectedCustomer) {
          // Update existing
          result = await supabaseClient
            .from('customers')
            .update(customerData)
            .eq('id', selectedCustomer.id)
            .select()
            .single();
        } else {
          // Insert new
          result = await supabaseClient
            .from('customers')
            .insert([customerData])
            .select()
            .single();
        }

        if (result.error) throw result.error;

        closeEditCustomerModal();
        showToast(selectedCustomer ? 'Customer updated!' : 'Customer added!');
        await loadCustomers();

        // If we were viewing this customer, refresh the view
        if (selectedCustomer) {
          viewCustomer(result.data.id);
        }
      } catch (err) {
        console.error('Save customer error:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Customer';
      }
    }

    async function deleteCustomer() {
      if (!selectedCustomer) return;

      const confirmed = confirm(`Are you sure you want to delete this customer?\n\n${selectedCustomer.name}\n${selectedCustomer.email || ''}\n\nThis will NOT delete their jobs, estimates, or invoices.`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('customers')
          .delete()
          .eq('id', selectedCustomer.id);

        if (error) throw error;

        closeCustomerModal();
        allCustomers = allCustomers.filter(c => c.id !== selectedCustomer.id);
        updateCustomersCount();
        renderCustomers();
        showToast('Customer deleted');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    function createJobForCustomer() {
      if (!selectedCustomer) return;
      closeCustomerModal();
      showPage('jobs');

      setTimeout(() => {
        if (typeof openCreateJobModal === 'function') {
          openCreateJobModal(selectedCustomer);
        } else {
          showToast('Navigate to Jobs page to create a job', 'info');
        }
      }, 100);
    }

    // Note: Main createEstimateForCustomer function is defined later with full implementation
    // This early reference is kept for code that runs before the full definition loads

    function quickNewJobForCustomer(customerId) {
      selectedCustomer = allCustomers.find(c => c.id === customerId);
      createJobForCustomer();
    }

    function quickNewEstimateForCustomer(customerId) {
      createEstimateForCustomer(customerId);
    }

    // Close modals on overlay click
    document.getElementById('customer-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeCustomerModal();
    });
    document.getElementById('edit-customer-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeEditCustomerModal();
    });

    // Admin Users Functions
    let adminUsers = [];

    async function loadAdminUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .or('account_type.eq.admin,account_type.eq.super_admin')
          .order('created_at', { ascending: false });

        if (error) throw error;
        adminUsers = data || [];
        renderAdminUsers();
      } catch (err) {
        document.getElementById('admin-users-list').innerHTML = `<p style="color: var(--error);">Error: ${err.message}</p>`;
      }
    }

    function renderAdminUsers() {
      const allAdmins = [
        ...SUPER_ADMIN_EMAILS.map(email => ({ email, full_name: email.split('@')[0], isSuperAdmin: true })),
        ...adminUsers.filter(u => !SUPER_ADMIN_EMAILS.includes(u.email?.toLowerCase()))
      ];

      document.getElementById('admin-users-list').innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allAdmins.map(user => `
              <tr>
                <td>${user.email}</td>
                <td>${user.full_name || '-'}</td>
                <td><span class="status-badge ${user.isSuperAdmin ? 'status-won' : 'status-qualified'}">${user.isSuperAdmin ? 'Super Admin' : 'Admin'}</span></td>
                <td style="text-align: right;">
                  ${user.isSuperAdmin ? '<span style="color: var(--text-muted); font-size: 12px;">Protected</span>' :
                    `<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeAdminUser('${user.id}', '${user.email}')">Remove</button>`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function addAdminUser() {
      const email = document.getElementById('new-admin-email').value.trim().toLowerCase();
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
      }

      if (SUPER_ADMIN_EMAILS.includes(email)) {
        alert('Already a super admin');
        return;
      }

      try {
        const { data: existing } = await supabaseClient.from('sg_users').select('*').eq('email', email).single();

        if (existing) {
          await supabaseClient.from('sg_users').update({ account_type: 'admin' }).eq('id', existing.id);
        } else {
          await supabaseClient.from('sg_users').insert([{ email, account_type: 'admin', full_name: email.split('@')[0] }]);
        }

        document.getElementById('new-admin-email').value = '';
        loadAdminUsers();
        alert(`Admin access granted to ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeAdminUser(userId, email) {
      if (!confirm(`Remove admin access for ${email}?`)) return;

      try {
        await supabaseClient.from('sg_users').update({ account_type: 'homeowner' }).eq('id', userId);
        loadAdminUsers();
        alert(`Admin removed: ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeLeadModal();
        closeProductModal();
        closeInvoiceModal();
      }
    });

    document.getElementById('lead-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeLeadModal();
    });

    // ============ PRODUCT MANAGEMENT ============
    let allProducts = [];
    let productFilter = 'all';
    let editingProduct = null;

    async function loadProducts() {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      try {
        let query = supabaseClient
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });

        // Non-super admins only see their own products
        if (!isSuperAdmin) {
          query = query.eq('vendor_id', currentUser.id);
        }

        const { data, error } = await query;

        if (error) {
          // Table might not exist yet
          if (error.code === '42P01') {
            productsGrid.innerHTML = `
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                <h3>Products Table Not Set Up</h3>
                <p>The products table needs to be created in Supabase. Contact your administrator.</p>
              </div>
            `;
            return;
          }
          throw error;
        }

        allProducts = data || [];
        renderProducts();
      } catch (err) {
        console.error('Error loading products:', err);
        productsGrid.innerHTML = `
          <div class="empty-state">
            <h3>Error loading products</h3>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    function filterProducts(status) {
      productFilter = status;
      document.querySelectorAll('[data-product-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.productStatus === status);
      });
      renderProducts();
    }

    function renderProducts() {
      const productsGrid = document.getElementById('products-grid');
      if (!productsGrid) return;

      let filtered = allProducts;
      if (productFilter !== 'all') {
        filtered = filtered.filter(p => p.status === productFilter);
      }

      if (filtered.length === 0) {
        productsGrid.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <h3>No products found</h3>
            <p>${productFilter !== 'all' ? 'No products with this status.' : 'Add your first product to get started.'}</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openProductModal()">Add Product</button>
          </div>
        `;
        return;
      }

      productsGrid.innerHTML = filtered.map(product => `
        <div class="product-card" data-id="${product.id}">
          <div class="product-image">
            ${product.image_url ?
              `<img src="${product.image_url}" alt="${product.name}" onerror="this.style.display='none';this.parentElement.querySelector('.product-placeholder').style.display='flex';">
               <div class="product-placeholder" style="display:none;">` :
              `<div class="product-placeholder">`}
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
          </div>
          <div class="product-info">
            <div class="product-status status-${product.status}">${product.status}</div>
            <h4 class="product-name">${product.name}</h4>
            <p class="product-category">${product.category || 'Uncategorized'}</p>
            <div class="product-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
            ${product.dimensions ? `<p class="product-dims">${product.dimensions}</p>` : ''}
          </div>
          <div class="product-actions">
            <button class="action-btn" onclick="editProduct('${product.id}')" title="Edit">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            </button>
            <button class="action-btn" onclick="deleteProduct('${product.id}')" title="Delete" style="color: var(--error);">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    function openProductModal(product = null) {
      editingProduct = product;
      const modal = document.getElementById('product-modal');
      const title = document.getElementById('product-modal-title');
      const form = document.getElementById('product-form');

      title.textContent = product ? 'Edit Product' : 'Add New Product';
      form.reset();

      if (product) {
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('product-category').value = product.category || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-dimensions').value = product.dimensions || '';
        document.getElementById('product-image-url').value = product.image_url || '';
        document.getElementById('product-status').value = product.status || 'draft';
        document.getElementById('product-material').value = product.material_type || '';
        document.getElementById('product-color').value = product.color || '';
        document.getElementById('product-stock').value = product.stock_quantity || 1;
      }

      modal.classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('active');
      editingProduct = null;
    }

    async function editProduct(id) {
      const product = allProducts.find(p => p.id === id);
      if (product) {
        openProductModal(product);
      }
    }

    async function saveProduct(e) {
      e.preventDefault();
      const btn = document.getElementById('product-save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const productData = {
        name: document.getElementById('product-name').value,
        description: document.getElementById('product-description').value,
        category: document.getElementById('product-category').value,
        price: parseFloat(document.getElementById('product-price').value) || 0,
        dimensions: document.getElementById('product-dimensions').value,
        image_url: document.getElementById('product-image-url').value,
        status: document.getElementById('product-status').value,
        material_type: document.getElementById('product-material').value,
        color: document.getElementById('product-color').value,
        stock_quantity: parseInt(document.getElementById('product-stock').value) || 1,
        updated_at: new Date().toISOString()
      };

      try {
        if (editingProduct) {
          // Update existing
          const { error } = await supabaseClient
            .from('products')
            .update(productData)
            .eq('id', editingProduct.id);
          if (error) throw error;
        } else {
          // Create new
          productData.vendor_id = currentUser.id;
          productData.vendor_email = currentUser.email;
          productData.created_at = new Date().toISOString();

          const { error } = await supabaseClient
            .from('products')
            .insert([productData]);
          if (error) throw error;
        }

        closeProductModal();
        loadProducts();
        alert(editingProduct ? 'Product updated!' : 'Product added!');
      } catch (err) {
        alert('Error saving product: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Product';
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const { error } = await supabaseClient
          .from('products')
          .delete()
          .eq('id', id);
        if (error) throw error;

        allProducts = allProducts.filter(p => p.id !== id);
        renderProducts();
        alert('Product deleted.');
      } catch (err) {
        alert('Error deleting product: ' + err.message);
      }
    }

    // Load products when showing products page
    const originalShowPage = showPage;
    showPage = function(page) {
      originalShowPage(page);
      if (page === 'products' && (isAdmin || userProfile?.account_type?.startsWith('pro_'))) {
        loadProducts();
      }
    };

    // Product modal click-outside to close
    document.getElementById('product-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeProductModal();
    });

    // ============ INVOICE MANAGEMENT ============
    const API_URL = 'https://surprise-granite-email-api.onrender.com';

    let allInvoices = [];
    let invoiceFilter = 'all';
    let invoiceItemCount = 1;

    async function loadInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      try {
        // Show loading state
        invoicesList.innerHTML = '<div class="empty-state"><p>Loading invoices...</p></div>';

        // Fetch from both Stripe API and Supabase in parallel
        const { data: { user } } = await supabaseClient.auth.getUser();

        const [stripeResponse, supabaseResult] = await Promise.all([
          fetch(`${API_URL}/api/invoices?limit=50`).catch(() => null),
          supabaseClient.from('invoices').select('*, invoice_items(*)').eq('user_id', user?.id).order('created_at', { ascending: false })
        ]);

        let stripeInvoices = [];
        if (stripeResponse && stripeResponse.ok) {
          const stripeData = await stripeResponse.json();
          stripeInvoices = (stripeData.invoices || []).map(inv => ({
            ...inv,
            source: 'stripe',
            amount_due: inv.amount_due || 0,
            amount_paid: inv.amount_paid || 0
          }));
        }

        // Transform Supabase invoices to match format
        const supabaseInvoices = (supabaseResult.data || []).map(inv => ({
          id: inv.id,
          number: inv.invoice_number,
          invoice_number: inv.invoice_number,
          customer_email: inv.customer_email,
          customer_name: inv.customer_name,
          // Normalize status: Supabase uses 'unpaid', Stripe uses 'open'
          status: inv.status === 'unpaid' ? 'open' : inv.status,
          total: inv.total || 0,
          amount_due: inv.amount_due || inv.total || 0,
          amount_paid: inv.amount_paid || 0,
          due_date: inv.due_date,
          created: new Date(inv.created_at).getTime() / 1000,
          created_at: inv.created_at,
          source: 'supabase',
          estimate_id: inv.estimate_id,
          invoice_items: inv.invoice_items
        }));

        // Combine and sort by date (newest first)
        allInvoices = [...stripeInvoices, ...supabaseInvoices].sort((a, b) => {
          const dateA = a.created || new Date(a.created_at).getTime() / 1000;
          const dateB = b.created || new Date(b.created_at).getTime() / 1000;
          return dateB - dateA;
        });

        renderInvoices();
      } catch (err) {
        console.error('Error loading invoices:', err);
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>Unable to Load Invoices</h3>
            <p>Please try again or create a new invoice.</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
      }
    }

    // Sync paid invoices and customers from Stripe to local database
    async function syncFromStripe() {
      const btn = document.getElementById('sync-stripe-btn');
      const originalHtml = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;"></span> Syncing...';

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Fetch paid invoices from Stripe
        console.log('[Sync] Fetching paid invoices from Stripe...');
        const response = await fetch(`${API_URL}/api/invoices?status=paid&limit=100`);
        if (!response.ok) throw new Error('Failed to fetch Stripe invoices');

        const { invoices: stripeInvoices } = await response.json();
        console.log('[Sync] Found', stripeInvoices?.length || 0, 'paid invoices');

        if (!stripeInvoices || stripeInvoices.length === 0) {
          showToast('No paid invoices found in Stripe', 'info');
          return;
        }

        let customersCreated = 0;
        let invoicesSynced = 0;
        let jobsCreated = 0;
        let errors = [];

        for (const inv of stripeInvoices) {
          if (!inv.customer_email) {
            console.log('[Sync] Skipping invoice without email:', inv.id);
            continue;
          }

          console.log('[Sync] Processing:', inv.customer_name, inv.customer_email);

          // Step 1: Check/create customer (always do this)
          let customerId = null;
          try {
            const { data: existingCustomer } = await supabaseClient
              .from('customers')
              .select('id')
              .eq('user_id', user.id)
              .eq('email', inv.customer_email)
              .single();

            if (existingCustomer) {
              customerId = existingCustomer.id;
              console.log('[Sync] Found existing customer:', customerId);
            } else {
              const { data: newCustomer, error: custErr } = await supabaseClient
                .from('customers')
                .insert({
                  user_id: user.id,
                  name: inv.customer_name || 'Customer',
                  email: inv.customer_email,
                  phone: inv.customer_phone || null,
                  source: 'stripe_sync'
                })
                .select()
                .single();

              if (!custErr && newCustomer) {
                customerId = newCustomer.id;
                customersCreated++;
                console.log('[Sync] Created customer:', customerId);
              } else if (custErr) {
                console.error('[Sync] Customer error:', custErr.message);
                errors.push(`Customer ${inv.customer_email}: ${custErr.message}`);
              }
            }
          } catch (e) {
            console.error('[Sync] Customer exception:', e);
          }

          // Step 2: Try to create invoice (may fail if columns don't exist - that's OK)
          let invoiceId = null;
          try {
            // Check if invoice exists by number
            const { data: existingInvoice } = await supabaseClient
              .from('invoices')
              .select('id')
              .eq('invoice_number', inv.number)
              .single();

            if (existingInvoice) {
              invoiceId = existingInvoice.id;
              console.log('[Sync] Invoice already exists:', invoiceId);
            } else {
              // Try with all columns first
              const invoiceData = {
                user_id: user.id,
                invoice_number: inv.number || `STR-${inv.id.slice(-8)}`,
                customer_id: customerId,
                customer_name: inv.customer_name || 'Customer',
                customer_email: inv.customer_email,
                total: inv.amount_paid || 0,
                status: 'paid',
                paid_at: new Date().toISOString()
              };

              // Add optional stripe columns (may not exist)
              try {
                invoiceData.amount_paid = inv.amount_paid || 0;
                invoiceData.amount_due = 0;
                invoiceData.stripe_invoice_id = inv.id;
                invoiceData.stripe_hosted_url = inv.hosted_invoice_url;
                invoiceData.stripe_pdf_url = inv.pdf;
              } catch (e) {}

              const { data: newInvoice, error: invErr } = await supabaseClient
                .from('invoices')
                .insert(invoiceData)
                .select()
                .single();

              if (!invErr && newInvoice) {
                invoiceId = newInvoice.id;
                invoicesSynced++;
                console.log('[Sync] Created invoice:', invoiceId);
              } else if (invErr) {
                console.error('[Sync] Invoice error:', invErr.message);
                // Try minimal insert without stripe columns
                const { data: minInvoice, error: minErr } = await supabaseClient
                  .from('invoices')
                  .insert({
                    user_id: user.id,
                    invoice_number: inv.number || `STR-${inv.id.slice(-8)}`,
                    customer_id: customerId,
                    customer_name: inv.customer_name || 'Customer',
                    customer_email: inv.customer_email,
                    total: inv.amount_paid || 0,
                    status: 'paid'
                  })
                  .select()
                  .single();

                if (!minErr && minInvoice) {
                  invoiceId = minInvoice.id;
                  invoicesSynced++;
                  console.log('[Sync] Created invoice (minimal):', invoiceId);
                }
              }
            }
          } catch (e) {
            console.error('[Sync] Invoice exception:', e);
          }

          // Step 3: Create job (even if invoice failed, as long as we have customer)
          if (customerId) {
            try {
              // Check if job exists for this customer email
              const { data: existingJob } = await supabaseClient
                .from('jobs')
                .select('id')
                .eq('user_id', user.id)
                .eq('customer_email', inv.customer_email)
                .single();

              if (!existingJob) {
                const jobNum = `JOB-${Date.now().toString(36).toUpperCase()}`;
                const jobData = {
                  user_id: user.id,
                  job_number: jobNum,
                  customer_id: customerId,
                  customer_name: inv.customer_name || 'Customer',
                  customer_email: inv.customer_email,
                  contract_amount: inv.amount_paid || 0,
                  total_paid: inv.amount_paid || 0,
                  deposit_paid: true,
                  status: 'new'
                };

                if (invoiceId) jobData.invoice_id = invoiceId;

                const { error: jobErr } = await supabaseClient
                  .from('jobs')
                  .insert(jobData);

                if (!jobErr) {
                  jobsCreated++;
                  console.log('[Sync] Created job:', jobNum);
                } else {
                  console.error('[Sync] Job error:', jobErr.message);
                }
              } else {
                console.log('[Sync] Job already exists for customer');
              }
            } catch (e) {
              console.error('[Sync] Job exception:', e);
            }
          }
        }

        showToast(`Synced: ${customersCreated} customers, ${invoicesSynced} invoices, ${jobsCreated} jobs`);

        // Reload data
        await Promise.all([loadInvoices(), loadCustomers(), loadJobs()]);

      } catch (err) {
        console.error('Sync error:', err);
        showToast('Sync failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    function filterInvoices(status) {
      invoiceFilter = status;
      document.querySelectorAll('[data-invoice-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.invoiceStatus === status);
      });
      renderInvoices();
    }

    async function voidInvoice(invoiceId) {
      if (!confirm('Void this invoice? The customer will no longer be able to pay it.')) return;

      try {
        const response = await fetch(`${API_URL}/api/invoices/${invoiceId}/void`, {
          method: 'POST'
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Failed to void invoice');
        }

        loadInvoices();
        showToast('Invoice voided');
      } catch (err) {
        console.error('Void invoice error:', err);
        alert('Error voiding invoice: ' + err.message);
      }
    }

    function renderInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      let filtered = allInvoices;
      // Filter by status
      if (invoiceFilter !== 'all') {
        if (invoiceFilter === 'viewed') {
          // Filter for invoices that have been viewed
          filtered = filtered.filter(inv => inv.view_count > 0);
        } else {
          filtered = filtered.filter(inv => inv.status === invoiceFilter);
        }
      }

      if (filtered.length === 0) {
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>No invoices found</h3>
            <p>${invoiceFilter !== 'all' ? 'No invoices with this status.' : 'Create your first invoice to get started.'}</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
        return;
      }

      // Modern card-based list for invoices
      invoicesList.innerHTML = `
        <div class="list-modern">
          ${filtered.map(inv => {
            const statusColor = inv.status === 'paid' ? '#22c55e' : inv.status === 'open' ? '#3b82f6' : inv.status === 'void' ? '#ef4444' : inv.status === 'draft' ? '#6b7280' : '#f59e0b';
            const viewedInfo = inv.view_count > 0 ? `Viewed ${inv.view_count}x` : '';
            return `
            <div class="list-item-modern"
                 onclick="viewSupabaseInvoice('${inv.id}')"
                 data-context-menu="invoice"
                 data-item-id="${inv.id}"
                 data-item-data='${JSON.stringify({ invoice_number: inv.number, status: inv.status, hosted_invoice_url: inv.hosted_invoice_url, pdf_url: inv.pdf, customer_name: inv.customer_name }).replace(/'/g, "&#39;")}'>
              <div class="list-item-icon" style="background: ${statusColor}20; color: ${statusColor};">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">#${inv.number || inv.id.slice(-8)}</div>
                <div class="list-item-subtitle">${inv.customer_name || 'No customer'} ${inv.customer_email ? ' ' + inv.customer_email : ''}</div>
                <div class="list-item-subtitle" style="margin-top: 2px;">
                  Due: ${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'Not set'}
                  ${viewedInfo ? `<span style="color: #22c55e; margin-left: 8px;">${viewedInfo}</span>` : ''}
                </div>
              </div>
              <div class="list-item-meta">
                <div style="font-weight: 700; font-size: 15px; color: var(--gold-primary); margin-bottom: 4px;">$${(inv.amount_due || 0).toFixed(2)}</div>
                <span class="badge-modern" style="background: ${statusColor}20; color: ${statusColor};">${inv.status}</span>
              </div>
            </div>
          `;}).join('')}
        </div>
      `;
    }

    function openInvoiceModal() {
      document.getElementById('invoice-modal').classList.add('active');
      document.getElementById('invoice-form').reset();
      document.getElementById('invoice-items').innerHTML = `
        <div class="invoice-item" data-index="0">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      invoiceItemCount = 1;
      updateInvoiceTotal();
    }

    function closeInvoiceModal() {
      document.getElementById('invoice-modal').classList.remove('active');
    }

    // Template Preview Modal Functions
    const templatePreviews = {
      classic: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #f4f4f4;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <tr>
            <td style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; text-align: center;">
              <h1 style="color: #f9cb00; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 1px;">Surprise Granite</h1>
              <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0; font-size: 14px;">Premium Countertops & Expert Installation</p>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 40px 20px; border-bottom: 2px solid #f9cb00;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h2 style="margin: 0; color: #1a1a2e; font-size: 32px; font-weight: 300;">INVOICE</h2>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px;"><strong>Date:</strong> Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #1a1a2e; font-size: 14px;"><strong>Due:</strong> Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Bill To</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 16px; font-weight: 600;">John Smith</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">From</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px; font-weight: 600;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 13px;">14155 W. Bell Road, Suite 100</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 30px;">
              <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: collapse;">
                <tr style="background-color: #1a1a2e;">
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Description</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: center;">Qty</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: right;">Amount</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Kitchen Countertop - Granite</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$2,500.00</td>
                </tr>
                <tr style="background-color: #ffffff;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Installation Labor</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$800.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" style="background-color: #1a1a2e; padding: 20px; border-radius: 8px;">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700;">TOTAL</td>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700; text-align: right;">$3,300.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px; text-align: center;">
              <a href="#" style="display: inline-block; background: linear-gradient(135deg, #f9cb00 0%, #e6b800 100%); color: #1a1a2e; text-decoration: none; padding: 18px 50px; border-radius: 50px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(249, 203, 0, 0.4);">Pay Now</a>
            </td>
          </tr>
          <tr>
            <td style="background-color: #f9f9f9; padding: 30px 40px; text-align: center; border-top: 1px solid #eee;">
              <p style="margin: 0 0 10px; color: #666; font-size: 14px;">Questions? Contact us at <a href="#" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a></p>
              <p style="margin: 0; color: #999; font-size: 12px;">Surprise Granite Marble & Quartz</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      modern: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="center" style="padding: 60px 20px;">
        <table role="presentation" width="550" cellspacing="0" cellpadding="0">
          <tr>
            <td style="padding-bottom: 40px; border-bottom: 1px solid #eee;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h1 style="margin: 0; color: #000; font-size: 24px; font-weight: 800; letter-spacing: -0.5px;">SURPRISE<span style="color: #f9cb00;">GRANITE</span></h1>
                    <p style="margin: 4px 0 0; color: #888; font-size: 12px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #000; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;">Invoice</p>
                    <p style="margin: 4px 0 0; color: #f9cb00; font-size: 20px; font-weight: 700;">#INV-2024-001</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Billed To</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 18px; font-weight: 600;">John Smith</p>
                    <p style="margin: 4px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" align="right">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Invoice Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">January 7, 2025</p>
                    <p style="margin: 20px 0 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Due Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">February 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Kitchen Countertop - Granite</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$2,500.00</p>
                  </td>
                </tr>
              </table>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Installation Labor</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$800.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" align="right">
                    <p style="margin: 0; padding: 15px 0; color: #000; font-size: 20px; font-weight: 700;">Total</p>
                    <p style="margin: 0; color: #000; font-size: 24px; font-weight: 700;">$3,300.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 20px 0 50px; text-align: center;">
              <a href="#" style="display: inline-block; background-color: #000; color: #fff; text-decoration: none; padding: 16px 60px; font-size: 14px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;">Pay Invoice </a>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0; border-top: 1px solid #eee; text-align: center;">
              <p style="margin: 0; color: #888; font-size: 13px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;"><a href="#" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a>  <a href="#" style="color: #f9cb00; text-decoration: none;">(602) 833-3189</a></p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      premium: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #0a0a12; font-family: 'Georgia', 'Times New Roman', serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #0a0a12;">
    <tr>
      <td align="center" style="padding: 50px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0">
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 12px; letter-spacing: 4px; text-transform: uppercase;">Premium Quality</p>
              <h1 style="margin: 15px 0 0; color: #ffffff; font-size: 36px; font-weight: 400; letter-spacing: 3px;">SURPRISE GRANITE</h1>
              <p style="margin: 10px 0 0; color: #888; font-size: 14px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 3px; text-transform: uppercase;">Invoice Number</p>
                    <p style="margin: 8px 0 0; color: #ffffff; font-size: 24px; font-weight: 300;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #888; font-size: 13px;">Issue Date: Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">Due: Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Bill To</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 20px; font-weight: 400;">John Smith</p>
                    <p style="margin: 8px 0 0; color: #888; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">From</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 14px;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">(602) 833-3189</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="padding: 20px 50px; border-bottom: 1px solid rgba(249, 203, 0, 0.2);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Description</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: center;" width="80">Qty</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: right;" width="120">Amount</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Kitchen Countertop - Granite</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$2,500.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Installation Labor</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$800.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background: linear-gradient(135deg, #f9cb00 0%, #d4a800 100%); padding: 30px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="color: #1a1a2e; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">Total Amount</td>
                  <td align="right" style="color: #1a1a2e; font-size: 32px; font-weight: 700;">$3,300.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <a href="#" style="display: inline-block; border: 2px solid #f9cb00; color: #f9cb00; text-decoration: none; padding: 18px 60px; font-size: 13px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase;">PAY INVOICE</a>
              <p style="margin: 30px 0 0; color: #666; font-size: 13px;">Secure payment powered by Stripe</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #0a0a12; padding: 40px 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 2px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 15px 0 0; color: #666; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 10px 0 0; color: #666; font-size: 12px;">info@surprisegranite.com  (602) 833-3189</p>
              <p style="margin: 20px 0 0; color: #444; font-size: 11px;">Thank you for choosing Surprise Granite for your project.</p>
            </td>
          </tr>
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`
    };

    function openTemplatePreview() {
      document.getElementById('template-preview-modal').classList.add('active');
      // Load the classic template by default
      showTemplatePreview('classic');
    }

    function closeTemplatePreview() {
      document.getElementById('template-preview-modal').classList.remove('active');
    }

    function showTemplatePreview(templateName) {
      // Update active tab
      document.querySelectorAll('.template-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.template === templateName) {
          tab.classList.add('active');
        }
      });

      // Show corresponding preview frame
      document.querySelectorAll('.template-preview-frame').forEach(frame => {
        frame.style.display = 'none';
      });
      const activeFrame = document.getElementById('template-frame-' + templateName);
      if (activeFrame) {
        activeFrame.style.display = 'block';
        // Load the template content into the iframe
        const iframe = document.getElementById('preview-iframe-' + templateName);
        if (iframe && templatePreviews[templateName]) {
          iframe.srcdoc = templatePreviews[templateName];
        }
      }
    }

    // Close template preview modal on click outside
    document.getElementById('template-preview-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeTemplatePreview();
    });

    function addInvoiceItem() {
      const container = document.getElementById('invoice-items');
      const itemHTML = `
        <div class="invoice-item" data-index="${invoiceItemCount}">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Installation Labor"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', itemHTML);
      invoiceItemCount++;
    }

    function removeInvoiceItem(btn) {
      const items = document.querySelectorAll('.invoice-item');
      if (items.length > 1) {
        btn.closest('.invoice-item').remove();
        updateInvoiceTotal();
      }
    }

    function updateInvoiceTotal() {
      const items = document.querySelectorAll('.invoice-item');
      let total = 0;
      items.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
        const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
        total += qty * amount;
      });
      document.getElementById('invoice-total').textContent = `$${total.toFixed(2)}`;
    }

    async function createInvoice(e) {
      e.preventDefault();
      const btn = document.getElementById('invoice-send-btn');
      btn.disabled = true;
      btn.textContent = 'Creating...';

      const items = [];
      document.querySelectorAll('.invoice-item').forEach(item => {
        items.push({
          description: item.querySelector('.item-description').value,
          quantity: parseInt(item.querySelector('.item-qty').value) || 1,
          amount: parseFloat(item.querySelector('.item-amount').value) || 0
        });
      });

      // Get selected template
      const selectedTemplate = document.querySelector('input[name="invoice-template"]:checked')?.value || 'classic';

      const invoiceData = {
        customer_email: document.getElementById('invoice-email').value,
        customer_name: document.getElementById('invoice-name').value,
        customer_phone: document.getElementById('invoice-phone').value,
        items,
        due_days: parseInt(document.getElementById('invoice-due-days').value),
        notes: document.getElementById('invoice-notes').value,
        auto_send: true,
        template: selectedTemplate
      };

      try {
        const response = await fetch(`${API_URL}/api/invoices`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create invoice');
        }

        closeInvoiceModal();
        loadInvoices();
        alert(`Invoice #${data.invoice.number} created and sent to ${invoiceData.customer_email}!`);
      } catch (err) {
        alert('Error creating invoice: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create & Send Invoice';
      }
    }

    async function sendReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        const response = await fetch(`${API_URL}/api/invoices/${invoiceId}/remind`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to send reminder');
        }

        alert('Payment reminder sent!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Invoice modal click-outside to close
    document.getElementById('invoice-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeInvoiceModal();
    });

    // ============ SUPABASE INVOICE FUNCTIONS ============
    async function viewSupabaseInvoice(invoiceId) {
      try {
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*, invoice_items(*)')
          .eq('id', invoiceId)
          .single();

        if (!invoice) {
          alert('Invoice not found');
          return;
        }

        // Create a simple invoice view modal or open in new tab
        const invoiceHtml = `
          <html>
          <head><title>Invoice #${invoice.invoice_number}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
            .header { border-bottom: 3px solid #f9cb00; padding-bottom: 20px; margin-bottom: 30px; }
            .header h1 { color: #1a1a2e; margin: 0; }
            .header p { color: #666; margin: 5px 0 0; }
            .info-row { display: flex; justify-content: space-between; margin-bottom: 30px; }
            .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { background: #f8f9fa; font-weight: 600; }
            .total-row { font-size: 18px; font-weight: bold; color: #f9cb00; }
            .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
            .status-open { background: #fef3c7; color: #d97706; }
            .status-paid { background: #d1fae5; color: #059669; }
            @media print { body { padding: 20px; } }
          </style>
          </head>
          <body>
            <div class="header">
              <h1>Surprise Granite</h1>
              <p>Marble & Quartz</p>
            </div>
            <h2>Invoice #${invoice.invoice_number}</h2>
            <div class="info-row">
              <div class="info-box">
                <strong>Bill To:</strong><br>
                ${invoice.customer_name || 'N/A'}<br>
                ${invoice.customer_email || ''}<br>
                ${invoice.customer_phone || ''}
              </div>
              <div class="info-box">
                <strong>Status:</strong> <span class="status status-${invoice.status}">${invoice.status}</span><br>
                <strong>Due Date:</strong> ${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A'}<br>
                <strong>Created:</strong> ${new Date(invoice.created_at).toLocaleDateString()}
              </div>
            </div>
            <table>
              <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
              <tbody>
                ${(invoice.invoice_items || []).map(item => `
                  <tr>
                    <td>${item.description || item.name || 'Item'}</td>
                    <td>${item.quantity || 1}</td>
                    <td>$${(item.unit_price || 0).toFixed(2)}</td>
                    <td>$${(item.total || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <table style="width: 300px; margin-left: auto;">
              <tr><td>Subtotal:</td><td style="text-align: right;">$${(invoice.subtotal || invoice.total || 0).toFixed(2)}</td></tr>
              ${invoice.tax_amount ? `<tr><td>Tax:</td><td style="text-align: right;">$${invoice.tax_amount.toFixed(2)}</td></tr>` : ''}
              <tr class="total-row"><td>Total:</td><td style="text-align: right;">$${(invoice.total || 0).toFixed(2)}</td></tr>
              <tr><td>Amount Paid:</td><td style="text-align: right;">$${(invoice.amount_paid || 0).toFixed(2)}</td></tr>
              <tr style="font-weight: bold;"><td>Amount Due:</td><td style="text-align: right;">$${(invoice.amount_due || invoice.total || 0).toFixed(2)}</td></tr>
            </table>
            ${invoice.notes ? `<div style="margin-top: 30px; padding: 15px; background: #fffbeb; border-radius: 8px;"><strong>Notes:</strong><br>${invoice.notes}</div>` : ''}
            <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px;">
              <p>Surprise Granite | (602) 833-3189 | info@surprisegranite.com</p>
            </div>
          </body>
          </html>
        `;

        const win = window.open('', '_blank');
        win.document.write(invoiceHtml);
        win.document.close();
      } catch (err) {
        console.error('View invoice error:', err);
        alert('Error viewing invoice');
      }
    }

    async function sendSupabaseInvoice(invoiceId) {
      if (!confirm('Send this invoice to the customer?')) return;

      try {
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*, invoice_items(*)')
          .eq('id', invoiceId)
          .single();

        if (!invoice || !invoice.customer_email) {
          alert('Invoice not found or missing customer email');
          return;
        }

        // Send via email API
        const response = await fetch(`${API_URL}/api/send-invoice-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            customer_email: invoice.customer_email,
            customer_name: invoice.customer_name,
            invoice_number: invoice.invoice_number,
            items: invoice.invoice_items,
            subtotal: invoice.subtotal,
            tax_amount: invoice.tax_amount,
            total: invoice.total,
            due_date: invoice.due_date,
            notes: invoice.notes
          })
        });

        if (response.ok) {
          showToast('Invoice sent!');
          // Update status
          await supabaseClient.from('invoices').update({ status: 'sent' }).eq('id', invoiceId);
          loadInvoices();

          // Send SMS notification (email already sent by API)
          sendNotification('invoice', 'sent', invoice, {
            email: null, // Already sent by email API
            phone: invoice.customer_phone,
            name: invoice.customer_name
          });
        } else {
          // Fallback to email client
          const subject = encodeURIComponent(`Invoice #${invoice.invoice_number} from Surprise Granite`);
          const body = encodeURIComponent(`Hi ${invoice.customer_name},\n\nPlease find your invoice #${invoice.invoice_number} for $${invoice.total.toFixed(2)}.\n\nDue date: ${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'Upon receipt'}\n\nThank you,\nSurprise Granite`);
          window.open(`mailto:${invoice.customer_email}?subject=${subject}&body=${body}`);
          showToast('Email client opened');
        }
      } catch (err) {
        console.error('Send invoice error:', err);
        alert('Error sending invoice');
      }
    }

    async function deleteSupabaseInvoice(invoiceId) {
      if (!confirm('Delete this invoice? This cannot be undone.')) return;

      try {
        // Delete invoice items first
        await supabaseClient.from('invoice_items').delete().eq('invoice_id', invoiceId);
        // Delete invoice
        await supabaseClient.from('invoices').delete().eq('id', invoiceId);

        showToast('Invoice deleted');
        loadInvoices();
      } catch (err) {
        console.error('Delete invoice error:', err);
        alert('Error deleting invoice');
      }
    }

    async function markInvoicePaid(invoiceId) {
      if (!confirm('Mark this invoice as paid?')) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get invoice details
        const { data: invoice, error: fetchError } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        if (fetchError) throw fetchError;

        // Update invoice status
        const { error: updateError } = await supabaseClient
          .from('invoices')
          .update({
            status: 'paid',
            amount_paid: invoice.total,
            amount_due: 0,
            paid_at: new Date().toISOString()
          })
          .eq('id', invoiceId);

        if (updateError) throw updateError;

        // Record payment in payments table
        await supabaseClient.from('payments').insert({
          user_id: user.id,
          invoice_id: invoiceId,
          customer_id: invoice.customer_id,
          amount: invoice.total,
          payment_method: 'manual',
          status: 'completed',
          notes: 'Manually marked as paid'
        });

        // Update customer totals if customer_id exists
        if (invoice.customer_id) {
          const { data: customer } = await supabaseClient
            .from('customers')
            .select('total_spent, total_jobs')
            .eq('id', invoice.customer_id)
            .single();

          if (customer) {
            await supabaseClient
              .from('customers')
              .update({
                total_spent: (customer.total_spent || 0) + invoice.total,
                total_jobs: (customer.total_jobs || 0) + 1
              })
              .eq('id', invoice.customer_id);
          }
        }

        // Generate job number
        const { data: jobNumber } = await supabaseClient.rpc('get_next_job_number', { p_user_id: user.id });

        // Create job from paid invoice with full traceability
        const { data: newJob } = await supabaseClient.from('jobs').insert({
          user_id: user.id,
          customer_id: invoice.customer_id,
          invoice_id: invoiceId,
          estimate_id: invoice.estimate_id,
          lead_id: invoice.lead_id,  // Preserve lead reference for traceability
          job_number: jobNumber || `JOB-${Date.now()}`,
          customer_name: invoice.customer_name,
          customer_email: invoice.customer_email,
          customer_phone: invoice.customer_phone,
          customer_address: invoice.customer_address,
          project_description: invoice.project_name || 'Project from Invoice #' + invoice.invoice_number,
          contract_amount: invoice.total,
          status: 'approved'
        }).select().single();

        // Send payment confirmation notification (email + SMS)
        sendNotification('invoice', 'paid', {
          ...invoice,
          amount: invoice.total
        }, {
          email: invoice.customer_email,
          phone: invoice.customer_phone,
          name: invoice.customer_name
        });

        showToast('Invoice marked as paid! Job created.');
        loadInvoices();
        loadJobs();
      } catch (err) {
        console.error('Mark paid error:', err);
        alert('Error marking invoice as paid: ' + err.message);
      }
    }

    // Update showPage to load invoices and wallet
    const _originalShowPage = showPage;
    showPage = function(page) {
      _originalShowPage(page);
      if (page === 'invoices' && isAdmin) {
        loadInvoices();
      }
      if (page === 'wallet' && isAdmin) {
        loadWalletData();
      }
      if (page === 'calendar') {
        initCalendar();
      }
      if (page === 'jobs') {
        loadJobs();
      }
      if (page === 'contractors') {
        loadContractors();
      }
    };

    // ============ WALLET MANAGEMENT ============
    let totalRevenue = 0;

    async function loadWalletData() {
      await Promise.all([
        loadBalance(),
        loadTransactions(),
        loadPayouts()
      ]);
    }

    async function loadBalance() {
      try {
        const response = await fetch(`${API_URL}/api/balance`);
        if (!response.ok) throw new Error('Failed to load balance');

        const data = await response.json();

        document.getElementById('available-balance').textContent = `$${data.total_available.toFixed(2)}`;
        document.getElementById('pending-balance').textContent = `$${data.total_pending.toFixed(2)}`;

      } catch (err) {
        console.error('Balance error:', err);
        document.getElementById('available-balance').textContent = '$--.--';
        document.getElementById('pending-balance').textContent = '$--.--';
      }
    }

    async function loadTransactions() {
      const container = document.getElementById('transactions-list');
      if (!container) return;

      try {
        const response = await fetch(`${API_URL}/api/balance-transactions?limit=15`);
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();

        if (data.transactions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No transactions yet</p>
            </div>
          `;
          return;
        }

        // Calculate total revenue from charges
        totalRevenue = data.transactions
          .filter(t => t.type === 'charge' && t.amount > 0)
          .reduce((sum, t) => sum + t.amount, 0);

        document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;

        container.innerHTML = data.transactions.map(t => {
          const isPositive = t.amount > 0 && t.type !== 'payout' && t.type !== 'stripe_fee';
          const iconClass = t.type === 'payout' ? 'payout' : (t.type === 'stripe_fee' ? 'fee' : 'income');
          const icon = t.type === 'payout'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>'
            : t.type === 'stripe_fee'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>';

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon ${iconClass}">${icon}</div>
                <div class="transaction-details">
                  <h4>${t.description || t.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                  <p>${t.type} ${t.fee > 0 ? ` Fee: $${t.fee.toFixed(2)}` : ''}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                <div class="date">${new Date(t.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Transactions error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load transactions</p>
          </div>
        `;
      }
    }

    async function loadPayouts() {
      const container = document.getElementById('payouts-list');
      if (!container) return;

      try {
        const response = await fetch(`${API_URL}/api/payouts?limit=10`);
        if (!response.ok) throw new Error('Failed to load payouts');

        const data = await response.json();

        if (data.payouts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No payouts yet. Funds are automatically transferred to your bank account.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = data.payouts.map(p => {
          const statusColor = p.status === 'paid' ? 'var(--success)' : (p.status === 'pending' ? 'var(--warning)' : 'var(--text-muted)');

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon payout">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <div class="transaction-details">
                  <h4>Bank Transfer</h4>
                  <p style="color: ${statusColor};">${p.status.charAt(0).toUpperCase() + p.status.slice(1)}  Arrives ${new Date(p.arrival_date).toLocaleDateString()}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount">$${p.amount.toFixed(2)}</div>
                <div class="date">${new Date(p.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Payouts error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load payouts</p>
          </div>
        `;
      }
    }

    // ============================================
    // STONE LISTINGS - Remnants Marketplace
    // ============================================

    let countertopsData = [];
    const MAX_FREE_LISTINGS = 3;

    // Load countertops data for autocomplete
    async function loadCountertopsData() {
      try {
        const response = await fetch('/data/countertops.json');
        countertopsData = await response.json();
      } catch (err) {
        console.error('Failed to load countertops data:', err);
      }
    }

    // Initialize listings functionality
    loadCountertopsData();

    // Stone autocomplete
    const stoneSearchInput = document.getElementById('listing-stone-search');
    const autocompleteResults = document.getElementById('stone-autocomplete-results');

    if (stoneSearchInput) {
      stoneSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 2) {
          autocompleteResults.classList.remove('active');
          return;
        }

        const matches = countertopsData
          .filter(stone =>
            stone.name.toLowerCase().includes(query) ||
            (stone.brand && stone.brand.toLowerCase().includes(query)) ||
            (stone.color && stone.color.toLowerCase().includes(query))
          )
          .slice(0, 8);

        if (matches.length === 0) {
          autocompleteResults.innerHTML = '<div style="padding: 12px; color: var(--text-muted);">No matching stones found</div>';
        } else {
          autocompleteResults.innerHTML = matches.map(stone => `
            <div class="stone-result-item" onclick="selectStone(${JSON.stringify(stone).replace(/"/g, '&quot;')})">
              <img src="${stone.image || '/images/placeholder.svg'}" alt="" class="stone-result-thumb">
              <div class="stone-result-info">
                <div class="stone-result-name">${stone.name}</div>
                <div class="stone-result-meta">${stone.brand || ''}  ${stone.type || ''}  ${stone.color || ''}</div>
              </div>
            </div>
          `).join('');
        }
        autocompleteResults.classList.add('active');
      });

      // Close autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.stone-autocomplete')) {
          autocompleteResults.classList.remove('active');
        }
      });
    }

    function selectStone(stone) {
      document.getElementById('listing-stone-slug').value = stone.slug || '';
      document.getElementById('listing-stone-name').value = stone.name || '';
      document.getElementById('listing-material-type').value = stone.type || '';
      document.getElementById('listing-brand').value = stone.brand || '';
      document.getElementById('listing-color').value = stone.color || '';
      document.getElementById('listing-stone-search').value = stone.name;

      // Update preview
      document.getElementById('selected-stone-preview').style.display = 'block';
      document.getElementById('selected-stone-img').src = stone.image || '/images/placeholder.svg';
      document.getElementById('selected-stone-name').textContent = stone.name;
      document.getElementById('selected-stone-meta').textContent = `${stone.brand || ''}  ${stone.type || ''}  ${stone.color || ''}`;

      // Auto-fill title if empty
      const titleInput = document.getElementById('listing-title');
      if (!titleInput.value) {
        titleInput.value = `${stone.name} Remnant`;
      }

      autocompleteResults.classList.remove('active');
    }

    function clearSelectedStone() {
      document.getElementById('listing-stone-slug').value = '';
      document.getElementById('listing-stone-name').value = '';
      document.getElementById('listing-material-type').value = '';
      document.getElementById('listing-brand').value = '';
      document.getElementById('listing-color').value = '';
      document.getElementById('listing-stone-search').value = '';
      document.getElementById('selected-stone-preview').style.display = 'none';
    }

    function togglePriceField() {
      const priceInput = document.getElementById('listing-price');
      const contactCheckbox = document.getElementById('listing-price-contact');
      priceInput.disabled = contactCheckbox.checked;
      if (contactCheckbox.checked) {
        priceInput.value = '';
        priceInput.placeholder = 'Contact for price';
      } else {
        priceInput.placeholder = '0.00';
      }
    }

    // Image Upload Functions
    function triggerImageUpload(slotNum) {
      const fileInput = document.getElementById(`image-file-${slotNum}`);
      fileInput.click();
    }

    async function handleImageUpload(slotNum, input) {
      const file = input.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB');
        return;
      }

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const progress = document.getElementById(`upload-progress-${slotNum}`);
      const progressBar = document.getElementById(`upload-bar-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);

      // Show progress
      progress.style.display = 'block';
      progressBar.style.width = '10%';

      try {
        // Get current user
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          alert('Please log in to upload images');
          return;
        }

        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

        progressBar.style.width = '30%';

        // Compress image if needed
        const compressedFile = await compressImage(file, 1200, 0.8);

        progressBar.style.width = '50%';

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('listing-images')
          .upload(fileName, compressedFile, {
            cacheControl: '3600',
            upsert: false
          });

        progressBar.style.width = '80%';

        if (error) {
          // Fallback: use data URL for preview and let user know to use URL input
          console.warn('Storage upload failed, using local preview:', error);
          const dataUrl = await readFileAsDataUrl(file);
          preview.src = dataUrl;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
          removeBtn.style.display = 'flex';
          slot.classList.add('has-image');
          // Store data URL temporarily (won't persist to DB, but shows preview)
          hiddenInput.value = dataUrl;
          progressBar.style.width = '100%';
          setTimeout(() => { progress.style.display = 'none'; }, 500);
          return;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('listing-images')
          .getPublicUrl(fileName);

        progressBar.style.width = '100%';

        // Update UI
        preview.src = urlData.publicUrl;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        removeBtn.style.display = 'flex';
        slot.classList.add('has-image');
        hiddenInput.value = urlData.publicUrl;

        setTimeout(() => { progress.style.display = 'none'; }, 500);

      } catch (err) {
        console.error('Upload error:', err);
        alert('Failed to upload image. Please try again or paste an image URL.');
        progress.style.display = 'none';
      }
    }

    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressImage(file, maxWidth, quality) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function removeImage(event, slotNum) {
      event.stopPropagation();

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);
      const fileInput = document.getElementById(`image-file-${slotNum}`);

      // Reset UI
      preview.src = '';
      preview.style.display = 'none';
      placeholder.style.display = 'flex';
      removeBtn.style.display = 'none';
      slot.classList.remove('has-image');
      hiddenInput.value = '';
      fileInput.value = '';
    }

    function updateImagePreviews() {
      const previewGrid = document.getElementById('image-preview-grid');
      const images = [
        document.getElementById('listing-image-1').value,
        document.getElementById('listing-image-2').value,
        document.getElementById('listing-image-3').value,
        document.getElementById('listing-image-4').value
      ].filter(url => url);

      previewGrid.innerHTML = images.map((url, i) => `
        <div class="image-preview-item">
          <img src="${url}" alt="Preview ${i + 1}" onerror="this.src='/images/placeholder.svg'">
        </div>
      `).join('');
    }

    // Modal functions
    async function openCreateListingModal() {
      // Check listing limit first
      const canCreate = await checkListingLimit();
      if (!canCreate.allowed) {
        alert(`You've reached your limit of ${canCreate.max} free listings. Upgrade to Pro for unlimited listings!`);
        return;
      }

      document.getElementById('create-listing-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCreateListingModal() {
      document.getElementById('create-listing-modal').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('create-listing-form').reset();
      clearSelectedStone();
      // Reset category to default
      selectListingCategory('countertops');
    }

    function selectListingCategory(category) {
      // Update hidden input
      document.getElementById('listing-category').value = category;

      // Update visual selection
      document.querySelectorAll('.listing-category-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.category === category);
      });

      // Update product selection section based on category
      const productSection = document.getElementById('product-selection-section');
      const titleEl = document.getElementById('product-selection-title');
      const labelEl = document.getElementById('product-search-label');
      const searchInput = document.getElementById('listing-stone-search');

      // Category-specific labels
      const categoryConfig = {
        countertops: {
          title: 'Select Stone',
          label: 'Search countertops catalog (optional)',
          placeholder: 'Start typing stone name...',
          showCatalog: true
        },
        tile: {
          title: 'Select Tile',
          label: 'Search tile catalog (optional)',
          placeholder: 'Start typing tile name...',
          showCatalog: true
        },
        flooring: {
          title: 'Select Flooring',
          label: 'Search flooring catalog (optional)',
          placeholder: 'Start typing flooring name...',
          showCatalog: true
        },
        cabinets: {
          title: 'Cabinet Details',
          label: 'Describe your cabinets',
          placeholder: 'e.g., Shaker White 36" Base Cabinet',
          showCatalog: false
        },
        supplies: {
          title: 'Product Details',
          label: 'Describe your product',
          placeholder: 'e.g., Mapei Kerabond Thinset 50lb',
          showCatalog: false
        },
        other: {
          title: 'Product Details',
          label: 'Describe your item',
          placeholder: 'e.g., Delta Faucet, Cabinet Hardware',
          showCatalog: false
        }
      };

      const config = categoryConfig[category] || categoryConfig.other;
      titleEl.textContent = config.title;
      labelEl.textContent = config.label;
      searchInput.placeholder = config.placeholder;

      // Show/hide autocomplete for categories without catalog
      const autocompleteResults = document.getElementById('stone-autocomplete-results');
      if (!config.showCatalog) {
        autocompleteResults.style.display = 'none';
      }

      // Clear previous selection when switching categories
      clearSelectedStone();
    }

    async function checkListingLimit() {
      const user = await supabaseClient.auth.getUser();
      if (!user.data.user) return { allowed: false, remaining: 0 };

      // Check if super admin by email
      const userEmail = (user.data.user.email || '').toLowerCase();
      if (SUPER_ADMIN_EMAILS.includes(userEmail)) {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Check if pro account
      const { data: profile } = await supabaseClient
        .from('sg_users')
        .select('account_type')
        .eq('id', user.data.user.id)
        .single();

      const accountType = profile?.account_type || 'homeowner';
      if (accountType.startsWith('pro_') || accountType === 'admin' || accountType === 'super_admin') {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Count active listings
      const { count } = await supabaseClient
        .from('stone_listings')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.data.user.id)
        .eq('status', 'active');

      return {
        allowed: (count || 0) < MAX_FREE_LISTINGS,
        remaining: MAX_FREE_LISTINGS - (count || 0),
        current: count || 0,
        max: MAX_FREE_LISTINGS,
        isPro: false
      };
    }

    async function handleCreateListing(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submit-listing-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Creating...';

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          throw new Error('Please sign in to create a listing');
        }

        // Get category and determine product name
        const category = document.getElementById('listing-category').value;
        const catalogStoneName = document.getElementById('listing-stone-name').value;
        const userBrandInput = document.getElementById('listing-brand-input').value;

        const listingData = {
          user_id: user.data.user.id,
          category: category,
          condition: document.getElementById('listing-condition').value || 'new',
          stone_name: catalogStoneName || document.getElementById('listing-title').value,
          stone_slug: document.getElementById('listing-stone-slug').value || null,
          material_type: document.getElementById('listing-material-type').value || category,
          brand: document.getElementById('listing-brand').value || userBrandInput || null,
          color: document.getElementById('listing-color').value || null,
          title: document.getElementById('listing-title').value,
          description: document.getElementById('listing-description').value || null,
          dimensions: document.getElementById('listing-dimensions').value || null,
          thickness: document.getElementById('listing-thickness').value || null,
          quantity: parseInt(document.getElementById('listing-quantity').value) || 1,
          price: document.getElementById('listing-price-contact').checked ? null : (parseFloat(document.getElementById('listing-price').value) || null),
          image_url: document.getElementById('listing-image-1').value || null,
          image_url_2: document.getElementById('listing-image-2').value || null,
          image_url_3: document.getElementById('listing-image-3').value || null,
          image_url_4: document.getElementById('listing-image-4').value || null,
          city: document.getElementById('listing-city').value || null,
          state: document.getElementById('listing-state').value || null,
          zip_code: document.getElementById('listing-zip').value || null,
          show_email: document.getElementById('listing-show-email').checked,
          show_phone: document.getElementById('listing-show-phone').checked,
          contact_form_only: document.getElementById('listing-contact-form').checked,
          status: 'active'
        };

        const { data, error } = await supabaseClient
          .from('stone_listings')
          .insert([listingData])
          .select()
          .single();

        if (error) throw error;

        closeCreateListingModal();
        await loadMyListings();
        alert('Listing created successfully!');

      } catch (err) {
        console.error('Create listing error:', err);
        alert('Failed to create listing: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        `;
      }
    }

    async function loadMyListings() {
      const loadingEl = document.getElementById('listings-loading');
      const emptyEl = document.getElementById('listings-empty');
      const gridEl = document.getElementById('listings-grid');
      const limitIndicator = document.getElementById('listing-limit-indicator');

      loadingEl.style.display = 'block';
      emptyEl.style.display = 'none';
      gridEl.style.display = 'none';

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          loadingEl.innerHTML = '<p style="color: var(--text-muted);">Please sign in to view your listings</p>';
          return;
        }

        // Update listing count and limit indicator
        const limitInfo = await checkListingLimit();
        if (limitInfo.isPro) {
          limitIndicator.textContent = 'Unlimited listings (Pro)';
          limitIndicator.style.color = 'var(--gold-primary)';
        } else {
          limitIndicator.textContent = `${limitInfo.current}/${limitInfo.max} listings used`;
          limitIndicator.style.color = limitInfo.remaining === 0 ? 'var(--error)' : 'var(--text-muted)';
        }

        // Update nav badge
        const listingsCountEl = document.getElementById('listings-count');
        if (listingsCountEl) {
          const count = limitInfo.current || 0;
          listingsCountEl.textContent = count;
          listingsCountEl.setAttribute('data-count', count);
          listingsCountEl.style.display = count > 0 ? '' : 'none';
        }

        const { data: listings, error } = await supabaseClient
          .from('stone_listings')
          .select('*')
          .eq('user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        loadingEl.style.display = 'none';

        if (!listings || listings.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }

        gridEl.style.display = 'grid';
        gridEl.innerHTML = listings.map(listing => {
          const category = listing.category || 'countertops';
          const categoryLabels = { countertops: 'Countertops', tile: 'Tile', flooring: 'Flooring', cabinets: 'Cabinets', supplies: 'Supplies', other: 'Other' };
          const conditionLabels = { new: 'New', remnant: 'Remnant', overstock: 'Overstock', used: 'Used', refurbished: 'Refurb' };
          return `
          <div class="listing-card">
            <div class="listing-image">
              ${listing.image_url ? `<img src="${listing.image_url}" alt="${listing.title}">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>'}
              <span class="listing-category-badge ${category}">${categoryLabels[category] || category}</span>
              <span class="listing-status-badge ${listing.status}">${listing.status}</span>
            </div>
            <div class="listing-content">
              <div class="listing-title">${listing.title}</div>
              <div class="listing-stone">${listing.stone_name || listing.brand || ''}</div>
              <div class="listing-meta">
                ${listing.condition ? `<span class="listing-meta-item">${conditionLabels[listing.condition] || listing.condition}</span>` : ''}
                ${listing.dimensions ? `<span class="listing-meta-item">${listing.dimensions}</span>` : ''}
                ${listing.thickness ? `<span class="listing-meta-item">${listing.thickness}</span>` : ''}
              </div>
              <div class="listing-price ${listing.price === null ? 'contact' : ''}">
                ${listing.price !== null ? '$' + listing.price.toFixed(2) : 'Contact for price'}
              </div>
              <div class="listing-stats">
                <span>${listing.views || 0} views</span>
                <span>${listing.inquiries || 0} inquiries</span>
              </div>
              <div class="listing-actions">
                <button class="btn-edit" onclick="editListing('${listing.id}')">Edit</button>
                ${listing.status === 'active' ?
                  `<button class="btn-edit" onclick="markListingSold('${listing.id}')">Mark Sold</button>` :
                  `<button class="btn-edit" onclick="reactivateListing('${listing.id}')">Reactivate</button>`
                }
                <button class="btn-delete" onclick="deleteListing('${listing.id}')">Delete</button>
              </div>
            </div>
          </div>
        `}).join('');

        // Also load inquiries
        await loadMyInquiries();

      } catch (err) {
        console.error('Load listings error:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
      }
    }

    async function loadMyInquiries() {
      const loadingEl = document.getElementById('inquiries-loading');
      const emptyEl = document.getElementById('inquiries-empty');
      const listEl = document.getElementById('inquiries-list');
      const badgeEl = document.getElementById('inquiries-badge');

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) return;

        // Get all inquiries for user's listings
        const { data: inquiries, error } = await supabaseClient
          .from('listing_inquiries')
          .select(`
            *,
            stone_listings!inner(title, user_id)
          `)
          .eq('stone_listings.user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        loadingEl.style.display = 'none';

        if (error || !inquiries || inquiries.length === 0) {
          emptyEl.style.display = 'block';
          return;
        }

        const unreadCount = inquiries.filter(i => !i.read).length;
        if (unreadCount > 0) {
          badgeEl.textContent = unreadCount;
          badgeEl.style.display = 'flex';
        } else {
          badgeEl.style.display = 'none';
        }

        listEl.style.display = 'block';
        listEl.innerHTML = inquiries.map(inquiry => `
          <div class="inquiry-item ${inquiry.read ? '' : 'unread'}" onclick="markInquiryRead('${inquiry.id}')">
            <div class="inquiry-header">
              <div>
                <div class="inquiry-listing">Re: ${inquiry.stone_listings.title}</div>
                <div class="inquiry-sender">${inquiry.sender_name}</div>
                <div class="inquiry-contact">
                  ${inquiry.sender_email}
                  ${inquiry.sender_phone ? `  ${inquiry.sender_phone}` : ''}
                </div>
              </div>
              <div class="inquiry-date">${new Date(inquiry.created_at).toLocaleDateString()}</div>
            </div>
            <div class="inquiry-message">${inquiry.message}</div>
            <div class="inquiry-actions" onclick="event.stopPropagation()">
              <a href="mailto:${inquiry.sender_email}?subject=Re: ${encodeURIComponent(inquiry.stone_listings.title)}" class="btn btn-email">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Reply via Email
              </a>
              <button class="btn btn-payment" onclick="openPaymentModal('${inquiry.id}', '${inquiry.sender_name.replace(/'/g, "\\'")}', '${inquiry.sender_email}', '${inquiry.stone_listings.title.replace(/'/g, "\\'")}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Send Payment Link
              </button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Load inquiries error:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
      }
    }

    async function markInquiryRead(id) {
      try {
        await supabaseClient
          .from('listing_inquiries')
          .update({ read: true })
          .eq('id', id);
        await loadMyInquiries();
      } catch (err) {
        console.error('Mark read error:', err);
      }
    }

    // Payment Request Modal Functions
    function openPaymentModal(inquiryId, customerName, customerEmail, listingTitle) {
      document.getElementById('payment-inquiry-id').value = inquiryId;
      document.getElementById('payment-customer-email').value = customerEmail;
      document.getElementById('payment-customer-name').value = customerName;
      document.getElementById('payment-recipient-name').textContent = customerName;
      document.getElementById('payment-recipient-email').textContent = customerEmail;
      document.getElementById('payment-description').value = listingTitle;
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-request-modal').style.display = 'flex';
    }

    function closePaymentModal() {
      document.getElementById('payment-request-modal').style.display = 'none';
    }

    async function sendPaymentRequest(event) {
      event.preventDefault();

      const sendBtn = document.getElementById('send-payment-btn');
      const originalText = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Creating...';

      try {
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const description = document.getElementById('payment-description').value;
        const customerEmail = document.getElementById('payment-customer-email').value;
        const customerName = document.getElementById('payment-customer-name').value;
        const note = document.getElementById('payment-note').value;

        // Create payment link via API
        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/payment-links', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: amount,
            description: description,
            customer_email: customerEmail
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create payment link');
        }

        // Send email with payment link
        const emailResponse = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: customerName,
            email: customerEmail,
            subject: `Payment Request for ${description}`,
            message: `
              <p>Hello ${customerName},</p>
              ${note ? `<p>${note}</p>` : '<p>Thank you for your interest in our stone remnant!</p>'}
              <p><strong>Amount Due:</strong> $${amount.toFixed(2)}</p>
              <p><strong>Description:</strong> ${description}</p>
              <p style="margin: 24px 0;">
                <a href="${result.payment_link.url}" style="display: inline-block; background: #f9cb00; color: #1a1a2e; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600;">Pay Now</a>
              </p>
              <p style="font-size: 13px; color: #666;">Or copy this link: ${result.payment_link.url}</p>
            `,
            source: 'marketplace-payment-request'
          })
        });

        closePaymentModal();
        showToast('Payment link sent to ' + customerEmail);

      } catch (err) {
        console.error('Payment request error:', err);
        alert('Failed to send payment request: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }

      return false;
    }

    function showToast(message) {
      const existing = document.querySelector('.toast-notification');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.style.cssText = `
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(16, 185, 129, 0.95);
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        z-index: 100000;
        animation: toastSlideUp 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    async function deleteListing(id) {
      if (!confirm('Are you sure you want to delete this listing?')) return;

      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .delete()
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Delete listing error:', err);
        alert('Failed to delete listing');
      }
    }

    async function markListingSold(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({ status: 'sold' })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Mark sold error:', err);
        alert('Failed to update listing');
      }
    }

    async function reactivateListing(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({
            status: 'active',
            expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString()
          })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Reactivate error:', err);
        alert('Failed to reactivate listing');
      }
    }

    function editListing(id) {
      // TODO: Implement edit listing modal
      alert('Edit functionality coming soon!');
    }

    // =============================================
    // ESTIMATES FEATURE
    // =============================================

    let serviceCatalog = [];
    let businessSettings = null;

    async function loadEstimates() {
      const listContainer = document.getElementById('estimates-list');
      if (!listContainer) return;

      listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="loading-spinner"></div><p>Loading estimates...</p></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><p>Please log in to view estimates</p></div>';
          return;
        }

        let query = supabaseClient
          .from('estimates')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        // Filter by status
        if (currentEstimateFilter === 'archived') {
          query = query.not('archived_at', 'is', null);
        } else {
          // By default, hide archived estimates
          query = query.is('archived_at', null);
          if (currentEstimateFilter !== 'all') {
            query = query.eq('status', currentEstimateFilter);
          }
        }

        const { data: estimates, error } = await query;

        if (error) throw error;

        // Update global estimates array with full data
        const { data: allEstimatesData } = await supabaseClient
          .from('estimates')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (allEstimatesData) {
          allEstimates = allEstimatesData; // Update global array
          const stats = {
            draft: allEstimates.filter(e => e.status === 'draft').length,
            sent: allEstimates.filter(e => e.status === 'sent').length,
            approved: allEstimates.filter(e => e.status === 'approved').length,
            rejected: allEstimates.filter(e => e.status === 'rejected').length
          };
          document.getElementById('stat-draft-estimates').textContent = stats.draft;
          document.getElementById('stat-sent-estimates').textContent = stats.sent;
          document.getElementById('stat-approved-estimates').textContent = stats.approved;
          document.getElementById('stat-rejected-estimates').textContent = stats.rejected;
          document.getElementById('estimates-count').textContent = allEstimates.length;
          document.getElementById('estimates-count').dataset.count = allEstimates.length;
        }

        if (!estimates || estimates.length === 0) {
          listContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 16px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <h3 style="margin-bottom: 8px;">No estimates yet</h3>
              <p style="color: var(--text-muted); margin-bottom: 16px;">Create your first estimate to send to customers</p>
              <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Create First Estimate
              </button>
            </div>`;
          return;
        }

        listContainer.innerHTML = estimates.map(estimate => `
          <div class="estimate-card" style="background: var(--dark-elevated); border-radius: 12px; padding: 20px; margin-bottom: 12px; border: 1px solid var(--border-subtle);"
               data-context-menu="estimate"
               data-item-id="${estimate.id}"
               data-item-data='${JSON.stringify({ estimate_number: estimate.estimate_number, status: estimate.status, customer_name: estimate.customer_name }).replace(/'/g, "&#39;")}'>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                  <span style="font-size: 18px; font-weight: 600;">${estimate.estimate_number || 'Draft'}</span>
                  <span class="status-badge status-${estimate.status}" style="padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                    ${estimate.status}
                  </span>
                </div>
                <div style="color: var(--text-secondary);">${estimate.customer_name}</div>
                ${estimate.project_name ? `<div style="color: var(--text-muted); font-size: 13px;">${estimate.project_name}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="font-size: 20px; font-weight: 700; color: var(--gold-primary);">$${(estimate.total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${new Date(estimate.created_at).toLocaleDateString()}</div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn-modern secondary small" onclick="viewEstimate('${estimate.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                View
              </button>
              ${estimate.status === 'draft' ? `
                <button class="btn-modern primary small" onclick="sendEstimate('${estimate.id}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                  Send
                </button>
              ` : ''}
              ${estimate.status === 'approved' ? `
                <button class="btn-modern success small" onclick="convertToInvoice('${estimate.id}')" style="background: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Convert to Invoice
                </button>
              ` : ''}
              <button class="btn-modern secondary small" onclick="duplicateEstimate('${estimate.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Duplicate
              </button>
              ${estimate.archived_at ? `
                <button class="btn-modern secondary small" onclick="unarchiveEstimate('${estimate.id}')" title="Restore">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  Restore
                </button>
                <button class="btn-modern small" onclick="deleteEstimatePermanent('${estimate.id}')" style="color: #ef4444;" title="Delete Permanently">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              ` : `
                <button class="btn-modern small" onclick="archiveEstimate('${estimate.id}')" style="color: #6b7280;" title="Archive">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                </button>
              `}
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Load estimates error:', err);
        listContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--error);">Error loading estimates: ${err.message}</div>`;
      }
    }

    function filterEstimates(status) {
      currentEstimateFilter = status;

      // Update active filter button
      document.querySelectorAll('[data-estimate-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.estimateStatus === status);
      });

      loadEstimates();
    }

    async function openCreateEstimateModal(preserveState = false) {
      const modal = document.getElementById('create-estimate-modal');
      modal.classList.add('active');
      document.getElementById('create-estimate-form').reset();

      // Reset state unless preserveState is true (called from startEstimateFromLead/Customer)
      if (!preserveState) {
        estimateModalState = {
          customerId: null,
          leadId: null,
          editingEstimateId: null
        };
      }

      // Reset line items container with empty message
      const container = document.getElementById('estimate-line-items');
      container.innerHTML = `<div id="empty-line-items-msg" style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        <br>No items added yet. Click "Add Item" or "From Catalog" to begin.
      </div>`;

      // Set current date display
      const today = new Date();
      document.getElementById('estimate-date-display').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

      // Set default valid until date (30 days from now)
      updateEstimateValidDate();

      // Get next estimate number
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          const { data } = await supabaseClient.rpc('get_next_estimate_number', { p_user_id: user.id });
          document.getElementById('estimate-number-display').textContent = data || '0001';
        }
      } catch (err) {
        document.getElementById('estimate-number-display').textContent = '0001';
      }

      // Load business settings defaults
      loadBusinessDefaults();

      // Reset category subtotals
      document.getElementById('subtotal-material').textContent = '$0.00';
      document.getElementById('subtotal-labor').textContent = '$0.00';
      document.getElementById('subtotal-service').textContent = '$0.00';

      // Reset totals
      calculateEstimateTotals();
    }

    function updateEstimateValidDate() {
      const days = parseInt(document.getElementById('estimate-valid-days').value) || 30;
      const validUntil = new Date();
      validUntil.setDate(validUntil.getDate() + days);
      document.getElementById('estimate-valid-until').value = validUntil.toISOString().split('T')[0];
    }

    function toggleAddItemMenu() {
      const menu = document.getElementById('add-item-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';

      // Close when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!e.target.closest('.dropdown')) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 10);
    }

    function updatePaymentSchedule() {
      const type = document.getElementById('payment-schedule-type').value;
      const container = document.getElementById('payment-schedule-container');
      const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;

      if (type === 'deposit-balance') {
        const depositPercent = parseFloat(document.getElementById('estimate-deposit-percent').value) || 50;
        container.innerHTML = `
          <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="padding: 16px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 14px;">1. Deposit Required</span>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="estimate-deposit-percent" value="${depositPercent}" min="0" max="100" style="width: 50px; text-align: center; padding: 4px; font-size: 13px;" onchange="updateEstimateTotals()">
                  <span style="font-size: 13px;">%</span>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
              <div id="estimate-deposit-amount" style="font-size: 22px; font-weight: 700; color: var(--gold-primary);">$${(total * depositPercent / 100).toFixed(2)}</div>
            </div>
            <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 14px;">2. Balance Due</span>
                <span id="balance-percent" style="font-size: 13px; color: var(--text-muted);">${100 - depositPercent}%</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon completion</div>
              <div id="estimate-balance-amount" style="font-size: 22px; font-weight: 700;">$${(total * (100 - depositPercent) / 100).toFixed(2)}</div>
            </div>
          </div>`;
      } else if (type === 'three-part') {
        container.innerHTML = `
          <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <div style="padding: 14px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">1. Deposit (33%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gold-primary);">$${(total * 0.33).toFixed(2)}</div>
            </div>
            <div style="padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">2. Progress (33%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">At project midpoint</div>
              <div style="font-size: 18px; font-weight: 700;">$${(total * 0.33).toFixed(2)}</div>
            </div>
            <div style="padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">3. Final (34%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Upon completion</div>
              <div style="font-size: 18px; font-weight: 700;">$${(total * 0.34).toFixed(2)}</div>
            </div>
          </div>`;
      } else if (type === 'due-on-completion') {
        container.innerHTML = `
          <div class="payment-schedule-items">
            <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px; text-align: center;">
              <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px;">Full Amount Due Upon Completion</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">No deposit required</div>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${total.toFixed(2)}</div>
            </div>
          </div>`;
      } else {
        container.innerHTML = `
          <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Define your custom payment milestones in the notes section above.</p>
            <div style="font-weight: 600;">Total: <span style="color: var(--gold-primary);">$${total.toFixed(2)}</span></div>
          </div>`;
      }
    }

    function loadTermsTemplate() {
      const defaultTerms = `1. ACCEPTANCE: This estimate is valid for the period specified above. Acceptance of this estimate constitutes agreement to all terms and conditions.

2. PAYMENT: Payment terms as outlined in the payment schedule above. We accept cash, check, and major credit cards. A 3% processing fee applies to credit card payments.

3. CHANGES: Any changes to the scope of work after acceptance may result in additional charges and timeline adjustments.

4. WARRANTY: Workmanship is warranted as specified above. Manufacturer warranties apply to all materials as per their terms.

5. ACCESS: Customer agrees to provide reasonable access to the work area during normal business hours.

6. COMPLETION: Estimated timelines are approximate and may vary based on material availability and unforeseen conditions.`;

      document.getElementById('estimate-terms').value = defaultTerms;

      if (businessSettings && businessSettings.default_warranty_terms) {
        document.getElementById('estimate-warranty').value = businessSettings.default_warranty_terms;
      } else {
        document.getElementById('estimate-warranty').value = '1 year workmanship warranty';
      }
    }

    function previewEstimate() {
      // Collect all form data and generate a preview
      const customerName = document.getElementById('estimate-customer-name').value.trim() || 'Customer Name';
      const projectName = document.getElementById('estimate-project-name').value.trim() || 'Project';
      const estimateNumber = document.getElementById('estimate-number-display').textContent;
      const estimateDate = document.getElementById('estimate-date-display').textContent;

      // Get business settings for branding
      const companyName = businessSettings?.company_name || 'Your Company Name';
      const companyPhone = businessSettings?.phone || '';
      const companyEmail = businessSettings?.email || '';
      const companyWebsite = businessSettings?.website || '';
      const companyLogo = businessSettings?.logo_url || '';
      const companyAddress = [
        businessSettings?.address,
        [businessSettings?.city, businessSettings?.state, businessSettings?.zip].filter(Boolean).join(', ')
      ].filter(Boolean).join(', ');
      const companyContact = [companyPhone, companyEmail].filter(Boolean).join(' | ');

      // Collect line items
      const lineItems = [];
      document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
        const name = item.querySelector('.item-name').value.trim();
        if (name) {
          lineItems.push({
            name: name,
            description: item.querySelector('.item-desc').value.trim(),
            unit: item.querySelector('.item-unit').value,
            quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
            unit_price: parseFloat(item.querySelector('.item-price').value) || 0,
            category: item.querySelector('.item-category').value || 'other'
          });
        }
      });

      // Get totals
      const subtotal = document.getElementById('estimate-subtotal').textContent;
      const taxAmount = document.getElementById('estimate-tax-amount').textContent;
      const discountAmount = document.getElementById('estimate-discount-amount').textContent;
      const total = document.getElementById('estimate-total').textContent;
      const depositAmount = document.getElementById('estimate-deposit-amount').textContent;

      // Generate preview HTML
      const previewHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Estimate Preview - ${estimateNumber}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
            .estimate-preview { max-width: 800px; margin: 0 auto; background: #fff; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
            .header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); color: #fff; padding: 30px; display: flex; justify-content: space-between; align-items: center; }
            .header h1 { font-size: 28px; color: #f9cb00; }
            .header .est-number { font-size: 14px; color: #aaa; }
            .header .est-number strong { color: #f9cb00; }
            .customer-section { padding: 20px 30px; border-bottom: 1px solid #eee; }
            .customer-section h3 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 8px; }
            .customer-section p { font-size: 15px; line-height: 1.6; }
            .items-section { padding: 20px 30px; }
            .items-section h3 { font-size: 14px; margin-bottom: 15px; color: #333; }
            .items-table { width: 100%; border-collapse: collapse; }
            .items-table th { background: #f5f5f5; padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
            .items-table td { padding: 12px 10px; border-bottom: 1px solid #eee; }
            .items-table .category-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
            .totals-section { padding: 20px 30px; background: #f9f9f9; }
            .totals-row { display: flex; justify-content: space-between; padding: 8px 0; }
            .totals-row.total { font-size: 20px; font-weight: bold; border-top: 2px solid #f9cb00; padding-top: 15px; margin-top: 10px; }
            .deposit-box { background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border: 1px solid rgba(249,203,0,0.3); padding: 15px 20px; border-radius: 8px; margin-top: 15px; }
            .footer { padding: 20px 30px; background: #1a1a1a; color: #888; font-size: 12px; text-align: center; }
            .preview-banner { background: #f9cb00; color: #1a1a1a; padding: 10px; text-align: center; font-weight: bold; }
            @media print { .preview-banner { display: none; } body { padding: 0; } .estimate-preview { box-shadow: none; } }
          </style>
        </head>
        <body>
          <div class="preview-banner">PREVIEW - This is how your estimate will appear to the customer</div>
          <div class="estimate-preview">
            <div class="header">
              <div style="display: flex; align-items: center; gap: 20px;">
                ${companyLogo ? `<img src="${companyLogo}" alt="Logo" style="height: 60px; width: auto; max-width: 120px; object-fit: contain; border-radius: 8px;">` : `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f9cb00, #cca600); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: #1a1a1a;">${companyName.substring(0,2).toUpperCase()}</div>`}
                <div>
                  <div style="font-size: 22px; font-weight: 700;">${companyName}</div>
                  ${companyAddress ? `<div style="font-size: 12px; color: #aaa; margin-top: 4px;">${companyAddress}</div>` : ''}
                  ${companyContact ? `<div style="font-size: 12px; color: #aaa;">${companyContact}</div>` : ''}
                </div>
              </div>
              <div style="text-align: right;">
                <h1 style="font-size: 28px; color: #f9cb00; margin: 0;">ESTIMATE</h1>
                <div class="est-number" style="margin-top: 8px;">Estimate #: <strong>${estimateNumber}</strong></div>
                <div style="font-size: 12px; color: #888;">Date: ${estimateDate}</div>
              </div>
            </div>

            <div class="customer-section">
              <h3>Prepared For</h3>
              <p><strong>${customerName}</strong></p>
              <p>${document.getElementById('estimate-customer-address').value || ''} ${document.getElementById('estimate-customer-city').value || ''}</p>
              <p style="margin-top: 10px;"><strong>Project:</strong> ${projectName}</p>
            </div>

            <div class="items-section">
              <h3>Items & Services</h3>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Unit</th>
                    <th style="text-align:center;">Qty</th>
                    <th style="text-align:right;">Price</th>
                    <th style="text-align:right;">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${lineItems.map(item => {
                    const colors = { material: '#3b82f6', labor: '#22c55e', service: '#a855f7', other: '#6b7280' };
                    return `<tr>
                      <td><span class="category-dot" style="background:${colors[item.category] || '#6b7280'}"></span>${item.name}${item.description ? '<br><small style="color:#888">' + item.description + '</small>' : ''}</td>
                      <td>${item.unit}</td>
                      <td style="text-align:center;">${item.quantity}</td>
                      <td style="text-align:right;">$${item.unit_price.toFixed(2)}</td>
                      <td style="text-align:right;">$${(item.quantity * item.unit_price).toFixed(2)}</td>
                    </tr>`;
                  }).join('')}
                  ${lineItems.length === 0 ? '<tr><td colspan="5" style="text-align:center;color:#888;padding:20px;">No items added</td></tr>' : ''}
                </tbody>
              </table>
            </div>

            <div class="totals-section">
              <div class="totals-row"><span>Subtotal</span><span>${subtotal}</span></div>
              <div class="totals-row"><span>Tax</span><span>${taxAmount}</span></div>
              <div class="totals-row"><span>Discount</span><span>${discountAmount}</span></div>
              <div class="totals-row total"><span>TOTAL</span><span style="color:#f9cb00;">${total}</span></div>
              <div class="deposit-box">
                <div style="display:flex;justify-content:space-between;"><span><strong>Deposit Required</strong></span><span style="font-size:18px;font-weight:bold;color:#f9cb00;">${depositAmount}</span></div>
                <div style="font-size:12px;color:#666;margin-top:5px;">Due upon approval to begin project</div>
              </div>
            </div>

            <div class="footer">
              <p>Thank you for choosing <strong>${companyName}</strong>!</p>
              ${companyWebsite ? `<p style="margin-top: 5px;">${companyWebsite}</p>` : ''}
            </div>
          </div>
          <div style="text-align:center;margin-top:20px;">
            <button onclick="window.print()" style="padding:10px 20px;background:#f9cb00;border:none;border-radius:5px;cursor:pointer;font-weight:bold;">Print Preview</button>
            <button onclick="window.close()" style="padding:10px 20px;background:#333;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-left:10px;">Close</button>
          </div>
        </body>
        </html>
      `;

      // Open in new window
      const previewWindow = window.open('', '_blank', 'width=900,height=700');
      previewWindow.document.write(previewHtml);
      previewWindow.document.close();
    }

    function closeCreateEstimateModal() {
      const modal = document.getElementById('create-estimate-modal');
      modal.classList.remove('active');
      // Clear any linked customer ID
      if (modal) delete modal.dataset.customerId;
    }

    async function loadBusinessDefaults() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: settings } = await supabaseClient
          .from('business_settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (settings) {
          businessSettings = settings;
          if (settings.default_tax_rate) {
            document.getElementById('estimate-tax-rate').value = settings.default_tax_rate;
          }
          if (settings.default_deposit_percent) {
            document.getElementById('estimate-deposit-percent').value = settings.default_deposit_percent;
          }
          if (settings.default_payment_terms) {
            document.getElementById('estimate-payment-terms').value = settings.default_payment_terms;
          }
          if (settings.default_warranty_terms) {
            document.getElementById('estimate-warranty').value = settings.default_warranty_terms;
          }
        }
      } catch (err) {
        console.log('No business settings found');
      }
    }

    function addEstimateLineItem(category = 'material', itemData = null) {
      const container = document.getElementById('estimate-line-items');

      // Remove empty message if present
      const emptyMsg = document.getElementById('empty-line-items-msg');
      if (emptyMsg) emptyMsg.remove();

      // Close the add item menu
      const menu = document.getElementById('add-item-menu');
      if (menu) menu.style.display = 'none';

      const template = document.querySelector('.line-item-template .estimate-line-item').cloneNode(true);

      // Set category
      const categoryColors = {
        material: '#3b82f6',
        labor: '#22c55e',
        service: '#a855f7',
        other: '#6b7280'
      };

      template.dataset.category = category;
      template.querySelector('.item-category').value = category;
      template.querySelector('.category-dot').style.background = categoryColors[category] || '#6b7280';
      template.querySelector('.category-dot').title = category.charAt(0).toUpperCase() + category.slice(1);

      // Set default unit based on category
      const unitSelect = template.querySelector('.item-unit');
      if (category === 'labor') {
        unitSelect.value = 'hour';
      } else if (category === 'service') {
        unitSelect.value = 'job';
      } else if (category === 'material') {
        unitSelect.value = 'sqft';
      }

      // Set values if item data provided
      if (itemData) {
        template.querySelector('.item-name').value = itemData.name || '';
        template.querySelector('.item-desc').value = itemData.description || '';
        template.querySelector('.item-unit').value = itemData.unit || unitSelect.value;
        template.querySelector('.item-qty').value = itemData.quantity || 1;
        template.querySelector('.item-price').value = itemData.price || 0;
      }

      // Add event listeners for real-time calculation
      template.querySelector('.item-qty').addEventListener('input', calculateEstimateTotals);
      template.querySelector('.item-price').addEventListener('input', calculateEstimateTotals);
      const costInput = template.querySelector('.item-cost');
      if (costInput) costInput.addEventListener('input', calculateEstimateTotals);

      container.appendChild(template);
      calculateEstimateTotals();

      // Focus the name field
      template.querySelector('.item-name').focus();
    }

    function removeEstimateLineItem(button) {
      const lineItem = button.closest('.estimate-line-item');
      lineItem.remove();
      calculateEstimateTotals();
    }

    function calculateEstimateTotals() {
      const lineItems = document.querySelectorAll('#estimate-line-items .estimate-line-item');
      let subtotal = 0;
      let totalCost = 0;
      const categoryTotals = { material: 0, labor: 0, service: 0, other: 0 };

      lineItems.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        const costInput = item.querySelector('.item-cost');
        const cost = costInput ? (parseFloat(costInput.value) || 0) : 0;
        const total = qty * price;
        const totalItemCost = qty * cost;
        const category = item.querySelector('.item-category').value || 'other';

        item.querySelector('.item-total').textContent = '$' + total.toFixed(2);
        subtotal += total;
        totalCost += totalItemCost;
        categoryTotals[category] = (categoryTotals[category] || 0) + total;

        // Calculate and display margin for this line item
        const marginEl = item.querySelector('.item-margin');
        if (marginEl) {
          if (cost > 0 && price > 0) {
            const marginPercent = ((price - cost) / cost) * 100;
            marginEl.textContent = marginPercent.toFixed(1) + '%';
            // Color code the margin
            if (marginPercent < 0) {
              marginEl.style.color = '#ef4444'; // Red for negative
            } else if (marginPercent < 20) {
              marginEl.style.color = '#f59e0b'; // Orange for low
            } else {
              marginEl.style.color = '#22c55e'; // Green for good
            }
          } else {
            marginEl.textContent = '--%';
            marginEl.style.color = 'var(--text-muted)';
          }
        }
      });

      // Update category subtotals
      const subtotalMaterial = document.getElementById('subtotal-material');
      const subtotalLabor = document.getElementById('subtotal-labor');
      const subtotalService = document.getElementById('subtotal-service');

      if (subtotalMaterial) subtotalMaterial.textContent = '$' + categoryTotals.material.toFixed(2);
      if (subtotalLabor) subtotalLabor.textContent = '$' + categoryTotals.labor.toFixed(2);
      if (subtotalService) subtotalService.textContent = '$' + (categoryTotals.service + categoryTotals.other).toFixed(2);

      document.getElementById('estimate-subtotal').textContent = '$' + subtotal.toFixed(2);

      // Calculate tax
      const taxRate = parseFloat(document.getElementById('estimate-tax-rate').value) || 0;
      const taxAmount = subtotal * (taxRate / 100);
      document.getElementById('estimate-tax-amount').textContent = '$' + taxAmount.toFixed(2);

      // Calculate discount
      const discountValue = parseFloat(document.getElementById('estimate-discount-value').value) || 0;
      const discountType = document.getElementById('estimate-discount-type').value;
      let discountAmount = 0;
      if (discountType === 'percent') {
        discountAmount = subtotal * (discountValue / 100);
      } else {
        discountAmount = discountValue;
      }
      document.getElementById('estimate-discount-amount').textContent = '-$' + discountAmount.toFixed(2);

      // Calculate total
      const total = subtotal + taxAmount - discountAmount;
      document.getElementById('estimate-total').textContent = '$' + total.toFixed(2);

      // Calculate deposit and balance
      const depositPercentEl = document.getElementById('estimate-deposit-percent');
      const depositPercent = depositPercentEl ? (parseFloat(depositPercentEl.value) || 0) : 50;
      const depositAmount = total * (depositPercent / 100);
      const balanceAmount = total - depositAmount;

      const depositAmountEl = document.getElementById('estimate-deposit-amount');
      const balanceAmountEl = document.getElementById('estimate-balance-amount');
      const balancePercentEl = document.getElementById('balance-percent');

      if (depositAmountEl) depositAmountEl.textContent = '$' + depositAmount.toFixed(2);
      if (balanceAmountEl) balanceAmountEl.textContent = '$' + balanceAmount.toFixed(2);
      if (balancePercentEl) balancePercentEl.textContent = (100 - depositPercent) + '%';

      // Update margin summary (internal only)
      const totalCostEl = document.getElementById('estimate-total-cost');
      const totalProfitEl = document.getElementById('estimate-total-profit');
      const totalMarginEl = document.getElementById('estimate-total-margin');

      if (totalCostEl) totalCostEl.textContent = '$' + totalCost.toFixed(2);

      const profit = subtotal - totalCost;
      if (totalProfitEl) {
        totalProfitEl.textContent = '$' + profit.toFixed(2);
        totalProfitEl.style.color = profit >= 0 ? '#22c55e' : '#ef4444';
      }

      if (totalMarginEl) {
        if (totalCost > 0) {
          const overallMargin = ((subtotal - totalCost) / totalCost) * 100;
          totalMarginEl.textContent = overallMargin.toFixed(1) + '%';
          if (overallMargin < 0) {
            totalMarginEl.style.color = '#ef4444';
          } else if (overallMargin < 20) {
            totalMarginEl.style.color = '#f59e0b';
          } else {
            totalMarginEl.style.color = '#22c55e';
          }
        } else {
          totalMarginEl.textContent = '--%';
          totalMarginEl.style.color = 'var(--text-muted)';
        }
      }
    }

    // Alias for compatibility
    function updateEstimateTotals() {
      calculateEstimateTotals();
    }

    // Add event listeners for tax, discount, deposit changes
    document.addEventListener('DOMContentLoaded', function() {
      ['estimate-tax-rate', 'estimate-discount-value', 'estimate-discount-type', 'estimate-deposit-percent'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', calculateEstimateTotals);
      });
    });

    // Helper: timeout wrapper for promises
    function withTimeout(promise, ms, errorMsg) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(errorMsg || 'Operation timed out')), ms))
      ]);
    }

    async function handleCreateEstimate(event) {
      event.preventDefault();
      console.log('[Estimate] Starting creation...');

      // Check supabaseClient
      if (!supabaseClient) {
        console.error('[Estimate] Supabase client not initialized');
        alert('Error: Database connection not ready. Please refresh the page.');
        return;
      }

      // Button is in modal footer, not inside form, so find it by form attribute
      const submitBtn = document.querySelector('button[form="create-estimate-form"][type="submit"]');
      if (!submitBtn) {
        console.error('[Estimate] Submit button not found');
        alert('Error: Submit button not found');
        return;
      }
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px;"></div> Creating...';
      submitBtn.disabled = true;

      try {
        console.log('[Estimate] Getting user...');
        const { data: { user }, error: userError } = await withTimeout(
          supabaseClient.auth.getUser(),
          10000,
          'Getting user timed out'
        );
        if (userError) {
          console.error('[Estimate] User error:', userError);
          throw userError;
        }
        if (!user) throw new Error('Please log in');

        // Collect line items with category
        const lineItems = [];
        document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
          const name = item.querySelector('.item-name').value.trim();
          if (name) {
            lineItems.push({
              name: name,
              description: item.querySelector('.item-desc').value.trim(),
              unit: item.querySelector('.item-unit').value,
              quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
              unit_price: parseFloat(item.querySelector('.item-price').value) || 0,
              category: item.querySelector('.item-category').value || 'other'
            });
          }
        });

        if (lineItems.length === 0) {
          throw new Error('Please add at least one line item');
        }
        console.log('[Estimate] Line items:', lineItems.length);

        // Generate estimate number
        const timestamp = Date.now().toString().slice(-6);
        const estimateNumber = `EST-${timestamp}`;
        console.log('[Estimate] Generated number:', estimateNumber);

        // Get totals
        const subtotal = parseFloat(document.getElementById('estimate-subtotal').textContent.replace('$', '').replace(',', '')) || 0;
        const taxRate = parseFloat(document.getElementById('estimate-tax-rate').value) || 0;
        const taxAmount = parseFloat(document.getElementById('estimate-tax-amount').textContent.replace('$', '').replace(',', '')) || 0;
        const discountValue = parseFloat(document.getElementById('estimate-discount-value').value) || 0;
        const discountType = document.getElementById('estimate-discount-type').value;
        const discountAmount = parseFloat(document.getElementById('estimate-discount-amount').textContent.replace('-$', '').replace(',', '')) || 0;
        const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;
        const depositPercentEl = document.getElementById('estimate-deposit-percent');
        const depositPercent = depositPercentEl ? (parseFloat(depositPercentEl.value) || 0) : 50;
        const depositAmount = total * (depositPercent / 100);

        // Get additional fields
        const projectType = document.getElementById('estimate-project-type').value || 'custom';
        const inclusionsEl = document.getElementById('estimate-inclusions');
        const exclusionsEl = document.getElementById('estimate-exclusions');
        const termsEl = document.getElementById('estimate-terms');
        const timelineEl = document.getElementById('estimate-timeline');
        const paymentScheduleType = document.getElementById('payment-schedule-type').value || 'deposit-balance';

        // Get customer_id from unified state (not dataset attributes)
        let customerId = estimateModalState.customerId || null;
        const leadId = estimateModalState.leadId || null;

        // If no customer linked, auto-create from form data
        const customerEmail = document.getElementById('estimate-customer-email').value.trim();
        const customerName = document.getElementById('estimate-customer-name').value.trim();

        if (!customerId && customerEmail) {
          console.log('[Estimate] No customer_id, creating customer from form...');
          const formData = {
            customerName: customerName,
            customerEmail: customerEmail,
            customerPhone: document.getElementById('estimate-customer-phone').value.trim(),
            customerAddress: document.getElementById('estimate-customer-address').value.trim(),
            customerCity: document.getElementById('estimate-customer-city').value.trim(),
            customerState: document.getElementById('estimate-customer-state').value.trim()
          };
          const newCustomer = await createCustomerFromEstimateForm(formData);
          if (newCustomer) {
            customerId = newCustomer.id;
            console.log('[Estimate] Auto-created customer:', customerId);
          }
        }

        // Create estimate
        const estimateData = {
          user_id: user.id,
          estimate_number: estimateNumber,
          customer_id: customerId,
          lead_id: leadId,
          customer_name: document.getElementById('estimate-customer-name').value.trim(),
          customer_email: document.getElementById('estimate-customer-email').value.trim() || null,
          customer_phone: document.getElementById('estimate-customer-phone').value.trim() || null,
          customer_address: document.getElementById('estimate-customer-address').value.trim() || null,
          customer_city: document.getElementById('estimate-customer-city').value.trim() || null,
          customer_state: document.getElementById('estimate-customer-state').value.trim() || null,
          customer_zip: document.getElementById('estimate-customer-zip').value.trim() || null,
          project_name: document.getElementById('estimate-project-name').value.trim() || null,
          project_description: document.getElementById('estimate-project-desc').value.trim() || null,
          project_type: projectType,
          valid_until: document.getElementById('estimate-valid-until')?.value || null,
          subtotal: subtotal,
          tax_rate: taxRate,
          tax_amount: taxAmount,
          discount_type: discountType,
          discount_value: discountValue,
          discount_amount: discountAmount,
          total: total,
          deposit_percent: depositPercent,
          deposit_amount: depositAmount,
          payment_schedule_type: paymentScheduleType,
          inclusions: inclusionsEl ? inclusionsEl.value.trim() || null : null,
          exclusions: exclusionsEl ? exclusionsEl.value.trim() || null : null,
          terms_conditions: termsEl ? termsEl.value.trim() || null : null,
          estimated_timeline: timelineEl ? timelineEl.value.trim() || null : null,
          warranty_terms: document.getElementById('estimate-warranty')?.value?.trim() || null,
          notes: document.getElementById('estimate-notes')?.value?.trim() || null,
          internal_notes: document.getElementById('estimate-internal-notes')?.value?.trim() || null,
          status: 'sent'
        };

        console.log('[Estimate] Inserting estimate with data:', JSON.stringify(estimateData, null, 2));
        console.log('[Estimate] Inserting estimate into database...');
        const { data: estimate, error: estimateError } = await withTimeout(
          supabaseClient.from('estimates').insert([estimateData]).select().single(),
          15000,
          'Database insert timed out - please try again'
        );

        if (estimateError) {
          console.error('[Estimate] Insert error:', estimateError);
          console.error('[Estimate] Error details:', JSON.stringify(estimateError, null, 2));
          console.error('[Estimate] Data sent:', JSON.stringify(estimateData, null, 2));
          throw new Error(estimateError.message || estimateError.details || 'Failed to create estimate');
        }
        console.log('[Estimate] Created:', estimate.id);

        // Insert line items with category
        const itemsToInsert = lineItems.map(item => ({
          estimate_id: estimate.id,
          name: item.name,
          description: item.description,
          unit_type: item.unit,
          quantity: item.quantity,
          unit_price: item.unit_price,
          total: item.quantity * item.unit_price,
          category: item.category
        }));

        console.log('[Estimate] Inserting line items...');
        const { error: itemsError } = await withTimeout(
          supabaseClient.from('estimate_items').insert(itemsToInsert),
          15000,
          'Line items insert timed out'
        );

        if (itemsError) {
          console.error('[Estimate] Items error:', itemsError);
          throw itemsError;
        }
        console.log('[Estimate] Items inserted');

        // Generate approval token
        console.log('[Estimate] Creating token...');
        const token = crypto.randomUUID();
        try {
          const { error: tokenError } = await withTimeout(
            supabaseClient.from('estimate_tokens').insert([{
              estimate_id: estimate.id,
              token: token,
              expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]),
            10000,
            'Token creation timed out'
          );

          if (tokenError) {
            console.error('[Estimate] Token error:', tokenError);
          }
        } catch (tokenErr) {
          console.error('[Estimate] Token creation failed:', tokenErr.message);
          // Don't throw - estimate is already created
        }
        console.log('[Estimate] Token created, closing modal...');

        // Open preview with option to send
        closeCreateEstimateModal();
        loadEstimates();

        const viewLink = `${window.location.origin}/estimate/view/?token=${token}`;

        // Try to send email via API, but don't fail if it doesn't work
        // (customerEmail was already defined earlier in this function)
        if (customerEmail) {
          try {
            const emailController = new AbortController();
            const emailTimeout = setTimeout(() => emailController.abort(), 10000); // 10 sec timeout
            await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              signal: emailController.signal,
              body: JSON.stringify({
                to: customerEmail,
                customerName: estimateData.customer_name,
                estimateNumber: estimate.estimate_number,
                projectName: estimateData.project_name,
                total: estimateData.total,
                approvalUrl: viewLink
              })
            });
            clearTimeout(emailTimeout);
            showToast('Estimate created and email sent!');
          } catch (emailErr) {
            console.log('Email API unavailable:', emailErr.message);
            // Fallback: offer to copy link or open email client
            const sendManually = confirm(
              `Estimate created successfully!\n\n` +
              `The email server is temporarily unavailable (starting up). Would you like to:\n\n` +
              ` Click OK to open your email client with the estimate link\n` +
              ` Click Cancel to just copy the link\n\n` +
              `(The email will be sent automatically on future attempts)`
            );

            if (sendManually) {
              const subject = encodeURIComponent(`Your Estimate from ${businessSettings?.company_name || 'Surprise Granite'}`);
              const body = encodeURIComponent(
                `Hi ${estimateData.customer_name},\n\n` +
                `Please review your estimate at the link below:\n\n${viewLink}\n\n` +
                `Thank you,\n${businessSettings?.company_name || 'Surprise Granite'}`
              );
              window.open(`mailto:${customerEmail}?subject=${subject}&body=${body}`);
            } else {
              navigator.clipboard.writeText(viewLink);
              showToast('Estimate link copied to clipboard!');
            }
          }
        } else {
          showToast('Estimate created! Add customer email to send.');
        }

        // Offer to preview
        if (confirm('Would you like to preview the estimate?')) {
          window.open(viewLink, '_blank');
        }

      } catch (err) {
        console.error('Create estimate error:', err);
        alert('Error creating estimate: ' + err.message);
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    async function saveEstimateDraft() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Collect line items
        const lineItems = [];
        document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
          const name = item.querySelector('.item-name').value.trim();
          if (name) {
            lineItems.push({
              name: name,
              description: item.querySelector('.item-desc').value.trim(),
              unit: item.querySelector('.item-unit').value,
              quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
              unit_price: parseFloat(item.querySelector('.item-price').value) || 0
            });
          }
        });

        const customerName = document.getElementById('estimate-customer-name').value.trim();
        if (!customerName) {
          throw new Error('Please enter a customer name');
        }

        // Get customer_id from unified state (preserve customer link in drafts!)
        let customerId = estimateModalState.customerId || null;
        const leadId = estimateModalState.leadId || null;

        // If no customer linked, auto-create from form data (even for drafts)
        const customerEmail = document.getElementById('estimate-customer-email').value.trim();
        if (!customerId && customerEmail) {
          const formData = {
            customerName: customerName,
            customerEmail: customerEmail,
            customerPhone: document.getElementById('estimate-customer-phone').value.trim(),
            customerAddress: document.getElementById('estimate-customer-address').value.trim(),
            customerCity: document.getElementById('estimate-customer-city').value.trim(),
            customerState: document.getElementById('estimate-customer-state').value.trim()
          };
          const newCustomer = await createCustomerFromEstimateForm(formData);
          if (newCustomer) customerId = newCustomer.id;
        }

        // Get totals
        const subtotal = parseFloat(document.getElementById('estimate-subtotal').textContent.replace('$', '').replace(',', '')) || 0;
        const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;

        const estimateData = {
          user_id: user.id,
          customer_id: customerId,
          lead_id: leadId,
          customer_name: customerName,
          customer_email: document.getElementById('estimate-customer-email').value.trim() || null,
          customer_phone: document.getElementById('estimate-customer-phone').value.trim() || null,
          customer_address: document.getElementById('estimate-customer-address').value.trim() || null,
          customer_city: document.getElementById('estimate-customer-city').value.trim() || null,
          customer_state: document.getElementById('estimate-customer-state').value.trim() || null,
          customer_zip: document.getElementById('estimate-customer-zip').value.trim() || null,
          project_name: document.getElementById('estimate-project-name').value.trim() || null,
          project_description: document.getElementById('estimate-project-desc').value.trim() || null,
          valid_until: document.getElementById('estimate-valid-until').value || null,
          subtotal: subtotal,
          tax_rate: parseFloat(document.getElementById('estimate-tax-rate').value) || 0,
          tax_amount: parseFloat(document.getElementById('estimate-tax-amount').textContent.replace('$', '')) || 0,
          discount_type: document.getElementById('estimate-discount-type').value,
          discount_value: parseFloat(document.getElementById('estimate-discount-value').value) || 0,
          discount_amount: parseFloat(document.getElementById('estimate-discount-amount').textContent.replace('-$', '')) || 0,
          total: total,
          deposit_percent: parseFloat(document.getElementById('estimate-deposit-percent').value) || 0,
          deposit_amount: parseFloat(document.getElementById('estimate-deposit-amount').textContent.replace('$', '')) || 0,
          payment_terms: document.getElementById('estimate-payment-terms').value.trim() || null,
          warranty_terms: document.getElementById('estimate-warranty').value.trim() || null,
          notes: document.getElementById('estimate-notes').value.trim() || null,
          internal_notes: document.getElementById('estimate-internal-notes').value.trim() || null,
          status: 'draft'
        };

        const { data: estimate, error } = await supabaseClient
          .from('estimates')
          .insert([estimateData])
          .select()
          .single();

        if (error) throw error;

        // Insert line items if any
        if (lineItems.length > 0) {
          const itemsToInsert = lineItems.map(item => ({
            estimate_id: estimate.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.quantity * item.unit_price
          }));

          await supabaseClient.from('estimate_items').insert(itemsToInsert);
        }

        closeCreateEstimateModal();
        loadEstimates();
        showToast('Draft saved successfully!');

      } catch (err) {
        console.error('Save draft error:', err);
        alert('Error saving draft: ' + err.message);
      }
    }

    async function sendEstimateEmail(estimateId, token) {
      try {
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!estimate || !estimate.customer_email) return;

        const approvalUrl = `${window.location.origin}/estimate/view/?token=${token}`;

        await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: estimate.customer_email,
            customerName: estimate.customer_name,
            estimateNumber: estimate.estimate_number,
            projectName: estimate.project_name,
            total: estimate.total,
            depositAmount: estimate.deposit_amount,
            validUntil: estimate.valid_until,
            approvalUrl: approvalUrl,
            items: estimate.estimate_items
          })
        });
      } catch (err) {
        console.error('Send email error:', err);
      }
    }

    async function sendEstimate(estimateId) {
      if (!confirm('Send this estimate to the customer?')) return;

      // Show loading state
      const btn = event?.target || document.querySelector(`button[onclick*="sendEstimate('${estimateId}')"]`);
      const originalText = btn?.innerHTML;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = ' Sending...';
      }
      showToast('Preparing estimate...', 'info');

      try {
        // Fetch estimate with items
        const { data: estimate, error: fetchErr } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (fetchErr) throw fetchErr;

        if (!estimate.customer_email) {
          alert('Please add a customer email before sending');
          return;
        }

        // Update status to sent
        await supabaseClient
          .from('estimates')
          .update({ status: 'sent', sent_at: new Date().toISOString() })
          .eq('id', estimateId);

        // Generate token
        const token = crypto.randomUUID();
        await supabaseClient
          .from('estimate_tokens')
          .insert([{
            estimate_id: estimateId,
            token: token,
            expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
          }]);

        const viewLink = `${window.location.origin}/estimate/view/?token=${token}`;

        // Prepare complete estimate data for email + PDF
        const emailData = {
          customer_email: estimate.customer_email,
          customer_name: estimate.customer_name,
          customer_phone: estimate.customer_phone,
          customer_address: estimate.customer_address,
          estimate_number: estimate.estimate_number,
          estimate_id: estimate.id,
          items: (estimate.estimate_items || []).map(item => ({
            description: item.description,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          })),
          subtotal: estimate.subtotal,
          tax_rate: estimate.tax_rate,
          tax_amount: estimate.tax_amount,
          total: estimate.total,
          notes: estimate.notes,
          view_url: viewLink,
          // Business info
          business_name: businessSettings?.company_name,
          business_email: businessSettings?.company_email,
          business_phone: businessSettings?.company_phone,
          business_address: businessSettings?.company_address,
          business_logo: businessSettings?.logo_url,
          // Project details
          project_type: estimate.project_type || estimate.project_name,
          estimated_timeline: estimate.estimated_timeline,
          inclusions: estimate.inclusions,
          exclusions: estimate.exclusions,
          terms_conditions: estimate.terms_conditions,
          valid_until: estimate.valid_until,
          created_at: estimate.created_at
        };

        // Parse payment schedule if stored as JSON
        if (estimate.payment_schedule) {
          try {
            emailData.payment_schedule = typeof estimate.payment_schedule === 'string'
              ? JSON.parse(estimate.payment_schedule)
              : estimate.payment_schedule;
          } catch (e) {}
        }

        // Try to send email via API with timeout
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 15000); // 15 sec timeout
          const response = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal,
            body: JSON.stringify(emailData)
          });
          clearTimeout(timeout);

          const result = await response.json();

          if (response.ok && result.success) {
            showToast(result.pdf_attached ? 'Estimate sent with PDF!' : 'Estimate sent!');

            // Send SMS notification (email already sent by API)
            sendNotification('estimate', 'sent', estimate, {
              email: null, // Already sent by email API
              phone: estimate.customer_phone,
              name: estimate.customer_name
            });
          } else {
            throw new Error(result.error || 'Failed to send');
          }
        } catch (emailErr) {
          console.log('Email API error:', emailErr.message);
          // Fallback to email client
          const subject = encodeURIComponent(`Your Estimate from ${businessSettings?.company_name || 'Surprise Granite'}`);
          const body = encodeURIComponent(
            `Hi ${estimate.customer_name},\n\n` +
            `Please review your estimate at the link below:\n\n${viewLink}\n\n` +
            `Thank you,\n${businessSettings?.company_name || 'Surprise Granite'}`
          );
          window.open(`mailto:${estimate.customer_email}?subject=${subject}&body=${body}`);
          showToast('Email client opened with estimate link');
        }

        loadEstimates();
      } catch (err) {
        console.error('Send estimate error:', err);
        alert('Error sending estimate: ' + err.message);
      } finally {
        // Reset button state
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText || 'Send';
        }
      }
    }

    async function viewEstimate(estimateId) {
      // Open estimate in preview modal or new tab
      try {
        const { data: tokenData } = await supabaseClient
          .from('estimate_tokens')
          .select('token')
          .eq('estimate_id', estimateId)
          .order('created_at', { ascending: false })
          .limit(1)
          .single();

        if (tokenData) {
          window.open(`/estimate/view/?token=${tokenData.token}`, '_blank');
        } else {
          // Generate new token for viewing
          const token = crypto.randomUUID();
          await supabaseClient
            .from('estimate_tokens')
            .insert([{
              estimate_id: estimateId,
              token: token,
              expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]);
          window.open(`/estimate/view/?token=${token}`, '_blank');
        }
      } catch (err) {
        console.error('View estimate error:', err);
        alert('Error viewing estimate');
      }
    }

    async function deleteEstimate(estimateId) {
      if (!confirm('Delete this draft estimate?')) return;

      try {
        await supabaseClient.from('estimates').delete().eq('id', estimateId);
        loadEstimates();
        showToast('Estimate deleted');
      } catch (err) {
        console.error('Delete estimate error:', err);
        alert('Error deleting estimate');
      }
    }

    async function archiveEstimate(estimateId) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ archived_at: new Date().toISOString() })
          .eq('id', estimateId);

        if (error) throw error;
        loadEstimates();
        showToast('Estimate archived');
      } catch (err) {
        console.error('Archive estimate error:', err);
        alert('Error archiving estimate');
      }
    }

    async function unarchiveEstimate(estimateId) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ archived_at: null })
          .eq('id', estimateId);

        if (error) throw error;
        loadEstimates();
        showToast('Estimate restored');
      } catch (err) {
        console.error('Unarchive estimate error:', err);
        alert('Error restoring estimate');
      }
    }

    async function deleteEstimatePermanent(estimateId) {
      if (!confirm('Permanently delete this estimate? This cannot be undone.')) return;

      try {
        // Delete line items first
        await supabaseClient.from('estimate_items').delete().eq('estimate_id', estimateId);
        // Delete the estimate
        await supabaseClient.from('estimates').delete().eq('id', estimateId);
        loadEstimates();
        showToast('Estimate permanently deleted');
      } catch (err) {
        console.error('Delete estimate error:', err);
        alert('Error deleting estimate');
      }
    }

    async function duplicateEstimate(estimateId) {
      try {
        const { data: original } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!original) throw new Error('Estimate not found');

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Create copy
        const newEstimate = {
          user_id: user.id,
          customer_name: original.customer_name,
          customer_email: original.customer_email,
          customer_phone: original.customer_phone,
          customer_address: original.customer_address,
          customer_city: original.customer_city,
          customer_state: original.customer_state,
          customer_zip: original.customer_zip,
          project_name: original.project_name ? original.project_name + ' (Copy)' : null,
          project_description: original.project_description,
          valid_until: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          subtotal: original.subtotal,
          tax_rate: original.tax_rate,
          tax_amount: original.tax_amount,
          discount_type: original.discount_type,
          discount_value: original.discount_value,
          discount_amount: original.discount_amount,
          total: original.total,
          deposit_percent: original.deposit_percent,
          deposit_amount: original.deposit_amount,
          payment_terms: original.payment_terms,
          warranty_terms: original.warranty_terms,
          notes: original.notes,
          internal_notes: original.internal_notes,
          status: 'draft'
        };

        const { data: newEst, error } = await supabaseClient
          .from('estimates')
          .insert([newEstimate])
          .select()
          .single();

        if (error) throw error;

        // Copy line items
        if (original.estimate_items && original.estimate_items.length > 0) {
          const items = original.estimate_items.map(item => ({
            estimate_id: newEst.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          }));

          await supabaseClient.from('estimate_items').insert(items);
        }

        loadEstimates();
        showToast('Estimate duplicated!');
      } catch (err) {
        console.error('Duplicate estimate error:', err);
        alert('Error duplicating estimate');
      }
    }

    async function convertToInvoice(estimateId) {
      if (!confirm('Convert this estimate to an invoice?')) return;

      try {
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!estimate) throw new Error('Estimate not found');

        // Prevent duplicate conversion
        if (estimate.status === 'converted' || estimate.converted_to_invoice_id) {
          alert('This estimate has already been converted to an invoice.');
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Generate invoice number
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        // Create invoice - preserve full traceability chain
        const invoiceData = {
          user_id: user.id,
          invoice_number: invoiceNumber,
          estimate_id: estimateId,
          lead_id: estimate.lead_id || null,  // Preserve lead reference for traceability
          customer_id: estimate.customer_id || null,
          customer_name: estimate.customer_name,
          customer_email: estimate.customer_email,
          customer_phone: estimate.customer_phone,
          customer_address: estimate.customer_address,
          customer_city: estimate.customer_city,
          customer_state: estimate.customer_state,
          customer_zip: estimate.customer_zip,
          project_name: estimate.project_name,
          subtotal: estimate.subtotal,
          tax_rate: estimate.tax_rate,
          tax_amount: estimate.tax_amount,
          discount_type: estimate.discount_type,
          discount_value: estimate.discount_value,
          discount_amount: estimate.discount_amount,
          total: estimate.total,
          amount_paid: 0,
          amount_due: estimate.total,
          payment_terms: estimate.payment_terms,
          notes: estimate.notes,
          status: 'unpaid',
          due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        };

        const { data: invoice, error } = await supabaseClient
          .from('invoices')
          .insert([invoiceData])
          .select()
          .single();

        if (error) throw error;

        // Copy line items to invoice
        if (estimate.estimate_items && estimate.estimate_items.length > 0) {
          const items = estimate.estimate_items.map(item => ({
            invoice_id: invoice.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          }));

          await supabaseClient.from('invoice_items').insert(items);
        }

        // Update estimate status
        await supabaseClient
          .from('estimates')
          .update({ status: 'converted', converted_to_invoice_id: invoice.id })
          .eq('id', estimateId);

        showToast('Invoice created successfully!');
        showPage('invoices');
        loadInvoices();
      } catch (err) {
        console.error('Convert to invoice error:', err);
        alert('Error converting to invoice: ' + err.message);
      }
    }

    // Alias for context menu compatibility
    const convertEstimateToInvoice = convertToInvoice;

    // =============================================
    // BUSINESS SETTINGS
    // =============================================

    function openBusinessSettings() {
      const modal = document.getElementById('business-settings-modal');
      modal.classList.add('active');
      loadBusinessSettings();
    }

    function closeBusinessSettings() {
      const modal = document.getElementById('business-settings-modal');
      modal.classList.remove('active');
    }

    async function loadBusinessSettings() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: settings } = await supabaseClient
          .from('business_settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (settings) {
          document.getElementById('biz-company-name').value = settings.company_name || '';
          document.getElementById('biz-phone').value = settings.phone || '';
          document.getElementById('biz-email').value = settings.email || '';
          document.getElementById('biz-address').value = settings.address || '';
          document.getElementById('biz-city').value = settings.city || '';
          document.getElementById('biz-state').value = settings.state || '';
          document.getElementById('biz-zip').value = settings.zip || '';
          document.getElementById('biz-license').value = settings.license_number || '';
          document.getElementById('biz-website').value = settings.website || '';
          document.getElementById('biz-estimate-prefix').value = settings.estimate_prefix || 'EST-';
          if (document.getElementById('biz-invoice-prefix')) {
            document.getElementById('biz-invoice-prefix').value = settings.invoice_prefix || 'INV-';
          }
          document.getElementById('biz-estimate-terms').value = settings.default_estimate_terms || '';

          // Load defaults
          if (document.getElementById('biz-tax-rate')) {
            document.getElementById('biz-tax-rate').value = settings.default_tax_rate || 0;
          }
          if (document.getElementById('biz-deposit')) {
            document.getElementById('biz-deposit').value = settings.default_deposit_percent || 50;
          }
          if (document.getElementById('biz-payment-terms')) {
            document.getElementById('biz-payment-terms').value = settings.default_payment_terms || '';
          }
          if (document.getElementById('biz-warranty')) {
            document.getElementById('biz-warranty').value = settings.default_warranty_terms || '';
          }

          // Load logo if exists
          const logoUrl = settings.logo_url;
          const logoImage = document.getElementById('logo-image');
          const logoPlaceholder = document.getElementById('logo-placeholder');
          const removeLogoBtn = document.getElementById('remove-logo-btn');
          const logoUrlInput = document.getElementById('biz-logo-url');

          if (logoUrl) {
            logoImage.src = logoUrl;
            logoImage.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            removeLogoBtn.style.display = 'inline-block';
            logoUrlInput.value = logoUrl;
          } else {
            logoImage.style.display = 'none';
            logoPlaceholder.style.display = 'block';
            removeLogoBtn.style.display = 'none';
            logoUrlInput.value = '';
          }
        }
      } catch (err) {
        console.log('No business settings found');
      }
    }

    async function saveBusinessSettings(event) {
      if (event) event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const settingsData = {
          user_id: user.id,
          company_name: document.getElementById('biz-company-name').value.trim() || null,
          phone: document.getElementById('biz-phone').value.trim() || null,
          email: document.getElementById('biz-email').value.trim() || null,
          address: document.getElementById('biz-address').value.trim() || null,
          city: document.getElementById('biz-city').value.trim() || null,
          state: document.getElementById('biz-state').value.trim() || null,
          zip: document.getElementById('biz-zip').value.trim() || null,
          license_number: document.getElementById('biz-license').value.trim() || null,
          website: document.getElementById('biz-website').value.trim() || null,
          estimate_prefix: document.getElementById('biz-estimate-prefix').value.trim() || 'EST-',
          invoice_prefix: document.getElementById('biz-invoice-prefix')?.value.trim() || 'INV-',
          default_estimate_terms: document.getElementById('biz-estimate-terms').value.trim() || null,
          default_tax_rate: parseFloat(document.getElementById('biz-tax-rate')?.value) || 0,
          default_deposit_percent: parseFloat(document.getElementById('biz-deposit')?.value) || 50,
          default_payment_terms: document.getElementById('biz-payment-terms')?.value.trim() || null,
          default_warranty_terms: document.getElementById('biz-warranty')?.value.trim() || null,
          logo_url: document.getElementById('biz-logo-url').value.trim() || null
        };

        const { error } = await supabaseClient
          .from('business_settings')
          .upsert([settingsData], { onConflict: 'user_id' });

        if (error) throw error;

        closeBusinessSettings();
        showToast('Business settings saved!');
      } catch (err) {
        console.error('Save business settings error:', err);
        alert('Error saving settings: ' + err.message);
      }

      return false;
    }

    // Logo upload handler
    async function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('Image must be smaller than 2MB');
        return;
      }

      const logoImage = document.getElementById('logo-image');
      const logoPlaceholder = document.getElementById('logo-placeholder');
      const removeLogoBtn = document.getElementById('remove-logo-btn');
      const logoUrlInput = document.getElementById('biz-logo-url');

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Show loading state
        logoPlaceholder.innerHTML = 'Uploading...';
        logoPlaceholder.style.display = 'block';
        logoImage.style.display = 'none';

        // Create unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `logos/${user.id}/logo-${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (error) throw error;

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('lead-images')
          .getPublicUrl(fileName);

        const publicUrl = urlData.publicUrl;

        // Update UI
        logoImage.src = publicUrl;
        logoImage.style.display = 'block';
        logoPlaceholder.style.display = 'none';
        removeLogoBtn.style.display = 'inline-block';
        logoUrlInput.value = publicUrl;

        showToast('Logo uploaded! Click Save to apply changes.');
      } catch (err) {
        console.error('Logo upload error:', err);
        logoPlaceholder.innerHTML = 'No logo<br>uploaded';
        logoPlaceholder.style.display = 'block';
        alert('Error uploading logo: ' + err.message);
      }
    }

    // Remove logo handler
    function removeLogo() {
      const logoImage = document.getElementById('logo-image');
      const logoPlaceholder = document.getElementById('logo-placeholder');
      const removeLogoBtn = document.getElementById('remove-logo-btn');
      const logoUrlInput = document.getElementById('biz-logo-url');
      const logoUpload = document.getElementById('logo-upload');

      logoImage.src = '';
      logoImage.style.display = 'none';
      logoPlaceholder.innerHTML = 'No logo<br>uploaded';
      logoPlaceholder.style.display = 'block';
      removeLogoBtn.style.display = 'none';
      logoUrlInput.value = '';
      logoUpload.value = '';

      showToast('Logo removed. Click Save to apply changes.');
    }

    // =============================================
    // JOBS & PROJECT MANAGEMENT
    // =============================================

    let allJobs = [];
    let allContractors = [];
    // allCustomers already declared above
    let currentJobId = null;
    let jobFilter = 'all';
    let contractorFilter = 'all';

    async function loadJobs() {
      const jobsList = document.getElementById('jobs-list');
      if (!jobsList) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        jobsList.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: jobs, error } = await supabaseClient
          .from('jobs')
          .select(`
            *,
            customers (id, name, email, phone, address, city, state, zip),
            job_contractors (
              id, contractor_id, role, amount_quoted, status,
              contractors (id, name, email, phone, type)
            )
          `)
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allJobs = jobs || [];
        updateJobsCount();
        updateJobStats();
        renderJobs();
        renderKanbanBoard();
      } catch (err) {
        console.error('Load jobs error:', err);
        jobsList.innerHTML = `<div class="empty-state"><p>Error loading jobs: ${err.message}</p></div>`;
      }
    }

    function updateJobsCount() {
      const badge = document.getElementById('jobs-count');
      if (badge) {
        const activeJobs = allJobs.filter(j => !['completed', 'cancelled'].includes(j.status)).length;
        badge.textContent = activeJobs;
        badge.dataset.count = activeJobs;
      }
    }

    function filterJobs(status) {
      jobFilter = status;
      document.querySelectorAll('[data-job-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.jobStatus === status);
      });
      renderJobs();
      renderKanbanBoard();
    }

    let currentJobsView = 'list';

    function setJobsView(view) {
      currentJobsView = view;
      const listView = document.getElementById('jobs-list-view');
      const kanbanView = document.getElementById('jobs-kanban-view');
      const listBtn = document.getElementById('jobsListBtn');
      const kanbanBtn = document.getElementById('jobsKanbanBtn');

      if (view === 'list') {
        listView.style.display = 'block';
        kanbanView.style.display = 'none';
        listBtn.style.background = 'var(--gold-primary)';
        listBtn.style.color = 'var(--dark-primary)';
        kanbanBtn.style.background = 'transparent';
        kanbanBtn.style.color = 'var(--text-secondary)';
      } else {
        listView.style.display = 'none';
        kanbanView.style.display = 'block';
        kanbanBtn.style.background = 'var(--gold-primary)';
        kanbanBtn.style.color = 'var(--dark-primary)';
        listBtn.style.background = 'transparent';
        listBtn.style.color = 'var(--text-secondary)';
        renderKanbanBoard();
      }
    }

    function renderKanbanBoard() {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed'];

      // Map existing statuses to kanban columns
      const statusMapping = {
        'new': 'lead',
        'reviewing': 'lead',
        'lead': 'lead',
        'approved': 'approved',
        'assigned': 'approved',
        'scheduled': 'scheduled',
        'measured': 'scheduled',
        'material_ordered': 'in_progress',
        'material_received': 'in_progress',
        'in_production': 'in_progress',
        'ready': 'in_progress',
        'installing': 'in_progress',
        'completed': 'completed',
        'on_hold': 'lead',
        'cancelled': 'completed'
      };

      // Clear all columns
      statuses.forEach(status => {
        const container = document.getElementById(`kanban-cards-${status}`);
        if (container) container.innerHTML = '';
      });

      // Group jobs by kanban status
      const grouped = { lead: [], approved: [], scheduled: [], in_progress: [], completed: [] };

      allJobs.forEach(job => {
        const kanbanStatus = statusMapping[job.status] || 'lead';
        grouped[kanbanStatus].push(job);
      });

      // Render cards and update counts
      statuses.forEach(status => {
        const container = document.getElementById(`kanban-cards-${status}`);
        const countEl = document.getElementById(`kanban-count-${status}`);

        if (countEl) countEl.textContent = grouped[status].length;

        if (container) {
          if (grouped[status].length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">No jobs</div>';
          } else {
            container.innerHTML = grouped[status].map(job => `
              <div class="kanban-card" onclick="openJobDetail('${job.id}')" style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <span style="font-weight: 600; font-size: 13px;">#${job.job_number || job.id.slice(0,8)}</span>
                  <span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-muted);">${job.status?.replace('_', ' ') || 'new'}</span>
                </div>
                <div style="font-size: 14px; font-weight: 500; margin-bottom: 6px;">${job.customers?.name || job.customer_name || 'Unknown'}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${job.description || job.project_type || 'No description'}</div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                  <span style="font-size: 13px; font-weight: 600; color: var(--gold-primary);">$${(job.total || job.contract_amount || 0).toLocaleString()}</span>
                  <span style="font-size: 11px; color: var(--text-muted);">${job.created_at ? new Date(job.created_at).toLocaleDateString() : ''}</span>
                </div>
              </div>
            `).join('');
          }
        }
      });

      // Update job stats
      updateJobStats();
    }

    function updateJobStats() {
      const activeJobs = allJobs.filter(j => !['completed', 'cancelled'].includes(j.status)).length;
      const totalRevenue = allJobs.reduce((sum, j) => sum + (j.total || j.contract_amount || 0), 0);
      const totalCosts = allJobs.reduce((sum, j) => sum + (j.total_cost || 0), 0);
      const netProfit = totalRevenue - totalCosts;

      const statActive = document.getElementById('stat-active-jobs');
      const statRevenue = document.getElementById('stat-total-revenue');
      const statCosts = document.getElementById('stat-total-costs');
      const statProfit = document.getElementById('stat-net-profit');

      if (statActive) statActive.textContent = activeJobs;
      if (statRevenue) statRevenue.textContent = '$' + totalRevenue.toLocaleString();
      if (statCosts) statCosts.textContent = '$' + totalCosts.toLocaleString();
      if (statProfit) statProfit.textContent = '$' + netProfit.toLocaleString();
    }

    function renderJobs() {
      const jobsList = document.getElementById('jobs-list');
      if (!jobsList) return;

      let filtered = allJobs;
      if (jobFilter !== 'all') {
        filtered = filtered.filter(job => job.status === jobFilter);
      }

      if (filtered.length === 0) {
        jobsList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <h3>${jobFilter !== 'all' ? 'No ' + jobFilter.replace('_', ' ') + ' jobs' : 'No jobs yet'}</h3>
            <p>Jobs are created automatically when invoices are paid.</p>
          </div>`;
        return;
      }

      const statusColors = {
        new: '#f59e0b',
        reviewing: '#f59e0b',
        material_ordered: '#06b6d4',
        material_received: '#06b6d4',
        assigned: '#3b82f6',
        scheduled: '#3b82f6',
        measured: '#8b5cf6',
        in_production: '#8b5cf6',
        ready: '#10b981',
        installing: '#10b981',
        completed: '#22c55e',
        on_hold: '#6b7280',
        cancelled: '#ef4444'
      };

      // Modern card-based list for better mobile experience
      jobsList.innerHTML = `
        <div class="list-modern">
          ${filtered.map(job => `
            <div class="list-item-modern"
                 data-context-menu="job"
                 data-item-id="${job.id}"
                 data-item-data='${JSON.stringify({ job_number: job.job_number, status: job.status, customer_name: job.customers?.name }).replace(/'/g, "&#39;")}'
                 onclick="openJobDetail('${job.id}')">
              <div class="list-item-icon" style="background: ${statusColors[job.status] || '#6b7280'}15;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${statusColors[job.status] || '#6b7280'}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">${job.job_number || 'New Job'}  ${job.customers?.name || 'Unknown'}</div>
                <div class="list-item-subtitle">${job.project_description || 'No description'}</div>
              </div>
              <div class="list-item-meta">
                <div class="list-item-amount">$${(job.contract_amount || 0).toLocaleString()}</div>
                <span class="badge-modern badge-${job.status || 'new'}">${(job.status || 'new').replace('_', ' ')}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function openNewJobModal() {
      document.getElementById('new-job-modal').classList.add('active');
      document.getElementById('new-job-form').reset();
      document.getElementById('new-customer-fields').style.display = 'none';
      loadCustomersForSelect();
    }

    function closeNewJobModal() {
      document.getElementById('new-job-modal').classList.remove('active');
    }

    function toggleNewCustomerFields() {
      const select = document.getElementById('job-customer-select');
      const fields = document.getElementById('new-customer-fields');
      fields.style.display = select.value === 'new' ? 'block' : 'none';
    }

    async function loadCustomersForSelect() {
      const select = document.getElementById('job-customer-select');
      if (!select) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state, zip')
          .eq('user_id', user.id)
          .order('name');

        allCustomers = customers || [];

        // Keep first two options and rebuild
        select.innerHTML = `
          <option value="">-- Select Customer --</option>
          <option value="new">+ Add New Customer</option>
          ${(customers || []).map(c => `<option value="${c.id}">${c.name}${c.email ? ' (' + c.email + ')' : ''}</option>`).join('')}
        `;
      } catch (err) {
        console.error('Load customers error:', err);
      }
    }

    async function createJob(event) {
      event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        let customerId = document.getElementById('job-customer-select').value;
        let customerName = '';
        let customerEmail = '';
        let customerPhone = '';
        let customerAddress = '';

        // Create new customer if needed
        if (customerId === 'new') {
          customerName = document.getElementById('job-customer-name').value.trim();
          customerEmail = document.getElementById('job-customer-email').value.trim() || null;
          customerPhone = document.getElementById('job-customer-phone').value.trim() || null;
          const addr = document.getElementById('job-customer-address').value.trim() || '';
          const city = document.getElementById('job-customer-city').value.trim() || '';
          const state = document.getElementById('job-customer-state').value.trim() || '';
          const zip = document.getElementById('job-customer-zip').value.trim() || '';
          customerAddress = [addr, city, state, zip].filter(Boolean).join(', ');

          if (!customerName) throw new Error('Customer name is required');

          const customerData = {
            user_id: user.id,
            name: customerName,
            email: customerEmail,
            phone: customerPhone,
            address: addr || null,
            city: city || null,
            state: state || null,
            zip: zip || null
          };

          const { data: newCustomer, error: custError } = await supabaseClient
            .from('customers')
            .insert([customerData])
            .select()
            .single();

          if (custError) throw custError;
          customerId = newCustomer.id;
        } else {
          // Get existing customer info
          const customer = allCustomers.find(c => c.id === customerId);
          if (customer) {
            customerName = customer.name || '';
            customerEmail = customer.email || '';
            customerPhone = customer.phone || '';
            customerAddress = [customer.address, customer.city, customer.state, customer.zip].filter(Boolean).join(', ');
          }
        }

        if (!customerId) throw new Error('Please select or create a customer');
        if (!customerName) throw new Error('Customer name is required');

        // Get next job number
        const { data: jobNumber } = await supabaseClient.rpc('get_next_job_number', { p_user_id: user.id });

        const scheduledDate = document.getElementById('job-scheduled-date').value || null;
        const depositAmount = parseFloat(document.getElementById('job-deposit').value) || 0;

        const jobData = {
          user_id: user.id,
          customer_id: customerId,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          customer_address: customerAddress,
          job_number: jobNumber || `JOB-${Date.now()}`,
          project_description: document.getElementById('job-title').value.trim(),
          project_type: document.getElementById('job-type').value,
          contract_amount: parseFloat(document.getElementById('job-total').value) || 0,
          deposit_amount: depositAmount,
          deposit_paid: depositAmount > 0,
          internal_notes: document.getElementById('job-notes').value.trim() || null,
          estimated_start_date: scheduledDate,
          status: scheduledDate ? 'scheduled' : 'new'
        };

        const { error } = await supabaseClient.from('jobs').insert([jobData]);
        if (error) throw error;

        closeNewJobModal();
        showToast('Job created successfully!');
        loadJobs();
      } catch (err) {
        console.error('Create job error:', err);
        alert('Error creating job: ' + err.message);
      }
    }

    async function openJobDetail(jobId) {
      currentJobId = jobId;
      const modal = document.getElementById('job-detail-modal');
      modal.classList.add('active');

      // Find job in allJobs
      const job = allJobs.find(j => j.id === jobId);
      if (!job) {
        alert('Job not found');
        return;
      }

      // Populate job details
      document.getElementById('job-detail-number').textContent = job.job_number || 'N/A';
      document.getElementById('job-detail-status').value = job.status || 'new';
      document.getElementById('job-detail-type').textContent = (job.project_type || 'N/A').replace('_', ' ');
      document.getElementById('job-detail-priority').textContent = job.project_description || '-';
      document.getElementById('job-detail-total').textContent = '$' + (job.contract_amount || 0).toFixed(2);
      document.getElementById('job-detail-balance').textContent = '$' + ((job.contract_amount || 0) - (job.total_paid || 0)).toFixed(2);
      document.getElementById('job-detail-notes').textContent = job.internal_notes || '-';

      // Customer info - use relation if available, otherwise use denormalized fields
      const customerName = job.customers?.name || job.customer_name || 'Unknown';
      const customerEmail = job.customers?.email || job.customer_email || '';
      const customerPhone = job.customers?.phone || job.customer_phone || '';
      const customerAddr = job.customers
        ? [job.customers.address, job.customers.city, job.customers.state, job.customers.zip].filter(Boolean).join(', ')
        : job.customer_address || '';
      document.getElementById('job-customer-name-display').textContent = customerName;
      document.getElementById('job-customer-email-display').textContent = customerEmail;
      document.getElementById('job-customer-phone-display').textContent = customerPhone;
      document.getElementById('job-customer-address-display').textContent = customerAddr;

      // Assigned contractors
      const contractorsList = document.getElementById('job-contractors-list');
      if (job.job_contractors && job.job_contractors.length > 0) {
        contractorsList.innerHTML = job.job_contractors.map(jc => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 8px;">
            <div style="flex: 1; cursor: pointer;" onclick="openContractorProfile('${jc.contractor_id}')">
              <div style="font-weight: 500;">${jc.contractors?.name || 'Unknown'}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${jc.role || jc.contractors?.type || ''} - $${(jc.amount_quoted || 0).toFixed(2)}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button class="action-btn" onclick="sendContractorPortalLink('${jc.contractor_id}')" title="Send Portal Link" style="padding: 4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
              </button>
              <span class="status-badge" style="font-size: 10px; background: ${jc.contractor_status === 'accepted' ? 'rgba(34,197,94,0.15)' : jc.contractor_status === 'declined' ? 'rgba(239,68,68,0.15)' : 'rgba(245,158,11,0.15)'}; color: ${jc.contractor_status === 'accepted' ? '#22c55e' : jc.contractor_status === 'declined' ? '#ef4444' : '#f59e0b'};">${jc.contractor_status || 'pending'}</span>
            </div>
          </div>
        `).join('');
      } else {
        contractorsList.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No contractors assigned yet.</div>';
      }

      // Populate schedule fields
      const fieldMeasureInput = document.getElementById('job-field-measure-date');
      const installDateInput = document.getElementById('job-install-date');

      if (fieldMeasureInput) {
        fieldMeasureInput.value = job.field_measure_date ? job.field_measure_date.slice(0, 16) : '';
      }
      if (installDateInput) {
        installDateInput.value = job.install_date ? job.install_date.slice(0, 16) : '';
      }

      // Load files
      loadJobFiles(jobId);

      // Load timeline
      loadJobTimeline(jobId);
    }

    function closeJobDetailModal() {
      document.getElementById('job-detail-modal').classList.remove('active');
      currentJobId = null;
    }

    async function updateJobStatus() {
      if (!currentJobId) return;

      const newStatus = document.getElementById('job-detail-status').value;

      try {
        const { error } = await supabaseClient
          .from('jobs')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', currentJobId);

        if (error) throw error;

        showToast('Status updated');
        loadJobs();
        // Refresh calendar if it's been loaded
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update status error:', err);
        alert('Error updating status: ' + err.message);
      }
    }

    // Update job status by ID (for context menu)
    async function updateJobStatusById(jobId, newStatus) {
      if (!jobId || !newStatus) return;

      try {
        // Get job details first for notification
        const { data: job } = await supabaseClient
          .from('jobs')
          .select('*')
          .eq('id', jobId)
          .single();

        const { error } = await supabaseClient
          .from('jobs')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', jobId);

        if (error) throw error;

        // Send status update notification (email + SMS)
        if (job && (job.customer_email || job.customer_phone)) {
          sendNotification('job', 'status_change', job, {
            email: job.customer_email,
            phone: job.customer_phone,
            name: job.customer_name
          }, newStatus);
        }

        showToast(`Job status updated to ${newStatus.replace('_', ' ')}`);
        loadJobs();
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update job status error:', err);
        showToast('Error updating status: ' + err.message, 'error');
      }
    }

    // Archive a job
    async function archiveJob(jobId) {
      if (!jobId) return;

      if (!confirm('Archive this job? It will be moved to archived status.')) return;

      try {
        const { error } = await supabaseClient
          .from('jobs')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', jobId);

        if (error) throw error;

        showToast('Job archived');
        loadJobs();
      } catch (err) {
        console.error('Archive job error:', err);
        showToast('Error archiving job: ' + err.message, 'error');
      }
    }

    // Delete a job
    async function deleteJob(jobId) {
      if (!jobId) return;

      if (!confirm('Delete this job? This action cannot be undone.')) return;

      try {
        // First delete related records
        await supabaseClient.from('job_contractors').delete().eq('job_id', jobId);
        await supabaseClient.from('job_files').delete().eq('job_id', jobId);
        await supabaseClient.from('job_timeline').delete().eq('job_id', jobId);

        // Then delete the job
        const { error } = await supabaseClient
          .from('jobs')
          .delete()
          .eq('id', jobId);

        if (error) throw error;

        showToast('Job deleted');
        loadJobs();
        closeJobDetailModal();
      } catch (err) {
        console.error('Delete job error:', err);
        showToast('Error deleting job: ' + err.message, 'error');
      }
    }

    async function updateJobSchedule(field) {
      if (!currentJobId) return;

      const fieldMeasureInput = document.getElementById('job-field-measure-date');
      const installDateInput = document.getElementById('job-install-date');

      const updateData = {
        updated_at: new Date().toISOString()
      };

      if (field === 'field_measure_date' && fieldMeasureInput) {
        updateData.field_measure_date = fieldMeasureInput.value ? new Date(fieldMeasureInput.value).toISOString() : null;
      }

      if (field === 'install_date' && installDateInput) {
        updateData.install_date = installDateInput.value ? new Date(installDateInput.value).toISOString() : null;
      }

      try {
        const { error } = await supabaseClient
          .from('jobs')
          .update(updateData)
          .eq('id', currentJobId);

        if (error) throw error;

        showToast('Schedule updated');
        loadJobs();
        // Refresh calendar to show the new event
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update schedule error:', err);
        alert('Error updating schedule: ' + err.message);
      }
    }

    async function loadJobFiles(jobId) {
      const container = document.getElementById('job-files-list');
      if (!container) return;

      try {
        const { data: files, error } = await supabaseClient
          .from('job_files')
          .select('*')
          .eq('job_id', jobId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!files || files.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No files uploaded yet.<br>
              <span style="font-size: 12px;">Drop files here or click Upload</span>
            </div>`;
          return;
        }

        container.innerHTML = files.map(file => `
          <div style="display: flex; align-items: center; gap: 12px; padding: 8px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 8px;">
            <div style="width: 40px; height: 40px; background: var(--dark-surface); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
              ${file.file_type?.includes('image') ? `<img src="${file.file_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">` :
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.file_name || 'File'}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${file.category || 'Document'} - ${new Date(file.created_at).toLocaleDateString()}</div>
            </div>
            <a href="${file.file_url}" target="_blank" class="action-btn" title="Download">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            </a>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load files error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Error loading files</div>';
      }
    }

    async function uploadJobFiles(event) {
      if (!currentJobId) return;

      const files = event.target.files;
      if (!files || files.length === 0) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        showToast('Uploading files...', 'info');

        for (const file of files) {
          const fileExt = file.name.split('.').pop();
          const fileName = `jobs/${currentJobId}/${Date.now()}-${file.name}`;

          // Upload to storage
          const { data, error: uploadError } = await supabaseClient.storage
            .from('lead-images')
            .upload(fileName, file);

          if (uploadError) throw uploadError;

          // Get public URL
          const { data: urlData } = supabaseClient.storage
            .from('lead-images')
            .getPublicUrl(fileName);

          // Save file record
          const { error: dbError } = await supabaseClient
            .from('job_files')
            .insert([{
              job_id: currentJobId,
              user_id: user.id,
              file_name: file.name,
              file_url: urlData.publicUrl,
              file_type: file.type,
              file_size: file.size,
              category: file.type.includes('image') ? 'photo' : 'document'
            }]);

          if (dbError) throw dbError;
        }

        showToast('Files uploaded successfully!');
        loadJobFiles(currentJobId);
        event.target.value = '';
      } catch (err) {
        console.error('Upload error:', err);
        alert('Error uploading files: ' + err.message);
      }
    }

    async function loadJobTimeline(jobId) {
      const container = document.getElementById('job-timeline');
      if (!container) return;

      try {
        const { data: history, error } = await supabaseClient
          .from('job_status_history')
          .select('*')
          .eq('job_id', jobId)
          .order('changed_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        if (!history || history.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No activity yet.</div>';
          return;
        }

        container.innerHTML = history.map(h => `
          <div style="display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
            <div style="width: 8px; height: 8px; background: var(--gold-primary); border-radius: 50%; margin-top: 6px;"></div>
            <div>
              <div style="font-size: 13px;">Status changed from <strong>${h.from_status || 'new'}</strong> to <strong>${h.to_status}</strong></div>
              <div style="font-size: 11px; color: var(--text-muted);">${new Date(h.changed_at).toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load timeline error:', err);
      }
    }

    async function sendCustomerPortalLink() {
      if (!currentJobId) return;

      const job = allJobs.find(j => j.id === currentJobId);
      if (!job || !job.customer_id) {
        alert('No customer associated with this job');
        return;
      }

      try {
        // Get or create customer portal token
        const { data: customer, error: fetchError } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, portal_token')
          .eq('id', job.customer_id)
          .single();

        if (fetchError) throw fetchError;
        if (!customer) throw new Error('Customer not found');

        let token = customer.portal_token;
        if (!token) {
          // Generate new token
          token = btoa(customer.id + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);

          const { error: updateError } = await supabaseClient
            .from('customers')
            .update({ portal_token: token })
            .eq('id', customer.id);

          if (updateError) throw updateError;
        }

        const portalUrl = `${window.location.origin}/customer-portal/?token=${token}`;

        // Show options modal
        const action = prompt(
          `Customer Portal Link for ${customer.name}:\n\n${portalUrl}\n\nOptions:\n1. Copy link (type "copy")\n2. Email link (type "email")\n3. Text link (type "text")`,
          'copy'
        );

        if (action === 'copy') {
          navigator.clipboard.writeText(portalUrl);
          showToast('Portal link copied to clipboard!');
        } else if (action === 'email' && customer.email) {
          try {
            await fetch(`${API_URL}/api/customers/send-portal-link`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                customer_id: customer.id,
                email: customer.email,
                portal_link: portalUrl,
                job_number: job.job_number
              })
            });
            showToast('Portal link sent via email!');
          } catch (err) {
            navigator.clipboard.writeText(portalUrl);
            showToast('Could not send email. Link copied instead.');
          }
        } else if (action === 'text' && customer.phone) {
          const message = encodeURIComponent(`Track your project with Surprise Granite: ${portalUrl}`);
          window.open(`sms:${customer.phone}?body=${message}`, '_blank');
        } else if (action) {
          navigator.clipboard.writeText(portalUrl);
          showToast('Link copied to clipboard!');
        }

      } catch (err) {
        console.error('Send portal link error:', err);
        alert('Error generating portal link: ' + err.message);
      }
    }

    async function sendContractorPortalLink(contractorId) {
      try {
        // Get or create contractor portal token
        const { data: contractor, error: fetchError } = await supabaseClient
          .from('contractors')
          .select('id, name, company, email, phone, invite_token')
          .eq('id', contractorId)
          .single();

        if (fetchError) throw fetchError;
        if (!contractor) throw new Error('Contractor not found');

        let token = contractor.invite_token;
        if (!token) {
          token = btoa(contractor.id + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);

          const { error: updateError } = await supabaseClient
            .from('contractors')
            .update({ invite_token: token })
            .eq('id', contractor.id);

          if (updateError) throw updateError;
        }

        const portalUrl = `${window.location.origin}/contractor-portal/?token=${token}`;

        const action = prompt(
          `Contractor Portal Link for ${contractor.company || contractor.name}:\n\n${portalUrl}\n\nOptions:\n1. Copy link (type "copy")\n2. Email link (type "email")\n3. Text link (type "text")`,
          'copy'
        );

        if (action === 'copy') {
          navigator.clipboard.writeText(portalUrl);
          showToast('Portal link copied!');
        } else if (action === 'email' && contractor.email) {
          try {
            await fetch(`${API_URL}/api/contractors/send-invite`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contractor_id: contractor.id,
                email: contractor.email,
                invite_link: portalUrl
              })
            });
            showToast('Portal link sent via email!');
          } catch (err) {
            navigator.clipboard.writeText(portalUrl);
            showToast('Could not send email. Link copied instead.');
          }
        } else if (action === 'text' && contractor.phone) {
          const message = encodeURIComponent(`Access your contractor portal at Surprise Granite: ${portalUrl}`);
          window.open(`sms:${contractor.phone}?body=${message}`, '_blank');
        } else if (action) {
          navigator.clipboard.writeText(portalUrl);
          showToast('Link copied!');
        }

      } catch (err) {
        console.error('Send contractor portal link error:', err);
        alert('Error generating portal link: ' + err.message);
      }
    }

    // =============================================
    // CONTRACTORS
    // =============================================

    async function loadContractors() {
      const container = document.getElementById('contractors-list');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: contractors, error } = await supabaseClient
          .from('contractors')
          .select('*')
          .eq('user_id', user.id)
          .order('name');

        if (error) throw error;

        allContractors = contractors || [];
        renderContractors();
      } catch (err) {
        console.error('Load contractors error:', err);
        container.innerHTML = `<div class="empty-state"><p>Error loading contractors</p></div>`;
      }
    }

    function filterContractors(type) {
      contractorFilter = type;
      document.querySelectorAll('[data-contractor-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.contractorStatus === type);
      });
      renderContractors();
    }

    function renderContractors() {
      const container = document.getElementById('contractors-list');
      if (!container) return;

      let filtered = allContractors;
      if (contractorFilter !== 'all') {
        filtered = filtered.filter(c => c.type === contractorFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <h3>No contractors found</h3>
            <p>Add your team members to assign them to jobs.</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewContractorModal()">Add Contractor</button>
          </div>`;
        return;
      }

      const getTrustBadgeColor = (score) => {
        if (score >= 70) return { bg: 'rgba(34, 197, 94, 0.15)', color: '#22c55e', label: 'Verified' };
        if (score >= 40) return { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b', label: 'Partial' };
        return { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280', label: 'New' };
      };

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          ${filtered.map(c => {
            const trust = getTrustBadgeColor(c.trust_score || 0);
            const isClaimed = !!c.claimed_by;
            return `
            <div class="contractor-card" onclick="openContractorProfile('${c.id}')" style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid ${isClaimed ? 'var(--gold-primary)' : 'var(--border-subtle)'}; cursor: pointer; transition: all 0.2s;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: 600; font-size: 15px;">${c.name}</span>
                    ${isClaimed ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="var(--gold-primary)" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>' : ''}
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted);">${c.company || ''}</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                  <span class="status-badge" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; font-size: 10px; padding: 4px 10px;">${c.type || 'other'}</span>
                  <div style="display: flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 10px; background: ${trust.bg};">
                    <span style="font-size: 11px; font-weight: 700; color: ${trust.color};">${c.trust_score || 0}</span>
                    <span style="font-size: 9px; color: ${trust.color};">${trust.label}</span>
                  </div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; min-height: 36px;">
                ${c.email ? `<div style="display: flex; align-items: center; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${c.email}</div>` : ''}
                ${c.phone ? `<div style="display: flex; align-items: center; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${c.phone}</div>` : ''}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
                <div style="font-size: 12px; color: var(--text-muted);">
                  ${c.total_jobs || 0} jobs assigned
                </div>
                <div style="display: flex; gap: 6px;" onclick="event.stopPropagation();">
                  <button class="action-btn" onclick="openContractorProfile('${c.id}')" title="View Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                  </button>
                  <button class="action-btn" onclick="quickInviteContractor('${c.id}')" title="Send Invite" style="color: var(--gold-primary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                  </button>
                </div>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function openNewContractorModal() {
      document.getElementById('new-contractor-modal').classList.add('active');
      document.getElementById('new-contractor-form').reset();
    }

    async function quickInviteContractor(contractorId) {
      const contractor = allContractors.find(c => c.id === contractorId);
      if (!contractor) return;

      // Generate invite link
      let token = contractor.invite_token;
      if (!token) {
        token = btoa(contractorId + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);
        try {
          await supabaseClient.from('contractors').update({ invite_token: token }).eq('id', contractorId);
        } catch (e) { console.log('Could not save token:', e); }
      }

      const inviteUrl = `${window.location.origin}/contractor-portal/?token=${token}`;

      // Copy to clipboard
      try {
        await navigator.clipboard.writeText(inviteUrl);
        showToast('Invite link copied!');
      } catch (e) {
        // Fallback
        const input = document.createElement('input');
        input.value = inviteUrl;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('Invite link copied!');
      }

      // If they have email, offer to send
      if (contractor.email) {
        const sendEmail = confirm(`Link copied! Also send invite email to ${contractor.email}?`);
        if (sendEmail) {
          try {
            await fetch(`${API_URL}/api/contractors/send-invite`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                contractor_id: contractorId,
                email: contractor.email,
                invite_link: inviteUrl
              })
            });
            showToast('Email sent!');
          } catch (err) {
            console.log('Could not send email:', err);
          }
        }
      }
    }

    function closeNewContractorModal() {
      document.getElementById('new-contractor-modal').classList.remove('active');
    }

    async function createContractor(event) {
      event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const contractorData = {
          user_id: user.id,
          name: document.getElementById('contractor-name').value.trim(),
          type: document.getElementById('contractor-type').value,
          email: document.getElementById('contractor-email').value.trim() || null,
          phone: document.getElementById('contractor-phone').value.trim() || null,
          company: document.getElementById('contractor-company').value.trim() || null,
          hourly_rate: parseFloat(document.getElementById('contractor-rate').value) || null,
          license_number: document.getElementById('contractor-license').value.trim() || null,
          notes: document.getElementById('contractor-notes').value.trim() || null
        };

        const { error } = await supabaseClient.from('contractors').insert([contractorData]);
        if (error) throw error;

        closeNewContractorModal();
        showToast('Contractor added!');
        loadContractors();
      } catch (err) {
        console.error('Create contractor error:', err);
        alert('Error adding contractor: ' + err.message);
      }
    }

    function openAssignContractorModal() {
      if (!currentJobId) return;
      document.getElementById('assign-contractor-modal').classList.add('active');
      // Reset inline form
      document.getElementById('new-contractor-inline').style.display = 'none';
      document.getElementById('assign-contractor-select').style.display = 'block';
      document.getElementById('assign-contractor-select').removeAttribute('disabled');
      loadContractorsForSelect();
    }

    function closeAssignContractorModal() {
      document.getElementById('assign-contractor-modal').classList.remove('active');
      cancelNewContractorInline();
    }

    function toggleNewContractorInAssign() {
      const select = document.getElementById('assign-contractor-select');
      const inlineForm = document.getElementById('new-contractor-inline');

      if (select.value === '__new__') {
        inlineForm.style.display = 'block';
        // Clear inline form fields
        document.getElementById('inline-contractor-name').value = '';
        document.getElementById('inline-contractor-company').value = '';
        document.getElementById('inline-contractor-email').value = '';
        document.getElementById('inline-contractor-phone').value = '';
        // Set role based on selection
        const role = document.getElementById('assign-contractor-role').value;
        document.getElementById('inline-contractor-name').focus();
      } else {
        inlineForm.style.display = 'none';
      }
    }

    function cancelNewContractorInline() {
      const select = document.getElementById('assign-contractor-select');
      const inlineForm = document.getElementById('new-contractor-inline');
      inlineForm.style.display = 'none';
      select.value = '';
    }

    async function loadContractorsForSelect() {
      const select = document.getElementById('assign-contractor-select');
      if (!select) return;

      select.innerHTML = `
        <option value="">-- Select Contractor --</option>
        <option value="__new__" style="color: var(--gold-primary); font-weight: 600;">+ Add New Contractor</option>
      `;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: contractors } = await supabaseClient
          .from('contractors')
          .select('id, name, type, company')
          .eq('user_id', user.id)
          .order('name');

        if (contractors && contractors.length > 0) {
          select.innerHTML += '<option disabled></option>';
          (contractors || []).forEach(c => {
            const displayName = c.company ? `${c.name} - ${c.company}` : c.name;
            select.innerHTML += `<option value="${c.id}">${displayName} (${c.type})</option>`;
          });
        }
      } catch (err) {
        console.error('Load contractors for select error:', err);
      }
    }

    async function assignContractor(event) {
      event.preventDefault();

      if (!currentJobId) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        let contractorId = document.getElementById('assign-contractor-select').value;

        // Check if we need to create a new contractor first
        if (contractorId === '__new__') {
          const newName = document.getElementById('inline-contractor-name').value.trim();
          if (!newName) throw new Error('Please enter contractor name');

          const role = document.getElementById('assign-contractor-role').value;
          const contractorData = {
            user_id: user.id,
            name: newName,
            type: role, // Use the selected role as the contractor type
            company: document.getElementById('inline-contractor-company').value.trim() || null,
            email: document.getElementById('inline-contractor-email').value.trim() || null,
            phone: document.getElementById('inline-contractor-phone').value.trim() || null
          };

          const { data: newContractor, error: createError } = await supabaseClient
            .from('contractors')
            .insert([contractorData])
            .select()
            .single();

          if (createError) throw createError;
          contractorId = newContractor.id;
          showToast('Contractor created!');
        }

        if (!contractorId || contractorId === '__new__') {
          throw new Error('Please select or create a contractor');
        }

        const assignData = {
          job_id: currentJobId,
          contractor_id: contractorId,
          role: document.getElementById('assign-contractor-role').value,
          amount_quoted: parseFloat(document.getElementById('assign-contractor-amount').value) || 0,
          status: 'pending'
        };

        const { error } = await supabaseClient.from('job_contractors').insert([assignData]);
        if (error) throw error;

        const shouldNotify = document.getElementById('assign-contractor-notify').checked;
        if (shouldNotify) {
          // Send invite email via API
          try {
            await fetch(`${API_URL}/api/jobs/${currentJobId}/assign-contractor`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ contractor_id: contractorId, send_invite: true })
            });
          } catch (apiErr) {
            console.log('Could not send invite email:', apiErr);
          }
        }

        closeAssignContractorModal();
        showToast('Contractor assigned!');
        loadJobs();
        loadContractors(); // Refresh contractors list too
        if (currentJobId) {
          const job = allJobs.find(j => j.id === currentJobId);
          if (job) openJobDetail(currentJobId);
        }
      } catch (err) {
        console.error('Assign contractor error:', err);
        alert('Error assigning contractor: ' + err.message);
      }
    }

    // =============================================
    // CALENDAR
    // =============================================

    let currentCalendarDate = new Date();
    let calendarEvents = [];

    async function initCalendar() {
      renderCalendar();
      // Ensure jobs and customers are loaded for scheduling
      if (allJobs.length === 0) await loadJobs();
      if (allCustomers.length === 0) await loadCustomers();
      loadCalendarEvents();
    }

    function changeCalendarMonth(delta) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
      renderCalendar();
      loadCalendarEvents();
    }

    function goToToday() {
      currentCalendarDate = new Date();
      renderCalendar();
      loadCalendarEvents();
    }

    // Calendar Scheduling Variables
    let selectedScheduleDate = null;

    // Open Quick Schedule Modal
    function openQuickScheduleModal(preselectedDate = null) {
      const modal = document.getElementById('quick-schedule-modal');
      if (!modal) return;

      // Reset form
      document.getElementById('quick-schedule-form').reset();

      // Populate customers dropdown
      const customerSelect = document.getElementById('schedule-customer-select');
      customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';
      allCustomers.forEach(c => {
        customerSelect.innerHTML += `<option value="${c.id}">${c.name} ${c.email ? '(' + c.email + ')' : ''}</option>`;
      });

      // Populate jobs dropdown
      const jobSelect = document.getElementById('schedule-job-select');
      jobSelect.innerHTML = '<option value="">-- Create New or Select Existing --</option>';
      allJobs.filter(j => j.status !== 'completed' && j.status !== 'cancelled').forEach(j => {
        jobSelect.innerHTML += `<option value="${j.id}">${j.job_number || 'Job'} - ${j.customer_name || j.project_description}</option>`;
      });

      // Set date if preselected
      if (preselectedDate) {
        document.getElementById('schedule-date').value = preselectedDate;
        selectedScheduleDate = preselectedDate;
      } else {
        // Default to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('schedule-date').value = today;
      }

      toggleScheduleFields();
      modal.classList.add('active');
    }

    function closeQuickScheduleModal() {
      document.getElementById('quick-schedule-modal').classList.remove('active');
      selectedScheduleDate = null;
    }

    function toggleScheduleFields() {
      const jobSelect = document.getElementById('schedule-job-select');
      const newJobFields = document.getElementById('schedule-new-job-fields');
      const descInput = document.getElementById('schedule-description');
      const customerSelect = document.getElementById('schedule-customer-select');

      if (jobSelect.value) {
        // Existing job selected - hide new job fields
        newJobFields.style.display = 'none';
        descInput.removeAttribute('required');
        customerSelect.removeAttribute('required');
      } else {
        // Creating new - show fields
        newJobFields.style.display = 'block';
        descInput.setAttribute('required', 'required');
      }
    }

    async function submitQuickSchedule(e) {
      e.preventDefault();

      const eventType = document.getElementById('schedule-event-type').value;
      const jobId = document.getElementById('schedule-job-select').value;
      const customerId = document.getElementById('schedule-customer-select').value;
      const description = document.getElementById('schedule-description').value;
      const scheduleDate = document.getElementById('schedule-date').value;
      const scheduleTime = document.getElementById('schedule-time').value;
      const duration = document.getElementById('schedule-duration').value;
      const notes = document.getElementById('schedule-notes').value;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        let targetJobId = jobId;

        // If no existing job selected, create a new one
        if (!jobId) {
          if (!customerId) {
            showToast('Please select a customer', 'error');
            return;
          }

          const customer = allCustomers.find(c => c.id === customerId);

          // Generate job number
          const { count } = await supabaseClient
            .from('jobs')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', user.id);

          const jobNumber = `JOB-${String((count || 0) + 1).padStart(4, '0')}`;

          // Create the job
          const { data: newJob, error: jobError } = await supabaseClient
            .from('jobs')
            .insert({
              user_id: user.id,
              customer_id: customerId,
              customer_name: customer?.name || 'Customer',
              customer_email: customer?.email || null,
              customer_phone: customer?.phone || null,
              job_number: jobNumber,
              project_description: description,
              status: 'scheduled',
              estimated_start_date: scheduleDate,
              notes: notes
            })
            .select()
            .single();

          if (jobError) throw jobError;
          targetJobId = newJob.id;

          // Add to local array
          allJobs.unshift(newJob);
        }

        // Update the job with the scheduled date/time based on event type
        const updateData = { updated_at: new Date().toISOString() };

        if (eventType === 'measure') {
          updateData.field_measure_date = scheduleTime ? `${scheduleDate}T${scheduleTime}:00` : scheduleDate;
        } else if (eventType === 'job' || eventType === 'consultation') {
          updateData.estimated_start_date = scheduleDate;
          if (scheduleTime) {
            updateData.scheduled_time = scheduleTime;
          }
        } else {
          updateData.estimated_start_date = scheduleDate;
        }

        if (notes && targetJobId) {
          updateData.notes = notes;
        }

        if (targetJobId) {
          await supabaseClient
            .from('jobs')
            .update(updateData)
            .eq('id', targetJobId);

          // Update local array
          const jobIdx = allJobs.findIndex(j => j.id === targetJobId);
          if (jobIdx !== -1) {
            Object.assign(allJobs[jobIdx], updateData);
          }
        }

        showToast('Event scheduled successfully!');
        closeQuickScheduleModal();
        closeDayEventsModal();
        loadCalendarEvents();
        renderCalendar();

      } catch (err) {
        console.error('Schedule error:', err);
        showToast('Error scheduling: ' + err.message, 'error');
      }
    }

    // Day Events Modal
    function showDayEvents(dateStr) {
      selectedScheduleDate = dateStr;
      const modal = document.getElementById('day-events-modal');
      if (!modal) return;

      const date = new Date(dateStr + 'T12:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('day-events-title').textContent = date.toLocaleDateString('en-US', options);

      const dayEvents = calendarEvents.filter(e => e.date === dateStr);
      const content = document.getElementById('day-events-content');

      if (dayEvents.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 12px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p>No events scheduled</p>
            <p style="font-size: 13px; margin-top: 8px;">Click "Add Event" to schedule something</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="list-modern">
            ${dayEvents.map(evt => {
              const typeColors = {
                job: '#3b82f6',
                measure: '#f59e0b',
                install: '#10b981',
                production: '#8b5cf6'
              };
              const color = typeColors[evt.type] || '#3b82f6';
              return `
                <div class="list-item-modern" onclick="openJobDetail('${evt.jobId}')" style="cursor: pointer;">
                  <div class="list-item-icon" style="background: ${color}20; color: ${color};">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                  </div>
                  <div class="list-item-content">
                    <div class="list-item-title">${evt.title}</div>
                    <div class="list-item-subtitle">${evt.type.charAt(0).toUpperCase() + evt.type.slice(1)}</div>
                  </div>
                  <div class="list-item-meta">
                    <span class="badge-modern" style="background: ${color}20; color: ${color};">${evt.status || 'Scheduled'}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeDayEventsModal() {
      document.getElementById('day-events-modal').classList.remove('active');
    }

    function openQuickScheduleForDate() {
      closeDayEventsModal();
      openQuickScheduleModal(selectedScheduleDate);
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const monthYearEl = document.getElementById('calendar-month-year');
      if (!grid || !monthYearEl) return;

      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      monthYearEl.textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and total days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const totalDays = lastDay.getDate();

      // Get previous month's days to show
      const prevMonthLastDay = new Date(year, month, 0).getDate();

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      let html = '';
      let dayCount = 1;
      let nextMonthDay = 1;

      // Generate 6 weeks (42 days)
      for (let i = 0; i < 42; i++) {
        let dayNumber, dateStr, isOtherMonth = false;

        if (i < startDayOfWeek) {
          // Previous month days
          dayNumber = prevMonthLastDay - startDayOfWeek + i + 1;
          const prevMonth = month === 0 ? 12 : month;
          const prevYear = month === 0 ? year - 1 : year;
          dateStr = `${prevYear}-${String(prevMonth).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          isOtherMonth = true;
        } else if (dayCount <= totalDays) {
          // Current month days
          dayNumber = dayCount;
          dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          dayCount++;
        } else {
          // Next month days
          dayNumber = nextMonthDay;
          const nextMonth = month === 11 ? 1 : month + 2;
          const nextYear = month === 11 ? year + 1 : year;
          dateStr = `${nextYear}-${String(nextMonth).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          nextMonthDay++;
          isOtherMonth = true;
        }

        const isToday = dateStr === todayStr;
        const dayEvents = calendarEvents.filter(e => e.date === dateStr);

        html += `
          <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"
               data-date="${dateStr}" onclick="showDayEvents('${dateStr}')">
            <div class="calendar-day-number">${dayNumber}</div>
            <div class="calendar-events">
              ${dayEvents.slice(0, 3).map(e => `
                <div class="calendar-event ${e.type}" onclick="event.stopPropagation(); openJobDetail('${e.jobId}')">
                  ${e.title}
                </div>
              `).join('')}
              ${dayEvents.length > 3 ? `<div class="calendar-event-more">+${dayEvents.length - 3} more</div>` : ''}
            </div>
          </div>
        `;
      }

      grid.innerHTML = html;
    }

    async function loadCalendarEvents() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Get jobs with dates
        const { data: jobs, error } = await supabaseClient
          .from('jobs')
          .select('id, job_number, customer_name, project_description, status, estimated_start_date, field_measure_date, install_date')
          .eq('user_id', user.id)
          .not('status', 'in', '("completed","cancelled")');

        if (error) throw error;

        calendarEvents = [];

        (jobs || []).forEach(job => {
          const title = job.customer_name || job.project_description || job.job_number;

          if (job.estimated_start_date) {
            calendarEvents.push({
              date: job.estimated_start_date,
              title: title,
              type: 'job',
              jobId: job.id,
              status: job.status
            });
          }

          if (job.field_measure_date) {
            const measureDate = job.field_measure_date.split('T')[0];
            calendarEvents.push({
              date: measureDate,
              title: `Measure: ${title}`,
              type: 'measure',
              jobId: job.id,
              status: job.status
            });
          }

          if (job.install_date) {
            const installDate = job.install_date.split('T')[0];
            calendarEvents.push({
              date: installDate,
              title: `Install: ${title}`,
              type: 'install',
              jobId: job.id,
              status: job.status
            });
          }
        });

        renderCalendar();
        renderUpcomingEvents();
      } catch (err) {
        console.error('Load calendar events error:', err);
      }
    }

    function renderUpcomingEvents() {
      const container = document.getElementById('upcoming-events-list');
      if (!container) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const upcoming = calendarEvents
        .filter(e => new Date(e.date) >= today)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 10);

      if (upcoming.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 30px;">
            <p style="color: var(--text-muted);">No upcoming events scheduled</p>
          </div>
        `;
        return;
      }

      const typeColors = {
        job: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' },
        install: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981' },
        measure: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' },
        production: { bg: 'rgba(139, 92, 246, 0.15)', color: '#8b5cf6' }
      };

      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      container.innerHTML = upcoming.map(event => {
        const date = new Date(event.date + 'T00:00:00');
        const colors = typeColors[event.type] || typeColors.job;
        const typeName = event.type === 'measure' ? 'Field Measure' :
                        event.type === 'install' ? 'Installation' :
                        event.type === 'production' ? 'In Production' : 'Scheduled';

        return `
          <div class="upcoming-event-item" onclick="openJobDetail('${event.jobId}')">
            <div class="upcoming-event-date">
              <span class="day">${date.getDate()}</span>
              <span class="month">${monthNames[date.getMonth()]}</span>
            </div>
            <div class="upcoming-event-info">
              <div class="upcoming-event-title">${event.title}</div>
              <div class="upcoming-event-details">
                <span class="upcoming-event-type" style="background: ${colors.bg}; color: ${colors.color};">${typeName}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function showDayEvents(dateStr) {
      const dayEvents = calendarEvents.filter(e => e.date === dateStr);
      if (dayEvents.length === 1) {
        openJobDetail(dayEvents[0].jobId);
      } else if (dayEvents.length > 1) {
        // Could open a modal with all events for the day
        console.log('Events on', dateStr, dayEvents);
      }
    }

    // =============================================
    // CUSTOMERS MODAL
    // =============================================

    function openCustomersModal() {
      document.getElementById('customers-modal').classList.add('active');
      loadCustomersModal();
    }

    function closeCustomersModal() {
      document.getElementById('customers-modal').classList.remove('active');
    }

    function openAddCustomerModal(customerId = null) {
      const modal = document.getElementById('add-customer-modal');
      const form = document.getElementById('add-customer-form');
      const title = document.getElementById('customer-modal-title');

      // Reset form
      form.reset();
      document.getElementById('edit-customer-id').value = '';

      if (customerId) {
        // Edit mode - find customer and populate form
        title.textContent = 'Edit Customer';
        const customer = allCustomers?.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('edit-customer-id').value = customer.id;
          document.getElementById('cust-name').value = customer.name || '';
          document.getElementById('cust-email').value = customer.email || '';
          document.getElementById('cust-phone').value = customer.phone || '';
          document.getElementById('cust-company').value = customer.company || '';
          document.getElementById('cust-address').value = customer.address || '';
          document.getElementById('cust-city').value = customer.city || '';
          document.getElementById('cust-state').value = customer.state || 'AZ';
          document.getElementById('cust-zip').value = customer.zip || '';
          const notesField = document.getElementById('cust-notes');
          if (notesField) notesField.value = customer.notes || '';
        }
      } else {
        title.textContent = 'Add New Customer';
      }

      modal.classList.add('active');
    }

    function closeAddCustomerModal() {
      document.getElementById('add-customer-modal').classList.remove('active');
    }

    async function saveCustomer(event) {
      event.preventDefault();

      const customerId = document.getElementById('edit-customer-id').value;
      const notesField = document.getElementById('cust-notes');
      const customerData = {
        name: document.getElementById('cust-name').value.trim(),
        email: document.getElementById('cust-email').value.trim() || null,
        phone: document.getElementById('cust-phone').value.trim() || null,
        company: document.getElementById('cust-company').value.trim() || null,
        address: document.getElementById('cust-address').value.trim() || null,
        city: document.getElementById('cust-city').value.trim() || null,
        state: document.getElementById('cust-state').value.trim() || null,
        zip: document.getElementById('cust-zip').value.trim() || null,
        notes: notesField ? notesField.value.trim() || null : null
      };

      if (!customerData.name) {
        showToast('Customer name is required', 'error');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          showToast('Please log in first', 'error');
          return;
        }

        let result;
        if (customerId) {
          // Update existing customer
          result = await supabaseClient
            .from('customers')
            .update(customerData)
            .eq('id', customerId)
            .eq('user_id', user.id)
            .select()
            .single();
        } else {
          // Create new customer
          result = await supabaseClient
            .from('customers')
            .insert({ ...customerData, user_id: user.id })
            .select()
            .single();
        }

        if (result.error) throw result.error;

        showToast(customerId ? 'Customer updated!' : 'Customer created!');
        closeAddCustomerModal();
        loadCustomersModal(); // Refresh the list
      } catch (err) {
        console.error('Save customer error:', err);
        showToast('Error saving customer: ' + err.message, 'error');
      }
    }

    // UNIFIED: Start estimate from customer - uses centralized state
    async function startEstimateFromCustomer(customerId) {
      // Use helper to fetch customer (handles cache and DB lookup)
      const customer = await getCustomer(customerId) || selectedCustomer;

      if (!customer) {
        showToast('Customer not found. Please select a customer first.', 'error');
        return;
      }

      // Update unified workflow state
      workflowState.currentCustomer = customer;
      selectedCustomer = customer;

      // Close any open modals
      if (typeof closeCustomersModal === 'function') closeCustomersModal();
      if (typeof closeCustomerModal === 'function') closeCustomerModal();

      // Navigate to estimates page
      showPage('estimates');

      // Small delay to ensure page is rendered
      setTimeout(() => {
        // Set modal state with proper customer linkage (no more dataset attributes)
        estimateModalState = {
          customerId: customer.id,
          leadId: null,
          editingEstimateId: null
        };

        // Open estimate modal (preserveState=true since we set estimateModalState above)
        openCreateEstimateModal(true);

        // Pre-fill customer info using helper
        fillEstimateCustomerFields(customer);

        showToast(`Creating estimate for ${customer.name}`);
      }, 100);
    }

    // Backward compatibility alias
    async function createEstimateForCustomer(customerId) {
      return startEstimateFromCustomer(customerId);
    }

    async function loadCustomersModal() {
      const container = document.getElementById('customers-list-modal');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .order('name');

        if (error) throw error;

        // Store in global array for other functions
        allCustomers = customers || [];

        if (!customers || customers.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No customers yet. Click "Add Customer" to create one.</div>';
          return;
        }

        container.innerHTML = `
          <table style="width: 100%;">
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Jobs</th>
                <th>Total Spent</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${customers.map(c => `
                <tr>
                  <td>
                    <strong>${c.name}</strong>
                    ${c.company ? `<div style="font-size: 12px; color: var(--text-muted);">${c.company}</div>` : ''}
                  </td>
                  <td>
                    <div style="font-size: 13px;">${c.email || '-'}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">${c.phone || ''}</div>
                  </td>
                  <td>${c.total_jobs || 0}</td>
                  <td style="color: var(--gold-primary); font-weight: 600;">$${(c.total_spent || 0).toFixed(2)}</td>
                  <td>
                    <div style="display: flex; gap: 8px;">
                      <button onclick="createEstimateForCustomer('${c.id}')" class="btn-modern small" style="font-size: 12px; padding: 6px 10px;">
                        <i class="fas fa-file-invoice"></i> Estimate
                      </button>
                      <button onclick="openAddCustomerModal('${c.id}')" class="btn-modern secondary small" style="font-size: 12px; padding: 6px 10px;">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Load customers error:', err);
        container.innerHTML = '<div style="color: var(--text-muted);">Error loading customers</div>';
      }
    }

    function searchCustomers() {
      // Simple client-side search
      const query = document.getElementById('customer-search').value.toLowerCase();
      const rows = document.querySelectorAll('#customers-list-modal tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
      });
    }

    async function sendCustomerUpdate() {
      // Placeholder for sending customer update email
      showToast('Customer update feature coming soon!', 'info');
    }

    async function orderMaterials() {
      // Placeholder for material ordering
      showToast('Material ordering feature coming soon!', 'info');
    }

    function saveJobChanges() {
      showToast('Changes saved!');
      closeJobDetailModal();
    }

    let currentContractorId = null;

    function editContractor(contractorId) {
      openContractorProfile(contractorId);
    }

    async function openContractorProfile(contractorId) {
      currentContractorId = contractorId;
      const modal = document.getElementById('contractor-profile-modal');
      modal.classList.add('active');

      // Find contractor in allContractors
      let contractor = allContractors.find(c => c.id === contractorId);

      // If not found, fetch from database
      if (!contractor) {
        try {
          const { data, error } = await supabaseClient
            .from('contractors')
            .select('*')
            .eq('id', contractorId)
            .single();
          if (error) throw error;
          contractor = data;
        } catch (err) {
          console.error('Load contractor error:', err);
          alert('Could not load contractor');
          return;
        }
      }

      // Populate profile
      document.getElementById('contractor-profile-name').textContent = contractor.name || 'Unknown';
      document.getElementById('contractor-profile-company').textContent = contractor.company || '';
      document.getElementById('contractor-profile-email').textContent = contractor.email || '-';
      document.getElementById('contractor-profile-phone').textContent = contractor.phone || '-';
      document.getElementById('contractor-profile-type').textContent = (contractor.type || '-').replace('_', ' ');
      document.getElementById('contractor-profile-license').textContent = contractor.license_number || '-';

      // Trust score
      const trustScore = contractor.trust_score || 0;
      document.getElementById('contractor-trust-score').textContent = trustScore;
      const badge = document.getElementById('contractor-trust-badge');
      badge.classList.toggle('verified', trustScore >= 70);

      // Generate invite link
      generateInviteLink(contractorId, contractor);

      // Render verification checklist
      renderVerificationChecklist(contractor);

      // Load documents
      loadContractorDocuments(contractorId);

      // Load job history
      loadContractorJobHistory(contractorId);
    }

    function closeContractorProfileModal() {
      document.getElementById('contractor-profile-modal').classList.remove('active');
      currentContractorId = null;
    }

    async function generateInviteLink(contractorId, contractor) {
      const linkInput = document.getElementById('contractor-invite-link');
      const qrContainer = document.getElementById('contractor-qr-code');

      // Generate a simple token if not exists
      let token = contractor.invite_token;
      if (!token) {
        token = btoa(contractorId + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);

        // Save token to database
        try {
          await supabaseClient
            .from('contractors')
            .update({ invite_token: token })
            .eq('id', contractorId);
        } catch (err) {
          console.log('Could not save invite token:', err);
        }
      }

      const inviteUrl = `${window.location.origin}/contractor-portal/?token=${token}`;
      linkInput.value = inviteUrl;

      // Generate QR code (using a simple QR code API)
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(inviteUrl)}`;
      qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 100px; height: 100px; border-radius: 4px;">`;
    }

    function copyInviteLink() {
      const linkInput = document.getElementById('contractor-invite-link');
      linkInput.select();
      document.execCommand('copy');
      showToast('Link copied to clipboard!');
    }

    async function sendInviteEmail() {
      if (!currentContractorId) return;

      const contractor = allContractors.find(c => c.id === currentContractorId);
      if (!contractor?.email) {
        alert('No email address for this contractor');
        return;
      }

      try {
        const inviteLink = document.getElementById('contractor-invite-link').value;
        await fetch(`${API_URL}/api/contractors/send-invite`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contractor_id: currentContractorId,
            email: contractor.email,
            invite_link: inviteLink
          })
        });
        showToast('Invite email sent!');
      } catch (err) {
        console.error('Send invite error:', err);
        showToast('Could not send email. Link copied instead.');
        copyInviteLink();
      }
    }

    function sendInviteSMS() {
      const contractor = allContractors.find(c => c.id === currentContractorId);
      const inviteLink = document.getElementById('contractor-invite-link').value;

      if (contractor?.phone) {
        // Open SMS app with pre-filled message
        const message = encodeURIComponent(`You've been invited to join Surprise Granite's contractor network! Complete your profile here: ${inviteLink}`);
        window.open(`sms:${contractor.phone}?body=${message}`, '_blank');
      } else {
        copyInviteLink();
        showToast('No phone number. Link copied instead.');
      }
    }

    function renderVerificationChecklist(contractor) {
      const container = document.getElementById('contractor-verification-checklist');

      const checklistItems = [
        { key: 'email', label: 'Email Address', subtitle: 'Contact information', points: 5, completed: !!contractor.email },
        { key: 'phone', label: 'Phone Number', subtitle: 'Contact information', points: 5, completed: !!contractor.phone },
        { key: 'company', label: 'Business Name', subtitle: 'Company details', points: 5, completed: !!contractor.company },
        { key: 'license', label: 'License Number', subtitle: 'Trade license', points: 10, completed: !!contractor.license_number },
        { key: 'claimed', label: 'Profile Claimed', subtitle: 'Account linked', points: 10, completed: !!contractor.claimed_by },
        { key: 'insurance', label: 'Insurance Certificate', subtitle: 'General liability', points: 25, completed: false }, // Check docs
        { key: 'w9', label: 'W-9 Form', subtitle: 'Tax documentation', points: 10, completed: false }, // Check docs
      ];

      container.innerHTML = checklistItems.map(item => `
        <div class="verification-item ${item.completed ? 'completed' : 'pending'}">
          <div class="verification-icon ${item.completed ? 'completed' : 'pending'}">
            ${item.completed
              ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
              : '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>'
            }
          </div>
          <div class="verification-item-text">
            <div class="verification-item-title">${item.label}</div>
            <div class="verification-item-subtitle">${item.subtitle}</div>
          </div>
          <div class="verification-item-points">+${item.points} pts</div>
        </div>
      `).join('');
    }

    async function loadContractorDocuments(contractorId) {
      const container = document.getElementById('contractor-documents-list');

      try {
        const { data: docs, error } = await supabaseClient
          .from('contractor_documents')
          .select('*')
          .eq('contractor_id', contractorId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!docs || docs.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No documents uploaded yet.<br>
              <span style="font-size: 12px;">Upload insurance, license, W-9, and other documents.</span>
            </div>
          `;
          return;
        }

        const docTypeLabels = {
          'insurance_general_liability': 'General Liability Insurance',
          'insurance_workers_comp': 'Workers Comp Insurance',
          'insurance_auto': 'Auto Insurance',
          'license_contractor': 'Contractor License',
          'license_trade': 'Trade License',
          'w9': 'W-9 Form',
          'certification': 'Certification',
          'bond': 'Bond',
          'other': 'Other Document'
        };

        container.innerHTML = docs.map(doc => `
          <div class="document-card">
            <div class="doc-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="doc-info">
              <div class="doc-name">${doc.document_name}</div>
              <div class="doc-meta">${docTypeLabels[doc.document_type] || doc.document_type}${doc.expiration_date ? ' | Exp: ' + new Date(doc.expiration_date).toLocaleDateString() : ''}</div>
            </div>
            <span class="doc-status ${doc.status}">${doc.status}</span>
            <a href="${doc.file_url}" target="_blank" class="action-btn" title="View">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            </a>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load contractor documents error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Could not load documents</div>';
      }
    }

    async function loadContractorJobHistory(contractorId) {
      const container = document.getElementById('contractor-job-history');

      try {
        const { data: jobs, error } = await supabaseClient
          .from('job_contractors')
          .select(`
            id, role, amount_quoted, status,
            jobs (id, job_number, customer_name, status)
          `)
          .eq('contractor_id', contractorId)
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        if (!jobs || jobs.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No jobs assigned yet</div>';
          return;
        }

        container.innerHTML = jobs.map(jc => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 6px; cursor: pointer;" onclick="openJobDetail('${jc.jobs?.id}')">
            <div>
              <div style="font-weight: 500; font-size: 13px;">${jc.jobs?.job_number || 'Unknown'}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${jc.jobs?.customer_name || ''} - ${jc.role}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 600; font-size: 13px; color: var(--gold-primary);">$${(jc.amount_quoted || 0).toFixed(0)}</div>
              <span class="status-badge job-${jc.jobs?.status || 'new'}" style="font-size: 9px; padding: 2px 8px;">${jc.jobs?.status || 'new'}</span>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load job history error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Could not load job history</div>';
      }
    }

    async function uploadContractorDocument(event) {
      const file = event.target.files[0];
      if (!file || !currentContractorId) return;

      // Ask for document type
      const docType = prompt('Document type? (insurance, license, w9, certification, other)', 'insurance');
      if (!docType) return;

      const docTypeMap = {
        'insurance': 'insurance_general_liability',
        'workers comp': 'insurance_workers_comp',
        'license': 'license_contractor',
        'w9': 'w9',
        'certification': 'certification',
        'bond': 'bond',
        'other': 'other'
      };

      const documentType = docTypeMap[docType.toLowerCase()] || 'other';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Upload file to storage
        const fileExt = file.name.split('.').pop();
        const fileName = `contractors/${currentContractorId}/${Date.now()}.${fileExt}`;

        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file);

        if (uploadError) throw uploadError;

        const { data: urlData } = supabaseClient.storage.from('lead-images').getPublicUrl(fileName);

        // Create document record
        const { error: docError } = await supabaseClient.from('contractor_documents').insert([{
          contractor_id: currentContractorId,
          user_id: user.id,
          document_type: documentType,
          document_name: file.name,
          file_url: urlData.publicUrl,
          file_type: fileExt,
          status: 'pending'
        }]);

        if (docError) throw docError;

        showToast('Document uploaded!');
        loadContractorDocuments(currentContractorId);

        // Recalculate trust score
        try {
          await supabaseClient.rpc('calculate_contractor_trust_score', { contractor_uuid: currentContractorId });
        } catch (e) {
          console.log('Could not update trust score:', e);
        }
      } catch (err) {
        console.error('Upload document error:', err);
        alert('Error uploading document: ' + err.message);
      }

      event.target.value = '';
    }

    function editContractorDetails() {
      showToast('Edit feature coming soon!', 'info');
    }

    function openNewCustomerModal() {
      // Use the job modal's new customer feature
      openNewJobModal();
      document.getElementById('job-customer-select').value = 'new';
      toggleNewCustomerFields();
    }

    // =============================================
    // SERVICE CATALOG
    // =============================================

    function openServiceCatalog() {
      const modal = document.getElementById('service-catalog-modal');
      modal.classList.add('active');
      loadServiceCatalog();
    }

    function closeServiceCatalog() {
      const modal = document.getElementById('service-catalog-modal');
      modal.classList.remove('active');
    }

    async function loadServiceCatalog() {
      const container = document.getElementById('catalog-items-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: items, error } = await supabaseClient
          .from('service_catalog')
          .select('*')
          .eq('user_id', user.id)
          .order('category', { ascending: true });

        if (error) throw error;

        serviceCatalog = items || [];

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <p>No catalog items yet</p>
              <button class="btn-modern primary small" onclick="openAddCatalogItem()" style="margin-top: 12px;">Add First Item</button>
            </div>`;
          return;
        }

        // Group by category
        const grouped = items.reduce((acc, item) => {
          const cat = item.category || 'Uncategorized';
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        container.innerHTML = Object.entries(grouped).map(([category, catItems]) => `
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 13px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${category}</h4>
            ${catItems.map(item => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px;">
                <div>
                  <div style="font-weight: 500;">${item.name}</div>
                  ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="color: var(--gold-primary); font-weight: 600;">$${item.default_price}/${item.unit}</span>
                  <button onclick="deleteCatalogItem('${item.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (err) {
        console.error('Load catalog error:', err);
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Error loading catalog</div>';
      }
    }

    function openAddCatalogItem() {
      const modal = document.getElementById('add-catalog-item-modal');
      modal.classList.add('active');
      document.getElementById('add-catalog-item-form').reset();
    }

    function closeAddCatalogItem() {
      const modal = document.getElementById('add-catalog-item-modal');
      modal.classList.remove('active');
    }

    async function saveCatalogItem(event) {
      if (event) event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const itemData = {
          user_id: user.id,
          name: document.getElementById('catalog-item-name').value.trim(),
          description: document.getElementById('catalog-item-desc').value.trim() || null,
          category: document.getElementById('catalog-item-category').value.trim() || 'General',
          unit: document.getElementById('catalog-item-unit').value,
          default_price: parseFloat(document.getElementById('catalog-item-price').value) || 0
        };

        if (!itemData.name) throw new Error('Please enter an item name');

        const { error } = await supabaseClient
          .from('service_catalog')
          .insert([itemData]);

        if (error) throw error;

        closeAddCatalogItem();
        loadServiceCatalog();
        showToast('Catalog item added!');
      } catch (err) {
        console.error('Save catalog item error:', err);
        alert('Error: ' + err.message);
      }

      return false;
    }

    async function deleteCatalogItem(itemId) {
      if (!confirm('Delete this catalog item?')) return;

      try {
        await supabaseClient.from('service_catalog').delete().eq('id', itemId);
        loadServiceCatalog();
        showToast('Item deleted');
      } catch (err) {
        console.error('Delete catalog item error:', err);
        alert('Error deleting item');
      }
    }

    // =============================================
    // CATALOG PICKER FOR ESTIMATES
    // =============================================

    function openCatalogPicker() {
      // Load catalog items and show picker
      const modal = document.createElement('div');
      modal.id = 'catalog-picker-modal';
      modal.className = 'modal-overlay';
      modal.style.display = 'flex';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div class="modal-header">
            <h2 class="modal-title">Add from Catalog</h2>
            <button class="modal-close" onclick="document.getElementById('catalog-picker-modal').remove()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" id="catalog-picker-list">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading catalog...</div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      loadCatalogPicker();
    }

    async function loadCatalogPicker() {
      const container = document.getElementById('catalog-picker-list');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: items } = await supabaseClient
          .from('service_catalog')
          .select('*')
          .eq('user_id', user.id)
          .order('category', { ascending: true });

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: var(--text-muted); margin-bottom: 16px;">No catalog items. Add services and materials to your catalog for quick estimate creation.</p>
              <button class="btn-modern primary" onclick="document.getElementById('catalog-picker-modal').remove(); openServiceCatalog();">
                Set Up Catalog
              </button>
            </div>`;
          return;
        }

        const grouped = items.reduce((acc, item) => {
          const cat = item.category || 'Uncategorized';
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        container.innerHTML = Object.entries(grouped).map(([category, catItems]) => `
          <div style="margin-bottom: 16px;">
            <h4 style="font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${category}</h4>
            ${catItems.map(item => `
              <div onclick="addCatalogItemToEstimate(${JSON.stringify(item).replace(/"/g, '&quot;')})" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(249,203,0,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                <div>
                  <div style="font-weight: 500;">${item.name}</div>
                  ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                </div>
                <span style="color: var(--gold-primary); font-weight: 600;">$${item.default_price}/${item.unit}</span>
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (err) {
        console.error('Load catalog picker error:', err);
        container.innerHTML = '<div style="padding: 20px; color: var(--error);">Error loading catalog</div>';
      }
    }

    function addCatalogItemToEstimate(item) {
      addEstimateLineItem({
        name: item.name,
        description: item.description,
        unit_type: item.unit,
        quantity: 1,
        price: item.default_price
      });
      document.getElementById('catalog-picker-modal')?.remove();
    }
  </script>
<script src="/js/user-tracking.js"></script>
<script src="/js/site-search.js"></script>

<!-- Remodely.ai Integration -->
<script src="/remodely-platform/config/tenants.js"></script>
<script>
  // Initialize Remodely tenant integration
  document.addEventListener('DOMContentLoaded', function() {
    if (window.REMODELY_TENANTS) {
      const tenant = window.REMODELY_TENANTS.initializeTenant();
      console.log('Remodely tenant initialized:', tenant.name);
    }
  });
</script>

<!-- Remodely Tools Hub -->
<script defer src="/js/remodely-hub.js?v=20260118"></script>

<!-- Pro-Customer Referral Tracking -->
<script src="/js/referral-tracking.js?v=20260118"></script>

<!-- Mobile Bottom Navigation -->
<script src="/js/account/components/mobile-nav.js?v=20260119"></script>
<script>
// Integrate mobile nav with account dashboard
document.addEventListener('DOMContentLoaded', function() {
  // Update mobile nav when user logs in
  const originalShowDashboard = window.showDashboard;
  if (originalShowDashboard) {
    window.showDashboard = function() {
      originalShowDashboard.apply(this, arguments);
      // Update mobile nav for current user
      if (window.mobileNav && window.userProfile) {
        window.mobileNav.updateForRole(window.userRole || 'homeowner');
        window.mobileNav.updateUserInfo(window.userProfile);
      }
    };
  }

  // Dispatch page change events for mobile nav
  const originalShowPage = window.showPage;
  if (originalShowPage) {
    window.showPage = function(page) {
      originalShowPage.apply(this, arguments);
      document.dispatchEvent(new CustomEvent('pageChanged', { detail: { page: page } }));
    };
  }

  // Update badges when counts change
  function updateMobileBadges() {
    if (!window.mobileNav) return;

    // Get counts from existing badge elements
    const leadsBadge = document.querySelector('.nav-item[data-page="leads"] .nav-badge');
    const estimatesBadge = document.querySelector('.nav-item[data-page="estimates"] .nav-badge');

    if (leadsBadge) {
      const count = parseInt(leadsBadge.textContent) || 0;
      window.mobileNav.updateBadge('leads', count);
    }
    if (estimatesBadge) {
      const count = parseInt(estimatesBadge.textContent) || 0;
      window.mobileNav.updateBadge('estimates', count);
    }
  }

  // Initial badge update
  setTimeout(updateMobileBadges, 2000);

  // Update badges periodically
  setInterval(updateMobileBadges, 30000);
});
</script>
</body>
</html>
