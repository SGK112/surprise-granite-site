<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Products & Price Sheets | Admin Dashboard | Surprise Granite</title>
  <meta name="description" content="Manage products, services, and price sheets."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Unified Navigation -->
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260111c">
  <script defer src="/js/unified-nav.js?v=20260111c"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --gold: #f9cb00;
      --gold-dark: #cca600;
      --dark: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text: #ffffff;
      --text-secondary: rgba(255,255,255,0.75);
      --text-muted: rgba(255,255,255,0.5);
      --border: rgba(255,255,255,0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text);
    }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .main { flex: 1; margin-left: 260px; padding: 32px; }

    /* Sidebar */
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text); }
    .sidebar-logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px; color: var(--dark);
    }
    .sidebar-logo-text { font-weight: 700; font-size: 16px; }
    .sidebar-logo-sub { font-size: 11px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }

    .nav-section { padding: 0 12px; margin-bottom: 24px; }
    .nav-section-title { padding: 8px 12px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px; border-radius: 8px; color: var(--text-secondary);
      text-decoration: none; transition: all 0.2s; margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--dark-elevated); color: var(--text); }
    .nav-item.active { background: rgba(249,203,0,0.1); color: var(--gold); }
    .nav-item svg { width: 20px; height: 20px; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; }

    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .page-title { font-size: 28px; font-weight: 700; }
    .page-subtitle { color: var(--text-muted); margin-top: 4px; }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;
      cursor: pointer; transition: all 0.2s; border: none; text-decoration: none;
    }
    .btn-primary { background: var(--gold); color: var(--dark); }
    .btn-primary:hover { background: var(--gold-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--dark-elevated); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--gold); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    .btn svg { width: 18px; height: 18px; }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
    .tab {
      padding: 10px 20px; border-radius: 8px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; color: var(--text-secondary);
    }
    .tab:hover { background: var(--dark-elevated); }
    .tab.active { background: var(--gold); color: var(--dark); }

    /* Cards */
    .card {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-size: 18px; font-weight: 600; }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px 16px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid var(--border); }
    tr:hover { background: var(--dark-elevated); }
    .product-name { font-weight: 600; }
    .product-sku { font-size: 12px; color: var(--text-muted); }
    .price { font-weight: 600; color: var(--success); }
    .badge {
      display: inline-block; padding: 4px 10px; border-radius: 20px;
      font-size: 12px; font-weight: 500;
    }
    .badge-success { background: rgba(34,197,94,0.15); color: var(--success); }
    .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .badge-info { background: rgba(59,130,246,0.15); color: var(--info); }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px 16px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none; border-color: var(--gold);
    }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    /* Upload Zone */
    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .upload-zone:hover { border-color: var(--gold); background: rgba(249,203,0,0.05); }
    .upload-zone.dragover { border-color: var(--gold); background: rgba(249,203,0,0.1); }
    .upload-icon { width: 48px; height: 48px; margin: 0 auto 16px; color: var(--text-muted); }
    .upload-text { color: var(--text-secondary); margin-bottom: 8px; }
    .upload-hint { font-size: 13px; color: var(--text-muted); }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center;
      z-index: 1000; padding: 20px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%; max-width: 700px; max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px; border-bottom: 1px solid var(--border);
    }
    .modal-title { font-size: 20px; font-weight: 700; }
    .modal-close {
      width: 36px; height: 36px; border-radius: 8px;
      background: var(--dark-elevated); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); transition: all 0.2s;
    }
    .modal-close:hover { background: var(--error); color: white; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-value { font-size: 32px; font-weight: 700; }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .stat-change { font-size: 12px; margin-top: 8px; }
    .stat-change.up { color: var(--success); }
    .stat-change.down { color: var(--error); }

    /* Import Results */
    .import-results { margin-top: 20px; max-height: 400px; overflow-y: auto; }
    .import-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px; border-radius: 8px; margin-bottom: 8px;
      background: var(--dark-elevated);
    }
    .import-item-name { font-weight: 500; }
    .import-item-meta { font-size: 13px; color: var(--text-muted); }

    /* Search */
    .search-bar {
      display: flex; gap: 12px; margin-bottom: 24px;
    }
    .search-input {
      flex: 1; padding: 12px 16px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px;
    }
    .search-input:focus { outline: none; border-color: var(--gold); }

    /* Loading */
    .loading { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { color: var(--text); margin-bottom: 8px; }

    /* Action buttons in table */
    .actions { display: flex; gap: 8px; }
    .action-btn {
      width: 32px; height: 32px; border-radius: 6px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text-muted);
    }
    .action-btn:hover { border-color: var(--gold); color: var(--gold); }
    .action-btn.delete:hover { border-color: var(--error); color: var(--error); }
    .action-btn svg { width: 16px; height: 16px; }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/account" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub">Admin Portal</div>
          </div>
        </a>
      </div>

      <nav class="nav-section">
        <div class="nav-section-title">Dashboard</div>
        <a href="/account/admin/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Overview
        </a>
        <a href="/account/admin/appointments.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Appointments
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Estimating</div>
        <a href="/account/admin/products.html" class="nav-item active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Products & Pricing
        </a>
        <a href="/account/admin/estimates.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Estimates
        </a>
        <a href="/account/admin/job-costing.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
          Job Costing
        </a>
        <a href="/account/?page=invoices" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          Invoices
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Website</div>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          View Site
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="page-header">
        <div>
          <h1 class="page-title">Products & Price Sheets</h1>
          <p class="page-subtitle">Manage your product catalog and import vendor price lists</p>
        </div>
        <div style="display: flex; gap: 12px;">
          <button class="btn btn-secondary" onclick="openImportModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Import Price Sheet
          </button>
          <button class="btn btn-primary" onclick="openProductModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Product
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statProducts">0</div>
          <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statCategories">0</div>
          <div class="stat-label">Categories</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statPriceSheets">0</div>
          <div class="stat-label">Price Sheets</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statActive">0</div>
          <div class="stat-label">Active Items</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="products">Products</div>
        <div class="tab" data-tab="price-sheets">Price Sheets</div>
        <div class="tab" data-tab="categories">Categories</div>
      </div>

      <!-- Search -->
      <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search products by name, SKU, or vendor...">
        <select class="form-select" style="width: 200px;" id="categoryFilter">
          <option value="">All Categories</option>
        </select>
      </div>

      <!-- Products Tab -->
      <div id="productsTab" class="tab-content">
        <div class="card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Our Price</th>
                  <th>Cost</th>
                  <th>Margin</th>
                  <th>Vendor</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="productsBody">
                <tr>
                  <td colspan="8" class="loading">
                    <div class="spinner"></div>
                    Loading products...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Price Sheets Tab -->
      <div id="priceSheetsTab" class="tab-content" style="display: none;">
        <div class="card">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Vendor</th>
                  <th>Products</th>
                  <th>Status</th>
                  <th>Uploaded</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="priceSheetsBody">
                <tr>
                  <td colspan="6" class="loading">
                    <div class="spinner"></div>
                    Loading price sheets...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Categories Tab -->
      <div id="categoriesTab" class="tab-content" style="display: none;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Product Categories</h3>
            <button class="btn btn-sm btn-primary" onclick="openCategoryModal()">Add Category</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Slug</th>
                  <th>Products</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="categoriesBody">
                <tr>
                  <td colspan="5" class="loading">
                    <div class="spinner"></div>
                    Loading categories...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Import Modal -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Import Price Sheet</h2>
        <button class="modal-close" onclick="closeImportModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Vendor Name</label>
          <input type="text" class="form-input" id="importVendor" placeholder="e.g., MSI Surfaces, Cambria, etc.">
        </div>

        <div class="form-group">
          <label class="form-label">Price Sheet Name</label>
          <input type="text" class="form-input" id="importName" placeholder="e.g., Q1 2026 Quartz Pricing">
        </div>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
          <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <div class="upload-text">Drop PDF or CSV here, or click to browse</div>
          <div class="upload-hint">Supports PDF price sheets and CSV files</div>
          <input type="file" id="fileInput" style="display:none" accept=".pdf,.csv,.xlsx">
        </div>

        <div id="importProgress" style="display: none; margin-top: 20px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div class="spinner" style="width: 24px; height: 24px; margin: 0;"></div>
            <span id="importStatus">Processing price sheet...</span>
          </div>
        </div>

        <div id="importResults" class="import-results" style="display: none;">
          <h4 style="margin-bottom: 12px;">Extracted Products</h4>
          <div id="importItemsList"></div>
        </div>
      </div>
      <div class="modal-footer" id="importFooter">
        <button class="btn btn-secondary" onclick="closeImportModal()">Cancel</button>
        <button class="btn btn-primary" id="importBtn" onclick="processImport()" disabled>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
          Import Products
        </button>
      </div>
    </div>
  </div>

  <!-- Product Modal -->
  <div class="modal-overlay" id="productModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="productModalTitle">Add Product</h2>
        <button class="modal-close" onclick="closeProductModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="productId">

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">SKU</label>
            <input type="text" class="form-input" id="productSku" placeholder="Product code">
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select class="form-select" id="productCategory"></select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Product Name *</label>
          <input type="text" class="form-input" id="productName" placeholder="Product name" required>
        </div>

        <div class="form-group">
          <label class="form-label">Description</label>
          <textarea class="form-textarea" id="productDescription" placeholder="Product description"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Unit Type</label>
            <select class="form-select" id="productUnit">
              <option value="sqft">Per Sq Ft</option>
              <option value="lnft">Per Linear Ft</option>
              <option value="each">Each</option>
              <option value="hour">Per Hour</option>
              <option value="job">Per Job</option>
              <option value="slab">Per Slab</option>
              <option value="piece">Per Piece</option>
              <option value="box">Per Box</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Vendor</label>
            <input type="text" class="form-input" id="productVendor" placeholder="Vendor name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Cost Price</label>
            <input type="number" class="form-input" id="productCost" placeholder="0.00" step="0.01">
            <div class="form-hint">What you pay</div>
          </div>
          <div class="form-group">
            <label class="form-label">Our Price *</label>
            <input type="number" class="form-input" id="productPrice" placeholder="0.00" step="0.01" required>
            <div class="form-hint">What you charge</div>
          </div>
          <div class="form-group">
            <label class="form-label">Min Price</label>
            <input type="number" class="form-input" id="productMinPrice" placeholder="0.00" step="0.01">
            <div class="form-hint">Lowest allowed</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="productActive" checked> Active
            </label>
          </div>
          <div class="form-group">
            <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="productWebsite"> Show on Website
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const API_URL = 'https://surprise-granite-email-api.onrender.com';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: 'sb-ypeypgwsycxcagncgdur-auth-token',
        flowType: 'pkce'
      }
    });

    let products = [];
    let categories = [];
    let priceSheets = [];
    let importedProducts = [];

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').style.display = 'block';
      });
    });

    // Load data
    async function loadData() {
      await Promise.all([loadProducts(), loadCategories(), loadPriceSheets()]);
      updateStats();
    }

    async function loadProducts() {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*, product_categories(name)')
          .order('name');

        if (error) throw error;
        products = data || [];
        renderProducts();
      } catch (e) {
        console.error('Load products error:', e);
        showEmptyState('productsBody', 'No products found', 'Add your first product or import a price sheet');
      }
    }

    async function loadCategories() {
      try {
        const { data, error } = await supabase
          .from('product_categories')
          .select('*')
          .order('sort_order');

        if (error) throw error;
        categories = data || [];
        renderCategories();
        populateCategorySelects();
      } catch (e) {
        console.error('Load categories error:', e);
        // Use default categories
        categories = [
          { id: '1', name: 'Countertops', slug: 'countertops' },
          { id: '2', name: 'Tile', slug: 'tile' },
          { id: '3', name: 'Flooring', slug: 'flooring' },
          { id: '4', name: 'Cabinets', slug: 'cabinets' },
          { id: '5', name: 'Sinks', slug: 'sinks' },
          { id: '6', name: 'Installation Labor', slug: 'labor' },
          { id: '7', name: 'Fabrication', slug: 'fabrication' },
          { id: '8', name: 'Edges', slug: 'edges' },
          { id: '9', name: 'Miscellaneous', slug: 'misc' }
        ];
        populateCategorySelects();
      }
    }

    async function loadPriceSheets() {
      try {
        const { data, error } = await supabase
          .from('price_sheets')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;
        priceSheets = data || [];
        renderPriceSheets();
      } catch (e) {
        console.error('Load price sheets error:', e);
        priceSheets = [];
        renderPriceSheets();
      }
    }

    function renderProducts() {
      const tbody = document.getElementById('productsBody');
      if (products.length === 0) {
        showEmptyState('productsBody', 'No products yet', 'Add products manually or import a price sheet');
        return;
      }

      tbody.innerHTML = products.map(p => {
        const margin = p.cost_price && p.our_price
          ? ((p.our_price - p.cost_price) / p.our_price * 100).toFixed(1)
          : '-';
        return `
          <tr>
            <td>
              <div class="product-name">${p.name}</div>
              ${p.sku ? `<div class="product-sku">${p.sku}</div>` : ''}
            </td>
            <td>${p.product_categories?.name || p.category_id || '-'}</td>
            <td class="price">$${(p.our_price || 0).toFixed(2)}/${p.unit_type || 'ea'}</td>
            <td>${p.cost_price ? '$' + p.cost_price.toFixed(2) : '-'}</td>
            <td>${margin}%</td>
            <td>${p.vendor_name || '-'}</td>
            <td>
              <span class="badge ${p.is_active ? 'badge-success' : 'badge-warning'}">
                ${p.is_active ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>
              <div class="actions">
                <button class="action-btn" onclick="editProduct('${p.id}')" title="Edit">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="action-btn delete" onclick="deleteProduct('${p.id}')" title="Delete">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderCategories() {
      const tbody = document.getElementById('categoriesBody');
      if (categories.length === 0) {
        showEmptyState('categoriesBody', 'No categories', 'Add categories to organize products');
        return;
      }

      tbody.innerHTML = categories.map(c => {
        const count = products.filter(p => p.category_id === c.id).length;
        return `
          <tr>
            <td><strong>${c.name}</strong></td>
            <td><code>${c.slug}</code></td>
            <td>${count}</td>
            <td>
              <span class="badge ${c.is_active !== false ? 'badge-success' : 'badge-warning'}">
                ${c.is_active !== false ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>
              <div class="actions">
                <button class="action-btn" onclick="editCategory('${c.id}')" title="Edit">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderPriceSheets() {
      const tbody = document.getElementById('priceSheetsBody');
      if (priceSheets.length === 0) {
        showEmptyState('priceSheetsBody', 'No price sheets imported', 'Import your first vendor price sheet');
        return;
      }

      tbody.innerHTML = priceSheets.map(ps => `
        <tr>
          <td><strong>${ps.name}</strong></td>
          <td>${ps.vendor_name || '-'}</td>
          <td>${ps.processed_items || 0} / ${ps.total_items || 0}</td>
          <td>
            <span class="badge badge-${ps.status === 'completed' ? 'success' : ps.status === 'failed' ? 'error' : 'info'}">
              ${ps.status}
            </span>
          </td>
          <td>${new Date(ps.created_at).toLocaleDateString()}</td>
          <td>
            <div class="actions">
              <button class="action-btn delete" onclick="deletePriceSheet('${ps.id}')" title="Delete">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function populateCategorySelects() {
      const options = '<option value="">Select category</option>' +
        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
      document.getElementById('productCategory').innerHTML = options;
      document.getElementById('categoryFilter').innerHTML = '<option value="">All Categories</option>' +
        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    function showEmptyState(tbodyId, title, text) {
      document.getElementById(tbodyId).innerHTML = `
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/>
                <line x1="7" y1="7" x2="7.01" y2="7"/>
              </svg>
              <h3>${title}</h3>
              <p>${text}</p>
            </div>
          </td>
        </tr>
      `;
    }

    function updateStats() {
      document.getElementById('statProducts').textContent = products.length;
      document.getElementById('statCategories').textContent = categories.length;
      document.getElementById('statPriceSheets').textContent = priceSheets.length;
      document.getElementById('statActive').textContent = products.filter(p => p.is_active).length;
    }

    // Modal functions
    function openImportModal() {
      document.getElementById('importModal').classList.add('open');
      document.getElementById('importProgress').style.display = 'none';
      document.getElementById('importResults').style.display = 'none';
      document.getElementById('importBtn').disabled = true;
      importedProducts = [];
    }

    function closeImportModal() {
      document.getElementById('importModal').classList.remove('open');
    }

    function openProductModal(product = null) {
      document.getElementById('productModal').classList.add('open');
      document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';

      if (product) {
        document.getElementById('productId').value = product.id;
        document.getElementById('productSku').value = product.sku || '';
        document.getElementById('productName').value = product.name || '';
        document.getElementById('productDescription').value = product.description || '';
        document.getElementById('productCategory').value = product.category_id || '';
        document.getElementById('productUnit').value = product.unit_type || 'each';
        document.getElementById('productVendor').value = product.vendor_name || '';
        document.getElementById('productCost').value = product.cost_price || '';
        document.getElementById('productPrice').value = product.our_price || '';
        document.getElementById('productMinPrice').value = product.min_price || '';
        document.getElementById('productActive').checked = product.is_active !== false;
        document.getElementById('productWebsite').checked = product.show_on_website || false;
      } else {
        document.getElementById('productId').value = '';
        document.getElementById('productSku').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productDescription').value = '';
        document.getElementById('productCategory').value = '';
        document.getElementById('productUnit').value = 'each';
        document.getElementById('productVendor').value = '';
        document.getElementById('productCost').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productMinPrice').value = '';
        document.getElementById('productActive').checked = true;
        document.getElementById('productWebsite').checked = false;
      }
    }

    function closeProductModal() {
      document.getElementById('productModal').classList.remove('open');
    }

    function editProduct(id) {
      const product = products.find(p => p.id === id);
      if (product) openProductModal(product);
    }

    async function saveProduct() {
      const id = document.getElementById('productId').value;
      const product = {
        sku: document.getElementById('productSku').value || null,
        name: document.getElementById('productName').value,
        description: document.getElementById('productDescription').value || null,
        category_id: document.getElementById('productCategory').value || null,
        unit_type: document.getElementById('productUnit').value,
        vendor_name: document.getElementById('productVendor').value || null,
        cost_price: parseFloat(document.getElementById('productCost').value) || null,
        our_price: parseFloat(document.getElementById('productPrice').value) || 0,
        min_price: parseFloat(document.getElementById('productMinPrice').value) || null,
        is_active: document.getElementById('productActive').checked,
        show_on_website: document.getElementById('productWebsite').checked
      };

      if (!product.name) {
        alert('Product name is required');
        return;
      }

      try {
        if (id) {
          const { error } = await supabase
            .from('products')
            .update(product)
            .eq('id', id);
          if (error) throw error;
        } else {
          const { error } = await supabase
            .from('products')
            .insert([product]);
          if (error) throw error;
        }

        closeProductModal();
        await loadProducts();
        updateStats();
      } catch (e) {
        console.error('Save product error:', e);
        alert('Error saving product: ' + e.message);
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const { error } = await supabase
          .from('products')
          .delete()
          .eq('id', id);
        if (error) throw error;

        await loadProducts();
        updateStats();
      } catch (e) {
        console.error('Delete product error:', e);
        alert('Error deleting product: ' + e.message);
      }
    }

    // File upload handling
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    async function handleFile(file) {
      const vendor = document.getElementById('importVendor').value || 'Unknown';
      const name = document.getElementById('importName').value || file.name;

      document.getElementById('importProgress').style.display = 'block';
      document.getElementById('importStatus').textContent = 'Uploading and processing...';

      try {
        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
          // Handle CSV
          const text = await file.text();
          const response = await fetch(`${API_URL}/api/price-sheets/parse-csv`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              csv_data: text,
              vendor_name: vendor
            })
          });

          const result = await response.json();
          if (result.success) {
            importedProducts = result.data.products;
            showImportResults();
          } else {
            throw new Error(result.error);
          }
        } else {
          // Handle PDF - convert to base64
          document.getElementById('importStatus').textContent = 'Analyzing price sheet with AI...';

          const base64 = await fileToBase64(file);
          const response = await fetch(`${API_URL}/api/price-sheets/parse`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              file_base64: base64,
              vendor_name: vendor
            })
          });

          const result = await response.json();
          if (result.success && result.data.products) {
            importedProducts = result.data.products;
            showImportResults();
          } else {
            throw new Error(result.error || 'Failed to parse price sheet');
          }
        }
      } catch (e) {
        console.error('Import error:', e);
        document.getElementById('importStatus').textContent = 'Error: ' + e.message;
      }
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
      });
    }

    function showImportResults() {
      document.getElementById('importProgress').style.display = 'none';
      document.getElementById('importResults').style.display = 'block';
      document.getElementById('importBtn').disabled = false;

      const list = document.getElementById('importItemsList');
      list.innerHTML = importedProducts.map((p, i) => `
        <div class="import-item">
          <div>
            <div class="import-item-name">${p.name}</div>
            <div class="import-item-meta">${p.category || 'Uncategorized'} â€¢ ${p.unit_type || 'each'}</div>
          </div>
          <div class="price">$${(p.our_price || 0).toFixed(2)}</div>
        </div>
      `).join('');
    }

    async function processImport() {
      if (importedProducts.length === 0) return;

      const vendor = document.getElementById('importVendor').value || 'Unknown';
      const name = document.getElementById('importName').value || 'Price Sheet';

      document.getElementById('importBtn').disabled = true;
      document.getElementById('importBtn').innerHTML = '<div class="spinner" style="width:18px;height:18px;margin:0;"></div> Importing...';

      try {
        // Create price sheet record
        const { data: priceSheet, error: psError } = await supabase
          .from('price_sheets')
          .insert([{
            name,
            vendor_name: vendor,
            file_type: 'pdf',
            status: 'processing',
            total_items: importedProducts.length
          }])
          .select()
          .single();

        // Insert products
        const productsToInsert = importedProducts.map(p => ({
          name: p.name,
          description: p.description,
          sku: p.sku,
          category_id: categories.find(c => c.slug === p.category)?.id || null,
          unit_type: p.unit_type || 'each',
          cost_price: p.cost_price,
          our_price: p.our_price || 0,
          vendor_name: p.vendor_name || vendor,
          price_sheet_id: priceSheet?.id,
          attributes: p.attributes,
          is_active: true
        }));

        const { error: prodError } = await supabase
          .from('products')
          .insert(productsToInsert);

        if (prodError) throw prodError;

        // Update price sheet status
        if (priceSheet) {
          await supabase
            .from('price_sheets')
            .update({
              status: 'completed',
              processed_items: importedProducts.length
            })
            .eq('id', priceSheet.id);
        }

        closeImportModal();
        await loadData();
        alert(`Successfully imported ${importedProducts.length} products!`);

      } catch (e) {
        console.error('Import error:', e);
        alert('Error importing products: ' + e.message);
        document.getElementById('importBtn').disabled = false;
        document.getElementById('importBtn').innerHTML = 'Import Products';
      }
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = products.filter(p =>
        p.name.toLowerCase().includes(query) ||
        (p.sku && p.sku.toLowerCase().includes(query)) ||
        (p.vendor_name && p.vendor_name.toLowerCase().includes(query))
      );
      renderFilteredProducts(filtered);
    });

    document.getElementById('categoryFilter').addEventListener('change', (e) => {
      const catId = e.target.value;
      const filtered = catId
        ? products.filter(p => p.category_id === catId)
        : products;
      renderFilteredProducts(filtered);
    });

    function renderFilteredProducts(filtered) {
      const tbody = document.getElementById('productsBody');
      if (filtered.length === 0) {
        showEmptyState('productsBody', 'No matching products', 'Try a different search term');
        return;
      }

      const originalProducts = products;
      products = filtered;
      renderProducts();
      products = originalProducts;
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
