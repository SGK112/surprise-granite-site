<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Job Costing | Admin Dashboard | Surprise Granite</title>
  <meta name="description" content="Track job costs and profitability."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Unified Navigation -->
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260111c">
  <script defer src="/js/unified-nav.js?v=20260111c"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --gold: #f9cb00;
      --gold-dark: #cca600;
      --dark: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text: #ffffff;
      --text-secondary: rgba(255,255,255,0.75);
      --text-muted: rgba(255,255,255,0.5);
      --border: rgba(255,255,255,0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text);
    }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .main { flex: 1; margin-left: 260px; padding: 32px; }

    /* Sidebar */
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text); }
    .sidebar-logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px; color: var(--dark);
    }
    .sidebar-logo-text { font-weight: 700; font-size: 16px; }
    .sidebar-logo-sub { font-size: 11px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }

    .nav-section { padding: 0 12px; margin-bottom: 24px; }
    .nav-section-title { padding: 8px 12px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px; border-radius: 8px; color: var(--text-secondary);
      text-decoration: none; transition: all 0.2s; margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--dark-elevated); color: var(--text); }
    .nav-item.active { background: rgba(249,203,0,0.1); color: var(--gold); }
    .nav-item svg { width: 20px; height: 20px; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; }

    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 28px; font-weight: 700; }
    .page-subtitle { color: var(--text-muted); margin-top: 4px; }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;
      cursor: pointer; transition: all 0.2s; border: none; text-decoration: none;
    }
    .btn-primary { background: var(--gold); color: var(--dark); }
    .btn-primary:hover { background: var(--gold-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--dark-elevated); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--gold); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    .btn svg { width: 18px; height: 18px; }

    /* Cards */
    .card {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 18px; font-weight: 600; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-card.profit { border-color: var(--success); background: rgba(34,197,94,0.05); }
    .stat-card.loss { border-color: var(--error); background: rgba(239,68,68,0.05); }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-value.positive { color: var(--success); }
    .stat-value.negative { color: var(--error); }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
    .stat-change { font-size: 12px; margin-top: 8px; }
    .stat-change.up { color: var(--success); }
    .stat-change.down { color: var(--error); }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px 16px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid var(--border); }
    tr:hover { background: var(--dark-elevated); }

    .badge {
      display: inline-block; padding: 4px 10px; border-radius: 20px;
      font-size: 12px; font-weight: 500;
    }
    .badge-success { background: rgba(34,197,94,0.15); color: var(--success); }
    .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .badge-info { background: rgba(59,130,246,0.15); color: var(--info); }
    .badge-danger { background: rgba(239,68,68,0.15); color: var(--error); }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px 16px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none; border-color: var(--gold);
    }
    .form-textarea { min-height: 80px; resize: vertical; font-family: inherit; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: flex-start; justify-content: center;
      z-index: 1000; padding: 20px; overflow-y: auto;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%; max-width: 800px;
      margin: 40px 0;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px; border-bottom: 1px solid var(--border);
    }
    .modal-title { font-size: 20px; font-weight: 700; }
    .modal-close {
      width: 36px; height: 36px; border-radius: 8px;
      background: var(--dark-elevated); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); transition: all 0.2s;
    }
    .modal-close:hover { background: var(--error); color: white; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; flex-wrap: wrap; }

    /* Search */
    .search-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .search-input {
      flex: 1; min-width: 200px; padding: 12px 16px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px;
    }
    .search-input:focus { outline: none; border-color: var(--gold); }

    /* Loading & Empty */
    .loading { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { color: var(--text); margin-bottom: 8px; }

    /* Actions */
    .actions { display: flex; gap: 8px; }
    .action-btn {
      width: 32px; height: 32px; border-radius: 6px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text-muted);
    }
    .action-btn:hover { border-color: var(--gold); color: var(--gold); }
    .action-btn.delete:hover { border-color: var(--error); color: var(--error); }
    .action-btn svg { width: 16px; height: 16px; }

    /* Cost Breakdown */
    .cost-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .cost-item {
      background: var(--dark-elevated);
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }
    .cost-item-value { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
    .cost-item-label { font-size: 12px; color: var(--text-muted); }

    /* Cost Entries */
    .cost-entries { margin-top: 20px; }
    .cost-entry {
      display: grid;
      grid-template-columns: 1fr 120px 100px 100px 40px;
      gap: 12px;
      padding: 12px;
      background: var(--dark-elevated);
      border-radius: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .cost-entry-header {
      display: grid;
      grid-template-columns: 1fr 120px 100px 100px 40px;
      gap: 12px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .cost-input {
      padding: 8px 12px;
      background: var(--dark-surface); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 14px;
    }
    .cost-input:focus { outline: none; border-color: var(--gold); }
    .remove-entry {
      width: 28px; height: 28px; border-radius: 6px;
      background: transparent; border: 1px solid var(--border);
      color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .remove-entry:hover { border-color: var(--error); color: var(--error); }

    /* Progress Bar */
    .progress-bar {
      height: 8px;
      background: var(--dark-elevated);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }
    .progress-fill {
      height: 100%;
      background: var(--gold);
      border-radius: 4px;
      transition: width 0.3s;
    }
    .progress-fill.over { background: var(--error); }

    /* Tabs */
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 16px; flex-wrap: wrap; }
    .tab {
      padding: 10px 20px; border-radius: 8px; font-weight: 500;
      cursor: pointer; transition: all 0.2s; color: var(--text-secondary);
    }
    .tab:hover { background: var(--dark-elevated); }
    .tab.active { background: var(--gold); color: var(--dark); }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
      .cost-entry { grid-template-columns: 1fr; }
      .cost-entry-header { display: none; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/account" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub">Admin Portal</div>
          </div>
        </a>
      </div>

      <nav class="nav-section">
        <div class="nav-section-title">Dashboard</div>
        <a href="/account/admin/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Overview
        </a>
        <a href="/account/admin/appointments.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Appointments
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Estimating</div>
        <a href="/account/admin/products.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Products & Pricing
        </a>
        <a href="/account/admin/estimates.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Estimates
        </a>
        <a href="/account/admin/job-costing.html" class="nav-item active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
          Job Costing
        </a>
        <a href="/account/?page=invoices" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          Invoices
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Website</div>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          View Site
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="page-header">
        <div>
          <h1 class="page-title">Job Costing</h1>
          <p class="page-subtitle">Track actual costs and profitability for each job</p>
        </div>
        <button class="btn btn-primary" onclick="openJobModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Job
        </button>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statActiveJobs">0</div>
          <div class="stat-label">Active Jobs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotalRevenue">$0</div>
          <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statTotalCosts">$0</div>
          <div class="stat-label">Total Costs</div>
        </div>
        <div class="stat-card profit" id="profitCard">
          <div class="stat-value positive" id="statProfit">$0</div>
          <div class="stat-label">Net Profit</div>
          <div class="stat-change up" id="statMargin">0% margin</div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="active">Active Jobs</div>
        <div class="tab" data-tab="completed">Completed</div>
        <div class="tab" data-tab="all">All Jobs</div>
      </div>

      <!-- Search -->
      <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search jobs by name, customer, or ID...">
        <select class="form-select" style="width: 160px;" id="statusFilter">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="completed">Completed</option>
          <option value="on_hold">On Hold</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>

      <!-- Jobs List -->
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Job</th>
                <th>Customer</th>
                <th>Estimated</th>
                <th>Actual Cost</th>
                <th>Variance</th>
                <th>Profit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="jobsBody">
              <tr>
                <td colspan="8" class="loading">
                  <div class="spinner"></div>
                  Loading jobs...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Job Modal -->
  <div class="modal-overlay" id="jobModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="jobModalTitle">New Job</h2>
        <button class="modal-close" onclick="closeJobModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="jobId">

        <!-- Job Info -->
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Job Name *</label>
            <input type="text" class="form-input" id="jobName" placeholder="e.g., Kitchen Countertop Install" required>
          </div>
          <div class="form-group">
            <label class="form-label">Customer Name</label>
            <input type="text" class="form-input" id="jobCustomer" placeholder="Customer name">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Linked Estimate</label>
            <select class="form-select" id="linkedEstimate">
              <option value="">No linked estimate</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="jobStatus">
              <option value="active">Active</option>
              <option value="on_hold">On Hold</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Budgeted Amount</label>
            <input type="number" class="form-input" id="budgetAmount" placeholder="0.00" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label">Contract Amount (Revenue)</label>
            <input type="number" class="form-input" id="contractAmount" placeholder="0.00" step="0.01">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Job Address</label>
          <input type="text" class="form-input" id="jobAddress" placeholder="123 Main St, Phoenix, AZ">
        </div>

        <!-- Cost Entries -->
        <h3 style="margin: 24px 0 16px; font-size: 16px;">Cost Entries</h3>
        <div class="cost-entry-header">
          <span>Description</span>
          <span>Category</span>
          <span>Qty</span>
          <span>Cost</span>
          <span></span>
        </div>
        <div class="cost-entries" id="costEntries">
          <!-- Cost entries will be added here -->
        </div>
        <button class="btn btn-secondary btn-sm" onclick="addCostEntry()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Cost Entry
        </button>

        <!-- Cost Summary -->
        <div class="cost-breakdown" style="margin-top: 24px;">
          <div class="cost-item">
            <div class="cost-item-value" id="laborTotal">$0.00</div>
            <div class="cost-item-label">Labor</div>
          </div>
          <div class="cost-item">
            <div class="cost-item-value" id="materialsTotal">$0.00</div>
            <div class="cost-item-label">Materials</div>
          </div>
          <div class="cost-item">
            <div class="cost-item-value" id="subcontractorTotal">$0.00</div>
            <div class="cost-item-label">Subcontractors</div>
          </div>
          <div class="cost-item">
            <div class="cost-item-value" id="overheadTotal">$0.00</div>
            <div class="cost-item-label">Overhead</div>
          </div>
          <div class="cost-item" style="background: var(--dark-surface); border: 1px solid var(--border);">
            <div class="cost-item-value" style="color: var(--gold);" id="grandTotal">$0.00</div>
            <div class="cost-item-label">Total Cost</div>
          </div>
        </div>

        <!-- Budget Progress -->
        <div style="margin-top: 16px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
            <span style="font-size: 13px; color: var(--text-secondary);">Budget Usage</span>
            <span style="font-size: 13px;" id="budgetPercent">0%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="budgetProgress" style="width: 0%;"></div>
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="jobNotes" placeholder="Job notes..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeJobModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveJob()">Save Job</button>
      </div>
    </div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    // Use global client if available
    const supabase = window._sgSupabaseClient || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: 'sb-ypeypgwsycxcagncgdur-auth-token',
        flowType: 'implicit',
        lock: false
      }
    });
    if (!window._sgSupabaseClient) window._sgSupabaseClient = supabase;

    let jobs = [];
    let estimates = [];
    let costEntryCount = 0;
    let currentTab = 'active';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setupTabs();
      setupSearch();
    });

    async function loadData() {
      await Promise.all([loadJobs(), loadEstimates()]);
      updateStats();
    }

    async function loadJobs() {
      try {
        const { data, error } = await supabase
          .from('job_costs')
          .select('*, job_cost_entries(*)')
          .order('created_at', { ascending: false });

        if (error) throw error;
        jobs = data || [];
        renderJobs();
      } catch (e) {
        console.error('Load jobs error:', e);
        // Demo data
        jobs = [
          {
            id: '1',
            job_name: 'Kitchen Countertop - Smith Residence',
            customer_name: 'John Smith',
            budget_amount: 5000,
            contract_amount: 6500,
            actual_cost: 4200,
            status: 'active',
            created_at: new Date().toISOString(),
            job_cost_entries: [
              { id: '1', description: 'Granite Slab', category: 'materials', quantity: 1, cost: 1800 },
              { id: '2', description: 'Installation Labor', category: 'labor', quantity: 8, cost: 400 },
              { id: '3', description: 'Fabrication', category: 'labor', quantity: 1, cost: 1200 },
              { id: '4', description: 'Sink Cutout', category: 'labor', quantity: 1, cost: 250 },
              { id: '5', description: 'Edge Profile', category: 'labor', quantity: 1, cost: 350 },
              { id: '6', description: 'Supplies', category: 'materials', quantity: 1, cost: 200 }
            ]
          },
          {
            id: '2',
            job_name: 'Bathroom Vanity - Davis Home',
            customer_name: 'Sarah Davis',
            budget_amount: 2500,
            contract_amount: 3200,
            actual_cost: 2100,
            status: 'completed',
            created_at: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
            job_cost_entries: []
          }
        ];
        renderJobs();
      }
    }

    async function loadEstimates() {
      try {
        const { data, error } = await supabase
          .from('estimates')
          .select('id, estimate_number, customer_name, total_amount')
          .order('created_at', { ascending: false });

        if (error) throw error;
        estimates = data || [];
        populateEstimateSelect();
      } catch (e) {
        console.error('Load estimates error:', e);
        estimates = [];
      }
    }

    function populateEstimateSelect() {
      const select = document.getElementById('linkedEstimate');
      select.innerHTML = '<option value="">No linked estimate</option>' +
        estimates.map(e => `<option value="${e.id}">${e.estimate_number || 'EST-' + e.id.slice(0,8)} - ${e.customer_name || 'Unknown'} ($${(e.total_amount || 0).toFixed(2)})</option>`).join('');
    }

    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentTab = tab.dataset.tab;
          renderJobs();
        });
      });
    }

    function setupSearch() {
      document.getElementById('searchInput').addEventListener('input', renderJobs);
      document.getElementById('statusFilter').addEventListener('change', renderJobs);
    }

    function renderJobs() {
      const tbody = document.getElementById('jobsBody');
      const search = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;

      let filtered = jobs.filter(job => {
        const matchesTab =
          currentTab === 'all' ||
          (currentTab === 'active' && job.status === 'active') ||
          (currentTab === 'completed' && job.status === 'completed');
        const matchesSearch = !search ||
          (job.job_name || '').toLowerCase().includes(search) ||
          (job.customer_name || '').toLowerCase().includes(search);
        const matchesStatus = !statusFilter || job.status === statusFilter;
        return matchesTab && matchesSearch && matchesStatus;
      });

      if (filtered.length === 0) {
        showEmptyState();
        return;
      }

      tbody.innerHTML = filtered.map(job => {
        const actualCost = calculateJobCost(job);
        const budget = job.budget_amount || 0;
        const contract = job.contract_amount || 0;
        const variance = budget - actualCost;
        const profit = contract - actualCost;
        const profitPercent = contract ? ((profit / contract) * 100).toFixed(1) : 0;

        const statusClass = {
          active: 'badge-info',
          completed: 'badge-success',
          on_hold: 'badge-warning',
          cancelled: 'badge-danger'
        }[job.status] || 'badge-info';

        return `
          <tr>
            <td>
              <div style="font-weight: 600;">${job.job_name || '-'}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${new Date(job.created_at).toLocaleDateString()}</div>
            </td>
            <td>${job.customer_name || '-'}</td>
            <td>$${budget.toFixed(2)}</td>
            <td>$${actualCost.toFixed(2)}</td>
            <td style="color: ${variance >= 0 ? 'var(--success)' : 'var(--error)'};">
              ${variance >= 0 ? '+' : ''}$${variance.toFixed(2)}
            </td>
            <td>
              <div style="font-weight: 600; color: ${profit >= 0 ? 'var(--success)' : 'var(--error)'};">
                $${profit.toFixed(2)}
              </div>
              <div style="font-size: 12px; color: var(--text-muted);">${profitPercent}%</div>
            </td>
            <td><span class="badge ${statusClass}">${job.status}</span></td>
            <td>
              <div class="actions">
                <button class="action-btn" onclick="editJob('${job.id}')" title="Edit">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="action-btn delete" onclick="deleteJob('${job.id}')" title="Delete">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showEmptyState() {
      document.getElementById('jobsBody').innerHTML = `
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"/>
                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
              </svg>
              <h3>No jobs found</h3>
              <p>Create a new job to start tracking costs</p>
            </div>
          </td>
        </tr>
      `;
    }

    function calculateJobCost(job) {
      if (!job.job_cost_entries || job.job_cost_entries.length === 0) {
        return job.actual_cost || 0;
      }
      return job.job_cost_entries.reduce((sum, entry) => {
        return sum + ((entry.quantity || 1) * (entry.cost || 0));
      }, 0);
    }

    function updateStats() {
      const activeJobs = jobs.filter(j => j.status === 'active').length;
      let totalRevenue = 0;
      let totalCosts = 0;

      jobs.forEach(job => {
        totalRevenue += job.contract_amount || 0;
        totalCosts += calculateJobCost(job);
      });

      const profit = totalRevenue - totalCosts;
      const margin = totalRevenue ? ((profit / totalRevenue) * 100).toFixed(1) : 0;

      document.getElementById('statActiveJobs').textContent = activeJobs;
      document.getElementById('statTotalRevenue').textContent = '$' + totalRevenue.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('statTotalCosts').textContent = '$' + totalCosts.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('statProfit').textContent = '$' + profit.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
      document.getElementById('statMargin').textContent = margin + '% margin';

      // Update profit card styling
      const profitCard = document.getElementById('profitCard');
      const profitValue = document.getElementById('statProfit');
      if (profit >= 0) {
        profitCard.classList.remove('loss');
        profitCard.classList.add('profit');
        profitValue.classList.remove('negative');
        profitValue.classList.add('positive');
      } else {
        profitCard.classList.remove('profit');
        profitCard.classList.add('loss');
        profitValue.classList.remove('positive');
        profitValue.classList.add('negative');
      }
    }

    // Modal Functions
    function openJobModal(job = null) {
      document.getElementById('jobModal').classList.add('open');
      document.getElementById('jobModalTitle').textContent = job ? 'Edit Job' : 'New Job';
      costEntryCount = 0;
      document.getElementById('costEntries').innerHTML = '';

      if (job) {
        document.getElementById('jobId').value = job.id;
        document.getElementById('jobName').value = job.job_name || '';
        document.getElementById('jobCustomer').value = job.customer_name || '';
        document.getElementById('linkedEstimate').value = job.estimate_id || '';
        document.getElementById('jobStatus').value = job.status || 'active';
        document.getElementById('budgetAmount').value = job.budget_amount || '';
        document.getElementById('contractAmount').value = job.contract_amount || '';
        document.getElementById('jobAddress').value = job.job_address || '';
        document.getElementById('jobNotes').value = job.notes || '';

        // Load cost entries
        if (job.job_cost_entries) {
          job.job_cost_entries.forEach(entry => addCostEntry(entry));
        }
      } else {
        document.getElementById('jobId').value = '';
        document.getElementById('jobName').value = '';
        document.getElementById('jobCustomer').value = '';
        document.getElementById('linkedEstimate').value = '';
        document.getElementById('jobStatus').value = 'active';
        document.getElementById('budgetAmount').value = '';
        document.getElementById('contractAmount').value = '';
        document.getElementById('jobAddress').value = '';
        document.getElementById('jobNotes').value = '';
        addCostEntry(); // Add one empty entry
      }

      calculateCostTotals();
    }

    function closeJobModal() {
      document.getElementById('jobModal').classList.remove('open');
    }

    function addCostEntry(entry = null) {
      costEntryCount++;
      const id = costEntryCount;
      const container = document.getElementById('costEntries');

      const div = document.createElement('div');
      div.className = 'cost-entry';
      div.id = `costEntry${id}`;
      div.innerHTML = `
        <input type="text" class="cost-input" id="desc${id}" placeholder="Description" value="${entry?.description || ''}" onchange="calculateCostTotals()">
        <select class="cost-input" id="cat${id}" onchange="calculateCostTotals()">
          <option value="labor" ${entry?.category === 'labor' ? 'selected' : ''}>Labor</option>
          <option value="materials" ${entry?.category === 'materials' ? 'selected' : ''}>Materials</option>
          <option value="subcontractor" ${entry?.category === 'subcontractor' ? 'selected' : ''}>Subcontractor</option>
          <option value="overhead" ${entry?.category === 'overhead' ? 'selected' : ''}>Overhead</option>
          <option value="other" ${entry?.category === 'other' ? 'selected' : ''}>Other</option>
        </select>
        <input type="number" class="cost-input" id="qty${id}" placeholder="Qty" value="${entry?.quantity || 1}" min="0" step="0.01" onchange="calculateCostTotals()">
        <input type="number" class="cost-input" id="cost${id}" placeholder="Cost" value="${entry?.cost || ''}" min="0" step="0.01" onchange="calculateCostTotals()">
        <button class="remove-entry" onclick="removeCostEntry(${id})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      `;
      container.appendChild(div);
      calculateCostTotals();
    }

    function removeCostEntry(id) {
      const entry = document.getElementById(`costEntry${id}`);
      if (entry) {
        entry.remove();
        calculateCostTotals();
      }
    }

    function calculateCostTotals() {
      let labor = 0, materials = 0, subcontractor = 0, overhead = 0;

      document.querySelectorAll('.cost-entry').forEach(entry => {
        const id = entry.id.replace('costEntry', '');
        const category = document.getElementById(`cat${id}`)?.value;
        const qty = parseFloat(document.getElementById(`qty${id}`)?.value) || 1;
        const cost = parseFloat(document.getElementById(`cost${id}`)?.value) || 0;
        const total = qty * cost;

        switch (category) {
          case 'labor': labor += total; break;
          case 'materials': materials += total; break;
          case 'subcontractor': subcontractor += total; break;
          case 'overhead': overhead += total; break;
          default: overhead += total;
        }
      });

      const grandTotal = labor + materials + subcontractor + overhead;
      const budget = parseFloat(document.getElementById('budgetAmount').value) || 0;
      const budgetPercent = budget ? Math.min(100, (grandTotal / budget) * 100) : 0;

      document.getElementById('laborTotal').textContent = '$' + labor.toFixed(2);
      document.getElementById('materialsTotal').textContent = '$' + materials.toFixed(2);
      document.getElementById('subcontractorTotal').textContent = '$' + subcontractor.toFixed(2);
      document.getElementById('overheadTotal').textContent = '$' + overhead.toFixed(2);
      document.getElementById('grandTotal').textContent = '$' + grandTotal.toFixed(2);
      document.getElementById('budgetPercent').textContent = budgetPercent.toFixed(0) + '%';

      const progressBar = document.getElementById('budgetProgress');
      progressBar.style.width = Math.min(100, budgetPercent) + '%';
      if (budgetPercent > 100) {
        progressBar.classList.add('over');
      } else {
        progressBar.classList.remove('over');
      }

      return { labor, materials, subcontractor, overhead, grandTotal };
    }

    async function saveJob() {
      const jobName = document.getElementById('jobName').value;
      if (!jobName) {
        alert('Job name is required');
        return;
      }

      const totals = calculateCostTotals();
      const jobId = document.getElementById('jobId').value;

      const job = {
        job_name: jobName,
        customer_name: document.getElementById('jobCustomer').value || null,
        estimate_id: document.getElementById('linkedEstimate').value || null,
        status: document.getElementById('jobStatus').value,
        budget_amount: parseFloat(document.getElementById('budgetAmount').value) || 0,
        contract_amount: parseFloat(document.getElementById('contractAmount').value) || 0,
        actual_cost: totals.grandTotal,
        labor_cost: totals.labor,
        materials_cost: totals.materials,
        subcontractor_cost: totals.subcontractor,
        overhead_cost: totals.overhead,
        job_address: document.getElementById('jobAddress').value || null,
        notes: document.getElementById('jobNotes').value || null
      };

      // Collect cost entries
      const costEntries = [];
      document.querySelectorAll('.cost-entry').forEach((entry, index) => {
        const id = entry.id.replace('costEntry', '');
        const description = document.getElementById(`desc${id}`)?.value;
        const category = document.getElementById(`cat${id}`)?.value;
        const qty = parseFloat(document.getElementById(`qty${id}`)?.value) || 1;
        const cost = parseFloat(document.getElementById(`cost${id}`)?.value) || 0;

        if (description || cost > 0) {
          costEntries.push({
            description: description || 'Unnamed',
            category: category,
            quantity: qty,
            cost: cost,
            total: qty * cost,
            sort_order: index
          });
        }
      });

      try {
        let savedJobId = jobId;

        if (jobId) {
          // Update existing job
          const { error } = await supabase
            .from('job_costs')
            .update(job)
            .eq('id', jobId);
          if (error) throw error;

          // Delete existing entries
          await supabase.from('job_cost_entries').delete().eq('job_id', jobId);
        } else {
          // Create new job
          const { data, error } = await supabase
            .from('job_costs')
            .insert(job)
            .select()
            .single();
          if (error) throw error;
          savedJobId = data.id;
        }

        // Insert cost entries
        if (costEntries.length > 0) {
          const entriesWithJob = costEntries.map(e => ({
            ...e,
            job_id: savedJobId
          }));
          const { error: entryError } = await supabase
            .from('job_cost_entries')
            .insert(entriesWithJob);
          if (entryError) throw entryError;
        }

        closeJobModal();
        await loadJobs();
        updateStats();
        alert('Job saved successfully!');
      } catch (e) {
        console.error('Save job error:', e);
        alert('Error saving job: ' + e.message);
      }
    }

    function editJob(id) {
      const job = jobs.find(j => j.id === id);
      if (job) openJobModal(job);
    }

    async function deleteJob(id) {
      if (!confirm('Are you sure you want to delete this job?')) return;

      try {
        // Delete entries first
        await supabase.from('job_cost_entries').delete().eq('job_id', id);
        // Delete job
        const { error } = await supabase.from('job_costs').delete().eq('id', id);
        if (error) throw error;

        await loadJobs();
        updateStats();
      } catch (e) {
        console.error('Delete job error:', e);
        alert('Error deleting job: ' + e.message);
      }
    }

    // Update totals when budget changes
    document.getElementById('budgetAmount')?.addEventListener('input', calculateCostTotals);
  </script>
</body>
</html>
