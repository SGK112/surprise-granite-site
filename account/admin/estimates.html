<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Estimates | Admin Dashboard | Surprise Granite</title>
  <meta name="description" content="Create and manage customer estimates."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>

  <!-- Unified Navigation -->
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260111c">
  <script defer src="/js/unified-nav.js?v=20260111c"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --gold: #f9cb00;
      --gold-dark: #cca600;
      --dark: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text: #ffffff;
      --text-secondary: rgba(255,255,255,0.75);
      --text-muted: rgba(255,255,255,0.5);
      --border: rgba(255,255,255,0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text);
    }

    /* Layout */
    .layout { display: flex; min-height: 100vh; }
    .sidebar {
      width: 260px;
      background: var(--dark-surface);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    .main { flex: 1; margin-left: 260px; padding: 32px; }

    /* Sidebar */
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 24px; }
    .sidebar-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--text); }
    .sidebar-logo-icon {
      width: 40px; height: 40px;
      background: linear-gradient(135deg, var(--gold), var(--gold-dark));
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 18px; color: var(--dark);
    }
    .sidebar-logo-text { font-weight: 700; font-size: 16px; }
    .sidebar-logo-sub { font-size: 11px; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }

    .nav-section { padding: 0 12px; margin-bottom: 24px; }
    .nav-section-title { padding: 8px 12px; font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 12px; border-radius: 8px; color: var(--text-secondary);
      text-decoration: none; transition: all 0.2s; margin-bottom: 4px;
    }
    .nav-item:hover { background: var(--dark-elevated); color: var(--text); }
    .nav-item.active { background: rgba(249,203,0,0.1); color: var(--gold); }
    .nav-item svg { width: 20px; height: 20px; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; }

    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 28px; font-weight: 700; }
    .page-subtitle { color: var(--text-muted); margin-top: 4px; }

    /* Buttons */
    .btn {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;
      cursor: pointer; transition: all 0.2s; border: none; text-decoration: none;
    }
    .btn-primary { background: var(--gold); color: var(--dark); }
    .btn-primary:hover { background: var(--gold-dark); transform: translateY(-1px); }
    .btn-secondary { background: var(--dark-elevated); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--gold); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    .btn svg { width: 18px; height: 18px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Cards */
    .card {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 18px; font-weight: 600; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 32px; }
    .stat-card {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-value { font-size: 28px; font-weight: 700; }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 12px 16px; font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
    td { padding: 16px; border-bottom: 1px solid var(--border); }
    tr:hover { background: var(--dark-elevated); }

    .badge {
      display: inline-block; padding: 4px 10px; border-radius: 20px;
      font-size: 12px; font-weight: 500;
    }
    .badge-success { background: rgba(34,197,94,0.15); color: var(--success); }
    .badge-warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .badge-info { background: rgba(59,130,246,0.15); color: var(--info); }
    .badge-danger { background: rgba(239,68,68,0.15); color: var(--error); }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    .form-label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input, .form-select, .form-textarea {
      width: 100%; padding: 12px 16px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none; border-color: var(--gold);
    }
    .form-textarea { min-height: 80px; resize: vertical; font-family: inherit; }
    .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
    .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 4px; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: flex-start; justify-content: center;
      z-index: 1000; padding: 20px; overflow-y: auto;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%; max-width: 900px;
      margin: 40px 0;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 24px; border-bottom: 1px solid var(--border);
    }
    .modal-title { font-size: 20px; font-weight: 700; }
    .modal-close {
      width: 36px; height: 36px; border-radius: 8px;
      background: var(--dark-elevated); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: var(--text-muted); transition: all 0.2s;
    }
    .modal-close:hover { background: var(--error); color: white; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 20px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; flex-wrap: wrap; }

    /* Search Bar */
    .search-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .search-input {
      flex: 1; min-width: 200px; padding: 12px 16px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 14px;
    }
    .search-input:focus { outline: none; border-color: var(--gold); }

    /* Loading & Empty */
    .loading { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { color: var(--text); margin-bottom: 8px; }

    /* Action buttons */
    .actions { display: flex; gap: 8px; }
    .action-btn {
      width: 32px; height: 32px; border-radius: 6px;
      background: var(--dark-elevated); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text-muted);
    }
    .action-btn:hover { border-color: var(--gold); color: var(--gold); }
    .action-btn.delete:hover { border-color: var(--error); color: var(--error); }
    .action-btn svg { width: 16px; height: 16px; }

    /* Line Items */
    .line-items { margin: 20px 0; }
    .line-item {
      display: grid;
      grid-template-columns: 1fr 100px 100px 100px 50px;
      gap: 12px;
      padding: 12px;
      background: var(--dark-elevated);
      border-radius: 8px;
      margin-bottom: 8px;
      align-items: center;
    }
    .line-item-header {
      display: grid;
      grid-template-columns: 1fr 100px 100px 100px 50px;
      gap: 12px;
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .line-input {
      padding: 8px 12px;
      background: var(--dark-surface); border: 1px solid var(--border);
      border-radius: 6px; color: var(--text); font-size: 14px;
    }
    .line-input:focus { outline: none; border-color: var(--gold); }
    .line-total { font-weight: 600; text-align: right; color: var(--success); }
    .remove-line {
      width: 28px; height: 28px; border-radius: 6px;
      background: transparent; border: 1px solid var(--border);
      color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .remove-line:hover { border-color: var(--error); color: var(--error); }

    /* Totals Section */
    .totals {
      margin-top: 20px;
      padding: 20px;
      background: var(--dark-elevated);
      border-radius: 12px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }
    .total-row:last-child { border-bottom: none; }
    .total-row.grand {
      font-size: 18px;
      font-weight: 700;
      padding-top: 16px;
      margin-top: 8px;
      border-top: 2px solid var(--gold);
    }
    .total-row.grand .total-amount { color: var(--gold); }

    /* Product Search Popup */
    .product-search-container { position: relative; }
    .product-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--dark-surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 250px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .product-dropdown.open { display: block; }
    .product-option {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    .product-option:hover { background: var(--dark-elevated); }
    .product-option:last-child { border-bottom: none; }
    .product-option-name { font-weight: 500; }
    .product-option-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }

    /* Customer Info Section */
    .customer-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
      padding: 20px;
      background: var(--dark-elevated);
      border-radius: 12px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
      .line-item { grid-template-columns: 1fr; }
      .line-item-header { display: none; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="/account" class="sidebar-logo">
          <div class="sidebar-logo-icon">SG</div>
          <div>
            <div class="sidebar-logo-text">Surprise Granite</div>
            <div class="sidebar-logo-sub">Admin Portal</div>
          </div>
        </a>
      </div>

      <nav class="nav-section">
        <div class="nav-section-title">Dashboard</div>
        <a href="/account/admin/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          Overview
        </a>
        <a href="/account/admin/appointments.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Appointments
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Estimating</div>
        <a href="/account/admin/products.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
          Products & Pricing
        </a>
        <a href="/account/admin/estimates.html" class="nav-item active">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
          Estimates
        </a>
        <a href="/account/admin/job-costing.html" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
          Job Costing
        </a>
        <a href="/account/?page=invoices" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
          Invoices
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">Website</div>
        <a href="/" class="nav-item">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>
          View Site
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="page-header">
        <div>
          <h1 class="page-title">Estimates</h1>
          <p class="page-subtitle">Create and manage customer estimates</p>
        </div>
        <button class="btn btn-primary" onclick="openEstimateModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Estimate
        </button>
      </div>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">Total Estimates</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statDraft">0</div>
          <div class="stat-label">Drafts</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statSent">0</div>
          <div class="stat-label">Sent</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statAccepted">0</div>
          <div class="stat-label">Accepted</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statValue">$0</div>
          <div class="stat-label">Total Value</div>
        </div>
      </div>

      <!-- Search & Filters -->
      <div class="search-bar">
        <input type="text" class="search-input" id="searchInput" placeholder="Search by estimate #, customer name, or email...">
        <select class="form-select" style="width: 160px;" id="statusFilter">
          <option value="">All Statuses</option>
          <option value="draft">Draft</option>
          <option value="sent">Sent</option>
          <option value="viewed">Viewed</option>
          <option value="accepted">Accepted</option>
          <option value="invoiced">Invoiced</option>
          <option value="declined">Declined</option>
          <option value="expired">Expired</option>
        </select>
      </div>

      <!-- Estimates List -->
      <div class="card">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Estimate #</th>
                <th>Customer</th>
                <th>Date</th>
                <th>Expires</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="estimatesBody">
              <tr>
                <td colspan="7" class="loading">
                  <div class="spinner"></div>
                  Loading estimates...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Estimate Modal -->
  <div class="modal-overlay" id="estimateModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="estimateModalTitle">New Estimate</h2>
        <button class="modal-close" onclick="closeEstimateModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="estimateId">

        <!-- Customer Information -->
        <h3 style="margin-bottom: 16px; font-size: 16px;">Customer Information</h3>
        <div class="customer-section">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-input" id="customerName" placeholder="Full name" required>
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="customerEmail" placeholder="email@example.com">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="customerPhone" placeholder="(602) 833-3189">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Project Address</label>
            <input type="text" class="form-input" id="projectAddress" placeholder="123 Main St, Phoenix, AZ">
          </div>
        </div>

        <!-- Estimate Details -->
        <div class="form-row" style="margin-bottom: 20px;">
          <div class="form-group">
            <label class="form-label">Estimate Number</label>
            <input type="text" class="form-input" id="estimateNumber" placeholder="Auto-generated">
            <div class="form-hint">Leave blank to auto-generate</div>
          </div>
          <div class="form-group">
            <label class="form-label">Valid Until</label>
            <input type="date" class="form-input" id="validUntil">
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="estimateStatus">
              <option value="draft">Draft</option>
              <option value="sent">Sent</option>
              <option value="accepted">Accepted</option>
              <option value="declined">Declined</option>
            </select>
          </div>
        </div>

        <!-- Line Items -->
        <h3 style="margin-bottom: 16px; font-size: 16px;">Line Items</h3>
        <div class="line-item-header">
          <span>Product/Service</span>
          <span>Qty</span>
          <span>Unit Price</span>
          <span>Total</span>
          <span></span>
        </div>
        <div class="line-items" id="lineItems">
          <!-- Line items will be added here -->
        </div>
        <button class="btn btn-secondary btn-sm" onclick="addLineItem()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Line Item
        </button>

        <!-- Totals -->
        <div class="totals">
          <div class="total-row">
            <span>Subtotal</span>
            <span id="subtotalDisplay">$0.00</span>
          </div>
          <div class="total-row">
            <span>
              <span>Discount</span>
              <input type="number" class="line-input" id="discountPercent" value="0" min="0" max="100" style="width: 60px; margin-left: 8px;" onchange="calculateTotals()">%
            </span>
            <span id="discountDisplay">-$0.00</span>
          </div>
          <div class="total-row">
            <span>
              <span>Tax</span>
              <input type="number" class="line-input" id="taxPercent" value="8.6" min="0" max="100" step="0.1" style="width: 60px; margin-left: 8px;" onchange="calculateTotals()">%
            </span>
            <span id="taxDisplay">$0.00</span>
          </div>
          <div class="total-row grand">
            <span>Grand Total</span>
            <span class="total-amount" id="grandTotalDisplay">$0.00</span>
          </div>
        </div>

        <!-- Notes -->
        <div class="form-group" style="margin-top: 20px;">
          <label class="form-label">Notes / Terms</label>
          <textarea class="form-textarea" id="estimateNotes" placeholder="Additional notes, terms, or conditions..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEstimateModal()">Cancel</button>
        <button class="btn btn-secondary" onclick="saveEstimate('draft')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save Draft
        </button>
        <button class="btn btn-primary" onclick="saveEstimate('sent')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Save & Send
        </button>
      </div>
    </div>
  </div>

  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    // Use global client if available
    const supabase = window._sgSupabaseClient || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        storageKey: 'sb-ypeypgwsycxcagncgdur-auth-token',
        flowType: 'implicit',
        lock: false
      }
    });
    if (!window._sgSupabaseClient) window._sgSupabaseClient = supabase;

    let estimates = [];
    let products = [];
    let lineItemCount = 0;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      setupSearch();
      setDefaultDates();
    });

    async function loadData() {
      await Promise.all([loadEstimates(), loadProducts()]);
      updateStats();
    }

    async function loadEstimates() {
      try {
        const { data, error } = await supabase
          .from('estimates')
          .select('*, estimate_line_items(*)')
          .order('created_at', { ascending: false });

        if (error) throw error;
        estimates = data || [];
        renderEstimates();
      } catch (e) {
        console.error('Load estimates error:', e);
        showEmptyState();
      }
    }

    async function loadProducts() {
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .eq('is_active', true)
          .order('name');

        if (error) throw error;
        products = data || [];
      } catch (e) {
        console.error('Load products error:', e);
        // Demo products for testing
        products = [
          { id: '1', name: 'Granite Countertop Installation', our_price: 65, unit_type: 'sqft' },
          { id: '2', name: 'Quartz Countertop Installation', our_price: 75, unit_type: 'sqft' },
          { id: '3', name: 'Edge Profile - Bullnose', our_price: 15, unit_type: 'lnft' },
          { id: '4', name: 'Undermount Sink Cutout', our_price: 250, unit_type: 'each' },
          { id: '5', name: 'Cooktop Cutout', our_price: 200, unit_type: 'each' },
          { id: '6', name: 'Backsplash Installation', our_price: 35, unit_type: 'sqft' }
        ];
      }
    }

    function renderEstimates() {
      const tbody = document.getElementById('estimatesBody');

      if (estimates.length === 0) {
        showEmptyState();
        return;
      }

      tbody.innerHTML = estimates.map(est => {
        const statusClass = {
          draft: 'badge-info',
          sent: 'badge-warning',
          viewed: 'badge-warning',
          accepted: 'badge-success',
          invoiced: 'badge-success',
          declined: 'badge-danger',
          expired: 'badge-danger'
        }[est.status] || 'badge-info';

        return `
          <tr>
            <td><strong>${est.estimate_number || 'EST-' + est.id.slice(0,8)}</strong></td>
            <td>
              <div>${est.customer_name || '-'}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${est.customer_email || ''}</div>
            </td>
            <td>${new Date(est.created_at).toLocaleDateString()}</td>
            <td>${est.valid_until ? new Date(est.valid_until).toLocaleDateString() : '-'}</td>
            <td style="font-weight: 600; color: var(--success);">$${(est.total_amount || 0).toFixed(2)}</td>
            <td><span class="badge ${statusClass}">${est.status}</span></td>
            <td>
              <div class="actions">
                <button class="action-btn" onclick="editEstimate('${est.id}')" title="Edit">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
                <button class="action-btn" onclick="duplicateEstimate('${est.id}')" title="Duplicate">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>
                </button>
                <button class="action-btn" onclick="downloadEstimate('${est.id}')" title="Download PDF">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </button>
                <button class="action-btn" onclick="convertToInvoice('${est.id}')" title="Convert to Invoice" style="${est.status === 'accepted' ? '' : 'opacity: 0.3; pointer-events: none;'}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
                </button>
                <button class="action-btn delete" onclick="deleteEstimate('${est.id}')" title="Delete">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function showEmptyState() {
      document.getElementById('estimatesBody').innerHTML = `
        <tr>
          <td colspan="7">
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              <h3>No estimates yet</h3>
              <p>Create your first estimate to get started</p>
            </div>
          </td>
        </tr>
      `;
    }

    function updateStats() {
      const total = estimates.length;
      const draft = estimates.filter(e => e.status === 'draft').length;
      const sent = estimates.filter(e => ['sent', 'viewed'].includes(e.status)).length;
      const accepted = estimates.filter(e => e.status === 'accepted').length;
      const value = estimates.reduce((sum, e) => sum + (e.total_amount || 0), 0);

      document.getElementById('statTotal').textContent = total;
      document.getElementById('statDraft').textContent = draft;
      document.getElementById('statSent').textContent = sent;
      document.getElementById('statAccepted').textContent = accepted;
      document.getElementById('statValue').textContent = '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function setupSearch() {
      const searchInput = document.getElementById('searchInput');
      const statusFilter = document.getElementById('statusFilter');

      searchInput.addEventListener('input', filterEstimates);
      statusFilter.addEventListener('change', filterEstimates);
    }

    function filterEstimates() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;

      const filtered = estimates.filter(est => {
        const matchesSearch = !search ||
          (est.estimate_number || '').toLowerCase().includes(search) ||
          (est.customer_name || '').toLowerCase().includes(search) ||
          (est.customer_email || '').toLowerCase().includes(search);
        const matchesStatus = !status || est.status === status;
        return matchesSearch && matchesStatus;
      });

      renderFilteredEstimates(filtered);
    }

    function renderFilteredEstimates(filtered) {
      const original = estimates;
      estimates = filtered;
      renderEstimates();
      estimates = original;
    }

    function setDefaultDates() {
      const today = new Date();
      const validUntil = new Date(today);
      validUntil.setDate(validUntil.getDate() + 30);
      document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
    }

    // Modal functions
    function openEstimateModal(estimate = null) {
      document.getElementById('estimateModal').classList.add('open');
      document.getElementById('estimateModalTitle').textContent = estimate ? 'Edit Estimate' : 'New Estimate';
      lineItemCount = 0;
      document.getElementById('lineItems').innerHTML = '';

      if (estimate) {
        document.getElementById('estimateId').value = estimate.id;
        document.getElementById('customerName').value = estimate.customer_name || '';
        document.getElementById('customerEmail').value = estimate.customer_email || '';
        document.getElementById('customerPhone').value = estimate.customer_phone || '';
        document.getElementById('projectAddress').value = estimate.project_address || '';
        document.getElementById('estimateNumber').value = estimate.estimate_number || '';
        document.getElementById('validUntil').value = estimate.valid_until ? estimate.valid_until.split('T')[0] : '';
        document.getElementById('estimateStatus').value = estimate.status || 'draft';
        document.getElementById('discountPercent').value = estimate.discount_percent || 0;
        document.getElementById('taxPercent').value = estimate.tax_percent || 8.6;
        document.getElementById('estimateNotes').value = estimate.notes || '';

        // Load line items
        if (estimate.estimate_line_items) {
          estimate.estimate_line_items.forEach(item => {
            addLineItem(item);
          });
        }
      } else {
        document.getElementById('estimateId').value = '';
        document.getElementById('customerName').value = '';
        document.getElementById('customerEmail').value = '';
        document.getElementById('customerPhone').value = '';
        document.getElementById('projectAddress').value = '';
        document.getElementById('estimateNumber').value = '';
        document.getElementById('estimateStatus').value = 'draft';
        document.getElementById('discountPercent').value = 0;
        document.getElementById('taxPercent').value = 8.6;
        document.getElementById('estimateNotes').value = '';
        setDefaultDates();
        addLineItem(); // Add one empty line item
      }

      calculateTotals();
    }

    function closeEstimateModal() {
      document.getElementById('estimateModal').classList.remove('open');
    }

    function addLineItem(item = null) {
      lineItemCount++;
      const id = lineItemCount;
      const container = document.getElementById('lineItems');

      const div = document.createElement('div');
      div.className = 'line-item';
      div.id = `lineItem${id}`;
      div.innerHTML = `
        <div class="product-search-container">
          <input type="text" class="line-input" id="product${id}" placeholder="Search products..."
                 value="${item ? (item.description || item.product_name || '') : ''}"
                 onfocus="showProductDropdown(${id})"
                 oninput="filterProducts(${id})"
                 onblur="setTimeout(() => hideProductDropdown(${id}), 200)">
          <input type="hidden" id="productId${id}" value="${item?.product_id || ''}">
          <div class="product-dropdown" id="dropdown${id}"></div>
        </div>
        <input type="number" class="line-input" id="qty${id}" placeholder="Qty" value="${item?.quantity || 1}" min="0" step="0.01" onchange="calculateTotals()">
        <input type="number" class="line-input" id="price${id}" placeholder="Price" value="${item?.unit_price || ''}" min="0" step="0.01" onchange="calculateTotals()">
        <div class="line-total" id="total${id}">$0.00</div>
        <button class="remove-line" onclick="removeLineItem(${id})">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      `;
      container.appendChild(div);
      calculateTotals();
    }

    function removeLineItem(id) {
      const item = document.getElementById(`lineItem${id}`);
      if (item) {
        item.remove();
        calculateTotals();
      }
    }

    function showProductDropdown(id) {
      filterProducts(id);
      document.getElementById(`dropdown${id}`).classList.add('open');
    }

    function hideProductDropdown(id) {
      document.getElementById(`dropdown${id}`).classList.remove('open');
    }

    function filterProducts(id) {
      const search = document.getElementById(`product${id}`).value.toLowerCase();
      const dropdown = document.getElementById(`dropdown${id}`);

      const filtered = products.filter(p =>
        p.name.toLowerCase().includes(search) ||
        (p.sku || '').toLowerCase().includes(search)
      ).slice(0, 10);

      dropdown.innerHTML = filtered.map(p => `
        <div class="product-option" onclick="selectProduct(${id}, '${p.id}', '${p.name.replace(/'/g, "\\'")}', ${p.our_price})">
          <div class="product-option-name">${p.name}</div>
          <div class="product-option-meta">$${p.our_price.toFixed(2)} per ${p.unit_type || 'unit'}</div>
        </div>
      `).join('') || '<div style="padding: 12px; color: var(--text-muted);">No products found</div>';
    }

    function selectProduct(id, productId, name, price) {
      document.getElementById(`product${id}`).value = name;
      document.getElementById(`productId${id}`).value = productId;
      document.getElementById(`price${id}`).value = price;
      hideProductDropdown(id);
      calculateTotals();
    }

    function calculateTotals() {
      let subtotal = 0;
      const lineItems = document.querySelectorAll('.line-item');

      lineItems.forEach(item => {
        const id = item.id.replace('lineItem', '');
        const qty = parseFloat(document.getElementById(`qty${id}`)?.value) || 0;
        const price = parseFloat(document.getElementById(`price${id}`)?.value) || 0;
        const total = qty * price;

        const totalEl = document.getElementById(`total${id}`);
        if (totalEl) totalEl.textContent = '$' + total.toFixed(2);

        subtotal += total;
      });

      const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
      const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;

      const discountAmount = subtotal * (discountPercent / 100);
      const afterDiscount = subtotal - discountAmount;
      const taxAmount = afterDiscount * (taxPercent / 100);
      const grandTotal = afterDiscount + taxAmount;

      document.getElementById('subtotalDisplay').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('discountDisplay').textContent = '-$' + discountAmount.toFixed(2);
      document.getElementById('taxDisplay').textContent = '$' + taxAmount.toFixed(2);
      document.getElementById('grandTotalDisplay').textContent = '$' + grandTotal.toFixed(2);

      return { subtotal, discountAmount, taxAmount, grandTotal };
    }

    async function saveEstimate(status = 'draft') {
      const customerName = document.getElementById('customerName').value;
      if (!customerName) {
        alert('Customer name is required');
        return;
      }

      const totals = calculateTotals();
      const estimateId = document.getElementById('estimateId').value;

      // Generate estimate number if not provided
      let estimateNumber = document.getElementById('estimateNumber').value;
      if (!estimateNumber) {
        const date = new Date();
        estimateNumber = `EST-${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
      }

      const estimate = {
        estimate_number: estimateNumber,
        customer_name: customerName,
        customer_email: document.getElementById('customerEmail').value || null,
        customer_phone: document.getElementById('customerPhone').value || null,
        project_address: document.getElementById('projectAddress').value || null,
        valid_until: document.getElementById('validUntil').value || null,
        status: status,
        subtotal: totals.subtotal,
        discount_percent: parseFloat(document.getElementById('discountPercent').value) || 0,
        discount_amount: totals.discountAmount,
        tax_percent: parseFloat(document.getElementById('taxPercent').value) || 0,
        tax_amount: totals.taxAmount,
        total_amount: totals.grandTotal,
        notes: document.getElementById('estimateNotes').value || null
      };

      // Collect line items
      const lineItems = [];
      document.querySelectorAll('.line-item').forEach((item, index) => {
        const id = item.id.replace('lineItem', '');
        const productId = document.getElementById(`productId${id}`)?.value;
        const description = document.getElementById(`product${id}`)?.value;
        const qty = parseFloat(document.getElementById(`qty${id}`)?.value) || 0;
        const price = parseFloat(document.getElementById(`price${id}`)?.value) || 0;

        if (description && qty > 0) {
          lineItems.push({
            product_id: productId || null,
            description: description,
            quantity: qty,
            unit_price: price,
            total_price: qty * price,
            sort_order: index
          });
        }
      });

      try {
        let savedEstimateId = estimateId;

        if (estimateId) {
          // Update existing estimate
          const { error } = await supabase
            .from('estimates')
            .update(estimate)
            .eq('id', estimateId);
          if (error) throw error;

          // Delete existing line items
          await supabase.from('estimate_line_items').delete().eq('estimate_id', estimateId);
        } else {
          // Create new estimate
          const { data, error } = await supabase
            .from('estimates')
            .insert(estimate)
            .select()
            .single();
          if (error) throw error;
          savedEstimateId = data.id;
        }

        // Insert line items
        if (lineItems.length > 0) {
          const lineItemsWithEstimate = lineItems.map(li => ({
            ...li,
            estimate_id: savedEstimateId
          }));
          const { error: liError } = await supabase
            .from('estimate_line_items')
            .insert(lineItemsWithEstimate);
          if (liError) throw liError;
        }

        // Send email if status is 'sent'
        if (status === 'sent' && estimate.customer_email) {
          await sendEstimateEmail(savedEstimateId, estimate);
        }

        closeEstimateModal();
        await loadEstimates();
        updateStats();
        alert(`Estimate ${status === 'sent' ? 'saved and sent' : 'saved'} successfully!`);
      } catch (e) {
        console.error('Save estimate error:', e);
        alert('Error saving estimate: ' + e.message);
      }
    }

    async function sendEstimateEmail(estimateId, estimate) {
      try {
        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/leads', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: estimate.customer_name,
            email: estimate.customer_email,
            phone: estimate.customer_phone || '',
            service: 'Estimate',
            source: 'admin-dashboard',
            message: `New estimate #${estimate.estimate_number} for $${estimate.total_amount.toFixed(2)}\n\nProject Address: ${estimate.project_address || 'N/A'}\nValid Until: ${estimate.valid_until || 'N/A'}\n\nNotes: ${estimate.notes || 'None'}`
          })
        });
        if (!response.ok) throw new Error('Email send failed');
      } catch (e) {
        console.error('Send email error:', e);
      }
    }

    function editEstimate(id) {
      const estimate = estimates.find(e => e.id === id);
      if (estimate) openEstimateModal(estimate);
    }

    async function duplicateEstimate(id) {
      const estimate = estimates.find(e => e.id === id);
      if (!estimate) return;

      const newEstimate = {
        ...estimate,
        id: undefined,
        estimate_number: undefined,
        status: 'draft',
        created_at: undefined,
        updated_at: undefined
      };

      openEstimateModal({
        ...newEstimate,
        estimate_line_items: estimate.estimate_line_items
      });
      document.getElementById('estimateId').value = ''; // Clear ID so it creates new
    }

    async function deleteEstimate(id) {
      if (!confirm('Are you sure you want to delete this estimate?')) return;

      try {
        // Delete line items first
        await supabase.from('estimate_line_items').delete().eq('estimate_id', id);
        // Delete estimate
        const { error } = await supabase.from('estimates').delete().eq('id', id);
        if (error) throw error;

        await loadEstimates();
        updateStats();
      } catch (e) {
        console.error('Delete estimate error:', e);
        alert('Error deleting estimate: ' + e.message);
      }
    }

    function downloadEstimate(id) {
      const estimate = estimates.find(e => e.id === id);
      if (!estimate) return;

      // Generate PDF using browser print
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Estimate ${estimate.estimate_number}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
            .header { display: flex; justify-content: space-between; margin-bottom: 40px; }
            .company { font-size: 24px; font-weight: bold; color: #1a1a2e; }
            .company-sub { color: #666; font-size: 14px; }
            .estimate-info { text-align: right; }
            .estimate-number { font-size: 20px; font-weight: bold; color: #f9cb00; }
            .customer { margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px; }
            .customer-title { font-weight: bold; margin-bottom: 10px; color: #333; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th { text-align: left; padding: 12px; background: #1a1a2e; color: white; }
            td { padding: 12px; border-bottom: 1px solid #ddd; }
            .totals { margin-top: 20px; text-align: right; }
            .total-row { padding: 8px 0; }
            .grand-total { font-size: 20px; font-weight: bold; color: #f9cb00; border-top: 2px solid #1a1a2e; padding-top: 10px; margin-top: 10px; }
            .notes { margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; }
            .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; }
          </style>
        </head>
        <body>
          <div class="header">
            <div>
              <div class="company">Surprise Granite</div>
              <div class="company-sub">Premium Stone & Tile Solutions</div>
              <div class="company-sub">Phone: (602) 833-3189</div>
              <div class="company-sub">www.surprisegranite.com</div>
            </div>
            <div class="estimate-info">
              <div class="estimate-number">${estimate.estimate_number}</div>
              <div>Date: ${new Date(estimate.created_at).toLocaleDateString()}</div>
              <div>Valid Until: ${estimate.valid_until ? new Date(estimate.valid_until).toLocaleDateString() : 'N/A'}</div>
            </div>
          </div>

          <div class="customer">
            <div class="customer-title">Customer Information</div>
            <div><strong>${estimate.customer_name}</strong></div>
            ${estimate.customer_email ? `<div>${estimate.customer_email}</div>` : ''}
            ${estimate.customer_phone ? `<div>${estimate.customer_phone}</div>` : ''}
            ${estimate.project_address ? `<div>${estimate.project_address}</div>` : ''}
          </div>

          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th>Qty</th>
                <th>Unit Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
              ${(estimate.estimate_line_items || []).map(li => `
                <tr>
                  <td>${li.description || li.product_name || '-'}</td>
                  <td>${li.quantity}</td>
                  <td>$${(li.unit_price || 0).toFixed(2)}</td>
                  <td>$${(li.total_price || 0).toFixed(2)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="totals">
            <div class="total-row">Subtotal: $${(estimate.subtotal || 0).toFixed(2)}</div>
            ${estimate.discount_amount ? `<div class="total-row">Discount (${estimate.discount_percent}%): -$${estimate.discount_amount.toFixed(2)}</div>` : ''}
            <div class="total-row">Tax (${estimate.tax_percent || 0}%): $${(estimate.tax_amount || 0).toFixed(2)}</div>
            <div class="grand-total">Total: $${(estimate.total_amount || 0).toFixed(2)}</div>
          </div>

          ${estimate.notes ? `<div class="notes"><strong>Notes:</strong><br>${estimate.notes}</div>` : ''}

          <div class="footer">
            <p>Thank you for your business!</p>
            <p>Surprise Granite - Quality Craftsmanship, Exceptional Service</p>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    async function convertToInvoice(id) {
      const estimate = estimates.find(e => e.id === id);
      if (!estimate) return;

      if (estimate.status !== 'accepted') {
        alert('Only accepted estimates can be converted to invoices.');
        return;
      }

      if (!estimate.customer_email) {
        alert('Customer email is required to create an invoice. Please edit the estimate and add an email address.');
        return;
      }

      if (!confirm(`Convert estimate ${estimate.estimate_number} to an invoice and send to ${estimate.customer_email}?`)) {
        return;
      }

      try {
        // Prepare line items for invoice
        const items = (estimate.estimate_line_items || []).map(li => ({
          description: li.description || li.product_name || 'Service',
          quantity: li.quantity || 1,
          amount: li.unit_price || 0
        }));

        // If no line items, create one from total
        if (items.length === 0) {
          items.push({
            description: 'Services per estimate ' + estimate.estimate_number,
            quantity: 1,
            amount: estimate.total_amount || 0
          });
        }

        const invoiceData = {
          customer_email: estimate.customer_email,
          customer_name: estimate.customer_name,
          customer_phone: estimate.customer_phone || '',
          items: items,
          due_days: 30,
          notes: `Converted from Estimate ${estimate.estimate_number}\n${estimate.notes || ''}`,
          template: 'classic'
        };

        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/invoices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(invoiceData)
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to create invoice');
        }

        // Update estimate status to show it was converted
        await supabase
          .from('estimates')
          .update({ status: 'invoiced', converted_to_invoice: data.invoice?.id })
          .eq('id', id);

        await loadEstimates();
        alert(`Invoice #${data.invoice?.number || 'N/A'} created and sent to ${estimate.customer_email}!\n\nView in Account Portal > Invoices`);

      } catch (e) {
        console.error('Convert to invoice error:', e);
        alert('Error creating invoice: ' + e.message + '\n\nMake sure the Invoice API is running.');
      }
    }

    // Add keyboard shortcut for quick actions
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeEstimateModal();
      }
      if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        openEstimateModal();
      }
    });
  </script>
</body>
</html>
