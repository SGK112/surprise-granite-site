<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Billing & Payouts | Vendor Dashboard | Surprise Granite</title>
  <meta name="description" content="Manage your subscription and payouts."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260110c">
  <script defer src="/js/unified-nav.js?v=20260110e"></script>
  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --gold-glow: rgba(249, 203, 0, 0.35);
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --sidebar-width: 260px;
      --nav-height: 140px;
    }
    @media (max-width: 991px) { :root { --nav-height: 64px; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--dark-deep); min-height: 100vh; color: var(--text-primary); }
    .dashboard-layout { display: flex; min-height: 100vh; padding-top: var(--nav-height); }
    .sidebar { position: fixed; left: 0; top: var(--nav-height); bottom: 0; width: var(--sidebar-width); background: var(--dark-surface); border-right: 1px solid var(--border-subtle); padding: 24px 0; overflow-y: auto; z-index: 100; }
    @media (max-width: 991px) { .sidebar { transform: translateX(-100%); transition: transform 0.3s; } .sidebar.open { transform: translateX(0); } }
    .sidebar-header { padding: 0 20px 24px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 20px; }
    .sidebar-business { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .sidebar-plan { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gold-primary); background: rgba(249, 203, 0, 0.1); padding: 4px 10px; border-radius: 100px; }
    .sidebar-nav { padding: 0 12px; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
    .nav-item.active { background: rgba(249, 203, 0, 0.1); color: var(--gold-primary); }
    .nav-item svg { width: 20px; height: 20px; opacity: 0.7; }
    .nav-badge { margin-left: auto; background: var(--gold-primary); color: var(--dark-primary); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 100px; }
    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 32px; }
    @media (max-width: 991px) { .main-content { margin-left: 0; padding: 20px; } }
    .mobile-menu-btn { display: none; position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--gold-primary); border: none; border-radius: 50%; color: var(--dark-primary); cursor: pointer; z-index: 101; }
    @media (max-width: 991px) { .mobile-menu-btn { display: flex; align-items: center; justify-content: center; } }
    .page-header { margin-bottom: 32px; }
    .page-title { font-size: 28px; font-weight: 800; }
    .page-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
    .card { background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; }
    .plan-card { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .plan-icon { width: 64px; height: 64px; background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)); border-radius: 16px; display: flex; align-items: center; justify-content: center; }
    .plan-icon svg { width: 32px; height: 32px; color: var(--dark-primary); stroke: var(--dark-primary); }
    .plan-info { flex: 1; min-width: 200px; }
    .plan-name { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .plan-price { font-size: 14px; color: var(--text-muted); }
    .plan-features { margin-top: 12px; display: flex; gap: 16px; flex-wrap: wrap; }
    .plan-feature { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--text-secondary); }
    .plan-feature svg { width: 16px; height: 16px; color: var(--success); stroke: var(--success); }
    .connect-card { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .connect-icon { width: 64px; height: 64px; background: var(--dark-elevated); border-radius: 16px; display: flex; align-items: center; justify-content: center; }
    .connect-icon.connected { background: rgba(34, 197, 94, 0.15); }
    .connect-icon svg { width: 32px; height: 32px; color: var(--text-muted); stroke: var(--text-muted); }
    .connect-icon.connected svg { color: var(--success); stroke: var(--success); }
    .connect-info { flex: 1; min-width: 200px; }
    .connect-status { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .connect-status.pending { color: var(--warning); }
    .connect-status.connected { color: var(--success); }
    .connect-desc { font-size: 13px; color: var(--text-muted); }
    .earnings-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
    @media (max-width: 768px) { .earnings-grid { grid-template-columns: 1fr; } }
    .earnings-stat { background: var(--dark-elevated); border-radius: 12px; padding: 20px; text-align: center; }
    .earnings-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
    .earnings-label { font-size: 13px; color: var(--text-muted); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)); color: var(--dark-primary); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 16px var(--gold-glow); }
    .btn-secondary { background: var(--dark-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn svg { width: 18px; height: 18px; }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .loading-container { display: flex; align-items: center; justify-content: center; min-height: 400px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-subtle); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    @media (max-width: 991px) { .sidebar-overlay.active { display: block; } }
  </style>
</head>
<body>
  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-business" id="businessName">Loading...</div>
        <div class="sidebar-plan"><span id="planName">Free</span></div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="/vendor/dashboard/" class="nav-item">Dashboard</a>
          <a href="/vendor/dashboard/leads/" class="nav-item">Leads <span class="nav-badge" id="leadsCount">0</span></a>
          <a href="/vendor/dashboard/customers/" class="nav-item">Customers</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <a href="/vendor/dashboard/profile/" class="nav-item">Profile</a>
          <a href="/vendor/dashboard/billing/" class="nav-item active">Billing & Payouts</a>
          <a href="#" class="nav-item" onclick="logout()">Log Out</a>
        </div>
      </nav>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <main class="main-content">
      <div id="loadingState" class="loading-container"><div class="loading-spinner"></div></div>
      <div id="pageContent" style="display: none;">
        <header class="page-header">
          <h1 class="page-title">Billing & Payouts</h1>
          <p class="page-subtitle">Manage your subscription and marketplace earnings</p>
        </header>
        <section class="section">
          <h2 class="section-title">Your Plan</h2>
          <div class="card">
            <div class="plan-card">
              <div class="plan-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
              <div class="plan-info">
                <div class="plan-name" id="currentPlanName">Starter</div>
                <div class="plan-price" id="currentPlanPrice">Free</div>
                <div class="plan-features">
                  <span class="plan-feature"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span id="leadsIncluded">0 leads/month</span></span>
                  <span class="plan-feature"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span id="commissionRate">10% commission</span></span>
                </div>
              </div>
              <a href="/vendor/select-plan/" class="btn btn-primary">Upgrade Plan</a>
            </div>
          </div>
        </section>
        <section class="section">
          <h2 class="section-title">Payout Account</h2>
          <div class="card">
            <div class="connect-card">
              <div class="connect-icon" id="connectIcon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></div>
              <div class="connect-info">
                <div class="connect-status" id="connectStatus">Not Connected</div>
                <div class="connect-desc" id="connectDesc">Connect your bank account to receive marketplace payouts.</div>
              </div>
              <button class="btn btn-primary" id="connectBtn" onclick="setupStripeConnect()">Connect Bank Account</button>
            </div>
          </div>
        </section>
        <section class="section" id="earningsSection" style="display: none;">
          <h2 class="section-title">Earnings Summary</h2>
          <div class="card">
            <div class="earnings-grid">
              <div class="earnings-stat"><div class="earnings-value" id="totalEarnings">$0</div><div class="earnings-label">Total Earnings</div></div>
              <div class="earnings-stat"><div class="earnings-value" id="pendingPayout">$0</div><div class="earnings-label">Pending Payout</div></div>
              <div class="earnings-stat"><div class="earnings-value" id="lastPayout">$0</div><div class="earnings-label">Last Payout</div></div>
            </div>
            <button class="btn btn-secondary" onclick="openStripeDashboard()">View Full Dashboard</button>
          </div>
        </section>
        <section class="section">
          <h2 class="section-title">Recent Transactions</h2>
          <div class="card">
            <div id="transactionsList"><div class="empty-state"><p>No transactions yet.</p></div></div>
          </div>
        </section>
      </div>
    </main>
  </div>
  <button class="mobile-menu-btn" onclick="toggleSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
  <script>
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const API_BASE = 'https://surprise-granite-email-api.onrender.com';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let vendorProfile = null;
    let subscription = null;

    async function initPage() {
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error || !user) { window.location.href = '/vendor/signup/'; return; }
        const { data: profile } = await supabaseClient.from('vendor_profiles').select('*').eq('id', user.id).single();
        if (!profile) { window.location.href = '/vendor/signup/'; return; }
        vendorProfile = profile;
        const { data: sub } = await supabaseClient.from('vendor_subscriptions').select('*, subscription_plans(*)').eq('vendor_id', user.id).single();
        subscription = sub;
        document.getElementById('businessName').textContent = profile.business_name || 'Your Business';
        if (sub?.subscription_plans) {
          const plan = sub.subscription_plans;
          document.getElementById('planName').textContent = plan.display_name;
          document.getElementById('currentPlanName').textContent = plan.display_name;
          document.getElementById('currentPlanPrice').textContent = plan.price_monthly > 0 ? '$' + plan.price_monthly + '/month' : 'Free';
          document.getElementById('leadsIncluded').textContent = plan.leads_per_month ? plan.leads_per_month + ' leads/month' : 'Pay per lead';
          document.getElementById('commissionRate').textContent = (plan.marketplace_commission || 10) + '% commission';
        }
        if (sub?.stripe_connect_account_id) { await checkConnectStatus(sub.stripe_connect_account_id); }
        const { data: leads } = await supabaseClient.from('lead_distributions').select('id').eq('vendor_id', vendorProfile.id);
        document.getElementById('leadsCount').textContent = leads?.length || 0;
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('pageContent').style.display = 'block';
      } catch (err) {
        console.error('Init error:', err);
        document.getElementById('loadingState').innerHTML = '<p style="color: var(--error);">Error loading page.</p>';
      }
    }

    async function checkConnectStatus(accountId) {
      try {
        const response = await fetch(API_BASE + '/api/connect/accounts/' + accountId);
        if (!response.ok) return;
        const data = await response.json();
        const account = data.account;
        const icon = document.getElementById('connectIcon');
        const status = document.getElementById('connectStatus');
        const desc = document.getElementById('connectDesc');
        const btn = document.getElementById('connectBtn');
        if (account.payouts_enabled) {
          icon.classList.add('connected');
          status.textContent = 'Connected';
          status.classList.add('connected');
          desc.textContent = 'Your bank account is connected and ready to receive payouts.';
          btn.textContent = 'Manage Account';
          btn.onclick = openStripeDashboard;
          document.getElementById('earningsSection').style.display = 'block';
          document.getElementById('totalEarnings').textContent = formatCurrency(vendorProfile.total_revenue || 0);
        } else if (account.details_submitted) {
          status.textContent = 'Pending Verification';
          status.classList.add('pending');
          desc.textContent = 'Your account is being verified by Stripe.';
        }
      } catch (err) { console.error('Connect status error:', err); }
    }

    async function setupStripeConnect() {
      const btn = document.getElementById('connectBtn');
      btn.disabled = true;
      btn.innerHTML = 'Setting up...';
      try {
        const response = await fetch(API_BASE + '/api/connect/accounts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: vendorProfile.email, business_name: vendorProfile.business_name })
        });
        if (!response.ok) throw new Error('Failed to create account');
        const data = await response.json();
        if (subscription) {
          await supabaseClient.from('vendor_subscriptions').update({ stripe_connect_account_id: data.account_id }).eq('vendor_id', vendorProfile.id);
        }
        window.location.href = data.onboarding_url;
      } catch (err) {
        console.error('Setup Connect error:', err);
        alert('Failed to set up payout account. Please try again.');
        btn.disabled = false;
        btn.innerHTML = 'Connect Bank Account';
      }
    }

    async function openStripeDashboard() {
      if (!subscription?.stripe_connect_account_id) return;
      try {
        const response = await fetch(API_BASE + '/api/connect/accounts/' + subscription.stripe_connect_account_id + '/login', { method: 'POST' });
        if (!response.ok) throw new Error('Failed to get dashboard link');
        const data = await response.json();
        window.open(data.url, '_blank');
      } catch (err) { alert('Failed to open Stripe dashboard.'); }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(amount);
    }
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('active');
    }
    async function logout() { await supabaseClient.auth.signOut(); window.location.href = '/'; }
    initPage();
  </script>
</body>
</html>
