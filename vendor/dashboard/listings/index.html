<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>My Listings | Vendor Dashboard | Surprise Granite</title>
  <meta name="description" content="Manage your stone listings and remnants in the Surprise Granite marketplace."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260129">
  <script defer src="/js/unified-nav.js?v=20260201d"></script>

  <style>
    :root {
      --gold-primary: #f9cb00; --gold-dark: #cca600; --gold-glow: rgba(249, 203, 0, 0.35);
      --dark-primary: #1a1a2e; --dark-deep: #0a0a12; --dark-surface: #12121a; --dark-elevated: #1e1e2d;
      --text-primary: #ffffff; --text-secondary: rgba(255, 255, 255, 0.75); --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1); --success: #22c55e; --warning: #f59e0b; --error: #ef4444; --info: #3b82f6;
      --sidebar-width: 260px; --nav-height: 140px;
    }
    @media (max-width: 991px) { :root { --nav-height: 64px; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--dark-deep); min-height: 100vh; color: var(--text-primary); }
    .dashboard-layout { display: flex; min-height: 100vh; padding-top: var(--nav-height); }
    .sidebar { position: fixed; left: 0; top: var(--nav-height); bottom: 0; width: var(--sidebar-width); background: var(--dark-surface); border-right: 1px solid var(--border-subtle); padding: 24px 0; overflow-y: auto; z-index: 100; transition: transform 0.3s ease; }
    @media (max-width: 991px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } }
    .sidebar-header { padding: 0 20px 24px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 20px; }
    .sidebar-business { font-size: 16px; font-weight: 700; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sidebar-plan { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gold-primary); background: rgba(249, 203, 0, 0.1); padding: 4px 10px; border-radius: 100px; }
    .sidebar-nav { padding: 0 12px; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
    .nav-item.active { background: rgba(249, 203, 0, 0.1); color: var(--gold-primary); }
    .nav-item svg { width: 20px; height: 20px; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; }
    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 32px; max-width: 100%; }
    @media (max-width: 991px) { .main-content { margin-left: 0; padding: 20px; } }
    .mobile-menu-btn { display: none; position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--gold-primary); border: none; border-radius: 50%; color: var(--dark-primary); cursor: pointer; z-index: 101; box-shadow: 0 4px 20px var(--gold-glow); }
    .mobile-menu-btn svg { width: 24px; height: 24px; }
    @media (max-width: 991px) { .mobile-menu-btn { display: flex; align-items: center; justify-content: center; } }
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 28px; font-weight: 800; letter-spacing: -0.5px; }
    .page-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 32px; }
    @media (max-width: 700px) { .stats-row { grid-template-columns: 1fr; } }
    .stat-card { background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; text-align: center; }
    .stat-value { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
    .stat-label { font-size: 13px; color: var(--text-muted); }

    /* Listings Grid */
    .listings-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    @media (max-width: 1100px) { .listings-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .listings-grid { grid-template-columns: 1fr; } }

    .listing-card { background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 16px; overflow: hidden; transition: all 0.2s; }
    .listing-card:hover { border-color: rgba(255,255,255,0.2); transform: translateY(-4px); }
    .listing-image { height: 180px; background: var(--dark-elevated); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .listing-image img { width: 100%; height: 100%; object-fit: cover; }
    .listing-image-placeholder { color: var(--text-muted); font-size: 13px; }
    .listing-body { padding: 20px; }
    .listing-material { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gold-primary); font-weight: 600; margin-bottom: 6px; }
    .listing-name { font-size: 16px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; }
    .listing-details { display: flex; gap: 16px; font-size: 13px; color: var(--text-muted); margin-bottom: 12px; }
    .listing-price { font-size: 20px; font-weight: 800; color: var(--gold-primary); margin-bottom: 16px; }
    .listing-status { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 6px; margin-bottom: 16px; }
    .listing-status.active { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
    .listing-status.sold { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
    .listing-status.expired { background: rgba(239, 68, 68, 0.15); color: #f87171; }
    .listing-actions { display: flex; gap: 8px; }
    .listing-actions .btn { flex: 1; padding: 10px; font-size: 13px; }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; font-family: inherit; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; }
    .btn-primary { background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%); color: var(--dark-primary); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 16px var(--gold-glow); }
    .btn-secondary { background: var(--dark-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); }
    .btn-danger { background: transparent; color: var(--error); border: 1px solid var(--error); }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }
    .btn-sm { padding: 8px 16px; font-size: 13px; }

    /* Empty State */
    .empty-state { text-align: center; padding: 80px 20px; }
    .empty-icon { width: 100px; height: 100px; background: var(--dark-elevated); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin: 0 auto 28px; }
    .empty-icon svg { width: 48px; height: 48px; stroke: var(--text-muted); }
    .empty-title { font-size: 22px; font-weight: 700; margin-bottom: 12px; }
    .empty-text { font-size: 15px; color: var(--text-muted); max-width: 400px; margin: 0 auto 28px; line-height: 1.6; }

    .loading-container { display: flex; align-items: center; justify-content: center; min-height: 400px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-subtle); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    @media (max-width: 991px) { .sidebar-overlay.active { display: block; } }

    /* Filters */
    .filters-bar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .filter-btn { padding: 10px 18px; border-radius: 8px; border: 1px solid var(--border-subtle); background: var(--dark-surface); color: var(--text-secondary); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; font-family: inherit; }
    .filter-btn:hover { border-color: rgba(255,255,255,0.2); }
    .filter-btn.active { background: var(--gold-primary); color: var(--dark-primary); border-color: var(--gold-primary); }
  </style>
</head>

<body>
  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-business" id="businessName">Loading...</div>
        <div class="sidebar-plan" id="planBadge">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5z"/></svg>
          <span id="planName">Free</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="/vendor/dashboard/" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>Dashboard</a>
          <a href="/vendor/dashboard/leads/" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Leads</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Marketplace</div>
          <a href="/vendor/dashboard/listings/" class="nav-item active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>My Listings</a>
          <a href="/marketplace/list-remnant/" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>List a Remnant</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <a href="/vendor/dashboard/profile/" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Profile</a>
          <a href="/vendor/dashboard/billing/" class="nav-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>Billing</a>
          <a href="javascript:void(0)" class="nav-item" onclick="logout()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Log Out</a>
        </div>
      </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <main class="main-content">
      <div id="loadingState" class="loading-container"><div class="loading-spinner"></div></div>

      <div id="pageContent" style="display: none;">
        <header class="page-header">
          <div>
            <h1 class="page-title">My Listings</h1>
            <p class="page-subtitle">Manage your stone remnants and slabs</p>
          </div>
          <a href="/marketplace/list-remnant/" class="btn btn-primary">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Listing
          </a>
        </header>

        <!-- Stats -->
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-value" id="statActive">0</div>
            <div class="stat-label">Active Listings</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statViews">0</div>
            <div class="stat-label">Total Views</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statInquiries">0</div>
            <div class="stat-label">Inquiries</div>
          </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
          <button class="filter-btn active" data-filter="all" onclick="filterListings('all')">All</button>
          <button class="filter-btn" data-filter="active" onclick="filterListings('active')">Active</button>
          <button class="filter-btn" data-filter="sold" onclick="filterListings('sold')">Sold</button>
          <button class="filter-btn" data-filter="expired" onclick="filterListings('expired')">Expired</button>
        </div>

        <!-- Listings -->
        <div id="listingsContainer"></div>
      </div>
    </main>
  </div>

  <button class="mobile-menu-btn" onclick="toggleSidebar()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>

  <script>
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let vendorProfile = null;
    let allListings = [];
    let currentFilter = 'all';

    async function initPage() {
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error || !user) { window.location.href = '/vendor/signup/'; return; }

        const { data: profile } = await supabaseClient.from('vendor_profiles').select('*').eq('id', user.id).single();
        if (!profile) { window.location.href = '/vendor/signup/'; return; }
        vendorProfile = profile;

        const { data: sub } = await supabaseClient.from('vendor_subscriptions').select('*, subscription_plans(*)').eq('vendor_id', user.id).single();

        document.getElementById('businessName').textContent = profile.business_name || 'Your Business';
        if (sub?.subscription_plans) {
          document.getElementById('planName').textContent = sub.subscription_plans.display_name;
        }

        await loadListings();

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('pageContent').style.display = 'block';
      } catch (err) {
        console.error('Init error:', err);
      }
    }

    async function loadListings() {
      try {
        const { data: listings } = await supabaseClient
          .from('stone_listings')
          .select('*')
          .eq('vendor_id', vendorProfile.id)
          .order('created_at', { ascending: false });

        allListings = listings || [];

        // Update stats
        const active = allListings.filter(l => l.status === 'active').length;
        const totalViews = allListings.reduce((sum, l) => sum + (l.view_count || 0), 0);
        const totalInquiries = allListings.reduce((sum, l) => sum + (l.inquiry_count || 0), 0);

        document.getElementById('statActive').textContent = active;
        document.getElementById('statViews').textContent = totalViews;
        document.getElementById('statInquiries').textContent = totalInquiries;

        renderListings();
      } catch (err) {
        console.error('Load listings error:', err);
      }
    }

    function filterListings(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === status);
      });
      renderListings();
    }

    function renderListings() {
      const container = document.getElementById('listingsContainer');
      let filtered = allListings;

      if (currentFilter !== 'all') {
        filtered = allListings.filter(l => l.status === currentFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
            </div>
            <h3 class="empty-title">${currentFilter === 'all' ? 'No listings yet' : 'No ' + currentFilter + ' listings'}</h3>
            <p class="empty-text">${currentFilter === 'all' ? 'List your stone remnants and slabs to sell them in our marketplace.' : 'You don\'t have any listings with this status.'}</p>
            ${currentFilter === 'all' ? '<a href="/marketplace/list-remnant/" class="btn btn-primary">Create Your First Listing</a>' : ''}
          </div>`;
        container.className = '';
        return;
      }

      container.className = 'listings-grid';
      container.innerHTML = filtered.map(listing => {
        const imageUrl = listing.images && listing.images[0] ? listing.images[0] : null;

        return `
          <div class="listing-card">
            <div class="listing-image">
              ${imageUrl ? `<img src="${imageUrl}" alt="${listing.name}" loading="lazy">` : '<span class="listing-image-placeholder">No image</span>'}
            </div>
            <div class="listing-body">
              <div class="listing-material">${listing.material_type || 'Stone'}</div>
              <div class="listing-name">${listing.name || 'Untitled Listing'}</div>
              <div class="listing-details">
                <span>${listing.length || '?'}" x ${listing.width || '?'}"</span>
                <span>${listing.thickness || '?'} cm</span>
              </div>
              <div class="listing-price">$${parseFloat(listing.price || 0).toLocaleString()}</div>
              <span class="listing-status ${listing.status}">${listing.status?.charAt(0).toUpperCase() + listing.status?.slice(1)}</span>
              <div class="listing-actions">
                <button class="btn btn-secondary btn-sm" onclick="editListing('${listing.id}')">Edit</button>
                ${listing.status === 'active' ? `<button class="btn btn-secondary btn-sm" onclick="markSold('${listing.id}')">Mark Sold</button>` : ''}
                <button class="btn btn-danger btn-sm" onclick="deleteListing('${listing.id}')">Delete</button>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function editListing(id) {
      window.location.href = `/marketplace/list-remnant/?edit=${id}`;
    }

    async function markSold(id) {
      if (!confirm('Mark this listing as sold?')) return;
      try {
        await supabaseClient.from('stone_listings').update({ status: 'sold', updated_at: new Date().toISOString() }).eq('id', id);
        await loadListings();
      } catch (err) {
        console.error('Mark sold error:', err);
        alert('Failed to update listing');
      }
    }

    async function deleteListing(id) {
      if (!confirm('Are you sure you want to delete this listing? This cannot be undone.')) return;
      try {
        await supabaseClient.from('stone_listings').delete().eq('id', id);
        await loadListings();
      } catch (err) {
        console.error('Delete error:', err);
        alert('Failed to delete listing');
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('active');
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = '/';
    }

    initPage();
  </script>
<script defer src="/js/remodely-hub.js?v=20260118"></script>
</body>
</html>
