<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Business Profile | Vendor Dashboard | Surprise Granite</title>
  <meta name="description" content="Manage your business profile and settings."/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb2d4f9fbad10/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260110c">
  <script defer src="/js/unified-nav.js?v=20260110e"></script>
  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --gold-glow: rgba(249, 203, 0, 0.35);
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --sidebar-width: 260px;
      --nav-height: 140px;
    }
    @media (max-width: 991px) { :root { --nav-height: 64px; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--dark-deep); min-height: 100vh; color: var(--text-primary); }
    .dashboard-layout { display: flex; min-height: 100vh; padding-top: var(--nav-height); }
    .sidebar { position: fixed; left: 0; top: var(--nav-height); bottom: 0; width: var(--sidebar-width); background: var(--dark-surface); border-right: 1px solid var(--border-subtle); padding: 24px 0; overflow-y: auto; z-index: 100; }
    @media (max-width: 991px) { .sidebar { transform: translateX(-100%); transition: transform 0.3s; } .sidebar.open { transform: translateX(0); } }
    .sidebar-header { padding: 0 20px 24px; border-bottom: 1px solid var(--border-subtle); margin-bottom: 20px; }
    .sidebar-business { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .sidebar-plan { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--gold-primary); background: rgba(249, 203, 0, 0.1); padding: 4px 10px; border-radius: 100px; }
    .sidebar-nav { padding: 0 12px; }
    .nav-section { margin-bottom: 24px; }
    .nav-section-title { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: var(--text-primary); }
    .nav-item.active { background: rgba(249, 203, 0, 0.1); color: var(--gold-primary); }
    .nav-badge { margin-left: auto; background: var(--gold-primary); color: var(--dark-primary); font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 100px; }
    .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 32px; max-width: 900px; }
    @media (max-width: 991px) { .main-content { margin-left: 0; padding: 20px; } }
    .mobile-menu-btn { display: none; position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; background: var(--gold-primary); border: none; border-radius: 50%; color: var(--dark-primary); cursor: pointer; z-index: 101; }
    @media (max-width: 991px) { .mobile-menu-btn { display: flex; align-items: center; justify-content: center; } }
    .page-header { margin-bottom: 32px; }
    .page-title { font-size: 28px; font-weight: 800; }
    .page-subtitle { font-size: 14px; color: var(--text-muted); margin-top: 4px; }
    .section { margin-bottom: 32px; }
    .section-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
    .card { background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } }
    .form-group { margin-bottom: 20px; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
    .form-input, .form-textarea, .form-select { width: 100%; padding: 12px 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 10px; color: var(--text-primary); font-size: 14px; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s; }
    .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: var(--gold-primary); box-shadow: 0 0 0 3px var(--gold-glow); }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-select { cursor: pointer; }
    .form-hint { font-size: 12px; color: var(--text-muted); margin-top: 6px; }
    .logo-upload { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .logo-preview { width: 100px; height: 100px; border-radius: 16px; background: var(--dark-elevated); border: 2px dashed var(--border-subtle); display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .logo-preview img { width: 100%; height: 100%; object-fit: cover; }
    .logo-preview svg { width: 40px; height: 40px; color: var(--text-muted); }
    .logo-actions { flex: 1; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; text-decoration: none; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)); color: var(--dark-primary); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 16px var(--gold-glow); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--dark-elevated); color: var(--text-primary); border: 1px solid var(--border-subtle); }
    .btn-small { padding: 8px 16px; font-size: 13px; }
    .service-areas-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
    .service-area-tag { display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 100px; font-size: 13px; }
    .service-area-tag.selected { background: rgba(249, 203, 0, 0.15); border-color: var(--gold-primary); color: var(--gold-primary); }
    .service-area-tag input { display: none; }
    .service-area-tag:hover { cursor: pointer; border-color: var(--gold-primary); }
    .material-types-grid { display: flex; flex-wrap: wrap; gap: 10px; }
    .material-chip { display: inline-flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 100px; font-size: 13px; cursor: pointer; transition: all 0.2s; }
    .material-chip:hover { border-color: var(--gold-primary); }
    .material-chip.selected { background: rgba(249, 203, 0, 0.15); border-color: var(--gold-primary); color: var(--gold-primary); }
    .material-chip input { display: none; }
    .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-subtle); }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--dark-surface); border: 1px solid var(--border-subtle); padding: 16px 24px; border-radius: 12px; font-size: 14px; z-index: 1000; display: flex; align-items: center; gap: 10px; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--error); }
    .loading-container { display: flex; align-items: center; justify-content: center; min-height: 400px; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-subtle); border-top-color: var(--gold-primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    @media (max-width: 991px) { .sidebar-overlay.active { display: block; } }
    .file-input { display: none; }
  </style>
</head>
<body>
  <div class="dashboard-layout">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-business" id="businessName">Loading...</div>
        <div class="sidebar-plan"><span id="planName">Free</span></div>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="/vendor/dashboard/" class="nav-item">Dashboard</a>
          <a href="/vendor/dashboard/leads/" class="nav-item">Leads <span class="nav-badge" id="leadsCount">0</span></a>
          <a href="/vendor/dashboard/customers/" class="nav-item">Customers</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <a href="/vendor/dashboard/profile/" class="nav-item active">Profile</a>
          <a href="/vendor/dashboard/billing/" class="nav-item">Billing & Payouts</a>
          <a href="javascript:void(0)" class="nav-item" onclick="logout()">Log Out</a>
        </div>
      </nav>
    </aside>
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <main class="main-content">
      <div id="loadingState" class="loading-container"><div class="loading-spinner"></div></div>
      <div id="pageContent" style="display: none;">
        <header class="page-header">
          <h1 class="page-title">Business Profile</h1>
          <p class="page-subtitle">Manage your business information and preferences</p>
        </header>

        <form id="profileForm" onsubmit="saveProfile(event)">
          <section class="section">
            <h2 class="section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
              Business Information
            </h2>
            <div class="card">
              <div class="form-group">
                <label class="form-label">Business Logo</label>
                <div class="logo-upload">
                  <div class="logo-preview" id="logoPreview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
                  </div>
                  <div class="logo-actions">
                    <input type="file" id="logoInput" class="file-input" accept="image/*" onchange="handleLogoUpload(event)">
                    <button type="button" class="btn btn-secondary btn-small" onclick="document.getElementById('logoInput').click()">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                      Upload Logo
                    </button>
                    <p class="form-hint">Recommended: 200x200px, PNG or JPG</p>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="businessNameInput">Business Name *</label>
                  <input type="text" id="businessNameInput" class="form-input" required placeholder="Your Business Name">
                </div>
                <div class="form-group">
                  <label class="form-label" for="businessType">Business Type</label>
                  <select id="businessType" class="form-select">
                    <option value="fabricator">Fabricator</option>
                    <option value="installer">Installer</option>
                    <option value="fabricator_installer">Fabricator & Installer</option>
                    <option value="contractor">General Contractor</option>
                    <option value="designer">Kitchen/Bath Designer</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="form-group full-width">
                  <label class="form-label" for="businessDescription">Business Description</label>
                  <textarea id="businessDescription" class="form-textarea" placeholder="Tell customers about your business, specialties, and experience..."></textarea>
                </div>
                <div class="form-group">
                  <label class="form-label" for="yearsInBusiness">Years in Business</label>
                  <input type="number" id="yearsInBusiness" class="form-input" min="0" max="100" placeholder="10">
                </div>
                <div class="form-group">
                  <label class="form-label" for="licenseNumber">License Number</label>
                  <input type="text" id="licenseNumber" class="form-input" placeholder="ROC #123456">
                </div>
              </div>
            </div>
          </section>

          <section class="section">
            <h2 class="section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
              Contact Information
            </h2>
            <div class="card">
              <div class="form-grid">
                <div class="form-group">
                  <label class="form-label" for="contactName">Contact Name *</label>
                  <input type="text" id="contactName" class="form-input" required placeholder="John Smith">
                </div>
                <div class="form-group">
                  <label class="form-label" for="contactEmail">Email Address *</label>
                  <input type="email" id="contactEmail" class="form-input" required placeholder="john@company.com">
                </div>
                <div class="form-group">
                  <label class="form-label" for="contactPhone">Phone Number *</label>
                  <input type="tel" id="contactPhone" class="form-input" required placeholder="(602) 555-1234">
                </div>
                <div class="form-group">
                  <label class="form-label" for="website">Website</label>
                  <input type="url" id="website" class="form-input" placeholder="https://yourcompany.com">
                </div>
              </div>
            </div>
          </section>

          <section class="section">
            <h2 class="section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
              Business Address
            </h2>
            <div class="card">
              <div class="form-grid">
                <div class="form-group full-width">
                  <label class="form-label" for="address">Street Address</label>
                  <input type="text" id="address" class="form-input" placeholder="123 Main Street">
                </div>
                <div class="form-group">
                  <label class="form-label" for="city">City</label>
                  <input type="text" id="city" class="form-input" placeholder="Phoenix">
                </div>
                <div class="form-group">
                  <label class="form-label" for="state">State</label>
                  <select id="state" class="form-select">
                    <option value="AZ">Arizona</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="NV">Nevada</option>
                    <option value="NM">New Mexico</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label" for="zipCode">ZIP Code</label>
                  <input type="text" id="zipCode" class="form-input" placeholder="85001">
                </div>
              </div>
            </div>
          </section>

          <section class="section">
            <h2 class="section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
              Service Areas
            </h2>
            <div class="card">
              <p class="form-hint" style="margin-bottom: 16px;">Select all areas where you provide services:</p>
              <div class="service-areas-grid" id="serviceAreas">
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Phoenix"> Phoenix</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Scottsdale"> Scottsdale</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Mesa"> Mesa</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Tempe"> Tempe</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Chandler"> Chandler</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Gilbert"> Gilbert</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Glendale"> Glendale</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Peoria"> Peoria</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Surprise"> Surprise</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Goodyear"> Goodyear</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Buckeye"> Buckeye</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Avondale"> Avondale</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Cave Creek"> Cave Creek</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Fountain Hills"> Fountain Hills</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Paradise Valley"> Paradise Valley</label>
                <label class="service-area-tag"><input type="checkbox" name="service_area" value="Queen Creek"> Queen Creek</label>
              </div>
            </div>
          </section>

          <section class="section">
            <h2 class="section-title">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
              Materials & Services
            </h2>
            <div class="card">
              <p class="form-hint" style="margin-bottom: 16px;">Select materials you work with:</p>
              <div class="material-types-grid" id="materialTypes">
                <label class="material-chip"><input type="checkbox" name="material" value="granite"> Granite</label>
                <label class="material-chip"><input type="checkbox" name="material" value="quartz"> Quartz</label>
                <label class="material-chip"><input type="checkbox" name="material" value="marble"> Marble</label>
                <label class="material-chip"><input type="checkbox" name="material" value="quartzite"> Quartzite</label>
                <label class="material-chip"><input type="checkbox" name="material" value="soapstone"> Soapstone</label>
                <label class="material-chip"><input type="checkbox" name="material" value="porcelain"> Porcelain</label>
                <label class="material-chip"><input type="checkbox" name="material" value="sintered"> Sintered Stone</label>
                <label class="material-chip"><input type="checkbox" name="material" value="butcher_block"> Butcher Block</label>
                <label class="material-chip"><input type="checkbox" name="material" value="concrete"> Concrete</label>
                <label class="material-chip"><input type="checkbox" name="material" value="laminate"> Laminate</label>
              </div>
            </div>
          </section>

          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="saveBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
              Save Changes
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <div class="toast" id="toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
    <span id="toastMessage">Changes saved successfully!</span>
  </div>

  <button class="mobile-menu-btn" onclick="toggleSidebar()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>

  <script>
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let vendorProfile = null;
    let originalProfile = null;

    async function initPage() {
      try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error || !user) { window.location.href = '/vendor/signup/'; return; }

        const { data: profile } = await supabaseClient.from('vendor_profiles').select('*').eq('id', user.id).single();
        if (!profile) { window.location.href = '/vendor/signup/'; return; }

        vendorProfile = profile;
        originalProfile = { ...profile };

        const { data: sub } = await supabaseClient.from('vendor_subscriptions').select('*, subscription_plans(*)').eq('vendor_id', user.id).single();

        document.getElementById('businessName').textContent = profile.business_name || 'Your Business';
        if (sub?.subscription_plans) {
          document.getElementById('planName').textContent = sub.subscription_plans.display_name;
        }

        const { data: leads } = await supabaseClient.from('lead_distributions').select('id').eq('vendor_id', vendorProfile.id);
        document.getElementById('leadsCount').textContent = leads?.length || 0;

        populateForm(profile);
        setupCheckboxStyling();

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('pageContent').style.display = 'block';
      } catch (err) {
        console.error('Init error:', err);
        document.getElementById('loadingState').innerHTML = '<p style="color: var(--error);">Error loading page.</p>';
      }
    }

    function populateForm(profile) {
      document.getElementById('businessNameInput').value = profile.business_name || '';
      document.getElementById('businessType').value = profile.business_type || 'fabricator';
      document.getElementById('businessDescription').value = profile.description || '';
      document.getElementById('yearsInBusiness').value = profile.years_in_business || '';
      document.getElementById('licenseNumber').value = profile.license_number || '';
      document.getElementById('contactName').value = profile.contact_name || '';
      document.getElementById('contactEmail').value = profile.email || '';
      document.getElementById('contactPhone').value = profile.phone || '';
      document.getElementById('website').value = profile.website || '';
      document.getElementById('address').value = profile.address || '';
      document.getElementById('city').value = profile.city || '';
      document.getElementById('state').value = profile.state || 'AZ';
      document.getElementById('zipCode').value = profile.zip_code || '';

      if (profile.logo_url) {
        document.getElementById('logoPreview').innerHTML = '<img src="' + profile.logo_url + '" alt="Logo">';
      }

      if (profile.service_areas && Array.isArray(profile.service_areas)) {
        profile.service_areas.forEach(function(area) {
          var checkbox = document.querySelector('input[name="service_area"][value="' + area + '"]');
          if (checkbox) {
            checkbox.checked = true;
            checkbox.closest('.service-area-tag').classList.add('selected');
          }
        });
      }

      if (profile.materials && Array.isArray(profile.materials)) {
        profile.materials.forEach(function(material) {
          var checkbox = document.querySelector('input[name="material"][value="' + material + '"]');
          if (checkbox) {
            checkbox.checked = true;
            checkbox.closest('.material-chip').classList.add('selected');
          }
        });
      }
    }

    function setupCheckboxStyling() {
      document.querySelectorAll('.service-area-tag input').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          this.closest('.service-area-tag').classList.toggle('selected', this.checked);
        });
      });
      document.querySelectorAll('.material-chip input').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
          this.closest('.material-chip').classList.toggle('selected', this.checked);
        });
      });
    }

    async function handleLogoUpload(event) {
      var file = event.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) { showToast('Please upload an image file', 'error'); return; }
      if (file.size > 2 * 1024 * 1024) { showToast('Image must be less than 2MB', 'error'); return; }

      var reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('logoPreview').innerHTML = '<img src="' + e.target.result + '" alt="Logo preview">';
      };
      reader.readAsDataURL(file);

      try {
        var fileName = 'logos/' + vendorProfile.id + '/' + Date.now() + '_' + file.name;
        var result = await supabaseClient.storage.from('vendor-assets').upload(fileName, file, { upsert: true });
        if (result.error) throw result.error;
        var urlResult = supabaseClient.storage.from('vendor-assets').getPublicUrl(fileName);
        vendorProfile.logo_url = urlResult.data.publicUrl;
        showToast('Logo uploaded successfully!', 'success');
      } catch (err) {
        console.error('Upload error:', err);
        showToast('Failed to upload logo', 'error');
      }
    }

    async function saveProfile(event) {
      event.preventDefault();
      var btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>Saving...</span>';

      var serviceAreas = [];
      document.querySelectorAll('input[name="service_area"]:checked').forEach(function(cb) {
        serviceAreas.push(cb.value);
      });

      var materials = [];
      document.querySelectorAll('input[name="material"]:checked').forEach(function(cb) {
        materials.push(cb.value);
      });

      var updates = {
        business_name: document.getElementById('businessNameInput').value,
        business_type: document.getElementById('businessType').value,
        description: document.getElementById('businessDescription').value,
        years_in_business: parseInt(document.getElementById('yearsInBusiness').value) || null,
        license_number: document.getElementById('licenseNumber').value || null,
        contact_name: document.getElementById('contactName').value,
        email: document.getElementById('contactEmail').value,
        phone: document.getElementById('contactPhone').value,
        website: document.getElementById('website').value || null,
        address: document.getElementById('address').value || null,
        city: document.getElementById('city').value || null,
        state: document.getElementById('state').value,
        zip_code: document.getElementById('zipCode').value || null,
        service_areas: serviceAreas,
        materials: materials,
        logo_url: vendorProfile.logo_url,
        updated_at: new Date().toISOString()
      };

      try {
        var result = await supabaseClient.from('vendor_profiles').update(updates).eq('id', vendorProfile.id);
        if (result.error) throw result.error;
        vendorProfile = Object.assign({}, vendorProfile, updates);
        originalProfile = Object.assign({}, vendorProfile);
        document.getElementById('businessName').textContent = updates.business_name;
        showToast('Profile saved successfully!', 'success');
      } catch (err) {
        console.error('Save error:', err);
        showToast('Failed to save profile', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save Changes';
      }
    }

    function resetForm() {
      if (originalProfile) {
        populateForm(originalProfile);
        document.querySelectorAll('.service-area-tag, .material-chip').forEach(function(el) {
          el.classList.remove('selected');
        });
        if (originalProfile.service_areas) {
          originalProfile.service_areas.forEach(function(area) {
            var checkbox = document.querySelector('input[name="service_area"][value="' + area + '"]');
            if (checkbox) checkbox.closest('.service-area-tag').classList.add('selected');
          });
        }
        if (originalProfile.materials) {
          originalProfile.materials.forEach(function(material) {
            var checkbox = document.querySelector('input[name="material"][value="' + material + '"]');
            if (checkbox) checkbox.closest('.material-chip').classList.add('selected');
          });
        }
      }
    }

    function showToast(message, type) {
      type = type || 'success';
      var toast = document.getElementById('toast');
      var toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      toast.className = 'toast show ' + type;
      setTimeout(function() { toast.classList.remove('show'); }, 3000);
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('active');
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      window.location.href = '/';
    }

    initPage();
  </script>
</body>
</html>
