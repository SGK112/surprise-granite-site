<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Shop | Surprise Granite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Shop countertop samples, sinks, faucets and more from Surprise Granite.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="/css/unified-nav.css?v=20260122">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --gold-glow: rgba(249, 203, 0, 0.35);
      --dark-primary: #1a1a2e;
      --dark-deep: #0f0f14;
      --dark-surface: #16161f;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.8);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --success: #22c55e;
      --error: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-deep);
      color: var(--text-primary);
      min-height: 100vh;
      padding-top: 80px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Hero */
    .shop-hero {
      text-align: center;
      padding: 48px 24px;
      background: linear-gradient(135deg, var(--dark-surface) 0%, var(--dark-deep) 100%);
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 32px;
    }

    .shop-hero h1 {
      font-size: 42px;
      font-weight: 800;
      margin-bottom: 12px;
    }

    .shop-hero p {
      color: var(--text-muted);
      font-size: 18px;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Layout */
    .shop-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 32px;
    }

    @media (max-width: 1024px) {
      .shop-layout {
        grid-template-columns: 1fr;
      }
    }

    /* Sidebar Filters */
    .filters-sidebar {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      height: fit-content;
      position: sticky;
      top: 100px;
    }

    @media (max-width: 1024px) {
      .filters-sidebar {
        position: static;
      }
    }

    .filter-section {
      margin-bottom: 24px;
    }

    .filter-section:last-child {
      margin-bottom: 0;
    }

    .filter-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .filter-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .filter-input:focus {
      outline: none;
      border-color: var(--gold-primary);
    }

    .filter-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .price-range {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .price-range input {
      flex: 1;
      padding: 10px 12px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      width: 100%;
    }

    .price-range span {
      color: var(--text-muted);
    }

    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-tag {
      padding: 8px 14px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 100px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      border-color: var(--gold-primary);
    }

    .filter-tag.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .clear-filters {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 16px;
    }

    .clear-filters:hover {
      background: var(--dark-elevated);
      color: var(--text-primary);
    }

    /* Products Section */
    .products-section {
      min-height: 500px;
    }

    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .products-count {
      font-size: 15px;
      color: var(--text-muted);
    }

    .sort-select {
      padding: 10px 16px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    /* Products Grid */
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
    }

    .product-card {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
    }

    .product-image-container {
      position: relative;
      aspect-ratio: 1;
      background: var(--dark-elevated);
      overflow: hidden;
    }

    .product-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .product-card:hover .product-image {
      transform: scale(1.05);
    }

    .product-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 6px 12px;
      background: var(--gold-primary);
      color: var(--dark-primary);
      font-size: 11px;
      font-weight: 700;
      border-radius: 6px;
      text-transform: uppercase;
    }

    .product-badge.sale {
      background: var(--error);
      color: white;
    }

    .product-info {
      padding: 20px;
    }

    .product-vendor {
      font-size: 12px;
      color: var(--gold-primary);
      font-weight: 600;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-name a {
      color: var(--text-primary);
      text-decoration: none;
    }

    .product-name a:hover {
      color: var(--gold-primary);
    }

    .product-type {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .product-price {
      display: flex;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 16px;
    }

    .price-current {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .price-compare {
      font-size: 15px;
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .product-actions {
      display: flex;
      gap: 10px;
    }

    .btn-add-cart {
      flex: 1;
      padding: 12px 16px;
      background: var(--gold-primary);
      color: var(--dark-primary);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-add-cart:hover {
      background: var(--gold-dark);
      box-shadow: 0 0 20px var(--gold-glow);
    }

    .btn-add-cart:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-view {
      padding: 12px 16px;
      background: var(--dark-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      font-size: 14px;
      text-decoration: none;
      transition: all 0.2s;
    }

    .btn-view:hover {
      background: var(--dark-primary);
      border-color: rgba(255,255,255,0.2);
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 80px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 48px;
      padding: 24px;
    }

    .page-btn {
      padding: 12px 18px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-btn.active {
      background: var(--gold-primary);
      color: var(--dark-primary);
      border-color: var(--gold-primary);
    }

    .page-info {
      padding: 12px 18px;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      stroke: var(--text-muted);
      margin-bottom: 24px;
    }

    .empty-state h3 {
      font-size: 22px;
      margin-bottom: 12px;
    }

    .empty-state p {
      color: var(--text-muted);
      font-size: 15px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--dark-surface);
      border: 1px solid var(--success);
      border-radius: 12px;
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast svg {
      width: 24px;
      height: 24px;
      stroke: var(--success);
    }

    @keyframes slideIn {
      from { transform: translateY(100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* Mobile Filters Toggle */
    .mobile-filter-toggle {
      display: none;
      width: 100%;
      padding: 14px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 16px;
    }

    @media (max-width: 1024px) {
      .mobile-filter-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .filters-sidebar {
        display: none;
      }

      .filters-sidebar.open {
        display: block;
      }
    }

    /* Quick View Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }

    @media (max-width: 768px) {
      .modal-content {
        grid-template-columns: 1fr;
      }
    }

    .modal-image {
      aspect-ratio: 1;
      background: var(--dark-elevated);
    }

    .modal-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .modal-info {
      padding: 32px;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 40px;
      height: 40px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 50%;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-vendor {
      font-size: 13px;
      color: var(--gold-primary);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .modal-price {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .modal-description {
      color: var(--text-secondary);
      font-size: 15px;
      line-height: 1.7;
      margin-bottom: 24px;
      max-height: 150px;
      overflow-y: auto;
    }

    .modal-meta {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--dark-elevated);
      border-radius: 8px;
    }

    .modal-meta-item {
      font-size: 13px;
    }

    .modal-meta-label {
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .modal-meta-value {
      font-weight: 600;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
    }

    .modal-actions .btn-add-cart {
      flex: 1;
      padding: 16px;
    }
  </style>
</head>
<body>
  <!-- Navigation will be injected by unified-nav.js -->

  <div class="shop-hero">
    <h1>Shop Our Collection</h1>
    <p>Premium countertop samples, sinks, faucets, and more for your home improvement projects</p>
  </div>

  <div class="container">
    <button class="mobile-filter-toggle" onclick="toggleFilters()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="4" y1="21" x2="4" y2="14"/><line x1="4" y1="10" x2="4" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="3"/>
        <line x1="20" y1="21" x2="20" y2="16"/><line x1="20" y1="12" x2="20" y2="3"/>
        <line x1="1" y1="14" x2="7" y2="14"/><line x1="9" y1="8" x2="15" y2="8"/>
        <line x1="17" y1="16" x2="23" y2="16"/>
      </svg>
      Filters
    </button>

    <div class="shop-layout">
      <!-- Filters Sidebar -->
      <aside class="filters-sidebar" id="filtersSidebar">
        <div class="filter-section">
          <div class="filter-title">Search</div>
          <input type="text" class="filter-input" id="searchInput" placeholder="Search products...">
        </div>

        <div class="filter-section">
          <div class="filter-title">Category</div>
          <div class="filter-tags" id="categoryTags">
            <span class="filter-tag active" data-value="">All</span>
          </div>
        </div>

        <div class="filter-section">
          <div class="filter-title">Vendor</div>
          <select class="filter-select" id="vendorSelect">
            <option value="">All Vendors</option>
          </select>
        </div>

        <div class="filter-section">
          <div class="filter-title">Price Range</div>
          <div class="price-range">
            <input type="number" id="priceMin" placeholder="Min">
            <span>to</span>
            <input type="number" id="priceMax" placeholder="Max">
          </div>
        </div>

        <div class="filter-section">
          <div class="filter-title">Stock Status</div>
          <div class="filter-tags">
            <span class="filter-tag active" data-stock="">All</span>
            <span class="filter-tag" data-stock="instock">In Stock</span>
          </div>
        </div>

        <button class="clear-filters" onclick="clearAllFilters()">Clear All Filters</button>
      </aside>

      <!-- Products Section -->
      <section class="products-section">
        <div class="products-header">
          <span class="products-count" id="productsCount">Loading products...</span>
          <select class="sort-select" id="sortSelect" onchange="applyFilters()">
            <option value="name">Sort by Name</option>
            <option value="price-low">Price: Low to High</option>
            <option value="price-high">Price: High to Low</option>
            <option value="newest">Newest First</option>
          </select>
        </div>

        <div class="products-grid" id="productsGrid">
          <div class="loading" style="grid-column: 1/-1;">
            <div class="spinner"></div>
          </div>
        </div>

        <div class="pagination" id="pagination"></div>
      </section>
    </div>
  </div>

  <!-- Quick View Modal -->
  <div class="modal-overlay" id="quickViewModal">
    <div class="modal" style="position: relative;">
      <button class="modal-close" onclick="closeQuickView()">&times;</button>
      <div class="modal-content" id="quickViewContent"></div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
      <polyline points="22 4 12 14.01 9 11.01"/>
    </svg>
    <span id="toastMessage">Added to cart!</span>
  </div>

  <script src="/js/cart.js"></script>
  <script defer src="/js/unified-nav.js?v=20260122"></script>
  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // State
    let allProducts = [];
    let filteredProducts = [];
    let currentPage = 1;
    const pageSize = 24;

    // Filters
    let filters = {
      search: '',
      category: '',
      vendor: '',
      priceMin: null,
      priceMax: null,
      inStock: false,
      sort: 'name'
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', init);

    async function init() {
      await loadProducts();
      setupEventListeners();
    }

    async function loadProducts() {
      try {
        const { data, error } = await supabase
          .from('shopify_products')
          .select('*')
          .eq('status', 'active')
          .eq('show_on_website', true)
          .order('name');

        if (error) throw error;

        allProducts = data || [];
        populateFilters();
        applyFilters();

      } catch (err) {
        console.error('Error loading products:', err);
        document.getElementById('productsGrid').innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <h3>Error loading products</h3>
            <p>Please try refreshing the page.</p>
          </div>
        `;
      }
    }

    function populateFilters() {
      // Categories (product types)
      const types = [...new Set(allProducts.map(p => p.product_type).filter(Boolean))].sort();
      const categoryTags = document.getElementById('categoryTags');
      categoryTags.innerHTML = `<span class="filter-tag active" data-value="" onclick="setCategory('')">All</span>` +
        types.map(t => `<span class="filter-tag" data-value="${t}" onclick="setCategory('${t}')">${t}</span>`).join('');

      // Vendors
      const vendors = [...new Set(allProducts.map(p => p.vendor).filter(Boolean))].sort();
      const vendorSelect = document.getElementById('vendorSelect');
      vendorSelect.innerHTML = '<option value="">All Vendors</option>' +
        vendors.map(v => `<option value="${v}">${v}</option>`).join('');
    }

    function setupEventListeners() {
      // Search
      let searchTimeout;
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filters.search = e.target.value.toLowerCase();
          currentPage = 1;
          applyFilters();
        }, 300);
      });

      // Vendor
      document.getElementById('vendorSelect').addEventListener('change', (e) => {
        filters.vendor = e.target.value;
        currentPage = 1;
        applyFilters();
      });

      // Price range
      document.getElementById('priceMin').addEventListener('change', (e) => {
        filters.priceMin = e.target.value ? parseFloat(e.target.value) : null;
        currentPage = 1;
        applyFilters();
      });

      document.getElementById('priceMax').addEventListener('change', (e) => {
        filters.priceMax = e.target.value ? parseFloat(e.target.value) : null;
        currentPage = 1;
        applyFilters();
      });

      // Stock filter tags
      document.querySelectorAll('[data-stock]').forEach(tag => {
        tag.addEventListener('click', () => {
          document.querySelectorAll('[data-stock]').forEach(t => t.classList.remove('active'));
          tag.classList.add('active');
          filters.inStock = tag.dataset.stock === 'instock';
          currentPage = 1;
          applyFilters();
        });
      });
    }

    function setCategory(category) {
      filters.category = category;
      document.querySelectorAll('#categoryTags .filter-tag').forEach(tag => {
        tag.classList.toggle('active', tag.dataset.value === category);
      });
      currentPage = 1;
      applyFilters();
    }

    function applyFilters() {
      filters.sort = document.getElementById('sortSelect').value;

      filteredProducts = allProducts.filter(p => {
        if (filters.search && !`${p.name} ${p.vendor || ''} ${p.sku || ''}`.toLowerCase().includes(filters.search)) {
          return false;
        }
        if (filters.category && p.product_type !== filters.category) return false;
        if (filters.vendor && p.vendor !== filters.vendor) return false;
        if (filters.priceMin !== null && p.price < filters.priceMin) return false;
        if (filters.priceMax !== null && p.price > filters.priceMax) return false;
        if (filters.inStock && (p.inventory_quantity === null || p.inventory_quantity <= 0)) return false;
        return true;
      });

      // Sort
      filteredProducts.sort((a, b) => {
        switch (filters.sort) {
          case 'price-low': return (a.price || 0) - (b.price || 0);
          case 'price-high': return (b.price || 0) - (a.price || 0);
          case 'newest': return new Date(b.created_at) - new Date(a.created_at);
          default: return (a.name || '').localeCompare(b.name || '');
        }
      });

      renderProducts();
    }

    function renderProducts() {
      const grid = document.getElementById('productsGrid');
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageProducts = filteredProducts.slice(start, end);

      document.getElementById('productsCount').textContent =
        `Showing ${start + 1}-${Math.min(end, filteredProducts.length)} of ${filteredProducts.length} products`;

      if (pageProducts.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <h3>No products found</h3>
            <p>Try adjusting your filters or search terms.</p>
          </div>
        `;
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      grid.innerHTML = pageProducts.map(p => `
        <div class="product-card">
          <div class="product-image-container">
            <img src="${p.image_url || 'https://via.placeholder.com/400x400?text=No+Image'}"
                 alt="${p.name}"
                 class="product-image"
                 loading="lazy"
                 onerror="this.src='https://via.placeholder.com/400x400?text=No+Image'">
            ${p.compare_at_price && p.compare_at_price > p.price ? '<span class="product-badge sale">Sale</span>' : ''}
          </div>
          <div class="product-info">
            ${p.vendor ? `<div class="product-vendor">${p.vendor}</div>` : ''}
            <h3 class="product-name">
              <a href="/store/product/?id=${p.id}">${p.name}</a>
            </h3>
            ${p.product_type ? `<div class="product-type">${p.product_type}</div>` : ''}
            <div class="product-price">
              <span class="price-current">$${parseFloat(p.price || 0).toFixed(2)}</span>
              ${p.compare_at_price && p.compare_at_price > p.price ?
                `<span class="price-compare">$${parseFloat(p.compare_at_price).toFixed(2)}</span>` : ''}
            </div>
            <div class="product-actions">
              <button class="btn-add-cart" onclick="addToCart('${p.id}')"
                ${p.inventory_quantity !== null && p.inventory_quantity <= 0 ? 'disabled' : ''}>
                ${p.inventory_quantity !== null && p.inventory_quantity <= 0 ? 'Out of Stock' : 'Add to Cart'}
              </button>
              <button class="btn-view" onclick="quickView('${p.id}')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                  <circle cx="12" cy="12" r="3"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / pageSize);
      const pagination = document.getElementById('pagination');

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = `
        <button class="page-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
          Previous
        </button>
      `;

      // Show page numbers
      const maxVisible = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
      let endPage = Math.min(totalPages, startPage + maxVisible - 1);

      if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }

      if (startPage > 1) {
        html += `<button class="page-btn" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) html += `<span class="page-info">...</span>`;
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += `<span class="page-info">...</span>`;
        html += `<button class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
      }

      html += `
        <button class="page-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
          Next
        </button>
      `;

      pagination.innerHTML = html;
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredProducts.length / pageSize);
      if (page < 1 || page > totalPages) return;
      currentPage = page;
      renderProducts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function addToCart(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;

      const cartItem = {
        id: product.id, // Supabase UUID for price validation
        handle: product.handle, // For fallback price lookup
        shopify_id: product.shopify_id,
        name: product.name,
        price: parseFloat(product.price) || 0,
        image: product.image_url,
        variant: null,
        quantity: 1,
        category: 'product',
        href: `/store/product/?id=${product.id}`
      };

      // Use the global cart functions from cart.js
      if (typeof window.addToCart === 'function') {
        window.addToCart(cartItem);
      } else {
        // Fallback: direct localStorage
        const cart = JSON.parse(localStorage.getItem('sg_cart') || '[]');
        const existingIndex = cart.findIndex(item => item.id === product.id || item.handle === product.handle);

        if (existingIndex >= 0) {
          cart[existingIndex].quantity += 1;
        } else {
          cart.push(cartItem);
        }

        localStorage.setItem('sg_cart', JSON.stringify(cart));
      }

      showToast(`${product.name} added to cart!`);
    }

    function quickView(productId) {
      const product = allProducts.find(p => p.id === productId);
      if (!product) return;

      const content = document.getElementById('quickViewContent');
      content.innerHTML = `
        <div class="modal-image">
          <img src="${product.image_url || 'https://via.placeholder.com/500x500?text=No+Image'}"
               alt="${product.name}"
               onerror="this.src='https://via.placeholder.com/500x500?text=No+Image'">
        </div>
        <div class="modal-info">
          ${product.vendor ? `<div class="modal-vendor">${product.vendor}</div>` : ''}
          <h2 class="modal-title">${product.name}</h2>
          <div class="modal-price">$${parseFloat(product.price || 0).toFixed(2)}</div>
          ${product.description ? `<div class="modal-description">${product.description}</div>` : ''}
          <div class="modal-meta">
            <div class="modal-meta-item">
              <div class="modal-meta-label">SKU</div>
              <div class="modal-meta-value">${product.sku || 'N/A'}</div>
            </div>
            <div class="modal-meta-item">
              <div class="modal-meta-label">Type</div>
              <div class="modal-meta-value">${product.product_type || 'N/A'}</div>
            </div>
            <div class="modal-meta-item">
              <div class="modal-meta-label">Stock</div>
              <div class="modal-meta-value">${product.inventory_quantity !== null ? product.inventory_quantity : 'N/A'}</div>
            </div>
            <div class="modal-meta-item">
              <div class="modal-meta-label">Vendor</div>
              <div class="modal-meta-value">${product.vendor || 'N/A'}</div>
            </div>
          </div>
          <div class="modal-actions">
            <button class="btn-add-cart" onclick="addToCart('${product.id}'); closeQuickView();"
              ${product.inventory_quantity !== null && product.inventory_quantity <= 0 ? 'disabled' : ''}>
              ${product.inventory_quantity !== null && product.inventory_quantity <= 0 ? 'Out of Stock' : 'Add to Cart'}
            </button>
            <a href="/store/product/?id=${product.id}" class="btn-view" style="text-align: center;">
              View Details
            </a>
          </div>
        </div>
      `;

      document.getElementById('quickViewModal').classList.add('open');
    }

    function closeQuickView() {
      document.getElementById('quickViewModal').classList.remove('open');
    }

    function clearAllFilters() {
      filters = {
        search: '',
        category: '',
        vendor: '',
        priceMin: null,
        priceMax: null,
        inStock: false,
        sort: 'name'
      };

      document.getElementById('searchInput').value = '';
      document.getElementById('vendorSelect').value = '';
      document.getElementById('priceMin').value = '';
      document.getElementById('priceMax').value = '';
      document.getElementById('sortSelect').value = 'name';

      document.querySelectorAll('.filter-tag').forEach(tag => {
        tag.classList.toggle('active', tag.dataset.value === '' || tag.dataset.stock === '');
      });

      currentPage = 1;
      applyFilters();
    }

    function toggleFilters() {
      document.getElementById('filtersSidebar').classList.toggle('open');
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Close modal on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeQuickView();
    });

    // Close modal on backdrop click
    document.getElementById('quickViewModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeQuickView();
    });
  </script>
</body>
</html>
