<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Project Quote | Surprise Granite</title>
  <link rel="icon" href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --success: #10b981;
      --warning: #f59e0b;
      --dark: #1a1a2e;
      --text: #333;
      --text-muted: #666;
      --border: #e5e7eb;
      --bg: #f9fafb;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, var(--dark) 0%, #16213e 100%);
      padding: 20px;
      text-align: center;
    }
    .header h1 { color: #fff; font-size: 24px; margin-bottom: 5px; }
    .header p { color: rgba(255,255,255,0.7); font-size: 14px; }
    .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
    .loading { text-align: center; padding: 60px 20px; }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    .project-card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
      margin-bottom: 20px;
    }
    .project-header { padding: 25px; border-bottom: 1px solid var(--border); }
    .project-name { font-size: 22px; font-weight: 700; color: var(--dark); margin-bottom: 8px; }
    .project-meta { display: flex; gap: 20px; flex-wrap: wrap; font-size: 14px; color: var(--text-muted); }
    .status-badge {
      display: inline-block; padding: 4px 12px; border-radius: 20px;
      font-size: 12px; font-weight: 600; text-transform: uppercase;
    }
    .status-sent, .status-viewed { background: #dbeafe; color: #1d4ed8; }
    .status-approved { background: #d1fae5; color: #059669; }
    .status-paid { background: #dcfce7; color: #16a34a; }
    .quote-summary { padding: 25px; background: #f8f9fa; }
    .quote-total { text-align: center; padding: 20px; background: #fff; border-radius: 12px; margin-bottom: 20px; }
    .quote-total-label { font-size: 14px; color: var(--text-muted); margin-bottom: 5px; }
    .quote-total-amount { font-size: 42px; font-weight: 700; color: var(--dark); }
    .payment-section { padding: 25px; }
    .payment-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .payment-option {
      border: 2px solid var(--border); border-radius: 12px; padding: 20px;
      cursor: pointer; transition: all 0.2s;
    }
    .payment-option:hover { border-color: var(--primary); }
    .payment-option.selected { border-color: var(--primary); background: #f0f0ff; }
    .payment-option-title { font-weight: 600; color: var(--dark); margin-bottom: 5px; }
    .payment-option-amount { font-size: 24px; font-weight: 700; color: var(--primary); }
    .payment-option-desc { font-size: 12px; color: var(--text-muted); margin-top: 5px; }
    .btn {
      display: inline-block; padding: 14px 28px; border-radius: 8px;
      font-size: 16px; font-weight: 600; cursor: pointer; border: none;
      transition: all 0.2s; text-decoration: none;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: #fff; width: 100%;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .payment-info {
      display: flex; align-items: center; justify-content: center; gap: 8px;
      margin-top: 15px; font-size: 13px; color: var(--text-muted);
    }
    .paid-banner {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: #fff; text-align: center; padding: 20px;
    }
    .paid-banner h2 { font-size: 20px; margin-bottom: 5px; }
    .customer-form { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 5px; color: var(--dark); }
    .form-group input {
      width: 100%; padding: 12px; border: 1px solid var(--border);
      border-radius: 8px; font-size: 14px;
    }
    .form-group input:focus { outline: none; border-color: var(--primary); }
    #payment-element { margin-bottom: 20px; }
    .footer { text-align: center; padding: 30px; color: var(--text-muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Surprise Granite</h1>
    <p>Your Project Quote</p>
  </div>
  <div class="container">
    <div id="content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>Loading your quote...</p>
      </div>
    </div>
  </div>
  <div class="footer">Questions? Call (602) 833-7194</div>
  <script>
    const API_BASE = 'https://api.surprisegranite.com';
    let project = null;
    let portalToken = null;
    let selectedPayment = 'deposit';
    let stripe = null;
    let elements = null;

    const urlParams = new URLSearchParams(window.location.search);
    portalToken = urlParams.get('token');

    if (!portalToken) {
      showError('Invalid link. Please use the link from your email.');
    } else {
      loadProject();
    }

    async function loadProject() {
      try {
        const response = await fetch(API_BASE + '/api/customer-portal/' + portalToken);
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Failed to load project');
        project = data.project;
        renderProject(data);
      } catch (error) {
        showError(error.message);
      }
    }

    function showError(message) {
      document.getElementById('content').innerHTML = '<div class="error"><h3>Unable to Load Quote</h3><p>' + message + '</p></div>';
    }

    function renderProject(data) {
      const { project, permissions } = data;
      const isPaid = project.payment_status === 'paid' || project.amount_paid >= project.quote_total;
      const remaining = project.quote_total - (project.amount_paid || 0);
      const depositAmt = Math.max(99, project.quote_total * 0.1).toFixed(2);

      let html = '<div class="project-card">';
      if (isPaid) {
        html += '<div class="paid-banner"><h2>Paid in Full</h2><p>Thank you!</p></div>';
      }
      html += '<div class="project-header"><h2 class="project-name">' + (project.name || 'Kitchen Design') + '</h2>';
      html += '<div class="project-meta"><span>Room: ' + (project.room_type || 'Kitchen') + '</span>';
      html += '<span class="status-badge status-' + project.status + '">' + project.status + '</span></div></div>';
      html += '<div class="quote-summary"><div class="quote-total">';
      html += '<div class="quote-total-label">Project Total</div>';
      html += '<div class="quote-total-amount">$' + (project.quote_total || 0).toLocaleString(undefined, {minimumFractionDigits: 2}) + '</div>';
      if (project.amount_paid > 0) {
        html += '<div style="margin-top:10px;font-size:14px;color:var(--success);">Paid: $' + project.amount_paid.toFixed(2) + '</div>';
      }
      html += '</div></div>';

      if (!isPaid && permissions.includes('pay')) {
        html += '<div class="payment-section"><h3 style="margin-bottom:20px;color:var(--dark);">Make a Payment</h3>';
        html += '<div class="customer-form"><div class="form-group"><label>Your Name</label>';
        html += '<input type="text" id="customerName" value="' + (project.customer_name || '') + '" placeholder="Full name"></div>';
        html += '<div class="form-group"><label>Phone Number</label>';
        html += '<input type="tel" id="customerPhone" value="' + (project.customer_phone || '') + '" placeholder="(555) 555-5555"></div></div>';
        html += '<div class="payment-options">';
        html += '<div class="payment-option selected" onclick="selectPayment(this, \'deposit\')"><div class="payment-option-title">Deposit (10%)</div>';
        html += '<div class="payment-option-amount">$' + depositAmt + '</div><div class="payment-option-desc">Secure your spot</div></div>';
        html += '<div class="payment-option" onclick="selectPayment(this, \'half\')"><div class="payment-option-title">50% Payment</div>';
        html += '<div class="payment-option-amount">$' + (remaining * 0.5).toFixed(2) + '</div></div>';
        html += '<div class="payment-option" onclick="selectPayment(this, \'full\')"><div class="payment-option-title">Pay in Full</div>';
        html += '<div class="payment-option-amount">$' + remaining.toFixed(2) + '</div></div></div>';
        html += '<div id="payment-element"></div>';
        html += '<button class="btn btn-primary" id="payBtn" onclick="processPayment()">Pay $' + depositAmt + '</button>';
        html += '<div class="payment-info">Secured by Stripe</div></div>';
      }
      html += '</div>';
      document.getElementById('content').innerHTML = html;
      if (!isPaid && permissions.includes('pay')) initStripe();
    }

    function selectPayment(el, type) {
      selectedPayment = type;
      document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected'));
      el.classList.add('selected');
      const remaining = project.quote_total - (project.amount_paid || 0);
      let amount = type === 'deposit' ? Math.max(99, project.quote_total * 0.1) : (type === 'half' ? remaining * 0.5 : remaining);
      document.getElementById('payBtn').textContent = 'Pay $' + amount.toFixed(2);
    }

    async function initStripe() {
      stripe = Stripe('pk_live_51Smr3E3qDbNyHFmdPLN9iXM3rMQv6hKNtXEP5yVpZVRHBFZ5xk0jKvPy4kQMQ6yHVzXSzVBBZlP8rMGKK9TyZ7qJ00q0Y3nKpN');
      try {
        const response = await fetch(API_BASE + '/api/projects/' + project.id + '/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payment_type: selectedPayment, token: portalToken })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error);
        elements = stripe.elements({ clientSecret: data.clientSecret });
        elements.create('payment').mount('#payment-element');
      } catch (error) {
        console.error('Stripe init error:', error);
      }
    }

    async function processPayment() {
      const btn = document.getElementById('payBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';
      try {
        const name = document.getElementById('customerName')?.value;
        const phone = document.getElementById('customerPhone')?.value;
        if (name || phone) {
          await fetch(API_BASE + '/api/projects/approve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: portalToken, customer_name: name, customer_phone: phone })
          });
        }
        const response = await fetch(API_BASE + '/api/projects/' + project.id + '/create-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ payment_type: selectedPayment, token: portalToken })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error);
        const result = await stripe.confirmPayment({
          elements,
          confirmParams: { return_url: window.location.origin + '/customer-portal/success.html?token=' + portalToken }
        });
        if (result.error) throw new Error(result.error.message);
      } catch (error) {
        alert('Payment failed: ' + error.message);
        btn.disabled = false;
        btn.textContent = 'Pay';
      }
    }
  </script>
<script defer src="/js/remodely-hub.js?v=20260118"></script>
</body>
</html>
