<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Inventory Management | Distributor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --gold-glow: rgba(249, 203, 0, 0.35);
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --success: #22c55e;
      --error: #ef4444;
      --blue-accent: #3b82f6;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text-primary);
      padding: 32px;
    }

    /* Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 800;
    }

    .back-link {
      font-size: 14px;
      color: var(--text-muted);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .back-link:hover {
      color: var(--gold-primary);
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
    }

    .btn-secondary {
      background: var(--dark-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    /* Filters */
    .filters-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .filter-select, .filter-input {
      padding: 10px 14px;
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
    }

    .filter-select {
      min-width: 150px;
    }

    .filter-input {
      flex: 1;
      max-width: 300px;
    }

    /* Table */
    .table-container {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      overflow: hidden;
    }

    .inventory-table {
      width: 100%;
      border-collapse: collapse;
    }

    .inventory-table th,
    .inventory-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid var(--border-subtle);
    }

    .inventory-table th {
      background: var(--dark-elevated);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .inventory-table tr:last-child td {
      border-bottom: none;
    }

    .inventory-table tr:hover {
      background: var(--dark-elevated);
    }

    .slab-row {
      cursor: pointer;
    }

    .slab-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      background: var(--dark-elevated);
    }

    .slab-name {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .slab-sku {
      font-size: 12px;
      color: var(--text-muted);
    }

    .slab-material {
      display: inline-block;
      padding: 4px 10px;
      background: var(--dark-elevated);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }

    .slab-price {
      font-weight: 700;
      color: var(--gold-primary);
    }

    .slab-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .slab-status.available {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .slab-status.sold {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .slab-status.reserved {
      background: rgba(249, 203, 0, 0.1);
      color: var(--gold-primary);
    }

    .actions-cell {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      padding: 8px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 80px 24px;
    }

    .empty-icon {
      width: 80px;
      height: 80px;
      background: var(--dark-elevated);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
    }

    .empty-icon svg {
      width: 40px;
      height: 40px;
      stroke: var(--text-muted);
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    /* CSV Upload Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      background: var(--dark-elevated);
      border: none;
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      padding: 24px;
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-subtle);
      border-radius: 16px;
      padding: 48px 24px;
      text-align: center;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--gold-primary);
      background: rgba(249, 203, 0, 0.05);
    }

    .drop-zone-icon {
      width: 64px;
      height: 64px;
      background: var(--dark-elevated);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
    }

    .drop-zone-icon svg {
      width: 32px;
      height: 32px;
      stroke: var(--gold-primary);
    }

    .drop-zone-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .drop-zone-text {
      font-size: 14px;
      color: var(--text-muted);
    }

    .drop-zone input[type="file"] {
      display: none;
    }

    /* Upload Progress */
    .upload-progress {
      padding: 24px;
      text-align: center;
    }

    .progress-bar-container {
      background: var(--dark-elevated);
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
      margin: 16px 0;
    }

    .progress-bar {
      height: 100%;
      background: var(--gold-primary);
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* Upload Results */
    .upload-results {
      padding: 24px;
    }

    .result-stat {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .result-stat:last-child {
      border-bottom: none;
    }

    .result-label {
      color: var(--text-muted);
    }

    .result-value {
      font-weight: 600;
    }

    .result-value.success { color: var(--success); }
    .result-value.error { color: var(--error); }

    /* CSV Template */
    .template-section {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .template-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .template-columns {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .template-col {
      background: var(--dark-elevated);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-family: monospace;
      color: var(--text-secondary);
    }

    .template-col.required {
      border: 1px solid var(--gold-primary);
      color: var(--gold-primary);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 24px;
    }

    .page-btn {
      width: 36px;
      height: 36px;
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .page-btn:hover {
      border-color: var(--text-muted);
      color: var(--text-primary);
    }

    .page-btn.active {
      background: var(--gold-primary);
      border-color: var(--gold-primary);
      color: var(--dark-primary);
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="page-header">
    <div>
      <a href="/distributor/dashboard/" class="back-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
        Back to Dashboard
      </a>
      <h1 class="page-title">Inventory Management</h1>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="openUploadModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Upload CSV
      </button>
      <a href="/distributor/dashboard/inventory/add/" class="btn btn-primary">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Slab
      </a>
    </div>
  </div>

  <div class="filters-bar">
    <select class="filter-select" id="filterStatus" onchange="loadInventory()">
      <option value="">All Status</option>
      <option value="available">Available</option>
      <option value="reserved">Reserved</option>
      <option value="sold">Sold</option>
    </select>
    <select class="filter-select" id="filterMaterial" onchange="loadInventory()">
      <option value="">All Materials</option>
      <option value="quartz">Quartz</option>
      <option value="granite">Granite</option>
      <option value="marble">Marble</option>
      <option value="quartzite">Quartzite</option>
      <option value="porcelain">Porcelain</option>
    </select>
    <input type="text" class="filter-input" id="filterSearch" placeholder="Search by name, SKU, or brand..." oninput="debounceSearch()">
  </div>

  <div class="table-container">
    <table class="inventory-table">
      <thead>
        <tr>
          <th>Image</th>
          <th>Product</th>
          <th>Material</th>
          <th>Dimensions</th>
          <th>Price</th>
          <th>Status</th>
          <th>Views</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="inventoryBody">
        <tr>
          <td colspan="8">
            <div class="loading"><div class="spinner"></div></div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination" id="pagination"></div>

  <!-- Upload Modal -->
  <div class="modal-overlay" id="uploadModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Upload Inventory CSV</h2>
        <button class="modal-close" onclick="closeUploadModal()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Step 1: Upload -->
        <div id="uploadStep1">
          <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
            <div class="drop-zone-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <div class="drop-zone-title">Drop your CSV file here</div>
            <div class="drop-zone-text">or click to browse (CSV, XLSX)</div>
          </div>

          <div class="template-section">
            <div class="template-title">Required & Optional Columns:</div>
            <div class="template-columns">
              <span class="template-col required">product_name*</span>
              <span class="template-col required">material_type*</span>
              <span class="template-col">external_id</span>
              <span class="template-col">product_sku</span>
              <span class="template-col">brand</span>
              <span class="template-col">collection</span>
              <span class="template-col">length_inches</span>
              <span class="template-col">width_inches</span>
              <span class="template-col">thickness_cm</span>
              <span class="template-col">price_per_sqft</span>
              <span class="template-col">primary_color</span>
              <span class="template-col">finish</span>
              <span class="template-col">primary_image_url</span>
            </div>
            <button class="btn btn-secondary" style="margin-top: 16px;" onclick="downloadTemplate()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Download Template CSV
            </button>
          </div>
        </div>

        <!-- Step 2: Processing -->
        <div id="uploadStep2" style="display: none;">
          <div class="upload-progress">
            <div class="drop-zone-icon">
              <div class="spinner"></div>
            </div>
            <div class="drop-zone-title">Processing your file...</div>
            <div class="progress-bar-container">
              <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">Preparing...</div>
          </div>
        </div>

        <!-- Step 3: Results -->
        <div id="uploadStep3" style="display: none;">
          <div class="upload-results">
            <div class="drop-zone-icon" id="resultIcon">
              <svg viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <h3 style="text-align: center; margin-bottom: 24px;">Upload Complete!</h3>

            <div class="result-stat">
              <span class="result-label">Total Records</span>
              <span class="result-value" id="resultTotal">0</span>
            </div>
            <div class="result-stat">
              <span class="result-label">Created</span>
              <span class="result-value success" id="resultCreated">0</span>
            </div>
            <div class="result-stat">
              <span class="result-label">Updated</span>
              <span class="result-value" id="resultUpdated">0</span>
            </div>
            <div class="result-stat">
              <span class="result-label">Failed</span>
              <span class="result-value error" id="resultFailed">0</span>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 24px;" onclick="closeUploadModal(); loadInventory();">
              View Inventory
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const API_BASE = 'https://surprise-granite-email-api.onrender.com';

    let currentUser = null;
    let currentPage = 1;
    const pageSize = 20;
    let searchTimeout = null;

    async function init() {
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        if (isLocalhost) {
          currentUser = { id: 'demo-user', email: 'demo@example.com' };
          console.log('Demo mode: Using demo user');
          showDemoInventory();
          setupDropZone();
          return;
        }
        window.location.href = '/log-in/?redirect=/distributor/dashboard/inventory/';
        return;
      }
      currentUser = user;
      loadInventory();
      setupDropZone();
    }

    function showDemoInventory() {
      const tbody = document.getElementById('inventoryBody');
      tbody.innerHTML = `
        <tr>
          <td colspan="8">
            <div class="empty-state">
              <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
              </div>
              <h3 class="empty-title">Demo Mode</h3>
              <p class="empty-text">You are viewing the inventory page in demo mode on localhost. Sign in to manage real inventory.</p>
              <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="btn btn-secondary" onclick="openUploadModal()">Upload CSV</button>
                <a href="/distributor/dashboard/inventory/add/" class="btn btn-primary">Add Slab</a>
              </div>
            </div>
          </td>
        </tr>
      `;
    }

    async function loadInventory() {
      const status = document.getElementById('filterStatus').value;
      const material = document.getElementById('filterMaterial').value;
      const search = document.getElementById('filterSearch').value;

      try {
        let query = supabaseClient
          .from('slab_inventory')
          .select('*, distributor_locations(location_name, city)', { count: 'exact' })
          .order('created_at', { ascending: false })
          .range((currentPage - 1) * pageSize, currentPage * pageSize - 1);

        // Get distributor profile first
        const { data: profile } = await supabaseClient
          .from('distributor_profiles')
          .select('id')
          .eq('user_id', currentUser.id)
          .single();

        if (!profile) {
          window.location.href = '/distributor/signup/';
          return;
        }

        query = query.eq('distributor_id', profile.id);

        if (status) query = query.eq('status', status);
        if (material) query = query.eq('material_type', material);
        if (search) {
          query = query.or(`product_name.ilike.%${search}%,product_sku.ilike.%${search}%,brand.ilike.%${search}%`);
        }

        const { data: slabs, error, count } = await query;

        if (error) throw error;

        renderInventory(slabs || []);
        renderPagination(count || 0);

      } catch (err) {
        console.error('Load inventory error:', err);
        document.getElementById('inventoryBody').innerHTML = `
          <tr><td colspan="8" style="text-align: center; padding: 48px; color: var(--text-muted);">Error loading inventory</td></tr>
        `;
      }
    }

    function renderInventory(slabs) {
      const tbody = document.getElementById('inventoryBody');

      if (slabs.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                </div>
                <h3 class="empty-title">No slabs yet</h3>
                <p class="empty-text">Add your first slab manually or upload a CSV file to import your inventory in bulk.</p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                  <button class="btn btn-secondary" onclick="openUploadModal()">Upload CSV</button>
                  <a href="/distributor/dashboard/inventory/add/" class="btn btn-primary">Add Slab</a>
                </div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = slabs.map(slab => `
        <tr class="slab-row" onclick="window.location.href='/distributor/dashboard/inventory/edit/?id=${slab.id}'">
          <td>
            <img src="${slab.primary_image_url || 'https://via.placeholder.com/60x60?text=No+Image'}" alt="${slab.product_name}" class="slab-image">
          </td>
          <td>
            <div class="slab-name">${slab.product_name}</div>
            <div class="slab-sku">${slab.product_sku || slab.bundle_number || '—'}</div>
          </td>
          <td>
            <span class="slab-material">${capitalize(slab.material_type)}</span>
            ${slab.brand ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${slab.brand}</div>` : ''}
          </td>
          <td>
            ${slab.length_inches && slab.width_inches ? `${slab.length_inches}" x ${slab.width_inches}"` : '—'}
            ${slab.square_feet ? `<div style="font-size: 12px; color: var(--text-muted);">${slab.square_feet} sqft</div>` : ''}
          </td>
          <td>
            <div class="slab-price">${slab.price_per_sqft ? '$' + parseFloat(slab.price_per_sqft).toFixed(2) + '/sqft' : '—'}</div>
          </td>
          <td>
            <span class="slab-status ${slab.status}">${capitalize(slab.status)}</span>
          </td>
          <td>${slab.view_count || 0}</td>
          <td onclick="event.stopPropagation()">
            <div class="actions-cell">
              <button class="action-btn" title="Edit" onclick="window.location.href='/distributor/dashboard/inventory/edit/?id=${slab.id}'">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
              </button>
              <button class="action-btn" title="Delete" onclick="deleteSlab('${slab.id}')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderPagination(total) {
      const totalPages = Math.ceil(total / pageSize);
      if (totalPages <= 1) {
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      let html = '';
      for (let i = 1; i <= totalPages; i++) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }
      document.getElementById('pagination').innerHTML = html;
    }

    function goToPage(page) {
      currentPage = page;
      loadInventory();
    }

    function debounceSearch() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        currentPage = 1;
        loadInventory();
      }, 300);
    }

    function capitalize(str) {
      return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }

    // CSV Upload
    function openUploadModal() {
      document.getElementById('uploadModal').classList.add('show');
      resetUploadModal();
    }

    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('show');
    }

    function resetUploadModal() {
      document.getElementById('uploadStep1').style.display = 'block';
      document.getElementById('uploadStep2').style.display = 'none';
      document.getElementById('uploadStep3').style.display = 'none';
    }

    function setupDropZone() {
      const dropZone = document.getElementById('dropZone');

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) processFile(file);
      });
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) processFile(file);
    }

    async function processFile(file) {
      document.getElementById('uploadStep1').style.display = 'none';
      document.getElementById('uploadStep2').style.display = 'block';
      document.getElementById('progressText').textContent = 'Parsing file...';
      document.getElementById('progressBar').style.width = '10%';

      try {
        // Parse CSV
        const results = await new Promise((resolve, reject) => {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: (results) => resolve(results),
            error: (error) => reject(error)
          });
        });

        const slabs = results.data.filter(row => row.product_name && row.material_type);

        if (slabs.length === 0) {
          throw new Error('No valid rows found. Make sure your CSV has product_name and material_type columns.');
        }

        document.getElementById('progressText').textContent = `Uploading ${slabs.length} slabs...`;
        document.getElementById('progressBar').style.width = '30%';

        // Upload to API
        const response = await fetch(`${API_BASE}/api/distributor/inventory/bulk`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-user-id': currentUser.id
          },
          body: JSON.stringify({
            slabs: slabs,
            sync_type: 'incremental'
          })
        });

        const data = await response.json();

        if (data.error) throw new Error(data.error);

        document.getElementById('progressBar').style.width = '100%';

        // Show results
        document.getElementById('uploadStep2').style.display = 'none';
        document.getElementById('uploadStep3').style.display = 'block';

        document.getElementById('resultTotal').textContent = slabs.length;
        document.getElementById('resultCreated').textContent = data.results?.created || 0;
        document.getElementById('resultUpdated').textContent = data.results?.updated || 0;
        document.getElementById('resultFailed').textContent = data.results?.failed || 0;

      } catch (err) {
        console.error('Upload error:', err);
        alert('Upload failed: ' + err.message);
        resetUploadModal();
      }
    }

    function downloadTemplate() {
      const template = `external_id,product_name,material_type,product_sku,brand,collection,length_inches,width_inches,thickness_cm,price_per_sqft,primary_color,finish,primary_image_url
SKU001,Calacatta Gold,marble,CAL-GOLD-001,MSI,Premium Collection,126,76,3,125.00,White,polished,https://example.com/image1.jpg
SKU002,Arctic White,quartz,ARC-WHT-002,Cambria,Classic Series,120,55,2,85.00,White,polished,https://example.com/image2.jpg`;

      const blob = new Blob([template], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'slab_inventory_template.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function deleteSlab(id) {
      if (!confirm('Are you sure you want to delete this slab?')) return;

      try {
        const response = await fetch(`${API_BASE}/api/distributor/inventory/${id}`, {
          method: 'DELETE',
          headers: { 'x-user-id': currentUser.id }
        });

        const data = await response.json();
        if (data.error) throw new Error(data.error);

        loadInventory();
      } catch (err) {
        alert('Delete failed: ' + err.message);
      }
    }

    init();
  </script>
<script defer src="/js/remodely-hub.js?v=20260118"></script>
</body>
</html>
