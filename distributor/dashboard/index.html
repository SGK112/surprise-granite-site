<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Distributor Dashboard | Surprise Granite Marketplace</title>
  <meta name="description" content="Manage your stone inventory, view analytics, and connect with fabricators."/>
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb269c6fbb176_Surprise-Granite-favicon-32x32px.png" rel="shortcut icon" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --gold-primary: #f9cb00;
      --gold-dark: #cca600;
      --gold-glow: rgba(249, 203, 0, 0.35);
      --dark-primary: #1a1a2e;
      --dark-deep: #0a0a12;
      --dark-surface: #12121a;
      --dark-elevated: #1e1e2d;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.75);
      --text-muted: rgba(255, 255, 255, 0.5);
      --border-subtle: rgba(255, 255, 255, 0.1);
      --success: #22c55e;
      --error: #ef4444;
      --blue-accent: #3b82f6;
      --sidebar-width: 260px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--dark-deep);
      min-height: 100vh;
      color: var(--text-primary);
    }

    /* Layout */
    .dashboard-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--dark-surface);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 0;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 100;
    }

    .sidebar-logo {
      padding: 0 24px 24px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 24px;
    }

    .sidebar-logo img {
      height: 32px;
    }

    .sidebar-logo span {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sidebar-nav {
      padding: 0 12px;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: var(--dark-elevated);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: rgba(249, 203, 0, 0.1);
      color: var(--gold-primary);
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      flex-shrink: 0;
    }

    .nav-badge {
      margin-left: auto;
      background: var(--gold-primary);
      color: var(--dark-primary);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 100px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 32px;
    }

    /* Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 800;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    .stat-card {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
    }

    .stat-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .stat-icon {
      width: 44px;
      height: 44px;
      background: rgba(249, 203, 0, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-icon svg {
      width: 22px;
      height: 22px;
      stroke: var(--gold-primary);
    }

    .stat-icon.blue { background: rgba(59, 130, 246, 0.1); }
    .stat-icon.blue svg { stroke: var(--blue-accent); }
    .stat-icon.green { background: rgba(34, 197, 94, 0.1); }
    .stat-icon.green svg { stroke: var(--success); }

    .stat-change {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 6px;
    }

    .stat-change.up {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .stat-change.down {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* Cards */
    .card {
      background: var(--dark-surface);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 700;
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .quick-actions {
        grid-template-columns: 1fr;
      }
    }

    .action-card {
      background: var(--dark-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 20px;
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .action-card:hover {
      border-color: var(--gold-primary);
      transform: translateY(-2px);
    }

    .action-icon {
      width: 48px;
      height: 48px;
      background: rgba(249, 203, 0, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }

    .action-icon svg {
      width: 24px;
      height: 24px;
      stroke: var(--gold-primary);
    }

    .action-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .action-desc {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Recent Activity */
    .activity-list {
      list-style: none;
    }

    .activity-item {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--gold-primary);
      margin-top: 6px;
      flex-shrink: 0;
    }

    .activity-dot.blue { background: var(--blue-accent); }
    .activity-dot.green { background: var(--success); }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .activity-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%);
      color: var(--dark-primary);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px var(--gold-glow);
    }

    .btn-secondary {
      background: var(--dark-elevated);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
    }

    .btn svg {
      width: 18px;
      height: 18px;
    }

    /* User Menu */
    .user-section {
      padding: 16px 24px;
      border-top: 1px solid var(--border-subtle);
      margin-top: auto;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gold-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--dark-primary);
      font-size: 16px;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
    }

    .user-email {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
    }

    .empty-icon {
      width: 64px;
      height: 64px;
      background: var(--dark-elevated);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .empty-icon svg {
      width: 32px;
      height: 32px;
      stroke: var(--text-muted);
    }

    .empty-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-subtle);
      border-top-color: var(--gold-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding: 20px;
      }

      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <img src="https://cdn.prod.website-files.com/6456ce4476abb25581fbad0c/6456ce4476abb255e1fbad54_surprise-granite-gold.svg" alt="Surprise Granite">
        <span>Distributor Portal</span>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="/distributor/dashboard/" class="nav-item active">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
            Dashboard
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Inventory</div>
          <a href="/distributor/dashboard/inventory/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
            All Slabs
            <span class="nav-badge" id="slabCount">0</span>
          </a>
          <a href="/distributor/dashboard/inventory/?status=available" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Available
          </a>
          <a href="/distributor/dashboard/inventory/add/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Slab
          </a>
          <a href="/distributor/dashboard/inventory/upload/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Upload CSV
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Business</div>
          <a href="/distributor/dashboard/inquiries/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            Inquiries
            <span class="nav-badge" id="inquiryCount">0</span>
          </a>
          <a href="/distributor/dashboard/locations/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            Locations
          </a>
          <a href="/distributor/dashboard/analytics/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            Analytics
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Settings</div>
          <a href="/distributor/dashboard/settings/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
            Company Profile
          </a>
          <a href="/distributor/dashboard/settings/api/" class="nav-item">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            API Keys
          </a>
        </div>
      </nav>

      <div class="user-section">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">?</div>
          <div>
            <div class="user-name" id="userName">Loading...</div>
            <div class="user-email" id="userEmail"></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <div>
          <h1 class="page-title">Welcome back!</h1>
          <p class="page-subtitle" id="companyName">Loading your dashboard...</p>
        </div>
        <div class="header-actions">
          <a href="/distributor/dashboard/inventory/add/" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Slab
          </a>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
            </div>
          </div>
          <div class="stat-value" id="totalSlabs">0</div>
          <div class="stat-label">Total Slabs</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon blue">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </div>
          </div>
          <div class="stat-value" id="totalViews">0</div>
          <div class="stat-label">Total Views</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon green">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
            </div>
          </div>
          <div class="stat-value" id="totalInquiries">0</div>
          <div class="stat-label">Inquiries</div>
        </div>

        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            </div>
          </div>
          <div class="stat-value" id="totalRevenue">$0</div>
          <div class="stat-label">Revenue (Platform)</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Quick Actions</h2>
        </div>
        <div class="quick-actions">
          <a href="/distributor/dashboard/inventory/add/" class="action-card">
            <div class="action-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            </div>
            <div class="action-title">Add Single Slab</div>
            <div class="action-desc">Manually add a new slab to your inventory</div>
          </a>

          <a href="/distributor/dashboard/inventory/upload/" class="action-card">
            <div class="action-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            </div>
            <div class="action-title">Upload CSV</div>
            <div class="action-desc">Bulk import your inventory from a spreadsheet</div>
          </a>

          <a href="/distributor/dashboard/settings/api/" class="action-card">
            <div class="action-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
            </div>
            <div class="action-title">Setup API</div>
            <div class="action-desc">Connect your inventory system for live sync</div>
          </a>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card" id="activityCard">
        <div class="card-header">
          <h2 class="card-title">Recent Activity</h2>
          <a href="/distributor/dashboard/inquiries/" class="btn btn-secondary">View All</a>
        </div>
        <div id="activityContent">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Supabase Config
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const API_BASE = 'https://surprise-granite-email-api.onrender.com';

    let currentUser = null;
    let accessToken = null;
    let distributorProfile = null;
    let isAdmin = false;

    // Super admin emails that can view any distributor
    const SUPER_ADMIN_EMAILS = [
      'steve@surprisegranite.com',
      'admin@surprisegranite.com',
      'sgk112@gmail.com'
    ];

    function getAuthHeaders() {
      const headers = { 'Content-Type': 'application/json' };
      if (accessToken) {
        headers['Authorization'] = `Bearer ${accessToken}`;
      }
      return headers;
    }

    // Check auth on load
    async function init() {
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';

      // First check for existing session
      let { data: { session } } = await supabaseClient.auth.getSession();

      // If no session, try to refresh (in case of page reload)
      if (!session) {
        const { data: refreshData } = await supabaseClient.auth.refreshSession();
        session = refreshData?.session;
      }

      if (!session) {
        if (isLocalhost) {
          currentUser = { id: 'demo-user', email: 'demo@example.com' };
          console.log('Demo mode: Using demo user');
          showDemoState();
          return;
        }
        // Store redirect destination for after login
        sessionStorage.setItem('auth_redirect', '/distributor/dashboard/');
        window.location.href = '/log-in/?redirect=/distributor/dashboard/';
        return;
      }

      currentUser = session.user;
      accessToken = session.access_token;
      isAdmin = SUPER_ADMIN_EMAILS.includes((session.user.email || '').toLowerCase());
      await loadDashboard();
    }

    function showDemoState() {
      // Update UI for demo mode
      document.getElementById('companyName').textContent = 'Demo Company';
      document.getElementById('userName').textContent = 'Demo User';
      document.getElementById('userEmail').textContent = 'demo@example.com';
      document.getElementById('userAvatar').textContent = 'D';

      // Show empty state for activity
      document.getElementById('activityContent').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
          </div>
          <h3 class="empty-title">Demo Mode</h3>
          <p class="empty-text">You are viewing the dashboard in demo mode on localhost. Sign in to see real data.</p>
        </div>
      `;
    }

    // Admin view - show list of all distributors to pick from
    async function showAdminDistributorPicker() {
      document.getElementById('companyName').textContent = 'Admin View';
      document.getElementById('userName').textContent = 'Super Admin';
      document.getElementById('userEmail').textContent = currentUser.email;
      document.getElementById('userAvatar').textContent = '⚡';

      // Fetch all distributors
      const { data: distributors, error } = await supabaseClient
        .from('distributor_profiles')
        .select('id, company_name, company_type, is_stone_yard_partner, verification_status, created_at')
        .order('company_name');

      if (error) {
        console.error('Error loading distributors:', error);
        return;
      }

      const content = document.getElementById('activityContent') || document.querySelector('.dashboard-content');
      content.innerHTML = `
        <div style="padding: 24px;">
          <div style="background: linear-gradient(135deg, rgba(249,203,0,0.15) 0%, rgba(249,203,0,0.05) 100%); border: 1px solid rgba(249,203,0,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
            <h3 style="margin: 0 0 8px; color: #f9cb00; font-size: 16px;">⚡ Admin Mode</h3>
            <p style="margin: 0; color: rgba(255,255,255,0.7); font-size: 14px;">Select a distributor to view their dashboard, or manage stone yard partners.</p>
          </div>

          <h3 style="margin: 0 0 16px; font-size: 18px;">All Distributors (${distributors.length})</h3>
          <div style="display: grid; gap: 12px;">
            ${distributors.map(d => `
              <a href="/distributor/dashboard/?distributor=${d.id}" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--dark-elevated, #1e1e2d); border: 1px solid var(--border-subtle, rgba(255,255,255,0.1)); border-radius: 10px; text-decoration: none; color: inherit; transition: all 0.2s;">
                <div>
                  <div style="font-weight: 600; margin-bottom: 4px;">${d.company_name}</div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5);">
                    ${d.company_type}${d.is_stone_yard_partner ? ' • Stone Yard Partner' : ''} • ${d.verification_status}
                  </div>
                </div>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.5;"><path d="M9 18l6-6-6-6"/></svg>
              </a>
            `).join('')}
          </div>

          <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
            <a href="/account/" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; background: var(--dark-surface, #12121a); border: 1px solid var(--border-subtle, rgba(255,255,255,0.1)); border-radius: 8px; color: inherit; text-decoration: none; font-size: 14px;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
              Back to Account
            </a>
          </div>
        </div>
      `;
    }

    async function loadDashboard() {
      try {
        // Check for admin viewing specific distributor via ?distributor=id
        const urlParams = new URLSearchParams(window.location.search);
        const viewDistributorId = urlParams.get('distributor');

        let profile = null;

        if (isAdmin && viewDistributorId) {
          // Admin viewing specific distributor
          const { data, error } = await supabaseClient
            .from('distributor_profiles')
            .select('*')
            .eq('id', viewDistributorId)
            .single();

          if (!error && data) {
            profile = data;
            console.log('Admin viewing distributor:', profile.company_name);
          }
        }

        if (!profile) {
          // Get own distributor profile
          const { data, error } = await supabaseClient
            .from('distributor_profiles')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

          if (!error && data) {
            profile = data;
          }
        }

        if (!profile) {
          // Not a distributor - check if admin
          if (isAdmin) {
            showAdminDistributorPicker();
            return;
          }
          // Regular user without distributor profile - redirect to signup
          window.location.href = '/distributor/signup/';
          return;
        }

        distributorProfile = profile;

        // Update UI
        document.getElementById('companyName').textContent = profile.company_name;
        document.getElementById('userName').textContent = profile.primary_contact_name;
        document.getElementById('userEmail').textContent = profile.primary_contact_email;
        document.getElementById('userAvatar').textContent = profile.primary_contact_name.charAt(0).toUpperCase();

        // Show admin banner if viewing as admin
        if (isAdmin && urlParams.get('distributor')) {
          const banner = document.createElement('div');
          banner.innerHTML = `
            <div style="background: linear-gradient(135deg, rgba(249,203,0,0.2) 0%, rgba(249,203,0,0.1) 100%); border-bottom: 1px solid rgba(249,203,0,0.3); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 16px;">⚡</span>
                <span style="font-size: 13px; color: #f9cb00; font-weight: 600;">Admin View</span>
                <span style="font-size: 13px; color: rgba(255,255,255,0.6);">Viewing: ${profile.company_name}</span>
              </div>
              <a href="/distributor/dashboard/" style="font-size: 12px; color: #f9cb00; text-decoration: none;">← Back to All Distributors</a>
            </div>
          `;
          document.body.insertBefore(banner, document.body.firstChild);
        }

        // Load stats
        await loadStats();

        // Load recent activity
        await loadRecentActivity();

      } catch (err) {
        console.error('Dashboard load error:', err);
      }
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/api/distributor/analytics`, {
          headers: getAuthHeaders()
        });
        const data = await response.json();

        if (data.summary) {
          document.getElementById('totalSlabs').textContent = data.summary.total_slabs || 0;
          document.getElementById('totalViews').textContent = formatNumber(data.summary.total_views || 0);
          document.getElementById('totalInquiries').textContent = data.summary.total_inquiries || 0;
          document.getElementById('totalRevenue').textContent = '$' + formatNumber(data.summary.total_revenue || 0);
          document.getElementById('slabCount').textContent = data.summary.total_slabs || 0;
          document.getElementById('inquiryCount').textContent = data.summary.recent_inquiries || 0;
        }
      } catch (err) {
        console.error('Stats load error:', err);
      }
    }

    async function loadRecentActivity() {
      try {
        // Load recent inquiries
        const { data: inquiries, error } = await supabaseClient
          .from('slab_inquiries')
          .select('*, slab_inventory(product_name)')
          .eq('distributor_id', distributorProfile.id)
          .order('created_at', { ascending: false })
          .limit(5);

        const container = document.getElementById('activityContent');

        if (!inquiries || inquiries.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
              </div>
              <h3 class="empty-title">No activity yet</h3>
              <p class="empty-text">Inquiries from customers will appear here. Add some slabs to start receiving interest!</p>
              <a href="/distributor/dashboard/inventory/add/" class="btn btn-primary">Add Your First Slab</a>
            </div>
          `;
          return;
        }

        const activityHtml = `
          <ul class="activity-list">
            ${inquiries.map(inq => `
              <li class="activity-item">
                <div class="activity-dot ${inq.status === 'new' ? '' : 'green'}"></div>
                <div class="activity-content">
                  <div class="activity-text">
                    <strong>${inq.name}</strong> inquired about <strong>${inq.slab_inventory?.product_name || 'a slab'}</strong>
                  </div>
                  <div class="activity-time">${formatTimeAgo(inq.created_at)}</div>
                </div>
              </li>
            `).join('')}
          </ul>
        `;

        container.innerHTML = activityHtml;

      } catch (err) {
        console.error('Activity load error:', err);
        document.getElementById('activityContent').innerHTML = '<p style="color: var(--text-muted); padding: 20px;">Unable to load activity</p>';
      }
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toLocaleString();
    }

    function formatTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString();
    }

    // Initialize
    init();
  </script>
<script defer src="/js/remodely-hub.js?v=20260118"></script>
</body>
</html>
