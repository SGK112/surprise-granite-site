    // Supabase config
    const SUPABASE_URL = 'https://ypeypgwsycxcagncgdur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlwZXlwZ3dzeWN4Y2FnbmNnZHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NTQ4MjMsImV4cCI6MjA4MzMzMDgyM30.R13pNv2FDtGhfeu7gUcttYNrQAbNYitqR4FIq3O2-ME';

    const SUPER_ADMIN_EMAILS = ['joshb@surprisegranite.com', 'info@surprisegranite.com'];

    let supabaseClient;
    let currentUser = null;
    let userProfile = null;
    let isAdmin = false;
    let isSuperAdmin = false;
    let userRole = 'customer'; // customer, contractor, vendor, admin

    // Google Maps variables (googleMapsReady is defined in head section)
    let locationAutocomplete = null;
    let locationMap = null;
    let locationMarker = null;

    // Listen for Google Maps ready event (dispatched by callback in head)
    document.addEventListener('googlemaps-ready', function() {
      // Initialize autocomplete on location input if it exists and modal is open
      const locationInput = document.getElementById('cal-event-location');
      if (locationInput && document.getElementById('calendar-event-modal')?.classList.contains('active')) {
        initLocationAutocomplete(locationInput);
      }
    });

    // Initialize Places Autocomplete on an input element
    function initLocationAutocomplete(inputElement) {
      if (!googleMapsReady || !google?.maps?.places) {
        return;
      }

      try {
        locationAutocomplete = new google.maps.places.Autocomplete(inputElement, {
          types: ['address'],
          componentRestrictions: { country: 'us' },
          fields: ['formatted_address', 'geometry', 'name', 'address_components']
        });

        locationAutocomplete.addListener('place_changed', () => {
          const place = locationAutocomplete.getPlace();
          if (place.geometry) {
            updateLocationMapPreview(place);
          }
        });

      } catch (err) {
        console.warn('[GoogleMaps] Failed to initialize autocomplete:', err);
      }
    }

    // Update map preview when address is selected
    function updateLocationMapPreview(place) {
      const mapContainer = document.getElementById('location-map-preview');
      const mapElement = document.getElementById('location-map');
      const addressDisplay = document.getElementById('location-map-address');

      if (!mapContainer || !mapElement || !place.geometry) return;

      // Show map preview
      mapContainer.style.display = 'block';

      // Update address text
      if (addressDisplay) {
        addressDisplay.textContent = place.formatted_address || place.name || '';
      }

      // Initialize or update map
      const location = place.geometry.location;

      if (!locationMap) {
        locationMap = new google.maps.Map(mapElement, {
          center: location,
          zoom: 15,
          disableDefaultUI: true,
          zoomControl: true,
          styles: [
            { elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
            { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a2e' }] },
            { elementType: 'labels.text.fill', stylers: [{ color: '#8b8b8b' }] },
            { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d2d44' }] },
            { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e1a' }] }
          ]
        });
      } else {
        locationMap.setCenter(location);
      }

      // Add or update marker
      if (locationMarker) {
        locationMarker.setPosition(location);
      } else {
        locationMarker = new google.maps.Marker({
          map: locationMap,
          position: location,
          animation: google.maps.Animation.DROP
        });
      }
    }

    // Hide map preview
    function hideLocationMapPreview() {
      const mapContainer = document.getElementById('location-map-preview');
      if (mapContainer) {
        mapContainer.style.display = 'none';
      }
    }

    // Generate Google Calendar URL for an event
    function generateGoogleCalendarUrl(event) {
      const baseUrl = 'https://calendar.google.com/calendar/render';

      // Format dates for Google Calendar (YYYYMMDDTHHmmssZ format)
      const formatDateForGCal = (dateStr) => {
        const d = new Date(dateStr);
        return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
      };

      const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: event.title || 'Appointment',
        dates: `${formatDateForGCal(event.start_time)}/${formatDateForGCal(event.end_time)}`,
        details: event.description || '',
        location: event.location || '',
        sf: 'true',
        output: 'xml'
      });

      return `${baseUrl}?${params.toString()}`;
    }

    // Open Google Calendar with event details
    function addToGoogleCalendar(event) {
      const url = generateGoogleCalendarUrl(event);
      window.open(url, '_blank', 'noopener,noreferrer');
    }

    // Initialize map in event detail modal
    let eventDetailMap = null;
    let eventDetailMarker = null;

    function initEventDetailMap(address) {
      if (!googleMapsReady || !google?.maps) {
        return;
      }

      const mapElement = document.getElementById('event-detail-map');
      if (!mapElement) return;

      // Use Geocoder to get coordinates from address
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          const location = results[0].geometry.location;

          // Create or update map
          eventDetailMap = new google.maps.Map(mapElement, {
            center: location,
            zoom: 15,
            disableDefaultUI: true,
            zoomControl: false,
            styles: [
              { elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
              { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a2e' }] },
              { elementType: 'labels.text.fill', stylers: [{ color: '#8b8b8b' }] },
              { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d2d44' }] },
              { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e0e1a' }] },
              { featureType: 'poi', stylers: [{ visibility: 'off' }] }
            ]
          });

          // Add marker
          eventDetailMarker = new google.maps.Marker({
            map: eventDetailMap,
            position: location,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: '#f9cb00',
              fillOpacity: 1,
              strokeColor: '#ffffff',
              strokeWeight: 2
            }
          });
        } else {
          // Hide map container if geocoding fails
          mapElement.style.display = 'none';
          console.log('[GoogleMaps] Geocoding failed for:', address);
        }
      });
    }

    // Auth ready state tracking - prevents race conditions
    let authReady = false;
    let authReadyPromise = null;
    let authReadyResolve = null;

    // Create promise that resolves when auth is ready
    function createAuthReadyPromise() {
      authReadyPromise = new Promise(resolve => {
        authReadyResolve = resolve;
      });
    }
    createAuthReadyPromise();

    function setAuthReady() {
      authReady = true;
      if (authReadyResolve) {
        authReadyResolve();
      }
    }

    async function waitForAuth(timeoutMs = 10000) {
      console.log('[Auth] waitForAuth called, authReady:', authReady);
      if (authReady) return true;
      if (authReadyPromise) {
        // Add timeout to prevent infinite wait
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Auth timeout')), timeoutMs);
        });
        try {
          await Promise.race([authReadyPromise, timeoutPromise]);
        } catch (err) {
          console.error('[Auth] waitForAuth timeout or error:', err.message);
          // If we timeout, check if supabaseClient exists and try to proceed anyway
          if (supabaseClient) {
            authReady = true;
            return true;
          }
          return false;
        }
      }
      console.log('[Auth] waitForAuth completed, authReady:', authReady);
      return authReady;
    }

    // Role-based feature permissions
    const ROLE_PERMISSIONS = {
      homeowner: {
        nav: ['dashboard', 'profile', 'favorites', 'tools', 'calendar'],
        features: ['view_own_jobs', 'view_estimates', 'approve_estimates', 'pay_invoices', 'view_calendar', 'upload_files', 'leave_reviews']
      },
      customer: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'calendar', 'messages'],
        features: ['view_own_jobs', 'view_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews']
      },
      pro: {
        nav: ['dashboard', 'profile', 'favorites', 'my-designs', 'listings', 'leads', 'customers', 'estimates', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'messages'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'message_team', 'view_calendar', 'upload_files', 'view_collaborators', 'manage_customers', 'view_leads', 'ai_tools', 'analytics']
      },
      contractor: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'customers', 'estimates', 'invoices', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'products', 'orders', 'messages'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews', 'view_collaborators', 'manage_customers', 'view_leads', 'hire_subcollaborators', 'ai_tools', 'analytics']
      },
      fabricator: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'customers', 'estimates', 'invoices', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'products', 'orders', 'messages', 'inventory', 'slabs'],
        features: ['view_own_jobs', 'create_jobs', 'view_estimates', 'send_estimates', 'approve_estimates', 'pay_invoices', 'message_team', 'view_calendar', 'upload_files', 'leave_reviews', 'view_collaborators', 'manage_customers', 'view_leads', 'hire_subcollaborators', 'ai_tools', 'analytics', 'manage_inventory', 'slab_management']
      },
      vendor: {
        nav: ['dashboard', 'profile', 'products', 'orders', 'customers', 'messages', 'calendar', 'wallet'],
        features: ['list_products', 'receive_orders', 'view_analytics', 'message_team', 'manage_inventory', 'connect_collaborators']
      },
      distributor: {
        nav: ['dashboard', 'profile', 'products', 'orders', 'customers', 'messages', 'calendar', 'wallet', 'inventory', 'slabs'],
        features: ['list_products', 'receive_orders', 'view_analytics', 'message_team', 'manage_inventory', 'slab_management', 'connect_collaborators'],
        redirectTo: '/distributor/dashboard/'
      },
      admin: {
        nav: ['dashboard', 'profile', 'favorites', 'listings', 'leads', 'customers', 'estimates', 'invoices', 'projects', 'jobs', 'collaborators', 'calendar', 'wallet', 'admin-users', 'products', 'orders', 'messages', 'inventory', 'slabs', 'analytics', 'settings'],
        features: ['full_access']
      }
    };

    // Apply role-based navigation visibility
    function applyRoleBasedNav(role) {
      const permissions = ROLE_PERMISSIONS[role] || ROLE_PERMISSIONS.customer;
      const allowedNavItems = permissions.nav;

      console.log('Applying nav for role:', role, 'Allowed items:', allowedNavItems);

      // Get all nav items with data-page attribute
      const navItems = document.querySelectorAll('.nav-item[data-page]');

      navItems.forEach(item => {
        const page = item.dataset.page;
        if (allowedNavItems.includes(page)) {
          item.classList.remove('hidden');
        } else {
          item.classList.add('hidden');
        }
      });

      // Show/hide nav sections based on role
      const salesNavEl = document.getElementById('sales-nav');
      const operationsNavEl = document.getElementById('operations-nav');
      const financeNavEl = document.getElementById('finance-nav');
      const adminNavEl = document.getElementById('admin-nav');
      const vendorNavEl = document.getElementById('vendor-nav');

      // Sales section - visible to collaborators and admins
      if (salesNavEl) {
        const showSalesNav = ['contractor', 'fabricator', 'admin'].includes(role);
        salesNavEl.classList.toggle('hidden', !showSalesNav);
      }

      // Operations section - visible to all roles for project management
      if (operationsNavEl) {
        operationsNavEl.classList.remove('hidden');
      }

      // Finance section - visible to admins only
      if (financeNavEl) {
        const showFinanceNav = ['admin'].includes(role);
        financeNavEl.classList.toggle('hidden', !showFinanceNav);
      }

      // Admin section - visible to super admins only
      if (adminNavEl) {
        const showAdminNav = isSuperAdmin || role === 'admin';
        adminNavEl.classList.toggle('hidden', !showAdminNav);
      }

      // Vendor/Store section - visible to vendors and admins
      if (vendorNavEl) {
        const showVendorNav = ['vendor', 'admin'].includes(role);
        vendorNavEl.classList.toggle('hidden', !showVendorNav);
      }

      // GOD MODE section - visible ONLY to GOD_MODE_EMAILS
      const godModeNavEl = document.getElementById('god-mode-nav');
      if (godModeNavEl) {
        const showGodMode = isGodMode();
        godModeNavEl.classList.toggle('hidden', !showGodMode);
        // Also set inline display to ensure it's hidden
        godModeNavEl.style.display = showGodMode ? 'block' : 'none';

        // Add special body class for GOD MODE users
        if (showGodMode) {
          document.body.classList.add('god-mode-active');
        } else {
          document.body.classList.remove('god-mode-active');
        }
      }

      // Add role indicator to body for CSS targeting
      document.body.dataset.userRole = role;

      console.log('Applied role-based nav for:', role);
    }

    // Check if user has permission for a feature
    function hasPermission(feature) {
      const permissions = ROLE_PERMISSIONS[userRole] || ROLE_PERMISSIONS.customer;
      return permissions.features.includes('full_access') || permissions.features.includes(feature);
    }

    // Switch role (for demo/testing)
    function switchRole(newRole) {
      if (!ROLE_PERMISSIONS[newRole]) return;

      // Check if role has a redirect (like distributor)
      const roleConfig = ROLE_PERMISSIONS[newRole];
      if (roleConfig.redirectTo) {
        showToast(`Redirecting to ${newRole} dashboard...`);
        window.location.href = roleConfig.redirectTo;
        return;
      }

      userRole = newRole;

      // Update role flags based on new role
      isAdmin = ['admin', 'super_admin'].includes(newRole);
      isSuperAdmin = newRole === 'super_admin';

      applyRoleBasedNav(newRole);

      // Update role display
      const roleEl = document.getElementById('user-role');
      const roleLabels = { homeowner: 'Homeowner', customer: 'Customer', contractor: 'Contractor', vendor: 'Vendor', pro: 'Pro', fabricator: 'Fabricator', distributor: 'Distributor', admin: 'Admin' };
      if (roleEl) roleEl.textContent = roleLabels[newRole] || 'Customer';

      // Show notification
      showToast(`Switched to ${roleLabels[newRole]} view`);

      // Refresh current page to show role-specific content
      const activePage = document.querySelector('.page.active');
      if (activePage) {
        const pageId = activePage.id.replace('page-', '');
        showPage(pageId);
      }
    }

    // GOD mode emails - EXCLUSIVE access to developer tools and role switcher
    const GOD_MODE_EMAILS = ['joshb@surprisegranite.com', 'sgk112@gmail.com'];

    // Check if current user has GOD MODE access
    function isGodMode() {
      const userEmail = currentUser?.email?.toLowerCase() || '';
      return GOD_MODE_EMAILS.includes(userEmail);
    }

    // Show role switcher only for GOD mode users
    function enableRoleSwitcher() {
      const switcher = document.getElementById('role-switcher');
      const select = document.getElementById('role-select');
      const userEmail = currentUser?.email?.toLowerCase() || '';

      // Only show for GOD mode emails
      if (switcher && select && GOD_MODE_EMAILS.includes(userEmail)) {
        switcher.style.display = 'block';
        select.value = userRole;
      }
    }

    let allLeads = [];
    let currentFilter = 'all';
    let currentLeadsView = 'grid'; // 'grid', 'list', or 'kanban'
    let selectedLead = null;
    let editingLeadId = null; // Track if we're editing an existing lead
    let showArchivedLeads = false; // Hide archived leads by default

    let allCustomers = [];
    let selectedCustomer = null;
    let customerFilter = 'all';
    let currentCustomerTab = 'jobs';

    // Global contractors state
    let allContractors = [];

    // Global estimates state
    let allEstimates = [];
    let selectedEstimate = null;
    let currentEstimateFilter = 'all';

    // ============================================
    // UNIFIED WORKFLOW STATE
    // Centralized state management for lead → customer → estimate → invoice → job flow
    // ============================================
    const workflowState = {
      currentLead: null,
      currentCustomer: null,
      currentEstimate: null,
      currentInvoice: null,
      currentJob: null,
      reset() {
        this.currentLead = null;
        this.currentCustomer = null;
        this.currentEstimate = null;
        this.currentInvoice = null;
        this.currentJob = null;
      }
    };

    // Modal-specific state for estimate creation
    let estimateModalState = {
      customerId: null,
      leadId: null,
      editingEstimateId: null
    };

    // ============================================
    // UNIVERSAL CONTEXT MENU SYSTEM
    // Right-click menus for jobs, invoices, customers, estimates, leads
    // ============================================
    const ContextMenu = {
      menu: null,
      overlay: null,
      currentItem: null,
      currentType: null,

      init() {
        // Create menu container
        this.menu = document.createElement('div');
        this.menu.className = 'context-menu';
        this.menu.id = 'universal-context-menu';
        document.body.appendChild(this.menu);

        // Create overlay for closing
        this.overlay = document.createElement('div');
        this.overlay.className = 'context-menu-overlay';
        this.overlay.style.display = 'none';
        this.overlay.addEventListener('click', () => this.hide());
        this.overlay.addEventListener('contextmenu', (e) => { e.preventDefault(); this.hide(); });
        document.body.appendChild(this.overlay);

        // Global right-click listener
        document.addEventListener('contextmenu', (e) => this.handleContextMenu(e));

        // Close on scroll or escape
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') this.hide(); });
        document.addEventListener('scroll', () => this.hide(), true);
      },

      handleContextMenu(e) {
        const target = e.target.closest('[data-context-menu]');
        if (!target) return;

        e.preventDefault();

        const menuType = target.dataset.contextMenu;
        const itemId = target.dataset.itemId;
        const itemData = target.dataset.itemData ? JSON.parse(target.dataset.itemData) : {};

        this.show(e.clientX, e.clientY, menuType, itemId, itemData, target);
      },

      show(x, y, type, itemId, itemData, targetElement) {
        this.currentType = type;
        this.currentItem = { id: itemId, ...itemData };

        // Clear previous highlight
        document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));

        // Highlight current row
        if (targetElement) {
          targetElement.classList.add('context-active');
        }

        // Build menu content
        const menuContent = this.buildMenu(type, itemData);
        this.menu.innerHTML = menuContent;

        // Show overlay and menu
        this.overlay.style.display = 'block';
        this.menu.classList.add('visible');

        // Position menu
        this.position(x, y);

        // Attach click handlers
        this.attachHandlers();
      },

      hide() {
        this.menu.classList.remove('visible');
        this.overlay.style.display = 'none';
        document.querySelectorAll('.context-active').forEach(el => el.classList.remove('context-active'));
        this.currentItem = null;
        this.currentType = null;
      },

      position(x, y) {
        const menuRect = this.menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        let posX = x;
        let posY = y;
        let originClass = '';

        // Adjust for right edge
        if (x + menuRect.width > viewportWidth - 10) {
          posX = x - menuRect.width;
          originClass = 'origin-right';
        }

        // Adjust for bottom edge
        if (y + menuRect.height > viewportHeight - 10) {
          posY = y - menuRect.height;
          originClass = originClass ? 'origin-bottom-right' : 'origin-bottom';
        }

        this.menu.style.left = Math.max(10, posX) + 'px';
        this.menu.style.top = Math.max(10, posY) + 'px';
        this.menu.className = 'context-menu visible ' + originClass;
      },

      buildMenu(type, itemData) {
        const menus = {
          job: this.buildJobMenu(itemData),
          invoice: this.buildInvoiceMenu(itemData),
          customer: this.buildCustomerMenu(itemData),
          estimate: this.buildEstimateMenu(itemData),
          lead: this.buildLeadMenu(itemData),
          calendar_event: this.buildCalendarEventMenu(itemData)
        };
        return menus[type] || '';
      },

      buildJobMenu(data) {
        const statusOptions = [
          { value: 'new', label: 'New' },
          { value: 'reviewing', label: 'Reviewing' },
          { value: 'material_ordered', label: 'Material Ordered' },
          { value: 'material_received', label: 'Material Received' },
          { value: 'scheduled', label: 'Scheduled' },
          { value: 'measured', label: 'Measured' },
          { value: 'in_production', label: 'In Production' },
          { value: 'ready', label: 'Ready' },
          { value: 'installing', label: 'Installing' },
          { value: 'completed', label: 'Completed' },
          { value: 'on_hold', label: 'On Hold' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">Job</div>
            <div class="subtitle">${data.job_number || 'Job'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Details
          </button>
          <button class="context-menu-item has-submenu">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <span class="status-dot ${s.value}"></span>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="schedule">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Schedule Job
          </button>
          <button class="context-menu-item" data-action="assign">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            Assign Collaborator
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item warning" data-action="archive">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
            Archive Job
          </button>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Job
          </button>
        `;
      },

      buildInvoiceMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Invoice</div>
            <div class="subtitle">${data.invoice_number || 'Invoice'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
            View Invoice
          </button>
          <button class="context-menu-item" data-action="open-stripe">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            Open in Stripe
          </button>
          <button class="context-menu-item" data-action="download-pdf">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Download PDF
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="send-reminder">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Reminder
          </button>
          <button class="context-menu-item" data-action="copy-link">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
            Copy Payment Link
          </button>
          <button class="context-menu-item" data-action="create-project">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            Create Project
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="void">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
            Void Invoice
          </button>
        `;
      },

      buildCustomerMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Customer</div>
            <div class="subtitle">${data.name || 'Customer'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            View Profile
          </button>
          <button class="context-menu-item primary" data-action="create-estimate">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            Create Estimate
          </button>
          <button class="context-menu-item" data-action="create-invoice">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
            Create Invoice
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="email">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
            Send Email
          </button>
          <button class="context-menu-item" data-action="call">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
            Call Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            Delete Customer
          </button>
        `;
      },

      buildEstimateMenu(data) {
        return `
          <div class="context-menu-header">
            <div class="title">Estimate</div>
            <div class="subtitle">${data.estimate_number || 'Estimate'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <i class="fa-regular fa-eye"></i>
            View Estimate
          </button>
          <button class="context-menu-item" data-action="edit">
            <i class="fa-regular fa-pen-to-square"></i>
            Edit Estimate
          </button>
          <button class="context-menu-item primary" data-action="convert-invoice">
            <i class="fa-solid fa-file-invoice-dollar"></i>
            Convert to Invoice
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="duplicate">
            <i class="fa-regular fa-clone"></i>
            Duplicate
          </button>
          <button class="context-menu-item" data-action="send">
            <i class="fa-regular fa-envelope"></i>
            Send to Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <i class="fa-regular fa-trash-can"></i>
            Delete Estimate
          </button>
        `;
      },

      buildLeadMenu(data) {
        const statusOptions = [
          { value: 'new', label: 'New' },
          { value: 'contacted', label: 'Contacted' },
          { value: 'qualified', label: 'Qualified' },
          { value: 'quoted', label: 'Quoted' },
          { value: 'won', label: 'Won' },
          { value: 'lost', label: 'Lost' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">Lead</div>
            <div class="subtitle">${data.name || 'Lead'}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <i class="fa-regular fa-user"></i>
            View Lead
          </button>
          <button class="context-menu-item primary" data-action="create-estimate">
            <i class="fa-regular fa-file-lines"></i>
            Create Estimate
          </button>
          <button class="context-menu-item has-submenu">
            <i class="fa-solid fa-arrows-rotate"></i>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <span class="status-dot ${s.value}"></span>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item success" data-action="convert-customer">
            <i class="fa-solid fa-user-plus"></i>
            Convert to Customer
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <i class="fa-regular fa-trash-can"></i>
            Delete Lead
          </button>
        `;
      },

      buildCalendarEventMenu(data) {
        const isApiEvent = !!data.apiEventId;
        const isJobEvent = !!data.jobId && !data.apiEventId;
        const statusOptions = [
          { value: 'scheduled', label: 'Scheduled', icon: 'fa-regular fa-calendar' },
          { value: 'confirmed', label: 'Confirmed', icon: 'fa-solid fa-circle-check' },
          { value: 'completed', label: 'Completed', icon: 'fa-solid fa-flag-checkered' },
          { value: 'cancelled', label: 'Cancelled', icon: 'fa-solid fa-circle-xmark' },
          { value: 'rescheduled', label: 'Rescheduled', icon: 'fa-solid fa-rotate' },
          { value: 'no_show', label: 'No Show', icon: 'fa-solid fa-user-slash' }
        ];

        return `
          <div class="context-menu-header">
            <div class="title">${isJobEvent ? 'Job Event' : 'Calendar Event'}</div>
            <div class="subtitle">${escapeHtml(data.title || 'Event')}</div>
          </div>
          <button class="context-menu-item" data-action="view">
            <i class="fa-regular fa-eye"></i>
            View Details
          </button>
          ${isApiEvent ? `
          <button class="context-menu-item" data-action="edit">
            <i class="fa-regular fa-pen-to-square"></i>
            Edit Event
          </button>
          <button class="context-menu-item has-submenu">
            <i class="fa-solid fa-arrows-rotate"></i>
            Change Status
            <div class="context-submenu">
              ${statusOptions.map(s => `
                <button class="context-menu-item" data-action="status" data-status="${s.value}">
                  <i class="${s.icon}" style="width: 16px; margin-right: 8px;"></i>
                  ${s.label}
                </button>
              `).join('')}
            </div>
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item" data-action="reschedule">
            <i class="fa-regular fa-calendar-days"></i>
            Reschedule
          </button>
          <button class="context-menu-item" data-action="duplicate">
            <i class="fa-regular fa-clone"></i>
            Duplicate Event
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item success" data-action="confirm">
            <i class="fa-solid fa-circle-check"></i>
            Mark Confirmed
          </button>
          <button class="context-menu-item" data-action="complete">
            <i class="fa-solid fa-flag-checkered"></i>
            Mark Completed
          </button>
          <div class="context-menu-divider"></div>
          <button class="context-menu-item danger" data-action="delete">
            <i class="fa-regular fa-trash-can"></i>
            Delete Event
          </button>
          ` : `
          <button class="context-menu-item" data-action="view-job">
            <i class="fa-regular fa-clipboard"></i>
            Open Job Details
          </button>
          <button class="context-menu-item" data-action="create-event">
            <i class="fa-solid fa-calendar-plus"></i>
            Create Calendar Event
          </button>
          `}
        `;
      },

      attachHandlers() {
        this.menu.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            const status = btn.dataset.status;
            this.handleAction(action, status);
          });
        });
      },

      handleAction(action, status) {
        const item = this.currentItem;
        const type = this.currentType;

        this.hide();

        // Route to appropriate handler based on type and action
        switch (type) {
          case 'job':
            this.handleJobAction(action, item, status);
            break;
          case 'invoice':
            this.handleInvoiceAction(action, item);
            break;
          case 'customer':
            this.handleCustomerAction(action, item);
            break;
          case 'estimate':
            this.handleEstimateAction(action, item);
            break;
          case 'lead':
            this.handleLeadAction(action, item, status);
            break;
          case 'calendar_event':
            this.handleCalendarEventAction(action, item, status);
            break;
        }
      },

      async handleJobAction(action, item, status) {
        switch (action) {
          case 'view':
            openJobDetail(item.id);
            break;
          case 'status':
            await updateJobStatusById(item.id, status);
            break;
          case 'schedule':
            openQuickScheduleModal(null, item.id);
            break;
          case 'assign':
            openAssignCollaboratorModal(item.id);
            break;
          case 'archive':
            await archiveJob(item.id);
            break;
          case 'delete':
            await deleteJob(item.id);
            break;
        }
      },

      async handleInvoiceAction(action, item) {
        switch (action) {
          case 'view':
            // Use unified view function that handles both Supabase and Stripe invoices
            viewSupabaseInvoice(item.id);
            break;
          case 'open-stripe':
            if (item.hosted_invoice_url) {
              window.open(item.hosted_invoice_url, '_blank');
            } else {
              showToast('No Stripe payment link available', 'warning');
            }
            break;
          case 'download-pdf':
            if (item.pdf_url) {
              window.open(item.pdf_url, '_blank');
            } else {
              showToast('No PDF available for this invoice', 'warning');
            }
            break;
          case 'send-reminder':
            await sendInvoiceReminder(item.id);
            break;
          case 'copy-link':
            if (item.hosted_invoice_url) {
              await navigator.clipboard.writeText(item.hosted_invoice_url);
              showToast('Payment link copied!', 'success');
            }
            break;
          case 'create-project':
            createProjectFromInvoice(item.id);
            break;
          case 'void':
            await voidInvoice(item.id);
            break;
        }
      },

      handleCustomerAction(action, item) {
        switch (action) {
          case 'view':
            selectCustomer(item.id);
            break;
          case 'create-estimate':
            startEstimateFromCustomer(item.id);
            break;
          case 'create-invoice':
            openInvoiceModal(item);
            break;
          case 'email':
            if (item.email) {
              window.location.href = `mailto:${item.email}`;
            }
            break;
          case 'call':
            if (item.phone) {
              window.location.href = `tel:${item.phone}`;
            }
            break;
          case 'delete':
            deleteCustomer(item.id);
            break;
        }
      },

      async handleEstimateAction(action, item) {
        switch (action) {
          case 'view':
            viewEstimate(item.id);
            break;
          case 'edit':
            editEstimate(item.id);
            break;
          case 'convert-invoice':
            convertEstimateToInvoice(item.id);
            break;
          case 'duplicate':
            await duplicateEstimate(item.id);
            break;
          case 'send':
            sendEstimateEmail(item.id);
            break;
          case 'delete':
            deleteEstimate(item.id);
            break;
        }
      },

      async handleLeadAction(action, item, status) {
        switch (action) {
          case 'view':
            viewLead(item.id);
            break;
          case 'create-estimate':
            startEstimateFromLead(item.id);
            break;
          case 'create-invoice':
            startInvoiceFromLead(item.id);
            break;
          case 'status':
            await updateLeadStatus(item.id, status);
            break;
          case 'convert-customer':
            await convertLeadToCustomer(item.id);
            break;
          case 'delete':
            await deleteLead(item.id);
            break;
        }
      },

      async handleCalendarEventAction(action, item, status) {
        const eventId = item.apiEventId || item.id;
        const jobId = item.jobId;

        switch (action) {
          case 'view':
            if (item.apiEventId) {
              openCalendarEventDetailModal(item.apiEventId);
            } else if (jobId) {
              openJobDetail(jobId);
            }
            break;
          case 'edit':
            if (item.apiEventId) {
              openCalendarEventModal(item.apiEventId);
            }
            break;
          case 'status':
            if (item.apiEventId && status) {
              await updateCalendarEventStatus(item.apiEventId, status);
            }
            break;
          case 'reschedule':
            if (item.apiEventId) {
              openCalendarEventModal(item.apiEventId);
            }
            break;
          case 'duplicate':
            if (item.apiEventId) {
              await duplicateCalendarEvent(item.apiEventId);
            }
            break;
          case 'confirm':
            if (item.apiEventId) {
              await updateCalendarEventStatus(item.apiEventId, 'confirmed');
            }
            break;
          case 'complete':
            if (item.apiEventId) {
              await updateCalendarEventStatus(item.apiEventId, 'completed');
            }
            break;
          case 'delete':
            if (item.apiEventId) {
              await deleteCalendarEvent(item.apiEventId);
            }
            break;
          case 'view-job':
            if (jobId) {
              openJobDetail(jobId);
            }
            break;
          case 'create-event':
            // Create a new calendar event linked to this job
            openCalendarEventModal(null, item.date, {
              title: item.title,
              projectId: jobId,
              type: item.type === 'measure' ? 'measurement' : item.type === 'install' ? 'installation' : 'appointment'
            });
            break;
        }
      }
    };

    // Calendar event status update helper
    async function updateCalendarEventStatus(eventId, status) {
      try {
        const { error } = await supabaseClient
          .from('calendar_events')
          .update({ status, updated_at: new Date().toISOString() })
          .eq('id', eventId);

        if (error) throw error;

        showToast(`Event marked as ${status}`, 'success');
        await loadCalendarEvents();
        await loadAllCalendarEvents();
      } catch (err) {
        console.error('Error updating event status:', err);
        showToast('Failed to update event status', 'error');
      }
    }

    // Duplicate calendar event helper
    async function duplicateCalendarEvent(eventId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Fetch original event
        const { data: original, error: fetchError } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('id', eventId)
          .single();

        if (fetchError) throw fetchError;

        // Create duplicate with new dates (tomorrow)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);

        const originalStart = new Date(original.start_time);
        const originalEnd = new Date(original.end_time);
        const duration = originalEnd - originalStart;

        const newStart = new Date(tomorrow);
        newStart.setHours(originalStart.getHours(), originalStart.getMinutes(), 0, 0);
        const newEnd = new Date(newStart.getTime() + duration);

        const duplicateData = {
          created_by: user.id,
          title: `${original.title} (Copy)`,
          description: original.description,
          event_type: original.event_type,
          meeting_format: original.meeting_format,
          start_time: newStart.toISOString(),
          end_time: newEnd.toISOString(),
          location: original.location,
          lead_id: original.lead_id,
          customer_id: original.customer_id,
          project_id: original.project_id,
          metadata: original.metadata,
          status: 'scheduled'
        };

        const { data: newEvent, error: insertError } = await supabaseClient
          .from('calendar_events')
          .insert(duplicateData)
          .select()
          .single();

        if (insertError) throw insertError;

        showToast('Event duplicated', 'success');

        // Open the new event for editing
        openCalendarEventModal(newEvent.id);

        await loadCalendarEvents();
        await loadAllCalendarEvents();
      } catch (err) {
        console.error('Error duplicating event:', err);
        showToast('Failed to duplicate event', 'error');
      }
    }

    // Initialize context menu on page load
    document.addEventListener('DOMContentLoaded', () => {
      ContextMenu.init();
    });

    // ============================================
    // HELPER FUNCTIONS FOR UNIFIED FLOW
    // ============================================

    // Fetch customer from database (not just cached array)
    async function getCustomer(customerId) {
      if (!customerId) return null;

      // Try cache first
      let customer = allCustomers?.find(c => c.id === customerId);
      if (customer) return customer;

      // Fetch from database
      try {
        const { data, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('id', customerId)
          .single();

        if (!error && data) {
          // Add to cache
          if (!allCustomers) allCustomers = [];
          allCustomers.push(data);
          return data;
        }
      } catch (e) {
        console.error('Error fetching customer:', e);
      }
      return null;
    }

    // Find or create customer from lead data
    async function findOrCreateCustomerFromLead(lead) {
      if (!lead) {
        console.error('[findOrCreateCustomerFromLead] No lead provided');
        return null;
      }

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        console.error('[findOrCreateCustomerFromLead] No user logged in');
        return null;
      }

      console.log('[findOrCreateCustomerFromLead] Processing lead:', lead.id, lead.email);

      // Check if customer already exists with this email
      if (lead.email) {
        const { data: existing, error: findError } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .eq('email', lead.email)
          .maybeSingle();

        if (findError) {
          console.error('[findOrCreateCustomerFromLead] Error finding customer:', findError);
        }

        if (existing) {
          console.log('[findOrCreateCustomerFromLead] Found existing customer:', existing.id);
          // Update lead with customer_id reference
          const { error: updateError } = await supabaseClient.from('leads').update({ customer_id: existing.id }).eq('id', lead.id);
          if (updateError) console.error('[findOrCreateCustomerFromLead] Error updating lead:', updateError);
          return existing;
        }
      }

      // Parse name
      const nameParts = (lead.full_name || '').trim().split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      // Parse address
      let address = '', city = '', state = 'AZ', zip = '';
      if (lead.service_address) {
        // service_address could be string or object
        if (typeof lead.service_address === 'string') {
          address = lead.service_address;
        } else if (typeof lead.service_address === 'object') {
          address = lead.service_address.street || lead.service_address.address || '';
          city = lead.service_address.city || '';
          state = lead.service_address.state || 'AZ';
          zip = lead.service_address.zip || lead.service_address.zip_code || '';
        }
      } else if (lead.billing_address) {
        // billing_address could be string or object
        if (typeof lead.billing_address === 'string') {
          const parts = lead.billing_address.split(',').map(s => s.trim());
          address = parts[0] || '';
          city = parts[1] || '';
          const stateZip = (parts[2] || '').split(' ');
          state = stateZip[0] || 'AZ';
          zip = stateZip[1] || '';
        } else if (typeof lead.billing_address === 'object') {
          address = lead.billing_address.street || lead.billing_address.address || '';
          city = lead.billing_address.city || '';
          state = lead.billing_address.state || 'AZ';
          zip = lead.billing_address.zip || lead.billing_address.zip_code || '';
        }
      } else if (lead.project_address) {
        address = lead.project_address;
      }

      // Create new customer (with bidirectional lead_id reference)
      console.log('[findOrCreateCustomerFromLead] Creating new customer for:', lead.full_name, lead.email);
      const { data: newCustomer, error } = await supabaseClient
        .from('customers')
        .insert({
          user_id: user.id,
          name: lead.full_name || 'Customer',
          email: lead.email || null,
          phone: lead.phone || null,
          address: address || null,
          city: city || null,
          state: state || 'AZ',
          zip: zip || null,
          lead_id: lead.id, // Bidirectional reference back to lead
          source: 'lead_conversion',
          notes: `Converted from lead. Project: ${lead.project_type || 'N/A'}`
        })
        .select()
        .single();

      if (error) {
        console.error('[findOrCreateCustomerFromLead] Error creating customer:', error);
        showToast('Error creating customer: ' + (error.message || 'Unknown error'), 'error');
        return null;
      }

      if (newCustomer) {
        console.log('[findOrCreateCustomerFromLead] Created customer:', newCustomer.id);
        // Update lead with customer reference
        const { error: updateError } = await supabaseClient.from('leads').update({
          customer_id: newCustomer.id,
          status: 'qualified'
        }).eq('id', lead.id);

        if (updateError) {
          console.error('[findOrCreateCustomerFromLead] Error updating lead:', updateError);
        } else {
        }

        // Add to cache
        if (!allCustomers) allCustomers = [];
        allCustomers.push(newCustomer);

        // Refresh leads list
        loadLeads();

        return newCustomer;
      }

      return null;
    }

    // Create customer from estimate form data
    async function createCustomerFromEstimateForm(formData) {
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) return null;

      // Check if customer exists with this email
      if (formData.customerEmail) {
        const { data: existing } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .eq('email', formData.customerEmail)
          .single();

        if (existing) return existing;
      }

      // Create new customer
      const { data: newCustomer, error } = await supabaseClient
        .from('customers')
        .insert({
          user_id: user.id,
          name: formData.customerName || 'Customer',
          email: formData.customerEmail,
          phone: formData.customerPhone,
          address: formData.customerAddress,
          city: formData.customerCity,
          state: formData.customerState || 'AZ',
          source: 'estimate_creation'
        })
        .select()
        .single();

      if (!error && newCustomer) {
        if (!allCustomers) allCustomers = [];
        allCustomers.push(newCustomer);
        return newCustomer;
      }

      return null;
    }

    // Pre-fill estimate form with customer data
    function fillEstimateCustomerFields(customer) {
      if (!customer) return;

      const fields = {
        'estimate-customer-name': customer.name,
        'estimate-customer-email': customer.email,
        'estimate-customer-phone': customer.phone,
        'estimate-customer-address': customer.address,
        'estimate-customer-city': customer.city,
        'estimate-customer-state': customer.state || 'AZ'
      };

      Object.entries(fields).forEach(([id, value]) => {
        const el = document.getElementById(id);
        if (el && value) el.value = value;
      });
    }

    // Initialize with timeout fallback
    document.addEventListener('DOMContentLoaded', async () => {
      // Fallback timer - show dashboard/auth if things take too long
      const fallbackTimer = setTimeout(() => {
        console.warn('Init timeout - forcing display');
        // Check if we have a cached session indicator
        const hasSession = localStorage.getItem('sb-ypeypgwsycxcagncgdur-auth-token');
        if (hasSession) {
          showDashboard();
        } else {
          showAuth();
        }
      }, 5000);

      try {
        // Wait for Supabase to be available (max 3 seconds)
        let attempts = 0;
        while (!window.supabase && attempts < 30) {
          await new Promise(r => setTimeout(r, 100));
          attempts++;
        }

        if (!window.supabase) {
          console.error('Supabase library failed to load after', attempts * 100, 'ms');
          clearTimeout(fallbackTimer);
          showAuth();
          return;
        }

        const { createClient } = window.supabase;

        // Check localStorage availability (mobile Safari ITP workaround)
        let storageAvailable = true;
        try {
          localStorage.setItem('__storage_test__', '1');
          localStorage.removeItem('__storage_test__');
        } catch (e) {
          storageAvailable = false;
          console.warn('localStorage unavailable, using memory storage');
        }

        // Create custom storage that falls back gracefully
        const customStorage = storageAvailable ? window.localStorage : {
          _data: {},
          getItem(key) { return this._data[key] || null; },
          setItem(key, value) { this._data[key] = value; },
          removeItem(key) { delete this._data[key]; }
        };

        // Use global client or create our own
        supabaseClient = window._sgSupabaseClient;
        if (!supabaseClient) {
          const { createClient } = window.supabase;
          supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
              storage: customStorage,
              autoRefreshToken: true,
              persistSession: true
            }
          });
          window._sgSupabaseClient = supabaseClient;
        }

        // Listen for auth state changes (handles token refresh on mobile)
        let authChangeHandled = false;
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          console.log('Account Auth State:', event);

          // Prevent double-handling
          if (authChangeHandled && event === 'INITIAL_SESSION') return;

          if (event === 'SIGNED_OUT' || event === 'USER_DELETED') {
            currentUser = null;
            showAuth();
          } else if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'INITIAL_SESSION') {
            if (session) {
              authChangeHandled = true;
              currentUser = session.user;
              // Refresh profile on token refresh
              loadUserProfile().catch(err => console.warn('Profile refresh failed:', err));
            }
          }
        });

        // Try to get session with retry for mobile
        let session = null;
        let sessionError = null;

        for (let retry = 0; retry < 2; retry++) {
          const result = await supabaseClient.auth.getSession();
          session = result.data?.session;
          sessionError = result.error;

          if (session || !sessionError) break;

          // Wait before retry
          await new Promise(r => setTimeout(r, 500));
        }

        clearTimeout(fallbackTimer);

        if (sessionError) {
          console.error('Session error:', sessionError);
          // Only redirect if this is a real error, not just missing session
          if (sessionError.message?.includes('refresh_token')) {
            showAuth();
            return;
          }
        }

        if (session) {
          currentUser = session.user;
          // Load profile BEFORE showing dashboard so isAdmin is set correctly
          try {
            await loadUserProfile();
          } catch (err) {
            console.warn('[Init] Profile load failed:', err);
          }
          showDashboard();
        } else {
          showAuth();
        }
      } catch (err) {
        clearTimeout(fallbackTimer);
        console.error('Init error:', err);
        showAuth();
      }
    });

    function showAuth() {
      // Check for incoming redirect parameter (e.g., from tools page auth check)
      const params = new URLSearchParams(window.location.search);
      const incomingRedirect = params.get('redirect');
      if (incomingRedirect) {
        // Store the original redirect destination for after login
        sessionStorage.setItem('auth_redirect', incomingRedirect);
      }
      // Redirect to unified login page instead of showing embedded auth
      window.location.href = '/log-in/?redirect=' + encodeURIComponent(window.location.pathname + window.location.hash);
    }

    // ============================================
    // NOTIFICATIONS SYSTEM
    // ============================================
    let allNotifications = [];
    let notificationPanelOpen = false;

    function toggleNotificationPanel() {
      const panel = document.getElementById('notification-panel');
      notificationPanelOpen = !notificationPanelOpen;
      panel.style.display = notificationPanelOpen ? 'block' : 'none';

      if (notificationPanelOpen) {
        loadNotifications();
        // Close when clicking outside
        setTimeout(() => {
          document.addEventListener('click', closeNotificationPanelOnClickOutside);
        }, 100);
      } else {
        document.removeEventListener('click', closeNotificationPanelOnClickOutside);
      }
    }

    function closeNotificationPanelOnClickOutside(e) {
      const panel = document.getElementById('notification-panel');
      const bell = e.target.closest('.notification-bell-wrapper');
      if (!bell && !panel.contains(e.target)) {
        notificationPanelOpen = false;
        panel.style.display = 'none';
        document.removeEventListener('click', closeNotificationPanelOnClickOutside);
      }
    }

    async function loadNotifications() {
      if (!supabaseClient || !currentUser) return;

      try {
        // Load from pro_notifications table
        const { data: notifications, error } = await supabaseClient
          .from('pro_notifications')
          .select('*')
          .eq('pro_user_id', currentUser.id)
          .order('created_at', { ascending: false })
          .limit(20);

        if (error) {
          console.warn('Could not load notifications:', error.message);
          // Fall back to generating notifications from recent activity
          await loadNotificationsFromActivity();
          return;
        }

        // Merge with StateManager viewed state for local persistence
        allNotifications = (notifications || []).map(notif => {
          if (typeof StateManager !== 'undefined' && StateManager.isNotificationViewed(notif.id)) {
            return { ...notif, read: true };
          }
          return notif;
        });
        renderNotificationPanel();
        updateNotificationBadge();
      } catch (err) {
        console.warn('Notifications error:', err);
        await loadNotificationsFromActivity();
      }
    }

    async function loadNotificationsFromActivity() {
      // Generate notifications from recent leads, appointments, etc.
      const notifications = [];

      try {
        // Recent leads (last 7 days)
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data: recentLeads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, created_at, status')
          .gte('created_at', weekAgo)
          .order('created_at', { ascending: false })
          .limit(10);

        (recentLeads || []).forEach(lead => {
          notifications.push({
            id: 'lead-' + lead.id,
            type: 'new_lead',
            title: 'New Lead',
            message: `${lead.full_name || lead.email || 'Someone'} submitted a lead`,
            created_at: lead.created_at,
            read: lead.status !== 'new',
            data: { lead_id: lead.id }
          });
        });

        // Upcoming appointments (next 48 hours)
        const now = new Date().toISOString();
        const twoDaysOut = new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString();
        const { data: upcomingEvents } = await supabaseClient
          .from('calendar_events')
          .select('id, title, start_time, status')
          .gte('start_time', now)
          .lte('start_time', twoDaysOut)
          .eq('status', 'scheduled')
          .order('start_time', { ascending: true })
          .limit(5);

        (upcomingEvents || []).forEach(event => {
          const eventDate = new Date(event.start_time);
          const hoursUntil = Math.round((eventDate - new Date()) / (1000 * 60 * 60));
          notifications.push({
            id: 'event-' + event.id,
            type: 'appointment_reminder',
            title: hoursUntil <= 24 ? 'Appointment Soon' : 'Upcoming Appointment',
            message: `${event.title} - ${hoursUntil <= 1 ? 'in 1 hour' : hoursUntil <= 24 ? 'in ' + hoursUntil + ' hours' : 'tomorrow'}`,
            created_at: new Date().toISOString(),
            read: false,
            data: { event_id: event.id }
          });
        });

        // Events needing confirmation
        const { data: pendingEvents } = await supabaseClient
          .from('calendar_events')
          .select('id, title, start_time')
          .eq('status', 'scheduled')
          .gte('start_time', now)
          .order('start_time', { ascending: true })
          .limit(5);

        (pendingEvents || []).forEach(event => {
          notifications.push({
            id: 'confirm-' + event.id,
            type: 'action_required',
            title: 'Needs Confirmation',
            message: `${event.title} is pending confirmation`,
            created_at: event.start_time,
            read: false,
            data: { event_id: event.id, action: 'confirm' }
          });
        });

      } catch (err) {
        console.warn('Activity notifications error:', err);
      }

      // Sort by date
      notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // Check StateManager for previously viewed notifications
      allNotifications = notifications.slice(0, 20).map(notif => {
        if (typeof StateManager !== 'undefined' && StateManager.isNotificationViewed(notif.id)) {
          return { ...notif, read: true };
        }
        return notif;
      });

      // Add welcome notification for new features if user hasn't seen tutorial
      if (!localStorage.getItem('sg_tutorial_seen_v2')) {
        allNotifications.unshift({
          id: 'new-features-welcome',
          type: 'new_features',
          title: 'New Project Management Features!',
          message: 'We\'ve added Projects, Jobs, Calendar, and Team collaboration. Click to take a tour!',
          created_at: new Date().toISOString(),
          read: false,
          data: { action: 'start_tutorial' }
        });
      }

      renderNotificationPanel();
      updateNotificationBadge();
    }

    function renderNotificationPanel() {
      const list = document.getElementById('notification-list');
      if (!list) return;

      if (allNotifications.length === 0) {
        list.innerHTML = `
          <div class="empty-state" style="padding: 40px 20px; text-align: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
            </svg>
            <p style="color: var(--text-muted); margin: 0;">No new notifications</p>
          </div>
        `;
        return;
      }

      // Professional SVG icons for notification types
      const typeIcons = {
        new_lead: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>`,
          color: '#3b82f6',
          actions: [
            { label: 'Schedule', action: 'schedule_lead', primary: true },
            { label: 'View', action: 'view_lead' }
          ]
        },
        appointment_booked: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="m9 16 2 2 4-4"/></svg>`,
          color: '#10b981',
          actions: [
            { label: 'Confirm', action: 'confirm_appointment', primary: true },
            { label: 'Reschedule', action: 'reschedule_appointment' }
          ]
        },
        appointment_reminder: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
          color: '#f59e0b',
          actions: [
            { label: 'View Event', action: 'view_event', primary: true },
            { label: 'Send Reminder', action: 'send_reminder' }
          ]
        },
        action_required: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
          color: '#ef4444',
          actions: [
            { label: 'Take Action', action: 'take_action', primary: true },
            { label: 'Dismiss', action: 'dismiss' }
          ]
        },
        estimate_approved: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
          color: '#10b981',
          actions: [
            { label: 'Create Invoice', action: 'create_invoice', primary: true },
            { label: 'View', action: 'view_estimate' }
          ]
        },
        payment_received: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
          color: '#10b981',
          actions: [
            { label: 'View Invoice', action: 'view_invoice', primary: true },
            { label: 'Send Receipt', action: 'send_receipt' }
          ]
        },
        message_received: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`,
          color: '#8b5cf6',
          actions: [
            { label: 'Reply', action: 'reply_message', primary: true },
            { label: 'View', action: 'view_message' }
          ]
        },
        new_features: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
          color: '#f59e0b',
          actions: [
            { label: 'Learn More', action: 'start_tutorial', primary: true }
          ]
        },
        default: {
          icon: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`,
          color: '#6b7280',
          actions: []
        }
      };

      list.innerHTML = allNotifications.map(notif => {
        const typeInfo = typeIcons[notif.type] || typeIcons.default;
        const timeAgo = getTimeAgo(new Date(notif.created_at));
        const unreadStyle = notif.read ? '' : 'background: rgba(59, 130, 246, 0.1); border-left: 3px solid #3b82f6;';
        const dataAttr = encodeURIComponent(JSON.stringify(notif.data || {}));

        // Build action buttons
        const actionButtons = typeInfo.actions.map(act => {
          const btnStyle = act.primary
            ? `background: ${typeInfo.color}; color: white; border: none;`
            : `background: transparent; color: ${typeInfo.color}; border: 1px solid ${typeInfo.color}40;`;
          return `<button onclick="event.stopPropagation(); handleNotificationAction('${notif.id}', '${act.action}', '${dataAttr}')"
                          style="${btnStyle} padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                    ${act.label}
                  </button>`;
        }).join('');

        return `
          <div class="notification-item" onclick="handleNotificationClick('${notif.id}', '${notif.type}', ${JSON.stringify(notif.data || {}).replace(/"/g, '&quot;')})"
               style="padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background 0.2s; ${unreadStyle}">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
              <div style="width: 38px; height: 38px; border-radius: 10px; background: ${typeInfo.color}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: ${typeInfo.color};">
                ${typeInfo.icon}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 14px; margin-bottom: 3px; ${notif.read ? 'color: var(--text-secondary)' : 'color: var(--text-primary)'}">${escapeHtml(notif.title)}</div>
                <div style="font-size: 13px; color: var(--text-muted); line-height: 1.4; margin-bottom: 6px;">${escapeHtml(notif.message)}</div>
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                  <span style="font-size: 11px; color: var(--text-muted);">${timeAgo}</span>
                  ${actionButtons ? `<div style="display: flex; gap: 6px;">${actionButtons}</div>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Handle notification action button clicks
    async function handleNotificationAction(notifId, action, encodedData) {
      const data = JSON.parse(decodeURIComponent(encodedData));

      // Mark notification as read
      const notif = allNotifications.find(n => n.id === notifId);
      if (notif) notif.read = true;
      if (typeof StateManager !== 'undefined') {
        StateManager.markNotificationViewed(notifId);
      }

      // Close notification panel
      toggleNotificationPanel();

      // Handle different actions
      switch (action) {
        case 'schedule_lead':
          if (data.lead_id) {
            showPage('leads');
            setTimeout(() => openScheduleLeadModal(data.lead_id), 300);
          }
          break;

        case 'view_lead':
          if (data.lead_id) {
            showPage('leads');
            setTimeout(() => viewLead(data.lead_id), 300);
          }
          break;

        case 'confirm_appointment':
          if (data.event_id) {
            await confirmCalendarEvent(data.event_id);
            showToast('Appointment confirmed');
          }
          break;

        case 'reschedule_appointment':
          if (data.event_id) {
            showPage('calendar');
            setTimeout(() => {
              openCalendarEventDetailModal(data.event_id);
              // Auto-click edit after opening
              setTimeout(() => {
                const editBtn = document.querySelector('#calendar-event-detail-modal [onclick*="editCalendarEvent"]');
                if (editBtn) editBtn.click();
              }, 300);
            }, 300);
          }
          break;

        case 'view_event':
          if (data.event_id) {
            showPage('calendar');
            setTimeout(() => openCalendarEventDetailModal(data.event_id), 300);
          }
          break;

        case 'send_reminder':
          if (data.event_id) {
            await sendEventReminder(data.event_id);
          }
          break;

        case 'take_action':
          // Navigate based on data context
          if (data.lead_id) {
            showPage('leads');
            setTimeout(() => viewLead(data.lead_id), 300);
          } else if (data.event_id) {
            showPage('calendar');
            setTimeout(() => openCalendarEventDetailModal(data.event_id), 300);
          } else if (data.estimate_id) {
            showPage('estimates');
          } else if (data.invoice_id) {
            showPage('invoices');
          }
          break;

        case 'dismiss':
          renderNotificationPanel();
          updateNotificationBadge();
          break;

        case 'create_invoice':
          if (data.estimate_id) {
            showPage('invoices');
            setTimeout(() => createInvoiceFromEstimate(data.estimate_id), 300);
          }
          break;

        case 'view_estimate':
          if (data.estimate_id) {
            showPage('estimates');
          }
          break;

        case 'view_invoice':
          if (data.invoice_id) {
            showPage('invoices');
          }
          break;

        case 'send_receipt':
          if (data.invoice_id) {
            await sendInvoiceReceipt(data.invoice_id);
          }
          break;

        case 'reply_message':
        case 'view_message':
          // TODO: Implement message viewing
          showToast('Messages feature coming soon', 'info');
          break;

        case 'start_tutorial':
          setTimeout(() => showFeatureTutorial(), 300);
          break;

        default:
          console.log('Unknown notification action:', action);
      }

      renderNotificationPanel();
      updateNotificationBadge();
    }

    // Send reminder for an event
    async function sendEventReminder(eventId) {
      try {
        const response = await fetch('/api/calendar/events/' + eventId + '/reminder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          showToast('Reminder sent successfully');
        } else {
          showToast('Failed to send reminder', 'error');
        }
      } catch (err) {
        console.error('Error sending reminder:', err);
        showToast('Failed to send reminder', 'error');
      }
    }

    // Send invoice receipt
    async function sendInvoiceReceipt(invoiceId) {
      try {
        const response = await fetch('/api/invoices/' + invoiceId + '/receipt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        if (response.ok) {
          showToast('Receipt sent successfully');
        } else {
          showToast('Failed to send receipt', 'error');
        }
      } catch (err) {
        console.error('Error sending receipt:', err);
        showToast('Failed to send receipt', 'error');
      }
    }

    // Create invoice from estimate
    async function createInvoiceFromEstimate(estimateId) {
      // Open invoice creation modal pre-filled with estimate data
      // This assumes there's an existing function or we need to implement it
      if (typeof openCreateInvoiceModal === 'function') {
        openCreateInvoiceModal({ estimate_id: estimateId });
      } else {
        showToast('Opening invoice creation...', 'info');
        // Navigate to invoices page - the user can create manually
      }
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function updateNotificationBadge() {
      const badge = document.getElementById('notification-badge');
      if (!badge) return;

      const unreadCount = allNotifications.filter(n => !n.read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    async function handleNotificationClick(notifId, type, data) {
      // Mark as read in memory
      const notif = allNotifications.find(n => n.id === notifId);
      if (notif) notif.read = true;

      // Persist to StateManager
      if (typeof StateManager !== 'undefined') {
        StateManager.markNotificationViewed(notifId);
      }

      // Update database
      if (supabaseClient && currentUser) {
        try {
          await supabaseClient
            .from('pro_notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('id', notifId);
        } catch (err) {
          console.warn('Could not persist notification read state:', err);
        }
      }

      renderNotificationPanel();
      updateNotificationBadge();

      // Navigate based on type
      toggleNotificationPanel();

      if (type === 'new_features' && data.action === 'start_tutorial') {
        // Start the feature tutorial
        setTimeout(() => showFeatureTutorial(), 300);
      } else if (type === 'new_lead' && data.lead_id) {
        showPage('leads');
        setTimeout(() => viewLead(data.lead_id), 300);
      } else if ((type === 'appointment_reminder' || type === 'action_required') && data.event_id) {
        showPage('calendar');
        setTimeout(() => openCalendarEventDetailModal(data.event_id), 300);
      } else if (type === 'estimate_approved' && data.estimate_id) {
        showPage('estimates');
      } else if (type === 'payment_received' && data.invoice_id) {
        showPage('invoices');
      }
    }

    async function markAllNotificationsRead() {
      // Mark all as read in memory and persist to StateManager
      allNotifications.forEach(n => {
        n.read = true;
        if (typeof StateManager !== 'undefined') {
          StateManager.markNotificationViewed(n.id);
        }
      });
      renderNotificationPanel();
      updateNotificationBadge();

      // Update in database if using pro_notifications
      if (supabaseClient && currentUser) {
        try {
          await supabaseClient
            .from('pro_notifications')
            .update({ is_read: true, read_at: new Date().toISOString() })
            .eq('pro_user_id', currentUser.id)
            .eq('is_read', false);
        } catch (err) {
          // Ignore - may not have this table
        }
      }

      showToast('All notifications marked as read');
    }

    // Load notifications periodically
    function startNotificationPolling() {
      loadNotifications();
      setInterval(loadNotifications, 60000); // Every minute
    }

    // Send daily digest email
    async function sendDailyDigest() {
      if (!currentUser) {
        showToast('Please sign in to receive your digest', 'error');
        return;
      }

      const userName = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'User';

      showToast('Sending daily digest...', 'info');

      try {
        const response = await fetch('/api/email/daily-digest', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            user_id: currentUser.id,
            email: currentUser.email,
            name: userName
          })
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showToast(`Digest sent to ${currentUser.email}`, 'success');
          toggleNotificationPanel();
        } else {
          throw new Error(result.error || 'Failed to send digest');
        }
      } catch (err) {
        console.error('Error sending digest:', err);
        showToast('Failed to send digest: ' + err.message, 'error');
      }
    }

    function showDashboard() {
      // Check for stored redirect URL (e.g., from Room Designer auth flow)
      const authRedirect = sessionStorage.getItem('auth_redirect');
      if (authRedirect) {
        sessionStorage.removeItem('auth_redirect');
        window.location.href = authRedirect;
        return;
      }

      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('dashboard-app').style.display = 'block';
      setupDashboard();

      // Check QuickBooks connection status
      if (typeof checkQuickBooksStatus === 'function') {
        checkQuickBooksStatus();
      }

      // Initialize StateManager with current user and sync all persisted data
      if (typeof StateManager !== 'undefined') {
        StateManager.setUser(currentUser);
        if (supabaseClient && currentUser) {
          // Sync confirmed events and read notifications in parallel
          Promise.all([
            StateManager.syncConfirmedEvents(supabaseClient),
            StateManager.syncReadNotifications(supabaseClient, currentUser.id)
          ]).then(() => {
            StateManager.cleanup(); // Clean up old data
          });
        }
      }

      // Start notification polling
      startNotificationPolling();

      // Initialize sidebar collapsed state from localStorage
      initSidebarState();

      // Update badge visibility (hide zeros)
      updateBadgeVisibility();

      // Add help button to header and initialize tutorials
      addHelpButton();
      initShepherdTours();

      // Mark auth as ready BEFORE handling hash navigation
      setAuthReady();

      // Check for invite acceptance tokens
      checkForInviteToken();
      checkForNetworkInviteToken();

      // Listen for auto-claimed invitations
      window.addEventListener('sg-invitations-claimed', function(e) {
        var count = e.detail && e.detail.count || 0;
        if (count > 0) {
          showToast('You\'ve been added to ' + count + ' project' + (count > 1 ? 's' : '') + ' as collaborator!');
          if (document.getElementById('page-collaborations') && document.getElementById('page-collaborations').classList.contains('active')) {
            loadCollaborations();
          }
        }
      });

      // Handle hash navigation (e.g., /account/#favorites)
      handleHashNavigation();

      // Listen for hash changes
      window.addEventListener('hashchange', handleHashNavigation);

      // Show tutorial for new features if user hasn't seen it
      setTimeout(() => {
        if (!localStorage.getItem('sg_tutorial_seen_v2')) {
          showFeatureTutorial();
        }
      }, 1500);
    }


    // ==================== SHEPHERD.JS TUTORIAL SYSTEM ====================

    // Tutorial tour configurations
    var shepherdTours = {};

    function initShepherdTours() {
      if (typeof Shepherd === 'undefined') {
        console.warn('[Tutorial] Shepherd.js not loaded');
        return;
      }

      // Quick Start Tour
      shepherdTours.quickStart = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
          cancelIcon: { enabled: true },
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      shepherdTours.quickStart.addSteps([
        {
          id: 'welcome',
          title: 'Welcome to Your Dashboard',
          text: 'This is your command center. See your stats, upcoming appointments, and items needing attention all in one place.',
          attachTo: { element: '#page-dashboard', on: 'bottom' },
          buttons: [
            { text: 'Skip', action: shepherdTours.quickStart.cancel, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'leads',
          title: 'Leads - Your Starting Point',
          text: 'Every customer journey starts here. Capture leads from your website, phone calls, or add them manually.',
          attachTo: { element: 'a[data-page="leads"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'customers',
          title: 'Customer Management',
          text: 'Once a lead converts, they become a customer. View their info, orders, estimates, and invoices in one place.',
          attachTo: { element: 'a[data-page="customers"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'estimates',
          title: 'Professional Estimates',
          text: 'Create detailed estimates with line items and terms. Send them to customers for approval.',
          attachTo: { element: 'a[data-page="estimates"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'operations',
          title: 'Operations Hub',
          text: 'Your complete project management system. Track projects through every stage from lead to completion.',
          attachTo: { element: '#operations-nav', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Next', action: shepherdTours.quickStart.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'notifications',
          title: 'Stay Notified',
          text: 'Get notifications for new leads, estimate approvals, appointments, and team activity.',
          attachTo: { element: '.notification-bell-wrapper', on: 'left' },
          buttons: [
            { text: 'Back', action: shepherdTours.quickStart.back, secondary: true },
            { text: 'Finish', action: shepherdTours.quickStart.complete, classes: 'shepherd-button-primary' }
          ]
        }
      ]);

      shepherdTours.quickStart.on('complete', function() {
        localStorage.setItem('sg_tutorial_seen', 'true');
        showToast('Tutorial complete! Click the help button anytime to learn more.');
      });

      // Complete Workflow Tour
      shepherdTours.completeWorkflow = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
          cancelIcon: { enabled: true },
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      shepherdTours.completeWorkflow.addSteps([
        {
          id: 'step1',
          title: 'Step 1: Capture Leads',
          text: 'Leads come from your website, quote requests, or manual entry. Each lead has contact info and project details.<br><br><strong>Tip:</strong> Respond within 5 minutes for better conversion.',
          attachTo: { element: 'a[data-page="leads"]', on: 'right' },
          buttons: [
            { text: 'Skip', action: shepherdTours.completeWorkflow.cancel, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step2',
          title: 'Step 2: Schedule Appointment',
          text: 'Contact the lead and schedule an appointment using the calendar. Appointments sync and send reminders automatically.',
          attachTo: { element: 'a[data-page="calendar"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step3',
          title: 'Step 3: Convert to Customer',
          text: 'When qualified, convert the lead to a customer. This creates a permanent record preserving all their history.',
          attachTo: { element: 'a[data-page="customers"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step4',
          title: 'Step 4: Create Estimate',
          text: 'Build a professional estimate with itemized costs, materials, and labor. Send via email for customer approval.',
          attachTo: { element: 'a[data-page="estimates"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step5',
          title: 'Step 5: Create Project',
          text: 'Once approved, create a project to track the entire job lifecycle. Projects link to estimates, invoices, and events.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step6',
          title: 'Step 6: Assign Team',
          text: 'Add contractors, fabricators, and installers from your network. Assign them specific roles on the project.',
          attachTo: { element: 'a[data-page="collaborators"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step7',
          title: 'Step 7: Schedule Installation',
          text: 'Schedule the installation on your calendar. Add multiple participants - they all get notified.',
          attachTo: { element: 'a[data-page="calendar"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Next', action: shepherdTours.completeWorkflow.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'step8',
          title: 'Step 8: Invoice & Get Paid',
          text: 'Convert estimates to invoices, collect deposits, and track payments. Integrates with Stripe for online payments.',
          attachTo: { element: 'a[data-page="invoices"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.completeWorkflow.back, secondary: true },
            { text: 'Finish', action: shepherdTours.completeWorkflow.complete, classes: 'shepherd-button-primary' }
          ]
        }
      ]);

      shepherdTours.completeWorkflow.on('complete', function() {
        showToast('Workflow tutorial complete!');
      });

      // Project Management Tour
      shepherdTours.projectManagement = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
          cancelIcon: { enabled: true },
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      shepherdTours.projectManagement.addSteps([
        {
          id: 'overview',
          title: 'Projects Overview',
          text: 'Projects are the heart of operations. Each project tracks a job from start to finish with all related data.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Skip', action: shepherdTours.projectManagement.cancel, secondary: true },
            { text: 'Next', action: shepherdTours.projectManagement.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'creation',
          title: 'Creating Projects',
          text: 'Click "New Project" to create one. Populate from an existing Lead, Customer, or enter details manually.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.projectManagement.back, secondary: true },
            { text: 'Next', action: shepherdTours.projectManagement.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'workflow',
          title: 'Workflow Status',
          text: 'Each project shows a workflow progress bar with 9 stages. Click to advance stages and auto-create calendar events.',
          attachTo: { element: 'a[data-page="projects"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.projectManagement.back, secondary: true },
            { text: 'Next', action: shepherdTours.projectManagement.next, classes: 'shepherd-button-primary' }
          ]
        },
        {
          id: 'team',
          title: 'Team Assignment',
          text: 'In project details, click "Assign" to add team members. Assign roles like Installer, Fabricator, or Measurer.',
          attachTo: { element: 'a[data-page="collaborators"]', on: 'right' },
          buttons: [
            { text: 'Back', action: shepherdTours.projectManagement.back, secondary: true },
            { text: 'Finish', action: shepherdTours.projectManagement.complete, classes: 'shepherd-button-primary' }
          ]
        }
      ]);

      shepherdTours.projectManagement.on('complete', function() {
        showToast('Project management tutorial complete!');
      });
    }

    // Start a specific tour
    function startTour(tourName) {
      if (!shepherdTours[tourName]) {
        console.warn('[Tutorial] Tour not found:', tourName);
        return;
      }

      // Cancel any active tour
      Object.values(shepherdTours).forEach(function(tour) {
        if (tour.isActive()) tour.cancel();
      });

      shepherdTours[tourName].start();
    }

    // Show tour selection menu
    function showTutorialMenu() {
      var modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'tutorial-menu-modal';
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

      modal.innerHTML = '<div class="modal-content" style="max-width: 480px;">' +
        '<div class="modal-header">' +
          '<h2 class="modal-title">Learn the App</h2>' +
          '<button class="modal-close" onclick="document.getElementById(\'tutorial-menu-modal\').remove()">&times;</button>' +
        '</div>' +
        '<div class="modal-body" style="padding: 20px;">' +
          '<p style="color: var(--text-secondary); margin-bottom: 20px;">Choose a tutorial to learn different parts of the app:</p>' +

          '<div onclick="document.getElementById(\'tutorial-menu-modal\').remove(); startTour(\'quickStart\')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
            '<div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark)); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
              '<svg width="22" height="22" fill="none" stroke="#1a1a2e" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: 600; color: var(--text-primary);">Quick Start</div>' +
              '<div style="font-size: 13px; color: var(--text-secondary);">Overview of key features (6 steps)</div>' +
            '</div>' +
            '<svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
          '</div>' +

          '<div onclick="document.getElementById(\'tutorial-menu-modal\').remove(); startTour(\'completeWorkflow\')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
            '<div style="width: 44px; height: 44px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
              '<svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: 600; color: var(--text-primary);">Complete Workflow</div>' +
              '<div style="font-size: 13px; color: var(--text-secondary);">Full lead-to-completion process (8 steps)</div>' +
            '</div>' +
            '<svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
          '</div>' +

          '<div onclick="document.getElementById(\'tutorial-menu-modal\').remove(); startTour(\'projectManagement\')" style="display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
            '<div style="width: 44px; height: 44px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); border-radius: 10px; display: flex; align-items: center; justify-content: center;">' +
              '<svg width="22" height="22" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-weight: 600; color: var(--text-primary);">Project Management</div>' +
              '<div style="font-size: 13px; color: var(--text-secondary);">Deep dive on project features (4 steps)</div>' +
            '</div>' +
            '<svg width="20" height="20" fill="none" stroke="var(--text-muted)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
          '</div>' +

        '</div>' +
        '<div class="modal-footer">' +
          '<button class="btn-modern ghost" onclick="document.getElementById(\'tutorial-menu-modal\').remove()">Close</button>' +
        '</div>' +
      '</div>';

      document.body.appendChild(modal);
    }

    // Add help button to header
    function addHelpButton() {
      var headerRight = document.querySelector('.header-right');
      if (!headerRight || document.getElementById('help-menu-btn')) return;

      var helpBtn = document.createElement('div');
      helpBtn.id = 'help-menu-btn';
      helpBtn.style.cssText = 'position: relative; margin-right: 8px;';
      helpBtn.innerHTML = '<button onclick="toggleHelpMenu()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background=\'var(--dark-elevated)\'; this.style.color=\'var(--text-primary)\'" onmouseout="this.style.background=\'none\'; this.style.color=\'var(--text-secondary)\'" title="Help & Tutorials">' +
        '<svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>' +
      '</button>' +
      '<div id="help-dropdown" style="display: none; position: absolute; top: 100%; right: 0; width: 200px; background: var(--dark-secondary); border: 1px solid var(--border-color); border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1000; overflow: hidden; margin-top: 4px;">' +
        '<div style="padding: 8px;">' +
          '<div onclick="toggleHelpMenu(); showTutorialMenu()" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>' +
            '<span style="color: var(--text-primary); font-size: 13px;">All Tutorials</span>' +
          '</div>' +
          '<div onclick="toggleHelpMenu(); startTour(\'quickStart\')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>' +
            '<span style="color: var(--text-primary); font-size: 13px;">Quick Start</span>' +
          '</div>' +
        '</div>' +
        '<div style="padding: 8px; border-top: 1px solid var(--border-color);">' +
          '<a href="mailto:support@surprisegranite.com" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; cursor: pointer; text-decoration: none; transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>' +
            '<span style="color: var(--text-secondary); font-size: 13px;">Contact Support</span>' +
          '</a>' +
        '</div>' +
      '</div>';

      var notifWrapper = headerRight.querySelector('.notification-bell-wrapper');
      if (notifWrapper) {
        headerRight.insertBefore(helpBtn, notifWrapper);
      } else {
        headerRight.appendChild(helpBtn);
      }
    }

    function toggleHelpMenu() {
      var dropdown = document.getElementById('help-dropdown');
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Close help dropdown when clicking outside
    document.addEventListener('click', function(e) {
      var helpBtn = document.getElementById('help-menu-btn');
      var dropdown = document.getElementById('help-dropdown');
      if (helpBtn && dropdown && !helpBtn.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Legacy function aliases for backward compatibility
    function showFeatureTutorial(tourName) {
      startTour(tourName || 'quickStart');
    }
    function resetTutorial() {
      localStorage.removeItem('sg_tutorial_seen');
      startTour('quickStart');
    }

    // Expose functions globally
    window.startTour = startTour;
    window.showTutorialMenu = showTutorialMenu;
    window.showFeatureTutorial = showFeatureTutorial;
    window.resetTutorial = resetTutorial;
    window.toggleHelpMenu = toggleHelpMenu;
    window.initShepherdTours = initShepherdTours;
    // ==================== END TUTORIAL SYSTEM ====================

    async function handleHashNavigation() {
      const hash = window.location.hash.replace('#', '');
      console.log('[Nav] handleHashNavigation called, hash:', hash, 'authReady:', authReady);
      const validPages = ['favorites', 'profile', 'leads', 'customers', 'estimates', 'invoices', 'jobs', 'projects', 'collaborators', 'products', 'dashboard', 'wallet', 'orders', 'messages', 'listings', 'admin-users', 'calendar', 'my-designs', 'tools', 'collaborations'];
      if (hash && validPages.includes(hash)) {
        console.log('[Nav] Calling showPage for:', hash);
        await showPage(hash);
      }
    }

    function showAuthTab(tab) {
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

      document.querySelector(`.auth-tab:nth-child(${tab === 'login' ? 1 : 2})`).classList.add('active');
      document.getElementById(`${tab}-form`).classList.add('active');

      document.getElementById('auth-title').textContent = tab === 'login' ? 'Welcome Back' : 'Create Account';
      document.getElementById('auth-subtitle').textContent = tab === 'login' ? 'Sign in to access your account' : 'Join us to get started';
      hideAuthMessage();

      // Reset signup to step 1 when switching tabs
      if (tab === 'signup') {
        goToSignupStep(1);
        selectAccountType('homeowner');
      }
    }

    // Signup step functions
    function selectAccountType(type) {
      // Update hidden input
      document.getElementById('signup-account-type').value = type;

      // Update card selection UI
      document.querySelectorAll('.account-type-card').forEach(card => {
        card.classList.remove('selected');
      });
      document.querySelector(`.account-type-card[data-type="${type}"]`).classList.add('selected');
    }

    function goToSignupStep(step) {
      const step1 = document.getElementById('signup-step-1');
      const step2 = document.getElementById('signup-step-2');
      const accountType = document.getElementById('signup-account-type').value;

      if (step === 1) {
        step1.style.display = 'block';
        step2.style.display = 'none';
        document.getElementById('auth-title').textContent = 'Create Account';
        document.getElementById('auth-subtitle').textContent = 'Join us to get started';
      } else {
        step1.style.display = 'none';
        step2.style.display = 'block';

        // Update labels based on account type
        const typeLabels = {
          'homeowner': 'Homeowner Account',
          'pro_fabricator': 'Pro Fabricator Account',
          'pro_designer': 'Designer / Architect Account'
        };
        document.getElementById('selected-type-label').textContent = typeLabels[accountType] || 'Your Account';

        // Show/hide pro fields
        const proFields = document.getElementById('pro-fields');
        const proNote = document.getElementById('pro-upgrade-note');
        const isPro = accountType.startsWith('pro_');

        proFields.style.display = isPro ? 'block' : 'none';
        proNote.style.display = isPro ? 'flex' : 'none';

        // Update header for pro accounts
        if (isPro) {
          document.getElementById('auth-title').textContent = 'Pro Account Setup';
          document.getElementById('auth-subtitle').textContent = 'Unlock unlimited features';
        } else {
          document.getElementById('auth-title').textContent = 'Create Account';
          document.getElementById('auth-subtitle').textContent = 'Almost there!';
        }
      }
    }

    // Initialize account type selection on page load
    document.addEventListener('DOMContentLoaded', function() {
      const homeownerCard = document.querySelector('.account-type-card[data-type="homeowner"]');
      if (homeownerCard) {
        homeownerCard.classList.add('selected');
      }
    });

    function showAuthMessage(msg, type) {
      const el = document.getElementById('auth-message');
      el.textContent = msg;
      el.className = `auth-message visible ${type}`;
    }

    function hideAuthMessage() {
      document.getElementById('auth-message').classList.remove('visible');
    }

    async function handleLogin(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('login-btn');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) throw error;

        currentUser = data.user;
        await loadUserProfile();
        showDashboard();
      } catch (err) {
        showAuthMessage(err.message || 'Failed to sign in', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    }

    async function handleGoogleLogin() {
      hideAuthMessage();

      const btn = document.querySelector('.btn-google');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="60" stroke-dashoffset="20"/></svg> Connecting...';
      }

      try {
        // Use SgAuth if available, otherwise use direct Supabase client
        if (window.SgAuth && window.SgAuth.signInWithGoogle) {
          await window.SgAuth.signInWithGoogle(window.location.origin + '/account/');
        } else {
          const { data, error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
              redirectTo: window.location.origin + '/account/'
            }
          });
          if (error) throw error;
        }
        // OAuth redirects to Google, so we won't reach here unless there's an error
      } catch (err) {
        showAuthMessage(err.message || 'Failed to connect with Google', 'error');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Sign in with Google';
        }
      }
    }

    async function handleSignup(e) {
      e.preventDefault();
      hideAuthMessage();

      const btn = document.getElementById('signup-btn');
      btn.disabled = true;
      btn.textContent = 'Creating account...';

      try {
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const phone = document.getElementById('signup-phone').value;
        const accountType = document.getElementById('signup-account-type').value;
        const businessName = document.getElementById('signup-business-name')?.value || null;
        const businessLocation = document.getElementById('signup-business-location')?.value || null;

        const { data, error } = await supabaseClient.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: name,
              phone,
              account_type: accountType,
              business_name: businessName,
              business_location: businessLocation
            }
          }
        });

        if (error) throw error;

        // Store in sg_users
        await supabaseClient.from('sg_users').insert([{
          id: data.user.id,
          email,
          full_name: name,
          phone: phone || null,
          account_type: accountType,
          business_name: businessName,
          business_location: businessLocation,
          verified: accountType === 'homeowner' // Homeowners auto-verified, pros need verification
        }]);

        // Show success message based on account type
        const isPro = accountType.startsWith('pro_');
        const successMsg = isPro
          ? 'Pro account created! Check your email to verify. Our team will review your business details.'
          : 'Account created! Check your email to verify, then sign in.';

        showAuthMessage(successMsg, 'success');
        showAuthTab('login');
      } catch (err) {
        showAuthMessage(err.message || 'Failed to create account', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }
    }

    async function loadUserProfile() {
      if (!currentUser) return;

      try {
        // Use maybeSingle() to handle missing profiles gracefully
        const { data: profile, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .eq('id', currentUser.id)
          .maybeSingle();

        if (error) {
          console.warn('Profile query error:', error);
        }

        userProfile = profile;

        const meta = currentUser.user_metadata || {};
        const name = profile?.full_name || meta.full_name || currentUser.email?.split('@')[0] || 'User';
        const accountType = profile?.account_type || 'homeowner';

        // Check admin status
        isSuperAdmin = SUPER_ADMIN_EMAILS.includes((currentUser.email || '').toLowerCase());
        isAdmin = isSuperAdmin || ['admin', 'super_admin'].includes(accountType);

        // Determine user role (from profile or derived from account type)
        if (isAdmin) {
          userRole = 'admin';
        } else if (profile?.user_role) {
          userRole = profile.user_role;
        } else if (accountType.startsWith('pro_')) {
          userRole = 'contractor';
        } else {
          userRole = 'customer';
        }

        // Safely update sidebar user info
        const avatarEl = document.getElementById('user-avatar');
        const nameEl = document.getElementById('user-name');
        const roleEl = document.getElementById('user-role');

        const roleLabels = {
          homeowner: 'Homeowner',
          customer: 'Customer',
          contractor: 'Contractor',
          vendor: 'Vendor',
          pro: 'Pro',
          fabricator: 'Fabricator',
          admin: 'Admin'
        };

        if (avatarEl) avatarEl.textContent = name.charAt(0).toUpperCase();
        if (nameEl) nameEl.textContent = name;
        if (roleEl) roleEl.textContent = isSuperAdmin ? 'Super Admin' : roleLabels[userRole] || roleLabels[accountType] || 'Customer';

        // Update account type label in sidebar header
        const accountTypeLabel = document.getElementById('account-type-label');
        if (accountTypeLabel) {
          const typeLabels = {
            'customer': 'Customer Account',
            'contractor': 'Contractor Account',
            'vendor': 'Vendor Account',
            'admin': 'Admin Account',
            'homeowner': 'Customer Account',
            'pro_contractor': 'Contractor Account',
            'pro_fabricator': 'Fabricator Account',
            'pro_designer': 'Designer Account',
            'pro_builder': 'Builder Account',
            'super_admin': 'Admin Account'
          };
          accountTypeLabel.textContent = isSuperAdmin ? '⚡ GOD MODE' : (typeLabels[userRole] || typeLabels[accountType] || 'Account');
        }

        // Safely update profile form
        const profileNameEl = document.getElementById('profile-name');
        const profileEmailEl = document.getElementById('profile-email');
        const profilePhoneEl = document.getElementById('profile-phone');
        const profileCompanyEl = document.getElementById('profile-company');

        if (profileNameEl) profileNameEl.value = name;
        if (profileEmailEl) profileEmailEl.value = currentUser.email || '';
        if (profilePhoneEl) profilePhoneEl.value = profile?.phone || meta.phone || '';
        if (profileCompanyEl) profileCompanyEl.value = profile?.company_name || '';

        // Apply role-based navigation
        applyRoleBasedNav(userRole);

        // Enable role switcher for admins (for testing different views)
        if (isAdmin) {
          enableRoleSwitcher();
        }

      } catch (err) {
        console.warn('Profile load error:', err);
      }

      // Load favorites count (non-blocking)
      loadFavoritesCount().catch(err => console.warn('Favorites count error:', err));
    }

    // ============ FAVORITES FUNCTIONS ============

    let allFavorites = [];
    let flooringFavorites = [];
    let countertopFavorites = [];

    async function loadFavoritesCount() {
      if (!currentUser) return;

      try {
        const { count } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = count || 0;
          countEl.style.display = count > 0 ? 'inline' : 'none';
        }
      } catch (err) {
        console.warn('Error loading favorites count:', err);
      }
    }

    async function loadFavorites() {
      if (!currentUser) return;

      const loadingEl = document.getElementById('favorites-loading');
      const emptyEl = document.getElementById('favorites-empty');
      const flooringSection = document.getElementById('favorites-flooring');
      const countertopsSection = document.getElementById('favorites-countertops');
      const tileSection = document.getElementById('favorites-tile');
      const shopSection = document.getElementById('favorites-shop');
      const quoteBtn = document.getElementById('request-quote-btn');
      const clearAllBtn = document.getElementById('clear-all-btn');

      try {
        const { data, error } = await supabaseClient
          .from('user_favorites')
          .select('*')
          .eq('user_id', currentUser.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allFavorites = data || [];
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');
        const tileFavorites = allFavorites.filter(f => f.product_type === 'tile');
        const shopFavorites = allFavorites.filter(f => f.product_type === 'shop');

        loadingEl.style.display = 'none';

        if (allFavorites.length === 0) {
          emptyEl.style.display = 'block';
          flooringSection.style.display = 'none';
          countertopsSection.style.display = 'none';
          if (tileSection) tileSection.style.display = 'none';
          if (shopSection) shopSection.style.display = 'none';
          quoteBtn.style.display = 'none';
          if (clearAllBtn) clearAllBtn.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          quoteBtn.style.display = 'inline-flex';
          if (clearAllBtn) clearAllBtn.style.display = 'inline-flex';

          // Show/render countertops section
          if (countertopFavorites.length > 0) {
            countertopsSection.style.display = 'block';
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            countertopsSection.style.display = 'none';
          }

          // Show/render flooring section
          if (flooringFavorites.length > 0) {
            flooringSection.style.display = 'block';
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            flooringSection.style.display = 'none';
          }

          // Show/render tile section
          if (tileFavorites.length > 0 && tileSection) {
            tileSection.style.display = 'block';
            document.getElementById('tile-section-count').textContent = tileFavorites.length;
            renderFavoritesGrid('favorites-tile-grid', tileFavorites);
          } else if (tileSection) {
            tileSection.style.display = 'none';
          }

          // Show/render shop section
          if (shopFavorites.length > 0 && shopSection) {
            shopSection.style.display = 'block';
            document.getElementById('shop-section-count').textContent = shopFavorites.length;
            renderFavoritesGrid('favorites-shop-grid', shopFavorites);
          } else if (shopSection) {
            shopSection.style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

      } catch (err) {
        console.error('Error loading favorites:', err);
        loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading favorites. Please try again.</p>';
      }
    }

    // Orders functionality
    let ordersLoaded = false;
    let allOrders = [];
    let filteredOrders = [];
    let ordersPage = 1;
    const ordersPageSize = 50;
    let ordersSearchTerm = '';

    async function loadOrders() {
      console.log('[Orders] loadOrders called, ordersLoaded:', ordersLoaded);
      if (ordersLoaded) {
        return;
      }

      const loadingEl = document.getElementById('orders-loading');
      const emptyEl = document.getElementById('orders-empty');
      const listEl = document.getElementById('orders-list');

      if (!loadingEl || !emptyEl || !listEl) {
        console.warn('[Orders] DOM elements not found', { loadingEl: !!loadingEl, emptyEl: !!emptyEl, listEl: !!listEl });
        return;
      }

      try {
        if (!supabaseClient) {
          console.error('[Orders] supabaseClient not initialized');
          loadingEl.style.display = 'none';
          emptyEl.innerHTML = '<p>Database not ready. Please refresh.</p>';
          emptyEl.style.display = 'block';
          return;
        }
        // Load ALL orders from shopify_orders
        const { data, error } = await supabaseClient
          .from('shopify_orders')
          .select('*')
          .order('shopify_created_at', { ascending: false });

        if (error) throw error;

        allOrders = data || [];
        filteredOrders = [...allOrders];
        ordersLoaded = true;

        loadingEl.style.display = 'none';

        // Update stats
        updateOrderStats();

        // Setup search
        setupOrdersSearch();

        if (allOrders.length === 0) {
          emptyEl.style.display = 'block';
          listEl.style.display = 'none';
          document.getElementById('orders-stats').style.display = 'none';
          document.getElementById('orders-pagination').style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          listEl.style.display = 'block';
          document.getElementById('orders-pagination').style.display = 'flex';
          renderOrders();
        }
      } catch (err) {
        console.error('Error loading orders:', err);
        loadingEl.innerHTML = '<p style="color: #ef4444;">Error loading orders. Please try again.</p>';
      }
    }

    function updateOrderStats() {
      const total = allOrders.length;
      // Check multiple possible field names for total
      const revenue = allOrders.reduce((sum, o) => {
        const orderTotal = parseFloat(o.total_price || o.total || o.amount || 0);
        return sum + orderTotal;
      }, 0);
      const paid = allOrders.filter(o => o.financial_status === 'paid').length;
      const fulfilled = allOrders.filter(o => o.fulfillment_status === 'fulfilled').length;

      document.getElementById('stat-total-orders').textContent = total.toLocaleString();
      document.getElementById('stat-orders-revenue').textContent = '$' + revenue.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      document.getElementById('stat-paid-orders').textContent = paid.toLocaleString();
      document.getElementById('stat-fulfilled-orders').textContent = fulfilled.toLocaleString();

      // Debug: log first order to see field names
      if (allOrders.length > 0) {
        console.log('Sample order fields:', Object.keys(allOrders[0]), 'Total field values:', allOrders[0].total_price, allOrders[0].total);
      }
    }

    function setupOrdersSearch() {
      const searchInput = document.getElementById('orders-search');
      let timeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          ordersSearchTerm = e.target.value.toLowerCase();
          filterOrders();
        }, 300);
      });
    }

    function filterOrders() {
      const statusFilter = document.getElementById('orders-status-filter').value;
      const fulfillmentFilter = document.getElementById('orders-fulfillment-filter').value;

      filteredOrders = allOrders.filter(order => {
        // Status filter
        if (statusFilter && order.financial_status !== statusFilter) return false;

        // Fulfillment filter
        if (fulfillmentFilter && order.fulfillment_status !== fulfillmentFilter) return false;

        // Search
        if (ordersSearchTerm) {
          const searchable = `${order.order_number || ''} ${order.customer_name || ''} ${order.customer_email || ''}`.toLowerCase();
          if (!searchable.includes(ordersSearchTerm)) return false;
        }

        return true;
      });

      ordersPage = 1;
      renderOrders();
    }

    function renderOrders() {
      const listEl = document.getElementById('orders-list');
      const emptyEl = document.getElementById('orders-empty');
      const paginationEl = document.getElementById('orders-pagination');

      if (filteredOrders.length === 0) {
        listEl.style.display = 'none';
        emptyEl.style.display = 'block';
        paginationEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      listEl.style.display = 'block';
      paginationEl.style.display = 'flex';

      const start = (ordersPage - 1) * ordersPageSize;
      const end = start + ordersPageSize;
      const pageOrders = filteredOrders.slice(start, end);

      listEl.innerHTML = pageOrders.map(order => {
        const orderDate = order.shopify_created_at
          ? new Date(order.shopify_created_at).toLocaleDateString('en-US', {
              year: 'numeric', month: 'short', day: 'numeric'
            })
          : 'N/A';

        const financialStatus = (order.financial_status || 'pending').toLowerCase();
        const fulfillmentStatus = (order.fulfillment_status || 'unfulfilled').toLowerCase();

        // Parse line items
        const lineItems = Array.isArray(order.line_items) ? order.line_items : [];

        return `
          <div class="order-card" onclick="showOrderDetail('${order.id}')" style="cursor: pointer;">
            <div class="order-header">
              <div class="order-info">
                <div class="order-number">Order #${escapeHtml(String(order.order_number || order.id))}</div>
                <div class="order-date">${orderDate}</div>
                <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(order.customer_name || order.customer_email || 'Guest')}</div>
              </div>
              <div class="order-status">
                <span class="status-badge ${financialStatus}">${escapeHtml(financialStatus)}</span>
                <span class="status-badge ${fulfillmentStatus}">${escapeHtml(fulfillmentStatus)}</span>
              </div>
            </div>

            <div class="order-items">
              ${lineItems.slice(0, 2).map(item => `
                <div class="order-item">
                  <div class="order-item-image">
                    ${item.image?.url
                      ? `<img src="${escapeHtml(item.image.url)}" alt="${escapeHtml(item.title || item.name)}" loading="lazy">`
                      : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="width:100%;height:100%;padding:15px;color:var(--text-muted)"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>'
                    }
                  </div>
                  <div class="order-item-details">
                    <div class="order-item-name">${escapeHtml(item.title || item.name || 'Product')}</div>
                    <div class="order-item-meta">Qty: ${item.quantity || 1}</div>
                  </div>
                  <div class="order-item-price">$${((item.originalUnitPrice?.amount || item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                </div>
              `).join('')}
              ${lineItems.length > 2 ? `
                <div class="order-item-meta" style="padding: 8px 0; color: var(--text-muted);">
                  + ${lineItems.length - 2} more item${lineItems.length - 2 > 1 ? 's' : ''}
                </div>
              ` : ''}
            </div>

            <div class="order-footer" style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div class="order-total-label">Total</div>
                <div class="order-total">$${parseFloat(order.total || 0).toFixed(2)}</div>
              </div>
              <button class="btn-modern secondary small" onclick="event.stopPropagation(); createProjectFromOrder('${order.id}')" title="Create Project" style="font-size: 11px; padding: 4px 10px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                Project
              </button>
            </div>
          </div>
        `;
      }).join('');

      // Update pagination
      const totalPages = Math.ceil(filteredOrders.length / ordersPageSize);
      document.getElementById('orders-page-info').textContent = `Showing ${start + 1}-${Math.min(end, filteredOrders.length)} of ${filteredOrders.length}`;
      document.getElementById('orders-prev-btn').disabled = ordersPage === 1;
      document.getElementById('orders-next-btn').disabled = ordersPage >= totalPages;
    }

    function ordersPagePrev() {
      if (ordersPage > 1) {
        ordersPage--;
        renderOrders();
        document.getElementById('page-orders').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function ordersPageNext() {
      const totalPages = Math.ceil(filteredOrders.length / ordersPageSize);
      if (ordersPage < totalPages) {
        ordersPage++;
        renderOrders();
        document.getElementById('page-orders').scrollIntoView({ behavior: 'smooth' });
      }
    }

    function showOrderDetail(orderId) {
      const order = allOrders.find(o => o.id === orderId);
      if (!order) return;

      const lineItems = Array.isArray(order.line_items) ? order.line_items : [];
      const orderDate = order.shopify_created_at
        ? new Date(order.shopify_created_at).toLocaleDateString('en-US', {
            year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
          })
        : 'N/A';

      const modal = document.createElement('div');
      modal.className = 'order-detail-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      modal.innerHTML = `
        <div style="background: var(--dark-surface); border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 18px; font-weight: 700;">Order #${escapeHtml(String(order.order_number || order.id))}</h3>
            <button onclick="this.closest('.order-detail-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Date</div>
                <div style="font-weight: 500;">${orderDate}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Status</div>
                <div><span class="status-badge ${order.financial_status || 'pending'}">${escapeHtml(order.financial_status || 'pending')}</span></div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Customer</div>
                <div style="font-weight: 500;">${escapeHtml(order.customer_name || 'Guest')}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${escapeHtml(order.customer_email || '')}</div>
              </div>
              <div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 4px;">Fulfillment</div>
                <div><span class="status-badge ${order.fulfillment_status || 'unfulfilled'}">${escapeHtml(order.fulfillment_status || 'unfulfilled')}</span></div>
              </div>
            </div>

            <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Items (${lineItems.length})</div>
            <div style="background: var(--dark-elevated); border-radius: 12px; padding: 12px;">
              ${lineItems.map(item => `
                <div style="display: flex; gap: 12px; padding: 8px 0; align-items: center; ${lineItems.indexOf(item) > 0 ? 'border-top: 1px solid var(--border-subtle);' : ''}">
                  <div style="width: 50px; height: 50px; border-radius: 8px; background: var(--dark-surface); overflow: hidden; flex-shrink: 0;">
                    ${item.image?.url
                      ? `<img src="${escapeHtml(item.image.url)}" style="width: 100%; height: 100%; object-fit: cover;">`
                      : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--text-muted);">📦</div>'
                    }
                  </div>
                  <div style="flex: 1;">
                    <div style="font-weight: 500;">${escapeHtml(item.title || item.name || 'Product')}</div>
                    <div style="font-size: 13px; color: var(--text-muted);">Qty: ${item.quantity || 1}</div>
                  </div>
                  <div style="font-weight: 600;">$${((item.originalUnitPrice?.amount || item.price || 0) * (item.quantity || 1)).toFixed(2)}</div>
                </div>
              `).join('')}
            </div>

            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 16px; font-weight: 600;">Total</span>
              <span style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${parseFloat(order.total || 0).toFixed(2)}</span>
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    function exportOrdersCSV() {
      if (filteredOrders.length === 0) {
        showToast('No orders to export', 'error');
        return;
      }

      const csv = [
        ['Order #', 'Date', 'Customer', 'Email', 'Total', 'Financial Status', 'Fulfillment Status'].join(','),
        ...filteredOrders.map(o => [
          o.order_number || o.id,
          o.shopify_created_at ? new Date(o.shopify_created_at).toLocaleDateString() : '',
          `"${(o.customer_name || '').replace(/"/g, '""')}"`,
          o.customer_email || '',
          o.total || 0,
          o.financial_status || '',
          o.fulfillment_status || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `orders-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Orders exported', 'success');
    }

    function renderFavoritesGrid(gridId, items) {
      const gridEl = document.getElementById(gridId);
      if (!gridEl) return;

      gridEl.innerHTML = items.map(item => `
        <div class="saved-floor-item" data-id="${item.id}">
          <img class="saved-floor-image" src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}" loading="lazy">
          <div class="saved-floor-content">
            <div class="saved-floor-title">${item.product_title}</div>
            ${item.product_material ? `<div class="saved-floor-material">${item.product_material}</div>` : ''}
            <div class="saved-floor-specs">
              ${item.product_color ? `<span class="saved-floor-spec">${item.product_color}</span>` : ''}
              ${item.product_thickness ? `<span class="saved-floor-spec">${item.product_thickness}</span>` : ''}
              ${item.product_wear_layer ? `<span class="saved-floor-spec">${item.product_wear_layer}</span>` : ''}
            </div>
            <div class="saved-floor-actions">
              <a href="${item.product_url}" class="saved-floor-view" target="_blank">View</a>
              <button class="saved-floor-remove" onclick="removeFavorite('${item.id}', '${item.product_type}')">Remove</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function removeFavorite(id, productType) {
      if (!confirm('Remove this from your favorites?')) return;

      try {
        const { error } = await supabaseClient
          .from('user_favorites')
          .delete()
          .eq('id', id)
          .eq('user_id', currentUser.id);

        if (error) throw error;

        // Remove from local arrays
        allFavorites = allFavorites.filter(f => f.id !== id);
        flooringFavorites = allFavorites.filter(f => f.product_type === 'flooring');
        countertopFavorites = allFavorites.filter(f => f.product_type === 'countertop');

        // Re-render the appropriate grid
        if (productType === 'countertop') {
          if (countertopFavorites.length > 0) {
            document.getElementById('countertops-section-count').textContent = countertopFavorites.length;
            renderFavoritesGrid('favorites-countertops-grid', countertopFavorites);
          } else {
            document.getElementById('favorites-countertops').style.display = 'none';
          }
        } else {
          if (flooringFavorites.length > 0) {
            document.getElementById('flooring-section-count').textContent = flooringFavorites.length;
            renderFavoritesGrid('favorites-flooring-grid', flooringFavorites);
          } else {
            document.getElementById('favorites-flooring').style.display = 'none';
          }
        }

        // Update nav count
        const countEl = document.getElementById('favorites-count');
        if (countEl) {
          countEl.textContent = allFavorites.length;
          countEl.style.display = allFavorites.length > 0 ? 'inline' : 'none';
        }

        // Show empty state if no more favorites
        if (allFavorites.length === 0) {
          document.getElementById('favorites-empty').style.display = 'block';
          document.getElementById('request-quote-btn').style.display = 'none';
        }

        showToast('Removed from favorites', 'success');

      } catch (err) {
        console.error('Error removing favorite:', err);
        showToast('Error removing item', 'error');
      }
    }

    // Clear ALL favorites - permanent action
    async function clearAllFavoritesConfirm() {
      // Show confirmation modal
      const confirmModal = document.createElement('div');
      confirmModal.className = 'quote-modal';
      confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      confirmModal.innerHTML = `
        <div style="background: linear-gradient(180deg, #1a1a2e 0%, #0d0d15 100%); border-radius: 20px; padding: 32px; max-width: 400px; width: 100%; text-align: center; color: #fff;">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="1.5" style="margin-bottom: 16px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <h3 style="margin: 0 0 12px; font-size: 22px;">Clear All Favorites?</h3>
          <p style="color: rgba(255,255,255,0.7); margin-bottom: 24px; line-height: 1.5;">This will permanently delete <strong>${allFavorites.length}</strong> item${allFavorites.length !== 1 ? 's' : ''} from your favorites. This action cannot be undone.</p>
          <div style="display: flex; gap: 12px; justify-content: center;">
            <button id="cancel-clear" style="background: rgba(255,255,255,0.1); color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px;">Cancel</button>
            <button id="confirm-clear" style="background: #dc2626; color: #fff; border: none; padding: 14px 28px; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 15px;">Yes, Clear All</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmModal);

      // Handle cancel
      confirmModal.querySelector('#cancel-clear').addEventListener('click', () => {
        confirmModal.remove();
      });

      // Handle confirm
      confirmModal.querySelector('#confirm-clear').addEventListener('click', async () => {
        const confirmBtn = confirmModal.querySelector('#confirm-clear');
        confirmBtn.textContent = 'Clearing...';
        confirmBtn.disabled = true;

        try {
          // Delete from Supabase
          const { error } = await supabaseClient
            .from('user_favorites')
            .delete()
            .eq('user_id', currentUser.id);

          if (error) throw error;

          // Clear ALL localStorage keys related to favorites
          const keysToRemove = [
            'sg_all_favorites',
            'sg_flooring_favorites',
            'sg_countertop_favorites',
            'sg_tile_favorites',
            'sg_cabinet_favorites',
            'sg_sink_favorites',
            'sg_shop_favorites',
            'sg_general_favorites',
            'favorites',
            'userFavorites',
            'sg_favorites'
          ];
          keysToRemove.forEach(key => {
            try { localStorage.removeItem(key); } catch (e) {}
          });

          // Also clear any key containing 'favorite'
          Object.keys(localStorage).forEach(key => {
            if (key.toLowerCase().includes('favorite')) {
              try { localStorage.removeItem(key); } catch (e) {}
            }
          });

          // Clear local arrays
          allFavorites = [];
          flooringFavorites = [];
          countertopFavorites = [];
          tileFavorites = [];
          shopFavorites = [];

          // Hide all sections
          document.getElementById('favorites-countertops').style.display = 'none';
          document.getElementById('favorites-flooring').style.display = 'none';
          document.getElementById('favorites-tile').style.display = 'none';
          document.getElementById('favorites-shop').style.display = 'none';

          // Show empty state
          document.getElementById('favorites-empty').style.display = 'block';

          // Hide buttons
          document.getElementById('request-quote-btn').style.display = 'none';
          document.getElementById('clear-all-btn').style.display = 'none';

          // Update counts
          const countEl = document.getElementById('favorites-count');
          if (countEl) {
            countEl.textContent = '0';
            countEl.style.display = 'none';
          }

          // Update dashboard stat if visible
          const statEl = document.getElementById('stat-favorites');
          if (statEl) statEl.textContent = '0';

          // Update global favorites if available
          if (window.SGFavorites && typeof window.SGFavorites.clearAll === 'function') {
            // Already cleared above, but this ensures in-memory state is synced
          }

          confirmModal.remove();
          showToast('All favorites cleared permanently', 'success');

        } catch (err) {
          console.error('Error clearing favorites:', err);
          confirmBtn.textContent = 'Yes, Clear All';
          confirmBtn.disabled = false;
          showToast('Error clearing favorites. Please try again.', 'error');
        }
      });

      // Close on click outside
      confirmModal.addEventListener('click', (e) => {
        if (e.target === confirmModal) {
          confirmModal.remove();
        }
      });
    }

    // =============================================
    // MY DESIGNS (ROOM DESIGNER)
    // =============================================

    let allDesigns = [];
    let designShares = {}; // Map of design_id -> share info with customer/lead data
    let designMessages = {}; // Map of design_id -> unread message count
    let designsFilter = 'all';

    async function loadMyDesigns() {
      const loadingEl = document.getElementById('designs-loading');
      const emptyEl = document.getElementById('designs-empty');
      const gridEl = document.getElementById('designs-grid');

      if (!loadingEl || !emptyEl || !gridEl) return;

      // Show loading
      loadingEl.style.display = 'flex';
      emptyEl.style.display = 'none';
      gridEl.style.display = 'none';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          loadingEl.style.display = 'none';
          emptyEl.style.display = 'block';
          return;
        }

        // Load designs created by this user
        const { data: designs, error } = await supabaseClient
          .from('room_designs')
          .select('*')
          .eq('user_id', user.id)
          .order('updated_at', { ascending: false });

        if (error) throw error;

        allDesigns = designs || [];

        // Load share info with customer/lead data for each design
        if (allDesigns.length > 0) {
          const designIds = allDesigns.map(d => d.id);

          // Get shares with lead info
          const { data: shares } = await supabaseClient
            .from('room_design_shares')
            .select('design_id, lead_id, customer_name, customer_email, permission_level, comments')
            .in('design_id', designIds);

          // Map shares by design_id
          designShares = {};
          (shares || []).forEach(share => {
            if (!designShares[share.design_id]) {
              designShares[share.design_id] = [];
            }
            designShares[share.design_id].push(share);
          });

          // Get unread message counts for designs with shares
          const leadIds = (shares || []).filter(s => s.lead_id).map(s => s.lead_id);
          if (leadIds.length > 0) {
            const { data: messages } = await supabaseClient
              .from('customer_messages')
              .select('customer_id, id, read_at')
              .in('customer_id', leadIds)
              .eq('channel', 'design_share')
              .eq('direction', 'inbound');

            // Count unread messages per lead, then map to design
            const unreadByLead = {};
            (messages || []).forEach(msg => {
              if (!msg.read_at) {
                unreadByLead[msg.customer_id] = (unreadByLead[msg.customer_id] || 0) + 1;
              }
            });

            // Map back to designs
            designMessages = {};
            (shares || []).forEach(share => {
              if (share.lead_id && unreadByLead[share.lead_id]) {
                designMessages[share.design_id] = (designMessages[share.design_id] || 0) + unreadByLead[share.lead_id];
              }
            });
          }
        }

        // Update count badge
        const countEl = document.getElementById('designs-count');
        if (countEl) {
          countEl.textContent = allDesigns.length;
          countEl.style.display = allDesigns.length > 0 ? 'inline-flex' : 'none';
        }

        loadingEl.style.display = 'none';

        if (allDesigns.length === 0) {
          emptyEl.style.display = 'block';
          gridEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          gridEl.style.display = 'grid';
          renderDesigns();
        }

      } catch (err) {
        console.error('Error loading designs:', err);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        gridEl.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading designs. Please try again.</p>';
      }
    }

    function filterDesigns() {
      designsFilter = document.getElementById('designs-filter').value;
      renderDesigns();
    }

    function renderDesigns() {
      const gridEl = document.getElementById('designs-grid');
      if (!gridEl) return;

      let filtered = allDesigns;
      if (designsFilter === 'shared') {
        filtered = allDesigns.filter(d => d.share_token);
      } else if (designsFilter === 'private') {
        filtered = allDesigns.filter(d => !d.share_token);
      } else if (designsFilter === 'with-messages') {
        filtered = allDesigns.filter(d => designMessages[d.id] > 0);
      }

      if (filtered.length === 0) {
        gridEl.innerHTML = `<p style="color: var(--text-muted); text-align: center; padding: 40px; grid-column: 1 / -1;">No ${designsFilter === 'all' ? '' : designsFilter + ' '}designs found.</p>`;
        return;
      }

      gridEl.innerHTML = filtered.map(design => {
        const isShared = !!design.share_token;
        const roomType = design.room_type || 'kitchen';
        const updatedDate = new Date(design.updated_at).toLocaleDateString();
        const elementCount = Array.isArray(design.elements) ? design.elements.length : 0;

        // Get customer/lead info from shares
        const shares = designShares[design.id] || [];
        const primaryShare = shares[0];
        const customerName = primaryShare?.customer_name || primaryShare?.customer_email;
        const unreadCount = designMessages[design.id] || 0;

        return `
          <div class="design-card" data-id="${design.id}">
            <div class="design-preview">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
              </svg>
              <span class="design-preview-badge ${isShared ? 'shared' : 'private'}">${isShared ? 'Shared' : 'Private'}</span>
              ${unreadCount > 0 ? `<span class="design-message-badge">${unreadCount}</span>` : ''}
            </div>
            <div class="design-content">
              <div class="design-title">${escapeHtml(design.name || design.project_name || 'Untitled Design')}</div>
              ${customerName ? `
                <div class="design-customer">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                  <span>${escapeHtml(customerName)}</span>
                </div>
              ` : ''}
              <div class="design-meta">
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                  ${roomType.charAt(0).toUpperCase() + roomType.slice(1)}
                </span>
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
                  ${elementCount} items
                </span>
                <span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  ${updatedDate}
                </span>
              </div>
              <div class="design-actions">
                <a href="/tools/room-designer/?p=${design.share_token || design.id}" class="design-btn-open">Open</a>
                ${unreadCount > 0 ? `
                  <button class="design-btn-messages" onclick="openDesignMessages('${design.id}')" title="${unreadCount} unread message${unreadCount > 1 ? 's' : ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <span class="btn-badge">${unreadCount}</span>
                  </button>
                ` : ''}
                <button class="design-btn-share" onclick="copyDesignLink('${design.share_token || design.id}')" title="Copy share link">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                </button>
                <button class="design-btn-share" onclick="linkDesignToLead('${design.id}')" title="Link to customer/lead" style="color: var(--gold-primary);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                </button>
                <button class="design-btn-share" onclick="openStartHandoffModal('${design.id}', '${escapeHtml(design.name || design.project_name || '')}')" title="Start fabrication handoff" style="color: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
                </button>
                <button class="design-btn-delete" onclick="deleteDesign('${design.id}', '${escapeHtml(design.name || design.project_name || 'Untitled')}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function copyDesignLink(token) {
      const url = `${window.location.origin}/tools/room-designer/?p=${token}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Design link copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    }

    async function deleteDesign(designId, designName) {
      if (!confirm(`Are you sure you want to delete "${designName}"? This cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('room_designs')
          .delete()
          .eq('id', designId);

        if (error) throw error;

        // Remove from local array
        allDesigns = allDesigns.filter(d => d.id !== designId);

        // Update count badge
        const countEl = document.getElementById('designs-count');
        if (countEl) {
          countEl.textContent = allDesigns.length;
          countEl.style.display = allDesigns.length > 0 ? 'inline-flex' : 'none';
        }

        // Re-render or show empty
        if (allDesigns.length === 0) {
          document.getElementById('designs-empty').style.display = 'block';
          document.getElementById('designs-grid').style.display = 'none';
        } else {
          renderDesigns();
        }

        showToast('Design deleted successfully', 'success');

      } catch (err) {
        console.error('Error deleting design:', err);
        showToast('Failed to delete design', 'error');
      }
    }

    // Link a design to a lead/customer from CRM
    async function linkDesignToLead(designId) {
      const design = allDesigns.find(d => d.id === designId);
      if (!design) return;

      // Create modal for lead selection
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'linkLeadModal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h3>Link Design to Customer</h3>
            <button onclick="document.getElementById('linkLeadModal').remove()" class="modal-close">&times;</button>
          </div>
          <div class="modal-body">
            <p style="color: var(--text-muted); margin-bottom: 16px;">
              Link "${escapeHtml(design.name || design.project_name || 'this design')}" to a customer from your CRM.
            </p>
            <div class="form-group">
              <label>Search Customer/Lead</label>
              <input type="text" id="leadSearchInput" placeholder="Type name or email..."
                     style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary);"
                     oninput="searchLeadsForDesign(this.value)">
            </div>
            <div id="leadSearchResults" style="max-height: 200px; overflow-y: auto; margin-top: 12px;"></div>
            <div class="form-group" style="margin-top: 16px;">
              <label>Or enter customer email directly</label>
              <input type="email" id="directCustomerEmail" placeholder="customer@email.com"
                     style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-secondary);">
            </div>
          </div>
          <div class="modal-footer">
            <button onclick="document.getElementById('linkLeadModal').remove()" class="btn-modern secondary">Cancel</button>
            <button onclick="confirmLinkDesignToLead('${designId}')" class="btn-modern primary">Link Customer</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Store design ID for the confirm function
      window._linkingDesignId = designId;
    }

    async function searchLeadsForDesign(query) {
      const resultsEl = document.getElementById('leadSearchResults');
      if (!resultsEl) return;

      if (!query || query.length < 2) {
        resultsEl.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">Type at least 2 characters to search...</p>';
        return;
      }

      try {
        const { data: leads, error } = await supabaseClient
          .from('leads')
          .select('id, name, email, phone, status')
          .or(`name.ilike.%${query}%,email.ilike.%${query}%`)
          .limit(10);

        if (error) throw error;

        if (!leads || leads.length === 0) {
          resultsEl.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No customers found.</p>';
          return;
        }

        resultsEl.innerHTML = leads.map(lead => `
          <div class="lead-search-item" onclick="selectLeadForDesign('${lead.id}', '${escapeHtml(lead.name || '')}', '${escapeHtml(lead.email || '')}')"
               style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;">
            <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(lead.name || 'Unknown')}</div>
            <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(lead.email || 'No email')}</div>
            <div style="font-size: 11px; color: var(--gold-primary); margin-top: 4px;">${lead.status || 'Lead'}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error searching leads:', err);
        resultsEl.innerHTML = '<p style="color: var(--error);">Error searching customers.</p>';
      }
    }

    let _selectedLeadId = null;
    let _selectedLeadName = null;
    let _selectedLeadEmail = null;

    function selectLeadForDesign(leadId, name, email) {
      _selectedLeadId = leadId;
      _selectedLeadName = name;
      _selectedLeadEmail = email;

      // Highlight selected
      document.querySelectorAll('.lead-search-item').forEach(el => {
        el.style.background = 'transparent';
        el.style.borderColor = 'var(--border-color)';
      });
      event.currentTarget.style.background = 'rgba(249, 203, 0, 0.1)';
      event.currentTarget.style.borderColor = 'var(--gold-primary)';
    }

    async function confirmLinkDesignToLead(designId) {
      const directEmail = document.getElementById('directCustomerEmail')?.value?.trim();

      let leadId = _selectedLeadId;
      let customerName = _selectedLeadName;
      let customerEmail = _selectedLeadEmail || directEmail;

      if (!leadId && !customerEmail) {
        showToast('Please select a customer or enter an email', 'warning');
        return;
      }

      try {
        // If only email provided, try to find or we'll store the email
        if (!leadId && customerEmail) {
          // Check if lead exists with this email
          const { data: existingLead } = await supabaseClient
            .from('leads')
            .select('id, name')
            .eq('email', customerEmail)
            .single();

          if (existingLead) {
            leadId = existingLead.id;
            customerName = existingLead.name;
          }
        }

        // Generate share token if design doesn't have one
        const design = allDesigns.find(d => d.id === designId);
        let shareToken = design?.share_token;

        if (!shareToken) {
          shareToken = generateToken(16);
          await supabaseClient
            .from('room_designs')
            .update({ share_token: shareToken })
            .eq('id', designId);
        }

        // Create or update room_design_shares record
        const { error } = await supabaseClient
          .from('room_design_shares')
          .upsert({
            design_id: designId,
            lead_id: leadId,
            customer_name: customerName,
            customer_email: customerEmail,
            share_token: shareToken,
            permission_level: 'view'
          }, { onConflict: 'design_id,lead_id' });

        if (error) throw error;

        document.getElementById('linkLeadModal')?.remove();
        showToast(`Design linked to ${customerName || customerEmail}`, 'success');

        // Refresh designs to show the link
        await loadMyDesigns();

        // Reset
        _selectedLeadId = null;
        _selectedLeadName = null;
        _selectedLeadEmail = null;

      } catch (err) {
        console.error('Error linking design:', err);
        showToast('Failed to link design to customer', 'error');
      }
    }

    function generateToken(length) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let token = '';
      for (let i = 0; i < length; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return token;
    }

    // Open messages for a specific design
    function openDesignMessages(designId) {
      // Navigate to messages page with design filter
      showPage('messages');

      // Set filter to show messages for this design
      setTimeout(() => {
        const shares = designShares[designId] || [];
        if (shares.length > 0 && shares[0].lead_id) {
          // If we have a conversation filter, apply it
          const leadId = shares[0].lead_id;
          if (typeof loadConversation === 'function') {
            loadConversation(leadId, 'design_share');
          }
        }
        showToast('Showing messages for this design', 'info');
      }, 300);
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ============ NAVIGATION & LOCATION HELPERS ============

    // Build full address string
    function buildFullAddress(street, city, state, zip) {
      const parts = [street, city, state, zip].filter(Boolean);
      return parts.join(', ');
    }

    // Get navigation URL (works on mobile and desktop)
    function getNavigationUrl(street, city, state, zip) {
      const address = buildFullAddress(street, city, state, zip);
      // Use universal Google Maps URL that works everywhere
      return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
    }

    // Open in Google Maps with directions
    function openInGoogleMaps(street, city, state, zip) {
      const address = buildFullAddress(street, city, state, zip);
      // Check if on iOS for Apple Maps option
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

      if (isIOS && confirm('Open in Apple Maps instead of Google Maps?')) {
        window.open(`https://maps.apple.com/?daddr=${encodeURIComponent(address)}`, '_blank');
      } else {
        // Google Maps directions (will prompt for starting location)
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`, '_blank');
      }
    }

    // Share En Route status - notifies customer and logs activity
    async function shareEnRouteStatus(projectId, customerName, street, city, state, zip) {
      const address = buildFullAddress(street, city, state, zip);

      // Show confirmation with options
      const options = [
        { label: 'Start Navigation & Notify Customer', value: 'navigate_notify' },
        { label: 'Just Start Navigation', value: 'navigate_only' },
        { label: 'Just Update Status', value: 'status_only' }
      ];

      const choice = await showEnRouteOptions(customerName, address);
      if (!choice) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Update project status to show en route
        if (choice !== 'navigate_only') {
          await supabaseClient
            .from('projects')
            .update({
              en_route_status: 'en_route',
              en_route_started_at: new Date().toISOString(),
              en_route_by: user.id,
              updated_at: new Date().toISOString()
            })
            .eq('id', projectId);

          // Log activity
          await supabaseClient.from('project_activity').insert({
            project_id: projectId,
            user_id: user.id,
            type: 'en_route',
            message: `${userProfile?.full_name || 'Team member'} is en route to the project location`,
            created_at: new Date().toISOString()
          });

          showToast('En Route status updated!', 'success');
        }

        // Open navigation
        if (choice === 'navigate_notify' || choice === 'navigate_only') {
          openInGoogleMaps(street, city, state, zip);
        }

        // Send notification to customer (if they have email)
        if (choice === 'navigate_notify') {
          const { data: project } = await supabaseClient
            .from('projects')
            .select('customer_email, customer_phone, customer_name')
            .eq('id', projectId)
            .single();

          if (project?.customer_email) {
            // Send en route notification email
            try {
              await fetch(`${API_BASE}/api/notifications/en-route`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  customer_email: project.customer_email,
                  customer_name: project.customer_name,
                  team_member: userProfile?.full_name || 'Our team',
                  project_address: address
                })
              });
              showToast('Customer notified!', 'success');
            } catch (e) {
              console.warn('Could not send en route notification:', e);
            }
          }
        }

      } catch (err) {
        console.error('Error updating en route status:', err);
        showToast('Error updating status', 'error');
      }
    }

    // Show en route options dialog
    function showEnRouteOptions(customerName, address) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay active';
        modal.style.zIndex = '20000';
        modal.innerHTML = `
          <div class="modal" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
              <h2 class="modal-title">En Route to Project</h2>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
              <div style="background: var(--dark-surface); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">DESTINATION</div>
                <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(customerName || 'Customer')}</div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">${escapeHtml(address)}</div>
              </div>
              <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-modern primary" style="width: 100%; justify-content: center; padding: 14px;" onclick="this.closest('.modal-overlay').dataset.choice='navigate_notify'; this.closest('.modal-overlay').remove();">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                  Navigate & Notify Customer
                </button>
                <button class="btn-modern secondary" style="width: 100%; justify-content: center; padding: 14px;" onclick="this.closest('.modal-overlay').dataset.choice='navigate_only'; this.closest('.modal-overlay').remove();">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                  Just Navigate
                </button>
                <button class="btn-modern ghost" style="width: 100%; justify-content: center; padding: 14px;" onclick="this.closest('.modal-overlay').dataset.choice='status_only'; this.closest('.modal-overlay').remove();">
                  Update Status Only
                </button>
              </div>
            </div>
          </div>
        `;

        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
            resolve(null);
          }
        });

        const observer = new MutationObserver(() => {
          if (!document.body.contains(modal)) {
            observer.disconnect();
            resolve(modal.dataset.choice || null);
          }
        });
        observer.observe(document.body, { childList: true });

        document.body.appendChild(modal);
      });
    }

    // Mark as arrived at location
    async function markArrivedAtProject(projectId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        await supabaseClient
          .from('projects')
          .update({
            en_route_status: 'arrived',
            arrived_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          })
          .eq('id', projectId);

        await supabaseClient.from('project_activity').insert({
          project_id: projectId,
          user_id: user.id,
          type: 'arrived',
          message: `${userProfile?.full_name || 'Team member'} arrived at the project location`,
          created_at: new Date().toISOString()
        });

        showToast('Marked as arrived!', 'success');
        if (typeof openProjectDetail === 'function') {
          openProjectDetail(projectId);
        }
      } catch (err) {
        console.error('Error marking arrived:', err);
        showToast('Error updating status', 'error');
      }
    }

    function requestQuoteForFavorites() {
      if (allFavorites.length === 0) {
        showToast('No favorites saved yet!', 'error');
        return;
      }

      // Build quote modal
      const modal = document.createElement('div');
      modal.className = 'quote-modal';
      modal.id = 'quote-modal';
      modal.innerHTML = `
        <div class="quote-modal-content">
          <div class="quote-modal-header">
            <h3>Request a Quote</h3>
            <button onclick="closeQuoteModal()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div class="quote-modal-body">
            <p style="color: var(--text-secondary); margin-bottom: 16px;">We'll prepare a quote for these ${allFavorites.length} items:</p>

            <div class="quote-items-list">
              ${allFavorites.map(item => `
                <div class="quote-item">
                  <img src="${item.product_image || '/images/placeholder.svg'}" alt="${item.product_title}">
                  <div class="quote-item-info">
                    <div class="quote-item-title">${item.product_title}</div>
                    <div class="quote-item-material">${item.product_type || ''} ${item.product_material ? '- ' + item.product_material : ''} ${item.product_color ? '- ' + item.product_color : ''}</div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="form-group" style="margin-bottom: 16px;">
              <label style="display: block; margin-bottom: 6px; color: var(--text-secondary); font-size: 13px;">Additional Notes (Optional)</label>
              <textarea id="quote-notes" rows="3" placeholder="Tell us about your project, room size, timeline, etc." style="width: 100%; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark); color: var(--text-primary); resize: vertical;"></textarea>
            </div>

            <button class="btn-modern primary" style="width: 100%;" onclick="submitQuoteRequest()">
              Submit Quote Request
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeQuoteModal() {
      const modal = document.getElementById('quote-modal');
      if (modal) modal.remove();
    }

    async function submitQuoteRequest() {
      const notes = document.getElementById('quote-notes')?.value || '';

      // Group favorites by type for the quote
      const groupedFavorites = allFavorites.reduce((acc, f) => {
        const type = f.product_type || 'other';
        if (!acc[type]) acc[type] = [];
        acc[type].push(f);
        return acc;
      }, {});

      // Build formatted list
      const itemsList = Object.entries(groupedFavorites).map(([type, items]) => {
        return `${type.charAt(0).toUpperCase() + type.slice(1)}:\n${items.map(f => `  - ${f.product_title} (${f.product_material || 'N/A'})`).join('\n')}`;
      }).join('\n\n');

      try {
        // Create lead/quote request in Supabase
        const quoteData = {
          user_id: currentUser.id,
          email: currentUser.email,
          full_name: userProfile?.full_name || currentUser.email.split('@')[0],
          phone: userProfile?.phone || '',
          status: 'new',
          source: 'favorites_quote',
          notes: `Quote Request from Favorites:\n\n${itemsList}\n\nAdditional Notes: ${notes || 'None'}`,
          created_at: new Date().toISOString()
        };

        const { error } = await supabaseClient
          .from('leads')
          .insert(quoteData);

        if (error) {
          console.warn('Lead insert error (table may not exist):', error);
        }

        // Send email notification via API
        try {
          await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              email: 'info@surprisegranite.com',
              counterSqft: 'Quote Request from Favorites',
              splashSqft: '',
              totalSqft: `${allFavorites.length} items selected`,
              edgeProfile: `Customer: ${userProfile?.full_name || currentUser.email}`,
              edgeLF: `Phone: ${userProfile?.phone || 'N/A'}`,
              priceBudget: allFavorites.map(f => f.product_title).join(', '),
              pricePopular: notes || 'No additional notes',
              pricePremium: `Email: ${currentUser.email}`
            })
          });
        } catch (emailErr) {
          console.warn('Email notification error:', emailErr);
        }

        closeQuoteModal();
        showToast('Quote request submitted! We\'ll contact you soon.', 'success');

      } catch (err) {
        console.error('Quote submit error:', err);
        showToast('Error submitting quote. Please try again.', 'error');
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#333'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Show keyboard shortcuts modal
    function showKeyboardShortcuts() {
      const shortcuts = [
        { category: 'Navigation', items: [
          { keys: 'D', desc: 'Go to Dashboard' },
          { keys: 'L', desc: 'Go to Leads' },
          { keys: 'P', desc: 'Go to Projects' },
          { keys: 'C', desc: 'Go to Calendar' },
          { keys: 'F', desc: 'Go to Finance' },
        ]},
        { category: 'Quick Actions', items: [
          { keys: 'Ctrl/Cmd + N', desc: 'Add New Lead' },
          { keys: 'Ctrl/Cmd + K', desc: 'Focus Search' },
          { keys: 'Shift + E', desc: 'Add Calendar Event' },
          { keys: 'Shift + I', desc: 'Create Invoice' },
          { keys: 'Shift + P', desc: 'Create Project' },
        ]},
        { category: 'General', items: [
          { keys: 'Escape', desc: 'Close Modal/Popup' },
        ]},
      ];

      const modal = document.createElement('div');
      modal.className = 'keyboard-shortcuts-modal';
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000;
        display: flex; align-items: center; justify-content: center; padding: 20px;
      `;
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; max-width: 480px; width: 100%; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Keyboard Shortcuts</h2>
            <button onclick="this.closest('.keyboard-shortcuts-modal').remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px;">&times;</button>
          </div>
          ${shortcuts.map(cat => `
            <div style="margin-bottom: 20px;">
              <h3 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 10px;">${cat.category}</h3>
              ${cat.items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                  <span style="color: var(--text-secondary); font-size: 14px;">${item.desc}</span>
                  <kbd style="background: var(--dark-elevated); border: 1px solid var(--border-light); border-radius: 6px; padding: 4px 10px; font-family: monospace; font-size: 12px; color: var(--gold-primary);">${item.keys}</kbd>
                </div>
              `).join('')}
            </div>
          `).join('')}
          <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; text-align: center;">Press <kbd style="background: var(--dark-elevated); border: 1px solid var(--border-light); border-radius: 4px; padding: 2px 6px; font-size: 11px;">?</kbd> anytime to show this help</p>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // ============ NOTIFICATION HELPER ============
    // Send email + SMS notifications via API
    async function sendNotification(type, action, entity, recipient, newStatus = null) {
      // Only send if we have recipient info
      if (!recipient?.email && !recipient?.phone) {
        return { email: { sent: false }, sms: { sent: false } };
      }

      try {
        const response = await fetch('/api/workflow/notify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type,          // 'estimate', 'invoice', 'job', 'appointment'
            action,        // 'sent', 'approved', 'status_change', 'reminder', 'paid'
            entity,        // The data object
            recipient,     // { email, phone, name }
            new_status: newStatus
          })
        });

        if (response.ok) {
          const result = await response.json();
          console.log('[Notify] Sent:', { type, action, result: result.notifications });
          return result.notifications;
        } else {
          console.log('[Notify] API error:', response.status);
          return { email: { sent: false }, sms: { sent: false } };
        }
      } catch (err) {
        console.log('[Notify] Error:', err.message);
        return { email: { sent: false }, sms: { sent: false } };
      }
    }

    // Load subscriber/user statistics
    // ============ NEEDS ATTENTION WIDGET ============
    async function loadNeedsAttention() {
      const container = document.getElementById('needs-attention-content');
      if (!container) return;

      try {
        const items = [];

        // Get leads not contacted in 48+ hours
        const cutoff48h = new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString();
        const { data: staleLeads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, created_at')
          .eq('status', 'new')
          .lt('created_at', cutoff48h)
          .limit(5);

        if (staleLeads?.length > 0) {
          items.push({
            type: 'leads',
            icon: '📞',
            color: '#f59e0b',
            title: `${staleLeads.length} lead${staleLeads.length > 1 ? 's' : ''} need follow-up`,
            subtitle: 'Not contacted in 48+ hours',
            action: () => showPage('leads')
          });
        }

        // Get today's appointments
        const today = new Date();
        const todayStart = new Date(today.setHours(0, 0, 0, 0)).toISOString();
        const todayEnd = new Date(today.setHours(23, 59, 59, 999)).toISOString();
        const { data: todayAppts } = await supabaseClient
          .from('calendar_events')
          .select('id')
          .gte('start_time', todayStart)
          .lte('start_time', todayEnd)
          .in('status', ['scheduled', 'confirmed']);

        if (todayAppts?.length > 0) {
          items.push({
            type: 'appointments',
            icon: '📅',
            color: '#3b82f6',
            title: `${todayAppts.length} appointment${todayAppts.length > 1 ? 's' : ''} today`,
            subtitle: 'View your schedule',
            action: () => showPage('calendar')
          });
        }

        // Get overdue invoices
        const { data: overdueInvoices } = await supabaseClient
          .from('invoices')
          .select('id, total')
          .eq('status', 'sent')
          .lt('due_date', new Date().toISOString())
          .limit(10);

        if (overdueInvoices?.length > 0) {
          const total = overdueInvoices.reduce((sum, inv) => sum + (inv.total || 0), 0);
          items.push({
            type: 'invoices',
            icon: '💰',
            color: '#ef4444',
            title: `$${total.toLocaleString()} in overdue invoices`,
            subtitle: `${overdueInvoices.length} invoice${overdueInvoices.length > 1 ? 's' : ''} past due`,
            action: () => showPage('invoices')
          });
        }

        // Get pending estimates awaiting approval
        const { data: pendingEstimates } = await supabaseClient
          .from('estimates')
          .select('id')
          .eq('status', 'sent')
          .limit(10);

        if (pendingEstimates?.length > 0) {
          items.push({
            type: 'estimates',
            icon: '📋',
            color: '#8b5cf6',
            title: `${pendingEstimates.length} estimate${pendingEstimates.length > 1 ? 's' : ''} awaiting approval`,
            subtitle: 'Sent but not yet approved',
            action: () => showPage('estimates')
          });
        }

        // Render items
        if (items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <p style="margin: 0;">All caught up!</p>
            </div>`;
          return;
        }

        container.innerHTML = items.map(item => `
          <div class="attention-item" onclick="${item.action ? item.action.toString().replace(/"/g, "'") : ''}" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 8px; cursor: pointer; border-left: 3px solid ${item.color};">
            <span style="font-size: 20px;">${item.icon}</span>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 14px;">${item.title}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${item.subtitle}</div>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          </div>
        `).join('');

        // Make items clickable
        container.querySelectorAll('.attention-item').forEach((el, i) => {
          el.onclick = items[i].action;
        });

      } catch (err) {
        console.error('Load needs attention error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading data</div>';
      }
    }

    function refreshNeedsAttention() {
      loadNeedsAttention();
      showToast('Refreshed', 'success');
    }

    // ============ TODAY'S SCHEDULE WIDGET ============
    async function loadTodaySchedule() {
      const container = document.getElementById('today-schedule-content');
      if (!container) return;

      try {
        const today = new Date();
        const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate()).toISOString();
        const todayEnd = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59).toISOString();

        const { data: events, error } = await supabaseClient
          .from('calendar_events')
          .select('id, title, start_time, end_time, event_type, location, status')
          .gte('start_time', todayStart)
          .lte('start_time', todayEnd)
          .order('start_time', { ascending: true });

        if (error) throw error;

        if (!events || events.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <p style="margin: 0 0 12px;">No appointments scheduled for today</p>
              <button class="btn-modern primary" onclick="showPage('calendar'); setTimeout(() => openCalendarEventModal(), 200);" style="font-size: 13px;">
                Schedule Something
              </button>
            </div>`;
          return;
        }

        container.innerHTML = events.map(event => {
          const startTime = new Date(event.start_time);
          const timeStr = startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
          const typeColors = {
            appointment: '#f59e0b',
            consultation: '#6366f1',
            measurement: '#10b981',
            installation: '#3b82f6',
            delivery: '#8b5cf6'
          };
          const color = typeColors[event.event_type] || '#6b7280';

          return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--border-subtle);">
              <div style="width: 4px; height: 40px; background: ${color}; border-radius: 2px;"></div>
              <div style="min-width: 70px; font-size: 13px; color: var(--text-muted);">${timeStr}</div>
              <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 14px;">${escapeHtml(event.title)}</div>
                ${event.location ? `<div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(event.location)}</div>` : ''}
              </div>
              <span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: ${color}20; color: ${color};">${event.event_type}</span>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Load today schedule error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading schedule</div>';
      }
    }

    // Load field status - projects with team en route or on site
    // Feature flag: set to true when en_route columns are added to projects table
    const ENABLE_FIELD_STATUS = false;

    async function loadFieldStatus() {
      const container = document.getElementById('field-status-content');
      const card = document.getElementById('field-status-card');
      if (!container || !card) return;

      // Skip if feature not enabled (columns don't exist yet)
      if (!ENABLE_FIELD_STATUS) {
        card.style.display = 'none';
        return;
      }

      try {
        const { data: projects, error } = await supabaseClient
          .from('projects')
          .select('id, name, customer_name, customer_phone, address, city, state, zip, en_route_status, en_route_started_at, arrived_at, en_route_by')
          .in('en_route_status', ['en_route', 'arrived'])
          .order('en_route_started_at', { ascending: false })
          .limit(10);

        if (error) {
          card.style.display = 'none';
          return;
        }

        // Show/hide card based on whether there are any en route projects
        if (!projects || projects.length === 0) {
          card.style.display = 'none';
          return;
        }

        card.style.display = 'block';

        container.innerHTML = projects.map(p => {
          const isEnRoute = p.en_route_status === 'en_route';
          const isArrived = p.en_route_status === 'arrived';
          const statusColor = isEnRoute ? '#f59e0b' : '#22c55e';
          const statusLabel = isEnRoute ? 'EN ROUTE' : 'ON SITE';
          const statusIcon = isEnRoute
            ? '<path d="M13 10V3L4 14h7v7l9-11h-7z"/>'
            : '<path d="M5 13l4 4L19 7"/>';
          const timeStr = p.en_route_started_at
            ? new Date(p.en_route_started_at).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })
            : '';
          const address = buildFullAddress(p.address, p.city, p.state, p.zip);

          return `
            <div style="display: flex; align-items: flex-start; gap: 12px; padding: 14px 16px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; transition: background 0.15s;" onclick="openProjectDetail('${p.id}')" onmouseover="this.style.background='var(--dark-elevated)'" onmouseout="this.style.background='transparent'">
              <div style="width: 36px; height: 36px; border-radius: 8px; background: ${statusColor}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg width="18" height="18" fill="none" stroke="${statusColor}" stroke-width="2" viewBox="0 0 24 24">${statusIcon}</svg>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${escapeHtml(p.name)}</span>
                  <span style="font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; background: ${statusColor}; color: white;">${statusLabel}</span>
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">${escapeHtml(p.customer_name || 'No customer')}</div>
                ${address ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; display: flex; align-items: center; gap: 4px;">
                  <svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
                  ${escapeHtml(address)}
                </div>` : ''}
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px; flex-shrink: 0;">
                ${timeStr ? `<span style="font-size: 11px; color: var(--text-muted);">Started ${timeStr}</span>` : ''}
                <div style="display: flex; gap: 4px;">
                  ${p.customer_phone ? `<a href="tel:${p.customer_phone}" onclick="event.stopPropagation();" style="width: 28px; height: 28px; border-radius: 6px; background: #22c55e20; display: flex; align-items: center; justify-content: center;">
                    <svg width="14" height="14" fill="none" stroke="#22c55e" stroke-width="2" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72"/></svg>
                  </a>` : ''}
                  <button onclick="event.stopPropagation(); openInGoogleMaps('${escapeHtml(p.address || '')}', '${escapeHtml(p.city || '')}', '${escapeHtml(p.state || '')}', '${escapeHtml(p.zip || '')}')" style="width: 28px; height: 28px; border-radius: 6px; background: #3b82f620; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <svg width="14" height="14" fill="none" stroke="#3b82f6" stroke-width="2" viewBox="0 0 24 24"><path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                  </button>
                  ${isEnRoute ? `<button onclick="event.stopPropagation(); markArrivedAtProject('${p.id}')" style="padding: 4px 10px; border-radius: 6px; background: #22c55e; border: none; cursor: pointer; font-size: 11px; font-weight: 600; color: white;">Mark Arrived</button>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        // Silently hide card if columns don't exist yet (schema not updated)
        card.style.display = 'none';
      }
    }

    function refreshFieldStatus() {
      loadFieldStatus();
      showToast('Field status refreshed', 'success');
    }

    async function loadSubscriberStats() {
      try {
        // Get total users count
        const { count: totalUsers, error: totalError } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact', head: true });

        if (totalError) throw totalError;

        // Get new users (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

        const { count: newUsers, error: newError } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact', head: true })
          .gte('created_at', sevenDaysAgo.toISOString());

        if (newError) throw newError;

        // Update UI
        const totalUsersEl = document.getElementById('stat-total-users');
        const newUsersEl = document.getElementById('stat-new-users');

        if (totalUsersEl) totalUsersEl.textContent = totalUsers || 0;
        if (newUsersEl) newUsersEl.textContent = newUsers || 0;

        console.log('Subscriber stats loaded:', { totalUsers, newUsers });
      } catch (err) {
        console.warn('Error loading subscriber stats:', err.message);
        // Set fallback values
        const totalUsersEl = document.getElementById('stat-total-users');
        const newUsersEl = document.getElementById('stat-new-users');
        if (totalUsersEl) totalUsersEl.textContent = '0';
        if (newUsersEl) newUsersEl.textContent = '0';
      }
    }

    let dashboardInitialized = false;

    function setupDashboard() {
      // Prevent re-initialization which would reset stats
      if (dashboardInitialized) {
        return;
      }
      dashboardInitialized = true;

      // Setup stats and quick actions based on role
      const statsEl = document.getElementById('dashboard-stats');
      const actionsEl = document.getElementById('quick-actions');

      if (isAdmin) {
        loadLeads();
        loadCustomers();
        loadSubscriberStats();
        setupLeadsRealtime();
        statsEl.innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="stat-total">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Leads</div>
            <div class="stat-value" id="stat-new">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">New Users</div>
            <div class="stat-value" id="stat-new-users">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Users</div>
            <div class="stat-value" id="stat-total-users">-</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('collaborators')">
            <div class="stat-label">Network</div>
            <div class="stat-value" id="stat-network">-</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="javascript:void(0)" class="action-card" onclick="showPage('leads'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>View Leads</h4>
              <p>Manage incoming leads from the website</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="showPage('calendar'); setTimeout(() => openCalendarEventModal(), 200); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Schedule</h4>
              <p>Create appointment or meeting</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="openInviteToProjectModal(); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
            </div>
            <div class="action-text">
              <h4>Invite Collaborator</h4>
              <p>Invite someone to collaborate on a project</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="showPage('projects'); return false;">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Projects</h4>
              <p>Manage projects, track progress and revenue</p>
            </div>
          </a>
          <a href="javascript:void(0)" class="action-card" onclick="resetTutorial(); return false;" style="border: 1px dashed var(--gold-primary); background: rgba(249, 203, 0, 0.05);">
            <div class="action-icon" style="color: var(--gold-primary);">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>Take the Tour <span class="new-feature-badge" style="margin-left: 8px;">NEW</span></h4>
              <p>Learn about new project management features</p>
            </div>
          </a>
        `;

        // Show admin widgets
        document.getElementById('needs-attention-card').style.display = 'block';
        document.getElementById('today-schedule-card').style.display = 'block';
        // Field status card visibility is controlled by loadFieldStatus based on data
        loadNeedsAttention();
        loadTodaySchedule();
        loadFieldStatus();
      } else {
        // Enhanced user stats
        statsEl.innerHTML = `
          <div class="stat-card clickable" onclick="showPage('favorites')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg></div>
            <div class="stat-label">My Favorites</div>
            <div class="stat-value" id="stat-favorites">0</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('listings')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg></div>
            <div class="stat-label">My Listings</div>
            <div class="stat-value" id="stat-listings">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
            <div class="stat-label">Quotes Sent</div>
            <div class="stat-value" id="stat-quotes">0</div>
          </div>
          <div class="stat-card clickable" onclick="showPage('collaborators')">
            <div class="stat-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
            <div class="stat-label">My Network</div>
            <div class="stat-value" id="stat-network">0</div>
          </div>
        `;
        actionsEl.innerHTML = `
          <a href="/get-a-free-estimate/" class="action-card action-highlight">
            <div class="action-icon action-icon-gold">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Get Free Estimate</h4>
              <p>Request a quote for your project</p>
            </div>
          </a>
          <a href="javascript:void(0)" onclick="showPage('favorites'); return false;" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>My Favorites</h4>
              <p>View saved materials</p>
            </div>
          </a>
          <a href="/remnants/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/></svg>
            </div>
            <div class="action-text">
              <h4>Stone Marketplace</h4>
              <p>Buy & sell remnants</p>
            </div>
          </a>
          <a href="/marketplace/slabs//" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Countertops</h4>
              <p>Granite, quartz, marble</p>
            </div>
          </a>
          <a href="/materials/flooring/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-width="2" d="M4 4h16v16H4z M4 10h16 M10 4v16"/></svg>
            </div>
            <div class="action-text">
              <h4>Browse Flooring</h4>
              <p>LVP, hardwood, tile</p>
            </div>
          </a>
          <a href="/tools/countertop-calculator/" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
            </div>
            <div class="action-text">
              <h4>Calculator</h4>
              <p>Estimate your project</p>
            </div>
          </a>
          <a href="javascript:void(0)" onclick="showPage('collaborators'); return false;" class="action-card">
            <div class="action-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </div>
            <div class="action-text">
              <h4>Collaborations</h4>
              <p>View project collaborations</p>
            </div>
          </a>
        `;
      }

      // Setup leads filter buttons (filter-pill with data-status)
      document.querySelectorAll('.filter-pills .filter-pill[data-status]').forEach(btn => {
        btn.addEventListener('click', () => {
          // Only toggle active within leads filter pills
          btn.closest('.filter-pills').querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentFilter = btn.dataset.status;
          renderLeads();
        });
      });

      // Setup search
      document.getElementById('leads-search')?.addEventListener('input', () => {
        renderLeads();
      });

      // Load admin users if admin
      if (isSuperAdmin) {
        loadAdminUsers();
      }

      // Load user stats from database
      if (!isAdmin) {
        loadUserStats();
      }

      // Bridge: check vendor onboarding + network stats
      checkVendorOnboarding();
      loadNetworkStats();
    }

    // Load real user stats from database
    async function loadUserStats() {
      if (!currentUser) return;

      try {
        // Load favorites count
        const { count: favCount, error: favError } = await supabaseClient
          .from('user_favorites')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!favError) {
          const favEl = document.getElementById('stat-favorites');
          if (favEl) favEl.textContent = favCount || 0;
        }

        // Load listings count
        const { count: listCount, error: listError } = await supabaseClient
          .from('marketplace_listings')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!listError) {
          const listEl = document.getElementById('stat-listings');
          if (listEl) listEl.textContent = listCount || 0;
        }

        // Load quotes count
        const { count: quoteCount, error: quoteError } = await supabaseClient
          .from('quote_requests')
          .select('*', { count: 'exact', head: true })
          .eq('user_id', currentUser.id);

        if (!quoteError) {
          const quoteEl = document.getElementById('stat-quotes');
          if (quoteEl) quoteEl.textContent = quoteCount || 0;
        }

        console.log('Dashboard: Loaded user stats', { favorites: favCount, listings: listCount, quotes: quoteCount });

      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    // Bridge 1: Check if pro user needs vendor onboarding
    async function checkVendorOnboarding() {
      try {
        if (!currentUser || !userProfile) return;
        var role = userProfile.account_type || userProfile.role || '';
        if (['pro_fabricator', 'pro_designer', 'contractor'].indexOf(role) === -1) return;

        var result = await supabaseClient
          .from('vendor_profiles')
          .select('id')
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (result.data) return; // Already has vendor profile

        var banner = document.getElementById('vendor-onboarding-banner');
        if (!banner) return;
        banner.style.display = '';
        banner.innerHTML =
          '<div class="vendor-onboarding-banner">' +
            '<svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="none" viewBox="0 0 24 24" stroke="var(--gold-primary)" stroke-width="1.5" style="flex-shrink: 0;"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>' +
            '<div class="banner-text">' +
              '<h3>Complete Your Vendor Profile</h3>' +
              '<p>Set up your business profile to appear in our network, receive project leads, and list your inventory on the marketplace.</p>' +
            '</div>' +
            '<a href="/vendor/signup/" class="btn-modern primary" style="white-space: nowrap;">Set Up Profile</a>' +
            '<button class="banner-dismiss" onclick="this.closest(\'.vendor-onboarding-banner\').parentElement.style.display=\'none\'" title="Dismiss">&times;</button>' +
          '</div>';
      } catch (err) {
        console.error('[VendorOnboarding] Check failed:', err);
      }
    }

    // Bridge 4: Load network/collaboration stats for dashboard
    async function loadNetworkStats() {
      try {
        var resp = await apiCall('/api/collaboration/my-projects?status=accepted');
        var data = await resp.json();
        var count = (data.collaborations || []).length;
        var el = document.getElementById('stat-network');
        if (el) el.textContent = count;
      } catch (e) {
        // Silently fail - network stats are non-critical
      }
    }

    async function showPage(page) {
      console.log('[showPage] Called for page:', page, 'authReady:', authReady, 'supabaseClient:', !!supabaseClient);

      // Block non-GOD MODE users from accessing god-* pages
      if (page.startsWith('god-') && !isGodMode()) {
        console.warn('[showPage] Access denied: GOD MODE required for page:', page);
        showPage('dashboard');
        return;
      }

      // Update URL hash without triggering hashchange
      if (window.location.hash !== `#${page}`) {
        history.replaceState(null, '', `#${page}`);
      }

      // Update nav
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.page === page);
      });

      // Update toolbar active state
      document.querySelectorAll('.page-toolbar .toolbar-btn[data-page]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.page === page);
      });

      // Update page sections
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.toggle('active', section.id === `page-${page}`);
      });

      // Update title
      const titles = {
        'dashboard': 'Dashboard',
        'profile': 'My Profile',
        'favorites': 'My Favorites',
        'my-designs': 'My Designs',
        'listings': 'My Listings',
        'tools': 'Design Tools',
        'leads': 'Leads',
        'customers': 'Customers',
        'estimates': 'Estimates',
        'invoices': 'Invoices',
        'jobs': 'Jobs & Projects',
        'projects': 'Projects',
        'collaborators': 'Collaborators & Team',
        'calendar': 'Calendar',
        'wallet': 'Wallet',
        'admin-users': 'Manage Admins',
        'products': 'Products',
        'orders': 'Orders',
        'messages': 'Messages',
        'collaborations': 'My Collaborations',
        'god-designs': 'All Designs'
      };
      document.getElementById('page-title').textContent = titles[page] || 'Dashboard';

      // Close mobile sidebar first (don't wait for data)
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      if (sidebar) sidebar.classList.remove('open');
      if (overlay) overlay.classList.remove('active');

      // Update FAB visibility based on current page
      updateFabVisibility(page);

      // Wait for auth to be ready before loading any data
      if (!authReady || !supabaseClient) {
        console.log('[showPage] Waiting for auth, authReady:', authReady, 'supabaseClient:', !!supabaseClient);
        const ready = await waitForAuth();
        if (!ready || !supabaseClient) {
          console.error('[showPage] Auth failed to initialize for page:', page);
          return;
        }
        console.log('[showPage] Auth now ready, loading', page);
      }

      console.log('[showPage] Loading data for page:', page);

      // Load data based on page - wrapped in try-catch to prevent silent failures
      try {
        // Load estimates when that page is shown
        if (page === 'estimates') {
          await loadEstimates();
        }

        // Load invoices when that page is shown
        if (page === 'invoices') {
          await loadInvoices();
        }

        // Load leads when that page is shown
        if (page === 'leads') {
          await loadLeads();
        }

        // Load favorites when that page is shown
        if (page === 'favorites') {
          await loadFavorites();
        }

        // Load my designs when that page is shown
        if (page === 'my-designs') {
          await loadMyDesigns();
        }

        // Load listings when that page is shown
        if (page === 'listings') {
          await loadMyListings();
        }

        // Load jobs when that page is shown
        if (page === 'jobs') {
          await loadJobs();
        }

        // Load projects when that page is shown
        if (page === 'projects') {
          await loadProjects();
        }

        // Load orders when that page is shown
        if (page === 'orders') {
          await loadOrders();
        }

        // Load collaborators when that page is shown
        if (page === 'collaborators') {
          await loadCollaborators();
        }

        // Load calendar when that page is shown - optimized for speed
        if (page === 'calendar') {
          renderCalendar(); // Show empty grid immediately
          // Load job events first (clears array), then custom events (merges)
          loadCalendarEvents().then(() => loadAllCalendarEvents());
        }

        // Load customers when that page is shown
        if (page === 'customers') {
          await loadCustomers();
        }

        // Load messages when that page is shown
        if (page === 'messages') {
          await loadConversations();
        }

        // Load collaborations when that page is shown
        if (page === 'collaborations') {
          await loadCollaborations();
          // Also load network count and invitations count for badges
          loadMyNetwork();
          loadReceivedInvitations();
        }
      } catch (err) {
        console.error('[showPage] Error loading data for', page, err);
      }
    }

    // Show/hide the appropriate FAB based on current page
    function updateFabVisibility(page) {
      const fabMap = {
        'leads': 'fab-leads',
        'estimates': 'fab-estimates',
        'invoices': 'fab-invoices',
        'jobs': 'fab-jobs',
        'customers': 'fab-customers'
      };

      // Hide all FABs first
      document.querySelectorAll('.fab-modern').forEach(fab => {
        fab.style.display = 'none';
      });

      // Show the FAB for current page (mobile only)
      const fabId = fabMap[page];
      if (fabId && window.innerWidth <= 768) {
        const fab = document.getElementById(fabId);
        if (fab) {
          fab.style.display = 'flex';
        }
      }
    }

    // Update FAB visibility on window resize
    window.addEventListener('resize', () => {
      const currentPage = window.location.hash.slice(1) || 'dashboard';
      updateFabVisibility(currentPage);
    });

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      if (sidebar) sidebar.classList.toggle('open');
      if (overlay) overlay.classList.toggle('active');
    }

    // Toggle sidebar collapse state (desktop)
    function toggleSidebarCollapse() {
      const sidebar = document.getElementById('sidebar');
      const isCollapsed = sidebar.classList.toggle('collapsed');
      document.body.classList.toggle('sidebar-collapsed', isCollapsed);

      // Save state to localStorage
      localStorage.setItem('sidebarCollapsed', isCollapsed ? 'true' : 'false');
    }

    // Initialize sidebar state from localStorage
    function initSidebarState() {
      const savedState = localStorage.getItem('sidebarCollapsed');
      if (savedState === 'true') {
        document.getElementById('sidebar').classList.add('collapsed');
        document.body.classList.add('sidebar-collapsed');
      }
    }

    // Update badge visibility based on count
    function updateBadgeVisibility() {
      document.querySelectorAll('.nav-badge').forEach(badge => {
        const count = parseInt(badge.textContent) || 0;
        badge.setAttribute('data-count', count);
        if (count === 0) {
          badge.style.display = 'none';
        } else {
          badge.style.display = '';
        }
      });
    }

    async function saveProfile() {
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;
      const company = document.getElementById('profile-company').value;

      try {
        const { error } = await supabaseClient
          .from('sg_users')
          .update({
            full_name: name,
            phone: phone || null,
            company_name: company || null,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentUser.id);

        if (error) throw error;

        document.getElementById('user-name').textContent = name;
        document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
        alert('Profile saved successfully!');
      } catch (err) {
        alert('Error saving profile: ' + err.message);
      }
    }

    async function handleLogout() {
      // Use SgAuth's comprehensive logout if available
      if (window.SgAuth && typeof window.SgAuth.signOut === 'function') {
        await window.SgAuth.signOut({ redirect: true, redirectUrl: '/' });
        return;
      }

      // Fallback logout
      try {
        await supabaseClient.auth.signOut();
      } catch (e) {
        console.warn('Logout error:', e);
      }

      // Clear all state
      currentUser = null;
      userProfile = null;

      // Clear localStorage
      try {
        const storageKey = window._sgSupabaseConfig?.storageKey || 'sg-auth-token';
        localStorage.removeItem(storageKey);
        localStorage.removeItem('sb-ypeypgwsycxcagncgdur-auth-token');
        sessionStorage.removeItem('auth_redirect');
      } catch (e) {}

      // Dispatch logout event for other components
      window.dispatchEvent(new CustomEvent('sg-auth-logout', {
        detail: { timestamp: Date.now() }
      }));

      // Redirect to home
      window.location.href = '/';
    }

    // Leads Functions
    let leadsSubscription = null;

    function setupLeadsRealtime() {
      // Subscribe to new leads in real-time
      if (leadsSubscription) {
        leadsSubscription.unsubscribe();
      }

      leadsSubscription = supabaseClient
        .channel('leads-changes')
        .on('postgres_changes',
          { event: 'INSERT', schema: 'public', table: 'leads' },
          (payload) => {
            console.log('New lead received:', payload.new);
            // Add to beginning of array
            allLeads.unshift(payload.new);
            updateStats();
            renderLeads();
            // Show notification
            showNewLeadNotification(payload.new);
          }
        )
        .on('postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'leads' },
          (payload) => {
            const idx = allLeads.findIndex(l => l.id === payload.new.id);
            if (idx !== -1) {
              allLeads[idx] = payload.new;
              updateStats();
              renderLeads();
            }
          }
        )
        .subscribe();
    }

    function showNewLeadNotification(lead) {
      // Create floating notification
      const notification = document.createElement('div');
      notification.className = 'new-lead-notification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border: 2px solid var(--gold-primary);
        border-radius: 12px;
        padding: 16px 20px;
        z-index: 10000;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        animation: slideIn 0.3s ease;
        cursor: pointer;
        max-width: 350px;
      `;
      notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="width: 40px; height: 40px; background: var(--gold-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="#1a1a2e" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
          </div>
          <div>
            <div style="font-weight: 700; color: var(--gold-primary); font-size: 12px; text-transform: uppercase;">New Lead!</div>
            <div style="font-weight: 600; color: #fff;">${lead.full_name || 'Unknown'}</div>
            <div style="font-size: 13px; color: var(--text-muted);">${lead.project_type || 'General Inquiry'} - ${lead.form_name || 'Website'}</div>
          </div>
        </div>
      `;

      notification.onclick = () => {
        notification.remove();
        showPage('leads');
        setTimeout(() => viewLead(lead.id), 100);
      };

      document.body.appendChild(notification);

      // Auto-dismiss after 10 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }
      }, 10000);

      // Play notification sound if available
      try {
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleGw+AGql1O3NpFg+H1qfzunXuWBOQFaVx+PiyHxqV06Ow9fex4ZeUU2EudLYu4FbTEJ3q8jMsHhSTjtvob/CpWtMSWijt764hW9VWmqjwM26i3taYnamu8jIl4RramKYtcPJoJCHf3pijaS0t6OXkYqAdXWInaCmo5qTi4J4');
        audio.volume = 0.3;
        audio.play().catch(() => {});
      } catch (e) {}
    }

    let isLoadingLeads = false;
    async function loadLeads() {
      if (isLoadingLeads) return;
      isLoadingLeads = true;
      try {
        const { data, error } = await supabaseClient
          .from('leads')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        allLeads = data || [];
        updateStats();
        renderLeads();
      } catch (err) {
        console.error('[Leads] Error loading leads:', err);
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <h3>Error loading leads</h3>
            <p>${escapeHtml(err.message || 'Unknown error')}</p>
          </div>
        `;
      } finally {
        isLoadingLeads = false;
      }
    }

    function updateStats() {
      // Exclude archived leads from main stats
      const activeLeads = allLeads.filter(l => l.status !== 'archived');
      const archivedCount = allLeads.filter(l => l.status === 'archived').length;

      const stats = {
        total: activeLeads.length,
        new: activeLeads.filter(l => l.status === 'new').length,
        contacted: activeLeads.filter(l => l.status === 'contacted').length,
        won: activeLeads.filter(l => l.status === 'won').length,
        archived: archivedCount
      };

      console.log('[Stats] updateStats called, stats:', stats);

      // Update stat elements if they exist (with null checks)
      const statTotal = document.getElementById('stat-total');
      const statNew = document.getElementById('stat-new');
      const statContacted = document.getElementById('stat-contacted');
      const statWon = document.getElementById('stat-won');

      console.log('[Stats] Elements found:', { statTotal: !!statTotal, statNew: !!statNew });

      if (statTotal) statTotal.textContent = stats.total;
      if (statNew) statNew.textContent = stats.new;
      if (statContacted) statContacted.textContent = stats.contacted;
      if (statWon) statWon.textContent = stats.won;

      const leadsCountEl = document.getElementById('leads-count');
      if (leadsCountEl) {
        leadsCountEl.textContent = stats.new;
        leadsCountEl.setAttribute('data-count', stats.new);
        leadsCountEl.style.display = stats.new > 0 ? '' : 'none';
      }
    }

    // Set leads view mode
    function setLeadsView(view) {
      currentLeadsView = view;
      // Update button styles
      ['grid', 'list', 'kanban'].forEach(v => {
        const btn = document.getElementById(`leads-view-${v}`);
        if (btn) {
          if (v === view) {
            btn.style.background = 'var(--gold-primary)';
            btn.style.color = 'var(--dark-primary)';
          } else {
            btn.style.background = 'transparent';
            btn.style.color = 'var(--text-secondary)';
          }
        }
      });
      renderLeads();
    }

    function renderLeads() {
      const searchTerm = document.getElementById('leads-search')?.value.toLowerCase() || '';

      let filtered = allLeads;

      // Filter out archived leads unless showArchivedLeads is true or filtering by archived
      if (!showArchivedLeads && currentFilter !== 'archived') {
        filtered = filtered.filter(l => l.status !== 'archived');
      }

      if (currentFilter !== 'all') {
        filtered = filtered.filter(l => l.status === currentFilter);
      }

      if (searchTerm) {
        filtered = filtered.filter(l =>
          (l.full_name || l.homeowner_name || l.name || '').toLowerCase().includes(searchTerm) ||
          (l.email || l.homeowner_email || '').toLowerCase().includes(searchTerm) ||
          (l.phone || l.homeowner_phone || '').toLowerCase().includes(searchTerm)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('leads-table').innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <h3>No leads found</h3>
            <p>${currentFilter !== 'all' ? 'No leads with this status.' : 'Leads from your website forms will appear here.'}</p>
          </div>
        `;
        return;
      }

      // Render based on current view
      if (currentLeadsView === 'list') {
        renderLeadsListView(filtered);
      } else if (currentLeadsView === 'kanban') {
        renderLeadsKanbanView(filtered);
      } else {
        renderLeadsGridView(filtered);
      }
    }

    function renderLeadsGridView(filtered) {
      const statusIcons = {
        new: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
        contacted: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>',
        qualified: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
        quoted: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        won: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>',
        lost: '<svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>'
      };

      document.getElementById('leads-table').innerHTML = `
        <div class="leads-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 16px;">
          ${filtered.map(lead => {
            const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';
            const leadEmail = lead.email || lead.homeowner_email || '';
            const leadPhone = lead.phone || lead.homeowner_phone || '';
            const hasAppointment = lead.appointment_date && lead.appointment_time;
            const statusColor = getStatusColor(lead.status);
            return `
            <div class="lead-card" onclick="viewLead('${lead.id}')"
                 style="background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 18px; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden;"
                 onmouseover="this.style.borderColor='${statusColor}'; this.style.boxShadow='0 4px 20px rgba(0,0,0,0.3)'"
                 onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.boxShadow='none'">
              <div style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: ${statusColor};"></div>
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-size: 17px; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(leadName)}</div>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${formatDate(lead.created_at)} ${lead.source ? '· ' + escapeHtml(lead.source) : ''}</div>
                </div>
                <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; background: ${statusColor}25; color: ${statusColor}; text-transform: uppercase; letter-spacing: 0.5px;">
                  ${statusIcons[lead.status] || ''} ${lead.status}
                </span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px;">
                ${leadPhone ? `<div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="opacity: 0.7;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg><span>${escapeHtml(leadPhone)}</span></div>` : ''}
                ${leadEmail ? `<div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="opacity: 0.7;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(leadEmail)}</span></div>` : ''}
              </div>
              ${lead.project_type ? `<div style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; padding: 6px 10px; background: var(--dark-surface); border-radius: 6px; color: var(--text-secondary); margin-bottom: 14px;"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>${escapeHtml(lead.project_type)}</div>` : ''}
              ${hasAppointment ? `<div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 12px; margin-bottom: 12px;"><div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;"><svg width="16" height="16" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg><span style="font-size: 12px; font-weight: 600; color: #10b981; text-transform: uppercase;">Scheduled</span></div><div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${lead.appointment_date}</div><div style="font-size: 13px; color: var(--text-secondary);">at ${lead.appointment_time}</div></div>` : `<button onclick="event.stopPropagation(); openScheduleLeadModal('${lead.id}')" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 16px; background: linear-gradient(135deg, var(--gold-primary) 0%, var(--gold-dark) 100%); border: none; border-radius: 8px; color: var(--dark-primary); font-size: 13px; font-weight: 600; cursor: pointer; margin-bottom: 12px;"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>Schedule Appointment</button>`}
              <!-- Primary Actions Row -->
              <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                <button onclick="event.stopPropagation(); startEstimateFromLead('${lead.id}')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: linear-gradient(135deg, #22c55e, #16a34a); border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 600; cursor: pointer;" title="Create Estimate">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Estimate
                </button>
                <button onclick="event.stopPropagation(); startInvoiceFromLead('${lead.id}')" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 10px; background: linear-gradient(135deg, #f9cb00, #cca600); border: none; border-radius: 8px; color: #1a1a2e; font-size: 13px; font-weight: 600; cursor: pointer;" title="Create Invoice">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                  Invoice
                </button>
              </div>
              <!-- Inline Status Selector -->
              <div style="margin-bottom: 10px;" onclick="event.stopPropagation();">
                <select onchange="inlineUpdateLeadStatus('${lead.id}', this.value)" style="width: 100%; padding: 8px 12px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 13px; cursor: pointer;">
                  <option value="new" ${lead.status === 'new' ? 'selected' : ''}>New</option>
                  <option value="contacted" ${lead.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                  <option value="qualified" ${lead.status === 'qualified' ? 'selected' : ''}>Qualified</option>
                  <option value="quoted" ${lead.status === 'quoted' ? 'selected' : ''}>Quoted</option>
                  <option value="won" ${lead.status === 'won' ? 'selected' : ''}>Won</option>
                  <option value="lost" ${lead.status === 'lost' ? 'selected' : ''}>Lost</option>
                </select>
              </div>
              <div class="lead-quick-actions">
                ${leadPhone ? `<button onclick="event.stopPropagation(); window.location.href='tel:${encodeURIComponent(leadPhone)}'" class="btn-action call" title="Call"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>Call</button>` : ''}
                ${leadEmail ? `<button onclick="event.stopPropagation(); openLeadEmailModal('${lead.id}')" class="btn-action email" title="Email"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>Email</button>` : ''}
                <button onclick="event.stopPropagation(); convertLeadToProject('${lead.id}')" class="btn-action project" title="Convert to Project"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>Project</button>
                <button onclick="event.stopPropagation(); quickArchiveLead('${lead.id}')" class="btn-action archive" title="${lead.status === 'archived' ? 'Restore' : 'Archive'}"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/></svg>${lead.status === 'archived' ? 'Restore' : 'Archive'}</button>
                <button onclick="event.stopPropagation(); quickDeleteLead('${lead.id}')" class="btn-action delete" title="Delete"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>Delete</button>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function renderLeadsListView(filtered) {
      document.getElementById('leads-table').innerHTML = `
        <div class="leads-list" style="display: flex; flex-direction: column; gap: 8px;">
          <div style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 120px; gap: 16px; padding: 12px 16px; background: var(--dark-surface); border-radius: 8px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
            <span>Name</span>
            <span>Contact</span>
            <span>Project</span>
            <span>Status</span>
            <span>Actions</span>
          </div>
          ${filtered.map(lead => {
            const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';
            const leadEmail = lead.email || lead.homeowner_email || '';
            const leadPhone = lead.phone || lead.homeowner_phone || '';
            const statusColor = getStatusColor(lead.status);
            return `
            <div class="lead-list-row" onclick="viewLead('${lead.id}')"
                 style="display: grid; grid-template-columns: 2fr 1.5fr 1fr 1fr 120px; gap: 16px; padding: 16px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 10px; cursor: pointer; align-items: center; transition: all 0.2s;"
                 onmouseover="this.style.borderColor='${statusColor}'; this.style.background='var(--dark-surface)'"
                 onmouseout="this.style.borderColor='var(--border-subtle)'; this.style.background='var(--dark-elevated)'">
              <div>
                <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 2px;">${escapeHtml(leadName)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${formatDate(lead.created_at)} ${lead.source ? '· ' + escapeHtml(lead.source) : ''}</div>
              </div>
              <div style="font-size: 13px;">
                ${leadPhone ? `<div style="color: var(--text-secondary); margin-bottom: 2px;">${escapeHtml(leadPhone)}</div>` : ''}
                ${leadEmail ? `<div style="color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(leadEmail)}</div>` : ''}
              </div>
              <div style="font-size: 13px; color: var(--text-secondary);">${lead.project_type ? escapeHtml(lead.project_type) : '-'}</div>
              <div>
                <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 6px; background: ${statusColor}25; color: ${statusColor}; text-transform: uppercase;">${lead.status}</span>
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap;" onclick="event.stopPropagation()">
                ${leadPhone ? `<button onclick="window.location.href='tel:${encodeURIComponent(leadPhone)}'" style="padding: 6px 10px; background: rgba(34, 197, 94, 0.15); border: none; border-radius: 6px; color: #22c55e; cursor: pointer; font-size: 12px;">Call</button>` : ''}
                ${leadEmail ? `<button onclick="openLeadEmailModal('${lead.id}')" style="padding: 6px 10px; background: rgba(59, 130, 246, 0.15); border: none; border-radius: 6px; color: #3b82f6; cursor: pointer; font-size: 12px;">Email</button>` : ''}
                <button onclick="quickArchiveLead('${lead.id}')" style="padding: 6px 10px; background: rgba(107, 114, 128, 0.15); border: none; border-radius: 6px; color: #9ca3af; cursor: pointer; font-size: 12px;" title="${lead.status === 'archived' ? 'Restore' : 'Archive'}">${lead.status === 'archived' ? '↩' : '📦'}</button>
                <button onclick="quickDeleteLead('${lead.id}')" style="padding: 6px 10px; background: rgba(239, 68, 68, 0.15); border: none; border-radius: 6px; color: #ef4444; cursor: pointer; font-size: 12px;" title="Delete">🗑</button>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function renderLeadsKanbanView(filtered) {
      const statuses = ['new', 'contacted', 'qualified', 'quoted', 'won', 'lost'];
      const statusLabels = { new: 'New', contacted: 'Contacted', qualified: 'Qualified', quoted: 'Quoted', won: 'Won', lost: 'Lost', archived: 'Archived' };
      const grouped = {};
      statuses.forEach(s => grouped[s] = []);
      filtered.forEach(lead => {
        if (grouped[lead.status]) grouped[lead.status].push(lead);
        else grouped['new'].push(lead);
      });

      document.getElementById('leads-table').innerHTML = `
        <div class="leads-kanban" style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 16px; min-height: 500px;">
          ${statuses.map(status => {
            const statusColor = getStatusColor(status);
            const leads = grouped[status];
            return `
            <div class="kanban-column" style="min-width: 280px; flex: 1; background: var(--dark-elevated); border-radius: 12px; padding: 16px; display: flex; flex-direction: column;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid ${statusColor};">
                <span style="font-weight: 600; color: ${statusColor};">${statusLabels[status]}</span>
                <span style="background: ${statusColor}25; color: ${statusColor}; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${leads.length}</span>
              </div>
              <div style="display: flex; flex-direction: column; gap: 12px; flex: 1; overflow-y: auto;">
                ${leads.length === 0 ? `<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">No leads</div>` : leads.map(lead => {
                  const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';
                  const leadEmail = lead.email || lead.homeowner_email || '';
                  const leadPhone = lead.phone || lead.homeowner_phone || '';
                  return `
                  <div onclick="viewLead('${lead.id}')" style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='${statusColor}'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 6px; font-size: 14px;">${escapeHtml(leadName)}</div>
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">${formatDate(lead.created_at)}</div>
                    ${lead.project_type ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">${escapeHtml(lead.project_type)}</div>` : ''}
                    <div style="display: flex; gap: 6px; margin-top: 10px;" onclick="event.stopPropagation()">
                      ${leadPhone ? `<button onclick="window.location.href='tel:${encodeURIComponent(leadPhone)}'" style="flex: 1; padding: 6px; background: rgba(34, 197, 94, 0.15); border: none; border-radius: 6px; color: #22c55e; cursor: pointer; font-size: 11px;">Call</button>` : ''}
                      ${leadEmail ? `<button onclick="openLeadEmailModal('${lead.id}')" style="flex: 1; padding: 6px; background: rgba(59, 130, 246, 0.15); border: none; border-radius: 6px; color: #3b82f6; cursor: pointer; font-size: 11px;">Email</button>` : ''}
                      <button onclick="quickArchiveLead('${lead.id}')" style="padding: 6px 8px; background: rgba(107, 114, 128, 0.15); border: none; border-radius: 6px; color: #9ca3af; cursor: pointer; font-size: 11px;" title="Archive">📦</button>
                      <button onclick="quickDeleteLead('${lead.id}')" style="padding: 6px 8px; background: rgba(239, 68, 68, 0.15); border: none; border-radius: 6px; color: #ef4444; cursor: pointer; font-size: 11px;" title="Delete">🗑</button>
                    </div>
                  </div>
                `}).join('')}
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    // Helper: Get color for status
    function getStatusColor(status) {
      const colors = {
        // Lead statuses
        new: '#f9cb00',
        contacted: '#3b82f6',
        qualified: '#8b5cf6',
        quoted: '#06b6d4',
        won: '#22c55e',
        lost: '#ef4444',
        archived: '#6b7280',
        // Project statuses
        lead: '#f59e0b',
        approved: '#22c55e',
        scheduled: '#8b5cf6',
        in_progress: '#06b6d4',
        completed: '#22c55e',
        on_hold: '#ef4444',
        cancelled: '#6b7280',
        // Invoice/Estimate statuses
        draft: '#6b7280',
        sent: '#3b82f6',
        paid: '#22c55e',
        overdue: '#ef4444',
        rejected: '#ef4444',
        void: '#6b7280',
        // En route statuses
        en_route: '#f59e0b',
        arrived: '#22c55e',
        on_site: '#22c55e'
      };
      return colors[status] || '#6b7280';
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'Unknown';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        if (hours === 0) return 'Just now';
        return `${hours}h ago`;
      } else if (days === 1) return 'Yesterday';
      else if (days < 7) return `${days}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function openLeadModal(id) { viewLead(id); }

    // Open professional email modal for leads
    function openLeadEmailModal(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Customer';
      const leadEmail = lead.email || lead.homeowner_email || '';
      const firstName = leadName.split(' ')[0];

      if (!leadEmail) {
        showToast('No email address for this lead', 'error');
        return;
      }

      // Professional email templates
      const templates = [
        {
          name: 'Initial Follow-up',
          subject: `Thank you for your interest - ${lead.project_type || 'Your Project'}`,
          body: `Hi ${firstName},\n\nThank you for reaching out to Surprise Granite! I wanted to personally follow up on your inquiry about ${lead.project_type || 'your project'}.\n\nWe specialize in beautiful, high-quality countertops and would love to help bring your vision to life. Would you be available for a quick call or an in-home consultation?\n\nPlease let me know what times work best for you, or feel free to call us directly.\n\nBest regards,\nThe Surprise Granite Team`
        },
        {
          name: 'Schedule Appointment',
          subject: 'Let\'s Schedule Your Free Consultation',
          body: `Hi ${firstName},\n\nI hope this message finds you well! I wanted to reach out about scheduling your free in-home consultation for ${lead.project_type || 'your countertop project'}.\n\nDuring the consultation, we'll:\n- Take precise measurements\n- Show you material samples\n- Provide a detailed quote\n\nThe entire process takes about 30-45 minutes. What day and time works best for you?\n\nLooking forward to meeting you!\n\nBest regards,\nThe Surprise Granite Team`
        },
        {
          name: 'Quote Follow-up',
          subject: 'Following Up on Your Quote',
          body: `Hi ${firstName},\n\nI wanted to follow up on the quote we provided for your ${lead.project_type || 'countertop project'}.\n\nDo you have any questions about the materials, pricing, or installation process? I'm happy to go over everything with you.\n\nIf you're ready to move forward, just let me know and we can get you scheduled!\n\nBest regards,\nThe Surprise Granite Team`
        },
        {
          name: 'Custom Message',
          subject: '',
          body: `Hi ${firstName},\n\n\n\nBest regards,\nThe Surprise Granite Team`
        }
      ];

      // Create modal
      const existing = document.getElementById('lead-email-modal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'lead-email-modal';
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="modal compose-modal" style="max-width: 600px;">
          <div class="modal-header">
            <h2>Send Email to ${escapeHtml(leadName)}</h2>
            <button class="modal-close" onclick="document.getElementById('lead-email-modal').remove()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" style="padding: 20px;">
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">To</label>
              <div style="padding: 12px 16px; background: var(--dark-surface); border-radius: 8px; color: var(--text-primary);">${escapeHtml(leadEmail)}</div>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Template</label>
              <select id="lead-email-template" onchange="applyLeadEmailTemplate()" style="width: 100%; padding: 12px 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
                ${templates.map((t, i) => `<option value="${i}">${t.name}</option>`).join('')}
              </select>
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Subject</label>
              <input type="text" id="lead-email-subject" value="${escapeHtml(templates[0].subject)}" style="width: 100%; padding: 12px 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
            </div>
            <div style="margin-bottom: 16px;">
              <label style="display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase;">Message</label>
              <textarea id="lead-email-body" rows="10" style="width: 100%; padding: 12px 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical; line-height: 1.5;">${escapeHtml(templates[0].body)}</textarea>
            </div>
          </div>
          <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border-subtle);">
            <button onclick="document.getElementById('lead-email-modal').remove()" class="btn-modern secondary">Cancel</button>
            <button onclick="sendLeadEmail('${leadId}')" class="btn-modern primary" id="send-lead-email-btn">
              <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              Send Email
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Store templates for template switching
      window.leadEmailTemplates = templates;
    }

    function applyLeadEmailTemplate() {
      const select = document.getElementById('lead-email-template');
      const idx = parseInt(select.value);
      const template = window.leadEmailTemplates[idx];
      if (template) {
        document.getElementById('lead-email-subject').value = template.subject;
        document.getElementById('lead-email-body').value = template.body;
      }
    }

    async function sendLeadEmail(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const leadEmail = lead.email || lead.homeowner_email || '';
      const subject = document.getElementById('lead-email-subject').value;
      const body = document.getElementById('lead-email-body').value;

      if (!subject.trim() || !body.trim()) {
        showToast('Please enter subject and message', 'error');
        return;
      }

      const btn = document.getElementById('send-lead-email-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Sending...';

      try {
        const response = await fetch('/api/email/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: leadEmail,
            subject: subject,
            body: body,
            lead_id: leadId
          })
        });

        const result = await response.json();

        if (result.success) {
          showToast('Email sent successfully!', 'success');
          document.getElementById('lead-email-modal').remove();

          // Update lead status to contacted if it was new
          if (lead.status === 'new') {
            await supabaseClient
              .from('leads')
              .update({ status: 'contacted', updated_at: new Date().toISOString() })
              .eq('id', leadId);
            loadLeads();
          }
        } else {
          throw new Error(result.error || 'Failed to send email');
        }
      } catch (err) {
        console.error('Email send error:', err);
        showToast('Failed to send email: ' + err.message, 'error');
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Send Email';
      }
    }

    // Quick Actions for Lead Cards
    function quickChangeLeadStatus(leadId, currentStatus) {
      const statuses = ['new', 'contacted', 'qualified', 'quoted', 'won', 'lost'];
      const statusLabels = { new: 'New', contacted: 'Contacted', qualified: 'Qualified', quoted: 'Quoted', won: 'Won', lost: 'Lost', archived: 'Archived' };

      // Create dropdown modal
      const modal = document.createElement('div');
      modal.id = 'quick-status-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; min-width: 240px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin: 0 0 16px; font-size: 14px; color: var(--text-primary);">Change Lead Status</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${statuses.map(s => `
              <button onclick="setLeadStatusQuick('${leadId}', '${s}')"
                      style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: ${s === currentStatus ? 'var(--gold-primary)20' : 'var(--dark-elevated)'}; border: 1px solid ${s === currentStatus ? 'var(--gold-primary)' : 'var(--border-subtle)'}; border-radius: 8px; cursor: pointer; transition: all 0.15s; color: ${s === currentStatus ? 'var(--gold-primary)' : 'var(--text-secondary)'};"
                      onmouseover="this.style.borderColor='var(--gold-primary)'"
                      onmouseout="this.style.borderColor='${s === currentStatus ? 'var(--gold-primary)' : 'var(--border-subtle)'}'"
              >
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${getStatusColor(s)};"></span>
                <span style="font-weight: 500;">${statusLabels[s]}</span>
                ${s === currentStatus ? '<span style="margin-left: auto; font-size: 11px;">Current</span>' : ''}
              </button>
            `).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function setLeadStatusQuick(leadId, newStatus) {
      document.getElementById('quick-status-modal')?.remove();

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', leadId);

        if (error) throw error;

        // Update local data
        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.status = newStatus;

        renderLeads();
        showToast(`Lead status changed to ${newStatus}`, 'success');
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    // Inline status update from dropdown - no modal needed
    async function inlineUpdateLeadStatus(leadId, newStatus) {
      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', leadId);

        if (error) throw error;

        // Update local data
        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.status = newStatus;

        // Update stats without full re-render to keep dropdown state
        updateStats();
        showToast(`Status → ${newStatus}`, 'success');
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    async function convertLeadToProject(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Unknown';

      if (!confirm(`Convert "${leadName}" to a project?`)) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Create project from lead data
        const projectData = {
          user_id: user.id,
          name: `${leadName} - ${lead.project_type || 'Project'}`,
          customer_name: leadName,
          customer_email: lead.email || lead.homeowner_email || null,
          customer_phone: lead.phone || lead.homeowner_phone || null,
          address: lead.project_address || lead.address || null,
          description: lead.message || lead.project_details || null,
          status: 'lead',
          priority: 'medium',
          lead_id: leadId
        };

        const { data: project, error } = await supabaseClient
          .from('projects')
          .insert(projectData)
          .select()
          .single();

        if (error) throw error;

        // Update lead status to won
        await supabaseClient
          .from('leads')
          .update({ status: 'won', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        // Update local lead
        if (lead) lead.status = 'won';

        showToast('Project created successfully!', 'success');
        renderLeads();

        // Optionally navigate to projects page
        if (confirm('View the new project?')) {
          showPage('projects');
          await loadProjects();
          setTimeout(() => openProjectDetail(project.id), 500);
        }

      } catch (err) {
        console.error('Error converting lead:', err);
        showToast('Failed to convert lead: ' + err.message, 'error');
      }
    }

    async function viewLead(id) {
      try {
      selectedLead = allLeads.find(function(l) { return l.id === id; });
      if (!selectedLead) return;

      // Open the new profile panel instead of old modal
      openProfilePanel(selectedLead, 'lead');
      return; // Skip old modal code

      var container = document.getElementById('lead-details');
      if (!container) { alert('Container not found'); return; }
      container.innerHTML = '';

      // Get values safely
      var name = String(selectedLead.full_name || selectedLead.homeowner_name || selectedLead.name || 'Unknown');
      var email = String(selectedLead.email || selectedLead.homeowner_email || '');
      var phone = String(selectedLead.phone || selectedLead.homeowner_phone || '');
      var address = String(selectedLead.project_address || selectedLead.address || '');
      var zip = String(selectedLead.project_zip || '');
      var project = String(selectedLead.project_type || 'Not specified');
      var msg = String(selectedLead.message || selectedLead.project_details || '');
      var source = String(selectedLead.source || 'Website');
      var apptDate = selectedLead.appointment_date || '';
      var apptTime = selectedLead.appointment_time || '';

      // Appointment banner with actions
      if (apptDate && apptTime) {
        var apptStatus = selectedLead.appointment_status || 'scheduled';
        var statusColors = {scheduled:'#f59e0b',confirmed:'#10b981',completed:'#6366f1',cancelled:'#ef4444'};
        var statusColor = statusColors[apptStatus] || '#f59e0b';

        var apptDiv = document.createElement('div');
        apptDiv.style.cssText = 'background:rgba(245,158,11,0.15);border:2px solid '+statusColor+';border-radius:12px;padding:16px;margin-bottom:16px;';

        var apptHeader = document.createElement('div');
        apptHeader.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
        var apptTitle = document.createElement('div');
        apptTitle.style.cssText = 'color:'+statusColor+';font-weight:bold;font-size:14px;';
        apptTitle.textContent = 'APPOINTMENT ' + apptStatus.toUpperCase();
        var statusBadge = document.createElement('span');
        statusBadge.style.cssText = 'background:'+statusColor+';color:#fff;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;';
        statusBadge.textContent = apptStatus;
        apptHeader.appendChild(apptTitle);
        apptHeader.appendChild(statusBadge);
        apptDiv.appendChild(apptHeader);

        var apptDateTime = document.createElement('div');
        apptDateTime.style.cssText = 'font-size:18px;font-weight:bold;margin-top:8px;';
        apptDateTime.textContent = apptDate + ' at ' + apptTime;
        apptDiv.appendChild(apptDateTime);

        if (address) {
          var apptLoc = document.createElement('div');
          apptLoc.style.cssText = 'margin-top:4px;color:#999;';
          apptLoc.textContent = '📍 ' + address;
          apptDiv.appendChild(apptLoc);
        }

        // Action buttons
        var btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display:flex;gap:8px;margin-top:12px;';

        if (apptStatus === 'scheduled') {
          var confirmBtn = document.createElement('button');
          confirmBtn.style.cssText = 'flex:1;padding:10px;border:none;border-radius:8px;background:#10b981;color:#fff;font-weight:600;cursor:pointer;';
          confirmBtn.textContent = '✓ Confirm & Create Event';
          confirmBtn.onclick = function() { confirmAppointment(selectedLead.id); };
          btnContainer.appendChild(confirmBtn);
        }

        var rescheduleBtn = document.createElement('button');
        rescheduleBtn.style.cssText = 'flex:1;padding:10px;border:none;border-radius:8px;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;';
        rescheduleBtn.textContent = '📅 Reschedule';
        rescheduleBtn.onclick = function() { openRescheduleModal(selectedLead.id); };
        btnContainer.appendChild(rescheduleBtn);

        if (apptStatus !== 'cancelled') {
          var cancelBtn = document.createElement('button');
          cancelBtn.style.cssText = 'padding:10px 16px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-weight:600;cursor:pointer;';
          cancelBtn.textContent = '✕';
          cancelBtn.title = 'Cancel Appointment';
          cancelBtn.onclick = function() { cancelAppointment(selectedLead.id); };
          btnContainer.appendChild(cancelBtn);
        }

        apptDiv.appendChild(btnContainer);
        container.appendChild(apptDiv);
      }

      // Check if message contains appointment info - auto-create pending event
      if (!apptDate && msg && (msg.includes('APPOINTMENT') || msg.includes('Date:') || msg.includes('Time:'))) {
        var parsedDate = '', parsedTime = '', parsedAddress = '';

        var dateMatch = msg.match(/Date:\s*([^\n]+)/i);
        if (dateMatch) parsedDate = dateMatch[1].trim();

        var timeMatch = msg.match(/Time:\s*([^\n]+)/i);
        if (timeMatch) parsedTime = timeMatch[1].trim();

        var addrMatch = msg.match(/Address:\s*([^\n]+)/i);
        if (addrMatch) parsedAddress = addrMatch[1].trim();

        if (parsedDate || parsedTime) {
          selectedLead._parsedDate = parsedDate;
          selectedLead._parsedTime = parsedTime;
          selectedLead._parsedAddress = parsedAddress || address;

          // Auto-create calendar event as pending (runs in background)
          autoCreatePendingEvent(selectedLead.id, parsedDate, parsedTime, parsedAddress || address, name, email, phone, msg);

          // Show pending appointment banner
          var pendingDiv = document.createElement('div');
          pendingDiv.id = 'pending-appt-banner';
          pendingDiv.style.cssText = 'background:rgba(251,191,36,0.15);border:2px solid #fbbf24;border-radius:12px;padding:16px;margin-bottom:16px;';

          var headerDiv = document.createElement('div');
          headerDiv.style.cssText = 'display:flex;justify-content:space-between;align-items:center;';
          headerDiv.innerHTML = '<div style="color:#fbbf24;font-weight:bold;font-size:14px;">📅 APPOINTMENT REQUEST</div><span style="background:#fbbf24;color:#000;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;">PENDING</span>';
          pendingDiv.appendChild(headerDiv);

          var dateDiv = document.createElement('div');
          dateDiv.style.cssText = 'font-size:18px;font-weight:bold;margin-top:8px;';
          dateDiv.textContent = parsedDate || 'Date to be confirmed';
          pendingDiv.appendChild(dateDiv);

          var timeDiv = document.createElement('div');
          timeDiv.style.cssText = 'color:#ccc;margin-top:2px;';
          timeDiv.textContent = parsedTime || 'Time to be confirmed';
          pendingDiv.appendChild(timeDiv);

          if (parsedAddress) {
            var locDiv = document.createElement('div');
            locDiv.style.cssText = 'color:#999;margin-top:4px;';
            locDiv.textContent = '📍 ' + parsedAddress;
            pendingDiv.appendChild(locDiv);
          }

          var btnDiv = document.createElement('div');
          btnDiv.style.cssText = 'display:flex;gap:8px;margin-top:12px;';
          btnDiv.innerHTML = '<button onclick="confirmParsedAppointment(\'' + selectedLead.id + '\')" style="flex:1;padding:10px;border:none;border-radius:8px;background:#10b981;color:#fff;font-weight:600;cursor:pointer;">✓ Confirm</button>' +
            '<button onclick="openRescheduleModal(\'' + selectedLead.id + '\')" style="flex:1;padding:10px;border:none;border-radius:8px;background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;">📅 Reschedule</button>' +
            '<button onclick="declineAppointment(\'' + selectedLead.id + '\')" style="padding:10px 16px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-weight:600;cursor:pointer;">✕</button>';
          pendingDiv.appendChild(btnDiv);

          container.appendChild(pendingDiv);
        }
      }

      // Helper to create rows
      function addRow(label, value, linkHref) {
        var row = document.createElement('div');
        row.style.cssText = 'display:flex;padding:12px 0;border-bottom:1px solid #333;';
        var labelEl = document.createElement('div');
        labelEl.style.cssText = 'width:100px;color:#888;font-size:12px;text-transform:uppercase;flex-shrink:0;';
        labelEl.textContent = label;
        var valueEl = document.createElement('div');
        valueEl.style.cssText = 'flex:1;font-size:14px;word-break:break-word;';
        if (linkHref && value) {
          var a = document.createElement('a');
          a.href = linkHref;
          a.style.cssText = 'color:#f9cb00;text-decoration:none;';
          a.textContent = value;
          if (linkHref.startsWith('http')) a.target = '_blank';
          valueEl.appendChild(a);
        } else {
          valueEl.textContent = value || 'Not provided';
        }
        row.appendChild(labelEl);
        row.appendChild(valueEl);
        container.appendChild(row);
      }

      addRow('Name', name);
      addRow('Email', email, email ? 'mailto:' + email : null);
      addRow('Phone', phone, phone ? 'tel:' + phone : null);
      if (address) addRow('Address', address, 'https://maps.google.com/?q=' + encodeURIComponent(address));
      if (zip) addRow('ZIP', zip);
      addRow('Project', project);

      // Message row
      var msgRow = document.createElement('div');
      msgRow.style.cssText = 'display:flex;padding:12px 0;border-bottom:1px solid #333;align-items:flex-start;';
      var msgLabel = document.createElement('div');
      msgLabel.style.cssText = 'width:100px;color:#888;font-size:12px;text-transform:uppercase;flex-shrink:0;';
      msgLabel.textContent = 'Message';
      var msgValue = document.createElement('div');
      msgValue.style.cssText = 'flex:1;background:#1a1a2e;padding:12px;border-radius:8px;max-height:150px;overflow-y:auto;white-space:pre-wrap;font-size:13px;';
      msgValue.textContent = msg || 'No message';
      msgRow.appendChild(msgLabel);
      msgRow.appendChild(msgValue);
      container.appendChild(msgRow);

      addRow('Source', source);
      addRow('Submitted', selectedLead.created_at ? new Date(selectedLead.created_at).toLocaleString() : 'Unknown');

      // Load linked estimates
      const estimatesContainer = document.getElementById('lead-estimates-list');
      if (estimatesContainer) {
        estimatesContainer.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px;">Loading estimates...</div>';

        const { data: estimates } = await supabaseClient
          .from('estimates')
          .select('id, estimate_number, total, status, created_at')
          .eq('lead_id', selectedLead.id)
          .order('created_at', { ascending: false });

        if (estimates && estimates.length > 0) {
          estimatesContainer.innerHTML = estimates.map(est => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--dark-bg); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; font-size: 14px;">${est.estimate_number || 'Draft'}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${new Date(est.created_at).toLocaleDateString()}</div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600; color: var(--gold-primary);">$${(est.total || 0).toLocaleString()}</div>
                <span class="status-badge status-${est.status}" style="font-size: 11px;">${est.status}</span>
              </div>
            </div>
          `).join('');
        } else {
          estimatesContainer.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px; text-align: center;">No estimates yet</div>';
        }
      }

      // Load linked calendar events for this lead
      try {
        const { data: calendarEvents, error: calEventsError } = await supabaseClient
          .from('calendar_events')
          .select('id, title, event_type, start_time, end_time, status, location')
          .eq('lead_id', selectedLead.id)
          .order('start_time', { ascending: true });

        if (calEventsError) {
          console.warn('Calendar events query error:', calEventsError.message);
        }

        if (calendarEvents && calendarEvents.length > 0) {
          // Add calendar events section to detailsHtml
          const eventsHtml = calendarEvents.map(evt => {
            const startDate = new Date(evt.start_time);
            const statusColors = {
              'scheduled': '#f59e0b',
              'confirmed': '#10b981',
              'completed': '#6366f1',
              'cancelled': '#ef4444',
              'no_show': '#ef4444'
            };
            return `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--dark-bg); border-radius: 8px; margin-bottom: 8px; border-left: 3px solid ${statusColors[evt.status] || '#f59e0b'};">
                <div>
                  <div style="font-weight: 600; font-size: 13px;">${evt.title || evt.event_type}</div>
                  <div style="font-size: 12px; color: var(--text-muted);">${startDate.toLocaleDateString()} at ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                  ${evt.location ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">📍 ${evt.location}</div>` : ''}
                </div>
                <span style="background: ${statusColors[evt.status] || '#f59e0b'}; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: capitalize;">${evt.status}</span>
              </div>
            `;
          }).join('');

          // Insert calendar section before Messages section
          const detailsContainer = document.getElementById('lead-details');
          if (detailsContainer) {
            detailsContainer.insertAdjacentHTML('beforeend', `
              <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
                <div class="detail-section-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#f59e0b" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  <span style="color: #f59e0b;">Calendar Events</span>
                </div>
                ${eventsHtml}
              </div>
            `);
          }
        }
      } catch (calErr) {
        console.warn('Failed to load calendar events for lead:', calErr);
      }

      // Load messages for this lead
      loadLeadMessages(selectedLead.id);

      document.getElementById('lead-status-select').value = selectedLead.status || 'new';
      document.getElementById('lead-modal').classList.add('active');
      } catch(err) {
        console.error('viewLead error:', err);
        showToast('Error loading lead details', 'error');
      }
    }

    // Confirm appointment and create calendar event
    async function confirmAppointment(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead || !lead.appointment_date || !lead.appointment_time) {
        showToast('No appointment to confirm', 'error');
        return;
      }

      try {
        showToast('Creating calendar event...', 'info');

        // Parse date and time
        const dateStr = lead.appointment_date;
        const timeStr = lead.appointment_time;
        const [timePart, ampm] = timeStr.split(' ');
        let [hours, minutes] = timePart.split(':').map(Number);
        if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
        if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
        minutes = minutes || 0;

        const startTime = new Date(dateStr + 'T' + String(hours).padStart(2,'0') + ':' + String(minutes).padStart(2,'0') + ':00');
        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000); // 1 hour

        const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Customer';
        const leadEmail = lead.email || lead.homeowner_email || '';
        const leadPhone = lead.phone || lead.homeowner_phone || '';
        const leadAddress = lead.project_address || lead.address || '';

        // Create calendar event
        const { data: calEvent, error: calError } = await supabaseClient
          .from('calendar_events')
          .insert([{
            created_by: currentUser.id,
            title: 'Appointment: ' + leadName,
            description: 'Project: ' + (lead.project_type || 'Not specified') + '\nPhone: ' + leadPhone + '\nEmail: ' + leadEmail + '\n\nNotes: ' + (lead.message || lead.project_details || ''),
            event_type: 'appointment',
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: leadAddress,
            location_address: leadAddress,
            lead_id: leadId,
            status: 'confirmed',
            reminder_minutes: [1440, 60],
            color: '#10b981'
          }])
          .select()
          .single();

        if (calError) throw calError;

        // Add customer as participant
        if (calEvent) {
          await supabaseClient.from('calendar_event_participants').insert([{
            event_id: calEvent.id,
            email: leadEmail.toLowerCase(),
            name: leadName,
            phone: leadPhone,
            participant_type: 'attendee',
            response_status: 'accepted'
          }]);
        }

        // Update lead appointment status
        await supabaseClient
          .from('leads')
          .update({ appointment_status: 'confirmed', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        // Update local data
        lead.appointment_status = 'confirmed';

        showToast('Appointment confirmed! Calendar event created.', 'success');
        viewLead(leadId); // Refresh the modal

      } catch (err) {
        console.error('Confirm appointment error:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    // Open reschedule modal
    function openRescheduleModal(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const currentDate = lead.appointment_date || '';
      const currentTime = lead.appointment_time || '';

      const modal = document.createElement('div');
      modal.id = 'reschedule-modal';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:20000;';
      modal.innerHTML = `
        <div style="background:#1e1e2e;border-radius:16px;padding:24px;width:90%;max-width:400px;">
          <h3 style="margin:0 0 16px;font-size:18px;">Reschedule Appointment</h3>
          <p style="color:#888;margin-bottom:16px;">Current: ${currentDate} at ${currentTime}</p>
          <div style="margin-bottom:12px;">
            <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">NEW DATE</label>
            <input type="date" id="reschedule-date" value="${currentDate}" style="width:100%;padding:12px;background:#2a2a3e;border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;">
          </div>
          <div style="margin-bottom:16px;">
            <label style="display:block;color:#888;font-size:12px;margin-bottom:4px;">NEW TIME</label>
            <input type="time" id="reschedule-time" style="width:100%;padding:12px;background:#2a2a3e;border:1px solid #444;border-radius:8px;color:#fff;font-size:14px;">
          </div>
          <div style="display:flex;gap:8px;">
            <button onclick="document.getElementById('reschedule-modal').remove()" style="flex:1;padding:12px;border:1px solid #444;border-radius:8px;background:transparent;color:#fff;cursor:pointer;">Cancel</button>
            <button onclick="submitReschedule('${leadId}')" style="flex:1;padding:12px;border:none;border-radius:8px;background:#f9cb00;color:#000;font-weight:600;cursor:pointer;">Save & Update Event</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };
    }

    // Submit reschedule
    async function submitReschedule(leadId) {
      const newDate = document.getElementById('reschedule-date').value;
      const newTimeInput = document.getElementById('reschedule-time').value;
      if (!newDate || !newTimeInput) {
        showToast('Please select date and time', 'error');
        return;
      }

      // Convert 24h to 12h format for display
      const [h, m] = newTimeInput.split(':');
      const hour = parseInt(h);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      const newTime = hour12 + ':' + m + ' ' + ampm;

      try {
        // Update lead
        await supabaseClient
          .from('leads')
          .update({
            appointment_date: newDate,
            appointment_time: newTime,
            appointment_status: 'scheduled',
            updated_at: new Date().toISOString()
          })
          .eq('id', leadId);

        // Update any existing calendar events for this lead
        const startTime = new Date(newDate + 'T' + newTimeInput + ':00');
        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);

        await supabaseClient
          .from('calendar_events')
          .update({
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            status: 'scheduled'
          })
          .eq('lead_id', leadId);

        // Update local data
        const lead = allLeads.find(l => l.id === leadId);
        if (lead) {
          lead.appointment_date = newDate;
          lead.appointment_time = newTime;
          lead.appointment_status = 'scheduled';
        }

        document.getElementById('reschedule-modal').remove();
        showToast('Appointment rescheduled!', 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Reschedule error:', err);
        showToast('Failed to reschedule: ' + err.message, 'error');
      }
    }

    // Cancel appointment
    async function cancelAppointment(leadId) {
      if (!confirm('Cancel this appointment?')) return;

      try {
        await supabaseClient
          .from('leads')
          .update({ appointment_status: 'cancelled', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        await supabaseClient
          .from('calendar_events')
          .update({ status: 'cancelled' })
          .eq('lead_id', leadId);

        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.appointment_status = 'cancelled';

        showToast('Appointment cancelled', 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Cancel error:', err);
        showToast('Failed to cancel: ' + err.message, 'error');
      }
    }

    // Create event from parsed message data
    async function createEventFromMessage(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const parsedDate = lead._parsedDate || '';
      const parsedTime = lead._parsedTime || '';
      const parsedAddress = lead._parsedAddress || lead.project_address || lead.address || '';

      if (!parsedDate) {
        showToast('Could not parse date from message', 'error');
        return;
      }

      try {
        showToast('Creating calendar event...', 'info');

        // Parse the date string (e.g., "Wednesday, February 4, 2026")
        let startTime;
        try {
          // Try to parse natural date
          const dateStr = parsedDate.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, '');
          startTime = new Date(dateStr);
          if (isNaN(startTime.getTime())) {
            startTime = new Date(parsedDate);
          }
        } catch (e) {
          startTime = new Date(parsedDate);
        }

        // Parse time (e.g., "3:00 PM")
        if (parsedTime) {
          const timeMatch = parsedTime.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
          if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]) || 0;
            const ampm = timeMatch[3];
            if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
            startTime.setHours(hours, minutes, 0, 0);
          }
        }

        if (isNaN(startTime.getTime())) {
          showToast('Could not parse date/time. Please schedule manually.', 'error');
          return;
        }

        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
        const leadName = lead.full_name || lead.homeowner_name || lead.name || 'Customer';
        const leadEmail = lead.email || lead.homeowner_email || '';
        const leadPhone = lead.phone || lead.homeowner_phone || '';

        // Create calendar event
        const { data: calEvent, error: calError } = await supabaseClient
          .from('calendar_events')
          .insert([{
            created_by: currentUser.id,
            title: 'Appointment: ' + leadName,
            description: 'Project: ' + (lead.project_type || 'Countertops') + '\nPhone: ' + leadPhone + '\nEmail: ' + leadEmail + '\n\n' + (lead.message || lead.project_details || ''),
            event_type: 'appointment',
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: parsedAddress,
            location_address: parsedAddress,
            lead_id: leadId,
            status: 'confirmed',
            reminder_minutes: [1440, 60],
            color: '#10b981'
          }])
          .select()
          .single();

        if (calError) throw calError;

        // Add customer as participant
        if (calEvent && leadEmail) {
          await supabaseClient.from('calendar_event_participants').insert([{
            event_id: calEvent.id,
            email: leadEmail.toLowerCase(),
            name: leadName,
            phone: leadPhone,
            participant_type: 'attendee',
            response_status: 'accepted'
          }]);
        }

        // Update lead with parsed appointment data
        const isoDate = startTime.toISOString().split('T')[0];
        const hours12 = startTime.getHours() % 12 || 12;
        const ampm = startTime.getHours() >= 12 ? 'PM' : 'AM';
        const formattedTime = hours12 + ':' + String(startTime.getMinutes()).padStart(2, '0') + ' ' + ampm;

        await supabaseClient
          .from('leads')
          .update({
            appointment_date: isoDate,
            appointment_time: formattedTime,
            appointment_status: 'confirmed',
            project_address: parsedAddress || lead.project_address,
            updated_at: new Date().toISOString()
          })
          .eq('id', leadId);

        // Update local data
        lead.appointment_date = isoDate;
        lead.appointment_time = formattedTime;
        lead.appointment_status = 'confirmed';
        if (parsedAddress) lead.project_address = parsedAddress;

        showToast('Calendar event created for ' + startTime.toLocaleDateString() + ' at ' + formattedTime, 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Create event error:', err);
        showToast('Failed to create event: ' + err.message, 'error');
      }
    }

    // Auto-create pending calendar event in background
    async function autoCreatePendingEvent(leadId, parsedDate, parsedTime, address, name, email, phone, message) {
      try {
        console.log('[AutoCreate] Starting for lead:', leadId, 'date:', parsedDate, 'time:', parsedTime);

        // Must have currentUser
        if (!currentUser || !currentUser.id) {
          console.warn('[AutoCreate] No currentUser, cannot create event');
          return;
        }

        // Check if event already exists for this lead
        const { data: existing, error: checkError } = await supabaseClient
          .from('calendar_events')
          .select('id')
          .eq('lead_id', leadId)
          .limit(1);

        if (checkError) {
          console.warn('[AutoCreate] Check existing error:', checkError.message);
        }

        if (existing && existing.length > 0) {
          console.log('[AutoCreate] Event already exists for lead', leadId);
          return;
        }

        // Parse date - try multiple formats
        let startTime = null;
        const dateFormats = [
          parsedDate,
          parsedDate.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, ''),
          parsedDate.replace(/(\d+)(st|nd|rd|th)/gi, '$1') // Remove ordinals
        ];

        for (const fmt of dateFormats) {
          const d = new Date(fmt);
          if (!isNaN(d.getTime())) {
            startTime = d;
            break;
          }
        }

        if (!startTime) {
          console.warn('[AutoCreate] Could not parse date:', parsedDate);
          return;
        }

        // Parse time
        if (parsedTime) {
          const timeMatch = parsedTime.match(/(\d{1,2}):?(\d{2})?\s*(AM|PM)?/i);
          if (timeMatch) {
            let hours = parseInt(timeMatch[1]);
            const minutes = parseInt(timeMatch[2]) || 0;
            const ampm = timeMatch[3];
            if (ampm && ampm.toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (ampm && ampm.toUpperCase() === 'AM' && hours === 12) hours = 0;
            startTime.setHours(hours, minutes, 0, 0);
            console.log('[AutoCreate] Parsed time:', hours + ':' + minutes);
          }
        } else {
          // Default to 9 AM if no time specified
          startTime.setHours(9, 0, 0, 0);
        }

        const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
        console.log('[AutoCreate] Creating event:', startTime.toISOString(), 'to', endTime.toISOString());

        // Create scheduled event
        const { data: newEvent, error } = await supabaseClient
          .from('calendar_events')
          .insert([{
            created_by: currentUser.id,
            title: 'Appointment: ' + name,
            description: 'Phone: ' + (phone || 'N/A') + '\nEmail: ' + (email || 'N/A') + '\n\n' + (message || ''),
            event_type: 'appointment',
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: address || null,
            location_address: address || null,
            lead_id: leadId,
            status: 'scheduled',
            color: '#fbbf24'
          }])
          .select()
          .single();

        if (error) {
          console.error('[AutoCreate] Insert error:', error.message, error.details, error.hint);
        } else {
          console.log('[AutoCreate] SUCCESS - Event created:', newEvent?.id);
          // Refresh calendar events
          if (typeof loadAllCalendarEvents === 'function') {
            loadAllCalendarEvents();
          }
        }

      } catch (err) {
        console.error('[AutoCreate] Exception:', err);
      }
    }

    // Confirm parsed appointment
    async function confirmParsedAppointment(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      try {
        showToast('Confirming appointment...', 'info');

        // Update calendar event status
        await supabaseClient
          .from('calendar_events')
          .update({ status: 'confirmed', color: '#10b981' })
          .eq('lead_id', leadId);

        // Update lead
        const parsedDate = lead._parsedDate || '';
        const parsedTime = lead._parsedTime || '';
        const parsedAddr = lead._parsedAddress || '';

        // Try to format date for storage
        let isoDate = '';
        try {
          const dateStr = parsedDate.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, '');
          const d = new Date(dateStr);
          if (!isNaN(d.getTime())) isoDate = d.toISOString().split('T')[0];
        } catch (e) {}

        await supabaseClient
          .from('leads')
          .update({
            appointment_date: isoDate,
            appointment_time: parsedTime,
            appointment_status: 'confirmed',
            project_address: parsedAddr || lead.project_address,
            updated_at: new Date().toISOString()
          })
          .eq('id', leadId);

        lead.appointment_date = isoDate;
        lead.appointment_time = parsedTime;
        lead.appointment_status = 'confirmed';

        // Close modal, reload calendar, show toast
        closeLeadModal();
        showPage('calendar');
        // Force reload calendar events (sequentially to avoid race condition)
        setTimeout(async function() {
          if (typeof loadCalendarEvents === 'function') await loadCalendarEvents();
          if (typeof loadAllCalendarEvents === 'function') await loadAllCalendarEvents();
          console.log('[Calendar] Events reloaded after confirmation, total:', calendarEvents.length);
        }, 100);
        showToast('✓ Appointment confirmed - ' + (lead._parsedDate || 'Date set'), 'success');

      } catch (err) {
        console.error('Confirm error:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    // Decline appointment
    async function declineAppointment(leadId) {
      if (!confirm('Decline this appointment request?')) return;

      try {
        await supabaseClient
          .from('calendar_events')
          .update({ status: 'cancelled', color: '#ef4444' })
          .eq('lead_id', leadId);

        await supabaseClient
          .from('leads')
          .update({ appointment_status: 'cancelled', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        const lead = allLeads.find(l => l.id === leadId);
        if (lead) lead.appointment_status = 'cancelled';

        showToast('Appointment declined', 'success');
        viewLead(leadId);

      } catch (err) {
        console.error('Decline error:', err);
        showToast('Failed to decline: ' + err.message, 'error');
      }
    }

    async function loadLeadMessages(leadId) {
      const container = document.getElementById('lead-messages-list');
      const badge = document.getElementById('lead-unread-badge');

      if (!container) return;

      container.innerHTML = '<div style="padding: 10px; color: var(--text-muted); font-size: 12px; text-align: center;">Loading messages...</div>';

      try {
        const { data: messages } = await supabaseClient
          .from('customer_messages')
          .select('*')
          .eq('lead_id', leadId)
          .order('created_at', { ascending: true });

        if (!messages || messages.length === 0) {
          container.innerHTML = '<div style="padding: 16px; color: var(--text-muted); font-size: 13px; text-align: center;">No messages yet. Comments from design shares will appear here.</div>';
          if (badge) badge.style.display = 'none';
          return;
        }

        // Count unread inbound messages
        const unread = messages.filter(m => m.direction === 'inbound' && m.status !== 'read').length;
        if (badge) {
          if (unread > 0) {
            badge.textContent = `${unread} new`;
            badge.style.display = 'inline';
          } else {
            badge.style.display = 'none';
          }
        }

        container.innerHTML = messages.map(msg => {
          const isInbound = msg.direction === 'inbound';
          const channelIcon = msg.channel === 'design_share' ? '🎨' : (msg.channel === 'sms' ? '📱' : '✉️');
          return `
            <div style="padding: 10px; margin-bottom: 8px; background: var(--dark-${isInbound ? 'bg' : 'elevated'}); border-radius: 8px; border-left: 3px solid ${isInbound ? '#3b82f6' : 'var(--gold-primary)'};">
              <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                <span style="font-size: 11px; color: var(--text-muted);">
                  ${channelIcon} ${isInbound ? (msg.sent_from || 'Customer') : 'You'}
                  ${msg.channel === 'design_share' ? '• Design Comment' : ''}
                </span>
                <span style="font-size: 11px; color: var(--text-muted);">${new Date(msg.created_at).toLocaleString()}</span>
              </div>
              <div style="color: var(--text-primary); font-size: 13px; line-height: 1.4;">${escapeHtml(msg.message || '')}</div>
            </div>
          `;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;

        // Mark as read
        const unreadIds = messages.filter(m => m.direction === 'inbound' && m.status !== 'read').map(m => m.id);
        if (unreadIds.length > 0) {
          supabaseClient
            .from('customer_messages')
            .update({ status: 'read', read_at: new Date().toISOString() })
            .in('id', unreadIds)
            .then(() => {
              if (badge) badge.style.display = 'none';
            });
        }
      } catch (err) {
        console.error('Load lead messages error:', err);
        container.innerHTML = '<div style="padding: 16px; color: var(--error); font-size: 13px; text-align: center;">Error loading messages</div>';
      }
    }

    async function sendLeadReply() {
      if (!selectedLead) return;

      const input = document.getElementById('lead-message-input');
      const message = input?.value?.trim();
      if (!message) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        const leadEmail = selectedLead.email;
        const leadName = selectedLead.full_name || selectedLead.name || '';
        const channel = leadEmail ? 'email' : 'portal';

        // Save to database
        const { data, error } = await supabaseClient
          .from('customer_messages')
          .insert({
            lead_id: selectedLead.id,
            sender_id: user?.id || null,
            direction: 'outbound',
            channel: channel,
            message: message,
            sent_from: user?.email || 'Surprise Granite',
            sent_to: leadEmail || null,
            status: 'sent',
            created_at: new Date().toISOString()
          });

        if (error) throw error;

        input.value = '';
        loadLeadMessages(selectedLead.id);

        // Send actual email if lead has an email address
        if (leadEmail) {
          try {
            const resp = await apiCall('/api/send-lead-message', {
              method: 'POST',
              body: JSON.stringify({
                to_email: leadEmail,
                to_name: leadName,
                message: message,
                sender_name: user?.user_metadata?.full_name || user?.email || 'Surprise Granite',
                lead_id: selectedLead.id
              })
            });
            const result = await resp.json();
            if (result.success) {
              showToast('Reply sent via email!', 'success');
            } else {
              showToast('Saved but email delivery failed', 'warning');
            }
          } catch (emailErr) {
            console.error('Email delivery error:', emailErr);
            showToast('Saved but email delivery failed', 'warning');
          }
        } else {
          showToast('Reply saved (no email on file for this lead)', 'info');
        }
      } catch (err) {
        console.error('Send reply error:', err);
        showToast('Failed to send reply', 'error');
      }
    }

    function closeLeadModal() {
      document.getElementById('lead-modal').classList.remove('active');
      selectedLead = null;
    }

    function openAddLeadModal() {
      document.getElementById('add-lead-form').reset();
      document.getElementById('add-lead-modal').classList.add('active');

      // Set min date for appointment picker to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('new-lead-appt-date').min = today;

      // Reset service address visibility
      document.getElementById('new-lead-service-address-section').style.display = 'none';
      document.getElementById('new-lead-address-same').checked = true;

      // Setup smart paste for auto-filling from pasted contact info
      setupSmartPaste('new-lead-first-name', {
        firstName: 'new-lead-first-name',
        lastName: 'new-lead-last-name',
        email: 'new-lead-email',
        phone: 'new-lead-phone',
        address: 'new-lead-billing-street',
        city: 'new-lead-billing-city',
        state: 'new-lead-billing-state',
        zip: 'new-lead-billing-zip'
      });
    }

    function closeAddLeadModal() {
      document.getElementById('add-lead-modal').classList.remove('active');
      // Reset service address section
      document.getElementById('new-lead-address-same').checked = true;
      document.getElementById('new-lead-service-address-section').style.display = 'none';
      // Reset edit mode and title
      editingLeadId = null;
      const modalTitle = document.querySelector('#add-lead-modal .modal-title');
      if (modalTitle) modalTitle.textContent = 'Add New Lead';
      document.getElementById('add-lead-form').reset();
    }

    function toggleNewLeadServiceAddress() {
      const checkbox = document.getElementById('new-lead-address-same');
      const serviceSection = document.getElementById('new-lead-service-address-section');

      if (checkbox.checked) {
        serviceSection.style.display = 'none';
        // Clear service address fields
        document.getElementById('new-lead-service-street').value = '';
        document.getElementById('new-lead-service-street2').value = '';
        document.getElementById('new-lead-service-city').value = '';
        document.getElementById('new-lead-service-zip').value = '';
      } else {
        serviceSection.style.display = 'block';
        // Animate in
        serviceSection.style.animation = 'fadeSlideIn 0.3s ease';
      }
    }

    async function saveNewLead(event) {
      event.preventDefault();

      const btn = document.getElementById('save-lead-btn');
      const originalBtnHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Saving...';

      try {
        // Get current user for lead ownership
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in to add leads');

        const firstName = document.getElementById('new-lead-first-name').value.trim();
        const lastName = document.getElementById('new-lead-last-name').value.trim();
        const fullName = `${firstName} ${lastName}`.trim();
        const email = document.getElementById('new-lead-email').value.trim();
        const phone = document.getElementById('new-lead-phone').value.trim() || null;
        const projectType = document.getElementById('new-lead-project-type').value || null;

        // Collect billing address
        const billingStreet = document.getElementById('new-lead-billing-street').value.trim();
        const billingAddress = billingStreet ? {
          street: billingStreet,
          street2: document.getElementById('new-lead-billing-street2').value.trim() || null,
          city: document.getElementById('new-lead-billing-city').value.trim() || null,
          state: document.getElementById('new-lead-billing-state').value || null,
          zip: document.getElementById('new-lead-billing-zip').value.trim() || null
        } : null;

        // Check if service address is same as billing
        const addressSame = document.getElementById('new-lead-address-same').checked;

        // Collect service address if different
        let serviceAddress = null;
        if (!addressSame) {
          const serviceStreet = document.getElementById('new-lead-service-street').value.trim();
          if (serviceStreet) {
            serviceAddress = {
              street: serviceStreet,
              street2: document.getElementById('new-lead-service-street2').value.trim() || null,
              city: document.getElementById('new-lead-service-city').value.trim() || null,
              state: document.getElementById('new-lead-service-state').value || null,
              zip: document.getElementById('new-lead-service-zip').value.trim() || null
            };
          }
        }

        // Collect appointment data
        const apptDate = document.getElementById('new-lead-appt-date').value;
        const apptTime = document.getElementById('new-lead-appt-time').value;
        const apptType = document.getElementById('new-lead-appt-type').value;
        const hasAppointment = apptDate && apptTime;

        // Format appointment string for message
        let appointmentInfo = '';
        if (hasAppointment) {
          const apptDateObj = new Date(apptDate + 'T12:00:00');
          const formattedDate = apptDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
          const apptTypeLabels = {
            'estimate': 'Free In-Home Estimate',
            'measure': 'Measurement Visit',
            'showroom': 'Showroom Visit',
            'consultation': 'Design Consultation',
            'installation': 'Installation'
          };
          appointmentInfo = `\n\nSCHEDULED APPOINTMENT:\n${apptTypeLabels[apptType] || apptType}\n${formattedDate} at ${apptTime}`;
        }

        const userMessage = document.getElementById('new-lead-message').value.trim() || '';
        const fullMessage = userMessage + appointmentInfo;

        const leadData = {
          full_name: fullName,
          first_name: firstName,
          last_name: lastName,
          email: email,
          phone: phone,
          project_type: projectType,
          zip_code: document.getElementById('new-lead-zip').value.trim() || null,
          message: fullMessage || null,
          source: document.getElementById('new-lead-source').value,
          status: document.getElementById('new-lead-status').value,
          // Address fields
          billing_address: billingAddress,
          service_address: serviceAddress,
          address_same: addressSame,
          // Appointment data in raw_data
          raw_data: hasAppointment ? {
            appointment: {
              date: apptDate,
              time: apptTime,
              type: apptType
            }
          } : null
        };

        let data, error;

        // Check if we're editing an existing lead
        if (editingLeadId) {
          // Update existing lead - add updated_at timestamp
          leadData.updated_at = new Date().toISOString();

          const { data: updateData, error: updateError } = await supabaseClient
            .from('leads')
            .update(leadData)
            .eq('id', editingLeadId)
            .select()
            .single();
          data = updateData;
          error = updateError;
        } else {
          // Insert new lead - add user_id, created_at and form_name
          leadData.user_id = user.id;
          leadData.created_at = new Date().toISOString();
          leadData.form_name = 'manual-entry';

          const { data: insertData, error: insertError } = await supabaseClient
            .from('leads')
            .insert([leadData])
            .select()
            .single();
          data = insertData;
          error = insertError;
        }

        if (error) throw error;

        // Create portal token for new leads only (not edits)
        let portalUrl = null;
        if (!editingLeadId) {
          try {
            const { data: { user } } = await supabaseClient.auth.getUser();
            const { data: token, error: tokenError } = await supabaseClient
              .from('portal_tokens')
              .insert([{
                lead_id: data.id,
                owner_id: user.id,
                email: email,
                phone: phone,
                permissions: {
                  view_project: true,
                  view_estimates: true,
                  approve_estimates: true,
                  view_invoices: true,
                  pay_invoices: true,
                  upload_photos: true,
                  send_messages: true,
                  view_appointments: true
                }
              }])
              .select()
              .single();

            if (token && !tokenError) {
              portalUrl = `https://www.surprisegranite.com/portal/?token=${token.token}`;
              console.log('Portal token created:', token.id);
            } else if (tokenError) {
              console.warn('Portal token error:', tokenError.message);
            }
          } catch (tokenErr) {
            console.warn('Portal token creation error:', tokenErr);
          }
        }

        // Send welcome email if checkbox is checked (new leads only)
        const sendEmail = document.getElementById('new-lead-send-email').checked;
        if (sendEmail && email && !editingLeadId) {
          try {
            await sendLeadWelcomeEmail({
              firstName,
              lastName,
              email,
              phone,
              projectType,
              hasAppointment,
              apptDate,
              apptTime,
              apptType,
              portalUrl
            });
          } catch (emailErr) {
            console.warn('Welcome email error (non-blocking):', emailErr);
          }
        }

        // Capture edit state before closing modal (which resets editingLeadId)
        const wasEditing = !!editingLeadId;

        // Update local array and refresh display
        if (wasEditing && data) {
          // Replace existing lead in array
          const index = allLeads.findIndex(l => l.id === editingLeadId);
          if (index !== -1) {
            allLeads[index] = data;
          }
        } else if (data) {
          // Add new lead to beginning
          allLeads.unshift(data);
        }

        updateStats();
        renderLeads();
        closeAddLeadModal();

        let successMsg = wasEditing ? 'Lead updated successfully!' : 'Lead added successfully!';
        if (!wasEditing && sendEmail && email) successMsg += ' Welcome email sent.';
        if (hasAppointment) successMsg += ' Appointment scheduled.';
        showToast(successMsg, 'success');

      } catch (err) {
        console.error('Error saving lead:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
      }
    }

    // Save lead and immediately open estimate modal - streamlined workflow
    async function saveLeadAndCreateEstimate() {
      const btn = document.getElementById('save-lead-estimate-btn');
      const originalBtnHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Saving...';

      try {
        // Validate required fields
        const firstName = document.getElementById('new-lead-first-name').value.trim();
        const lastName = document.getElementById('new-lead-last-name').value.trim();
        const email = document.getElementById('new-lead-email').value.trim();

        if (!firstName || !lastName || !email) {
          showToast('Please fill in required fields (First Name, Last Name, Email)', 'error');
          return;
        }

        // Get current user for lead ownership
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in to add leads');

        const fullName = `${firstName} ${lastName}`.trim();
        const phone = document.getElementById('new-lead-phone').value.trim() || null;
        const projectType = document.getElementById('new-lead-project-type').value || null;

        // Collect billing address
        const billingStreet = document.getElementById('new-lead-billing-street').value.trim();
        const billingAddress = billingStreet ? {
          street: billingStreet,
          street2: document.getElementById('new-lead-billing-street2').value.trim() || null,
          city: document.getElementById('new-lead-billing-city').value.trim() || null,
          state: document.getElementById('new-lead-billing-state').value || null,
          zip: document.getElementById('new-lead-billing-zip').value.trim() || null
        } : null;

        // Check if service address is same as billing
        const addressSame = document.getElementById('new-lead-address-same').checked;

        // Collect service address if different
        let serviceAddress = null;
        if (!addressSame) {
          const serviceStreet = document.getElementById('new-lead-service-street').value.trim();
          if (serviceStreet) {
            serviceAddress = {
              street: serviceStreet,
              street2: document.getElementById('new-lead-service-street2').value.trim() || null,
              city: document.getElementById('new-lead-service-city').value.trim() || null,
              state: document.getElementById('new-lead-service-state').value || null,
              zip: document.getElementById('new-lead-service-zip').value.trim() || null
            };
          }
        }

        const userMessage = document.getElementById('new-lead-message').value.trim() || '';

        const leadData = {
          full_name: fullName,
          first_name: firstName,
          last_name: lastName,
          email: email,
          phone: phone,
          project_type: projectType,
          zip_code: document.getElementById('new-lead-zip').value.trim() || null,
          message: userMessage || null,
          source: document.getElementById('new-lead-source').value,
          status: 'quoted', // Set to quoted since we're creating an estimate
          billing_address: billingAddress,
          service_address: serviceAddress,
          address_same: addressSame,
          user_id: user.id,
          created_at: new Date().toISOString(),
          form_name: 'manual-entry-estimate'
        };

        // Insert the lead
        const { data: lead, error } = await supabaseClient
          .from('leads')
          .insert([leadData])
          .select()
          .single();

        if (error) throw error;

        // Add to local array
        allLeads.unshift(lead);
        updateStats();
        renderLeads();

        // Close the add lead modal
        closeAddLeadModal();

        showToast('Lead saved! Opening estimate form...', 'success');

        // Small delay then open estimate modal with lead data
        setTimeout(() => {
          startEstimateFromLead(lead.id);
        }, 300);

      } catch (err) {
        console.error('Error in save lead & estimate:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
      }
    }

    // Save lead and immediately open invoice modal - for customers ready to pay
    async function saveLeadAndCreateInvoice() {
      const btn = document.getElementById('save-lead-invoice-btn');
      const originalBtnHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Saving...';

      try {
        // Validate required fields
        const firstName = document.getElementById('new-lead-first-name').value.trim();
        const lastName = document.getElementById('new-lead-last-name').value.trim();
        const email = document.getElementById('new-lead-email').value.trim();

        if (!firstName || !lastName || !email) {
          showToast('Please fill in required fields (First Name, Last Name, Email)', 'error');
          return;
        }

        // Get current user for lead ownership
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in to add leads');

        const fullName = `${firstName} ${lastName}`.trim();
        const phone = document.getElementById('new-lead-phone').value.trim() || null;
        const projectType = document.getElementById('new-lead-project-type').value || null;

        // Collect billing address
        const billingStreet = document.getElementById('new-lead-billing-street').value.trim();
        const billingAddress = billingStreet ? {
          street: billingStreet,
          street2: document.getElementById('new-lead-billing-street2').value.trim() || null,
          city: document.getElementById('new-lead-billing-city').value.trim() || null,
          state: document.getElementById('new-lead-billing-state').value || null,
          zip: document.getElementById('new-lead-billing-zip').value.trim() || null
        } : null;

        const userMessage = document.getElementById('new-lead-message').value.trim() || '';

        const leadData = {
          full_name: fullName,
          first_name: firstName,
          last_name: lastName,
          email: email,
          phone: phone,
          project_type: projectType,
          zip_code: document.getElementById('new-lead-zip').value.trim() || null,
          message: userMessage || null,
          source: document.getElementById('new-lead-source').value,
          status: 'won', // Set to won since they're ready to pay
          billing_address: billingAddress,
          user_id: user.id,
          created_at: new Date().toISOString(),
          form_name: 'manual-entry-invoice'
        };

        // Insert the lead
        const { data: lead, error } = await supabaseClient
          .from('leads')
          .insert([leadData])
          .select()
          .single();

        if (error) throw error;

        // Add to local array
        allLeads.unshift(lead);
        updateStats();
        renderLeads();

        // Close the add lead modal
        closeAddLeadModal();

        showToast('Lead saved! Opening invoice form...', 'success');

        // Small delay then open invoice modal with lead data
        setTimeout(() => {
          startInvoiceFromLead(lead.id);
        }, 300);

      } catch (err) {
        console.error('Error in save lead & invoice:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalBtnHTML;
      }
    }

    // Send welcome email to new lead
    async function sendLeadWelcomeEmail(leadInfo) {
      const { firstName, lastName, email, phone, projectType, hasAppointment, apptDate, apptTime, apptType, notes, portalUrl } = leadInfo;

      const projectTypeLabels = {
        'kitchen': 'Kitchen Countertops',
        'bathroom': 'Bathroom Vanity',
        'flooring': 'Flooring',
        'fireplace': 'Fireplace Surround',
        'outdoor': 'Outdoor Kitchen',
        'commercial': 'Commercial Project',
        'other': 'Home Improvement'
      };
      const projectLabel = projectTypeLabels[projectType] || 'Countertop Project';

      const apptTypeLabels = {
        'estimate': 'Free In-Home Estimate',
        'measure': 'Measurement Visit',
        'showroom': 'Showroom Visit',
        'consultation': 'Design Consultation',
        'installation': 'Installation'
      };

      // Format appointment date nicely
      let formattedDate = '';
      if (hasAppointment && apptDate) {
        const apptDateObj = new Date(apptDate + 'T12:00:00');
        formattedDate = apptDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      }

      try {
        // Use local API for development, production API otherwise
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiBase = isLocal ? 'http://localhost:3001' : 'https://surprise-granite-email-api.onrender.com';

        const response = await fetch(`${apiBase}/api/email/lead-welcome`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: email,
            first_name: firstName,
            last_name: lastName,
            full_name: `${firstName} ${lastName}`.trim(),
            project_type: projectLabel,
            notes: notes || null,
            has_appointment: hasAppointment,
            appointment_date: hasAppointment ? formattedDate : null,
            appointment_time: hasAppointment ? apptTime : null,
            appointment_type: hasAppointment ? (apptTypeLabels[apptType] || 'Appointment') : null,
            portal_url: portalUrl || null,
            source: 'Manual Entry - Account'
          })
        });

        const result = await response.json();
        if (!response.ok) {
          console.error('Welcome email failed:', result);
          return false;
        }
        console.log('Welcome email sent successfully to:', email);
        return true;
      } catch (error) {
        console.error('Failed to send welcome email:', error);
        return false;
      }
    }

    // Close add lead modal when clicking overlay
    document.getElementById('add-lead-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeAddLeadModal();
    });

    async function updateLeadStatus() {
      if (!selectedLead) return;

      const newStatus = document.getElementById('lead-status-select').value;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = newStatus;

        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Status updated', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function deleteLead() {
      if (!selectedLead) return;

      const confirmed = confirm(`Are you sure you want to permanently delete this lead?\n\n${selectedLead.full_name || 'Unknown'}\n${selectedLead.email || ''}\n\nThis action cannot be undone.`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', selectedLead.id);

        if (error) throw error;

        // Remove from local array
        allLeads = allLeads.filter(l => l.id !== selectedLead.id);
        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Lead deleted', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function archiveLead() {
      if (!selectedLead) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        if (error) throw error;

        // Update local array
        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) allLeads[idx].status = 'archived';

        updateStats();
        renderLeads();
        closeLeadModal();
        showToast('Lead archived', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickDeleteLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const confirmed = confirm(`Delete this lead?\n\n${lead.full_name || 'Unknown'}\n${lead.email || ''}`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', leadId);

        if (error) throw error;

        allLeads = allLeads.filter(l => l.id !== leadId);
        updateStats();
        renderLeads();
        showToast('Lead deleted', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickArchiveLead(leadId) {
      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', leadId);

        if (error) throw error;

        const idx = allLeads.findIndex(l => l.id === leadId);
        if (idx !== -1) allLeads[idx].status = 'archived';

        updateStats();
        renderLeads();
        showToast('Lead archived', 'success');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function convertLeadToCustomer() {
      if (!selectedLead) {
        showToast('No lead selected', 'error');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Check if customer already exists with this email
        if (selectedLead.email) {
          const { data: existing, error: checkError } = await supabaseClient
            .from('customers')
            .select('id')
            .eq('email', selectedLead.email)
            .eq('user_id', user.id)
            .maybeSingle();

          // Ignore 406 errors (no rows found)
          if (existing && !checkError) {
            showToast('Customer with this email already exists', 'info');
            return;
          }
        }

        // Parse name into parts
        const nameParts = (selectedLead.full_name || '').trim().split(' ');
        const firstName = nameParts[0] || '';
        const lastName = nameParts.slice(1).join(' ') || '';

        // Get address from structured data or parse from string
        let address = null, city = null, state = 'AZ', zip = null;

        // Try structured service_address first, then billing_address
        const structuredAddr = selectedLead.service_address || selectedLead.billing_address;
        if (structuredAddr && typeof structuredAddr === 'object') {
          address = structuredAddr.street || null;
          if (structuredAddr.street2) address += ' ' + structuredAddr.street2;
          city = structuredAddr.city || null;
          state = structuredAddr.state || 'AZ';
          zip = structuredAddr.zip || selectedLead.zip_code || null;
        } else {
          // Fall back to parsing address string
          const addressParts = (selectedLead.project_address || selectedLead.address || '').split(',').map(s => s.trim());
          address = addressParts[0] || null;
          city = addressParts[1] || null;
          state = addressParts[2] || 'AZ';
          zip = selectedLead.zip_code || null;
        }

        // Build notes with appointment info if present
        let notes = `Lead source: ${selectedLead.form_name || 'Website'}\nProject type: ${selectedLead.project_type || 'Not specified'}`;
        if (selectedLead.raw_data?.appointment) {
          const appt = selectedLead.raw_data.appointment;
          const apptTypeLabels = {
            'estimate': 'Free In-Home Estimate',
            'measure': 'Measurement Visit',
            'showroom': 'Showroom Visit',
            'consultation': 'Design Consultation',
            'installation': 'Installation'
          };
          notes += `\n\nScheduled: ${apptTypeLabels[appt.type] || appt.type} on ${appt.date} at ${appt.time}`;
        }
        if (selectedLead.message) {
          notes += `\n\nOriginal message: ${selectedLead.message}`;
        }

        // Create customer with standard fields only (+ bidirectional lead_id reference)
        const customerData = {
          user_id: user.id,
          name: selectedLead.full_name || 'Unknown',
          email: selectedLead.email || null,
          phone: selectedLead.phone || null,
          address: address,
          city: city,
          state: state,
          zip: zip,
          notes: notes,
          lead_id: selectedLead.id, // Bidirectional reference back to lead
          source: selectedLead.form_name || 'lead_conversion'
        };

        console.log('Creating customer with data:', customerData);

        const { data: customer, error } = await supabaseClient
          .from('customers')
          .insert(customerData)
          .select()
          .single();

        if (error) {
          console.error('Customer insert error:', error);
          throw error;
        }

        // Update lead status to "qualified"
        await supabaseClient
          .from('leads')
          .update({ status: 'qualified', customer_id: customer.id, updated_at: new Date().toISOString() })
          .eq('id', selectedLead.id);

        // Update local lead data (bidirectional sync)
        const idx = allLeads.findIndex(l => l.id === selectedLead.id);
        if (idx !== -1) {
          allLeads[idx].status = 'qualified';
          allLeads[idx].customer_id = customer.id;
        }

        // Add new customer to global array (bidirectional sync)
        customer.lead_id = selectedLead.id;
        customer.total_jobs = 0;
        customer.total_spent = 0;
        allCustomers.unshift(customer);

        // Save appointment info before closing modal (which clears selectedLead)
        const hasAppointment = selectedLead?.raw_data?.appointment;
        const customerId = customer.id;

        showToast('Customer created successfully!');
        updateStats();
        renderLeads();
        closeLeadModal();

        // Offer to create estimate with appointment pre-filled
        const confirmMsg = hasAppointment
          ? 'Customer added! They have an appointment scheduled. Create an estimate for them now?'
          : 'Customer added! Would you like to create an estimate for them now?';

        if (confirm(confirmMsg)) {
          createEstimateForCustomer(customerId);
        }
      } catch (err) {
        console.error('Convert lead error:', err);
        showToast('Error creating customer: ' + err.message, 'error');
      }
    }

    // UNIFIED: Start estimate from lead - ensures customer is created/linked first
    async function startEstimateFromLead(leadId) {
      const lead = leadId ? allLeads.find(l => l.id === leadId) : selectedLead;
      if (!lead) {
        showToast('No lead selected', 'error');
        return;
      }

      // Close lead modal
      closeLeadModal();

      showToast('Creating customer record...', 'info');

      // ALWAYS create/find customer first - this ensures proper linkage
      const customer = await findOrCreateCustomerFromLead(lead);
      if (!customer) {
        showToast('Failed to create customer record', 'error');
        return;
      }

      // Update workflow state
      workflowState.currentLead = lead;
      workflowState.currentCustomer = customer;

      // Navigate to estimates page
      showPage('estimates');

      // Small delay to ensure page is rendered
      setTimeout(() => {
        // Set modal state with proper customer linkage
        estimateModalState = {
          customerId: customer.id,
          leadId: lead.id,
          editingEstimateId: null
        };

        // Open estimate modal (preserveState=true since we set estimateModalState above)
        openCreateEstimateModal(true);

        // Pre-fill customer info
        fillEstimateCustomerFields(customer);

        // Pre-fill project info from lead
        const projectNameField = document.getElementById('estimate-project-name');
        const projectDescField = document.getElementById('estimate-project-desc');
        if (projectNameField) projectNameField.value = lead.project_type ? `${lead.project_type} Project` : 'New Project';
        if (projectDescField) projectDescField.value = lead.message || lead.project_details || '';

        // Update lead status to "quoted"
        supabaseClient
          .from('leads')
          .update({ status: 'quoted', updated_at: new Date().toISOString() })
          .eq('id', lead.id);

        showToast(`Estimate linked to customer: ${customer.name}`);
      }, 150);
    }

    // Backward compatibility alias
    async function createEstimateFromLead() {
      return startEstimateFromLead(selectedLead?.id);
    }

    // Send invoice directly to lead (without requiring an estimate)
    function sendInvoiceToLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'warning');
        return;
      }

      closeLeadModal();
      showPage('invoices');

      setTimeout(() => {
        openInvoiceModal({
          email: selectedLead.email || '',
          name: selectedLead.full_name || '',
          phone: selectedLead.phone || ''
        });

        showToast('Invoice form pre-filled from lead', 'success');
      }, 200);
    }

    // Create project from lead
    async function createProjectFromLead() {
      if (!selectedLead) { showToast('No lead selected', 'warning'); return; }
      var lead = selectedLead;

      // Ensure customer exists first
      await findOrCreateCustomerFromLead(lead);

      // Close lead modal and navigate to projects
      const leadModal = document.getElementById('lead-modal');
      if (leadModal) leadModal.classList.remove('active');
      showPage('projects');

      setTimeout(function() {
        openNewProjectModal();
        // Pre-fill from lead data
        document.getElementById('proj-name').value = (lead.project_type || 'New Project') + ' - ' + (lead.full_name || '');
        document.getElementById('proj-customer-name').value = lead.full_name || '';
        document.getElementById('proj-customer-email').value = lead.email || '';
        document.getElementById('proj-customer-phone').value = lead.phone || '';
        // Parse address
        var addr = lead.project_address || lead.service_address || '';
        if (typeof addr === 'object' && addr !== null) {
          document.getElementById('proj-address').value = addr.street || '';
          document.getElementById('proj-city').value = addr.city || '';
          document.getElementById('proj-state').value = addr.state || 'AZ';
          document.getElementById('proj-zip').value = addr.zip || '';
        } else {
          document.getElementById('proj-address').value = addr;
        }
        document.getElementById('proj-notes').value = 'From lead: ' + (lead.message || lead.project_details || '');
        document.getElementById('proj-status').value = 'lead';

        showToast('Project form pre-filled from lead', 'success');
      }, 300);
    }

    // Create room design from lead
    async function createDesignFromLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'error');
        return;
      }

      // Store lead info in sessionStorage for the room designer to read
      const leadInfo = {
        id: selectedLead.id,
        full_name: selectedLead.full_name || '',
        email: selectedLead.email || '',
        phone: selectedLead.phone || '',
        address: selectedLead.project_address || selectedLead.address || '',
        project_type: selectedLead.project_type || '',
        message: selectedLead.message || selectedLead.project_details || ''
      };

      sessionStorage.setItem('sg_lead_for_design', JSON.stringify(leadInfo));

      // Close lead modal
      closeLeadModal();

      // Open room designer in new tab with lead flag
      window.open('/tools/room-designer/?from_lead=1', '_blank');

      showToast('Opening Room Designer with lead info...');
    }

    // Quick convert from leads table
    async function quickConvertLead(leadId, action) {
      selectedLead = allLeads.find(l => l.id === leadId);
      if (!selectedLead) {
        showToast('Lead not found', 'error');
        return;
      }

      if (action === 'customer') {
        await convertLeadToCustomer();
      } else if (action === 'estimate') {
        await createEstimateFromLead();
      } else if (action === 'design') {
        await createDesignFromLead();
      }
    }

    // ==========================================
    // UNIFIED CUSTOMER MANAGEMENT SYSTEM
    // Combines: Account Subscribers, Shopify Customers, Imported Clients
    // ==========================================

    // allCustomers and customerFilter declared above
    let filteredCustomersList = [];
    let customersPage = 1;
    const customersPageSize = 50;
    // customerFilter declared above
    let customerSort = 'recent';
    let customersLoaded = false;

    // Customer source counts
    let subscriberCount = 0;
    let shopifyCustomerCount = 0;
    let importedCustomerCount = 0;

    async function loadCustomers() {
      if (customersLoaded) {
        renderCustomers();
        return;
      }

      const loadingEl = document.getElementById('customers-loading');
      const emptyEl = document.getElementById('customers-empty');
      const tableEl = document.getElementById('customers-table');
      const paginationEl = document.getElementById('customers-pagination');

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();

        // Step 1: Consolidate sg_users and shopify_customers into unified customers table
        await consolidateCustomerSources(user);

        // Step 2: Load from the unified customers table (single source of truth)
        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Map source labels for display
        const sourceLabels = {
          'subscriber': { label: 'Account', color: 'var(--gold-primary)' },
          'shopify': { label: 'Shopify', color: 'var(--info)' },
          'manual': { label: 'Manual', color: 'var(--text-muted)' },
          'stripe_sync': { label: 'Stripe', color: 'var(--success)' },
          'lead_conversion': { label: 'Lead', color: 'var(--warning)' }
        };

        allCustomers = (customers || []).map(c => ({
          ...c,
          _source: c.source || 'manual',
          name: c.name || c.full_name || c.email?.split('@')[0] || 'Unknown',
          total_spent: parseFloat(c.total_spent || 0),
          orders_count: c.total_jobs || 0,
          _sourceLabel: sourceLabels[c.source]?.label || 'Customer',
          _sourceColor: sourceLabels[c.source]?.color || 'var(--text-muted)'
        }));

        // Count by source for stats
        subscriberCount = allCustomers.filter(c => c._source === 'subscriber').length;
        shopifyCustomerCount = allCustomers.filter(c => c._source === 'shopify').length;
        importedCustomerCount = allCustomers.filter(c => c._source === 'stripe_sync' || c._source === 'manual').length;

        customersLoaded = true;
        loadingEl.style.display = 'none';

        // Update stats
        updateCustomerStats();

        // Setup search
        setupCustomersSearch();

        if (allCustomers.length === 0) {
          emptyEl.style.display = 'block';
          tableEl.style.display = 'none';
          paginationEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          tableEl.style.display = 'block';
          paginationEl.style.display = 'flex';
          filterCustomers('all');
        }

      } catch (err) {
        console.error('Error loading customers:', err);
        loadingEl.innerHTML = `<p style="color: var(--error);">Error loading customers: ${escapeHtml(err.message || 'Unknown error')}</p>`;
      }
    }

    // Consolidate records from sg_users and shopify_customers into the unified customers table
    async function consolidateCustomerSources(user) {
      try {
        // Get existing customer emails for deduplication
        const { data: existingCustomers } = await supabaseClient
          .from('customers')
          .select('email');

        const existingEmails = new Set((existingCustomers || []).map(c => c.email?.toLowerCase()).filter(Boolean));

        // Fetch from sg_users and shopify_customers in parallel
        const [subscribersResult, shopifyResult] = await Promise.all([
          supabaseClient.from('sg_users').select('id, email, full_name, phone, created_at, account_type, avatar_url'),
          supabaseClient.from('shopify_customers').select('*').order('created_at', { ascending: false })
        ]);

        const toInsert = [];

        // Process subscribers not yet in customers table
        (subscribersResult.data || []).forEach(u => {
          if (u.email && !existingEmails.has(u.email.toLowerCase())) {
            existingEmails.add(u.email.toLowerCase());
            toInsert.push({
              user_id: user?.id,
              name: u.full_name || u.email?.split('@')[0] || 'Unknown',
              email: u.email,
              phone: u.phone || null,
              source: 'subscriber',
              created_at: u.created_at
            });
          }
        });

        // Process Shopify customers not yet in customers table
        (shopifyResult.data || []).forEach(c => {
          const name = c.name || [c.first_name, c.last_name].filter(Boolean).join(' ') || c.email?.split('@')[0] || 'Unknown';
          if (c.email && !existingEmails.has(c.email.toLowerCase())) {
            existingEmails.add(c.email.toLowerCase());
            toInsert.push({
              user_id: user?.id,
              name: name,
              email: c.email,
              phone: c.phone || null,
              source: 'shopify',
              created_at: c.created_at
            });
          }
        });

        // Bulk insert new records
        if (toInsert.length > 0) {
          const { error } = await supabaseClient.from('customers').upsert(toInsert, { onConflict: 'user_id,email', ignoreDuplicates: true });
          if (error) {
            console.warn('[Customers] Consolidation error (non-fatal):', error.message);
          }
        }
      } catch (err) {
        console.warn('[Customers] Consolidation failed (non-fatal):', err.message);
      }
    }

    function updateCustomerStats() {
      const total = allCustomers.length;
      const totalRevenue = allCustomers.reduce((sum, c) => sum + (parseFloat(c.total_spent) || 0), 0);
      const activeCount = allCustomers.filter(c => (c.orders_count || 0) > 0).length;
      const thirtyDaysAgo = new Date();
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      const recentCount = allCustomers.filter(c => new Date(c.created_at) > thirtyDaysAgo).length;
      const vipCount = allCustomers.filter(c => (parseFloat(c.total_spent) || 0) >= 1000).length;

      document.getElementById('stat-total-customers').textContent = total.toLocaleString();
      document.getElementById('stat-subscribers').textContent = subscriberCount.toLocaleString();
      document.getElementById('stat-shopify-customers').textContent = shopifyCustomerCount.toLocaleString();
      document.getElementById('stat-imported-customers').textContent = importedCustomerCount.toLocaleString();
      document.getElementById('stat-customer-revenue').textContent = '$' + totalRevenue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      // Update filter counts
      document.getElementById('count-all-customers').textContent = total;
      document.getElementById('count-active-customers').textContent = activeCount;
      document.getElementById('count-recent-customers').textContent = recentCount;
      document.getElementById('count-vip-customers').textContent = vipCount;

      // Update nav badge
      const countEl = document.getElementById('customers-count');
      if (countEl) {
        countEl.textContent = total.toLocaleString();
        countEl.dataset.count = total;
        countEl.style.display = total > 0 ? 'inline-flex' : 'none';
      }
    }

    function setupCustomersSearch() {
      const searchInput = document.getElementById('customers-search');
      if (!searchInput) return;
      let timeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          customersPage = 1;
          renderCustomers();
        }, 300);
      });
    }

    function filterCustomers(filter) {
      customerFilter = filter;

      // Update filter pills
      document.querySelectorAll('[data-customer-filter]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.customerFilter === filter);
      });

      // Update source dropdown
      const sourceSelect = document.getElementById('customers-source-filter');
      if (sourceSelect && ['all', 'subscribers', 'shopify', 'imported', 'manual'].includes(filter)) {
        sourceSelect.value = filter;
      }

      customersPage = 1;
      renderCustomers();
    }

    function sortCustomers(sortBy) {
      customerSort = sortBy;
      renderCustomers();
    }

    function renderCustomers() {
      const searchTerm = (document.getElementById('customers-search')?.value || '').toLowerCase();
      let filtered = [...allCustomers];

      // Apply source filter
      if (customerFilter === 'subscribers') {
        filtered = filtered.filter(c => c._source === 'subscriber' || c._source === 'both');
      } else if (customerFilter === 'shopify') {
        filtered = filtered.filter(c => c._source === 'shopify' || c._source === 'both');
      } else if (customerFilter === 'imported') {
        filtered = filtered.filter(c => c._source === 'imported');
      } else if (customerFilter === 'manual') {
        filtered = filtered.filter(c => c._source === 'manual');
      } else if (customerFilter === 'active') {
        filtered = filtered.filter(c => (c.orders_count || 0) > 0);
      } else if (customerFilter === 'recent') {
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        filtered = filtered.filter(c => new Date(c.created_at) > thirtyDaysAgo);
      } else if (customerFilter === 'vip') {
        filtered = filtered.filter(c => (parseFloat(c.total_spent) || 0) >= 1000);
      }

      // Apply search
      if (searchTerm) {
        filtered = filtered.filter(c => {
          const name = c.name || '';
          return name.toLowerCase().includes(searchTerm) ||
            (c.email || '').toLowerCase().includes(searchTerm) ||
            (c.phone || '').toLowerCase().includes(searchTerm) ||
            (c.city || '').toLowerCase().includes(searchTerm);
        });
      }

      // Apply sort
      if (customerSort === 'name') {
        filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
      } else if (customerSort === 'spent') {
        filtered.sort((a, b) => (parseFloat(b.total_spent) || 0) - (parseFloat(a.total_spent) || 0));
      } else if (customerSort === 'orders') {
        filtered.sort((a, b) => (b.orders_count || 0) - (a.orders_count || 0));
      } else {
        filtered.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      }

      filteredCustomersList = filtered;

      const tableEl = document.getElementById('customers-table');
      const emptyEl = document.getElementById('customers-empty');
      const paginationEl = document.getElementById('customers-pagination');

      if (filtered.length === 0) {
        tableEl.style.display = 'none';
        emptyEl.style.display = 'block';
        paginationEl.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      tableEl.style.display = 'block';
      paginationEl.style.display = 'flex';

      // Paginate
      const start = (customersPage - 1) * customersPageSize;
      const end = start + customersPageSize;
      const pageCustomers = filtered.slice(start, end);

      // Render customer cards
      tableEl.innerHTML = `
        <div class="list-modern">
          ${pageCustomers.map(c => {
            const ordersCount = c.orders_count || 0;
            const totalSpent = parseFloat(c.total_spent || 0);
            const ordersColor = ordersCount > 0 ? '#22c55e' : '#6b7280';
            return `
            <div class="list-item-modern" onclick="viewShopifyCustomer('${c.id}')" data-item-id="${c.id}">
              <div class="list-item-icon" style="background: rgba(249, 203, 0, 0.15); color: var(--gold-primary);">
                ${c.avatar_url
                  ? `<img src="${c.avatar_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`
                  : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>`
                }
              </div>
              <div class="list-item-content">
                <div class="list-item-title">
                  ${escapeHtml(c.name)}
                  <span style="display: inline-block; padding: 2px 8px; font-size: 10px; font-weight: 600; border-radius: 10px; margin-left: 8px; background: ${c._sourceColor}20; color: ${c._sourceColor};">${c._sourceLabel}</span>
                </div>
                <div class="list-item-subtitle">${escapeHtml(c.email || 'No email')} ${c.phone ? '· ' + escapeHtml(c.phone) : ''}</div>
                <div class="list-item-subtitle" style="margin-top: 2px;">
                  ${escapeHtml(c.city || '')}${c.state ? ', ' + escapeHtml(c.state) : ''}
                  ${c.account_type ? `<span style="color: var(--text-muted); margin-left: 8px;">${c.account_type}</span>` : ''}
                </div>
              </div>
              <div class="list-item-meta">
                <div style="font-weight: 700; font-size: 15px; color: var(--gold-primary); margin-bottom: 4px;">$${totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                <span class="badge-modern" style="background: ${ordersColor}20; color: ${ordersColor};">${ordersCount} orders</span>
              </div>
            </div>
          `;}).join('')}
        </div>
      `;

      // Update pagination
      const totalPages = Math.ceil(filtered.length / customersPageSize);
      document.getElementById('customers-page-info').textContent = `Showing ${start + 1}-${Math.min(end, filtered.length)} of ${filtered.length}`;
      document.getElementById('customers-prev-btn').disabled = customersPage === 1;
      document.getElementById('customers-next-btn').disabled = customersPage >= totalPages;
    }

    function customersPagePrev() {
      if (customersPage > 1) {
        customersPage--;
        renderCustomers();
      }
    }

    function customersPageNext() {
      const totalPages = Math.ceil(filteredCustomersList.length / customersPageSize);
      if (customersPage < totalPages) {
        customersPage++;
        renderCustomers();
      }
    }

    // Export customers to CSV
    function exportCustomersCSV() {
      if (filteredCustomersList.length === 0) {
        showToast('No customers to export', 'error');
        return;
      }

      const csv = [
        ['Name', 'Email', 'Phone', 'City', 'State', 'Total Spent', 'Orders', 'Source', 'Created'].join(','),
        ...filteredCustomersList.map(c => [
          `"${(c.name || '').replace(/"/g, '""')}"`,
          c.email || '',
          c.phone || '',
          `"${(c.city || '').replace(/"/g, '""')}"`,
          c.state || '',
          c.total_spent || 0,
          c.orders_count || 0,
          c._sourceLabel || '',
          c.created_at ? new Date(c.created_at).toLocaleDateString() : ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `customers-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Customers exported', 'success');
    }

    // Customer import modal
    function openCustomerImportModal() {
      const modal = document.createElement('div');
      modal.className = 'customer-import-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      modal.innerHTML = `
        <div style="background: var(--dark-surface); border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 18px; font-weight: 700;">Import Customers</h3>
            <button onclick="this.closest('.customer-import-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div style="padding: 24px;">
            <div style="border: 2px dashed var(--border-subtle); border-radius: 12px; padding: 32px; text-align: center; margin-bottom: 20px;">
              <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <p style="margin-bottom: 12px;">Upload a CSV file with your customers</p>
              <input type="file" id="customer-import-file" accept=".csv" style="display: none;" onchange="handleCustomerImport(this.files[0])">
              <button class="btn-modern primary" onclick="document.getElementById('customer-import-file').click()">Choose File</button>
            </div>
            <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
              <h4 style="margin-bottom: 12px; font-size: 14px;">Expected CSV Format</h4>
              <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 8px;">Include headers in first row:</p>
              <code style="display: block; background: var(--dark-surface); padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto;">
                name,email,phone,address,city,state,zip,notes
              </code>
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    async function handleCustomerImport(file) {
      if (!file) return;

      try {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim());

        if (lines.length < 2) {
          showToast('CSV file is empty', 'error');
          return;
        }

        const headers = lines[0].split(',').map(h => h.trim().toLowerCase().replace(/['"]/g, ''));
        const customers = [];

        for (let i = 1; i < lines.length; i++) {
          const values = lines[i].match(/(".*?"|[^,]+)/g)?.map(v => v.trim().replace(/^"|"$/g, '')) || [];
          if (values.length === 0) continue;

          const customer = {
            source: 'imported',
            created_at: new Date().toISOString()
          };

          headers.forEach((header, idx) => {
            const value = values[idx] || '';
            if (header.includes('name') || header === 'full_name') customer.name = value;
            else if (header.includes('email')) customer.email = value;
            else if (header.includes('phone')) customer.phone = value;
            else if (header.includes('address') && !header.includes('city')) customer.address = value;
            else if (header.includes('city')) customer.city = value;
            else if (header.includes('state')) customer.state = value;
            else if (header.includes('zip') || header.includes('postal')) customer.zip = value;
            else if (header.includes('note')) customer.notes = value;
          });

          if (customer.name || customer.email) {
            customers.push(customer);
          }
        }

        if (customers.length === 0) {
          showToast('No valid customers found in CSV', 'error');
          return;
        }

        // Insert into customers table (for imported clients)
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          const toInsert = customers.map(c => ({ ...c, user_id: user.id }));
          const { error } = await supabaseClient.from('customers').insert(toInsert);
          if (error) {
            console.error('Import error:', error);
            showToast('Error importing: ' + error.message, 'error');
            return;
          }
        }

        showToast(`${customers.length} customers imported!`, 'success');
        document.querySelector('.customer-import-modal')?.remove();

        // Reload customers
        customersLoaded = false;
        await loadCustomers();

      } catch (err) {
        console.error('Import error:', err);
        showToast('Error reading file', 'error');
      }
    }

    function searchCustomersPage() {
      customersPage = 1;
      renderCustomers();
    }

    async function viewCustomer(customerId) {
      selectedCustomer = allCustomers.find(c => c.id === customerId);
      if (!selectedCustomer) {
        // Try loading from database
        const { data } = await supabaseClient.from('customers').select('*').eq('id', customerId).single();
        if (data) selectedCustomer = data;
        else return;
      }

      // Update modal title
      document.getElementById('customer-detail-modal-title').textContent = selectedCustomer.name || 'Customer Details';

      // Render customer info
      document.getElementById('customer-info').innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div class="detail-row"><div class="detail-label">Email</div><div class="detail-value">${selectedCustomer.email ? `<a href="mailto:${selectedCustomer.email}" style="color: var(--gold-primary);">${selectedCustomer.email}</a>` : 'Not provided'}</div></div>
          <div class="detail-row"><div class="detail-label">Phone</div><div class="detail-value">${selectedCustomer.phone ? `<a href="tel:${selectedCustomer.phone}" style="color: var(--gold-primary);">${selectedCustomer.phone}</a>` : 'Not provided'}</div></div>
          <div class="detail-row"><div class="detail-label">Address</div><div class="detail-value">${selectedCustomer.address || '-'}</div></div>
          <div class="detail-row"><div class="detail-label">City/State/ZIP</div><div class="detail-value">${[selectedCustomer.city, selectedCustomer.state, selectedCustomer.zip].filter(Boolean).join(', ') || '-'}</div></div>
          <div class="detail-row"><div class="detail-label">Source</div><div class="detail-value">${selectedCustomer.source || 'Direct'}</div></div>
          <div class="detail-row"><div class="detail-label">Customer Since</div><div class="detail-value">${new Date(selectedCustomer.created_at).toLocaleDateString()}</div></div>
        </div>
      `;

      // Reset to jobs tab and load content
      currentCustomerTab = 'jobs';
      document.querySelectorAll('.customer-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === 'jobs');
      });
      loadCustomerTabContent('jobs');

      // Show modal
      document.getElementById('customer-modal').classList.add('active');
    }

    function closeCustomerModal() {
      document.getElementById('customer-modal').classList.remove('active');
      selectedCustomer = null;
    }

    // View Shopify customer details
    function viewShopifyCustomer(customerId) {
      const customer = allCustomers.find(c => c.id === customerId);
      if (!customer) return;

      const customerName = customer.name || [customer.first_name, customer.last_name].filter(Boolean).join(' ') || 'Unknown';
      const totalSpent = parseFloat(customer.total_spent || 0);
      const ordersCount = customer.orders_count || 0;
      const createdAt = customer.shopify_created_at || customer.created_at;

      const modal = document.createElement('div');
      modal.className = 'shopify-customer-modal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100001; padding: 20px;';
      modal.innerHTML = `
        <div style="background: var(--dark-surface); border-radius: 16px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border-subtle);">
            <h3 style="font-size: 18px; font-weight: 700;">${escapeHtml(customerName)}</h3>
            <button onclick="this.closest('.shopify-customer-modal').remove()" style="background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div style="padding: 24px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
              <div style="background: var(--dark-elevated); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${totalSpent.toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Total Spent</div>
              </div>
              <div style="background: var(--dark-elevated); padding: 16px; border-radius: 12px; text-align: center;">
                <div style="font-size: 24px; font-weight: 700; color: var(--success);">${ordersCount}</div>
                <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">Orders</div>
              </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Email</span>
                <span>${customer.email ? `<a href="mailto:${escapeHtml(customer.email)}" style="color: var(--gold-primary);">${escapeHtml(customer.email)}</a>` : '-'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Phone</span>
                <span>${customer.phone ? `<a href="tel:${escapeHtml(customer.phone)}" style="color: var(--gold-primary);">${escapeHtml(customer.phone)}</a>` : '-'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Location</span>
                <span>${[customer.city, customer.state, customer.zip].filter(Boolean).join(', ') || '-'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Address</span>
                <span style="text-align: right; max-width: 60%;">${escapeHtml(customer.address || '-')}</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Customer Since</span>
                <span>${createdAt ? new Date(createdAt).toLocaleDateString() : '-'}</span>
              </div>
              ${customer.tags ? `
              <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
                <span style="color: var(--text-muted);">Tags</span>
                <span>${escapeHtml(customer.tags)}</span>
              </div>
              ` : ''}
              ${customer.note ? `
              <div style="padding: 12px 0;">
                <div style="color: var(--text-muted); margin-bottom: 8px;">Notes</div>
                <div style="background: var(--dark-elevated); padding: 12px; border-radius: 8px; font-size: 14px;">${escapeHtml(customer.note)}</div>
              </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      document.body.appendChild(modal);
    }

    function showCustomerTab(tab) {
      currentCustomerTab = tab;
      document.querySelectorAll('.customer-tabs .tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      loadCustomerTabContent(tab);
    }

    async function loadCustomerTabContent(tab) {
      const container = document.getElementById('customer-tab-content');
      container.innerHTML = '<div class="empty-state"><div class="spinner"></div><p>Loading...</p></div>';

      if (!selectedCustomer) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        if (tab === 'jobs') {
          const { data: jobs } = await supabaseClient
            .from('projects')
            .select('*')
            .eq('customer_id', selectedCustomer.id)
            .order('created_at', { ascending: false });

          if (!jobs || jobs.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No jobs for this customer yet.</p>
                <button class="btn-modern primary" onclick="createJobForCustomer()" style="margin-top: 12px;">Create First Job</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Job #</th><th>Description</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                <tbody>
                  ${jobs.map(j => `
                    <tr style="cursor: pointer;" onclick="viewJob && viewJob('${j.id}')">
                      <td style="font-weight: 600;">${j.job_number || '-'}</td>
                      <td>${j.description || '-'}</td>
                      <td><span class="status-badge job-${j.status || 'new'}">${(j.status || 'new').replace('_', ' ')}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(j.total_price || 0).toFixed(2)}</td>
                      <td>${new Date(j.created_at).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'estimates') {
          const { data: estimates } = await supabaseClient
            .from('estimates')
            .select('*')
            .or(`customer_email.eq.${selectedCustomer.email},customer_id.eq.${selectedCustomer.id}`)
            .order('created_at', { ascending: false });

          if (!estimates || estimates.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No estimates for this customer yet.</p>
                <button class="btn-modern primary" onclick="createEstimateForCustomer()" style="margin-top: 12px;">Create Estimate</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Estimate #</th><th>Project</th><th>Status</th><th>Total</th><th>Date</th></tr></thead>
                <tbody>
                  ${estimates.map(e => `
                    <tr style="cursor: pointer;" onclick="viewEstimate && viewEstimate('${e.id}')">
                      <td style="font-weight: 600;">${e.estimate_number || 'Draft'}</td>
                      <td>${e.project_name || '-'}</td>
                      <td><span class="status-badge status-${e.status}">${e.status}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(e.total || 0).toFixed(2)}</td>
                      <td>${new Date(e.created_at).toLocaleDateString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'invoices') {
          const { data: invoices } = await supabaseClient
            .from('invoices')
            .select('*')
            .or(`customer_email.eq.${selectedCustomer.email},customer_id.eq.${selectedCustomer.id}`)
            .order('created_at', { ascending: false });

          if (!invoices || invoices.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <p>No invoices for this customer yet.</p>
                <button class="btn-modern primary" onclick="createInvoiceForCustomer()" style="margin-top: 12px;">Create Invoice</button>
              </div>
            `;
          } else {
            container.innerHTML = `
              <table>
                <thead><tr><th>Invoice #</th><th>Status</th><th>Amount</th><th>Due Date</th><th>Actions</th></tr></thead>
                <tbody>
                  ${invoices.map(inv => `
                    <tr>
                      <td style="font-weight: 600;">${inv.invoice_number || '-'}</td>
                      <td><span class="status-badge status-${inv.status === 'paid' ? 'won' : inv.status === 'open' ? 'new' : 'lost'}">${inv.status}</span></td>
                      <td style="color: var(--gold-primary); font-weight: 600;">$${(inv.amount_due || 0).toFixed(2)}</td>
                      <td>${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '-'}</td>
                      <td>
                        ${inv.stripe_hosted_url ? `<a href="${inv.stripe_hosted_url}" target="_blank" class="btn-modern secondary" style="padding: 4px 8px; font-size: 12px;">Pay</a>` : ''}
                        ${inv.stripe_pdf_url ? `<a href="${inv.stripe_pdf_url}" target="_blank" class="btn-modern secondary" style="padding: 4px 8px; font-size: 12px; margin-left: 4px;">PDF</a>` : ''}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          }
        } else if (tab === 'favorites') {
          // Load customer's favorites if they have a user account
          let favorites = [];

          // Try to find user by email
          if (selectedCustomer.email) {
            const { data: userData } = await supabaseClient
              .from('sg_users')
              .select('id')
              .eq('email', selectedCustomer.email)
              .single();

            if (userData) {
              const { data: favData } = await supabaseClient
                .from('user_favorites')
                .select('*')
                .eq('user_id', userData.id)
                .order('created_at', { ascending: false });

              favorites = favData || [];
            }
          }

          if (!favorites || favorites.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <p>No favorites found for this customer.</p>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Customer may not have an account or hasn't saved any favorites yet.</p>
              </div>
            `;
          } else {
            container.innerHTML = `
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                ${favorites.map(fav => `
                  <div class="favorite-card" style="background: var(--dark-elevated); border-radius: 12px; overflow: hidden; border: 1px solid var(--border-subtle);">
                    ${fav.image_url ? `<img src="${fav.image_url}" alt="${fav.product_name || 'Product'}" style="width: 100%; height: 120px; object-fit: cover;">` : `<div style="width: 100%; height: 120px; background: var(--dark-surface); display: flex; align-items: center; justify-content: center; color: var(--text-muted);"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>`}
                    <div style="padding: 12px;">
                      <div style="font-weight: 600; margin-bottom: 4px;">${fav.product_name || 'Unknown Product'}</div>
                      <div style="font-size: 12px; color: var(--text-muted);">${fav.product_type || fav.category || 'Material'}</div>
                      ${fav.product_url ? `<a href="${fav.product_url}" target="_blank" class="btn-modern secondary" style="margin-top: 8px; font-size: 12px; padding: 6px 10px;">View Product</a>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
              <p style="margin-top: 16px; font-size: 12px; color: var(--text-muted);">These are materials and products your customer has saved as favorites.</p>
            `;
          }
        } else if (tab === 'messages') {
          // Load messages/correspondence with this customer
          let messages = [];

          if (selectedCustomer.id) {
            const { data: msgData } = await supabaseClient
              .from('customer_messages')
              .select('*')
              .eq('customer_id', selectedCustomer.id)
              .order('created_at', { ascending: false });

            messages = msgData || [];
          }

          container.innerHTML = `
            <div style="display: flex; flex-direction: column; gap: 16px;">
              <!-- Message Input -->
              <div style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid var(--border-subtle);">
                <textarea id="new-customer-message" rows="3" placeholder="Type a message to this customer..." style="width: 100%; padding: 12px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); resize: vertical; margin-bottom: 12px;"></textarea>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn-modern secondary" onclick="sendCustomerEmail()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    Send Email
                  </button>
                  <button class="btn-modern primary" onclick="sendCustomerSMS()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    Send SMS
                  </button>
                </div>
              </div>

              <!-- Message History -->
              <div style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid var(--border-subtle);">
                <h4 style="margin-bottom: 12px; color: var(--text-secondary);">Message History</h4>
                ${messages.length === 0 ? `
                  <div class="empty-state" style="padding: 24px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="color: var(--text-muted); margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                    <p>No messages yet.</p>
                    <p style="font-size: 12px; color: var(--text-muted);">Send your first message to start the conversation.</p>
                  </div>
                ` : `
                  <div style="display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto;">
                    ${messages.map(msg => `
                      <div style="padding: 12px; background: var(--dark-surface); border-radius: 8px; border-left: 3px solid ${msg.direction === 'outbound' ? 'var(--gold-primary)' : '#3b82f6'};">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                          <span style="font-size: 12px; color: var(--text-muted);">${msg.direction === 'outbound' ? 'Sent' : 'Received'} via ${msg.channel || 'email'}</span>
                          <span style="font-size: 12px; color: var(--text-muted);">${new Date(msg.created_at).toLocaleString()}</span>
                        </div>
                        <div style="color: var(--text-primary);">${msg.message || msg.content || ''}</div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          `;
        } else if (tab === 'notes') {
          container.innerHTML = `
            <div style="padding: 16px;">
              <textarea id="customer-notes-edit" rows="6" style="width: 100%; padding: 12px; background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); resize: vertical;">${selectedCustomer.notes || ''}</textarea>
              <button class="btn-modern primary" onclick="saveCustomerNotes()" style="margin-top: 12px;">Save Notes</button>
            </div>
          `;
        }
      } catch (err) {
        console.error('Error loading tab content:', err);
        container.innerHTML = `<div class="empty-state"><p style="color: var(--error);">Error: ${escapeHtml(err.message || 'Unknown error')}</p></div>`;
      }
    }

    async function saveCustomerNotes() {
      if (!selectedCustomer) return;
      const notes = document.getElementById('customer-notes-edit')?.value || '';

      try {
        const { error } = await supabaseClient
          .from('customers')
          .update({ notes, updated_at: new Date().toISOString() })
          .eq('id', selectedCustomer.id);

        if (error) throw error;
        selectedCustomer.notes = notes;
        showToast('Notes saved!');
      } catch (err) {
        showToast('Error saving notes: ' + err.message, 'error');
      }
    }

    // Send email to customer
    async function sendCustomerEmail() {
      if (!selectedCustomer) return;

      const message = document.getElementById('new-customer-message')?.value?.trim();
      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }

      if (!selectedCustomer.email) {
        showToast('Customer has no email address', 'error');
        return;
      }

      try {
        // Log the message to database
        const { error } = await supabaseClient.from('customer_messages').insert({
          customer_id: selectedCustomer.id,
          sender_id: currentUser.id,
          direction: 'outbound',
          channel: 'email',
          message: message,
          sent_to: selectedCustomer.email,
          status: 'sent',
          created_at: new Date().toISOString()
        });

        if (error) throw error;

        // Open email client as fallback
        const subject = encodeURIComponent('Message from Surprise Granite');
        const body = encodeURIComponent(message);
        window.open(`mailto:${selectedCustomer.email}?subject=${subject}&body=${body}`, '_blank');

        document.getElementById('new-customer-message').value = '';
        showToast('Message logged! Email client opened.');
        loadCustomerTabContent('messages');
      } catch (err) {
        console.error('Email error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    // Send SMS to customer
    async function sendCustomerSMS() {
      if (!selectedCustomer) return;

      const message = document.getElementById('new-customer-message')?.value?.trim();
      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }

      if (!selectedCustomer.phone) {
        showToast('Customer has no phone number', 'error');
        return;
      }

      try {
        // Log the message to database
        const { error } = await supabaseClient.from('customer_messages').insert({
          customer_id: selectedCustomer.id,
          sender_id: currentUser.id,
          direction: 'outbound',
          channel: 'sms',
          message: message,
          sent_to: selectedCustomer.phone,
          status: 'sent',
          created_at: new Date().toISOString()
        });

        if (error) throw error;

        // Open SMS app as fallback (works on mobile)
        const smsBody = encodeURIComponent(message);
        window.open(`sms:${selectedCustomer.phone}?body=${smsBody}`, '_blank');

        document.getElementById('new-customer-message').value = '';
        showToast('Message logged! SMS app opened.');
        loadCustomerTabContent('messages');
      } catch (err) {
        console.error('SMS error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function openQuickAddCustomerModal() {
      selectedCustomer = null;
      document.getElementById('edit-customer-title').textContent = 'Add Customer';
      document.getElementById('edit-customer-form').reset();
      document.getElementById('edit-customer-modal').classList.add('active');
    }

    function editCustomer() {
      if (!selectedCustomer) return;
      document.getElementById('edit-customer-title').textContent = 'Edit Customer';

      // Populate form
      document.getElementById('customer-name').value = selectedCustomer.name || '';
      document.getElementById('customer-email').value = selectedCustomer.email || '';
      document.getElementById('customer-phone').value = selectedCustomer.phone || '';
      document.getElementById('customer-source').value = selectedCustomer.source || '';
      document.getElementById('customer-address').value = selectedCustomer.address || '';
      document.getElementById('customer-city').value = selectedCustomer.city || '';
      document.getElementById('customer-state').value = selectedCustomer.state || '';
      document.getElementById('customer-zip').value = selectedCustomer.zip || '';
      document.getElementById('customer-notes').value = selectedCustomer.notes || '';

      closeCustomerModal();
      document.getElementById('edit-customer-modal').classList.add('active');
    }

    function closeEditCustomerModal() {
      document.getElementById('edit-customer-modal').classList.remove('active');
    }

    async function saveCustomerForm(event) {
      event.preventDefault();

      const btn = document.getElementById('save-customer-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        const customerData = {
          user_id: user.id,
          name: document.getElementById('customer-name').value.trim(),
          email: document.getElementById('customer-email').value.trim() || null,
          phone: document.getElementById('customer-phone').value.trim() || null,
          source: document.getElementById('customer-source').value || null,
          address: document.getElementById('customer-address').value.trim() || null,
          city: document.getElementById('customer-city').value.trim() || null,
          state: document.getElementById('customer-state').value.trim() || null,
          zip: document.getElementById('customer-zip').value.trim() || null,
          notes: document.getElementById('customer-notes').value.trim() || null,
          updated_at: new Date().toISOString()
        };

        let result;
        if (selectedCustomer) {
          // Update existing
          result = await supabaseClient
            .from('customers')
            .update(customerData)
            .eq('id', selectedCustomer.id)
            .select()
            .single();
        } else {
          // Insert new
          result = await supabaseClient
            .from('customers')
            .insert([customerData])
            .select()
            .single();
        }

        if (result.error) throw result.error;

        closeEditCustomerModal();
        showToast(selectedCustomer ? 'Customer updated!' : 'Customer added!');
        await loadCustomers();

        // If we were viewing this customer, refresh the view
        if (selectedCustomer) {
          viewCustomer(result.data.id);
        }
      } catch (err) {
        console.error('Save customer error:', err);
        showToast('Error: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Customer';
      }
    }

    async function deleteCustomer() {
      if (!selectedCustomer) return;

      const confirmed = confirm(`Are you sure you want to delete this customer?\n\n${selectedCustomer.name}\n${selectedCustomer.email || ''}\n\nThis will NOT delete their jobs, estimates, or invoices.`);
      if (!confirmed) return;

      try {
        const { error } = await supabaseClient
          .from('customers')
          .delete()
          .eq('id', selectedCustomer.id);

        if (error) throw error;

        closeCustomerModal();
        allCustomers = allCustomers.filter(c => c.id !== selectedCustomer.id);
        updateCustomersCount();
        renderCustomers();
        showToast('Customer deleted');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    function createJobForCustomer() {
      if (!selectedCustomer) return;
      closeCustomerModal();
      showPage('jobs');

      setTimeout(() => {
        openNewJobModal(selectedCustomer);
      }, 100);
    }

    // Note: Main createEstimateForCustomer function is defined later with full implementation
    // This early reference is kept for code that runs before the full definition loads

    function quickNewJobForCustomer(customerId) {
      selectedCustomer = allCustomers.find(c => c.id === customerId);
      createJobForCustomer();
    }

    function quickNewEstimateForCustomer(customerId) {
      createEstimateForCustomer(customerId);
    }

    // Schedule appointment for customer
    function scheduleAppointmentForCustomer() {
      if (!selectedCustomer) {
        showToast('No customer selected', 'warning');
        return;
      }

      const customer = selectedCustomer;
      closeCustomerModal();
      showPage('calendar');

      setTimeout(() => {
        openCalendarEventModal(null, null, {
          title: `Appointment - ${customer.name || customer.email || 'Customer'}`,
          type: 'appointment',
          contactName: customer.name || '',
          contactEmail: customer.email || '',
          contactPhone: customer.phone || '',
          location: formatAddressFromData(customer),
          customerId: customer.id
        });
      }, 200);
    }

    // Close modals on overlay click
    document.getElementById('customer-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeCustomerModal();
    });
    document.getElementById('edit-customer-modal')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) closeEditCustomerModal();
    });

    // Admin Users Functions
    let adminUsers = [];

    async function loadAdminUsers() {
      try {
        const { data, error } = await supabaseClient
          .from('sg_users')
          .select('*')
          .or('account_type.eq.admin,account_type.eq.super_admin')
          .order('created_at', { ascending: false });

        if (error) throw error;
        adminUsers = data || [];
        renderAdminUsers();
      } catch (err) {
        document.getElementById('admin-users-list').innerHTML = `<p style="color: var(--error);">Error: ${escapeHtml(err.message || 'Unknown error')}</p>`;
      }
    }

    function renderAdminUsers() {
      const allAdmins = [
        ...SUPER_ADMIN_EMAILS.map(email => ({ email, full_name: email.split('@')[0], isSuperAdmin: true })),
        ...adminUsers.filter(u => !SUPER_ADMIN_EMAILS.includes(u.email?.toLowerCase()))
      ];

      document.getElementById('admin-users-list').innerHTML = `
        <table style="width: 100%;">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allAdmins.map(user => `
              <tr>
                <td>${user.email}</td>
                <td>${user.full_name || '-'}</td>
                <td><span class="status-badge ${user.isSuperAdmin ? 'status-won' : 'status-qualified'}">${user.isSuperAdmin ? 'Super Admin' : 'Admin'}</span></td>
                <td style="text-align: right;">
                  ${user.isSuperAdmin ? '<span style="color: var(--text-muted); font-size: 12px;">Protected</span>' :
                    `<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="removeAdminUser('${user.id}', '${user.email}')">Remove</button>`}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function addAdminUser() {
      const email = document.getElementById('new-admin-email').value.trim().toLowerCase();
      if (!email || !email.includes('@')) {
        alert('Please enter a valid email');
        return;
      }

      if (SUPER_ADMIN_EMAILS.includes(email)) {
        alert('Already a super admin');
        return;
      }

      try {
        const { data: existing } = await supabaseClient.from('sg_users').select('*').eq('email', email).single();

        if (existing) {
          await supabaseClient.from('sg_users').update({ account_type: 'admin' }).eq('id', existing.id);
        } else {
          await supabaseClient.from('sg_users').insert([{ email, account_type: 'admin', full_name: email.split('@')[0] }]);
        }

        document.getElementById('new-admin-email').value = '';
        loadAdminUsers();
        alert(`Admin access granted to ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeAdminUser(userId, email) {
      if (!confirm(`Remove admin access for ${email}?`)) return;

      try {
        await supabaseClient.from('sg_users').update({ account_type: 'homeowner' }).eq('id', userId);
        loadAdminUsers();
        alert(`Admin removed: ${email}`);
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Global keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape closes modals
      if (e.key === 'Escape') {
        closeLeadModal();
        closeProductModal();
        closeInvoiceModal();
      }

      // Don't trigger shortcuts when typing in inputs
      const activeEl = document.activeElement;
      const isTyping = activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.isContentEditable);
      if (isTyping) return;

      // Keyboard navigation shortcuts (no modifiers = page navigation)
      if (!e.ctrlKey && !e.metaKey && !e.altKey) {
        switch(e.key) {
          case 'd': case 'D': showPage('dashboard'); break;
          case 'l': case 'L': showPage('leads'); break;
          case 'p': case 'P': showPage('projects'); break;
          case 'c': case 'C': showPage('calendar'); break;
          case 'f': case 'F': showPage('finance'); break;
        }
      }

      // Action shortcuts (Ctrl/Cmd + key)
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'n': case 'N':
            e.preventDefault();
            openAddLeadModal();
            break;
          case 'k': case 'K':
            e.preventDefault();
            // Global search focus (if exists)
            const searchInput = document.querySelector('.topbar-search input, #global-search');
            if (searchInput) searchInput.focus();
            break;
        }
      }

      // Shift shortcuts for quick actions
      if (e.shiftKey && !e.ctrlKey && !e.metaKey) {
        switch(e.key) {
          case 'E': case 'e':
            e.preventDefault();
            openCalendarEventModal && openCalendarEventModal();
            break;
          case 'I': case 'i':
            e.preventDefault();
            openInvoiceModal && openInvoiceModal();
            break;
          case 'P': case 'p':
            e.preventDefault();
            openNewProjectModal && openNewProjectModal();
            break;
          case '?':
            e.preventDefault();
            showKeyboardShortcuts && showKeyboardShortcuts();
            break;
        }
      }

      // ? without shift also shows help
      if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
        e.preventDefault();
        showKeyboardShortcuts && showKeyboardShortcuts();
      }
    });

    document.getElementById('lead-modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeLeadModal();
    });

    // ============ PRODUCT MANAGEMENT (Shopify Products) ============
    let allProducts = [];
    let filteredProducts = [];
    let selectedProducts = new Set();
    let productsPage = 1;
    const productsPageSize = 50;
    let productsSearchTerm = '';
    let productsStatusFilter = 'all';
    let productsVendorFilter = '';
    let productsTypeFilter = '';
    let productsLoaded = false;
    let editingProduct = null;

    async function loadProducts() {
      if (productsLoaded) return;

      const loadingEl = document.getElementById('products-loading');
      const emptyEl = document.getElementById('products-empty');
      const tableEl = document.getElementById('products-table-container');

      try {
        // Load ALL products from shopify_products
        const { data, error } = await supabaseClient
          .from('shopify_products')
          .select('*')
          .order('name');

        if (error) throw error;

        allProducts = data || [];
        filteredProducts = [...allProducts];
        productsLoaded = true;

        loadingEl.style.display = 'none';

        // Update stats
        updateProductStats();

        // Populate vendor/type filters
        populateProductFilters();

        // Setup search
        setupProductsSearch();

        // Setup dropship toggle handler
        document.getElementById('product-dropship')?.addEventListener('change', (e) => {
          document.getElementById('product-supplier-group').style.display = e.target.checked ? 'block' : 'none';
        });

        if (allProducts.length === 0) {
          emptyEl.style.display = 'block';
          tableEl.style.display = 'none';
        } else {
          emptyEl.style.display = 'none';
          tableEl.style.display = 'block';
          renderProductsTable();
        }
      } catch (err) {
        console.error('Error loading products:', err);
        loadingEl.innerHTML = '<p style="color: var(--error);">Error loading products. Please try again.</p>';
      }
    }

    function updateProductStats() {
      const total = allProducts.length;
      const active = allProducts.filter(p => p.status === 'active').length;
      const draft = allProducts.filter(p => p.status === 'draft').length;
      const lowStock = allProducts.filter(p => p.inventory_quantity !== null && p.inventory_quantity <= 5).length;
      const discontinued = allProducts.filter(p => p.status === 'discontinued').length;

      document.getElementById('stat-total-products').textContent = total.toLocaleString();
      document.getElementById('stat-active-products').textContent = active.toLocaleString();
      document.getElementById('stat-draft-products').textContent = draft.toLocaleString();
      document.getElementById('stat-lowstock-products').textContent = lowStock.toLocaleString();

      // Update filter counts
      document.getElementById('products-count-all').textContent = total;
      document.getElementById('products-count-active').textContent = active;
      document.getElementById('products-count-draft').textContent = draft;
      document.getElementById('products-count-discontinued').textContent = discontinued;
    }

    function populateProductFilters() {
      // Vendors
      const vendors = [...new Set(allProducts.map(p => p.vendor).filter(Boolean))].sort();
      const vendorSelect = document.getElementById('products-vendor-filter');
      if (vendorSelect) {
        vendorSelect.innerHTML = '<option value="">All Vendors</option>' +
          vendors.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      }

      // Types
      const types = [...new Set(allProducts.map(p => p.product_type).filter(Boolean))].sort();
      const typeSelect = document.getElementById('products-type-filter');
      if (typeSelect) {
        typeSelect.innerHTML = '<option value="">All Types</option>' +
          types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
      }
    }

    function setupProductsSearch() {
      const searchInput = document.getElementById('products-search');
      if (!searchInput) return;
      let timeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          productsSearchTerm = e.target.value.toLowerCase();
          filterProductsList();
        }, 300);
      });
    }

    function filterProductsByStatus(status) {
      productsStatusFilter = status;
      document.querySelectorAll('[data-product-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.productStatus === status);
      });
      productsPage = 1;
      filterProductsList();
    }

    function filterProductsList() {
      productsVendorFilter = document.getElementById('products-vendor-filter')?.value || '';
      productsTypeFilter = document.getElementById('products-type-filter')?.value || '';

      filteredProducts = allProducts.filter(p => {
        // Status filter
        if (productsStatusFilter !== 'all' && p.status !== productsStatusFilter) return false;

        // Vendor filter
        if (productsVendorFilter && p.vendor !== productsVendorFilter) return false;

        // Type filter
        if (productsTypeFilter && p.product_type !== productsTypeFilter) return false;

        // Search
        if (productsSearchTerm) {
          const searchable = `${p.name || ''} ${p.sku || ''} ${p.vendor || ''} ${p.product_type || ''}`.toLowerCase();
          if (!searchable.includes(productsSearchTerm)) return false;
        }

        return true;
      });

      productsPage = 1;
      renderProductsTable();
    }

    function renderProductsTable() {
      const tbody = document.getElementById('products-table-body');
      const emptyEl = document.getElementById('products-empty');
      const tableEl = document.getElementById('products-table-container');

      if (filteredProducts.length === 0) {
        tbody.innerHTML = '';
        tableEl.style.display = 'none';
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';
      tableEl.style.display = 'block';

      const start = (productsPage - 1) * productsPageSize;
      const end = start + productsPageSize;
      const pageProducts = filteredProducts.slice(start, end);
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        // Mobile card view
        tbody.innerHTML = pageProducts.map(p => `
          <div class="product-card-mobile" style="display: block; margin-bottom: 12px;">
            <div class="product-card-mobile-header">
              <input type="checkbox" data-id="${p.id}"
                ${selectedProducts.has(p.id) ? 'checked' : ''}
                onchange="toggleProductSelect('${p.id}')"
                style="accent-color: var(--gold-primary); width: 20px; height: 20px; margin-right: 8px;">
              <img src="${p.image_url || 'https://via.placeholder.com/60x60?text=No+Image'}"
                   class="product-card-mobile-image"
                   onerror="this.src='https://via.placeholder.com/60x60?text=No+Image'">
              <div class="product-card-mobile-info">
                <div class="product-card-mobile-name">${escapeHtml(p.name || '')}</div>
                <div class="product-card-mobile-meta">${escapeHtml(p.vendor || 'No vendor')} ${p.sku ? '• ' + escapeHtml(p.sku) : ''}</div>
              </div>
            </div>
            <div class="product-card-mobile-row">
              <span class="product-card-mobile-label">Price</span>
              <span class="product-card-mobile-value" style="color: var(--gold-primary);">$${parseFloat(p.price || 0).toFixed(2)}</span>
            </div>
            <div class="product-card-mobile-row">
              <span class="product-card-mobile-label">Stock</span>
              <span class="product-card-mobile-value" style="color: ${p.inventory_quantity !== null && p.inventory_quantity <= 5 ? 'var(--error)' : 'var(--success)'};">
                ${p.inventory_quantity !== null ? p.inventory_quantity : '-'}
              </span>
            </div>
            <div class="product-card-mobile-row">
              <span class="product-card-mobile-label">Status</span>
              <span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; text-transform: capitalize;
                background: ${p.status === 'active' ? 'rgba(34, 197, 94, 0.15)' : p.status === 'draft' ? 'rgba(156, 163, 175, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                color: ${p.status === 'active' ? '#4ade80' : p.status === 'draft' ? '#9ca3af' : '#f87171'};">
                ${escapeHtml(p.status || 'draft')}
              </span>
              ${p.is_dropship ? '<span style="display: inline-block; padding: 2px 6px; background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 4px;">DS</span>' : ''}
            </div>
            <div class="product-card-mobile-actions">
              <button onclick="editProduct('${p.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Edit
              </button>
              <button class="danger" onclick="deleteProduct('${p.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Delete
              </button>
            </div>
          </div>
        `).join('');
      } else {
        // Desktop table view
        tbody.innerHTML = pageProducts.map(p => `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <input type="checkbox" class="product-row-checkbox" data-id="${p.id}"
                ${selectedProducts.has(p.id) ? 'checked' : ''}
                onchange="toggleProductSelect('${p.id}')"
                style="accent-color: var(--gold-primary);">
            </td>
            <td style="padding: 12px 16px;">
              <img src="${p.image_url || 'https://via.placeholder.com/50x50?text=No+Image'}"
                   alt="" style="width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: var(--dark-surface);"
                   onerror="this.src='https://via.placeholder.com/50x50?text=No+Image'">
            </td>
            <td style="padding: 12px 16px;">
              <div style="font-weight: 600; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(p.name || '')}</div>
              <div style="font-size: 13px; color: var(--text-muted);">${escapeHtml(p.vendor || '-')}</div>
            </td>
            <td style="padding: 12px 16px; font-family: monospace; font-size: 13px; color: var(--text-secondary);">${escapeHtml(p.sku || '-')}</td>
            <td style="padding: 12px 16px; font-weight: 600;">$${parseFloat(p.price || 0).toFixed(2)}</td>
            <td style="padding: 12px 16px;">
              <span style="font-weight: 600; color: ${p.inventory_quantity !== null && p.inventory_quantity <= 5 ? 'var(--error)' : 'var(--success)'};">
                ${p.inventory_quantity !== null ? p.inventory_quantity : '-'}
              </span>
            </td>
            <td style="padding: 12px 16px;">
              <span style="display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; text-transform: capitalize;
                background: ${p.status === 'active' ? 'rgba(34, 197, 94, 0.15)' : p.status === 'draft' ? 'rgba(156, 163, 175, 0.15)' : 'rgba(239, 68, 68, 0.15)'};
                color: ${p.status === 'active' ? '#4ade80' : p.status === 'draft' ? '#9ca3af' : '#f87171'};">
                ${escapeHtml(p.status || 'draft')}
              </span>
              ${p.is_dropship ? '<span style="display: inline-block; padding: 2px 6px; background: rgba(59, 130, 246, 0.15); color: #60a5fa; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 4px;">DS</span>' : ''}
            </td>
            <td style="padding: 12px 16px;">
              <div style="display: flex; gap: 8px;">
                <button onclick="editProduct('${p.id}')" title="Edit" style="padding: 8px; border-radius: 6px; border: none; background: transparent; color: var(--text-muted); cursor: pointer;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button onclick="deleteProduct('${p.id}')" title="Delete" style="padding: 8px; border-radius: 6px; border: none; background: transparent; color: var(--error); cursor: pointer;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `).join('');
      }

      // Update pagination
      const totalPages = Math.ceil(filteredProducts.length / productsPageSize);
      document.getElementById('products-page-info').textContent = `Showing ${start + 1}-${Math.min(end, filteredProducts.length)} of ${filteredProducts.length}`;
      document.getElementById('products-prev-btn').disabled = productsPage === 1;
      document.getElementById('products-next-btn').disabled = productsPage >= totalPages;

      updateProductsBulkActions();
    }

    // Re-render on resize for responsive view
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        if (productsLoaded) renderProductsTable();
      }, 250);
    });

    function productsPagePrev() {
      if (productsPage > 1) {
        productsPage--;
        renderProductsTable();
      }
    }

    function productsPageNext() {
      const totalPages = Math.ceil(filteredProducts.length / productsPageSize);
      if (productsPage < totalPages) {
        productsPage++;
        renderProductsTable();
      }
    }

    // Selection functions
    function toggleProductSelect(id) {
      if (selectedProducts.has(id)) {
        selectedProducts.delete(id);
      } else {
        selectedProducts.add(id);
      }
      updateProductsBulkActions();
    }

    function toggleAllProducts() {
      const checkbox = document.getElementById('products-select-all');
      const start = (productsPage - 1) * productsPageSize;
      const end = start + productsPageSize;
      const pageProducts = filteredProducts.slice(start, end);

      if (checkbox.checked) {
        pageProducts.forEach(p => selectedProducts.add(p.id));
      } else {
        pageProducts.forEach(p => selectedProducts.delete(p.id));
      }
      renderProductsTable();
    }

    function clearProductSelection() {
      selectedProducts.clear();
      document.getElementById('products-select-all').checked = false;
      renderProductsTable();
    }

    function updateProductsBulkActions() {
      const bulkActions = document.getElementById('products-bulk-actions');
      const count = selectedProducts.size;
      document.getElementById('products-selected-count').textContent = count;
      bulkActions.style.display = count > 0 ? 'flex' : 'none';
    }

    // Bulk actions
    async function bulkUpdateProducts(status) {
      if (selectedProducts.size === 0) return;

      try {
        const ids = Array.from(selectedProducts);
        const { error } = await supabaseClient
          .from('shopify_products')
          .update({ status, updated_at: new Date().toISOString() })
          .in('id', ids);

        if (error) throw error;

        showToast(`${ids.length} products updated to ${status}`, 'success');
        clearProductSelection();
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Bulk update error:', err);
        showToast('Error updating products', 'error');
      }
    }

    async function bulkDeleteProducts() {
      if (selectedProducts.size === 0) return;
      if (!confirm(`Are you sure you want to delete ${selectedProducts.size} products? This cannot be undone.`)) return;

      try {
        const ids = Array.from(selectedProducts);
        const { error } = await supabaseClient
          .from('shopify_products')
          .delete()
          .in('id', ids);

        if (error) throw error;

        showToast(`${ids.length} products deleted`, 'success');
        clearProductSelection();
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Bulk delete error:', err);
        showToast('Error deleting products', 'error');
      }
    }

    // Open modal for create/edit
    function openProductModal(product = null) {
      editingProduct = product;
      const modal = document.getElementById('product-modal');
      const title = document.getElementById('product-modal-title');
      const form = document.getElementById('product-form');

      title.textContent = product ? 'Edit Product' : 'Add New Product';
      form.reset();
      document.getElementById('product-id').value = '';
      document.getElementById('product-supplier-group').style.display = 'none';

      if (product) {
        document.getElementById('product-id').value = product.id;
        document.getElementById('product-name').value = product.name || '';
        document.getElementById('product-sku').value = product.sku || '';
        document.getElementById('product-vendor').value = product.vendor || '';
        document.getElementById('product-type').value = product.product_type || '';
        document.getElementById('product-description').value = product.description || '';
        document.getElementById('product-price').value = product.price || '';
        document.getElementById('product-compare-price').value = product.compare_at_price || '';
        document.getElementById('product-cost').value = product.cost_price || '';
        document.getElementById('product-stock').value = product.inventory_quantity || 0;
        document.getElementById('product-status').value = product.status || 'draft';
        document.getElementById('product-dropship').checked = product.is_dropship || false;
        document.getElementById('product-supplier').value = product.supplier_name || '';
        document.getElementById('product-image-url').value = product.image_url || '';
        document.getElementById('product-tags').value = Array.isArray(product.tags) ? product.tags.join(', ') : (product.tags || '');

        if (product.is_dropship) {
          document.getElementById('product-supplier-group').style.display = 'block';
        }
      }

      modal.classList.add('active');
    }

    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('active');
      editingProduct = null;
    }

    function editProduct(id) {
      const product = allProducts.find(p => p.id === id);
      if (product) {
        openProductModal(product);
      }
    }

    async function saveProduct(e) {
      e.preventDefault();
      const btn = document.getElementById('product-save-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const productId = document.getElementById('product-id').value;
      const tagsInput = document.getElementById('product-tags').value;
      const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(Boolean) : [];

      const productData = {
        name: document.getElementById('product-name').value,
        sku: document.getElementById('product-sku').value || null,
        vendor: document.getElementById('product-vendor').value || null,
        product_type: document.getElementById('product-type').value || null,
        description: document.getElementById('product-description').value || null,
        price: parseFloat(document.getElementById('product-price').value) || 0,
        compare_at_price: parseFloat(document.getElementById('product-compare-price').value) || null,
        cost_price: parseFloat(document.getElementById('product-cost').value) || null,
        inventory_quantity: parseInt(document.getElementById('product-stock').value) || 0,
        status: document.getElementById('product-status').value,
        is_dropship: document.getElementById('product-dropship').checked,
        supplier_name: document.getElementById('product-supplier').value || null,
        image_url: document.getElementById('product-image-url').value || null,
        tags: tags,
        updated_at: new Date().toISOString()
      };

      try {
        if (productId) {
          // Update existing
          const { error } = await supabaseClient
            .from('shopify_products')
            .update(productData)
            .eq('id', productId);
          if (error) throw error;
          showToast('Product updated successfully', 'success');
        } else {
          // Create new - generate handle from name
          productData.handle = productData.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
          productData.created_at = new Date().toISOString();

          const { error } = await supabaseClient
            .from('shopify_products')
            .insert([productData]);
          if (error) throw error;
          showToast('Product created successfully', 'success');
        }

        closeProductModal();
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Save error:', err);
        showToast('Error saving product: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Product';
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const { error } = await supabaseClient
          .from('shopify_products')
          .delete()
          .eq('id', id);
        if (error) throw error;

        showToast('Product deleted', 'success');
        productsLoaded = false;
        await loadProducts();
      } catch (err) {
        console.error('Delete error:', err);
        showToast('Error deleting product: ' + err.message, 'error');
      }
    }

    function exportProductsCSV() {
      if (filteredProducts.length === 0) {
        showToast('No products to export', 'error');
        return;
      }

      const csv = [
        ['Name', 'SKU', 'Vendor', 'Type', 'Price', 'Stock', 'Status', 'Dropship', 'Shopify ID'].join(','),
        ...filteredProducts.map(p => [
          `"${(p.name || '').replace(/"/g, '""')}"`,
          p.sku || '',
          `"${(p.vendor || '').replace(/"/g, '""')}"`,
          `"${(p.product_type || '').replace(/"/g, '""')}"`,
          p.price || 0,
          p.inventory_quantity || 0,
          p.status || '',
          p.is_dropship ? 'Yes' : 'No',
          p.shopify_id || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `products-export-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Products exported', 'success');
    }

    // Load products when showing products page
    const originalShowPage = showPage;
    showPage = async function(page) {
      await originalShowPage(page);
      if (page === 'products') {
        await loadProducts();
      }
    };

    // Product modal click-outside to close
    document.getElementById('product-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeProductModal();
    });

    // ============ PRODUCT IMPORT ============
    let importData = [];
    let importHeaders = [];
    let importMapping = {};

    function openImportModal() {
      document.getElementById('import-modal').classList.add('active');
      resetImport();
    }

    function closeImportModal() {
      document.getElementById('import-modal').classList.remove('active');
      resetImport();
    }

    function resetImport() {
      importData = [];
      importHeaders = [];
      importMapping = {};
      document.getElementById('import-step-1').style.display = 'block';
      document.getElementById('import-step-2').style.display = 'none';
      document.getElementById('import-step-3').style.display = 'none';
      document.getElementById('import-step-4').style.display = 'none';
      document.getElementById('import-footer').style.display = 'flex';
      document.getElementById('import-btn').disabled = true;
      document.getElementById('import-file-input').value = '';
    }

    // Setup drag and drop
    document.addEventListener('DOMContentLoaded', () => {
      const dropzone = document.getElementById('import-dropzone');
      if (!dropzone) return;

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, (e) => {
          e.preventDefault();
          e.stopPropagation();
        });
      });

      ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.style.borderColor = 'var(--gold-primary)';
          dropzone.style.background = 'rgba(249, 203, 0, 0.05)';
        });
      });

      ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, () => {
          dropzone.style.borderColor = 'var(--border-subtle)';
          dropzone.style.background = 'transparent';
        });
      });

      dropzone.addEventListener('drop', (e) => {
        const file = e.dataTransfer.files[0];
        if (file) handleImportFile(file);
      });
    });

    async function handleImportFile(file) {
      if (!file) return;

      const fileName = file.name.toLowerCase();

      if (fileName.endsWith('.csv')) {
        await parseCSV(file);
      } else if (fileName.endsWith('.pdf')) {
        await parsePDF(file);
      } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        await parseExcel(file);
      } else {
        showToast('Unsupported file format. Please use CSV, PDF, or Excel.', 'error');
        return;
      }
    }

    async function parseCSV(file) {
      const text = await file.text();
      const lines = text.split(/\r?\n/).filter(line => line.trim());

      if (lines.length < 2) {
        showToast('CSV file is empty or has no data rows', 'error');
        return;
      }

      // Parse headers
      importHeaders = parseCSVLine(lines[0]);

      // Parse data rows
      importData = [];
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.some(v => v.trim())) {
          const row = {};
          importHeaders.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          importData.push(row);
        }
      }

      showMappingStep(file.name);
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        const nextChar = line[i + 1];

        if (char === '"' && inQuotes && nextChar === '"') {
          current += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    async function parsePDF(file) {
      showToast('Processing PDF...', 'info');

      // Load PDF.js if not already loaded
      if (!window.pdfjsLib) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          fullText += pageText + '\n';
        }

        // Try to extract tabular data from PDF text
        const extractedData = extractPDFData(fullText);

        if (extractedData.length === 0) {
          showToast('Could not extract product data from PDF. Try CSV format instead.', 'error');
          return;
        }

        importHeaders = Object.keys(extractedData[0]);
        importData = extractedData;
        showMappingStep(file.name);
      } catch (err) {
        console.error('PDF parse error:', err);
        showToast('Error reading PDF file. Try CSV format instead.', 'error');
      }
    }

    function extractPDFData(text) {
      // Try to find patterns like SKU, prices, product names
      const lines = text.split(/\n/).filter(l => l.trim());
      const products = [];

      // Pattern matching for common product list formats
      // Look for lines with prices (contains $ or numeric values)
      const pricePattern = /\$?\d+\.?\d{0,2}/g;
      const skuPattern = /[A-Z0-9]{3,}[-_]?[A-Z0-9]*/gi;

      for (const line of lines) {
        const prices = line.match(pricePattern);
        const skus = line.match(skuPattern);

        if (prices && prices.length > 0) {
          // Extract what looks like a product line
          const cleanLine = line.replace(pricePattern, '|||PRICE|||').replace(skuPattern, '|||SKU|||');
          const parts = cleanLine.split(/\s{2,}|\t/).filter(p => p.trim());

          if (parts.length >= 1) {
            const product = {
              name: line.replace(pricePattern, '').replace(skuPattern, '').trim().substring(0, 200) || 'Unknown Product',
              price: prices[0]?.replace('$', '') || '',
              sku: skus?.[0] || ''
            };
            if (product.name && product.name !== 'Unknown Product') {
              products.push(product);
            }
          }
        }
      }

      return products;
    }

    async function parseExcel(file) {
      showToast('Processing Excel file...', 'info');

      // Load SheetJS if not already loaded
      if (!window.XLSX) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
      }

      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        if (jsonData.length < 2) {
          showToast('Excel file is empty or has no data rows', 'error');
          return;
        }

        importHeaders = jsonData[0].map(h => String(h || '').trim());
        importData = [];

        for (let i = 1; i < jsonData.length; i++) {
          const row = {};
          importHeaders.forEach((header, idx) => {
            row[header] = jsonData[i][idx] !== undefined ? String(jsonData[i][idx]) : '';
          });
          if (Object.values(row).some(v => v.trim())) {
            importData.push(row);
          }
        }

        showMappingStep(file.name);
      } catch (err) {
        console.error('Excel parse error:', err);
        showToast('Error reading Excel file', 'error');
      }
    }

    function showMappingStep(fileName) {
      document.getElementById('import-step-1').style.display = 'none';
      document.getElementById('import-step-2').style.display = 'block';
      document.getElementById('import-file-info').textContent = `${importData.length} rows detected from ${fileName}`;

      // Auto-map columns based on common names
      const fieldMappings = {
        name: ['name', 'title', 'product', 'product_name', 'productname', 'item', 'item_name', 'description'],
        sku: ['sku', 'item_number', 'itemnumber', 'item_no', 'itemno', 'product_code', 'productcode', 'code', 'upc', 'part_number', 'partnumber'],
        price: ['price', 'cost', 'retail', 'retail_price', 'retailprice', 'unit_price', 'unitprice', 'amount', 'msrp'],
        vendor: ['vendor', 'supplier', 'brand', 'manufacturer', 'mfg', 'mfr'],
        inventory_quantity: ['quantity', 'stock', 'qty', 'inventory', 'in_stock', 'instock', 'available'],
        description: ['description', 'desc', 'details', 'notes', 'product_description'],
        product_type: ['type', 'category', 'product_type', 'producttype', 'material'],
        image_url: ['image', 'image_url', 'imageurl', 'photo', 'picture', 'img']
      };

      importMapping = {};
      const mappingGrid = document.getElementById('import-mapping-grid');
      mappingGrid.innerHTML = '';

      Object.entries(fieldMappings).forEach(([field, aliases]) => {
        // Find matching header
        const matchedHeader = importHeaders.find(h =>
          aliases.some(alias => h.toLowerCase().replace(/[^a-z0-9]/g, '').includes(alias.replace(/[^a-z0-9]/g, '')))
        );

        if (matchedHeader) {
          importMapping[field] = matchedHeader;
        }

        const fieldLabels = {
          name: 'Product Name *',
          sku: 'SKU',
          price: 'Price *',
          vendor: 'Vendor',
          inventory_quantity: 'Stock Quantity',
          description: 'Description',
          product_type: 'Product Type',
          image_url: 'Image URL'
        };

        mappingGrid.innerHTML += `
          <div style="display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 13px; font-weight: 500;">${fieldLabels[field]}</label>
            <select id="map-${field}" onchange="updateMapping('${field}', this.value)"
              style="padding: 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 13px;">
              <option value="">-- Skip --</option>
              ${importHeaders.map(h => `<option value="${escapeHtml(h)}" ${importMapping[field] === h ? 'selected' : ''}>${escapeHtml(h)}</option>`).join('')}
            </select>
          </div>
        `;
      });

      // Show preview
      updateImportPreview();

      // Enable import button if required fields are mapped
      validateMapping();
    }

    function updateMapping(field, value) {
      if (value) {
        importMapping[field] = value;
      } else {
        delete importMapping[field];
      }
      updateImportPreview();
      validateMapping();
    }

    function validateMapping() {
      const hasName = importMapping.name;
      const hasPrice = importMapping.price;
      document.getElementById('import-btn').disabled = !(hasName && hasPrice);
    }

    function updateImportPreview() {
      const thead = document.getElementById('import-preview-head');
      const tbody = document.getElementById('import-preview-body');

      const mappedFields = Object.entries(importMapping).filter(([_, v]) => v);

      thead.innerHTML = `<tr style="background: var(--dark-surface);">
        ${mappedFields.map(([field]) => `<th style="padding: 10px; text-align: left; font-size: 12px; text-transform: uppercase; color: var(--text-muted);">${field}</th>`).join('')}
      </tr>`;

      tbody.innerHTML = importData.slice(0, 5).map(row => `
        <tr style="border-bottom: 1px solid var(--border-subtle);">
          ${mappedFields.map(([field, header]) => `<td style="padding: 10px; font-size: 13px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(row[header] || '-')}</td>`).join('')}
        </tr>
      `).join('');
    }

    async function startImport() {
      document.getElementById('import-step-2').style.display = 'none';
      document.getElementById('import-step-3').style.display = 'block';
      document.getElementById('import-footer').style.display = 'none';

      const updateExisting = document.getElementById('import-update-existing').checked;
      const setActive = document.getElementById('import-set-active').checked;

      let imported = 0;
      let updated = 0;
      let errors = 0;
      const total = importData.length;

      for (let i = 0; i < importData.length; i++) {
        const row = importData[i];

        // Build product object from mapping
        const product = {
          name: row[importMapping.name] || 'Unknown Product',
          sku: row[importMapping.sku] || null,
          price: parseFloat(String(row[importMapping.price] || '0').replace(/[^0-9.]/g, '')) || 0,
          vendor: row[importMapping.vendor] || null,
          inventory_quantity: parseInt(row[importMapping.inventory_quantity]) || 0,
          description: row[importMapping.description] || null,
          product_type: row[importMapping.product_type] || null,
          image_url: row[importMapping.image_url] || null,
          status: setActive ? 'active' : 'draft',
          handle: (row[importMapping.name] || 'product').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, ''),
          updated_at: new Date().toISOString()
        };

        try {
          // Check if product exists by SKU
          if (updateExisting && product.sku) {
            const { data: existing } = await supabaseClient
              .from('shopify_products')
              .select('id')
              .eq('sku', product.sku)
              .single();

            if (existing) {
              // Update existing
              const { error } = await supabaseClient
                .from('shopify_products')
                .update(product)
                .eq('id', existing.id);

              if (error) throw error;
              updated++;
            } else {
              // Insert new
              product.created_at = new Date().toISOString();
              const { error } = await supabaseClient
                .from('shopify_products')
                .insert([product]);

              if (error) throw error;
              imported++;
            }
          } else {
            // Insert new
            product.created_at = new Date().toISOString();
            const { error } = await supabaseClient
              .from('shopify_products')
              .insert([product]);

            if (error) throw error;
            imported++;
          }
        } catch (err) {
          console.error('Import error for row:', row, err);
          errors++;
        }

        // Update progress
        const progress = Math.round(((i + 1) / total) * 100);
        document.getElementById('import-progress-bar').style.width = progress + '%';
        document.getElementById('import-progress-text').textContent = `${i + 1} of ${total} products processed`;
      }

      // Show complete step
      document.getElementById('import-step-3').style.display = 'none';
      document.getElementById('import-step-4').style.display = 'block';

      let message = `${imported} products imported`;
      if (updated > 0) message += `, ${updated} updated`;
      if (errors > 0) message += `, ${errors} errors`;
      document.getElementById('import-complete-text').textContent = message;

      // Refresh products list
      productsLoaded = false;
      await loadProducts();
    }

    // ============ INVOICE MANAGEMENT ============
    const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
      ? `http://${window.location.host}`
      : 'https://surprise-granite-email-api.onrender.com';
    const API_BASE = API_URL;

    // VoiceNow CRM API for payments, SMS, and advanced features
    const VOICENOW_API = 'https://voiceflow-crm.onrender.com';

    // Reusable API call helper - auto-includes Supabase JWT auth token
    async function apiCall(endpoint, options = {}) {
      // Skip API calls on static dev server (no backend)
      const isStaticServer = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      if (isStaticServer && endpoint.includes('/api/collaboration')) {
        return new Response(JSON.stringify({ collaborations: [] }), { status: 200 });
      }

      const { data: { session } } = await supabaseClient.auth.getSession();
      const token = session?.access_token;
      return fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
          ...(options.headers || {})
        }
      });
    }

    let allInvoices = [];
    let invoiceFilter = 'all';
    let invoiceItemCount = 1;

    async function loadInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) {
        console.warn('[Invoices] No invoices-list container found');
        return;
      }

      try {
        // Show loading state
        invoicesList.innerHTML = '<div class="empty-state"><p>Loading invoices...</p></div>';

        if (!supabaseClient) {
          console.error('[Invoices] supabaseClient not initialized');
          invoicesList.innerHTML = '<div class="empty-state"><p>Database connection not ready. Please refresh.</p></div>';
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        console.log('[Invoices] User:', user?.id);

        // Load from both Supabase (source of truth) and Stripe (supplementary) in parallel
        const [supabaseResult, stripeResult] = await Promise.all([
          supabaseClient
            .from('invoices')
            .select('*, invoice_items(*)')
            .eq('user_id', user?.id)
            .order('created_at', { ascending: false }),
          apiCall('/api/invoices?limit=100')
            .then(r => r.ok ? r.json() : { invoices: [] })
            .catch(err => {
              console.warn('[Invoices] Stripe fetch failed (non-fatal):', err.message);
              return { invoices: [] };
            })
        ]);

        if (supabaseResult.error) throw supabaseResult.error;

        // Map Supabase invoices
        const supabaseInvoices = (supabaseResult.data || []).map(inv => ({
          id: inv.id,
          number: inv.invoice_number,
          invoice_number: inv.invoice_number,
          customer_email: inv.customer_email,
          customer_name: inv.customer_name,
          status: inv.status === 'unpaid' ? 'open' : inv.status,
          total: inv.total || 0,
          amount_due: inv.amount_due || inv.total || 0,
          amount_paid: inv.amount_paid || 0,
          due_date: inv.due_date,
          created: new Date(inv.created_at).getTime() / 1000,
          created_at: inv.created_at,
          source: 'supabase',
          estimate_id: inv.estimate_id,
          stripe_invoice_id: inv.stripe_invoice_id,
          stripe_hosted_url: inv.stripe_hosted_url,
          stripe_pdf_url: inv.stripe_pdf_url,
          invoice_items: inv.invoice_items,
          view_count: inv.view_count || 0,
          deposit_requested: inv.deposit_requested || 0,
          deposit_paid: inv.deposit_paid || 0,
          deposit_paid_at: inv.deposit_paid_at,
          balance_due: inv.balance_due || inv.amount_due || inv.total || 0
        }));

        // Track Stripe IDs already in Supabase for deduplication
        const knownStripeIds = new Set(
          supabaseInvoices.map(inv => inv.stripe_invoice_id).filter(Boolean)
        );

        // Safe date conversion for Unix timestamps
        function safeISODate(ts) {
          if (!ts) return null;
          try {
            const d = new Date(typeof ts === 'number' ? ts * 1000 : ts);
            return isNaN(d.getTime()) ? null : d.toISOString();
          } catch { return null; }
        }

        // Map Stripe-only invoices (server already returns dollars and ISO dates)
        const stripeInvoices = (stripeResult.invoices || [])
          .filter(inv => inv.id && !knownStripeIds.has(inv.id))
          .map(inv => ({
            id: inv.id,
            number: inv.number || inv.id,
            invoice_number: inv.number || inv.id,
            customer_email: inv.customer_email || '',
            customer_name: inv.customer_name || '',
            status: inv.status || 'unknown',
            total: inv.total || 0,
            amount_due: inv.amount_due || 0,
            amount_paid: inv.amount_paid || 0,
            due_date: inv.due_date || null,
            created: inv.created ? new Date(inv.created).getTime() / 1000 : null,
            created_at: inv.created || null,
            source: 'stripe',
            stripe_invoice_id: inv.id,
            stripe_hosted_url: inv.hosted_invoice_url || null,
            stripe_pdf_url: inv.invoice_pdf || null,
            invoice_items: [],
            view_count: inv.view_count || 0
          }));

        // Merge: Supabase first (source of truth), then Stripe-only records
        allInvoices = [...supabaseInvoices, ...stripeInvoices];

        // Calculate and display accounting stats
        updateAccountingStats();

        renderInvoices();
      } catch (err) {
        console.error('Error loading invoices:', err);
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>Unable to Load Invoices</h3>
            <p>Please try again or create a new invoice.</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
      }
    }

    // Calculate and display accounting summary stats
    function updateAccountingStats() {
      const totalInvoiced = allInvoices.reduce((sum, inv) => sum + (inv.total || inv.amount_due || 0), 0);
      const totalPaid = allInvoices.reduce((sum, inv) => sum + (inv.amount_paid || (inv.status === 'paid' ? (inv.total || inv.amount_due || 0) : 0)), 0);
      const outstanding = allInvoices
        .filter(inv => inv.status !== 'paid' && inv.status !== 'void')
        .reduce((sum, inv) => sum + (inv.amount_due || inv.balance_due || inv.total || 0), 0);
      const depositsCollected = allInvoices.reduce((sum, inv) => sum + (inv.deposit_paid || 0), 0);

      const formatCurrency = (val) => '$' + val.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      const statTotalInvoiced = document.getElementById('stat-total-invoiced');
      const statTotalPaid = document.getElementById('stat-total-paid');
      const statOutstanding = document.getElementById('stat-outstanding');
      const statDeposits = document.getElementById('stat-deposits-collected');

      if (statTotalInvoiced) statTotalInvoiced.textContent = formatCurrency(totalInvoiced);
      if (statTotalPaid) statTotalPaid.textContent = formatCurrency(totalPaid);
      if (statOutstanding) statOutstanding.textContent = formatCurrency(outstanding);
      if (statDeposits) statDeposits.textContent = formatCurrency(depositsCollected);

      // Update aging report
      updateAgingReport();
    }

    // Calculate invoice aging buckets
    function updateAgingReport() {
      const now = new Date();
      const formatCurrency = (val) => '$' + val.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      // Filter unpaid invoices
      const unpaidInvoices = allInvoices.filter(inv =>
        inv.status !== 'paid' && inv.status !== 'void' && inv.status !== 'draft'
      );

      // Calculate days overdue for each invoice
      const aging = {
        current: { amount: 0, count: 0 },
        days30: { amount: 0, count: 0 },
        days60: { amount: 0, count: 0 },
        days90: { amount: 0, count: 0 }
      };

      unpaidInvoices.forEach(inv => {
        const dueDate = inv.due_date ? new Date(inv.due_date) : new Date(inv.created_at);
        const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
        const amount = inv.amount_due || inv.balance_due || inv.total || 0;

        if (daysOverdue <= 0) {
          aging.current.amount += amount;
          aging.current.count++;
        } else if (daysOverdue <= 30) {
          aging.days30.amount += amount;
          aging.days30.count++;
        } else if (daysOverdue <= 60) {
          aging.days60.amount += amount;
          aging.days60.count++;
        } else {
          aging.days90.amount += amount;
          aging.days90.count++;
        }
      });

      // Update UI
      const updateEl = (id, value) => {
        const el = document.getElementById(id);
        if (el) el.textContent = value;
      };

      updateEl('aging-current', formatCurrency(aging.current.amount));
      updateEl('aging-current-count', `${aging.current.count} invoice${aging.current.count !== 1 ? 's' : ''}`);
      updateEl('aging-30', formatCurrency(aging.days30.amount));
      updateEl('aging-30-count', `${aging.days30.count} invoice${aging.days30.count !== 1 ? 's' : ''}`);
      updateEl('aging-60', formatCurrency(aging.days60.amount));
      updateEl('aging-60-count', `${aging.days60.count} invoice${aging.days60.count !== 1 ? 's' : ''}`);
      updateEl('aging-90', formatCurrency(aging.days90.amount));
      updateEl('aging-90-count', `${aging.days90.count} invoice${aging.days90.count !== 1 ? 's' : ''}`);

      // Show/hide reminder button based on overdue count
      const overdueCount = aging.days30.count + aging.days60.count + aging.days90.count;
      const reminderBtn = document.getElementById('send-reminders-btn');
      if (reminderBtn) {
        reminderBtn.style.display = overdueCount > 0 ? 'inline-flex' : 'none';
      }
    }

    // Send payment reminders to all overdue invoices
    async function sendOverdueReminders() {
      const now = new Date();

      // Get all overdue invoices (past due date, not paid)
      const overdueInvoices = allInvoices.filter(inv => {
        if (inv.status === 'paid' || inv.status === 'void' || inv.status === 'draft') return false;
        const dueDate = inv.due_date ? new Date(inv.due_date) : null;
        if (!dueDate) return false;
        return now > dueDate && inv.customer_email;
      });

      if (overdueInvoices.length === 0) {
        showToast('No overdue invoices with email addresses', 'info');
        return;
      }

      if (!confirm(`Send payment reminders to ${overdueInvoices.length} overdue invoice${overdueInvoices.length > 1 ? 's' : ''}?`)) {
        return;
      }

      const btn = document.getElementById('send-reminders-btn');
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner" style="width: 14px; height: 14px;"></span> Sending...';

      let sent = 0;
      let failed = 0;

      for (const inv of overdueInvoices) {
        try {
          const dueDate = new Date(inv.due_date);
          const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));

          const response = await apiCall('/api/email/invoice-reminder', {
            method: 'POST',
            body: JSON.stringify({
              customer_email: inv.customer_email,
              customer_name: inv.customer_name || 'Valued Customer',
              invoice_number: inv.invoice_number || inv.number || inv.id.slice(-8),
              amount_due: inv.amount_due || inv.balance_due || inv.total,
              due_date: inv.due_date,
              days_overdue: daysOverdue,
              payment_url: inv.stripe_hosted_url || null
            })
          });

          if (response.ok) {
            sent++;
            // Update last reminder sent timestamp
            await supabaseClient
              .from('invoices')
              .update({ last_reminder_sent: new Date().toISOString() })
              .eq('id', inv.id);
          } else {
            failed++;
          }
        } catch (err) {
          console.error('Reminder error for invoice', inv.id, err);
          failed++;
        }
      }

      btn.disabled = false;
      btn.innerHTML = originalHtml;

      if (sent > 0) {
        showToast(`Sent ${sent} payment reminder${sent > 1 ? 's' : ''}${failed > 0 ? ` (${failed} failed)` : ''}`, 'success');
      } else {
        showToast('Failed to send reminders', 'error');
      }
    }

    // Export invoices to CSV
    function exportInvoicesCSV() {
      if (allInvoices.length === 0) {
        showToast('No invoices to export', 'warning');
        return;
      }

      // CSV headers
      const headers = [
        'Invoice Number',
        'Customer Name',
        'Customer Email',
        'Status',
        'Total',
        'Amount Paid',
        'Amount Due',
        'Deposit Requested',
        'Deposit Paid',
        'Due Date',
        'Created Date',
        'Paid Date'
      ];

      // CSV rows
      const rows = allInvoices.map(inv => [
        inv.invoice_number || inv.number || inv.id.slice(-8),
        (inv.customer_name || '').replace(/,/g, ' '),
        inv.customer_email || '',
        inv.status || '',
        (inv.total || 0).toFixed(2),
        (inv.amount_paid || 0).toFixed(2),
        (inv.amount_due || inv.balance_due || 0).toFixed(2),
        (inv.deposit_requested || 0).toFixed(2),
        (inv.deposit_paid || 0).toFixed(2),
        inv.due_date ? new Date(inv.due_date).toLocaleDateString() : '',
        inv.created_at ? new Date(inv.created_at).toLocaleDateString() : '',
        inv.paid_at ? new Date(inv.paid_at).toLocaleDateString() : ''
      ]);

      // Build CSV content
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      // Download file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `invoices_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      showToast(`Exported ${allInvoices.length} invoices to CSV`, 'success');
    }

    // Open payment history modal
    async function openPaymentHistoryModal() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Fetch all payments
        const { data: payments, error } = await supabaseClient
          .from('payments')
          .select('*, invoices(invoice_number, customer_name)')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (error) throw error;

        const modalHtml = `
          <div class="modal-overlay active" id="payment-history-modal" onclick="if(event.target===this) closePaymentHistoryModal()">
            <div class="modal" style="max-width: 700px; max-height: 80vh;">
              <div class="modal-header">
                <h2 class="modal-title">Payment History</h2>
                <button class="modal-close" onclick="closePaymentHistoryModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                ${payments && payments.length > 0 ? `
                  <div style="display: flex; flex-direction: column; gap: 12px;">
                    ${payments.map(p => `
                      <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; border: 1px solid var(--border-subtle);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                          <div>
                            <div style="font-weight: 600; font-size: 15px; color: #22c55e;">+$${(p.amount || 0).toFixed(2)}</div>
                            <div style="font-size: 13px; color: var(--text-muted);">${p.invoices?.customer_name || 'Unknown'} · Invoice #${p.invoices?.invoice_number || 'N/A'}</div>
                          </div>
                          <div style="text-align: right;">
                            <span style="display: inline-block; padding: 3px 8px; background: ${p.payment_type === 'deposit' ? 'rgba(249,203,0,0.2)' : 'rgba(34,197,94,0.2)'}; color: ${p.payment_type === 'deposit' ? '#f9cb00' : '#22c55e'}; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${p.payment_type || 'payment'}</span>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${p.payment_method || 'N/A'}</div>
                          </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                          ${new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' })}
                          ${p.notes ? ` · ${p.notes}` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                ` : `
                  <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="opacity: 0.3; margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                    <p>No payments recorded yet</p>
                  </div>
                `}
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (err) {
        console.error('Payment history error:', err);
        showToast('Error loading payment history', 'error');
      }
    }

    function closePaymentHistoryModal() {
      const modal = document.getElementById('payment-history-modal');
      if (modal) modal.remove();
    }

    // Record a general payment on an invoice
    async function recordPayment(invoiceId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get invoice details
        const { data: invoice, error: fetchError } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        if (fetchError) throw fetchError;

        const amountDue = invoice.amount_due || invoice.balance_due || invoice.total || 0;
        const amountPaid = invoice.amount_paid || 0;

        const modalHtml = `
          <div class="modal-overlay active" id="record-payment-modal" onclick="if(event.target===this) closeRecordPaymentModal()">
            <div class="modal" style="max-width: 450px;">
              <div class="modal-header">
                <h2 class="modal-title">Record Payment</h2>
                <button class="modal-close" onclick="closeRecordPaymentModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="modal-body">
                <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
                  <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Invoice #${invoice.invoice_number || invoice.number || invoice.id.slice(-8)}</div>
                  <div style="font-size: 15px; font-weight: 600; margin-bottom: 12px;">${invoice.customer_name || 'Customer'}</div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted);">Invoice Total</span>
                    <span style="font-weight: 600;">$${(invoice.total || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted);">Already Paid</span>
                    <span style="font-weight: 600; color: #22c55e;">$${amountPaid.toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                    <span style="color: var(--text-muted);">Balance Due</span>
                    <span style="font-weight: 700; color: var(--gold-primary);">$${amountDue.toFixed(2)}</span>
                  </div>
                </div>

                <div class="form-group">
                  <label>Payment Amount</label>
                  <input type="number" id="payment-amount-input" value="${amountDue.toFixed(2)}" min="0" step="0.01" style="font-size: 18px; font-weight: 600;"/>
                </div>

                <div class="form-group">
                  <label>Payment Method</label>
                  <select id="payment-method-select">
                    <option value="card">Credit/Debit Card</option>
                    <option value="cash">Cash</option>
                    <option value="check">Check</option>
                    <option value="transfer">Bank Transfer</option>
                    <option value="venmo">Venmo</option>
                    <option value="zelle">Zelle</option>
                    <option value="stripe">Stripe (Online)</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Notes (Optional)</label>
                  <input type="text" id="payment-notes-input" placeholder="e.g., Check #1234, Final payment"/>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn-modern secondary" onclick="closeRecordPaymentModal()">Cancel</button>
                <button class="btn-modern primary" onclick="savePayment('${invoiceId}')" style="background: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                  Record Payment
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (err) {
        console.error('Record payment error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function closeRecordPaymentModal() {
      const modal = document.getElementById('record-payment-modal');
      if (modal) modal.remove();
    }

    async function savePayment(invoiceId) {
      const paymentAmount = parseFloat(document.getElementById('payment-amount-input')?.value) || 0;
      const paymentMethod = document.getElementById('payment-method-select')?.value || 'other';
      const notes = document.getElementById('payment-notes-input')?.value || '';

      if (paymentAmount <= 0) {
        showToast('Please enter a valid payment amount', 'warning');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get current invoice
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        const previousPaid = invoice.amount_paid || 0;
        const newAmountPaid = previousPaid + paymentAmount;
        const newAmountDue = Math.max(0, (invoice.total || 0) - newAmountPaid);
        const isFullyPaid = newAmountDue <= 0;

        // Update invoice
        const { error: updateError } = await supabaseClient
          .from('invoices')
          .update({
            amount_paid: newAmountPaid,
            amount_due: newAmountDue,
            balance_due: newAmountDue,
            status: isFullyPaid ? 'paid' : 'partial',
            paid_at: isFullyPaid ? new Date().toISOString() : invoice.paid_at
          })
          .eq('id', invoiceId);

        if (updateError) throw updateError;

        // Record payment in payments table
        await supabaseClient.from('payments').insert({
          user_id: user.id,
          invoice_id: invoiceId,
          customer_id: invoice.customer_id,
          amount: paymentAmount,
          payment_method: paymentMethod,
          payment_type: isFullyPaid ? 'final' : 'partial',
          status: 'completed',
          notes: notes || (isFullyPaid ? 'Final payment' : 'Partial payment')
        });

        closeRecordPaymentModal();
        showToast(`Payment of $${paymentAmount.toFixed(2)} recorded!${isFullyPaid ? ' Invoice paid in full!' : ''}`, 'success');
        loadInvoices();

      } catch (err) {
        console.error('Save payment error:', err);
        showToast('Error saving payment: ' + err.message, 'error');
      }
    }

    // Sync paid invoices and customers from Stripe to local database
    async function syncFromStripe() {
      const btn = document.getElementById('sync-stripe-btn');
      if (!btn) {
        console.error('[Sync] Sync button not found');
        return;
      }
      const originalHtml = btn.innerHTML;

      try {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border-width:2px;margin-right:8px;"></span> Syncing...';

        if (!supabaseClient) {
          throw new Error('Database connection not ready');
        }

        if (!API_URL) {
          throw new Error('API URL not configured');
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');
        console.log('[Sync] User authenticated:', user.id);

        // Fetch paid invoices from Stripe via authenticated API (one-time import)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

        let response;
        try {
          response = await apiCall('/api/invoices?status=paid&limit=100', {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchErr) {
          clearTimeout(timeoutId);
          if (fetchErr.name === 'AbortError') {
            throw new Error('Stripe API timed out. The server may be starting up - please try again in a moment.');
          }
          throw fetchErr;
        }

        if (!response.ok) throw new Error('Failed to fetch Stripe invoices: ' + response.status);

        const { invoices: stripeInvoices } = await response.json();

        if (!stripeInvoices || stripeInvoices.length === 0) {
          showToast('No paid invoices found in Stripe', 'info');
          return;
        }

        let customersCreated = 0;
        let invoicesSynced = 0;
        let jobsCreated = 0;
        let errors = [];

        for (const inv of stripeInvoices) {
          if (!inv.customer_email) {
            console.log('[Sync] Skipping invoice without email:', inv.id);
            continue;
          }

          console.log('[Sync] Processing:', inv.customer_name, inv.customer_email);

          // Step 1: Check/create customer (always do this)
          let customerId = null;
          try {
            const { data: existingCustomer } = await supabaseClient
              .from('customers')
              .select('id')
              .eq('user_id', user.id)
              .eq('email', inv.customer_email)
              .single();

            if (existingCustomer) {
              customerId = existingCustomer.id;
              console.log('[Sync] Found existing customer:', customerId);
            } else {
              const { data: newCustomer, error: custErr } = await supabaseClient
                .from('customers')
                .insert({
                  user_id: user.id,
                  name: inv.customer_name || 'Customer',
                  email: inv.customer_email,
                  phone: inv.customer_phone || null,
                  source: 'stripe_sync'
                })
                .select()
                .single();

              if (!custErr && newCustomer) {
                customerId = newCustomer.id;
                customersCreated++;
                console.log('[Sync] Created customer:', customerId);
              } else if (custErr) {
                console.error('[Sync] Customer error:', custErr.message);
                errors.push(`Customer ${inv.customer_email}: ${custErr.message}`);
              }
            }
          } catch (e) {
            console.error('[Sync] Customer exception:', e);
          }

          // Step 2: Try to create invoice (may fail if columns don't exist - that's OK)
          let invoiceId = null;
          try {
            // Check if invoice exists by number
            const { data: existingInvoice } = await supabaseClient
              .from('invoices')
              .select('id')
              .eq('invoice_number', inv.number)
              .single();

            if (existingInvoice) {
              invoiceId = existingInvoice.id;
              console.log('[Sync] Invoice already exists:', invoiceId);
            } else {
              // Try with all columns first
              const invoiceData = {
                user_id: user.id,
                invoice_number: inv.number || `STR-${inv.id.slice(-8)}`,
                customer_id: customerId,
                customer_name: inv.customer_name || 'Customer',
                customer_email: inv.customer_email,
                total: inv.amount_paid || 0,
                status: 'paid',
                paid_at: new Date().toISOString()
              };

              // Add optional stripe columns (may not exist)
              try {
                invoiceData.amount_paid = inv.amount_paid || 0;
                invoiceData.amount_due = 0;
                invoiceData.stripe_invoice_id = inv.id;
                invoiceData.stripe_hosted_url = inv.hosted_invoice_url;
                invoiceData.stripe_pdf_url = inv.pdf;
              } catch (e) {}

              const { data: newInvoice, error: invErr } = await supabaseClient
                .from('invoices')
                .insert(invoiceData)
                .select()
                .single();

              if (!invErr && newInvoice) {
                invoiceId = newInvoice.id;
                invoicesSynced++;
                console.log('[Sync] Created invoice:', invoiceId);
              } else if (invErr) {
                console.error('[Sync] Invoice error:', invErr.message);
                // Try minimal insert without stripe columns
                const { data: minInvoice, error: minErr } = await supabaseClient
                  .from('invoices')
                  .insert({
                    user_id: user.id,
                    invoice_number: inv.number || `STR-${inv.id.slice(-8)}`,
                    customer_id: customerId,
                    customer_name: inv.customer_name || 'Customer',
                    customer_email: inv.customer_email,
                    total: inv.amount_paid || 0,
                    status: 'paid'
                  })
                  .select()
                  .single();

                if (!minErr && minInvoice) {
                  invoiceId = minInvoice.id;
                  invoicesSynced++;
                  console.log('[Sync] Created invoice (minimal):', invoiceId);
                }
              }
            }
          } catch (e) {
            console.error('[Sync] Invoice exception:', e);
          }

          // Step 3: Create job (even if invoice failed, as long as we have customer)
          if (customerId) {
            try {
              // Check if job exists for this customer email
              const { data: existingJob } = await supabaseClient
                .from('projects')
                .select('id')
                .eq('user_id', user.id)
                .eq('customer_email', inv.customer_email)
                .single();

              if (!existingJob) {
                const jobNum = `JOB-${Date.now().toString(36).toUpperCase()}`;
                const jobData = {
                  user_id: user.id,
                  job_number: jobNum,
                  customer_id: customerId,
                  customer_name: inv.customer_name || 'Customer',
                  customer_email: inv.customer_email,
                  contract_amount: inv.amount_paid || 0,
                  total_paid: inv.amount_paid || 0,
                  deposit_paid: true,
                  status: 'new'
                };

                if (invoiceId) jobData.invoice_id = invoiceId;

                const { error: jobErr } = await supabaseClient
                  .from('projects')
                  .insert(jobData);

                if (!jobErr) {
                  jobsCreated++;
                  console.log('[Sync] Created job:', jobNum);
                } else {
                  console.error('[Sync] Job error:', jobErr.message);
                }
              } else {
              }
            } catch (e) {
              console.error('[Sync] Job exception:', e);
            }
          }
        }

        showToast(`Synced: ${customersCreated} customers, ${invoicesSynced} invoices, ${jobsCreated} jobs`);

        // Reload data
        await Promise.all([loadInvoices(), loadCustomers(), loadJobs()]);

      } catch (err) {
        console.error('Sync error:', err);
        showToast('Sync failed: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    function filterInvoices(status) {
      invoiceFilter = status;
      document.querySelectorAll('[data-invoice-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.invoiceStatus === status);
      });
      renderInvoices();
    }

    // Inline status update for invoices - no modal needed
    async function inlineUpdateInvoiceStatus(invoiceId, newStatus) {
      try {
        const { error } = await supabaseClient
          .from('invoices')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', invoiceId);

        if (error) throw error;

        // Update local data
        const invoice = allInvoices.find(i => i.id === invoiceId);
        if (invoice) invoice.status = newStatus;

        showToast(`Invoice → ${newStatus}`, 'success');
        renderInvoices();
      } catch (err) {
        console.error('Error updating invoice status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    async function voidInvoice(invoiceId) {
      if (!confirm('Void this invoice? The customer will no longer be able to pay it.')) return;

      try {
        // Check if it's a Stripe invoice (starts with 'in_')
        if (invoiceId.startsWith('in_')) {
          // Void via Stripe API
          const response = await apiCall(`/api/invoices/${invoiceId}/void`, {
            method: 'POST'
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error || 'Failed to void invoice');
          }
        } else {
          // Supabase invoice - update status directly
          const { error } = await supabaseClient
            .from('invoices')
            .update({ status: 'void' })
            .eq('id', invoiceId);

          if (error) throw error;
        }

        loadInvoices();
        showToast('Invoice voided');
      } catch (err) {
        console.error('Void invoice error:', err);
        alert('Error voiding invoice: ' + err.message);
      }
    }

    function renderInvoices() {
      const invoicesList = document.getElementById('invoices-list');
      if (!invoicesList) return;

      let filtered = allInvoices;
      // Filter by status
      if (invoiceFilter !== 'all') {
        if (invoiceFilter === 'viewed') {
          // Filter for invoices that have been viewed
          filtered = filtered.filter(inv => inv.view_count > 0);
        } else {
          filtered = filtered.filter(inv => inv.status === invoiceFilter);
        }
      }

      if (filtered.length === 0) {
        invoicesList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <h3>No invoices found</h3>
            <p>${invoiceFilter !== 'all' ? 'No invoices with this status.' : 'Create your first invoice to get started.'}</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openInvoiceModal()">Create Invoice</button>
          </div>
        `;
        return;
      }

      // Modern card-based list for invoices
      invoicesList.innerHTML = `
        <div class="list-modern">
          ${filtered.map(inv => {
            const statusColor = inv.status === 'paid' ? '#22c55e' : inv.status === 'open' ? '#3b82f6' : inv.status === 'void' ? '#ef4444' : inv.status === 'draft' ? '#6b7280' : inv.status === 'partial' ? '#f59e0b' : '#f59e0b';
            const viewedInfo = inv.view_count > 0 ? `Viewed ${inv.view_count}x` : '';

            // Deposit info
            const hasDeposit = inv.deposit_requested > 0;
            const depositPaid = inv.deposit_paid > 0;
            const depositRemaining = hasDeposit ? (inv.deposit_requested - (inv.deposit_paid || 0)) : 0;
            let depositInfo = '';
            if (hasDeposit) {
              if (depositPaid && inv.deposit_paid >= inv.deposit_requested) {
                depositInfo = '<span style="color: #22c55e; font-size: 11px;">Deposit Paid</span>';
              } else if (depositPaid) {
                depositInfo = '<span style="color: #f59e0b; font-size: 11px;">Partial Deposit ($' + (inv.deposit_paid || 0).toFixed(2) + ')</span>';
              } else {
                depositInfo = '<span style="color: #3b82f6; font-size: 11px;">Deposit Due: $' + inv.deposit_requested.toFixed(2) + '</span>';
              }
            }

            // QuickBooks sync status
            const qboStatus = inv.qbo_sync_status || 'pending';
            const qboSynced = inv.qbo_id && qboStatus === 'synced';
            const qboError = qboStatus === 'error';
            let qboIndicator = '';
            if (qboConnected) {
              if (qboSynced) {
                qboIndicator = '<span style="color: #22c55e; font-size: 10px;" title="Synced to QuickBooks">QB ✓</span>';
              } else if (qboError) {
                qboIndicator = '<span style="color: #ef4444; font-size: 10px;" title="' + (inv.qbo_sync_error || 'Sync error') + '">QB !</span>';
              }
            }

            // Show record deposit button for open invoices with deposit requested but not fully paid
            const showDepositBtn = hasDeposit && inv.status !== 'paid' && (!depositPaid || inv.deposit_paid < inv.deposit_requested);

            return `
            <div class="list-item-modern"
                 data-context-menu="invoice"
                 data-item-id="${inv.id}"
                 data-item-data='${JSON.stringify({ invoice_number: inv.number, status: inv.status, hosted_invoice_url: inv.stripe_hosted_url, pdf_url: inv.stripe_pdf_url, customer_name: inv.customer_name, source: inv.source }).replace(/'/g, "&#39;")}'>
              <div class="list-item-icon" style="background: ${statusColor}20; color: ${statusColor};" onclick="viewSupabaseInvoice('${inv.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
              </div>
              <div class="list-item-content" onclick="viewSupabaseInvoice('${inv.id}')">
                <div class="list-item-title">#${inv.number || inv.id.slice(-8)}</div>
                <div class="list-item-subtitle">${inv.customer_name || 'No customer'} ${inv.customer_email ? '· ' + inv.customer_email : ''}</div>
                <div class="list-item-subtitle" style="margin-top: 2px;">
                  Due: ${inv.due_date ? new Date(inv.due_date).toLocaleDateString() : 'Not set'}
                  ${viewedInfo ? `<span style="color: #22c55e; margin-left: 8px;">${viewedInfo}</span>` : ''}
                  ${qboIndicator ? `<span style="margin-left: 8px;">${qboIndicator}</span>` : ''}
                </div>
                ${depositInfo ? `<div style="margin-top: 4px;">${depositInfo}</div>` : ''}
              </div>
              <div class="list-item-meta" style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                <div style="font-weight: 700; font-size: 15px; color: var(--gold-primary);">$${(inv.amount_due || 0).toFixed(2)}</div>
                <select onchange="event.stopPropagation(); inlineUpdateInvoiceStatus('${inv.id}', this.value)" style="padding: 4px 8px; background: ${statusColor}20; border: 1px solid ${statusColor}40; border-radius: 6px; color: ${statusColor}; font-size: 11px; font-weight: 600; text-transform: uppercase; cursor: pointer;">
                  <option value="draft" ${inv.status === 'draft' ? 'selected' : ''}>Draft</option>
                  <option value="open" ${inv.status === 'open' ? 'selected' : ''}>Open</option>
                  <option value="partial" ${inv.status === 'partial' ? 'selected' : ''}>Partial</option>
                  <option value="paid" ${inv.status === 'paid' ? 'selected' : ''}>Paid</option>
                  <option value="void" ${inv.status === 'void' ? 'selected' : ''}>Void</option>
                </select>
                ${inv.status !== 'paid' && inv.status !== 'void' ? `<button class="btn-modern" style="padding: 4px 10px; font-size: 11px; background: #22c55e;" onclick="event.stopPropagation(); recordPayment('${inv.id}')">+ Payment</button>` : ''}
                ${showDepositBtn ? `<button class="btn-modern secondary" style="padding: 4px 10px; font-size: 11px;" onclick="event.stopPropagation(); recordDeposit('${inv.id}')">Record Deposit</button>` : ''}
                ${qboConnected && !qboSynced ? `<button class="btn-modern ghost qbo-sync-btn" style="padding: 4px 8px; font-size: 10px;" onclick="event.stopPropagation(); syncInvoiceToQBO('${inv.id}')" title="Sync to QuickBooks"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg></button>` : ''}
              </div>
            </div>
          `;}).join('')}
        </div>
      `;
    }

    function openInvoiceModal(customer = null) {
      document.getElementById('invoice-modal').classList.add('active');
      document.getElementById('invoice-form').reset();
      document.getElementById('invoice-items').innerHTML = `
        <div class="invoice-item" data-index="0">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Kitchen Countertop Installation"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      invoiceItemCount = 1;

      // Reset deposit request fields
      const depositCheckbox = document.getElementById('invoice-require-deposit');
      const depositOptions = document.getElementById('invoice-deposit-options');
      if (depositCheckbox) depositCheckbox.checked = false;
      if (depositOptions) depositOptions.style.display = 'none';
      const depositValueEl = document.getElementById('invoice-deposit-value');
      if (depositValueEl) depositValueEl.value = 50;
      const depositTypeEl = document.getElementById('invoice-deposit-type');
      if (depositTypeEl) depositTypeEl.value = 'percent';

      // Reset deposit received fields
      const depositReceivedCheckbox = document.getElementById('invoice-deposit-received');
      const depositReceivedOptions = document.getElementById('invoice-deposit-received-options');
      if (depositReceivedCheckbox) depositReceivedCheckbox.checked = false;
      if (depositReceivedOptions) depositReceivedOptions.style.display = 'none';
      const depositReceivedAmountEl = document.getElementById('invoice-deposit-received-amount');
      if (depositReceivedAmountEl) depositReceivedAmountEl.value = '';
      const depositPaymentMethodEl = document.getElementById('invoice-deposit-payment-method');
      if (depositPaymentMethodEl) depositPaymentMethodEl.value = 'cash';

      updateInvoiceTotal();

      // Reset lead_id hidden field
      const leadIdField = document.getElementById('invoice-lead-id');
      if (leadIdField) leadIdField.value = '';

      // Pre-fill customer details if provided
      if (customer) {
        if (customer.email) {
          document.getElementById('invoice-email').value = customer.email;
        }
        if (customer.name) {
          document.getElementById('invoice-name').value = customer.name;
        }
        if (customer.phone) {
          document.getElementById('invoice-phone').value = customer.phone;
        }
        // Set lead_id if provided (for lead-to-invoice linking)
        if (customer.lead_id && leadIdField) {
          leadIdField.value = customer.lead_id;
        }
      }
    }

    function closeInvoiceModal() {
      document.getElementById('invoice-modal').classList.remove('active');
    }

    // Start invoice from a lead (quick action)
    function startInvoiceFromLead(leadId) {
      const lead = leadId ? allLeads.find(l => l.id === leadId) : selectedLead;
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      // Navigate to invoices page and open modal with lead data
      showPage('invoices');
      setTimeout(() => {
        openInvoiceModal({
          email: lead.email || lead.homeowner_email,
          name: lead.full_name || lead.name || `${lead.first_name || ''} ${lead.last_name || ''}`.trim(),
          phone: lead.phone || lead.homeowner_phone,
          lead_id: lead.id
        });
      }, 300);
    }

    // =====================================================
    // QUICKBOOKS SYNC FUNCTIONS
    // =====================================================

    let qboConnected = false;

    // Check QuickBooks connection status
    async function checkQuickBooksStatus() {
      try {
        const response = await fetch(`${API_BASE}/api/quickbooks/status`, {
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });
        const data = await response.json();
        qboConnected = data.connected;
        updateQuickBooksUI();
      } catch (e) {
        console.log('QuickBooks status check failed:', e);
        qboConnected = false;
      }
    }

    // Update UI based on QuickBooks connection status
    function updateQuickBooksUI() {
      const qbBtns = document.querySelectorAll('.qbo-sync-btn');
      qbBtns.forEach(btn => {
        btn.style.display = qboConnected ? 'inline-flex' : 'none';
      });
    }

    // Connect to QuickBooks
    async function connectQuickBooks() {
      try {
        const response = await fetch(`${API_BASE}/api/quickbooks/connect`, {
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });
        const data = await response.json();
        if (data.authUrl) {
          window.open(data.authUrl, 'QuickBooks Connect', 'width=600,height=700');
        } else if (data.error) {
          throw new Error(data.error);
        }
      } catch (e) {
        console.error('QuickBooks connect error:', e);
        showToast('Failed to connect to QuickBooks: ' + e.message, 'error');
      }
    }

    // Disconnect from QuickBooks
    async function disconnectQuickBooks() {
      if (!confirm('Are you sure you want to disconnect QuickBooks?')) return;

      try {
        await fetch(`${API_BASE}/api/quickbooks/disconnect`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });
        qboConnected = false;
        updateQuickBooksUI();
        showToast('QuickBooks disconnected', 'info');
      } catch (e) {
        showToast('Failed to disconnect QuickBooks', 'error');
      }
    }

    // Sync invoice to QuickBooks
    async function syncInvoiceToQBO(invoiceId) {
      const btn = event?.target?.closest('button');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';
      }

      try {
        const response = await fetch(`${API_BASE}/api/quickbooks/sync/invoice/${invoiceId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });

        const data = await response.json();
        if (data.success) {
          showToast('Invoice synced to QuickBooks', 'success');
          loadInvoices(); // Refresh to show sync status
        } else {
          throw new Error(data.error || 'Sync failed');
        }
      } catch (e) {
        showToast(`QuickBooks sync failed: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>';
        }
      }
    }

    // Sync estimate to QuickBooks
    async function syncEstimateToQBO(estimateId) {
      const btn = event?.target?.closest('button');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>';
      }

      try {
        const response = await fetch(`${API_BASE}/api/quickbooks/sync/estimate/${estimateId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });

        const data = await response.json();
        if (data.success) {
          showToast('Estimate synced to QuickBooks', 'success');
          loadEstimates(); // Refresh to show sync status
        } else {
          throw new Error(data.error || 'Sync failed');
        }
      } catch (e) {
        showToast(`QuickBooks sync failed: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>';
        }
      }
    }

    // Sync all pending invoices
    async function syncAllInvoicesToQBO() {
      const btn = event?.target?.closest('button');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Syncing...';
      }

      try {
        const response = await fetch('/api/quickbooks/sync/invoices', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });

        const data = await response.json();
        if (data.success) {
          showToast(data.message, 'success');
          loadInvoices();
        } else {
          throw new Error(data.error);
        }
      } catch (e) {
        showToast(`Sync failed: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Sync All to QuickBooks';
        }
      }
    }

    // Sync all pending estimates
    async function syncAllEstimatesToQBO() {
      const btn = event?.target?.closest('button');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Syncing...';
      }

      try {
        const response = await fetch('/api/quickbooks/sync/estimates', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session?.access_token}` }
        });

        const data = await response.json();
        if (data.success) {
          showToast(data.message, 'success');
          loadEstimates();
        } else {
          throw new Error(data.error);
        }
      } catch (e) {
        showToast(`Sync failed: ${e.message}`, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Sync All to QuickBooks';
        }
      }
    }

    // Template Preview Modal Functions
    const templatePreviews = {
      classic: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f4; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #f4f4f4;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          <tr>
            <td style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; text-align: center;">
              <h1 style="color: #f9cb00; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 1px;">Surprise Granite</h1>
              <p style="color: rgba(255,255,255,0.8); margin: 8px 0 0; font-size: 14px;">Premium Countertops & Expert Installation</p>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 40px 20px; border-bottom: 2px solid #f9cb00;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h2 style="margin: 0; color: #1a1a2e; font-size: 32px; font-weight: 300;">INVOICE</h2>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px;"><strong>Date:</strong> Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #1a1a2e; font-size: 14px;"><strong>Due:</strong> Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Bill To</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 16px; font-weight: 600;">John Smith</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0 0 5px; color: #999; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">From</p>
                    <p style="margin: 0; color: #1a1a2e; font-size: 14px; font-weight: 600;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #666; font-size: 13px;">14155 W. Bell Road, Suite 100</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 30px;">
              <table width="100%" cellspacing="0" cellpadding="0" style="border-collapse: collapse;">
                <tr style="background-color: #1a1a2e;">
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px;">Description</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: center;">Qty</td>
                  <td style="padding: 15px; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; text-align: right;">Amount</td>
                </tr>
                <tr style="background-color: #f9f9f9;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Kitchen Countertop - Granite</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$2,500.00</td>
                </tr>
                <tr style="background-color: #ffffff;">
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee;">Installation Labor</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: center;">1</td>
                  <td style="padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; text-align: right;">$800.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" style="background-color: #1a1a2e; padding: 20px; border-radius: 8px;">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700;">TOTAL</td>
                        <td style="color: #f9cb00; font-size: 18px; font-weight: 700; text-align: right;">$3,300.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 0 40px 40px; text-align: center;">
              <a href="javascript:void(0)" style="display: inline-block; background: linear-gradient(135deg, #f9cb00 0%, #e6b800 100%); color: #1a1a2e; text-decoration: none; padding: 18px 50px; border-radius: 50px; font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(249, 203, 0, 0.4);">Pay Now</a>
            </td>
          </tr>
          <tr>
            <td style="background-color: #f9f9f9; padding: 30px 40px; text-align: center; border-top: 1px solid #eee;">
              <p style="margin: 0 0 10px; color: #666; font-size: 14px;">Questions? Contact us at <a href="javascript:void(0)" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a></p>
              <p style="margin: 0; color: #999; font-size: 12px;">Surprise Granite Marble & Quartz</p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      modern: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #ffffff; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0">
    <tr>
      <td align="center" style="padding: 60px 20px;">
        <table role="presentation" width="550" cellspacing="0" cellpadding="0">
          <tr>
            <td style="padding-bottom: 40px; border-bottom: 1px solid #eee;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <h1 style="margin: 0; color: #000; font-size: 24px; font-weight: 800; letter-spacing: -0.5px;">SURPRISE<span style="color: #f9cb00;">GRANITE</span></h1>
                    <p style="margin: 4px 0 0; color: #888; font-size: 12px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #000; font-size: 11px; text-transform: uppercase; letter-spacing: 2px;">Invoice</p>
                    <p style="margin: 4px 0 0; color: #f9cb00; font-size: 20px; font-weight: 700;">#INV-2024-001</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Billed To</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 18px; font-weight: 600;">John Smith</p>
                    <p style="margin: 4px 0 0; color: #666; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" align="right">
                    <p style="margin: 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Invoice Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">January 7, 2025</p>
                    <p style="margin: 20px 0 0; color: #888; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Due Date</p>
                    <p style="margin: 10px 0 0; color: #000; font-size: 16px;">February 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Kitchen Countertop - Granite</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$2,500.00</p>
                  </td>
                </tr>
              </table>
              <table width="100%" cellspacing="0" cellpadding="0" style="border-bottom: 1px solid #f0f0f0;">
                <tr>
                  <td style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 500;">Installation Labor</p>
                    <p style="margin: 4px 0 0; color: #888; font-size: 13px;">Qty: 1</p>
                  </td>
                  <td align="right" style="padding: 20px 0;">
                    <p style="margin: 0; color: #000; font-size: 16px; font-weight: 600;">$800.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 30px 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td></td>
                  <td width="200" align="right">
                    <p style="margin: 0; padding: 15px 0; color: #000; font-size: 20px; font-weight: 700;">Total</p>
                    <p style="margin: 0; color: #000; font-size: 24px; font-weight: 700;">$3,300.00</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="padding: 20px 0 50px; text-align: center;">
              <a href="javascript:void(0)" style="display: inline-block; background-color: #000; color: #fff; text-decoration: none; padding: 16px 60px; font-size: 14px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase;">Pay Invoice →</a>
            </td>
          </tr>
          <tr>
            <td style="padding: 40px 0; border-top: 1px solid #eee; text-align: center;">
              <p style="margin: 0; color: #888; font-size: 13px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 8px 0 0; color: #aaa; font-size: 12px;"><a href="javascript:void(0)" style="color: #f9cb00; text-decoration: none;">info@surprisegranite.com</a> • <a href="javascript:void(0)" style="color: #f9cb00; text-decoration: none;">(602) 833-3189</a></p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`,
      premium: `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="robots" content="noindex, nofollow"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #0a0a12; font-family: 'Georgia', 'Times New Roman', serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" style="background-color: #0a0a12;">
    <tr>
      <td align="center" style="padding: 50px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0">
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 12px; letter-spacing: 4px; text-transform: uppercase;">Premium Quality</p>
              <h1 style="margin: 15px 0 0; color: #ffffff; font-size: 36px; font-weight: 400; letter-spacing: 3px;">SURPRISE GRANITE</h1>
              <p style="margin: 10px 0 0; color: #888; font-size: 14px; letter-spacing: 2px;">MARBLE & QUARTZ</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 3px; text-transform: uppercase;">Invoice Number</p>
                    <p style="margin: 8px 0 0; color: #ffffff; font-size: 24px; font-weight: 300;">#INV-2024-001</p>
                  </td>
                  <td align="right">
                    <p style="margin: 0; color: #888; font-size: 13px;">Issue Date: Jan 7, 2025</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">Due: Feb 6, 2025</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 40px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="50%" valign="top">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Bill To</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 20px; font-weight: 400;">John Smith</p>
                    <p style="margin: 8px 0 0; color: #888; font-size: 14px;">john@example.com</p>
                  </td>
                  <td width="50%" valign="top" align="right">
                    <p style="margin: 0; color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">From</p>
                    <p style="margin: 15px 0 0; color: #ffffff; font-size: 14px;">Surprise Granite Marble & Quartz</p>
                    <p style="margin: 5px 0 0; color: #888; font-size: 13px;">(602) 833-3189</p>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #1a1a2e; padding: 0;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="padding: 20px 50px; border-bottom: 1px solid rgba(249, 203, 0, 0.2);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase;">Description</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: center;" width="80">Qty</td>
                        <td style="color: #f9cb00; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; text-align: right;" width="120">Amount</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Kitchen Countertop - Granite</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$2,500.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 25px 50px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <table width="100%" cellspacing="0" cellpadding="0">
                      <tr>
                        <td style="color: #ffffff; font-size: 16px;">Installation Labor</td>
                        <td style="color: #888; font-size: 14px; text-align: center;" width="80">1</td>
                        <td style="color: #ffffff; font-size: 16px; text-align: right;" width="120">$800.00</td>
                      </tr>
                    </table>
                  </td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background: linear-gradient(135deg, #f9cb00 0%, #d4a800 100%); padding: 30px 50px;">
              <table width="100%" cellspacing="0" cellpadding="0">
                <tr>
                  <td style="color: #1a1a2e; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">Total Amount</td>
                  <td align="right" style="color: #1a1a2e; font-size: 32px; font-weight: 700;">$3,300.00</td>
                </tr>
              </table>
            </td>
          </tr>
          <tr>
            <td style="background-color: #12121a; padding: 50px; text-align: center;">
              <a href="javascript:void(0)" style="display: inline-block; border: 2px solid #f9cb00; color: #f9cb00; text-decoration: none; padding: 18px 60px; font-size: 13px; font-weight: 400; letter-spacing: 3px; text-transform: uppercase;">PAY INVOICE</a>
              <p style="margin: 30px 0 0; color: #666; font-size: 13px;">Secure payment powered by Stripe</p>
            </td>
          </tr>
          <tr>
            <td style="background-color: #0a0a12; padding: 40px 50px; text-align: center;">
              <p style="margin: 0; color: #f9cb00; font-size: 11px; letter-spacing: 2px;">Surprise Granite Marble & Quartz</p>
              <p style="margin: 15px 0 0; color: #666; font-size: 12px;">14155 W. Bell Road, Suite 100, Surprise, AZ 85374</p>
              <p style="margin: 10px 0 0; color: #666; font-size: 12px;">info@surprisegranite.com • (602) 833-3189</p>
              <p style="margin: 20px 0 0; color: #444; font-size: 11px;">Thank you for choosing Surprise Granite for your project.</p>
            </td>
          </tr>
          <tr>
            <td style="height: 4px; background: linear-gradient(90deg, transparent, #f9cb00, transparent);"></td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>`
    };

    function openTemplatePreview() {
      document.getElementById('template-preview-modal').classList.add('active');
      // Load the classic template by default
      showTemplatePreview('classic');
    }

    function closeTemplatePreview() {
      document.getElementById('template-preview-modal').classList.remove('active');
    }

    function showTemplatePreview(templateName) {
      // Update active tab
      document.querySelectorAll('.template-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.template === templateName) {
          tab.classList.add('active');
        }
      });

      // Show corresponding preview frame
      document.querySelectorAll('.template-preview-frame').forEach(frame => {
        frame.style.display = 'none';
      });
      const activeFrame = document.getElementById('template-frame-' + templateName);
      if (activeFrame) {
        activeFrame.style.display = 'block';
        // Load the template content into the iframe
        const iframe = document.getElementById('preview-iframe-' + templateName);
        if (iframe && templatePreviews[templateName]) {
          iframe.srcdoc = templatePreviews[templateName];
        }
      }
    }

    // Close template preview modal on click outside
    document.getElementById('template-preview-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeTemplatePreview();
    });

    function addInvoiceItem() {
      const container = document.getElementById('invoice-items');
      const itemHTML = `
        <div class="invoice-item" data-index="${invoiceItemCount}">
          <div class="form-row" style="align-items: flex-end;">
            <div class="form-group" style="flex: 3;">
              <label>Description *</label>
              <input type="text" class="item-description" required placeholder="e.g., Installation Labor"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Qty</label>
              <input type="number" class="item-qty" value="1" min="1" onchange="updateInvoiceTotal()"/>
            </div>
            <div class="form-group" style="flex: 1;">
              <label>Amount ($) *</label>
              <input type="number" class="item-amount" required min="0" step="0.01" placeholder="0.00" onchange="updateInvoiceTotal()"/>
            </div>
            <button type="button" class="btn-modern secondary" style="margin-bottom: 20px; padding: 10px;" onclick="removeInvoiceItem(this)">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            </button>
          </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', itemHTML);
      invoiceItemCount++;
    }

    function removeInvoiceItem(btn) {
      const items = document.querySelectorAll('.invoice-item');
      if (items.length > 1) {
        btn.closest('.invoice-item').remove();
        updateInvoiceTotal();
      }
    }

    function updateInvoiceTotal() {
      const items = document.querySelectorAll('.invoice-item');
      let total = 0;
      items.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 1;
        const amount = parseFloat(item.querySelector('.item-amount').value) || 0;
        total += qty * amount;
      });
      document.getElementById('invoice-total').textContent = `$${total.toFixed(2)}`;
      // Also update deposit calculations if enabled
      updateInvoiceDeposit();
      updateDepositReceived();
    }

    function toggleInvoiceDeposit() {
      const checkbox = document.getElementById('invoice-require-deposit');
      const options = document.getElementById('invoice-deposit-options');
      const receivedCheckbox = document.getElementById('invoice-deposit-received');
      const receivedOptions = document.getElementById('invoice-deposit-received-options');

      if (checkbox && options) {
        options.style.display = checkbox.checked ? 'block' : 'none';

        // If checking "request deposit", uncheck "deposit received" (mutually exclusive)
        if (checkbox.checked && receivedCheckbox) {
          receivedCheckbox.checked = false;
          if (receivedOptions) receivedOptions.style.display = 'none';
        }

        if (checkbox.checked) {
          updateInvoiceDeposit();
        }
      }
    }

    function updateInvoiceDeposit() {
      const depositEnabled = document.getElementById('invoice-require-deposit')?.checked;
      if (!depositEnabled) return;

      const totalText = document.getElementById('invoice-total')?.textContent || '$0.00';
      const total = parseFloat(totalText.replace(/[$,]/g, '')) || 0;

      const depositType = document.getElementById('invoice-deposit-type')?.value || 'percent';
      const depositValue = parseFloat(document.getElementById('invoice-deposit-value')?.value) || 0;

      let depositAmount = 0;
      if (depositType === 'percent') {
        depositAmount = total * (depositValue / 100);
        document.getElementById('invoice-deposit-value-label').textContent = 'Deposit %';
        document.getElementById('invoice-deposit-value').max = 100;
      } else {
        depositAmount = Math.min(depositValue, total);
        document.getElementById('invoice-deposit-value-label').textContent = 'Amount ($)';
        document.getElementById('invoice-deposit-value').max = total;
      }

      const balanceDue = total - depositAmount;

      const depositAmountEl = document.getElementById('invoice-deposit-amount');
      const balanceDueEl = document.getElementById('invoice-balance-due');

      if (depositAmountEl) depositAmountEl.textContent = `$${depositAmount.toFixed(2)}`;
      if (balanceDueEl) balanceDueEl.textContent = `$${balanceDue.toFixed(2)}`;
    }

    // Toggle deposit already received section
    function toggleDepositReceived() {
      const checkbox = document.getElementById('invoice-deposit-received');
      const options = document.getElementById('invoice-deposit-received-options');
      const requestCheckbox = document.getElementById('invoice-require-deposit');
      const requestOptions = document.getElementById('invoice-deposit-options');

      if (checkbox && options) {
        options.style.display = checkbox.checked ? 'block' : 'none';

        // If checking "deposit received", uncheck "request deposit" (mutually exclusive)
        if (checkbox.checked && requestCheckbox) {
          requestCheckbox.checked = false;
          if (requestOptions) requestOptions.style.display = 'none';
        }

        if (checkbox.checked) {
          updateDepositReceived();
        }
      }
    }

    // Update deposit received display
    function updateDepositReceived() {
      const depositReceived = document.getElementById('invoice-deposit-received')?.checked;
      if (!depositReceived) return;

      const totalText = document.getElementById('invoice-total')?.textContent || '$0.00';
      const total = parseFloat(totalText.replace(/[$,]/g, '')) || 0;

      const depositAmount = parseFloat(document.getElementById('invoice-deposit-received-amount')?.value) || 0;
      const balanceRemaining = Math.max(0, total - depositAmount);

      const depositDisplayEl = document.getElementById('invoice-deposit-received-display');
      const balanceRemainingEl = document.getElementById('invoice-balance-remaining');

      if (depositDisplayEl) depositDisplayEl.textContent = `$${depositAmount.toFixed(2)}`;
      if (balanceRemainingEl) balanceRemainingEl.textContent = `$${balanceRemaining.toFixed(2)}`;
    }

    // Get invoice form data helper
    function getInvoiceFormData() {
      const items = [];
      document.querySelectorAll('.invoice-item').forEach(item => {
        items.push({
          description: item.querySelector('.item-description').value,
          quantity: parseInt(item.querySelector('.item-qty').value) || 1,
          amount: parseFloat(item.querySelector('.item-amount').value) || 0
        });
      });

      // Calculate deposit if requesting deposit
      const depositEnabled = document.getElementById('invoice-require-deposit')?.checked || false;
      let depositAmount = 0;
      let depositPercent = 0;
      let depositType = 'percent';

      if (depositEnabled) {
        const totalText = document.getElementById('invoice-total')?.textContent || '$0.00';
        const total = parseFloat(totalText.replace(/[$,]/g, '')) || 0;
        depositType = document.getElementById('invoice-deposit-type')?.value || 'percent';
        const depositValue = parseFloat(document.getElementById('invoice-deposit-value')?.value) || 0;

        if (depositType === 'percent') {
          depositPercent = depositValue;
          depositAmount = total * (depositValue / 100);
        } else {
          depositAmount = Math.min(depositValue, total);
          depositPercent = total > 0 ? (depositAmount / total) * 100 : 0;
        }
      }

      // Check if deposit already received
      const depositAlreadyReceived = document.getElementById('invoice-deposit-received')?.checked || false;
      let depositReceivedAmount = 0;
      let depositPaymentMethod = '';

      if (depositAlreadyReceived) {
        depositReceivedAmount = parseFloat(document.getElementById('invoice-deposit-received-amount')?.value) || 0;
        depositPaymentMethod = document.getElementById('invoice-deposit-payment-method')?.value || 'cash';
      }

      return {
        items,
        customerEmail: document.getElementById('invoice-email').value,
        customerName: document.getElementById('invoice-name').value,
        customerPhone: document.getElementById('invoice-phone').value,
        dueDays: parseInt(document.getElementById('invoice-due-days').value) || 30,
        notes: document.getElementById('invoice-notes').value,
        selectedTemplate: document.querySelector('input[name="invoice-template"]:checked')?.value || 'classic',
        ccMe: document.getElementById('invoice-cc-me')?.checked ?? true,
        ccOther: document.getElementById('invoice-cc-other')?.value || '',
        depositEnabled,
        depositAmount,
        depositPercent,
        depositType,
        depositAlreadyReceived,
        depositReceivedAmount,
        depositPaymentMethod,
        leadId: document.getElementById('invoice-lead-id')?.value || null
      };
    }

    // Save invoice as draft (no email sent)
    async function saveInvoiceDraft() {
      const btn = document.getElementById('invoice-draft-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Saving...';

      try {
        const formData = getInvoiceFormData();
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        const total = formData.items.reduce((sum, item) => sum + (item.quantity * item.amount), 0);
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        const draftData = {
          user_id: user.id,
          invoice_number: invoiceNumber,
          customer_email: formData.customerEmail,
          customer_name: formData.customerName,
          customer_phone: formData.customerPhone,
          subtotal: total,
          total: total,
          amount_due: total,
          amount_paid: 0,
          due_date: new Date(Date.now() + formData.dueDays * 24 * 60 * 60 * 1000).toISOString(),
          notes: formData.notes,
          status: 'draft'
        };

        // Include lead_id if creating from a lead
        if (formData.leadId) {
          draftData.lead_id = formData.leadId;
        }

        const { data: invoice, error } = await supabaseClient
          .from('invoices')
          .insert(draftData)
          .select()
          .single();

        if (error) throw error;

        // Save items
        if (formData.items.length > 0) {
          const invoiceItems = formData.items.map(item => ({
            invoice_id: invoice.id,
            description: item.description,
            name: item.description,
            quantity: item.quantity,
            unit_price: item.amount,
            total: item.quantity * item.amount
          }));
          await supabaseClient.from('invoice_items').insert(invoiceItems);
        }

        closeInvoiceModal();
        loadInvoices();
        showToast(`Invoice #${invoiceNumber} saved as draft`, 'success');
      } catch (err) {
        showToast('Error saving draft: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg> Save Draft';
      }
    }

    // Preview invoice before sending
    async function previewInvoice() {
      const formData = getInvoiceFormData();
      console.log('[Invoices] previewInvoice formData:', formData);

      if (!formData.customerEmail) {
        showToast('Please enter customer email', 'warning');
        return;
      }
      if (formData.items.length === 0 || !formData.items[0].description) {
        showToast('Please add at least one line item', 'warning');
        return;
      }

      const total = formData.items.reduce((sum, item) => sum + (item.quantity * item.amount), 0);
      const dueDate = new Date(Date.now() + formData.dueDays * 24 * 60 * 60 * 1000);

      // Build CC list for display
      const ccList = [];
      if (formData.ccMe && userProfile?.email) ccList.push(userProfile.email);
      if (formData.ccOther) ccList.push(formData.ccOther);

      const previewHtml = `
        <div style="max-width: 600px; margin: 0 auto; font-family: system-ui, sans-serif;">
          <div style="background: var(--dark-elevated); border-radius: 12px; padding: 24px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 16px; color: var(--gold-primary);">Invoice Preview</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div>
                <div style="color: var(--text-muted); font-size: 12px;">TO</div>
                <div style="font-weight: 600;">${formData.customerName || 'Customer'}</div>
                <div style="color: var(--text-secondary);">${formData.customerEmail}</div>
                ${formData.customerPhone ? `<div style="color: var(--text-secondary);">${formData.customerPhone}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="color: var(--text-muted); font-size: 12px;">DUE DATE</div>
                <div style="font-weight: 600;">${dueDate.toLocaleDateString()}</div>
                <div style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">TEMPLATE</div>
                <div>${formData.selectedTemplate.charAt(0).toUpperCase() + formData.selectedTemplate.slice(1)}</div>
              </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 16px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-subtle);">
                  <th style="text-align: left; padding: 8px 0; color: var(--text-muted); font-size: 12px;">ITEM</th>
                  <th style="text-align: center; padding: 8px 0; color: var(--text-muted); font-size: 12px;">QTY</th>
                  <th style="text-align: right; padding: 8px 0; color: var(--text-muted); font-size: 12px;">AMOUNT</th>
                </tr>
              </thead>
              <tbody>
                ${formData.items.map(item => `
                  <tr style="border-bottom: 1px solid var(--border-subtle);">
                    <td style="padding: 12px 0;">${item.description || 'Item'}</td>
                    <td style="text-align: center; padding: 12px 0;">${item.quantity}</td>
                    <td style="text-align: right; padding: 12px 0;">$${(item.quantity * item.amount).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>

            <div style="text-align: right; font-size: 20px; font-weight: 700; color: var(--gold-primary);">
              Total: $${total.toFixed(2)}
            </div>

            ${formData.notes ? `
              <div style="margin-top: 16px; padding: 12px; background: var(--dark-surface); border-radius: 8px;">
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">NOTES</div>
                <div style="color: var(--text-secondary);">${formData.notes}</div>
              </div>
            ` : ''}

            ${ccList.length > 0 ? `
              <div style="margin-top: 16px; padding: 12px; background: rgba(249, 203, 0, 0.1); border-radius: 8px; border-left: 3px solid var(--gold-primary);">
                <div style="color: var(--text-muted); font-size: 12px; margin-bottom: 4px;">CC COPY TO</div>
                <div style="color: var(--text-secondary);">${ccList.join(', ')}</div>
              </div>
            ` : ''}
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="btn-modern secondary" id="preview-edit-btn">Edit Invoice</button>
            <button class="btn-modern primary" id="preview-send-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              Send Invoice
            </button>
          </div>
        </div>
      `;

      // Create preview modal
      let previewModal = document.getElementById('invoice-preview-modal');
      if (!previewModal) {
        previewModal = document.createElement('div');
        previewModal.id = 'invoice-preview-modal';
        previewModal.className = 'modal-overlay';
        previewModal.innerHTML = `<div class="modal" style="max-width: 700px;">${previewHtml}</div>`;
        previewModal.addEventListener('click', (e) => {
          if (e.target === previewModal) previewModal.classList.remove('active');
        });
        document.body.appendChild(previewModal);
      } else {
        previewModal.querySelector('.modal').innerHTML = previewHtml;
      }

      // Attach button handlers after modal is created
      const editBtn = previewModal.querySelector('#preview-edit-btn');
      const sendBtn = previewModal.querySelector('#preview-send-btn');
      if (editBtn) {
        editBtn.onclick = () => previewModal.classList.remove('active');
      }
      if (sendBtn) {
        sendBtn.onclick = () => {
          confirmSendInvoice();
        };
      }

      previewModal.classList.add('active');
    }

    // Confirm and send invoice after preview
    async function confirmSendInvoice() {
      document.getElementById('invoice-preview-modal')?.classList.remove('active');
      try {
        await createInvoice(new Event('submit'));
      } catch (err) {
        console.error('[Invoices] confirmSendInvoice error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    let isCreatingInvoice = false; // Guard against double-clicks

    async function createInvoice(e) {
      console.log('[Invoices] createInvoice called, isCreating:', isCreatingInvoice);
      if (e && e.preventDefault) e.preventDefault();

      // Prevent double-submission
      if (isCreatingInvoice) {
        return;
      }
      isCreatingInvoice = true;

      const btn = document.getElementById('invoice-preview-btn');
      const sendBtn = document.getElementById('preview-send-btn');

      // Disable both buttons if they exist
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Creating...';
      }
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner"></span> Sending...';
      }

      let formData;
      try {
        formData = getInvoiceFormData();
        console.log('[Invoices] Form data:', formData);
      } catch (formErr) {
        console.error('[Invoices] Form data error:', formErr);
        showToast('Error reading form data', 'error');
        isCreatingInvoice = false;
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Preview & Send';
        }
        return;
      }

      const { items, customerEmail, customerName, customerPhone, dueDays, notes, selectedTemplate, ccMe, ccOther, depositEnabled, depositAmount, depositPercent, depositAlreadyReceived, depositReceivedAmount, depositPaymentMethod, leadId } = formData;
      console.log('[Invoices] Destructured OK - items:', items?.length, 'email:', customerEmail);

      // Build CC recipients list
      const ccRecipients = [];
      if (ccMe && userProfile?.email) ccRecipients.push(userProfile.email);
      if (ccOther && ccOther.trim()) ccRecipients.push(ccOther.trim());
      console.log('[Invoices] About to get user auth...');

      try {
        const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
        console.log('[Invoices] Auth call returned');
        if (authError) {
          console.error('[Invoices] Auth error:', authError);
          throw new Error('Authentication error: ' + authError.message);
        }
        if (!user) throw new Error('Not authenticated');
        console.log('[Invoices] User:', user.id);

        // Calculate total from items
        const total = items.reduce((sum, item) => sum + (item.quantity * item.amount), 0);
        console.log('[Invoices] Total:', total, 'Email:', customerEmail);
        if (total <= 0) throw new Error('Invoice total must be greater than $0');
        if (!customerEmail) throw new Error('Customer email is required');

        // Generate invoice number
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        console.log('[Invoices] Creating invoice:', invoiceNumber, 'for', customerEmail);

        // Step 1: Create invoice in Supabase (single source of truth)
        let amountDue = total;
        let amountPaid = 0;
        let balanceDue = total;
        let invoiceStatus = 'draft';

        // Handle deposit scenarios
        if (depositAlreadyReceived && depositReceivedAmount > 0) {
          // Deposit already received - record it and calculate remaining balance
          amountPaid = depositReceivedAmount;
          balanceDue = Math.max(0, total - depositReceivedAmount);
          amountDue = balanceDue;
          // If fully paid, mark as paid; if partial, mark as partial
          if (depositReceivedAmount >= total) {
            invoiceStatus = 'paid';
          } else {
            invoiceStatus = 'partial';
          }
          console.log('[Invoices] Deposit already received:', depositReceivedAmount, 'Balance:', balanceDue);
        } else if (depositEnabled && depositAmount > 0) {
          // Requesting deposit - amount due is just the deposit
          amountDue = depositAmount;
          balanceDue = total - depositAmount;
        }

        const invoiceData = {
          user_id: user.id,
          invoice_number: invoiceNumber,
          customer_email: customerEmail,
          customer_name: customerName,
          customer_phone: customerPhone,
          subtotal: total,
          total: total,
          amount_due: amountDue,
          amount_paid: amountPaid,
          due_date: new Date(Date.now() + dueDays * 24 * 60 * 60 * 1000).toISOString(),
          notes: notes,
          status: invoiceStatus,
          deposit_requested: depositEnabled ? depositAmount : (depositAlreadyReceived ? depositReceivedAmount : null),
          deposit_percent: depositEnabled ? depositPercent : null,
          deposit_paid: depositAlreadyReceived ? depositReceivedAmount : 0,
          deposit_paid_at: depositAlreadyReceived && depositReceivedAmount > 0 ? new Date().toISOString() : null,
          deposit_payment_method: depositAlreadyReceived ? depositPaymentMethod : null,
          balance_due: balanceDue
        };

        // Include lead_id if creating from a lead (for traceability)
        if (leadId) {
          invoiceData.lead_id = leadId;
          console.log('[Invoices] Linking invoice to lead:', leadId);
        }

        const { data: invoice, error: invoiceError } = await supabaseClient
          .from('invoices')
          .insert(invoiceData)
          .select()
          .single();

        if (invoiceError) {
          console.error('[Invoices] Supabase insert error:', invoiceError);
          throw invoiceError;
        }

        console.log('[Invoices] Supabase invoice created:', invoice.id);

        // Step 2: Create invoice items in Supabase
        if (items.length > 0) {
          const invoiceItems = items.map(item => ({
            invoice_id: invoice.id,
            description: item.description,
            name: item.description,
            quantity: item.quantity,
            unit_price: item.amount,
            total: item.quantity * item.amount
          }));

          const { error: itemsError } = await supabaseClient.from('invoice_items').insert(invoiceItems);
          if (itemsError) console.warn('[Invoices] Items insert error:', itemsError);
        }

        // Close modal and show success IMMEDIATELY - don't wait for Stripe
        closeInvoiceModal();
        isCreatingInvoice = false; // Reset guard
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> Preview & Send';
        }
        console.log('[Invoices] Invoice created successfully:', invoiceNumber);
        showToast(`Invoice #${invoiceNumber} created! Sending email...`, 'success');
        loadInvoices();

        // Step 3: Create Stripe invoice via surprise-granite-email-api (has correct Stripe keys)
        (async () => {
          try {
            console.log('[Invoices] Starting Stripe invoice for:', customerEmail);
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            const response = await apiCall('/api/invoices', {
              method: 'POST',
              signal: controller.signal,
              body: JSON.stringify({
                customer_email: customerEmail,
                customer_name: customerName,
                customer_phone: customerPhone,
                items: items,
                due_days: dueDays,
                notes: notes,
                auto_send: true,
                cc_recipients: ccRecipients
              })
            });

            clearTimeout(timeoutId);
            console.log('[Invoices] API response status:', response.status);

            if (response.ok) {
              const result = await response.json();
              console.log('[Invoices] Stripe response:', result);

              if (result.invoice?.id) {
                await supabaseClient
                  .from('invoices')
                  .update({
                    stripe_invoice_id: result.invoice.id,
                    stripe_hosted_url: result.invoice.hosted_invoice_url,
                    stripe_pdf_url: result.invoice.invoice_pdf,
                    status: 'open'
                  })
                  .eq('id', invoice.id);

                console.log('[Invoices] Stripe invoice created:', result.invoice.id);
                showToast(`Invoice emailed to ${customerEmail}!`, 'success');
                loadInvoices();
              } else {
                console.error('[Invoices] Missing invoice ID:', result);
                showToast('Invoice saved but email may not have sent', 'warning');
              }
            } else {
              const errorText = await response.text();
              console.error('[Invoices] API error:', response.status, errorText);
              showToast(`Email delivery failed (${response.status}). Invoice saved locally.`, 'error');
            }
          } catch (err) {
            if (err.name === 'AbortError') {
              console.error('[Invoices] API timed out');
              showToast('Email service timed out. Invoice saved, please resend manually.', 'warning');
            } else {
              console.error('[Invoices] Error:', err);
              showToast('Email failed: ' + err.message, 'error');
            }
          }
        })();

      } catch (err) {
        console.error('[Invoices] Create error:', err);
        showToast('Error creating invoice: ' + err.message, 'error');
        isCreatingInvoice = false; // Reset guard
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg> Preview & Send';
        }
        const sendBtn = document.getElementById('preview-send-btn');
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = 'Send Invoice';
        }
      }
    }

    async function sendReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        const response = await apiCall(`/api/invoices/${invoiceId}/remind`, {
          method: 'POST'
        });

        if (!response.ok) {
          throw new Error('Failed to send reminder');
        }

        alert('Payment reminder sent!');
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Invoice modal click-outside to close
    document.getElementById('invoice-modal')?.addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeInvoiceModal();
    });

    // ============ SUPABASE INVOICE FUNCTIONS ============
    async function viewSupabaseInvoice(invoiceId) {
      try {
        // First check if this is a Stripe-only invoice (starts with 'in_')
        const stripeOnlyInvoice = allInvoices.find(inv => inv.id === invoiceId && inv.source === 'stripe');
        if (stripeOnlyInvoice) {
          // For Stripe-only invoices, open the hosted URL or show basic info
          if (stripeOnlyInvoice.stripe_hosted_url) {
            window.open(stripeOnlyInvoice.stripe_hosted_url, '_blank');
            return;
          }
          // Fallback: show what we have from Stripe
          const invoiceHtml = `
            <html>
            <head><title>Invoice #${stripeOnlyInvoice.number}</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
              .header { border-bottom: 3px solid #f9cb00; padding-bottom: 20px; margin-bottom: 30px; }
              .header h1 { color: #1a1a2e; margin: 0; }
              .info-box { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
              .status { display: inline-block; padding: 6px 16px; border-radius: 20px; font-weight: 600; }
              .status-paid { background: #d1fae5; color: #059669; }
              .status-open { background: #fef3c7; color: #d97706; }
            </style>
            </head>
            <body>
              <div class="header"><h1>Surprise Granite</h1><p>Marble & Quartz</p></div>
              <h2>Invoice #${stripeOnlyInvoice.number}</h2>
              <div class="info-box">
                <p><strong>Customer:</strong> ${stripeOnlyInvoice.customer_name || stripeOnlyInvoice.customer_email || 'N/A'}</p>
                <p><strong>Status:</strong> <span class="status status-${stripeOnlyInvoice.status}">${stripeOnlyInvoice.status}</span></p>
                <p><strong>Amount Due:</strong> $${(stripeOnlyInvoice.amount_due || 0).toFixed(2)}</p>
                <p><strong>Due Date:</strong> ${stripeOnlyInvoice.due_date ? new Date(stripeOnlyInvoice.due_date).toLocaleDateString() : 'N/A'}</p>
              </div>
              <p style="color: #666;">This invoice was created in Stripe. For full details, view in the Stripe Dashboard.</p>
              <div class="no-print" style="margin-top: 30px; text-align: center;">
                <button onclick="window.print()" style="padding: 12px 24px; background: #f9cb00; color: #1a1a2e; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px;">Print / Save PDF</button>
                <button onclick="window.close()" style="padding: 12px 24px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Close</button>
              </div>
              <style>@media print { .no-print { display: none !important; } }</style>
            </body>
            </html>
          `;
          const win = window.open('', '_blank');
          win.document.write(invoiceHtml);
          win.document.close();
          return;
        }

        // For Supabase invoices, fetch full details
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*, invoice_items(*)')
          .eq('id', invoiceId)
          .single();

        if (!invoice) {
          alert('Invoice not found');
          return;
        }

        // Create a simple invoice view modal or open in new tab
        const invoiceHtml = `
          <html>
          <head><title>Invoice #${invoice.invoice_number}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
            .header { border-bottom: 3px solid #f9cb00; padding-bottom: 20px; margin-bottom: 30px; }
            .header h1 { color: #1a1a2e; margin: 0; }
            .header p { color: #666; margin: 5px 0 0; }
            .info-row { display: flex; justify-content: space-between; margin-bottom: 30px; }
            .info-box { background: #f8f9fa; padding: 15px; border-radius: 8px; }
            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
            th { background: #f8f9fa; font-weight: 600; }
            .total-row { font-size: 18px; font-weight: bold; color: #f9cb00; }
            .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
            .status-open { background: #fef3c7; color: #d97706; }
            .status-paid { background: #d1fae5; color: #059669; }
            @media print { body { padding: 20px; } }
          </style>
          </head>
          <body>
            <div class="header">
              <h1>Surprise Granite</h1>
              <p>Marble & Quartz</p>
            </div>
            <h2>Invoice #${invoice.invoice_number}</h2>
            <div class="info-row">
              <div class="info-box">
                <strong>Bill To:</strong><br>
                ${invoice.customer_name || 'N/A'}<br>
                ${invoice.customer_email || ''}<br>
                ${invoice.customer_phone || ''}
              </div>
              <div class="info-box">
                <strong>Status:</strong> <span class="status status-${invoice.status}">${invoice.status}</span><br>
                <strong>Due Date:</strong> ${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'N/A'}<br>
                <strong>Created:</strong> ${new Date(invoice.created_at).toLocaleDateString()}
              </div>
            </div>
            <table>
              <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
              <tbody>
                ${(invoice.invoice_items || []).map(item => `
                  <tr>
                    <td>${item.description || item.name || 'Item'}</td>
                    <td>${item.quantity || 1}</td>
                    <td>$${(item.unit_price || 0).toFixed(2)}</td>
                    <td>$${(item.total || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            <table style="width: 300px; margin-left: auto;">
              <tr><td>Subtotal:</td><td style="text-align: right;">$${(invoice.subtotal || invoice.total || 0).toFixed(2)}</td></tr>
              ${invoice.tax_amount ? `<tr><td>Tax:</td><td style="text-align: right;">$${invoice.tax_amount.toFixed(2)}</td></tr>` : ''}
              <tr class="total-row"><td>Total:</td><td style="text-align: right;">$${(invoice.total || 0).toFixed(2)}</td></tr>
              <tr><td>Amount Paid:</td><td style="text-align: right;">$${(invoice.amount_paid || 0).toFixed(2)}</td></tr>
              <tr style="font-weight: bold;"><td>Amount Due:</td><td style="text-align: right;">$${(invoice.amount_due || invoice.total || 0).toFixed(2)}</td></tr>
            </table>
            ${invoice.notes ? `<div style="margin-top: 30px; padding: 15px; background: #fffbeb; border-radius: 8px;"><strong>Notes:</strong><br>${invoice.notes}</div>` : ''}
            <div style="margin-top: 40px; text-align: center; color: #999; font-size: 12px;">
              <p>Surprise Granite | (602) 833-3189 | info@surprisegranite.com</p>
            </div>
            <div class="no-print" style="margin-top: 30px; text-align: center;">
              <button onclick="window.print()" style="padding: 12px 24px; background: #f9cb00; color: #1a1a2e; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; margin-right: 10px;">Print / Save PDF</button>
              <button onclick="window.close()" style="padding: 12px 24px; background: #333; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Close</button>
            </div>
            <style>@media print { .no-print { display: none !important; } }</style>
          </body>
          </html>
        `;

        const win = window.open('', '_blank');
        win.document.write(invoiceHtml);
        win.document.close();
      } catch (err) {
        console.error('View invoice error:', err);
        alert('Error viewing invoice');
      }
    }

    async function sendSupabaseInvoice(invoiceId) {
      if (!confirm('Send this invoice to the customer?')) return;

      try {
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*, invoice_items(*)')
          .eq('id', invoiceId)
          .single();

        if (!invoice || !invoice.customer_email) {
          alert('Invoice not found or missing customer email');
          return;
        }

        // Send via email API
        const response = await apiCall('/api/send-invoice-email', {
          method: 'POST',
          body: JSON.stringify({
            customer_email: invoice.customer_email,
            customer_name: invoice.customer_name,
            invoice_number: invoice.invoice_number,
            items: invoice.invoice_items,
            subtotal: invoice.subtotal,
            tax_amount: invoice.tax_amount,
            total: invoice.total,
            due_date: invoice.due_date,
            notes: invoice.notes
          })
        });

        if (response.ok) {
          showToast('Invoice sent!');
          // Update status
          await supabaseClient.from('invoices').update({ status: 'sent' }).eq('id', invoiceId);
          loadInvoices();

          // Send SMS notification (email already sent by API)
          sendNotification('invoice', 'sent', invoice, {
            email: null, // Already sent by email API
            phone: invoice.customer_phone,
            name: invoice.customer_name
          });
        } else {
          // Fallback to email client
          const subject = encodeURIComponent(`Invoice #${invoice.invoice_number} from Surprise Granite`);
          const body = encodeURIComponent(`Hi ${invoice.customer_name},\n\nPlease find your invoice #${invoice.invoice_number} for $${invoice.total.toFixed(2)}.\n\nDue date: ${invoice.due_date ? new Date(invoice.due_date).toLocaleDateString() : 'Upon receipt'}\n\nThank you,\nSurprise Granite`);
          window.open(`mailto:${invoice.customer_email}?subject=${subject}&body=${body}`);
          showToast('Email client opened');
        }
      } catch (err) {
        console.error('Send invoice error:', err);
        alert('Error sending invoice');
      }
    }

    async function deleteSupabaseInvoice(invoiceId) {
      if (!confirm('Delete this invoice? This cannot be undone.')) return;

      try {
        // Delete invoice items first
        await supabaseClient.from('invoice_items').delete().eq('invoice_id', invoiceId);
        // Delete invoice
        await supabaseClient.from('invoices').delete().eq('id', invoiceId);

        showToast('Invoice deleted');
        loadInvoices();
      } catch (err) {
        console.error('Delete invoice error:', err);
        alert('Error deleting invoice');
      }
    }

    async function sendInvoiceReminder(invoiceId) {
      if (!confirm('Send payment reminder for this invoice?')) return;

      try {
        // Check if it's a Stripe invoice (starts with 'in_')
        if (invoiceId.startsWith('in_')) {
          // Use Stripe API
          const response = await apiCall(`/api/invoices/${invoiceId}/remind`, {
            method: 'POST'
          });
          if (response.ok) {
            showToast('Payment reminder sent!', 'success');
          } else {
            throw new Error('Stripe reminder failed');
          }
        } else {
          // Supabase invoice - send via our email API
          const { data: invoice } = await supabaseClient
            .from('invoices')
            .select('*')
            .eq('id', invoiceId)
            .single();

          if (!invoice || !invoice.customer_email) {
            showToast('Invoice not found or missing customer email', 'error');
            return;
          }

          const response = await apiCall('/api/send-invoice-reminder', {
            method: 'POST',
            body: JSON.stringify({
              customer_email: invoice.customer_email,
              customer_name: invoice.customer_name,
              invoice_number: invoice.invoice_number,
              amount_due: invoice.amount_due || invoice.total,
              due_date: invoice.due_date,
              payment_url: invoice.stripe_hosted_url || null
            })
          });

          if (response.ok) {
            showToast('Payment reminder sent!', 'success');
          } else {
            // Fallback to email client
            const subject = encodeURIComponent(`Payment Reminder - Invoice #${invoice.invoice_number}`);
            const body = encodeURIComponent(`Hi ${invoice.customer_name || 'there'},\n\nThis is a friendly reminder that Invoice #${invoice.invoice_number} for $${(invoice.amount_due || invoice.total || 0).toFixed(2)} is due.\n\nPlease let us know if you have any questions.\n\nThank you,\nSurprise Granite`);
            window.open(`mailto:${invoice.customer_email}?subject=${subject}&body=${body}`);
            showToast('Email client opened for reminder', 'info');
          }
        }
      } catch (err) {
        console.error('Send reminder error:', err);
        showToast('Error sending reminder', 'error');
      }
    }

    async function markInvoicePaid(invoiceId) {
      if (!confirm('Mark this invoice as paid?')) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get invoice details
        const { data: invoice, error: fetchError } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        if (fetchError) throw fetchError;

        // If invoice has lead_id but no customer_id, convert lead to customer
        let customerId = invoice.customer_id;
        if (invoice.lead_id && !customerId) {
          console.log('[Invoice Paid] Converting lead to customer:', invoice.lead_id);
          const { data: lead } = await supabaseClient
            .from('leads')
            .select('*')
            .eq('id', invoice.lead_id)
            .single();

          if (lead) {
            // Check if customer already exists by email
            const { data: existingCustomer } = await supabaseClient
              .from('customers')
              .select('id')
              .eq('user_id', user.id)
              .ilike('email', lead.email || '')
              .single();

            if (existingCustomer) {
              customerId = existingCustomer.id;
            } else {
              // Create new customer from lead
              const { data: newCustomer, error: custErr } = await supabaseClient
                .from('customers')
                .insert({
                  user_id: user.id,
                  name: lead.full_name || lead.homeowner_name || lead.name || 'Customer',
                  email: lead.email || lead.homeowner_email,
                  phone: lead.phone || lead.homeowner_phone,
                  address: lead.address || lead.homeowner_address,
                  city: lead.city,
                  state: lead.state,
                  zip: lead.zip,
                  source: 'converted_lead',
                  lead_id: lead.id,
                  notes: `Converted from lead on ${new Date().toLocaleDateString()}`
                })
                .select()
                .single();

              if (!custErr && newCustomer) {
                customerId = newCustomer.id;
                console.log('[Invoice Paid] Created customer from lead:', customerId);
              }
            }

            // Update lead status to converted and link to customer
            await supabaseClient
              .from('leads')
              .update({
                status: 'converted',
                customer_id: customerId,
                converted_at: new Date().toISOString()
              })
              .eq('id', lead.id);

            // Update invoice with customer_id
            await supabaseClient
              .from('invoices')
              .update({ customer_id: customerId })
              .eq('id', invoiceId);

            console.log('[Invoice Paid] Lead converted:', lead.id, '-> Customer:', customerId);
          }
        }

        // Update invoice status
        const { error: updateError } = await supabaseClient
          .from('invoices')
          .update({
            status: 'paid',
            amount_paid: invoice.total,
            amount_due: 0,
            paid_at: new Date().toISOString()
          })
          .eq('id', invoiceId);

        if (updateError) throw updateError;

        // Record payment in payments table
        await supabaseClient.from('payments').insert({
          user_id: user.id,
          invoice_id: invoiceId,
          customer_id: customerId,
          amount: invoice.total,
          payment_method: 'manual',
          status: 'completed',
          notes: 'Manually marked as paid'
        });

        // Update customer totals if customer_id exists
        if (customerId) {
          const { data: customer } = await supabaseClient
            .from('customers')
            .select('total_spent, total_jobs')
            .eq('id', customerId)
            .single();

          if (customer) {
            await supabaseClient
              .from('customers')
              .update({
                total_spent: (customer.total_spent || 0) + invoice.total,
                total_jobs: (customer.total_jobs || 0) + 1
              })
              .eq('id', customerId);
          }
        }

        // Generate job number (fallback if RPC not available)
        let jobNumber = null;
        try {
          const { data } = await supabaseClient.rpc('get_next_job_number', { p_user_id: user.id });
          jobNumber = data;
        } catch { /* RPC may not exist yet */ }

        // Create job from paid invoice with full traceability
        const { data: newJob } = await supabaseClient.from('projects').insert({
          user_id: user.id,
          customer_id: customerId,
          invoice_id: invoiceId,
          estimate_id: invoice.estimate_id,
          lead_id: invoice.lead_id,  // Preserve lead reference for traceability
          job_number: jobNumber || `JOB-${Date.now()}`,
          customer_name: invoice.customer_name,
          customer_email: invoice.customer_email,
          customer_phone: invoice.customer_phone,
          customer_address: invoice.customer_address,
          description: invoice.project_name || 'Project from Invoice #' + invoice.invoice_number,
          contract_amount: invoice.total,
          status: 'approved'
        }).select().single();

        // Send payment confirmation notification (email + SMS)
        sendNotification('invoice', 'paid', {
          ...invoice,
          amount: invoice.total
        }, {
          email: invoice.customer_email,
          phone: invoice.customer_phone,
          name: invoice.customer_name
        });

        showToast('Invoice marked as paid! Job created.');
        loadInvoices();
        loadJobs();
      } catch (err) {
        console.error('Mark paid error:', err);
        alert('Error marking invoice as paid: ' + err.message);
      }
    }

    // Record deposit payment on an invoice
    async function recordDeposit(invoiceId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get invoice details
        const { data: invoice, error: fetchError } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        if (fetchError) throw fetchError;

        const depositRequested = invoice.deposit_requested || (invoice.total * 0.5);
        const depositAlreadyPaid = invoice.deposit_paid || 0;

        // Show deposit recording modal
        const modalHtml = `
          <div class="modal-overlay active" id="record-deposit-modal" onclick="if(event.target===this) closeRecordDepositModal()">
            <div class="modal" style="max-width: 450px;">
              <div class="modal-header">
                <h2 class="modal-title">Record Deposit Payment</h2>
                <button class="modal-close" onclick="closeRecordDepositModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="modal-body">
                <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted);">Invoice Total</span>
                    <span style="font-weight: 600;">$${(invoice.total || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted);">Deposit Requested</span>
                    <span style="font-weight: 600; color: var(--gold-primary);">$${depositRequested.toFixed(2)}</span>
                  </div>
                  ${depositAlreadyPaid > 0 ? `<div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Already Paid</span>
                    <span style="font-weight: 600; color: #22c55e;">$${depositAlreadyPaid.toFixed(2)}</span>
                  </div>` : ''}
                </div>

                <div class="form-group">
                  <label>Deposit Amount Received</label>
                  <input type="number" id="deposit-amount-input" value="${depositRequested.toFixed(2)}" min="0" max="${invoice.total}" step="0.01" style="font-size: 18px; font-weight: 600;"/>
                </div>

                <div class="form-group">
                  <label>Payment Method</label>
                  <select id="deposit-payment-method">
                    <option value="card">Credit/Debit Card</option>
                    <option value="cash">Cash</option>
                    <option value="check">Check</option>
                    <option value="transfer">Bank Transfer</option>
                    <option value="venmo">Venmo</option>
                    <option value="zelle">Zelle</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Notes (Optional)</label>
                  <input type="text" id="deposit-notes" placeholder="e.g., Check #1234"/>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn-modern secondary" onclick="closeRecordDepositModal()">Cancel</button>
                <button class="btn-modern primary" onclick="saveDepositPayment('${invoiceId}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                  Record Deposit
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (err) {
        console.error('Record deposit error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function closeRecordDepositModal() {
      const modal = document.getElementById('record-deposit-modal');
      if (modal) modal.remove();
    }

    async function saveDepositPayment(invoiceId) {
      const depositAmount = parseFloat(document.getElementById('deposit-amount-input')?.value) || 0;
      const paymentMethod = document.getElementById('deposit-payment-method')?.value || 'other';
      const notes = document.getElementById('deposit-notes')?.value || '';

      if (depositAmount <= 0) {
        showToast('Please enter a valid deposit amount', 'warning');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get current invoice
        const { data: invoice } = await supabaseClient
          .from('invoices')
          .select('*')
          .eq('id', invoiceId)
          .single();

        const previousDeposit = invoice.deposit_paid || 0;
        const totalDepositPaid = previousDeposit + depositAmount;
        const newAmountPaid = (invoice.amount_paid || 0) + depositAmount;
        const newAmountDue = invoice.total - newAmountPaid;

        // Update invoice with deposit
        const { error: updateError } = await supabaseClient
          .from('invoices')
          .update({
            deposit_paid: totalDepositPaid,
            deposit_paid_at: new Date().toISOString(),
            deposit_payment_method: paymentMethod,
            amount_paid: newAmountPaid,
            amount_due: Math.max(0, newAmountDue),
            balance_due: Math.max(0, newAmountDue),
            status: newAmountDue <= 0 ? 'paid' : 'partial'
          })
          .eq('id', invoiceId);

        if (updateError) throw updateError;

        // Record payment
        await supabaseClient.from('payments').insert({
          user_id: user.id,
          invoice_id: invoiceId,
          customer_id: invoice.customer_id,
          amount: depositAmount,
          payment_method: paymentMethod,
          payment_type: 'deposit',
          status: 'completed',
          notes: notes || 'Deposit payment'
        });

        closeRecordDepositModal();
        showToast(`Deposit of $${depositAmount.toFixed(2)} recorded!`, 'success');
        loadInvoices();

      } catch (err) {
        console.error('Save deposit error:', err);
        showToast('Error saving deposit: ' + err.message, 'error');
      }
    }

    // Record deposit payment on an estimate
    async function recordEstimateDeposit(estimateId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get estimate details
        const { data: estimate, error: fetchError } = await supabaseClient
          .from('estimates')
          .select('*')
          .eq('id', estimateId)
          .single();

        if (fetchError) throw fetchError;

        const depositRequested = estimate.deposit_amount || estimate.deposit_requested || (estimate.total * 0.5);
        const depositAlreadyPaid = estimate.deposit_paid || 0;

        // Show deposit recording modal
        const modalHtml = `
          <div class="modal-overlay active" id="record-estimate-deposit-modal" onclick="if(event.target===this) closeRecordEstimateDepositModal()">
            <div class="modal" style="max-width: 450px;">
              <div class="modal-header">
                <h2 class="modal-title">Record Estimate Deposit</h2>
                <button class="modal-close" onclick="closeRecordEstimateDepositModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
              </div>
              <div class="modal-body">
                <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted);">Estimate Total</span>
                    <span style="font-weight: 600;">$${(estimate.total || 0).toFixed(2)}</span>
                  </div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted);">Deposit Requested</span>
                    <span style="font-weight: 600; color: var(--gold-primary);">$${depositRequested.toFixed(2)}</span>
                  </div>
                  ${depositAlreadyPaid > 0 ? `<div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted);">Already Paid</span>
                    <span style="font-weight: 600; color: #22c55e;">$${depositAlreadyPaid.toFixed(2)}</span>
                  </div>` : ''}
                </div>

                <div class="form-group">
                  <label>Deposit Amount Received</label>
                  <input type="number" id="estimate-deposit-amount-input" value="${depositRequested.toFixed(2)}" min="0" max="${estimate.total}" step="0.01" style="font-size: 18px; font-weight: 600;"/>
                </div>

                <div class="form-group">
                  <label>Payment Method</label>
                  <select id="estimate-deposit-payment-method">
                    <option value="card">Credit/Debit Card</option>
                    <option value="cash">Cash</option>
                    <option value="check">Check</option>
                    <option value="transfer">Bank Transfer</option>
                    <option value="venmo">Venmo</option>
                    <option value="zelle">Zelle</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Notes (Optional)</label>
                  <input type="text" id="estimate-deposit-notes" placeholder="e.g., Check #1234"/>
                </div>

                <div style="background: rgba(34, 197, 94, 0.1); border-radius: 8px; padding: 12px; margin-top: 16px;">
                  <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="estimate-deposit-convert" checked style="width: 18px; height: 18px;">
                    <span style="font-size: 13px;">Convert to invoice after recording deposit</span>
                  </label>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn-modern secondary" onclick="closeRecordEstimateDepositModal()">Cancel</button>
                <button class="btn-modern primary" onclick="saveEstimateDepositPayment('${estimateId}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                  Record Deposit
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (err) {
        console.error('Record estimate deposit error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function closeRecordEstimateDepositModal() {
      const modal = document.getElementById('record-estimate-deposit-modal');
      if (modal) modal.remove();
    }

    async function saveEstimateDepositPayment(estimateId) {
      const depositAmount = parseFloat(document.getElementById('estimate-deposit-amount-input')?.value) || 0;
      const paymentMethod = document.getElementById('estimate-deposit-payment-method')?.value || 'other';
      const notes = document.getElementById('estimate-deposit-notes')?.value || '';
      const convertToInvoice = document.getElementById('estimate-deposit-convert')?.checked ?? true;

      if (depositAmount <= 0) {
        showToast('Please enter a valid deposit amount', 'warning');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        // Get current estimate
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*')
          .eq('id', estimateId)
          .single();

        const previousDeposit = estimate.deposit_paid || 0;
        const totalDepositPaid = previousDeposit + depositAmount;
        const balanceDue = estimate.total - totalDepositPaid;

        // Update estimate with deposit
        const { error: updateError } = await supabaseClient
          .from('estimates')
          .update({
            deposit_paid: totalDepositPaid,
            deposit_paid_at: new Date().toISOString(),
            balance_due: Math.max(0, balanceDue),
            status: 'approved'
          })
          .eq('id', estimateId);

        if (updateError) throw updateError;

        // Record payment
        await supabaseClient.from('payments').insert({
          user_id: user.id,
          estimate_id: estimateId,
          amount: depositAmount,
          payment_method: paymentMethod,
          payment_type: 'deposit',
          status: 'completed',
          notes: notes || 'Estimate deposit payment'
        });

        closeRecordEstimateDepositModal();
        showToast(`Deposit of $${depositAmount.toFixed(2)} recorded!`, 'success');

        // Optionally convert to invoice
        if (convertToInvoice) {
          await createInvoiceFromEstimate(estimateId);
        } else {
          loadEstimates();
        }

      } catch (err) {
        console.error('Save estimate deposit error:', err);
        showToast('Error saving deposit: ' + err.message, 'error');
      }
    }

    // Update showPage to load invoices and wallet
    const _originalShowPage = showPage;
    showPage = async function(page) {
      await _originalShowPage(page);
      if (page === 'invoices' && isAdmin) {
        await loadInvoices();
      }
      if (page === 'wallet' && isAdmin) {
        await loadWalletData();
      }
      if (page === 'calendar') {
        initCalendar();
      }
      if (page === 'jobs') {
        await loadJobs();
      }
      if (page === 'collaborators') {
        loadCollaborators();
      }
    };

    // ============ WALLET MANAGEMENT ============
    let totalRevenue = 0;

    async function loadWalletData() {
      await Promise.all([
        loadBalance(),
        loadTransactions(),
        loadPayouts()
      ]);
    }

    async function loadBalance() {
      try {
        const response = await apiCall('/api/balance');
        if (!response.ok) throw new Error('Failed to load balance');

        const data = await response.json();

        document.getElementById('available-balance').textContent = `$${data.total_available.toFixed(2)}`;
        document.getElementById('pending-balance').textContent = `$${data.total_pending.toFixed(2)}`;

      } catch (err) {
        console.error('Balance error:', err);
        document.getElementById('available-balance').textContent = '$--.--';
        document.getElementById('pending-balance').textContent = '$--.--';
      }
    }

    async function loadTransactions() {
      const container = document.getElementById('transactions-list');
      if (!container) return;

      try {
        const response = await apiCall('/api/balance-transactions?limit=15');
        if (!response.ok) throw new Error('Failed to load transactions');

        const data = await response.json();

        if (data.transactions.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No transactions yet</p>
            </div>
          `;
          return;
        }

        // Calculate total revenue from charges
        totalRevenue = data.transactions
          .filter(t => t.type === 'charge' && t.amount > 0)
          .reduce((sum, t) => sum + t.amount, 0);

        document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;

        container.innerHTML = data.transactions.map(t => {
          const isPositive = t.amount > 0 && t.type !== 'payout' && t.type !== 'stripe_fee';
          const iconClass = t.type === 'payout' ? 'payout' : (t.type === 'stripe_fee' ? 'fee' : 'income');
          const icon = t.type === 'payout'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>'
            : t.type === 'stripe_fee'
            ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>';

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon ${iconClass}">${icon}</div>
                <div class="transaction-details">
                  <h4>${t.description || t.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                  <p>${t.type} ${t.fee > 0 ? `• Fee: $${t.fee.toFixed(2)}` : ''}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                <div class="date">${new Date(t.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Transactions error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load transactions</p>
          </div>
        `;
      }
    }

    async function loadPayouts() {
      const container = document.getElementById('payouts-list');
      if (!container) return;

      try {
        const response = await apiCall('/api/payouts?limit=10');
        if (!response.ok) throw new Error('Failed to load payouts');

        const data = await response.json();

        if (data.payouts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <p>No payouts yet. Funds are automatically transferred to your bank account.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = data.payouts.map(p => {
          const statusColor = p.status === 'paid' ? 'var(--success)' : (p.status === 'pending' ? 'var(--warning)' : 'var(--text-muted)');

          return `
            <div class="transaction-row">
              <div class="transaction-info">
                <div class="transaction-icon payout">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <div class="transaction-details">
                  <h4>Bank Transfer</h4>
                  <p style="color: ${statusColor};">${p.status.charAt(0).toUpperCase() + p.status.slice(1)} • Arrives ${new Date(p.arrival_date).toLocaleDateString()}</p>
                </div>
              </div>
              <div class="transaction-amount">
                <div class="amount">$${p.amount.toFixed(2)}</div>
                <div class="date">${new Date(p.created).toLocaleDateString()}</div>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Payouts error:', err);
        container.innerHTML = `
          <div class="empty-state">
            <p>Unable to load payouts</p>
          </div>
        `;
      }
    }

    // ============================================
    // STONE LISTINGS - Remnants Marketplace
    // ============================================

    let countertopsData = [];
    const MAX_FREE_LISTINGS = 3;

    // Load countertops data for autocomplete
    async function loadCountertopsData() {
      try {
        const response = await fetch('/data/countertops.json');
        countertopsData = await response.json();
      } catch (err) {
        console.error('Failed to load countertops data:', err);
      }
    }

    // Initialize listings functionality
    loadCountertopsData();

    // Stone autocomplete
    const stoneSearchInput = document.getElementById('listing-stone-search');
    const autocompleteResults = document.getElementById('stone-autocomplete-results');

    if (stoneSearchInput) {
      stoneSearchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase().trim();
        if (query.length < 2) {
          autocompleteResults.classList.remove('active');
          return;
        }

        const matches = countertopsData
          .filter(stone =>
            stone.name.toLowerCase().includes(query) ||
            (stone.brand && stone.brand.toLowerCase().includes(query)) ||
            (stone.color && stone.color.toLowerCase().includes(query))
          )
          .slice(0, 8);

        if (matches.length === 0) {
          autocompleteResults.innerHTML = '<div style="padding: 12px; color: var(--text-muted);">No matching stones found</div>';
        } else {
          autocompleteResults.innerHTML = matches.map(stone => `
            <div class="stone-result-item" onclick="selectStone(${JSON.stringify(stone).replace(/"/g, '&quot;')})">
              <img src="${stone.image || '/images/placeholder.svg'}" alt="" class="stone-result-thumb">
              <div class="stone-result-info">
                <div class="stone-result-name">${stone.name}</div>
                <div class="stone-result-meta">${stone.brand || ''} • ${stone.type || ''} • ${stone.color || ''}</div>
              </div>
            </div>
          `).join('');
        }
        autocompleteResults.classList.add('active');
      });

      // Close autocomplete when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.stone-autocomplete')) {
          autocompleteResults.classList.remove('active');
        }
      });
    }

    function selectStone(stone) {
      document.getElementById('listing-stone-slug').value = stone.slug || '';
      document.getElementById('listing-stone-name').value = stone.name || '';
      document.getElementById('listing-material-type').value = stone.type || '';
      document.getElementById('listing-brand').value = stone.brand || '';
      document.getElementById('listing-color').value = stone.color || '';
      document.getElementById('listing-stone-search').value = stone.name;

      // Update preview
      document.getElementById('selected-stone-preview').style.display = 'block';
      document.getElementById('selected-stone-img').src = stone.image || '/images/placeholder.svg';
      document.getElementById('selected-stone-name').textContent = stone.name;
      document.getElementById('selected-stone-meta').textContent = `${stone.brand || ''} • ${stone.type || ''} • ${stone.color || ''}`;

      // Auto-fill title if empty
      const titleInput = document.getElementById('listing-title');
      if (!titleInput.value) {
        titleInput.value = `${stone.name} Remnant`;
      }

      autocompleteResults.classList.remove('active');
    }

    function clearSelectedStone() {
      document.getElementById('listing-stone-slug').value = '';
      document.getElementById('listing-stone-name').value = '';
      document.getElementById('listing-material-type').value = '';
      document.getElementById('listing-brand').value = '';
      document.getElementById('listing-color').value = '';
      document.getElementById('listing-stone-search').value = '';
      document.getElementById('selected-stone-preview').style.display = 'none';
    }

    function togglePriceField() {
      const priceInput = document.getElementById('listing-price');
      const contactCheckbox = document.getElementById('listing-price-contact');
      priceInput.disabled = contactCheckbox.checked;
      if (contactCheckbox.checked) {
        priceInput.value = '';
        priceInput.placeholder = 'Contact for price';
      } else {
        priceInput.placeholder = '0.00';
      }
    }

    // Image Upload Functions
    function triggerImageUpload(slotNum) {
      const fileInput = document.getElementById(`image-file-${slotNum}`);
      fileInput.click();
    }

    async function handleImageUpload(slotNum, input) {
      const file = input.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be less than 5MB');
        return;
      }

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const progress = document.getElementById(`upload-progress-${slotNum}`);
      const progressBar = document.getElementById(`upload-bar-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);

      // Show progress
      progress.style.display = 'block';
      progressBar.style.width = '10%';

      try {
        // Get current user
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) {
          alert('Please log in to upload images');
          return;
        }

        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `${user.id}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

        progressBar.style.width = '30%';

        // Compress image if needed
        const compressedFile = await compressImage(file, 1200, 0.8);

        progressBar.style.width = '50%';

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('listing-images')
          .upload(fileName, compressedFile, {
            cacheControl: '3600',
            upsert: false
          });

        progressBar.style.width = '80%';

        if (error) {
          // Fallback: use data URL for preview and let user know to use URL input
          console.warn('Storage upload failed, using local preview:', error);
          const dataUrl = await readFileAsDataUrl(file);
          preview.src = dataUrl;
          preview.style.display = 'block';
          placeholder.style.display = 'none';
          removeBtn.style.display = 'flex';
          slot.classList.add('has-image');
          // Store data URL temporarily (won't persist to DB, but shows preview)
          hiddenInput.value = dataUrl;
          progressBar.style.width = '100%';
          setTimeout(() => { progress.style.display = 'none'; }, 500);
          return;
        }

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('listing-images')
          .getPublicUrl(fileName);

        progressBar.style.width = '100%';

        // Update UI
        preview.src = urlData.publicUrl;
        preview.style.display = 'block';
        placeholder.style.display = 'none';
        removeBtn.style.display = 'flex';
        slot.classList.add('has-image');
        hiddenInput.value = urlData.publicUrl;

        setTimeout(() => { progress.style.display = 'none'; }, 500);

      } catch (err) {
        console.error('Upload error:', err);
        alert('Failed to upload image. Please try again or paste an image URL.');
        progress.style.display = 'none';
      }
    }

    function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function compressImage(file, maxWidth, quality) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;

          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }

          canvas.width = width;
          canvas.height = height;

          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);

          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: 'image/jpeg' }));
          }, 'image/jpeg', quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    function removeImage(event, slotNum) {
      event.stopPropagation();

      const slot = document.getElementById(`image-slot-${slotNum}`);
      const placeholder = document.getElementById(`upload-placeholder-${slotNum}`);
      const preview = document.getElementById(`image-preview-${slotNum}`);
      const removeBtn = document.getElementById(`remove-btn-${slotNum}`);
      const hiddenInput = document.getElementById(`listing-image-${slotNum}`);
      const fileInput = document.getElementById(`image-file-${slotNum}`);

      // Reset UI
      preview.src = '';
      preview.style.display = 'none';
      placeholder.style.display = 'flex';
      removeBtn.style.display = 'none';
      slot.classList.remove('has-image');
      hiddenInput.value = '';
      fileInput.value = '';
    }

    function updateImagePreviews() {
      const previewGrid = document.getElementById('image-preview-grid');
      const images = [
        document.getElementById('listing-image-1').value,
        document.getElementById('listing-image-2').value,
        document.getElementById('listing-image-3').value,
        document.getElementById('listing-image-4').value
      ].filter(url => url);

      previewGrid.innerHTML = images.map((url, i) => `
        <div class="image-preview-item">
          <img src="${url}" alt="Preview ${i + 1}" onerror="this.src='/images/placeholder.svg'">
        </div>
      `).join('');
    }

    // Modal functions
    async function openCreateListingModal() {
      // Check listing limit first
      const canCreate = await checkListingLimit();
      if (!canCreate.allowed) {
        alert(`You've reached your limit of ${canCreate.max} free listings. Upgrade to Pro for unlimited listings!`);
        return;
      }

      document.getElementById('create-listing-modal').classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeCreateListingModal() {
      document.getElementById('create-listing-modal').classList.remove('active');
      document.body.style.overflow = '';
      // Reset form
      document.getElementById('create-listing-form').reset();
      clearSelectedStone();
      // Reset category to default
      selectListingCategory('countertops');
    }

    function selectListingCategory(category) {
      // Update hidden input
      document.getElementById('listing-category').value = category;

      // Update visual selection
      document.querySelectorAll('.listing-category-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.category === category);
      });

      // Update product selection section based on category
      const productSection = document.getElementById('product-selection-section');
      const titleEl = document.getElementById('product-selection-title');
      const labelEl = document.getElementById('product-search-label');
      const searchInput = document.getElementById('listing-stone-search');

      // Category-specific labels
      const categoryConfig = {
        countertops: {
          title: 'Select Stone',
          label: 'Search countertops catalog (optional)',
          placeholder: 'Start typing stone name...',
          showCatalog: true
        },
        tile: {
          title: 'Select Tile',
          label: 'Search tile catalog (optional)',
          placeholder: 'Start typing tile name...',
          showCatalog: true
        },
        flooring: {
          title: 'Select Flooring',
          label: 'Search flooring catalog (optional)',
          placeholder: 'Start typing flooring name...',
          showCatalog: true
        },
        cabinets: {
          title: 'Cabinet Details',
          label: 'Describe your cabinets',
          placeholder: 'e.g., Shaker White 36" Base Cabinet',
          showCatalog: false
        },
        supplies: {
          title: 'Product Details',
          label: 'Describe your product',
          placeholder: 'e.g., Mapei Kerabond Thinset 50lb',
          showCatalog: false
        },
        other: {
          title: 'Product Details',
          label: 'Describe your item',
          placeholder: 'e.g., Delta Faucet, Cabinet Hardware',
          showCatalog: false
        }
      };

      const config = categoryConfig[category] || categoryConfig.other;
      titleEl.textContent = config.title;
      labelEl.textContent = config.label;
      searchInput.placeholder = config.placeholder;

      // Show/hide autocomplete for categories without catalog
      const autocompleteResults = document.getElementById('stone-autocomplete-results');
      if (!config.showCatalog) {
        autocompleteResults.style.display = 'none';
      }

      // Clear previous selection when switching categories
      clearSelectedStone();
    }

    async function checkListingLimit() {
      const user = await supabaseClient.auth.getUser();
      if (!user.data.user) return { allowed: false, remaining: 0 };

      // Check if super admin by email
      const userEmail = (user.data.user.email || '').toLowerCase();
      if (SUPER_ADMIN_EMAILS.includes(userEmail)) {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Check if pro account
      const { data: profile } = await supabaseClient
        .from('sg_users')
        .select('account_type')
        .eq('id', user.data.user.id)
        .single();

      const accountType = profile?.account_type || 'homeowner';
      if (accountType.startsWith('pro_') || accountType === 'admin' || accountType === 'super_admin') {
        return { allowed: true, remaining: Infinity, isPro: true };
      }

      // Count active listings
      const { count } = await supabaseClient
        .from('stone_listings')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.data.user.id)
        .eq('status', 'active');

      return {
        allowed: (count || 0) < MAX_FREE_LISTINGS,
        remaining: MAX_FREE_LISTINGS - (count || 0),
        current: count || 0,
        max: MAX_FREE_LISTINGS,
        isPro: false
      };
    }

    async function handleCreateListing(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('submit-listing-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div> Creating...';

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          throw new Error('Please sign in to create a listing');
        }

        // Get category and determine product name
        const category = document.getElementById('listing-category').value;
        const catalogStoneName = document.getElementById('listing-stone-name').value;
        const userBrandInput = document.getElementById('listing-brand-input').value;

        const listingData = {
          user_id: user.data.user.id,
          category: category,
          condition: document.getElementById('listing-condition').value || 'new',
          stone_name: catalogStoneName || document.getElementById('listing-title').value,
          stone_slug: document.getElementById('listing-stone-slug').value || null,
          material_type: document.getElementById('listing-material-type').value || category,
          brand: document.getElementById('listing-brand').value || userBrandInput || null,
          color: document.getElementById('listing-color').value || null,
          title: document.getElementById('listing-title').value,
          description: document.getElementById('listing-description').value || null,
          dimensions: document.getElementById('listing-dimensions').value || null,
          thickness: document.getElementById('listing-thickness').value || null,
          quantity: parseInt(document.getElementById('listing-quantity').value) || 1,
          price: document.getElementById('listing-price-contact').checked ? null : (parseFloat(document.getElementById('listing-price').value) || null),
          image_url: document.getElementById('listing-image-1').value || null,
          image_url_2: document.getElementById('listing-image-2').value || null,
          image_url_3: document.getElementById('listing-image-3').value || null,
          image_url_4: document.getElementById('listing-image-4').value || null,
          city: document.getElementById('listing-city').value || null,
          state: document.getElementById('listing-state').value || null,
          zip_code: document.getElementById('listing-zip').value || null,
          show_email: document.getElementById('listing-show-email').checked,
          show_phone: document.getElementById('listing-show-phone').checked,
          contact_form_only: document.getElementById('listing-contact-form').checked,
          status: 'active'
        };

        const { data, error } = await supabaseClient
          .from('stone_listings')
          .insert([listingData])
          .select()
          .single();

        if (error) throw error;

        closeCreateListingModal();
        await loadMyListings();
        alert('Listing created successfully!');

      } catch (err) {
        console.error('Create listing error:', err);
        alert('Failed to create listing: ' + err.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
          Create Listing
        `;
      }
    }

    async function loadMyListings() {
      const loadingEl = document.getElementById('listings-loading');
      const emptyEl = document.getElementById('listings-empty');
      const gridEl = document.getElementById('listings-grid');
      const limitIndicator = document.getElementById('listing-limit-indicator');

      if (loadingEl) loadingEl.style.display = 'block';
      if (emptyEl) emptyEl.style.display = 'none';
      if (gridEl) gridEl.style.display = 'none';

      // Always try to load inquiries regardless of listings
      loadMyInquiries().catch(err => console.error('Inquiries load error:', err));

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          if (loadingEl) loadingEl.innerHTML = '<p style="color: var(--text-muted);">Please sign in to view your listings</p>';
          return;
        }

        // Update listing count and limit indicator
        const limitInfo = await checkListingLimit();
        if (limitIndicator) {
          if (limitInfo.isPro) {
            limitIndicator.textContent = 'Unlimited listings (Pro)';
            limitIndicator.style.color = 'var(--gold-primary)';
          } else {
            limitIndicator.textContent = `${limitInfo.current}/${limitInfo.max} listings used`;
            limitIndicator.style.color = limitInfo.remaining === 0 ? 'var(--error)' : 'var(--text-muted)';
          }
        }

        // Update nav badge
        const listingsCountEl = document.getElementById('listings-count');
        if (listingsCountEl) {
          const count = limitInfo.current || 0;
          listingsCountEl.textContent = count;
          listingsCountEl.setAttribute('data-count', count);
          listingsCountEl.style.display = count > 0 ? '' : 'none';
        }

        const { data: listings, error } = await supabaseClient
          .from('stone_listings')
          .select('*')
          .eq('user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (loadingEl) loadingEl.style.display = 'none';

        if (!listings || listings.length === 0) {
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        if (gridEl) {
          gridEl.style.display = 'grid';
          gridEl.innerHTML = listings.map(listing => {
          const category = listing.category || 'countertops';
          const categoryLabels = { countertops: 'Countertops', tile: 'Tile', flooring: 'Flooring', cabinets: 'Cabinets', supplies: 'Supplies', other: 'Other' };
          const conditionLabels = { new: 'New', remnant: 'Remnant', overstock: 'Overstock', used: 'Used', refurbished: 'Refurb' };
          return `
          <div class="listing-card">
            <div class="listing-image">
              ${listing.image_url ? `<img src="${listing.image_url}" alt="${listing.title}">` : '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">No Image</div>'}
              <span class="listing-category-badge ${category}">${categoryLabels[category] || category}</span>
              <span class="listing-status-badge ${listing.status}">${listing.status}</span>
            </div>
            <div class="listing-content">
              <div class="listing-title">${listing.title}</div>
              <div class="listing-stone">${listing.stone_name || listing.brand || ''}</div>
              <div class="listing-meta">
                ${listing.condition ? `<span class="listing-meta-item">${conditionLabels[listing.condition] || listing.condition}</span>` : ''}
                ${listing.dimensions ? `<span class="listing-meta-item">${listing.dimensions}</span>` : ''}
                ${listing.thickness ? `<span class="listing-meta-item">${listing.thickness}</span>` : ''}
              </div>
              <div class="listing-price ${listing.price === null ? 'contact' : ''}">
                ${listing.price !== null ? '$' + listing.price.toFixed(2) : 'Contact for price'}
              </div>
              <div class="listing-stats">
                <span>${listing.views || 0} views</span>
                <span>${listing.inquiries || 0} inquiries</span>
              </div>
              <div class="listing-actions">
                <button class="btn-edit" onclick="editListing('${listing.id}')">Edit</button>
                ${listing.status === 'active' ?
                  `<button class="btn-edit" onclick="markListingSold('${listing.id}')">Mark Sold</button>` :
                  `<button class="btn-edit" onclick="reactivateListing('${listing.id}')">Reactivate</button>`
                }
                <button class="btn-delete" onclick="deleteListing('${listing.id}')">Delete</button>
              </div>
            </div>
          </div>
        `}).join('');
        }

      } catch (err) {
        console.error('Load listings error:', err);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
      }
    }

    async function loadMyInquiries() {
      const loadingEl = document.getElementById('inquiries-loading');
      const emptyEl = document.getElementById('inquiries-empty');
      const listEl = document.getElementById('inquiries-list');
      const badgeEl = document.getElementById('inquiries-badge');

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          if (loadingEl) loadingEl.style.display = 'none';
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        // Get all inquiries for user's listings
        const { data: inquiries, error } = await supabaseClient
          .from('listing_inquiries')
          .select(`
            *,
            stone_listings!inner(title, user_id)
          `)
          .eq('stone_listings.user_id', user.data.user.id)
          .order('created_at', { ascending: false });

        if (loadingEl) loadingEl.style.display = 'none';

        if (error || !inquiries || inquiries.length === 0) {
          if (emptyEl) emptyEl.style.display = 'block';
          return;
        }

        const unreadCount = inquiries.filter(i => !i.read).length;
        if (badgeEl) {
          if (unreadCount > 0) {
            badgeEl.textContent = unreadCount;
            badgeEl.style.display = 'flex';
          } else {
            badgeEl.style.display = 'none';
          }
        }

        if (listEl) {
          listEl.style.display = 'block';
          listEl.innerHTML = inquiries.map(inquiry => `
          <div class="inquiry-item ${inquiry.read ? '' : 'unread'}" onclick="markInquiryRead('${inquiry.id}')">
            <div class="inquiry-header">
              <div>
                <div class="inquiry-listing">Re: ${inquiry.stone_listings.title}</div>
                <div class="inquiry-sender">${inquiry.sender_name}</div>
                <div class="inquiry-contact">
                  ${inquiry.sender_email}
                  ${inquiry.sender_phone ? ` • ${inquiry.sender_phone}` : ''}
                </div>
              </div>
              <div class="inquiry-date">${new Date(inquiry.created_at).toLocaleDateString()}</div>
            </div>
            <div class="inquiry-message">${inquiry.message}</div>
            <div class="inquiry-actions" onclick="event.stopPropagation()">
              <a href="mailto:${inquiry.sender_email}?subject=Re: ${encodeURIComponent(inquiry.stone_listings.title)}" class="btn btn-email">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Reply via Email
              </a>
              <button class="btn btn-payment" onclick="openPaymentModal('${inquiry.id}', '${inquiry.sender_name.replace(/'/g, "\\'")}', '${inquiry.sender_email}', '${inquiry.stone_listings.title.replace(/'/g, "\\'")}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Send Payment Link
              </button>
            </div>
          </div>
        `).join('');
        }

      } catch (err) {
        console.error('Load inquiries error:', err);
        if (loadingEl) loadingEl.style.display = 'none';
        if (emptyEl) emptyEl.style.display = 'block';
      }
    }

    async function markInquiryRead(id) {
      try {
        await supabaseClient
          .from('listing_inquiries')
          .update({ read: true })
          .eq('id', id);
        await loadMyInquiries();
      } catch (err) {
        console.error('Mark read error:', err);
      }
    }

    // ==========================================
    // UNIFIED MESSAGES / NOTIFICATION CENTER
    // ==========================================
    let messageItems = [];
    let currentNotification = null;
    let notificationFilter = 'all';

    async function loadConversations() {
      const listEl = document.getElementById('conversations-list');
      if (!listEl) {
        console.warn('[Messages] conversations-list element not found');
        return;
      }

      listEl.innerHTML = '<div class="loading-state"><div class="spinner-modern"></div><span>Loading...</span></div>';

      try {
        if (!supabaseClient) {
          console.error('[Messages] supabaseClient not initialized');
          listEl.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">Database not ready. Please refresh.</div>';
          return;
        }
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) {
          listEl.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">Please sign in to view messages</div>';
          return;
        }

        messageItems = [];

        // 1. Load Pro Notifications (design shares, favorites, wishlists, etc.)
        try {
          const { data: proNotifs } = await supabaseClient
            .from('pro_notifications')
            .select('*')
            .eq('pro_user_id', user.data.user.id)
            .order('created_at', { ascending: false })
            .limit(50);

          (proNotifs || []).forEach(n => {
            messageItems.push({
              id: n.id,
              type: 'notification',
              category: n.notification_type,
              title: n.title,
              message: n.message,
              data: n.data || {},
              isRead: n.is_read,
              createdAt: n.created_at,
              icon: getNotificationIcon(n.notification_type),
              color: getNotificationColor(n.notification_type)
            });
          });
        } catch (e) { console.warn('Pro notifications not available:', e.message); }

        // 2. Load Listing Inquiries (marketplace messages)
        try {
          const { data: inquiries } = await supabaseClient
            .from('listing_inquiries')
            .select('*, stone_listings!inner(title, user_id)')
            .eq('stone_listings.user_id', user.data.user.id)
            .order('created_at', { ascending: false })
            .limit(50);

          (inquiries || []).forEach(inq => {
            messageItems.push({
              id: inq.id,
              type: 'inquiry',
              category: 'listing_inquiry',
              title: `Inquiry: ${inq.stone_listings?.title || 'Listing'}`,
              message: inq.message,
              sender: { name: inq.sender_name, email: inq.sender_email, phone: inq.sender_phone },
              isRead: inq.read || false,
              createdAt: inq.created_at,
              icon: 'marketplace',
              color: 'blue'
            });
          });
        } catch (e) { console.warn('Listing inquiries not available:', e.message); }

        // 3. Load Customer Messages (grouped by customer)
        try {
          const { data: messages } = await supabaseClient
            .from('customer_messages')
            .select('*, customers(id, name, email, phone)')
            .order('created_at', { ascending: false })
            .limit(100);

          const customerMsgMap = new Map();
          (messages || []).forEach(msg => {
            if (!msg.customer_id) return;
            if (!customerMsgMap.has(msg.customer_id)) {
              customerMsgMap.set(msg.customer_id, {
                customer: msg.customers,
                messages: [],
                lastMessage: msg,
                unreadCount: 0
              });
            }
            customerMsgMap.get(msg.customer_id).messages.push(msg);
            if (msg.direction === 'inbound' && !msg.read_at) {
              customerMsgMap.get(msg.customer_id).unreadCount++;
            }
          });

          customerMsgMap.forEach((conv, customerId) => {
            const customer = conv.customer || {};
            messageItems.push({
              id: customerId,
              type: 'conversation',
              category: 'customer_message',
              title: customer.name || customer.email || 'Customer',
              message: conv.lastMessage?.message || 'No messages',
              customer: customer,
              messages: conv.messages,
              unreadCount: conv.unreadCount,
              isRead: conv.unreadCount === 0,
              createdAt: conv.lastMessage?.created_at || conv.customer?.created_at,
              icon: 'customer',
              color: 'gold'
            });
          });
        } catch (e) { console.warn('Customer messages not available:', e.message); }

        // 4. Load Recent Leads (as notifications)
        try {
          const { data: leads } = await supabaseClient
            .from('leads')
            .select('*')
            .eq('status', 'new')
            .order('created_at', { ascending: false })
            .limit(20);

          (leads || []).forEach(lead => {
            messageItems.push({
              id: lead.id,
              type: 'lead',
              category: 'new_lead',
              title: `New Lead: ${lead.full_name || lead.email || 'Unknown'}`,
              message: lead.project_type ? `${lead.project_type} project` : 'New inquiry',
              lead: lead,
            isRead: lead.status !== 'new',
            createdAt: lead.created_at,
            icon: 'lead',
            color: 'green'
            });
          });
        } catch (e) { console.warn('Leads not available:', e.message); }

        // Sort all by date
        messageItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        renderMessageItems();
        updateUnreadBadge();

      } catch (err) {
        console.error('Load notifications error:', err);
        listEl.innerHTML = '<div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">Error loading messages</div>';
      }
    }

    function getNotificationIcon(type) {
      const icons = {
        design_shared: 'design',
        favorite_added: 'heart',
        wishlist_shared: 'list',
        estimate_requested: 'estimate',
        new_customer: 'customer',
        customer_active: 'customer',
        system: 'bell'
      };
      return icons[type] || 'bell';
    }

    function getNotificationColor(type) {
      const colors = {
        design_shared: 'purple',
        favorite_added: 'pink',
        wishlist_shared: 'blue',
        estimate_requested: 'gold',
        new_customer: 'green',
        customer_active: 'green',
        system: 'gray'
      };
      return colors[type] || 'gray';
    }

    function renderMessageItems(filter = '') {
      const listEl = document.getElementById('conversations-list');
      if (!listEl) return;

      let filtered = messageItems;

      // Apply category filter
      if (notificationFilter !== 'all') {
        filtered = filtered.filter(n => {
          if (notificationFilter === 'unread') return !n.isRead;
          if (notificationFilter === 'messages') return n.type === 'conversation' || n.type === 'inquiry';
          if (notificationFilter === 'leads') return n.type === 'lead';
          if (notificationFilter === 'notifications') return n.type === 'notification';
          return true;
        });
      }

      // Apply search filter
      if (filter) {
        const q = filter.toLowerCase();
        filtered = filtered.filter(n =>
          (n.title || '').toLowerCase().includes(q) ||
          (n.message || '').toLowerCase().includes(q)
        );
      }

      if (filtered.length === 0) {
        listEl.innerHTML = `
          <div class="empty-state" style="padding: 40px; text-align: center; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="opacity: 0.3; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
            <p>${filter ? 'No results found' : 'No messages yet'}</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewMessageModal()">Send a Message</button>
          </div>
        `;
        return;
      }

      listEl.innerHTML = filtered.map(notif => {
        const initials = getNotifInitials(notif);
        const preview = (notif.message || '').slice(0, 60) + ((notif.message || '').length > 60 ? '...' : '');
        const time = formatMessageTime(notif.createdAt);
        const isActive = currentNotification && currentNotification.id === notif.id;
        const unreadDot = !notif.isRead ? '<div class="notif-unread-dot"></div>' : '';
        const badge = notif.unreadCount > 0 ? `<div class="conversation-unread">${notif.unreadCount}</div>` : '';

        return `
          <div class="conversation-item ${isActive ? 'active' : ''} ${!notif.isRead ? 'unread' : ''}" onclick="selectNotification('${notif.id}', '${notif.type}')">
            <div class="notif-avatar ${notif.color}">${getNotifIconSvg(notif.icon)}</div>
            <div class="conversation-details">
              <div class="conversation-name">${unreadDot}${escapeHtml(notif.title)}</div>
              <div class="conversation-preview">${escapeHtml(preview)}</div>
            </div>
            <div class="conversation-meta">
              <div class="conversation-time">${time}</div>
              ${badge}
            </div>
          </div>
        `;
      }).join('');

      // Update mobile badge count
      const countBadge = document.getElementById('conversations-count-badge');
      if (countBadge) {
        const unreadCount = messageItems.filter(n => !n.isRead).length;
        countBadge.textContent = unreadCount > 0 ? unreadCount : filtered.length;
        countBadge.style.background = unreadCount > 0 ? 'var(--gold)' : 'var(--surface-elevated)';
        countBadge.style.color = unreadCount > 0 ? 'var(--dark)' : 'var(--text-muted)';
      }
    }

    function getNotifInitials(notif) {
      if (notif.customer) {
        return (notif.customer.name || notif.customer.email || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      }
      if (notif.sender) {
        return (notif.sender.name || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
      }
      return '!';
    }

    function getNotifIconSvg(icon) {
      const icons = {
        design: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>',
        heart: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>',
        list: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>',
        estimate: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>',
        customer: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>',
        lead: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>',
        marketplace: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
        bell: '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>'
      };
      return icons[icon] || icons.bell;
    }

    function filterConversations(query) {
      renderMessageItems(query);
    }

    function setNotificationFilter(filter) {
      notificationFilter = filter;
      document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
      document.querySelector(`.filter-chip[data-filter="${filter}"]`)?.classList.add('active');
      renderMessageItems();
    }

    async function selectNotification(id, type) {
      const notif = messageItems.find(n => n.id === id);
      if (!notif) return;

      currentNotification = notif;
      renderMessageItems();
      mobileCollapseOnSelect();

      // Show appropriate detail view
      const headerEl = document.getElementById('thread-header');
      const inputEl = document.getElementById('message-input-area');
      const messagesEl = document.getElementById('thread-messages');

      if (type === 'conversation') {
        // Show customer conversation
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'block';

        const customer = notif.customer || {};
        document.getElementById('thread-avatar').textContent = getNotifInitials(notif);
        document.getElementById('thread-name').textContent = customer.name || customer.email || 'Customer';
        document.getElementById('thread-status').textContent = customer.email || customer.phone || '';

        await loadThreadMessages(id);
        markNotificationRead(notif);

      } else if (type === 'inquiry') {
        // Show inquiry detail
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'block';

        document.getElementById('thread-avatar').textContent = getNotifInitials(notif);
        document.getElementById('thread-name').textContent = notif.sender?.name || 'Inquiry';
        document.getElementById('thread-status').textContent = notif.sender?.email || '';

        messagesEl.innerHTML = `
          <div class="notif-detail-card">
            <div class="notif-detail-header">
              <h3>${escapeHtml(notif.title)}</h3>
              <span class="notif-time">${formatDateDivider(notif.createdAt)}</span>
            </div>
            <div class="notif-detail-body">
              <p>${escapeHtml(notif.message)}</p>
            </div>
            <div class="notif-detail-contact">
              ${notif.sender?.email ? `<a href="mailto:${notif.sender.email}" class="contact-link"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> ${notif.sender.email}</a>` : ''}
              ${notif.sender?.phone ? `<a href="tel:${notif.sender.phone}" class="contact-link"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg> ${notif.sender.phone}</a>` : ''}
            </div>
            <div class="notif-detail-actions">
              <button class="btn-modern primary" onclick="replyToInquiry('${id}')">Reply</button>
              <button class="btn-modern secondary" onclick="convertInquiryToLead('${id}')">Convert to Lead</button>
            </div>
          </div>
        `;
        markInquiryAsRead(id);

      } else if (type === 'lead') {
        // Show lead detail
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'none';

        document.getElementById('thread-avatar').textContent = getNotifInitials(notif);
        document.getElementById('thread-name').textContent = notif.lead?.full_name || 'Lead';
        document.getElementById('thread-status').textContent = notif.lead?.email || '';

        const lead = notif.lead || {};
        messagesEl.innerHTML = `
          <div class="notif-detail-card">
            <div class="notif-detail-header">
              <h3>New Lead</h3>
              <span class="notif-time">${formatDateDivider(notif.createdAt)}</span>
            </div>
            <div class="notif-detail-body">
              <div class="detail-row"><strong>Name:</strong> ${escapeHtml(lead.full_name || 'N/A')}</div>
              <div class="detail-row"><strong>Email:</strong> ${escapeHtml(lead.email || 'N/A')}</div>
              <div class="detail-row"><strong>Phone:</strong> ${escapeHtml(lead.phone || 'N/A')}</div>
              <div class="detail-row"><strong>Project:</strong> ${escapeHtml(lead.project_type || 'N/A')}</div>
              ${lead.notes ? `<div class="detail-row"><strong>Notes:</strong> ${escapeHtml(lead.notes)}</div>` : ''}
            </div>
            <div class="notif-detail-actions">
              <button class="btn-modern primary" onclick="openLeadModal('${lead.id}')">View Lead</button>
              <button class="btn-modern secondary" onclick="contactLead('${lead.id}')">Contact</button>
            </div>
          </div>
        `;

      } else {
        // Show notification detail
        if (headerEl) headerEl.style.display = 'flex';
        if (inputEl) inputEl.style.display = 'none';

        document.getElementById('thread-avatar').innerHTML = getNotifIconSvg(notif.icon);
        document.getElementById('thread-name').textContent = notif.title;
        document.getElementById('thread-status').textContent = formatDateDivider(notif.createdAt);

        messagesEl.innerHTML = `
          <div class="notif-detail-card">
            <div class="notif-detail-header">
              <h3>${escapeHtml(notif.title)}</h3>
            </div>
            <div class="notif-detail-body">
              <p>${escapeHtml(notif.message)}</p>
            </div>
            ${notif.data?.link ? `
              <div class="notif-detail-actions">
                <button class="btn-modern primary" onclick="window.location.href='${notif.data.link}'">View Details</button>
              </div>
            ` : ''}
          </div>
        `;
        markNotificationRead(notif);
      }
    }

    async function loadThreadMessages(entityId) {
      const messagesEl = document.getElementById('thread-messages');
      if (!messagesEl) return;

      try {
        // Try customer_id first, then lead_id
        let { data: messages, error } = await supabaseClient
          .from('customer_messages')
          .select('*')
          .eq('customer_id', entityId)
          .order('created_at', { ascending: true });

        // If no results, try as lead_id
        if ((!messages || messages.length === 0) && !error) {
          const leadResult = await supabaseClient
            .from('customer_messages')
            .select('*')
            .eq('lead_id', entityId)
            .order('created_at', { ascending: true });
          if (leadResult.data?.length) {
            messages = leadResult.data;
            error = leadResult.error;
          }
        }

        if (error) throw error;

        if (!messages || messages.length === 0) {
          messagesEl.innerHTML = `
            <div class="empty-thread">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <h3>Start the conversation</h3>
              <p>Send a message to begin</p>
            </div>
          `;
          return;
        }

        let html = '';
        let lastDate = '';

        messages.forEach(msg => {
          const msgDate = new Date(msg.created_at).toLocaleDateString();
          if (msgDate !== lastDate) {
            html += `<div class="date-divider">${formatDateDivider(msg.created_at)}</div>`;
            lastDate = msgDate;
          }
          const channelBadge = msg.channel && msg.channel !== 'in_app' ? `<span class="message-channel-badge">${msg.channel.toUpperCase()}</span>` : '';
          const statusIcon = getMessageStatusIcon(msg.status);
          const sourceLabel = msg.source_type === 'design_comment' ? '<span class="message-channel-badge">DESIGN</span>' : '';

          html += `
            <div class="message-bubble-wrapper ${msg.direction}">
              <div class="message-bubble ${msg.direction}">
                <div class="message-content">${escapeHtml(msg.message)}</div>
                <div class="message-meta">
                  <span class="message-time">${formatMessageTime(msg.created_at)}</span>
                  ${channelBadge}
                  ${sourceLabel}
                  ${msg.direction === 'outbound' ? `<span class="message-status ${msg.status || 'sent'}">${statusIcon}</span>` : ''}
                </div>
              </div>
              <div class="message-actions">
                ${msg.direction === 'outbound' ? `
                  <button class="message-action-btn delete" onclick="deleteMessage('${msg.id}')" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    Delete
                  </button>
                ` : `
                  <button class="message-action-btn" onclick="replyToMessage('${msg.id}')" title="Reply">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/></svg>
                    Reply
                  </button>
                `}
              </div>
            </div>
          `;
        });

        messagesEl.innerHTML = html;
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Mark inbound messages as read
        const unreadIds = messages.filter(m => m.direction === 'inbound' && !m.read_at).map(m => m.id);
        if (unreadIds.length > 0) {
          await supabaseClient.from('customer_messages')
            .update({ read_at: new Date().toISOString(), status: 'read' })
            .in('id', unreadIds);
        }

      } catch (err) {
        console.error('Load thread error:', err);
      }
    }

    async function markNotificationRead(notif) {
      if (notif.isRead) return;
      try {
        await supabaseClient.from('pro_notifications').update({ is_read: true, read_at: new Date().toISOString() }).eq('id', notif.id);
        notif.isRead = true;
        updateUnreadBadge();
      } catch (err) {
        console.error('Mark read error:', err);
      }
    }

    async function markInquiryAsRead(id) {
      try {
        await supabaseClient.from('listing_inquiries').update({ read: true }).eq('id', id);
        const notif = messageItems.find(n => n.id === id);
        if (notif) notif.isRead = true;
        updateUnreadBadge();
      } catch (err) {
        console.error('Mark inquiry read error:', err);
      }
    }

    function updateUnreadBadge() {
      const unreadCount = messageItems.filter(n => !n.isRead).length;
      const badge = document.querySelector('.nav-item[data-page="messages"] .nav-badge');
      if (badge) {
        badge.textContent = unreadCount;
        badge.style.display = unreadCount > 0 ? 'flex' : 'none';
      }
    }

    async function replyToInquiry(id) {
      const notif = messageItems.find(n => n.id === id);
      if (!notif?.sender?.email) {
        showToast('No email to reply to', 'error');
        return;
      }
      openNewMessageModal();
      setTimeout(() => {
        setManualRecipient(notif.sender.email);
      }, 100);
    }

    async function convertInquiryToLead(id) {
      const notif = messageItems.find(n => n.id === id);
      if (!notif) return;
      try {
        const user = await supabaseClient.auth.getUser();
        await supabaseClient.from('leads').insert({
          user_id: user.data.user.id,
          full_name: notif.sender?.name || '',
          email: notif.sender?.email || '',
          phone: notif.sender?.phone || '',
          source: 'marketplace_inquiry',
          notes: notif.message,
          status: 'new'
        });
        showToast('Converted to lead!', 'success');
      } catch (err) {
        showToast('Error converting to lead', 'error');
      }
    }

    function contactLead(leadId) {
      const notif = messageItems.find(n => n.lead?.id === leadId);
      if (!notif?.lead) return;
      openNewMessageModal();
      setTimeout(() => {
        if (notif.lead.email) setManualRecipient(notif.lead.email);
        else if (notif.lead.phone) setManualRecipient(notif.lead.phone);
      }, 100);
    }

    async function sendMessage() {
      if (!currentNotification || currentNotification.type !== 'conversation') {
        showToast('Please select a conversation', 'error');
        return;
      }

      const inputEl = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-message-btn');
      const message = inputEl?.value?.trim();
      if (!message) return;

      const channel = document.querySelector('input[name="message-channel"]:checked')?.value || 'in_app';

      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="spinner-modern" style="width:16px;height:16px;"></div>';
      }

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) throw new Error('Not authenticated');

        const isLead = currentNotification.source === 'lead' || currentNotification.lead;
        const recipientEmail = currentNotification.customer?.email || currentNotification.lead?.email;
        const recipientName = currentNotification.customer?.name || currentNotification.lead?.full_name || currentNotification.lead?.name || '';
        const effectiveChannel = (channel === 'email' && recipientEmail) ? 'email' : channel;

        const { data: insertedMsg } = await supabaseClient.from('customer_messages').insert({
          ...(isLead ? { lead_id: currentNotification.id } : { customer_id: currentNotification.id }),
          sender_id: user.data.user.id,
          direction: 'outbound',
          channel: effectiveChannel,
          message: message,
          sent_from: user.data.user.email,
          sent_to: recipientEmail || currentNotification.customer?.phone || null,
          status: 'sent'
        }).select('id');

        if (inputEl) inputEl.value = '';
        await loadThreadMessages(currentNotification.id);

        // Send actual email if channel is email and recipient has email
        if (effectiveChannel === 'email' && recipientEmail) {
          try {
            const resp = await apiCall('/api/send-lead-message', {
              method: 'POST',
              body: JSON.stringify({
                to_email: recipientEmail,
                to_name: recipientName,
                message: message,
                sender_name: user.data.user.user_metadata?.full_name || user.data.user.email || 'Surprise Granite',
                lead_id: isLead ? currentNotification.id : null
              })
            });
            const result = await resp.json();
            if (result.success) {
              showToast('Message sent via email!', 'success');
            } else {
              showToast('Saved but email delivery failed', 'warning');
            }
          } catch (emailErr) {
            console.error('Email delivery error:', emailErr);
            showToast('Saved but email delivery failed', 'warning');
          }
        } else {
          showToast('Message sent', 'success');
        }

      } catch (err) {
        console.error('Send error:', err);
        showToast('Failed to send', 'error');
      } finally {
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>';
        }
      }
    }

    function handleMessageKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    function formatMessageTime(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
      if (days === 1) return 'Yesterday';
      if (days < 7) return date.toLocaleDateString([], { weekday: 'short' });
      return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    function formatDateDivider(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      return date.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
    }

    function callCustomer() {
      const phone = currentNotification?.customer?.phone || currentNotification?.sender?.phone || currentNotification?.lead?.phone;
      if (!phone) { showToast('No phone number', 'error'); return; }
      window.open(`tel:${phone}`, '_self');
    }

    function emailCustomer() {
      const email = currentNotification?.customer?.email || currentNotification?.sender?.email || currentNotification?.lead?.email;
      if (!email) { showToast('No email', 'error'); return; }
      window.open(`mailto:${email}`, '_blank');
    }

    function viewCustomerProfile() {
      if (currentNotification?.customer) openCustomerDetailModal(currentNotification.customer);
      else if (currentNotification?.lead) openLeadModal(currentNotification.lead.id);
    }

    function attachFile() {
      showToast('File attachments coming soon', 'info');
    }

    // Message status icon helper
    function getMessageStatusIcon(status) {
      if (status === 'read') {
        return '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
      } else if (status === 'delivered') {
        return '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
      }
      return '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
    }

    // Delete message with confirmation
    async function deleteMessage(messageId) {
      if (!confirm('Delete this message? This cannot be undone.')) return;

      try {
        const { error } = await supabaseClient
          .from('customer_messages')
          .delete()
          .eq('id', messageId);

        if (error) throw error;

        showToast('Message deleted', 'success');

        // Reload thread
        if (currentNotification) {
          await loadThreadMessages(currentNotification.id);
        }
      } catch (err) {
        console.error('Delete message error:', err);
        showToast('Failed to delete message', 'error');
      }
    }

    // Reply to a specific message
    function replyToMessage(messageId) {
      const inputEl = document.getElementById('message-input');
      if (inputEl) {
        inputEl.focus();
        inputEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // Toggle conversations list on mobile
    function toggleConversationsList() {
      const list = document.querySelector('#page-messages .conversations-list');
      const toggle = document.querySelector('.conversations-toggle');
      if (list && toggle) {
        list.classList.toggle('collapsed');
        toggle.classList.toggle('collapsed');
      }
    }

    // Mobile: auto-collapse conversations when selecting
    function mobileCollapseOnSelect() {
      if (window.innerWidth <= 768) {
        const list = document.querySelector('#page-messages .conversations-list');
        const toggle = document.querySelector('.conversations-toggle');
        if (list && toggle) {
          list.classList.add('collapsed');
          toggle.classList.add('collapsed');
        }
      }
    }

    // New Message Composer - Full Featured
    let composeRecipient = null;
    let allContacts = [];

    function openNewMessageModal() {
      // Create compose modal
      const existing = document.getElementById('compose-message-modal');
      if (existing) existing.remove();

      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'compose-message-modal';
      modal.onclick = function(e) { if (e.target === modal) closeComposeModal(); };
      modal.innerHTML = `
        <div class="modal compose-modal">
          <div class="modal-header">
            <h2>New Message</h2>
            <button class="modal-close" onclick="closeComposeModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" style="padding: 0;">
            <!-- Recipient Selection -->
            <div class="compose-section">
              <label class="compose-label">To:</label>
              <div id="compose-recipient-display" style="display: none;" class="compose-recipient-chip">
                <span id="compose-recipient-name"></span>
                <button type="button" onclick="clearComposeRecipient()" class="chip-remove">&times;</button>
              </div>
              <input type="text" id="compose-recipient-search" class="compose-input" placeholder="Search contacts or enter email/phone..." oninput="searchComposeRecipients(this.value)" onfocus="showContactSuggestions()">
              <div id="compose-suggestions" class="compose-suggestions"></div>
            </div>

            <!-- Manual Entry Toggle -->
            <div class="compose-section" id="manual-entry-section" style="display: none;">
              <div class="manual-entry-fields">
                <input type="text" id="compose-manual-name" class="compose-input" placeholder="Name (optional)">
                <input type="email" id="compose-manual-email" class="compose-input" placeholder="Email">
                <input type="tel" id="compose-manual-phone" class="compose-input" placeholder="Phone (optional)">
              </div>
            </div>

            <!-- Channel Selection -->
            <div class="compose-section">
              <label class="compose-label">Send via:</label>
              <div class="compose-channels">
                <label class="channel-chip selected" data-channel="email">
                  <input type="radio" name="compose-channel" value="email" checked>
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Email
                </label>
                <label class="channel-chip" data-channel="sms">
                  <input type="radio" name="compose-channel" value="sms">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  SMS
                </label>
                <label class="channel-chip" data-channel="in_app">
                  <input type="radio" name="compose-channel" value="in_app">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                  In-App
                </label>
              </div>
            </div>

            <!-- Subject (for email) -->
            <div class="compose-section" id="compose-subject-section">
              <input type="text" id="compose-subject" class="compose-input" placeholder="Subject">
            </div>

            <!-- Message -->
            <div class="compose-section compose-message-section">
              <textarea id="compose-message" class="compose-textarea" placeholder="Type your message..." rows="4"></textarea>
            </div>

            <!-- Quick Templates -->
            <div class="compose-section">
              <div class="quick-templates">
                <button type="button" class="template-chip" onclick="insertTemplate('estimate')">Send Estimate</button>
                <button type="button" class="template-chip" onclick="insertTemplate('followup')">Follow Up</button>
                <button type="button" class="template-chip" onclick="insertTemplate('payment')">Payment Link</button>
                <button type="button" class="template-chip" onclick="insertTemplate('schedule')">Schedule Visit</button>
              </div>
            </div>
          </div>
          <div class="modal-footer compose-footer">
            <button type="button" class="btn-modern secondary" onclick="closeComposeModal()">Cancel</button>
            <button type="button" class="btn-modern primary" id="compose-send-btn" onclick="sendComposeMessage()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              Send
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Setup channel toggle
      modal.querySelectorAll('.channel-chip').forEach(chip => {
        chip.addEventListener('click', function() {
          modal.querySelectorAll('.channel-chip').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          this.querySelector('input').checked = true;
          // Show/hide subject for email
          const subjectSection = document.getElementById('compose-subject-section');
          if (subjectSection) {
            subjectSection.style.display = this.dataset.channel === 'email' ? 'block' : 'none';
          }
        });
      });

      // Load contacts
      loadAllContacts();
    }

    function closeComposeModal() {
      const modal = document.getElementById('compose-message-modal');
      if (modal) modal.remove();
      composeRecipient = null;
    }

    async function loadAllContacts() {
      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) return;

        allContacts = [];

        // Load customers
        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone')
          .eq('invited_by', user.data.user.id)
          .limit(100);

        (customers || []).forEach(c => {
          allContacts.push({
            id: c.id,
            type: 'customer',
            name: c.name || c.email || 'Unknown',
            email: c.email,
            phone: c.phone,
            label: 'Customer'
          });
        });

        // Load leads (RLS handles user filtering)
        const { data: leads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, phone')
          .limit(100);

        (leads || []).forEach(l => {
          allContacts.push({
            id: l.id,
            type: 'lead',
            name: l.full_name || l.email || 'Unknown',
            email: l.email,
            phone: l.phone,
            label: 'Lead'
          });
        });

        // Load collaborators (may not exist for all users)
        try {
          const { data: collaborators } = await supabaseClient
            .from('general_collaborators')
            .select('id, name, email, phone')
            .eq('invited_by', user.data.user.id)
            .limit(50);

          (collaborators || []).forEach(c => {
            allContacts.push({
              id: c.id,
              type: 'contractor',
              name: c.name || c.email || 'Unknown',
              email: c.email,
              phone: c.phone,
              label: 'Contractor'
            });
          });
        } catch (contractorErr) {
          console.warn('Collaborators table not available:', contractorErr);
        }

      } catch (err) {
        console.error('Load contacts error:', err);
      }
    }

    function showContactSuggestions() {
      if (composeRecipient) return;
      searchComposeRecipients('');
    }

    function searchComposeRecipients(query) {
      const suggestionsEl = document.getElementById('compose-suggestions');
      if (!suggestionsEl) return;

      const q = query.toLowerCase().trim();

      // Check if it looks like an email or phone
      const isEmail = q.includes('@') || /^[a-z0-9._%+-]+$/i.test(q);
      const isPhone = /^[\d\s\-\(\)\+]+$/.test(q) && q.replace(/\D/g, '').length >= 7;

      let filtered = allContacts.filter(c => {
        if (!q) return true;
        return (c.name || '').toLowerCase().includes(q) ||
               (c.email || '').toLowerCase().includes(q) ||
               (c.phone || '').includes(q);
      }).slice(0, 8);

      let html = '';

      // Manual entry option at top if query looks like contact info
      if (q && (isEmail || isPhone)) {
        html += `
          <div class="suggestion-item manual" onclick="setManualRecipient('${escapeHtml(q)}')">
            <div class="suggestion-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
            </div>
            <div class="suggestion-details">
              <div class="suggestion-name">Send to "${escapeHtml(q)}"</div>
              <div class="suggestion-meta">Manual entry</div>
            </div>
          </div>
        `;
      }

      // Contact results
      if (filtered.length > 0) {
        filtered.forEach(c => {
          const initials = (c.name || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          html += `
            <div class="suggestion-item" onclick="selectComposeRecipient('${c.type}', '${c.id}', '${escapeHtml(c.name)}', '${c.email || ''}', '${c.phone || ''}')">
              <div class="suggestion-avatar">${initials}</div>
              <div class="suggestion-details">
                <div class="suggestion-name">${escapeHtml(c.name)}</div>
                <div class="suggestion-meta">${c.email || c.phone || ''} <span class="suggestion-badge">${c.label}</span></div>
              </div>
            </div>
          `;
        });
      } else if (!q) {
        html = '<div class="suggestion-empty">Start typing to search contacts...</div>';
      } else if (!isEmail && !isPhone) {
        html += '<div class="suggestion-empty">No contacts found. Enter an email or phone number.</div>';
      }

      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = html ? 'block' : 'none';
    }

    function selectComposeRecipient(type, id, name, email, phone) {
      composeRecipient = { type, id, name, email, phone };

      document.getElementById('compose-recipient-search').style.display = 'none';
      document.getElementById('compose-suggestions').style.display = 'none';
      document.getElementById('compose-recipient-display').style.display = 'flex';
      document.getElementById('compose-recipient-name').textContent = name + (email ? ` (${email})` : phone ? ` (${phone})` : '');

      // Focus message input
      document.getElementById('compose-message').focus();
    }

    function setManualRecipient(value) {
      const isEmail = value.includes('@');
      composeRecipient = {
        type: 'manual',
        id: null,
        name: '',
        email: isEmail ? value : '',
        phone: isEmail ? '' : value
      };

      document.getElementById('compose-recipient-search').style.display = 'none';
      document.getElementById('compose-suggestions').style.display = 'none';
      document.getElementById('compose-recipient-display').style.display = 'flex';
      document.getElementById('compose-recipient-name').textContent = value;

      // Auto-select channel based on input
      if (!isEmail) {
        document.querySelector('.channel-chip[data-channel="sms"]').click();
      }

      document.getElementById('compose-message').focus();
    }

    function clearComposeRecipient() {
      composeRecipient = null;
      document.getElementById('compose-recipient-search').style.display = 'block';
      document.getElementById('compose-recipient-search').value = '';
      document.getElementById('compose-recipient-display').style.display = 'none';
      document.getElementById('compose-suggestions').style.display = 'none';
      document.getElementById('compose-recipient-search').focus();
    }

    function insertTemplate(type) {
      const messageEl = document.getElementById('compose-message');
      const subjectEl = document.getElementById('compose-subject');
      if (!messageEl) return;

      const templates = {
        estimate: {
          subject: 'Your Estimate from Surprise Granite',
          message: 'Hi,\n\nThank you for your interest in Surprise Granite! I\'ve prepared an estimate for your project.\n\nPlease review it at your convenience and let me know if you have any questions.\n\nBest regards'
        },
        followup: {
          subject: 'Following Up - Surprise Granite',
          message: 'Hi,\n\nI wanted to follow up on our recent conversation about your project.\n\nDo you have any questions I can help answer? I\'m happy to schedule a time to discuss further.\n\nBest regards'
        },
        payment: {
          subject: 'Payment Request - Surprise Granite',
          message: 'Hi,\n\nThank you for choosing Surprise Granite!\n\nPlease use the link below to complete your payment securely:\n[Payment Link]\n\nLet me know if you have any questions.\n\nBest regards'
        },
        schedule: {
          subject: 'Schedule Your Appointment - Surprise Granite',
          message: 'Hi,\n\nI\'d like to schedule a visit to take measurements and discuss your project in detail.\n\nWhat days/times work best for you this week?\n\nBest regards'
        }
      };

      const template = templates[type];
      if (template) {
        if (subjectEl) subjectEl.value = template.subject;
        messageEl.value = template.message;
        messageEl.focus();
      }
    }

    async function sendComposeMessage() {
      const messageEl = document.getElementById('compose-message');
      const subjectEl = document.getElementById('compose-subject');
      const sendBtn = document.getElementById('compose-send-btn');
      const channel = document.querySelector('input[name="compose-channel"]:checked')?.value || 'email';
      const message = messageEl?.value?.trim();
      const subject = subjectEl?.value?.trim();

      if (!composeRecipient) {
        showToast('Please select a recipient', 'error');
        return;
      }

      if (!message) {
        showToast('Please enter a message', 'error');
        return;
      }

      // Validate contact method for channel
      if (channel === 'email' && !composeRecipient.email) {
        showToast('Recipient has no email address', 'error');
        return;
      }
      if (channel === 'sms' && !composeRecipient.phone) {
        showToast('Recipient has no phone number', 'error');
        return;
      }

      // Disable button
      if (sendBtn) {
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<div class="spinner-modern" style="width:16px;height:16px;"></div> Sending...';
      }

      try {
        const user = await supabaseClient.auth.getUser();
        if (!user.data.user) throw new Error('Not authenticated');

        // For email channel, send via API
        if (channel === 'email' && composeRecipient.email) {
          try {
            await apiCall('/api/send-estimate', {
              method: 'POST',
              body: JSON.stringify({
                email: composeRecipient.email,
                counterSqft: subject || 'Message from Surprise Granite',
                splashSqft: '',
                totalSqft: '',
                edgeProfile: `From: ${user.data.user.email}`,
                edgeLF: '',
                priceBudget: message,
                pricePopular: '',
                pricePremium: ''
              })
            });
          } catch (emailErr) {
            console.warn('Email send error (continuing):', emailErr);
            // Continue even if email fails - we'll save to database
          }
        }

        // For SMS channel - log for now (requires Twilio setup)
        if (channel === 'sms') {
          console.log('SMS would be sent to:', composeRecipient.phone, 'Message:', message);
          // SMS integration can be added later with Twilio
        }

        // Save to database for any recipient type
        if (composeRecipient.type === 'customer' && composeRecipient.id) {
          await supabaseClient.from('customer_messages').insert({
            customer_id: composeRecipient.id,
            sender_id: user.data.user.id,
            direction: 'outbound',
            channel: channel,
            message: message,
            subject: subject || null,
            sent_from: user.data.user.email,
            sent_to: composeRecipient.email || composeRecipient.phone,
            status: 'sent'
          });
        } else if (composeRecipient.type === 'lead' && composeRecipient.id) {
          // For leads, we could create a customer_messages entry or log it
          console.log('Message to lead:', composeRecipient.id, message);
        }

        showToast(`Message sent via ${channel.toUpperCase()}`, 'success');
        closeComposeModal();

        // Refresh conversations if on messages page
        if (document.getElementById('page-messages')?.classList.contains('active')) {
          loadConversations();
        }

      } catch (err) {
        console.error('Send message error:', err);
        showToast(err.message || 'Failed to send message', 'error');
      } finally {
        if (sendBtn) {
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Send';
        }
      }
    }

    async function startNewConversation(customerId) {
      await selectConversation(customerId);
      const inputEl = document.getElementById('message-input');
      if (inputEl) inputEl.focus();
    }

    // Payment Request Modal Functions
    function openPaymentModal(inquiryId, customerName, customerEmail, listingTitle) {
      document.getElementById('payment-inquiry-id').value = inquiryId;
      document.getElementById('payment-customer-email').value = customerEmail;
      document.getElementById('payment-customer-name').value = customerName;
      document.getElementById('payment-recipient-name').textContent = customerName;
      document.getElementById('payment-recipient-email').textContent = customerEmail;
      document.getElementById('payment-description').value = listingTitle;
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-request-modal').style.display = 'flex';
    }

    function closePaymentModal() {
      document.getElementById('payment-request-modal').style.display = 'none';
    }

    async function sendPaymentRequest(event) {
      event.preventDefault();

      const sendBtn = document.getElementById('send-payment-btn');
      const originalText = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div> Creating...';

      try {
        const amount = parseFloat(document.getElementById('payment-amount').value);
        const description = document.getElementById('payment-description').value;
        const customerEmail = document.getElementById('payment-customer-email').value;
        const customerName = document.getElementById('payment-customer-name').value;
        const note = document.getElementById('payment-note').value;

        // Create payment link via API
        const response = await fetch('https://surprise-granite-email-api.onrender.com/api/payment-links', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: amount,
            description: description,
            customer_email: customerEmail
          })
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to create payment link');
        }

        // Send email with payment link
        const emailResponse = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: customerName,
            email: customerEmail,
            subject: `Payment Request for ${description}`,
            message: `
              <p>Hello ${customerName},</p>
              ${note ? `<p>${note}</p>` : '<p>Thank you for your interest in our stone remnant!</p>'}
              <p><strong>Amount Due:</strong> $${amount.toFixed(2)}</p>
              <p><strong>Description:</strong> ${description}</p>
              <p style="margin: 24px 0;">
                <a href="${result.payment_link.url}" style="display: inline-block; background: #f9cb00; color: #1a1a2e; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600;">Pay Now</a>
              </p>
              <p style="font-size: 13px; color: #666;">Or copy this link: ${result.payment_link.url}</p>
            `,
            source: 'marketplace-payment-request'
          })
        });

        closePaymentModal();
        showToast('Payment link sent to ' + customerEmail);

      } catch (err) {
        console.error('Payment request error:', err);
        alert('Failed to send payment request: ' + err.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }

      return false;
    }

    // ============ QUICK PAY FUNCTIONS ============
    let quickPayData = {};

    function openQuickPayModal() {
      document.getElementById('quick-pay-modal').classList.add('active');
      document.getElementById('quick-pay-form-state').style.display = 'block';
      document.getElementById('quick-pay-result-state').style.display = 'none';
      document.getElementById('quick-pay-form').reset();
    }

    function closeQuickPayModal() {
      document.getElementById('quick-pay-modal').classList.remove('active');
    }

    function resetQuickPayModal() {
      document.getElementById('quick-pay-form-state').style.display = 'block';
      document.getElementById('quick-pay-result-state').style.display = 'none';
      document.getElementById('quick-pay-form').reset();
    }

    async function generateQuickPayLink(event) {
      event.preventDefault();

      const btn = document.getElementById('qp-generate-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Creating...';

      try {
        const name = document.getElementById('qp-name').value.trim();
        const email = document.getElementById('qp-email').value.trim();
        const phone = document.getElementById('qp-phone').value.trim();
        const amount = parseFloat(document.getElementById('qp-amount').value);
        const description = document.getElementById('qp-description').value.trim() || 'Payment to Surprise Granite';

        if (!name || !email || !amount || amount <= 0) {
          throw new Error('Please fill in all required fields');
        }

        console.log('[QuickPay] Creating payment link for:', name, email, amount);

        // Create payment link via VoiceNow CRM Surprise Granite endpoint
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000);

        let paymentUrl = null;

        try {
          const response = await fetch(`${VOICENOW_API}/api/surprise-granite/quick-pay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal,
            body: JSON.stringify({
              amount: amount,
              description: description,
              customerEmail: email,
              customerName: name,
              customerPhone: phone,
              sendSMS: false // We'll send SMS separately if needed
            })
          });
          clearTimeout(timeoutId);
          const result = await response.json();
          console.log('[QuickPay] API response:', result);

          if (response.ok && result.success && result.paymentLink?.url) {
            paymentUrl = result.paymentLink.url;
          } else {
            throw new Error(result.error || 'Failed to create payment link');
          }
        } catch (apiErr) {
          console.error('[QuickPay] API error:', apiErr.message);
          throw new Error('Failed to create payment link. Please try again.');
        }

        // Store data for sharing
        quickPayData = {
          name,
          email,
          phone,
          amount,
          description,
          url: paymentUrl
        };

        // Update result display
        document.getElementById('qp-result-name').textContent = name;
        document.getElementById('qp-result-amount').textContent = '$' + amount.toFixed(2);
        document.getElementById('qp-link-display').value = paymentUrl;

        // Generate QR code using free API
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(paymentUrl)}`;
        document.getElementById('qp-qr-code').src = qrUrl;

        // Switch to result state
        document.getElementById('quick-pay-form-state').style.display = 'none';
        document.getElementById('quick-pay-result-state').style.display = 'block';

        showToast('Payment link created!', 'success');

      } catch (err) {
        console.error('Quick pay error:', err);
        showToast(err.message || 'Failed to create payment link', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Generate Link';
      }

      return false;
    }

    async function copyQuickPayLink() {
      try {
        await navigator.clipboard.writeText(quickPayData.url);
        showToast('Payment link copied!', 'success');
      } catch (err) {
        // Fallback for older browsers
        const input = document.getElementById('qp-link-display');
        input.select();
        document.execCommand('copy');
        showToast('Payment link copied!', 'success');
      }
    }

    async function sendQuickPayEmail() {
      const btn = event.target.closest('button');
      const originalHtml = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span>';

      try {
        const emailResponse = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: quickPayData.name,
            email: quickPayData.email,
            subject: `Payment Request - $${quickPayData.amount.toFixed(2)}`,
            message: `
              <p>Hello ${quickPayData.name},</p>
              <p>Here's your secure payment link for <strong>${quickPayData.description}</strong>.</p>
              <p style="font-size: 24px; font-weight: bold; color: #f9cb00;">Amount Due: $${quickPayData.amount.toFixed(2)}</p>
              <p style="margin: 24px 0;">
                <a href="${quickPayData.url}" style="display: inline-block; background: #f9cb00; color: #1a1a2e; text-decoration: none; padding: 14px 32px; border-radius: 8px; font-weight: 600;">Pay Now</a>
              </p>
              <p style="font-size: 13px; color: #666;">Or copy this link: ${quickPayData.url}</p>
              <p style="margin-top: 24px;">Thank you for your business!</p>
              <p>- Surprise Granite</p>
            `,
            source: 'quick-pay'
          })
        });

        if (emailResponse.ok) {
          showToast(`Payment link sent to ${quickPayData.email}!`, 'success');
        } else {
          throw new Error('Email failed to send');
        }
      } catch (err) {
        // Fallback to mailto
        const subject = encodeURIComponent(`Payment Request - $${quickPayData.amount.toFixed(2)}`);
        const body = encodeURIComponent(`Hi ${quickPayData.name},\n\nHere's your payment link for ${quickPayData.description}:\n\nAmount: $${quickPayData.amount.toFixed(2)}\nPay here: ${quickPayData.url}\n\nThank you!\nSurprise Granite`);
        window.open(`mailto:${quickPayData.email}?subject=${subject}&body=${body}`);
        showToast('Opening email client...', 'info');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
      }
    }

    async function sendQuickPaySMS() {
      const smsText = `Hi ${quickPayData.name}! Here's your payment link for $${quickPayData.amount.toFixed(2)}: ${quickPayData.url} - Surprise Granite`;
      const phone = quickPayData.phone ? quickPayData.phone.replace(/\D/g, '') : '';

      // If we have a phone number, try to send via VoiceNow CRM first
      if (phone) {
        const btn = event?.target?.closest?.('button');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span>';
        }

        try {
          // Send SMS via VoiceNow CRM Surprise Granite endpoint
          const response = await fetch(`${VOICENOW_API}/api/surprise-granite/send-sms`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: phone,
              message: smsText
            })
          });

          const result = await response.json();

          if (result.success) {
            showToast(`SMS sent to ${quickPayData.phone}!`, 'success');
          } else {
            throw new Error(result.message || 'SMS failed');
          }
        } catch (err) {
          console.warn('VoiceNow SMS failed, falling back to native:', err);
          // Fallback to native SMS app
          const message = encodeURIComponent(smsText);
          if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            window.open(`sms:${phone}&body=${message}`);
          } else {
            window.open(`sms:${phone}?body=${message}`);
          }
          showToast('Opening SMS app...', 'info');
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg> Send SMS';
          }
        }
      } else {
        // No phone - copy to clipboard
        navigator.clipboard.writeText(smsText);
        showToast('SMS text copied! (No phone number entered)', 'info');
      }
    }

    async function deleteListing(id) {
      if (!confirm('Are you sure you want to delete this listing?')) return;

      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .delete()
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Delete listing error:', err);
        alert('Failed to delete listing');
      }
    }

    async function markListingSold(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({ status: 'sold' })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Mark sold error:', err);
        alert('Failed to update listing');
      }
    }

    async function reactivateListing(id) {
      try {
        const { error } = await supabaseClient
          .from('stone_listings')
          .update({
            status: 'active',
            expires_at: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000).toISOString()
          })
          .eq('id', id);

        if (error) throw error;
        await loadMyListings();
      } catch (err) {
        console.error('Reactivate error:', err);
        alert('Failed to reactivate listing');
      }
    }

    function editListing(id) {
      // TODO: Implement edit listing modal
      alert('Edit functionality coming soon!');
    }

    // =============================================
    // ESTIMATES FEATURE
    // =============================================

    let serviceCatalog = [];
    let businessSettings = null;

    // Inline status update for estimates - no modal needed
    async function inlineUpdateEstimateStatus(estimateId, newStatus) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', estimateId);

        if (error) throw error;

        // Update local data
        const estimate = allEstimates.find(e => e.id === estimateId);
        if (estimate) estimate.status = newStatus;

        showToast(`Estimate → ${newStatus}`, 'success');

        // Refresh to update button visibility (e.g., Convert to Invoice)
        loadEstimates();
      } catch (err) {
        console.error('Error updating estimate status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    async function loadEstimates() {
      const listContainer = document.getElementById('estimates-list');
      if (!listContainer) {
        console.warn('[Estimates] No estimates-list container found');
        return;
      }

      listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><div class="loading-spinner"></div><p>Loading estimates...</p></div>';

      try {
        if (!supabaseClient) {
          console.error('[Estimates] supabaseClient not initialized');
          listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><p>Database connection not ready. Please refresh.</p></div>';
          return;
        }
        const { data: { user } } = await supabaseClient.auth.getUser();
        console.log('[Estimates] User:', user?.id);
        if (!user) {
          listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);"><p>Please log in to view estimates</p></div>';
          return;
        }

        let query = supabaseClient
          .from('estimates')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        // Filter by status
        if (currentEstimateFilter === 'archived') {
          query = query.not('archived_at', 'is', null);
        } else {
          // By default, hide archived estimates
          query = query.is('archived_at', null);
          if (currentEstimateFilter !== 'all') {
            query = query.eq('status', currentEstimateFilter);
          }
        }

        const { data: estimates, error } = await query;

        if (error) throw error;

        // Update global estimates array with full data
        const { data: allEstimatesData } = await supabaseClient
          .from('estimates')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (allEstimatesData) {
          allEstimates = allEstimatesData; // Update global array
          const stats = {
            draft: allEstimates.filter(e => e.status === 'draft').length,
            sent: allEstimates.filter(e => e.status === 'sent').length,
            approved: allEstimates.filter(e => e.status === 'approved').length,
            rejected: allEstimates.filter(e => e.status === 'rejected').length
          };
          document.getElementById('stat-draft-estimates').textContent = stats.draft;
          document.getElementById('stat-sent-estimates').textContent = stats.sent;
          document.getElementById('stat-approved-estimates').textContent = stats.approved;
          document.getElementById('stat-rejected-estimates').textContent = stats.rejected;
          document.getElementById('estimates-count').textContent = allEstimates.length;
          document.getElementById('estimates-count').dataset.count = allEstimates.length;
        }

        if (!estimates || estimates.length === 0) {
          listContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="opacity: 0.3; margin-bottom: 16px;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <h3 style="margin-bottom: 8px;">No estimates yet</h3>
              <p style="color: var(--text-muted); margin-bottom: 16px;">Create your first estimate to send to customers</p>
              <button class="btn-modern primary" onclick="openCreateEstimateModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Create First Estimate
              </button>
            </div>`;
          return;
        }

        listContainer.innerHTML = estimates.map(estimate => `
          <div class="estimate-card" style="background: var(--dark-elevated); border-radius: 12px; padding: 20px; margin-bottom: 12px; border: 1px solid var(--border-subtle);"
               data-context-menu="estimate"
               data-item-id="${estimate.id}"
               data-item-data='${JSON.stringify({ estimate_number: estimate.estimate_number, status: estimate.status, customer_name: estimate.customer_name }).replace(/'/g, "&#39;")}'>
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 4px;">
                  <span style="font-size: 18px; font-weight: 600;">${estimate.estimate_number || 'Draft'}</span>
                  <select onchange="inlineUpdateEstimateStatus('${estimate.id}', this.value)" style="padding: 4px 8px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary); font-size: 11px; font-weight: 600; text-transform: uppercase; cursor: pointer;">
                    <option value="draft" ${estimate.status === 'draft' ? 'selected' : ''}>Draft</option>
                    <option value="sent" ${estimate.status === 'sent' ? 'selected' : ''}>Sent</option>
                    <option value="approved" ${estimate.status === 'approved' ? 'selected' : ''}>Approved</option>
                    <option value="rejected" ${estimate.status === 'rejected' ? 'selected' : ''}>Rejected</option>
                  </select>
                </div>
                <div style="color: var(--text-secondary);">${estimate.customer_name}</div>
                ${estimate.project_name ? `<div style="color: var(--text-muted); font-size: 13px;">${estimate.project_name}</div>` : ''}
              </div>
              <div style="text-align: right;">
                <div style="font-size: 20px; font-weight: 700; color: var(--gold-primary);">$${(estimate.total || 0).toLocaleString('en-US', { minimumFractionDigits: 2 })}</div>
                <div style="font-size: 12px; color: var(--text-muted);">
                  ${new Date(estimate.created_at).toLocaleDateString()}
                  ${qboConnected && estimate.qbo_id && estimate.qbo_sync_status === 'synced' ? '<span style="color: #22c55e; margin-left: 8px;" title="Synced to QuickBooks">QB ✓</span>' : ''}
                  ${qboConnected && estimate.qbo_sync_status === 'error' ? '<span style="color: #ef4444; margin-left: 8px;" title="' + (estimate.qbo_sync_error || 'Sync error') + '">QB !</span>' : ''}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button class="btn-modern secondary small" onclick="viewEstimate('${estimate.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                View
              </button>
              <button class="btn-modern secondary small" onclick="scheduleForEstimate('${estimate.id}', '${(estimate.estimate_number || '').replace(/'/g, '')}', '${(estimate.customer_name || '').replace(/'/g, '')}', '${(estimate.customer_email || '').replace(/'/g, '')}')" title="Schedule Follow-up">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Schedule
              </button>
              ${estimate.status === 'draft' ? `
                <button class="btn-modern primary small" onclick="sendEstimate('${estimate.id}')">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                  Send
                </button>
              ` : ''}
              ${estimate.converted_to_invoice_id ? `
                <button class="btn-modern secondary small" onclick="viewSupabaseInvoice('${estimate.converted_to_invoice_id}')" style="color: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  View Invoice
                </button>
              ` : (estimate.status === 'approved' || estimate.status === 'sent') ? `
                <button class="btn-modern success small" onclick="convertToInvoice('${estimate.id}')" style="background: #22c55e;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                  Convert to Invoice
                </button>
              ` : ''}
              <button class="btn-modern secondary small" onclick="duplicateEstimate('${estimate.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                Duplicate
              </button>
              <button class="btn-modern secondary small" onclick="event.stopPropagation(); inviteFromEstimate('${estimate.id}')" title="Invite collaborator">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                Invite
              </button>
              ${!estimate.archived_at ? `
                <button class="btn-modern secondary small" onclick="event.stopPropagation(); createProjectFromEstimate('${estimate.id}')" title="Create Project">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                  Project
                </button>
              ` : ''}
              ${qboConnected && !estimate.qbo_id ? `
                <button class="btn-modern secondary small qbo-sync-btn" onclick="event.stopPropagation(); syncEstimateToQBO('${estimate.id}')" title="Sync to QuickBooks">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  QB Sync
                </button>
              ` : ''}
              ${estimate.archived_at ? `
                <button class="btn-modern secondary small" onclick="unarchiveEstimate('${estimate.id}')" title="Restore">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                  Restore
                </button>
                <button class="btn-modern small" onclick="deleteEstimatePermanent('${estimate.id}')" style="color: #ef4444;" title="Delete Permanently">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              ` : `
                <button class="btn-modern small" onclick="archiveEstimate('${estimate.id}')" style="color: #6b7280;" title="Archive">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"/></svg>
                </button>
              `}
            </div>
          </div>
        `).join('');

      } catch (err) {
        console.error('Load estimates error:', err);
        listContainer.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--error);">Error loading estimates: ${escapeHtml(err.message || 'Unknown error')}</div>`;
      }
    }

    function filterEstimates(status) {
      currentEstimateFilter = status;

      // Update active filter button
      document.querySelectorAll('[data-estimate-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.estimateStatus === status);
      });

      loadEstimates();
    }

    async function openCreateEstimateModal(preserveState = false) {
      const modal = document.getElementById('create-estimate-modal');
      modal.classList.add('active');
      document.getElementById('create-estimate-form').reset();

      // Reset state unless preserveState is true (called from startEstimateFromLead/Customer)
      if (!preserveState) {
        estimateModalState = {
          customerId: null,
          leadId: null,
          editingEstimateId: null
        };
      }

      // Reset line items container with empty message
      const container = document.getElementById('estimate-line-items');
      container.innerHTML = `<div id="empty-line-items-msg" style="padding: 30px; text-align: center; color: var(--text-muted); font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 8px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
        <br>No items added yet. Click "Add Item" or "From Catalog" to begin.
      </div>`;

      // Set current date display
      const today = new Date();
      document.getElementById('estimate-date-display').textContent = today.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

      // Set default valid until date (30 days from now)
      updateEstimateValidDate();

      // Get next estimate number
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) {
          const { data } = await supabaseClient.rpc('get_next_estimate_number', { p_user_id: user.id });
          document.getElementById('estimate-number-display').textContent = data || '0001';
        }
      } catch (err) {
        document.getElementById('estimate-number-display').textContent = '0001';
      }

      // Load business settings defaults
      loadBusinessDefaults();

      // Reset category subtotals
      document.getElementById('subtotal-material').textContent = '$0.00';
      document.getElementById('subtotal-labor').textContent = '$0.00';
      document.getElementById('subtotal-service').textContent = '$0.00';

      // Reset totals
      calculateEstimateTotals();
    }

    function updateEstimateValidDate() {
      const days = parseInt(document.getElementById('estimate-valid-days').value) || 30;
      const validUntil = new Date();
      validUntil.setDate(validUntil.getDate() + days);
      document.getElementById('estimate-valid-until').value = validUntil.toISOString().split('T')[0];
    }

    function toggleAddItemMenu() {
      const menu = document.getElementById('add-item-menu');
      menu.style.display = menu.style.display === 'none' ? 'block' : 'none';

      // Close when clicking outside
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!e.target.closest('.dropdown')) {
            menu.style.display = 'none';
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 10);
    }

    function updatePaymentSchedule() {
      const type = document.getElementById('payment-schedule-type').value;
      const container = document.getElementById('payment-schedule-container');
      const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;

      if (type === 'deposit-balance') {
        const depositPercent = parseFloat(document.getElementById('estimate-deposit-percent').value) || 50;
        container.innerHTML = `
          <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div style="padding: 16px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 14px;">1. Deposit Required</span>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <input type="number" id="estimate-deposit-percent" value="${depositPercent}" min="0" max="100" style="width: 50px; text-align: center; padding: 4px; font-size: 13px;" onchange="updateEstimateTotals()">
                  <span style="font-size: 13px;">%</span>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
              <div id="estimate-deposit-amount" style="font-size: 22px; font-weight: 700; color: var(--gold-primary);">$${(total * depositPercent / 100).toFixed(2)}</div>
            </div>
            <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 14px;">2. Balance Due</span>
                <span id="estimate-balance-percent" style="font-size: 13px; color: var(--text-muted);">${100 - depositPercent}%</span>
              </div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Due upon completion</div>
              <div id="estimate-balance-amount" style="font-size: 22px; font-weight: 700;">$${(total * (100 - depositPercent) / 100).toFixed(2)}</div>
            </div>
          </div>`;
      } else if (type === 'three-part') {
        container.innerHTML = `
          <div class="payment-schedule-items" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
            <div style="padding: 14px; background: rgba(249, 203, 0, 0.1); border: 1px solid rgba(249, 203, 0, 0.3); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">1. Deposit (33%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Due upon approval</div>
              <div style="font-size: 18px; font-weight: 700; color: var(--gold-primary);">$${(total * 0.33).toFixed(2)}</div>
            </div>
            <div style="padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">2. Progress (33%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">At project midpoint</div>
              <div style="font-size: 18px; font-weight: 700;">$${(total * 0.33).toFixed(2)}</div>
            </div>
            <div style="padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 6px;">3. Final (34%)</div>
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">Upon completion</div>
              <div style="font-size: 18px; font-weight: 700;">$${(total * 0.34).toFixed(2)}</div>
            </div>
          </div>`;
      } else if (type === 'due-on-completion') {
        container.innerHTML = `
          <div class="payment-schedule-items">
            <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px; text-align: center;">
              <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px;">Full Amount Due Upon Completion</div>
              <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">No deposit required</div>
              <div style="font-size: 24px; font-weight: 700; color: var(--gold-primary);">$${total.toFixed(2)}</div>
            </div>
          </div>`;
      } else {
        container.innerHTML = `
          <div style="padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle); border-radius: 10px;">
            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Define your custom payment milestones in the notes section above.</p>
            <div style="font-weight: 600;">Total: <span style="color: var(--gold-primary);">$${total.toFixed(2)}</span></div>
          </div>`;
      }
    }

    function loadTermsTemplate() {
      const defaultTerms = `1. ACCEPTANCE: This estimate is valid for the period specified above. Acceptance of this estimate constitutes agreement to all terms and conditions.

2. PAYMENT: Payment terms as outlined in the payment schedule above. We accept cash, check, and major credit cards. A 3% processing fee applies to credit card payments.

3. CHANGES: Any changes to the scope of work after acceptance may result in additional charges and timeline adjustments.

4. WARRANTY: Workmanship is warranted as specified above. Manufacturer warranties apply to all materials as per their terms.

5. ACCESS: Customer agrees to provide reasonable access to the work area during normal business hours.

6. COMPLETION: Estimated timelines are approximate and may vary based on material availability and unforeseen conditions.`;

      document.getElementById('estimate-terms').value = defaultTerms;

      if (businessSettings && businessSettings.default_warranty_terms) {
        document.getElementById('estimate-warranty').value = businessSettings.default_warranty_terms;
      } else {
        document.getElementById('estimate-warranty').value = '1 year workmanship warranty';
      }
    }

    function previewEstimate() {
      // Collect all form data and generate a preview
      const customerName = document.getElementById('estimate-customer-name').value.trim() || 'Customer Name';
      const projectName = document.getElementById('estimate-project-name').value.trim() || 'Project';
      const estimateNumber = document.getElementById('estimate-number-display').textContent;
      const estimateDate = document.getElementById('estimate-date-display').textContent;

      // Get business settings for branding
      const companyName = businessSettings?.company_name || 'Your Company Name';
      const companyPhone = businessSettings?.phone || '';
      const companyEmail = businessSettings?.email || '';
      const companyWebsite = businessSettings?.website || '';
      const companyLogo = businessSettings?.logo_url || '';
      const companyAddress = [
        businessSettings?.address,
        [businessSettings?.city, businessSettings?.state, businessSettings?.zip].filter(Boolean).join(', ')
      ].filter(Boolean).join(', ');
      const companyContact = [companyPhone, companyEmail].filter(Boolean).join(' | ');

      // Collect line items
      const lineItems = [];
      document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
        const name = item.querySelector('.item-name').value.trim();
        if (name) {
          lineItems.push({
            name: name,
            description: item.querySelector('.item-desc').value.trim(),
            unit: item.querySelector('.item-unit').value,
            quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
            unit_price: parseFloat(item.querySelector('.item-price').value) || 0,
            category: item.querySelector('.item-category').value || 'other'
          });
        }
      });

      // Get totals
      const subtotal = document.getElementById('estimate-subtotal').textContent;
      const taxAmount = document.getElementById('estimate-tax-amount').textContent;
      const discountAmount = document.getElementById('estimate-discount-amount').textContent;
      const total = document.getElementById('estimate-total').textContent;
      const depositAmount = document.getElementById('estimate-deposit-amount').textContent;

      // Generate preview HTML
      const previewHtml = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>Estimate Preview - ${estimateNumber}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
            .estimate-preview { max-width: 800px; margin: 0 auto; background: #fff; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
            .header { background: linear-gradient(135deg, #1a1a1a, #2d2d2d); color: #fff; padding: 30px; display: flex; justify-content: space-between; align-items: center; }
            .header h1 { font-size: 28px; color: #f9cb00; }
            .header .est-number { font-size: 14px; color: #aaa; }
            .header .est-number strong { color: #f9cb00; }
            .customer-section { padding: 20px 30px; border-bottom: 1px solid #eee; }
            .customer-section h3 { font-size: 12px; text-transform: uppercase; color: #888; margin-bottom: 8px; }
            .customer-section p { font-size: 15px; line-height: 1.6; }
            .items-section { padding: 20px 30px; }
            .items-section h3 { font-size: 14px; margin-bottom: 15px; color: #333; }
            .items-table { width: 100%; border-collapse: collapse; }
            .items-table th { background: #f5f5f5; padding: 10px; text-align: left; font-size: 11px; text-transform: uppercase; color: #666; }
            .items-table td { padding: 12px 10px; border-bottom: 1px solid #eee; }
            .items-table .category-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
            .totals-section { padding: 20px 30px; background: #f9f9f9; }
            .totals-row { display: flex; justify-content: space-between; padding: 8px 0; }
            .totals-row.total { font-size: 20px; font-weight: bold; border-top: 2px solid #f9cb00; padding-top: 15px; margin-top: 10px; }
            .deposit-box { background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border: 1px solid rgba(249,203,0,0.3); padding: 15px 20px; border-radius: 8px; margin-top: 15px; }
            .footer { padding: 20px 30px; background: #1a1a1a; color: #888; font-size: 12px; text-align: center; }
            .preview-banner { background: #f9cb00; color: #1a1a1a; padding: 10px; text-align: center; font-weight: bold; }
            @media print { .preview-banner { display: none; } body { padding: 0; } .estimate-preview { box-shadow: none; } }
          </style>
        </head>
        <body>
          <div class="preview-banner">PREVIEW - This is how your estimate will appear to the customer</div>
          <div class="estimate-preview">
            <div class="header">
              <div style="display: flex; align-items: center; gap: 20px;">
                ${companyLogo ? `<img src="${companyLogo}" alt="Logo" style="height: 60px; width: auto; max-width: 120px; object-fit: contain; border-radius: 8px;">` : `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #f9cb00, #cca600); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 24px; color: #1a1a1a;">${companyName.substring(0,2).toUpperCase()}</div>`}
                <div>
                  <div style="font-size: 22px; font-weight: 700;">${companyName}</div>
                  ${companyAddress ? `<div style="font-size: 12px; color: #aaa; margin-top: 4px;">${companyAddress}</div>` : ''}
                  ${companyContact ? `<div style="font-size: 12px; color: #aaa;">${companyContact}</div>` : ''}
                </div>
              </div>
              <div style="text-align: right;">
                <h1 style="font-size: 28px; color: #f9cb00; margin: 0;">ESTIMATE</h1>
                <div class="est-number" style="margin-top: 8px;">Estimate #: <strong>${estimateNumber}</strong></div>
                <div style="font-size: 12px; color: #888;">Date: ${estimateDate}</div>
              </div>
            </div>

            <div class="customer-section">
              <h3>Prepared For</h3>
              <p><strong>${customerName}</strong></p>
              <p>${document.getElementById('estimate-customer-address').value || ''} ${document.getElementById('estimate-customer-city').value || ''}</p>
              <p style="margin-top: 10px;"><strong>Project:</strong> ${projectName}</p>
            </div>

            <div class="items-section">
              <h3>Items & Services</h3>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Description</th>
                    <th>Unit</th>
                    <th style="text-align:center;">Qty</th>
                    <th style="text-align:right;">Price</th>
                    <th style="text-align:right;">Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${lineItems.map(item => {
                    const colors = { material: '#3b82f6', labor: '#22c55e', service: '#a855f7', other: '#6b7280' };
                    return `<tr>
                      <td><span class="category-dot" style="background:${colors[item.category] || '#6b7280'}"></span>${item.name}${item.description ? '<br><small style="color:#888">' + item.description + '</small>' : ''}</td>
                      <td>${item.unit}</td>
                      <td style="text-align:center;">${item.quantity}</td>
                      <td style="text-align:right;">$${item.unit_price.toFixed(2)}</td>
                      <td style="text-align:right;">$${(item.quantity * item.unit_price).toFixed(2)}</td>
                    </tr>`;
                  }).join('')}
                  ${lineItems.length === 0 ? '<tr><td colspan="5" style="text-align:center;color:#888;padding:20px;">No items added</td></tr>' : ''}
                </tbody>
              </table>
            </div>

            <div class="totals-section">
              <div class="totals-row"><span>Subtotal</span><span>${subtotal}</span></div>
              <div class="totals-row"><span>Tax</span><span>${taxAmount}</span></div>
              <div class="totals-row"><span>Discount</span><span>${discountAmount}</span></div>
              <div class="totals-row total"><span>TOTAL</span><span style="color:#f9cb00;">${total}</span></div>
              <div class="deposit-box">
                <div style="display:flex;justify-content:space-between;"><span><strong>Deposit Required</strong></span><span style="font-size:18px;font-weight:bold;color:#f9cb00;">${depositAmount}</span></div>
                <div style="font-size:12px;color:#666;margin-top:5px;">Due upon approval to begin project</div>
              </div>
            </div>

            <div class="footer">
              <p>Thank you for choosing <strong>${companyName}</strong>!</p>
              ${companyWebsite ? `<p style="margin-top: 5px;">${companyWebsite}</p>` : ''}
            </div>
          </div>
          <div style="text-align:center;margin-top:20px;">
            <button onclick="window.print()" style="padding:10px 20px;background:#f9cb00;border:none;border-radius:5px;cursor:pointer;font-weight:bold;">Print Preview</button>
            <button onclick="window.close()" style="padding:10px 20px;background:#333;color:#fff;border:none;border-radius:5px;cursor:pointer;margin-left:10px;">Close</button>
          </div>
        </body>
        </html>
      `;

      // Open in new window
      const previewWindow = window.open('', '_blank', 'width=900,height=700');
      previewWindow.document.write(previewHtml);
      previewWindow.document.close();
    }

    function closeCreateEstimateModal() {
      const modal = document.getElementById('create-estimate-modal');
      modal.classList.remove('active');
      // Clear any linked customer ID
      if (modal) delete modal.dataset.customerId;
    }

    async function loadBusinessDefaults() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: settings } = await supabaseClient
          .from('business_settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (settings) {
          businessSettings = settings;
          if (settings.default_tax_rate) {
            document.getElementById('estimate-tax-rate').value = settings.default_tax_rate;
          }
          if (settings.default_deposit_percent) {
            document.getElementById('estimate-deposit-percent').value = settings.default_deposit_percent;
          }
          if (settings.default_payment_terms) {
            document.getElementById('estimate-payment-terms').value = settings.default_payment_terms;
          }
          if (settings.default_warranty_terms) {
            document.getElementById('estimate-warranty').value = settings.default_warranty_terms;
          }
        }
      } catch (err) {
      }
    }

    function addEstimateLineItem(category = 'material', itemData = null) {
      const container = document.getElementById('estimate-line-items');

      // Remove empty message if present
      const emptyMsg = document.getElementById('empty-line-items-msg');
      if (emptyMsg) emptyMsg.remove();

      // Close the add item menu
      const menu = document.getElementById('add-item-menu');
      if (menu) menu.style.display = 'none';

      const template = document.querySelector('.line-item-template .estimate-line-item').cloneNode(true);

      // Set category
      const categoryColors = {
        material: '#3b82f6',
        labor: '#22c55e',
        service: '#a855f7',
        other: '#6b7280'
      };

      template.dataset.category = category;
      template.querySelector('.item-category').value = category;
      template.querySelector('.category-dot').style.background = categoryColors[category] || '#6b7280';
      template.querySelector('.category-dot').title = category.charAt(0).toUpperCase() + category.slice(1);

      // Set default unit based on category
      const unitSelect = template.querySelector('.item-unit');
      if (category === 'labor') {
        unitSelect.value = 'hour';
      } else if (category === 'service') {
        unitSelect.value = 'job';
      } else if (category === 'material') {
        unitSelect.value = 'sqft';
      }

      // Set values if item data provided
      if (itemData) {
        template.querySelector('.item-name').value = itemData.name || '';
        template.querySelector('.item-desc').value = itemData.description || '';
        template.querySelector('.item-unit').value = itemData.unit || unitSelect.value;
        template.querySelector('.item-qty').value = itemData.quantity || 1;
        template.querySelector('.item-price').value = itemData.price || 0;
      }

      // Add event listeners for real-time calculation
      template.querySelector('.item-qty').addEventListener('input', calculateEstimateTotals);
      template.querySelector('.item-price').addEventListener('input', calculateEstimateTotals);
      const costInput = template.querySelector('.item-cost');
      if (costInput) costInput.addEventListener('input', calculateEstimateTotals);

      container.appendChild(template);
      calculateEstimateTotals();

      // Focus the name field
      template.querySelector('.item-name').focus();
    }

    function removeEstimateLineItem(button) {
      const lineItem = button.closest('.estimate-line-item');
      lineItem.remove();
      calculateEstimateTotals();
    }

    function calculateEstimateTotals() {
      const lineItems = document.querySelectorAll('#estimate-line-items .estimate-line-item');
      let subtotal = 0;
      let totalCost = 0;
      const categoryTotals = { material: 0, labor: 0, service: 0, other: 0 };

      lineItems.forEach(item => {
        const qty = parseFloat(item.querySelector('.item-qty').value) || 0;
        const price = parseFloat(item.querySelector('.item-price').value) || 0;
        const costInput = item.querySelector('.item-cost');
        const cost = costInput ? (parseFloat(costInput.value) || 0) : 0;
        const total = qty * price;
        const totalItemCost = qty * cost;
        const category = item.querySelector('.item-category').value || 'other';

        item.querySelector('.item-total').textContent = '$' + total.toFixed(2);
        subtotal += total;
        totalCost += totalItemCost;
        categoryTotals[category] = (categoryTotals[category] || 0) + total;

        // Calculate and display margin for this line item
        const marginEl = item.querySelector('.item-margin');
        if (marginEl) {
          if (cost > 0 && price > 0) {
            const marginPercent = ((price - cost) / cost) * 100;
            marginEl.textContent = marginPercent.toFixed(1) + '%';
            // Color code the margin
            if (marginPercent < 0) {
              marginEl.style.color = '#ef4444'; // Red for negative
            } else if (marginPercent < 20) {
              marginEl.style.color = '#f59e0b'; // Orange for low
            } else {
              marginEl.style.color = '#22c55e'; // Green for good
            }
          } else {
            marginEl.textContent = '--%';
            marginEl.style.color = 'var(--text-muted)';
          }
        }
      });

      // Update category subtotals
      const subtotalMaterial = document.getElementById('subtotal-material');
      const subtotalLabor = document.getElementById('subtotal-labor');
      const subtotalService = document.getElementById('subtotal-service');

      if (subtotalMaterial) subtotalMaterial.textContent = '$' + categoryTotals.material.toFixed(2);
      if (subtotalLabor) subtotalLabor.textContent = '$' + categoryTotals.labor.toFixed(2);
      if (subtotalService) subtotalService.textContent = '$' + (categoryTotals.service + categoryTotals.other).toFixed(2);

      document.getElementById('estimate-subtotal').textContent = '$' + subtotal.toFixed(2);

      // Calculate tax
      const taxRate = parseFloat(document.getElementById('estimate-tax-rate').value) || 0;
      const taxAmount = subtotal * (taxRate / 100);
      document.getElementById('estimate-tax-amount').textContent = '$' + taxAmount.toFixed(2);

      // Calculate discount
      const discountValue = parseFloat(document.getElementById('estimate-discount-value').value) || 0;
      const discountType = document.getElementById('estimate-discount-type').value;
      let discountAmount = 0;
      if (discountType === 'percent') {
        discountAmount = subtotal * (discountValue / 100);
      } else {
        discountAmount = discountValue;
      }
      document.getElementById('estimate-discount-amount').textContent = '-$' + discountAmount.toFixed(2);

      // Calculate total
      const total = subtotal + taxAmount - discountAmount;
      document.getElementById('estimate-total').textContent = '$' + total.toFixed(2);

      // Calculate deposit and balance
      const depositPercentEl = document.getElementById('estimate-deposit-percent');
      const depositPercent = depositPercentEl ? (parseFloat(depositPercentEl.value) || 0) : 50;
      const depositAmount = total * (depositPercent / 100);
      const balanceAmount = total - depositAmount;

      const depositAmountEl = document.getElementById('estimate-deposit-amount');
      const balanceAmountEl = document.getElementById('estimate-balance-amount');
      const balancePercentEl = document.getElementById('estimate-balance-percent');

      if (depositAmountEl) depositAmountEl.textContent = '$' + depositAmount.toFixed(2);
      if (balanceAmountEl) balanceAmountEl.textContent = '$' + balanceAmount.toFixed(2);
      if (balancePercentEl) balancePercentEl.textContent = (100 - depositPercent) + '%';

      // Update margin summary (internal only)
      const totalCostEl = document.getElementById('estimate-total-cost');
      const totalProfitEl = document.getElementById('estimate-total-profit');
      const totalMarginEl = document.getElementById('estimate-total-margin');

      if (totalCostEl) totalCostEl.textContent = '$' + totalCost.toFixed(2);

      const profit = subtotal - totalCost;
      if (totalProfitEl) {
        totalProfitEl.textContent = '$' + profit.toFixed(2);
        totalProfitEl.style.color = profit >= 0 ? '#22c55e' : '#ef4444';
      }

      if (totalMarginEl) {
        if (totalCost > 0) {
          const overallMargin = ((subtotal - totalCost) / totalCost) * 100;
          totalMarginEl.textContent = overallMargin.toFixed(1) + '%';
          if (overallMargin < 0) {
            totalMarginEl.style.color = '#ef4444';
          } else if (overallMargin < 20) {
            totalMarginEl.style.color = '#f59e0b';
          } else {
            totalMarginEl.style.color = '#22c55e';
          }
        } else {
          totalMarginEl.textContent = '--%';
          totalMarginEl.style.color = 'var(--text-muted)';
        }
      }
    }

    // Alias for compatibility
    function updateEstimateTotals() {
      calculateEstimateTotals();
    }

    // Add event listeners for tax, discount, deposit changes
    document.addEventListener('DOMContentLoaded', function() {
      ['estimate-tax-rate', 'estimate-discount-value', 'estimate-discount-type', 'estimate-deposit-percent'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', calculateEstimateTotals);
      });
    });

    // Helper: timeout wrapper for promises
    function withTimeout(promise, ms, errorMsg) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(errorMsg || 'Operation timed out')), ms))
      ]);
    }

    async function handleCreateEstimate(event) {
      event.preventDefault();

      // Check supabaseClient
      if (!supabaseClient) {
        console.error('[Estimate] Supabase client not initialized');
        alert('Error: Database connection not ready. Please refresh the page.');
        return;
      }

      // Button is in modal footer, not inside form, so find it by form attribute
      const submitBtn = document.querySelector('button[form="create-estimate-form"][type="submit"]');
      if (!submitBtn) {
        console.error('[Estimate] Submit button not found');
        alert('Error: Submit button not found');
        return;
      }
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px;"></div> Creating...';
      submitBtn.disabled = true;

      try {
        const { data: { user }, error: userError } = await withTimeout(
          supabaseClient.auth.getUser(),
          10000,
          'Getting user timed out'
        );
        if (userError) {
          console.error('[Estimate] User error:', userError);
          throw userError;
        }
        if (!user) throw new Error('Please log in');

        // Collect line items with category
        const lineItems = [];
        document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
          const name = item.querySelector('.item-name').value.trim();
          if (name) {
            lineItems.push({
              name: name,
              description: item.querySelector('.item-desc').value.trim(),
              unit: item.querySelector('.item-unit').value,
              quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
              unit_price: parseFloat(item.querySelector('.item-price').value) || 0,
              category: item.querySelector('.item-category').value || 'other'
            });
          }
        });

        if (lineItems.length === 0) {
          throw new Error('Please add at least one line item');
        }
        console.log('[Estimate] Line items:', lineItems.length);

        // Generate estimate number
        const timestamp = Date.now().toString().slice(-6);
        const estimateNumber = `EST-${timestamp}`;
        console.log('[Estimate] Generated number:', estimateNumber);

        // Get totals
        const subtotal = parseFloat(document.getElementById('estimate-subtotal').textContent.replace('$', '').replace(',', '')) || 0;
        const taxRate = parseFloat(document.getElementById('estimate-tax-rate').value) || 0;
        const taxAmount = parseFloat(document.getElementById('estimate-tax-amount').textContent.replace('$', '').replace(',', '')) || 0;
        const discountValue = parseFloat(document.getElementById('estimate-discount-value').value) || 0;
        const discountType = document.getElementById('estimate-discount-type').value;
        const discountAmount = parseFloat(document.getElementById('estimate-discount-amount').textContent.replace('-$', '').replace(',', '')) || 0;
        const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;
        const depositPercentEl = document.getElementById('estimate-deposit-percent');
        const depositPercent = depositPercentEl ? (parseFloat(depositPercentEl.value) || 0) : 50;
        const depositAmount = total * (depositPercent / 100);

        // Get additional fields
        const projectType = document.getElementById('estimate-project-type').value || 'custom';
        const inclusionsEl = document.getElementById('estimate-inclusions');
        const exclusionsEl = document.getElementById('estimate-exclusions');
        const termsEl = document.getElementById('estimate-terms');
        const timelineEl = document.getElementById('estimate-timeline');
        const paymentScheduleType = document.getElementById('payment-schedule-type').value || 'deposit-balance';

        // Get customer_id from unified state (not dataset attributes)
        let customerId = estimateModalState.customerId || null;
        const leadId = estimateModalState.leadId || null;

        // If no customer linked, auto-create from form data
        const customerEmail = document.getElementById('estimate-customer-email').value.trim();
        const customerName = document.getElementById('estimate-customer-name').value.trim();

        if (!customerId && customerEmail) {
          const formData = {
            customerName: customerName,
            customerEmail: customerEmail,
            customerPhone: document.getElementById('estimate-customer-phone').value.trim(),
            customerAddress: document.getElementById('estimate-customer-address').value.trim(),
            customerCity: document.getElementById('estimate-customer-city').value.trim(),
            customerState: document.getElementById('estimate-customer-state').value.trim()
          };
          const newCustomer = await createCustomerFromEstimateForm(formData);
          if (newCustomer) {
            customerId = newCustomer.id;
            console.log('[Estimate] Auto-created customer:', customerId);
          }
        }

        // Create estimate
        const estimateData = {
          user_id: user.id,
          estimate_number: estimateNumber,
          customer_id: customerId,
          lead_id: leadId,
          customer_name: document.getElementById('estimate-customer-name').value.trim(),
          customer_email: document.getElementById('estimate-customer-email').value.trim() || null,
          customer_phone: document.getElementById('estimate-customer-phone').value.trim() || null,
          customer_address: document.getElementById('estimate-customer-address').value.trim() || null,
          customer_city: document.getElementById('estimate-customer-city').value.trim() || null,
          customer_state: document.getElementById('estimate-customer-state').value.trim() || null,
          customer_zip: document.getElementById('estimate-customer-zip').value.trim() || null,
          project_name: document.getElementById('estimate-project-name').value.trim() || null,
          description: document.getElementById('estimate-project-desc').value.trim() || null,
          project_type: projectType,
          valid_until: document.getElementById('estimate-valid-until')?.value || null,
          subtotal: subtotal,
          tax_rate: taxRate,
          tax_amount: taxAmount,
          discount_type: discountType,
          discount_value: discountValue,
          discount_amount: discountAmount,
          total: total,
          deposit_percent: depositPercent,
          deposit_amount: depositAmount,
          payment_schedule_type: paymentScheduleType,
          inclusions: inclusionsEl ? inclusionsEl.value.trim() || null : null,
          exclusions: exclusionsEl ? exclusionsEl.value.trim() || null : null,
          terms_conditions: termsEl ? termsEl.value.trim() || null : null,
          estimated_timeline: timelineEl ? timelineEl.value.trim() || null : null,
          warranty_terms: document.getElementById('estimate-warranty')?.value?.trim() || null,
          notes: document.getElementById('estimate-notes')?.value?.trim() || null,
          internal_notes: document.getElementById('estimate-internal-notes')?.value?.trim() || null,
          status: 'sent'
        };

        console.log('[Estimate] Inserting estimate with data:', JSON.stringify(estimateData, null, 2));
        const { data: estimate, error: estimateError } = await withTimeout(
          supabaseClient.from('estimates').insert([estimateData]).select().single(),
          15000,
          'Database insert timed out - please try again'
        );

        if (estimateError) {
          console.error('[Estimate] Insert error:', estimateError);
          console.error('[Estimate] Error details:', JSON.stringify(estimateError, null, 2));
          console.error('[Estimate] Data sent:', JSON.stringify(estimateData, null, 2));
          throw new Error(estimateError.message || estimateError.details || 'Failed to create estimate');
        }
        console.log('[Estimate] Created:', estimate.id);

        // Insert line items with category
        const itemsToInsert = lineItems.map(item => ({
          estimate_id: estimate.id,
          name: item.name,
          description: item.description,
          unit_type: item.unit,
          quantity: item.quantity,
          unit_price: item.unit_price,
          total: item.quantity * item.unit_price,
          category: item.category
        }));

        const { error: itemsError } = await withTimeout(
          supabaseClient.from('estimate_items').insert(itemsToInsert),
          15000,
          'Line items insert timed out'
        );

        if (itemsError) {
          console.error('[Estimate] Items error:', itemsError);
          throw itemsError;
        }

        // Generate approval token
        const token = crypto.randomUUID();
        try {
          const { error: tokenError } = await withTimeout(
            supabaseClient.from('estimate_tokens').insert([{
              estimate_id: estimate.id,
              token: token,
              expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]),
            10000,
            'Token creation timed out'
          );

          if (tokenError) {
            console.error('[Estimate] Token error:', tokenError);
          }
        } catch (tokenErr) {
          console.error('[Estimate] Token creation failed:', tokenErr.message);
          // Don't throw - estimate is already created
        }

        // Open preview with option to send
        closeCreateEstimateModal();
        loadEstimates();

        const viewLink = `${window.location.origin}/estimate/view/?token=${token}`;

        // Try to send email via API, but don't fail if it doesn't work
        // (customerEmail was already defined earlier in this function)
        if (customerEmail) {
          try {
            const emailController = new AbortController();
            const emailTimeout = setTimeout(() => emailController.abort(), 10000); // 10 sec timeout
            await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              signal: emailController.signal,
              body: JSON.stringify({
                to: customerEmail,
                customerName: estimateData.customer_name,
                estimateNumber: estimate.estimate_number,
                projectName: estimateData.project_name,
                total: estimateData.total,
                approvalUrl: viewLink
              })
            });
            clearTimeout(emailTimeout);
            showToast('Estimate created and email sent!');
          } catch (emailErr) {
            console.log('Email API unavailable:', emailErr.message);
            // Fallback: offer to copy link or open email client
            const sendManually = confirm(
              `Estimate created successfully!\n\n` +
              `The email server is temporarily unavailable (starting up). Would you like to:\n\n` +
              `• Click OK to open your email client with the estimate link\n` +
              `• Click Cancel to just copy the link\n\n` +
              `(The email will be sent automatically on future attempts)`
            );

            if (sendManually) {
              const subject = encodeURIComponent(`Your Estimate from ${businessSettings?.company_name || 'Surprise Granite'}`);
              const body = encodeURIComponent(
                `Hi ${estimateData.customer_name},\n\n` +
                `Please review your estimate at the link below:\n\n${viewLink}\n\n` +
                `Thank you,\n${businessSettings?.company_name || 'Surprise Granite'}`
              );
              window.open(`mailto:${customerEmail}?subject=${subject}&body=${body}`);
            } else {
              navigator.clipboard.writeText(viewLink);
              showToast('Estimate link copied to clipboard!');
            }
          }
        } else {
          showToast('Estimate created! Add customer email to send.');
        }

        // Offer to preview
        if (confirm('Would you like to preview the estimate?')) {
          window.open(viewLink, '_blank');
        }

      } catch (err) {
        console.error('Create estimate error:', err);
        alert('Error creating estimate: ' + err.message);
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    async function saveEstimateDraft() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Collect line items
        const lineItems = [];
        document.querySelectorAll('#estimate-line-items .estimate-line-item').forEach(item => {
          const name = item.querySelector('.item-name').value.trim();
          if (name) {
            lineItems.push({
              name: name,
              description: item.querySelector('.item-desc').value.trim(),
              unit: item.querySelector('.item-unit').value,
              quantity: parseFloat(item.querySelector('.item-qty').value) || 0,
              unit_price: parseFloat(item.querySelector('.item-price').value) || 0
            });
          }
        });

        const customerName = document.getElementById('estimate-customer-name').value.trim();
        if (!customerName) {
          throw new Error('Please enter a customer name');
        }

        // Get customer_id from unified state (preserve customer link in drafts!)
        let customerId = estimateModalState.customerId || null;
        const leadId = estimateModalState.leadId || null;

        // If no customer linked, auto-create from form data (even for drafts)
        const customerEmail = document.getElementById('estimate-customer-email').value.trim();
        if (!customerId && customerEmail) {
          const formData = {
            customerName: customerName,
            customerEmail: customerEmail,
            customerPhone: document.getElementById('estimate-customer-phone').value.trim(),
            customerAddress: document.getElementById('estimate-customer-address').value.trim(),
            customerCity: document.getElementById('estimate-customer-city').value.trim(),
            customerState: document.getElementById('estimate-customer-state').value.trim()
          };
          const newCustomer = await createCustomerFromEstimateForm(formData);
          if (newCustomer) customerId = newCustomer.id;
        }

        // Get totals
        const subtotal = parseFloat(document.getElementById('estimate-subtotal').textContent.replace('$', '').replace(',', '')) || 0;
        const total = parseFloat(document.getElementById('estimate-total').textContent.replace('$', '').replace(',', '')) || 0;

        const estimateData = {
          user_id: user.id,
          customer_id: customerId,
          lead_id: leadId,
          customer_name: customerName,
          customer_email: document.getElementById('estimate-customer-email').value.trim() || null,
          customer_phone: document.getElementById('estimate-customer-phone').value.trim() || null,
          customer_address: document.getElementById('estimate-customer-address').value.trim() || null,
          customer_city: document.getElementById('estimate-customer-city').value.trim() || null,
          customer_state: document.getElementById('estimate-customer-state').value.trim() || null,
          customer_zip: document.getElementById('estimate-customer-zip').value.trim() || null,
          project_name: document.getElementById('estimate-project-name').value.trim() || null,
          description: document.getElementById('estimate-project-desc').value.trim() || null,
          valid_until: document.getElementById('estimate-valid-until').value || null,
          subtotal: subtotal,
          tax_rate: parseFloat(document.getElementById('estimate-tax-rate').value) || 0,
          tax_amount: parseFloat(document.getElementById('estimate-tax-amount').textContent.replace('$', '')) || 0,
          discount_type: document.getElementById('estimate-discount-type').value,
          discount_value: parseFloat(document.getElementById('estimate-discount-value').value) || 0,
          discount_amount: parseFloat(document.getElementById('estimate-discount-amount').textContent.replace('-$', '')) || 0,
          total: total,
          deposit_percent: parseFloat(document.getElementById('estimate-deposit-percent').value) || 0,
          deposit_amount: parseFloat(document.getElementById('estimate-deposit-amount').textContent.replace('$', '')) || 0,
          payment_terms: document.getElementById('estimate-payment-terms').value.trim() || null,
          warranty_terms: document.getElementById('estimate-warranty').value.trim() || null,
          notes: document.getElementById('estimate-notes').value.trim() || null,
          internal_notes: document.getElementById('estimate-internal-notes').value.trim() || null,
          status: 'draft'
        };

        const { data: estimate, error } = await supabaseClient
          .from('estimates')
          .insert([estimateData])
          .select()
          .single();

        if (error) throw error;

        // Insert line items if any
        if (lineItems.length > 0) {
          const itemsToInsert = lineItems.map(item => ({
            estimate_id: estimate.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.quantity * item.unit_price
          }));

          await supabaseClient.from('estimate_items').insert(itemsToInsert);
        }

        closeCreateEstimateModal();
        loadEstimates();
        showToast('Draft saved successfully!');

      } catch (err) {
        console.error('Save draft error:', err);
        alert('Error saving draft: ' + err.message);
      }
    }

    async function sendEstimateEmail(estimateId, token) {
      try {
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!estimate || !estimate.customer_email) return;

        const approvalUrl = `${window.location.origin}/estimate/view/?token=${token}`;

        await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            to: estimate.customer_email,
            customerName: estimate.customer_name,
            estimateNumber: estimate.estimate_number,
            projectName: estimate.project_name,
            total: estimate.total,
            depositAmount: estimate.deposit_amount,
            validUntil: estimate.valid_until,
            approvalUrl: approvalUrl,
            items: estimate.estimate_items
          })
        });
      } catch (err) {
        console.error('Send email error:', err);
      }
    }

    async function sendEstimate(estimateId) {
      if (!confirm('Send this estimate to the customer?')) return;

      // Show loading state
      const btn = event?.target || document.querySelector(`button[onclick*="sendEstimate('${estimateId}')"]`);
      const originalText = btn?.innerHTML;
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '⏳ Sending...';
      }
      showToast('Preparing estimate...', 'info');

      try {
        // Fetch estimate with items
        const { data: estimate, error: fetchErr } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (fetchErr) throw fetchErr;

        if (!estimate.customer_email) {
          alert('Please add a customer email before sending');
          return;
        }

        // Update status to sent
        await supabaseClient
          .from('estimates')
          .update({ status: 'sent', sent_at: new Date().toISOString() })
          .eq('id', estimateId);

        // Generate token
        const token = crypto.randomUUID();
        await supabaseClient
          .from('estimate_tokens')
          .insert([{
            estimate_id: estimateId,
            token: token,
            expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
          }]);

        const viewLink = `${window.location.origin}/estimate/view/?token=${token}`;

        // Prepare complete estimate data for email + PDF
        const emailData = {
          customer_email: estimate.customer_email,
          customer_name: estimate.customer_name,
          customer_phone: estimate.customer_phone,
          customer_address: estimate.customer_address,
          estimate_number: estimate.estimate_number,
          estimate_id: estimate.id,
          items: (estimate.estimate_items || []).map(item => ({
            description: item.description,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          })),
          subtotal: estimate.subtotal,
          tax_rate: estimate.tax_rate,
          tax_amount: estimate.tax_amount,
          total: estimate.total,
          notes: estimate.notes,
          view_url: viewLink,
          // Business info
          business_name: businessSettings?.company_name,
          business_email: businessSettings?.company_email,
          business_phone: businessSettings?.company_phone,
          business_address: businessSettings?.company_address,
          business_logo: businessSettings?.logo_url,
          // Project details
          project_type: estimate.project_type || estimate.project_name,
          estimated_timeline: estimate.estimated_timeline,
          inclusions: estimate.inclusions,
          exclusions: estimate.exclusions,
          terms_conditions: estimate.terms_conditions,
          valid_until: estimate.valid_until,
          created_at: estimate.created_at
        };

        // Parse payment schedule if stored as JSON
        if (estimate.payment_schedule) {
          try {
            emailData.payment_schedule = typeof estimate.payment_schedule === 'string'
              ? JSON.parse(estimate.payment_schedule)
              : estimate.payment_schedule;
          } catch (e) {}
        }

        // Try to send email via API with timeout
        try {
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 15000); // 15 sec timeout
          const response = await fetch('https://surprise-granite-email-api.onrender.com/api/send-estimate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            signal: controller.signal,
            body: JSON.stringify(emailData)
          });
          clearTimeout(timeout);

          const result = await response.json();

          if (response.ok && result.success) {
            showToast(result.pdf_attached ? 'Estimate sent with PDF!' : 'Estimate sent!');

            // Send SMS notification (email already sent by API)
            sendNotification('estimate', 'sent', estimate, {
              email: null, // Already sent by email API
              phone: estimate.customer_phone,
              name: estimate.customer_name
            });
          } else {
            throw new Error(result.error || 'Failed to send');
          }
        } catch (emailErr) {
          console.log('Email API error:', emailErr.message);
          // Fallback to email client
          const subject = encodeURIComponent(`Your Estimate from ${businessSettings?.company_name || 'Surprise Granite'}`);
          const body = encodeURIComponent(
            `Hi ${estimate.customer_name},\n\n` +
            `Please review your estimate at the link below:\n\n${viewLink}\n\n` +
            `Thank you,\n${businessSettings?.company_name || 'Surprise Granite'}`
          );
          window.open(`mailto:${estimate.customer_email}?subject=${subject}&body=${body}`);
          showToast('Email client opened with estimate link');
        }

        loadEstimates();
      } catch (err) {
        console.error('Send estimate error:', err);
        alert('Error sending estimate: ' + err.message);
      } finally {
        // Reset button state
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = originalText || 'Send';
        }
      }
    }

    async function viewEstimate(estimateId) {
      // Open estimate in preview modal or new tab
      try {
        const { data: tokenData } = await supabaseClient
          .from('estimate_tokens')
          .select('token')
          .eq('estimate_id', estimateId)
          .order('created_at', { ascending: false })
          .limit(1)
          .single();

        if (tokenData) {
          window.open(`/estimate/view/?token=${tokenData.token}`, '_blank');
        } else {
          // Generate new token for viewing
          const token = crypto.randomUUID();
          await supabaseClient
            .from('estimate_tokens')
            .insert([{
              estimate_id: estimateId,
              token: token,
              expires_at: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
            }]);
          window.open(`/estimate/view/?token=${token}`, '_blank');
        }
      } catch (err) {
        console.error('View estimate error:', err);
        alert('Error viewing estimate');
      }
    }

    async function deleteEstimate(estimateId) {
      if (!confirm('Delete this draft estimate?')) return;

      try {
        await supabaseClient.from('estimates').delete().eq('id', estimateId);
        loadEstimates();
        showToast('Estimate deleted');
      } catch (err) {
        console.error('Delete estimate error:', err);
        alert('Error deleting estimate');
      }
    }

    async function archiveEstimate(estimateId) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ archived_at: new Date().toISOString() })
          .eq('id', estimateId);

        if (error) throw error;
        loadEstimates();
        showToast('Estimate archived');
      } catch (err) {
        console.error('Archive estimate error:', err);
        alert('Error archiving estimate');
      }
    }

    async function unarchiveEstimate(estimateId) {
      try {
        const { error } = await supabaseClient
          .from('estimates')
          .update({ archived_at: null })
          .eq('id', estimateId);

        if (error) throw error;
        loadEstimates();
        showToast('Estimate restored');
      } catch (err) {
        console.error('Unarchive estimate error:', err);
        alert('Error restoring estimate');
      }
    }

    async function deleteEstimatePermanent(estimateId) {
      if (!confirm('Permanently delete this estimate? This cannot be undone.')) return;

      try {
        // Delete line items first
        await supabaseClient.from('estimate_items').delete().eq('estimate_id', estimateId);
        // Delete the estimate
        await supabaseClient.from('estimates').delete().eq('id', estimateId);
        loadEstimates();
        showToast('Estimate permanently deleted');
      } catch (err) {
        console.error('Delete estimate error:', err);
        alert('Error deleting estimate');
      }
    }

    async function duplicateEstimate(estimateId) {
      try {
        const { data: original } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!original) throw new Error('Estimate not found');

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Create copy
        const newEstimate = {
          user_id: user.id,
          customer_name: original.customer_name,
          customer_email: original.customer_email,
          customer_phone: original.customer_phone,
          customer_address: original.customer_address,
          customer_city: original.customer_city,
          customer_state: original.customer_state,
          customer_zip: original.customer_zip,
          project_name: original.project_name ? original.project_name + ' (Copy)' : null,
          description: original.description,
          valid_until: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          subtotal: original.subtotal,
          tax_rate: original.tax_rate,
          tax_amount: original.tax_amount,
          discount_type: original.discount_type,
          discount_value: original.discount_value,
          discount_amount: original.discount_amount,
          total: original.total,
          deposit_percent: original.deposit_percent,
          deposit_amount: original.deposit_amount,
          payment_terms: original.payment_terms,
          warranty_terms: original.warranty_terms,
          notes: original.notes,
          internal_notes: original.internal_notes,
          status: 'draft'
        };

        const { data: newEst, error } = await supabaseClient
          .from('estimates')
          .insert([newEstimate])
          .select()
          .single();

        if (error) throw error;

        // Copy line items
        if (original.estimate_items && original.estimate_items.length > 0) {
          const items = original.estimate_items.map(item => ({
            estimate_id: newEst.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          }));

          await supabaseClient.from('estimate_items').insert(items);
        }

        loadEstimates();
        showToast('Estimate duplicated!');
      } catch (err) {
        console.error('Duplicate estimate error:', err);
        alert('Error duplicating estimate');
      }
    }

    // Bridge: Create project pre-filled from order data
    async function createProjectFromOrder(orderId) {
      try {
        var order = (allOrders || []).find(function(o) { return o.id === orderId; });
        if (!order) {
          var result = await supabaseClient.from('shopify_orders').select('*').eq('id', orderId).single();
          order = result.data;
        }
        if (!order) { showToast('Order not found', 'warning'); return; }

        showPage('projects');
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = 'Order #' + (order.order_number || order.id) + ' - ' + (order.customer_name || '');
          document.getElementById('proj-customer-name').value = order.customer_name || '';
          document.getElementById('proj-customer-email').value = order.customer_email || '';
          document.getElementById('proj-customer-phone').value = order.customer_phone || '';
          document.getElementById('proj-value').value = order.total || '';
          document.getElementById('proj-notes').value = 'Created from order #' + (order.order_number || order.id);
          document.getElementById('proj-status').value = (order.financial_status || '').toLowerCase() === 'paid' ? 'scheduled' : 'approved';
          showToast('Project form pre-filled from order', 'success');
        }, 300);
      } catch (err) {
        showToast('Error loading order', 'error');
      }
    }

    // Bridge: Create project pre-filled from invoice data
    async function createProjectFromInvoice(invoiceId) {
      try {
        // First try to find in our cached allInvoices array (handles both Supabase and Stripe)
        var inv = allInvoices.find(i => i.id === invoiceId);

        // If not found in cache and it's a UUID (Supabase), try fetching from database
        if (!inv && !invoiceId.startsWith('in_')) {
          var result = await supabaseClient.from('invoices').select('*').eq('id', invoiceId).single();
          inv = result.data;
        }

        if (!inv) { showToast('Invoice not found', 'warning'); return; }

        showPage('projects');
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = 'Project - ' + (inv.customer_name || inv.invoice_number || '');
          document.getElementById('proj-customer-name').value = inv.customer_name || '';
          document.getElementById('proj-customer-email').value = inv.customer_email || '';
          document.getElementById('proj-customer-phone').value = inv.customer_phone || '';
          document.getElementById('proj-value').value = inv.total || '';
          document.getElementById('proj-notes').value = 'Created from invoice #' + (inv.invoice_number || invoiceId.substring(0, 8));
          document.getElementById('proj-status').value = inv.status === 'paid' ? 'scheduled' : 'approved';
          showToast('Project form pre-filled from invoice', 'success');
        }, 300);
      } catch (err) {
        showToast('Error loading invoice', 'error');
      }
    }

    // Bridge: Create project pre-filled from estimate data
    async function createProjectFromEstimate(estimateId) {
      try {
        var result = await supabaseClient.from('estimates').select('*').eq('id', estimateId).single();
        var est = result.data;
        if (!est) { showToast('Estimate not found', 'warning'); return; }

        showPage('projects');
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = est.project_name || ('Project - ' + (est.customer_name || ''));
          document.getElementById('proj-customer-name').value = est.customer_name || '';
          document.getElementById('proj-customer-email').value = est.customer_email || '';
          document.getElementById('proj-customer-phone').value = est.customer_phone || '';
          document.getElementById('proj-address').value = est.customer_address || '';
          document.getElementById('proj-city').value = est.customer_city || '';
          document.getElementById('proj-state').value = est.customer_state || '';
          document.getElementById('proj-zip').value = est.customer_zip || '';
          document.getElementById('proj-value').value = est.total || '';
          document.getElementById('proj-notes').value = 'Created from estimate ' + (est.estimate_number || '#' + estimateId.substring(0, 8));
          document.getElementById('proj-status').value = 'approved';
          showToast('Project form pre-filled from estimate', 'success');
        }, 300);
      } catch (err) {
        showToast('Error loading estimate', 'error');
      }
    }

    // Bridge: Create estimate pre-filled from project data
    async function createEstimateFromProject(projectId) {
      var project = allProjects.find(function(p) { return p.id === projectId; });
      if (!project) { showToast('Project not found', 'warning'); return; }

      // Close project detail modal
      document.getElementById('project-detail-modal').classList.remove('active');
      showPage('estimates');

      estimateModalState = { customerId: null, leadId: null, editingEstimateId: null };

      setTimeout(function() {
        openCreateEstimateModal(false);
        fillField('estimate-customer-name', project.customer_name);
        fillField('estimate-customer-email', project.customer_email);
        fillField('estimate-customer-phone', project.customer_phone);
        fillField('estimate-customer-address', project.address);
        fillField('estimate-customer-city', project.city);
        fillField('estimate-customer-state', project.state);
        fillField('estimate-customer-zip', project.zip);
        fillField('estimate-project-name', project.name);
        fillField('estimate-project-desc', project.description || '');
        showToast('Estimate form pre-filled from project', 'success');
      }, 300);
    }

    async function convertToInvoice(estimateId) {
      if (!confirm('Convert this estimate to an invoice?')) return;

      try {
        const { data: estimate } = await supabaseClient
          .from('estimates')
          .select('*, estimate_items(*)')
          .eq('id', estimateId)
          .single();

        if (!estimate) throw new Error('Estimate not found');

        // Prevent duplicate conversion
        if (estimate.status === 'converted' || estimate.converted_to_invoice_id) {
          alert('This estimate has already been converted to an invoice.');
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();

        // Generate invoice number
        const invoicePrefix = businessSettings?.invoice_prefix || 'INV-';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 5).toUpperCase();
        const invoiceNumber = `${invoicePrefix}${timestamp}-${random}`;

        // Create invoice - preserve full traceability chain
        const invoiceData = {
          user_id: user.id,
          invoice_number: invoiceNumber,
          estimate_id: estimateId,
          lead_id: estimate.lead_id || null,  // Preserve lead reference for traceability
          customer_id: estimate.customer_id || null,
          customer_name: estimate.customer_name,
          customer_email: estimate.customer_email,
          customer_phone: estimate.customer_phone,
          customer_address: estimate.customer_address,
          customer_city: estimate.customer_city,
          customer_state: estimate.customer_state,
          customer_zip: estimate.customer_zip,
          project_name: estimate.project_name,
          subtotal: estimate.subtotal,
          tax_rate: estimate.tax_rate,
          tax_amount: estimate.tax_amount,
          discount_type: estimate.discount_type,
          discount_value: estimate.discount_value,
          discount_amount: estimate.discount_amount,
          total: estimate.total,
          amount_paid: 0,
          amount_due: estimate.total,
          payment_terms: estimate.payment_terms,
          notes: estimate.notes,
          status: 'unpaid',
          due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString()
        };

        const { data: invoice, error } = await supabaseClient
          .from('invoices')
          .insert([invoiceData])
          .select()
          .single();

        if (error) throw error;

        // Copy line items to invoice
        if (estimate.estimate_items && estimate.estimate_items.length > 0) {
          const items = estimate.estimate_items.map(item => ({
            invoice_id: invoice.id,
            name: item.name,
            description: item.description,
            unit_type: item.unit,
            quantity: item.quantity,
            unit_price: item.unit_price,
            total: item.total
          }));

          await supabaseClient.from('invoice_items').insert(items);
        }

        // Update estimate status
        await supabaseClient
          .from('estimates')
          .update({ status: 'converted', converted_to_invoice_id: invoice.id })
          .eq('id', estimateId);

        // Optionally create Stripe invoice for payment processing (non-blocking)
        try {
          const stripeItems = (estimate.estimate_items || []).map(item => ({
            description: item.name || item.description,
            quantity: item.quantity || 1,
            amount: item.unit_price || item.total || 0
          }));

          if (stripeItems.length > 0 && estimate.customer_email) {
            const response = await apiCall('/api/invoices', {
              method: 'POST',
              body: JSON.stringify({
                customer_email: estimate.customer_email,
                customer_name: estimate.customer_name,
                customer_phone: estimate.customer_phone,
                items: stripeItems,
                due_days: 30,
                notes: estimate.notes || '',
                auto_send: false
              })
            });

            if (response.ok) {
              const stripeData = await response.json();
              if (stripeData.invoice?.id) {
                await supabaseClient
                  .from('invoices')
                  .update({
                    stripe_invoice_id: stripeData.invoice.id,
                    stripe_hosted_url: stripeData.invoice.hosted_invoice_url,
                    stripe_pdf_url: stripeData.invoice.pdf
                  })
                  .eq('id', invoice.id);
              }
            }
          }
        } catch (stripeErr) {
          console.warn('[ConvertToInvoice] Stripe invoice creation failed (Supabase record saved):', stripeErr.message);
        }

        // Bridge: Link invoice back to project if one references this estimate
        try {
          var projResult = await supabaseClient.from('projects')
            .select('id')
            .eq('estimate_id', estimateId)
            .single();
          if (projResult.data) {
            await supabaseClient.from('projects')
              .update({ invoice_id: invoice.id })
              .eq('id', projResult.data.id);
          }
        } catch (e) { /* non-blocking */ }

        showToast('Invoice created successfully!');
        showPage('invoices');
        loadInvoices();
      } catch (err) {
        console.error('Convert to invoice error:', err);
        alert('Error converting to invoice: ' + err.message);
      }
    }

    // Alias for context menu compatibility
    const convertEstimateToInvoice = convertToInvoice;

    // =============================================
    // BUSINESS SETTINGS
    // =============================================

    function openBusinessSettings() {
      const modal = document.getElementById('business-settings-modal');
      modal.classList.add('active');
      loadBusinessSettings();
      updateQuickBooksSettingsUI();
    }

    // Update QuickBooks UI in settings modal
    async function updateQuickBooksSettingsUI() {
      const connectBtn = document.getElementById('qbo-connect-btn');
      const disconnectBtn = document.getElementById('qbo-disconnect-btn');
      const statusText = document.getElementById('qbo-status-text');

      if (!connectBtn || !disconnectBtn) return;

      try {
        const session = await supabaseClient.auth.getSession();
        const token = session.data.session?.access_token;
        if (!token) return;

        const response = await fetch(`${API_BASE}/api/quickbooks/status`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();

        if (data.connected) {
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'inline-flex';
          if (statusText) {
            statusText.textContent = 'Connected - syncing enabled';
            statusText.style.color = '#22c55e';
          }
        } else {
          connectBtn.style.display = 'inline-flex';
          disconnectBtn.style.display = 'none';
          if (statusText) {
            statusText.textContent = 'Sync invoices & estimates';
            statusText.style.color = 'var(--text-muted)';
          }
        }
      } catch (e) {
        console.error('QuickBooks status check failed:', e);
      }
    }

    function closeBusinessSettings() {
      const modal = document.getElementById('business-settings-modal');
      modal.classList.remove('active');
    }

    async function loadBusinessSettings() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: settings } = await supabaseClient
          .from('business_settings')
          .select('*')
          .eq('user_id', user.id)
          .single();

        if (settings) {
          document.getElementById('biz-company-name').value = settings.company_name || '';
          document.getElementById('biz-phone').value = settings.phone || '';
          document.getElementById('biz-email').value = settings.email || '';
          document.getElementById('biz-address').value = settings.address || '';
          document.getElementById('biz-city').value = settings.city || '';
          document.getElementById('biz-state').value = settings.state || '';
          document.getElementById('biz-zip').value = settings.zip || '';
          document.getElementById('biz-license').value = settings.license_number || '';
          document.getElementById('biz-website').value = settings.website || '';
          document.getElementById('biz-estimate-prefix').value = settings.estimate_prefix || 'EST-';
          if (document.getElementById('biz-invoice-prefix')) {
            document.getElementById('biz-invoice-prefix').value = settings.invoice_prefix || 'INV-';
          }
          document.getElementById('biz-estimate-terms').value = settings.default_estimate_terms || '';

          // Load defaults
          if (document.getElementById('biz-tax-rate')) {
            document.getElementById('biz-tax-rate').value = settings.default_tax_rate || 0;
          }
          if (document.getElementById('biz-deposit')) {
            document.getElementById('biz-deposit').value = settings.default_deposit_percent || 50;
          }
          if (document.getElementById('biz-payment-terms')) {
            document.getElementById('biz-payment-terms').value = settings.default_payment_terms || '';
          }
          if (document.getElementById('biz-warranty')) {
            document.getElementById('biz-warranty').value = settings.default_warranty_terms || '';
          }

          // Load logo if exists
          const logoUrl = settings.logo_url;
          const logoImage = document.getElementById('logo-image');
          const logoPlaceholder = document.getElementById('logo-placeholder');
          const removeLogoBtn = document.getElementById('remove-logo-btn');
          const logoUrlInput = document.getElementById('biz-logo-url');

          if (logoUrl) {
            logoImage.src = logoUrl;
            logoImage.style.display = 'block';
            logoPlaceholder.style.display = 'none';
            removeLogoBtn.style.display = 'inline-block';
            logoUrlInput.value = logoUrl;
          } else {
            logoImage.style.display = 'none';
            logoPlaceholder.style.display = 'block';
            removeLogoBtn.style.display = 'none';
            logoUrlInput.value = '';
          }
        }
      } catch (err) {
      }
    }

    async function saveBusinessSettings(event) {
      if (event) event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const settingsData = {
          user_id: user.id,
          company_name: document.getElementById('biz-company-name').value.trim() || null,
          phone: document.getElementById('biz-phone').value.trim() || null,
          email: document.getElementById('biz-email').value.trim() || null,
          address: document.getElementById('biz-address').value.trim() || null,
          city: document.getElementById('biz-city').value.trim() || null,
          state: document.getElementById('biz-state').value.trim() || null,
          zip: document.getElementById('biz-zip').value.trim() || null,
          license_number: document.getElementById('biz-license').value.trim() || null,
          website: document.getElementById('biz-website').value.trim() || null,
          estimate_prefix: document.getElementById('biz-estimate-prefix').value.trim() || 'EST-',
          invoice_prefix: document.getElementById('biz-invoice-prefix')?.value.trim() || 'INV-',
          default_estimate_terms: document.getElementById('biz-estimate-terms').value.trim() || null,
          default_tax_rate: parseFloat(document.getElementById('biz-tax-rate')?.value) || 0,
          default_deposit_percent: parseFloat(document.getElementById('biz-deposit')?.value) || 50,
          default_payment_terms: document.getElementById('biz-payment-terms')?.value.trim() || null,
          default_warranty_terms: document.getElementById('biz-warranty')?.value.trim() || null,
          logo_url: document.getElementById('biz-logo-url').value.trim() || null
        };

        const { error } = await supabaseClient
          .from('business_settings')
          .upsert([settingsData], { onConflict: 'user_id' });

        if (error) throw error;

        closeBusinessSettings();
        showToast('Business settings saved!');
      } catch (err) {
        console.error('Save business settings error:', err);
        alert('Error saving settings: ' + err.message);
      }

      return false;
    }

    // Logo upload handler
    async function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }

      // Validate file size (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('Image must be smaller than 2MB');
        return;
      }

      const logoImage = document.getElementById('logo-image');
      const logoPlaceholder = document.getElementById('logo-placeholder');
      const removeLogoBtn = document.getElementById('remove-logo-btn');
      const logoUrlInput = document.getElementById('biz-logo-url');

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Show loading state
        logoPlaceholder.innerHTML = 'Uploading...';
        logoPlaceholder.style.display = 'block';
        logoImage.style.display = 'none';

        // Create unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `logos/${user.id}/logo-${Date.now()}.${fileExt}`;

        // Upload to Supabase Storage
        const { data, error } = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });

        if (error) throw error;

        // Get public URL
        const { data: urlData } = supabaseClient.storage
          .from('lead-images')
          .getPublicUrl(fileName);

        const publicUrl = urlData.publicUrl;

        // Update UI
        logoImage.src = publicUrl;
        logoImage.style.display = 'block';
        logoPlaceholder.style.display = 'none';
        removeLogoBtn.style.display = 'inline-block';
        logoUrlInput.value = publicUrl;

        showToast('Logo uploaded! Click Save to apply changes.');
      } catch (err) {
        console.error('Logo upload error:', err);
        logoPlaceholder.innerHTML = 'No logo<br>uploaded';
        logoPlaceholder.style.display = 'block';
        alert('Error uploading logo: ' + err.message);
      }
    }

    // Remove logo handler
    function removeLogo() {
      const logoImage = document.getElementById('logo-image');
      const logoPlaceholder = document.getElementById('logo-placeholder');
      const removeLogoBtn = document.getElementById('remove-logo-btn');
      const logoUrlInput = document.getElementById('biz-logo-url');
      const logoUpload = document.getElementById('logo-upload');

      logoImage.src = '';
      logoImage.style.display = 'none';
      logoPlaceholder.innerHTML = 'No logo<br>uploaded';
      logoPlaceholder.style.display = 'block';
      removeLogoBtn.style.display = 'none';
      logoUrlInput.value = '';
      logoUpload.value = '';

      showToast('Logo removed. Click Save to apply changes.');
    }

    // =============================================
    // PROJECTS MANAGEMENT
    // =============================================

    let allProjects = [];
    let projectFilter = 'all';
    let projectSearchTerm = '';
    let currentProjectsView = 'list';
    let currentProjectId = null;
    let projectSearchTimeout = null;

    const PROJECT_STATUS_COLORS = {
      lead: '#f59e0b',
      approved: '#3b82f6',
      scheduled: '#8b5cf6',
      in_progress: '#06b6d4',
      completed: '#22c55e',
      on_hold: '#ef4444',
      cancelled: '#6b7280'
    };

    const PROJECT_STATUS_LABELS = {
      lead: 'Lead',
      approved: 'Approved',
      scheduled: 'Scheduled',
      in_progress: 'In Progress',
      completed: 'Completed',
      on_hold: 'On Hold',
      cancelled: 'Cancelled'
    };

    const PROJECT_PRIORITY_COLORS = {
      low: '#6b7280',
      medium: '#3b82f6',
      high: '#f59e0b',
      urgent: '#ef4444'
    };

    // Workflow stages for home services projects
    const WORKFLOW_STAGES = [
      { key: 'lead', label: 'Lead', icon: '📋', color: '#6b7280', status: 'lead' },
      { key: 'appointment', label: 'Appointment', icon: '📅', color: '#3b82f6', status: 'lead' },
      { key: 'estimate', label: 'Estimate', icon: '📝', color: '#8b5cf6', status: 'lead' },
      { key: 'approved', label: 'Approved', icon: '✓', color: '#10b981', status: 'approved' },
      { key: 'deposit', label: 'Deposit', icon: '💰', color: '#f59e0b', status: 'approved' },
      { key: 'materials', label: 'Materials', icon: '📦', color: '#14b8a6', status: 'scheduled' },
      { key: 'scheduled', label: 'Scheduled', icon: '🗓️', color: '#06b6d4', status: 'scheduled' },
      { key: 'installing', label: 'Installing', icon: '🔧', color: '#ec4899', status: 'in_progress' },
      { key: 'completed', label: 'Complete', icon: '✅', color: '#22c55e', status: 'completed' }
    ];

    function getWorkflowStageIndex(project) {
      // Map project status to workflow stage
      const status = project.status || 'lead';
      const workflowStage = project.workflow_stage;

      // If explicit workflow_stage is set, use that
      if (workflowStage) {
        const idx = WORKFLOW_STAGES.findIndex(s => s.key === workflowStage);
        if (idx >= 0) return idx;
      }

      // Otherwise infer from status
      switch (status) {
        case 'lead': return project.has_estimate ? 2 : (project.has_appointment ? 1 : 0);
        case 'approved': return project.has_deposit ? 4 : 3;
        case 'scheduled': return project.has_materials ? 6 : 5;
        case 'in_progress': return 7;
        case 'completed': return 8;
        default: return 0;
      }
    }

    function renderWorkflowStatusBar(project) {
      const currentIndex = getWorkflowStageIndex(project);

      return '<div style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; margin-bottom: 20px;">' +
        '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">' +
          '<div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Workflow Progress</div>' +
          '<span style="font-size: 12px; color: var(--gold-primary); font-weight: 600;">' + Math.round((currentIndex / (WORKFLOW_STAGES.length - 1)) * 100) + '%</span>' +
        '</div>' +
        '<div style="display: flex; align-items: center; gap: 4px; overflow-x: auto; padding-bottom: 8px;">' +
          WORKFLOW_STAGES.map(function(stage, i) {
            var isCompleted = i < currentIndex;
            var isCurrent = i === currentIndex;
            var isPending = i > currentIndex;
            var bgColor = isCompleted ? stage.color : (isCurrent ? stage.color + '33' : 'var(--dark-tertiary)');
            var textColor = isCompleted ? '#fff' : (isCurrent ? stage.color : 'var(--text-muted)');
            var canAdvance = i === currentIndex + 1;

            return '<div class="workflow-stage" onclick="' + (canAdvance ? 'advanceWorkflowStage(\'' + project.id + '\', \'' + stage.key + '\')' : '') + '" style="flex: 1; min-width: 60px; text-align: center; cursor: ' + (canAdvance ? 'pointer' : 'default') + '; opacity: ' + (isPending && !canAdvance ? '0.5' : '1') + '; transition: all 0.2s;" title="' + (canAdvance ? 'Click to advance to ' + stage.label : stage.label) + '">' +
              '<div style="width: 32px; height: 32px; border-radius: 50%; background: ' + bgColor + '; color: ' + textColor + '; display: flex; align-items: center; justify-content: center; margin: 0 auto 4px; font-size: 14px; border: 2px solid ' + (isCurrent ? stage.color : 'transparent') + '; transition: all 0.2s;">' +
                (isCompleted ? '✓' : stage.icon) +
              '</div>' +
              '<div style="font-size: 10px; color: ' + (isCurrent ? 'var(--text-primary)' : 'var(--text-muted)') + '; font-weight: ' + (isCurrent ? '600' : '400') + '; white-space: nowrap;">' + stage.label + '</div>' +
            '</div>' +
            (i < WORKFLOW_STAGES.length - 1 ? '<div style="flex-shrink: 0; width: 20px; height: 2px; background: ' + (isCompleted ? stage.color : 'var(--dark-border)') + '; margin-top: -16px;"></div>' : '');
          }).join('') +
        '</div>' +
      '</div>';
    }

    async function advanceWorkflowStage(projectId, newStage) {
      const stage = WORKFLOW_STAGES.find(s => s.key === newStage);
      if (!stage) return;

      const confirmed = confirm('Advance project to "' + stage.label + '" stage?');
      if (!confirmed) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Update project with new workflow stage and status
        const { error } = await supabaseClient
          .from('projects')
          .update({
            workflow_stage: newStage,
            status: stage.status,
            updated_at: new Date().toISOString()
          })
          .eq('id', projectId)
          .eq('user_id', user.id);

        if (error) throw error;

        // Auto-create calendar event for certain stages
        if (['appointment', 'scheduled', 'installing'].includes(newStage)) {
          await autoCreateWorkflowEvent(projectId, newStage, user.id);
        }

        showToast('Advanced to ' + stage.label, 'success');
        await loadProjects();

        // Refresh detail modal if open
        if (currentProjectId === projectId) {
          openProjectDetail(projectId);
        }

      } catch (err) {
        console.error('Error advancing workflow:', err);
        showToast(err.message || 'Failed to advance workflow', 'error');
      }
    }

    async function autoCreateWorkflowEvent(projectId, stage, userId) {
      try {
        // Get project details
        const { data: project } = await supabaseClient
          .from('projects')
          .select('name, customer_name, customer_email, customer_phone, address, city, state, zip')
          .eq('id', projectId)
          .single();

        if (!project) return;

        const eventTypes = {
          appointment: { type: 'measurement', title: 'Measurement - ' },
          scheduled: { type: 'installation', title: 'Installation - ' },
          installing: { type: 'installation', title: 'In Progress - ' }
        };

        const eventConfig = eventTypes[stage];
        if (!eventConfig) return;

        // Check if event already exists for this project and type
        const { data: existingEvents } = await supabaseClient
          .from('calendar_events')
          .select('id')
          .eq('project_id', projectId)
          .eq('event_type', eventConfig.type)
          .limit(1);

        if (existingEvents && existingEvents.length > 0) {
          return;
        }

        // Create the event (scheduled for tomorrow at 9am)
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        const endTime = new Date(tomorrow.getTime() + 3 * 60 * 60 * 1000); // 3 hours

        await supabaseClient
          .from('calendar_events')
          .insert({
            created_by: userId,
            title: eventConfig.title + (project.customer_name || project.name),
            event_type: eventConfig.type,
            status: 'scheduled',
            start_time: tomorrow.toISOString(),
            end_time: endTime.toISOString(),
            location: project.address,
            location_address: [project.address, project.city, project.state, project.zip].filter(Boolean).join(', '),
            description: 'Customer: ' + (project.customer_name || 'N/A') + '\nPhone: ' + (project.customer_phone || 'N/A') + '\nEmail: ' + (project.customer_email || 'N/A'),
            project_id: projectId,
            metadata: {
              contact_name: project.customer_name,
              contact_email: project.customer_email,
              contact_phone: project.customer_phone,
              auto_created: true,
              workflow_stage: stage
            }
          });

        showToast('Calendar event auto-created', 'info');
        console.log('Auto-created calendar event for workflow stage:', stage);

      } catch (err) {
        console.warn('Could not auto-create workflow event:', err.message);
      }
    }

    async function loadProjects() {
      const listEl = document.getElementById('projects-list');
      if (!listEl) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        listEl.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: projects, error } = await supabaseClient
          .from('projects')
          .select('*')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allProjects = projects || [];
        updateProjectStats();
        updateProjectsCount();
        renderProjectsList();
        renderProjectsKanban();

        // Bridge: Check for design-to-project handoff
        checkDesignToProjectBridge();
      } catch (err) {
        console.error('Error loading projects:', err);
        listEl.innerHTML = '<div class="empty-state"><h3>Error loading projects</h3><p>' + (err.message || 'Please try again') + '</p></div>';
      }
    }

    // Bridge: Detect design-to-project handoff from room designer
    function checkDesignToProjectBridge() {
      var designData = sessionStorage.getItem('sg_design_for_project');
      if (!designData || !window.location.hash.includes('from_design')) return;
      sessionStorage.removeItem('sg_design_for_project');

      try {
        var design = JSON.parse(designData);
        setTimeout(function() {
          openNewProjectModal();
          document.getElementById('proj-name').value = design.name || 'Room Design Project';
          document.getElementById('proj-description').value = 'From room designer' + (design.room_type ? ' (' + design.room_type + ')' : '');
          if (design.quote_total) document.getElementById('proj-value').value = design.quote_total;
          document.getElementById('proj-status').value = 'lead';
          showToast('Project form pre-filled from design', 'success');
        }, 400);
      } catch (e) { /* ignore parse errors */ }
    }

    function updateProjectsCount() {
      const badge = document.getElementById('projects-count');
      if (!badge) return;
      const active = allProjects.filter(p => ['approved', 'scheduled', 'in_progress'].includes(p.status)).length;
      badge.textContent = active;
      badge.dataset.count = active;
    }

    function updateProjectStats() {
      const all = allProjects;
      const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
      el('stat-total-projects', all.length);
      el('stat-active-projects', all.filter(p => ['approved', 'scheduled', 'in_progress'].includes(p.status)).length);
      el('stat-completed-projects', all.filter(p => p.status === 'completed').length);
      const pipeline = all.filter(p => !['completed', 'cancelled'].includes(p.status))
        .reduce((sum, p) => sum + (parseFloat(p.value) || 0), 0);
      el('stat-pipeline-value', '$' + pipeline.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }));
    }

    function filterProjects(status) {
      projectFilter = status;
      document.querySelectorAll('[data-proj-status]').forEach(pill => {
        pill.classList.toggle('active', pill.dataset.projStatus === status);
      });
      renderProjectsList();
      renderProjectsKanban();
    }

    function debounceProjectSearch() {
      clearTimeout(projectSearchTimeout);
      projectSearchTimeout = setTimeout(() => {
        projectSearchTerm = (document.getElementById('projects-search')?.value || '').toLowerCase().trim();
        renderProjectsList();
        renderProjectsKanban();
      }, 300);
    }

    function getFilteredProjects() {
      return allProjects.filter(p => {
        if (projectFilter !== 'all' && p.status !== projectFilter) return false;
        if (projectSearchTerm) {
          const term = projectSearchTerm;
          return (p.name || '').toLowerCase().includes(term) ||
                 (p.customer_name || '').toLowerCase().includes(term) ||
                 (p.description || '').toLowerCase().includes(term);
        }
        return true;
      });
    }

    function renderProjectsList() {
      const listEl = document.getElementById('projects-list');
      if (!listEl) return;

      const filtered = getFilteredProjects();

      if (filtered.length === 0) {
        listEl.innerHTML = `<div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
          <h3>${projectFilter !== 'all' ? 'No ' + (PROJECT_STATUS_LABELS[projectFilter] || projectFilter) + ' projects' : 'No projects yet'}</h3>
          <p>${projectFilter !== 'all' ? 'No projects match this filter.' : 'Create your first project to start tracking work.'}</p>
          ${projectFilter === 'all' ? '<button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewProjectModal()">Create First Project</button>' : ''}
        </div>`;
        return;
      }

      listEl.innerHTML = filtered.map(p => {
        const statusColor = PROJECT_STATUS_COLORS[p.status] || '#6b7280';
        const priorityColor = PROJECT_PRIORITY_COLORS[p.priority] || '#6b7280';
        const value = parseFloat(p.value) || 0;
        const progress = p.progress || 0;
        const dateStr = p.created_at ? new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';

        return `<div class="list-item-modern project-list-item" style="display: flex; align-items: center; gap: 16px; padding: 16px; cursor: pointer; border-bottom: 1px solid var(--dark-border); transition: background 0.15s; position: relative;" onclick="openProjectDetail('${p.id}')">
          <div style="width: 42px; height: 42px; border-radius: 10px; background: ${statusColor}20; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${statusColor}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.name)}</span>
              ${p.en_route_status === 'en_route' ? '<span style="font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: #f59e0b20; color: #f59e0b; display: inline-flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>EN ROUTE</span>' : ''}
              ${p.en_route_status === 'arrived' ? '<span style="font-size: 10px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: #22c55e20; color: #22c55e;">ON SITE</span>' : ''}
            </div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">${escapeHtml(p.customer_name || 'No customer')}</div>
            ${p.address ? `<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; display: flex; align-items: center; gap: 4px; cursor: pointer;" onclick="event.stopPropagation(); openInGoogleMaps('${escapeHtml(p.address)}', '${escapeHtml(p.city || '')}', '${escapeHtml(p.state || '')}', '${escapeHtml(p.zip || '')}')"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${escapeHtml(p.address)}${p.city ? ', ' + escapeHtml(p.city) : ''}</div>` : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 12px; flex-shrink: 0;">
            ${progress > 0 ? `<div style="width: 60px; height: 6px; background: var(--dark-border); border-radius: 3px; overflow: hidden;"><div style="width: ${progress}%; height: 100%; background: ${statusColor}; border-radius: 3px;"></div></div>` : ''}
            <span style="font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 6px; background: ${statusColor}20; color: ${statusColor};">${PROJECT_STATUS_LABELS[p.status] || p.status}</span>
            <span style="font-size: 12px; font-weight: 600; padding: 4px 8px; border-radius: 6px; background: ${priorityColor}15; color: ${priorityColor}; text-transform: capitalize;">${p.priority || 'medium'}</span>
            ${value > 0 ? `<span style="font-size: 13px; font-weight: 600; color: var(--gold-primary);">$${value.toLocaleString()}</span>` : ''}
            <span style="font-size: 11px; color: var(--text-muted);">${dateStr}</span>
            <!-- Quick Actions (visible on hover) -->
            <div class="project-quick-actions">
              <button onclick="event.stopPropagation(); quickChangeProjectStatus('${p.id}', '${p.status}')" class="status" title="Change Status">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/></svg>
              </button>
              <button onclick="event.stopPropagation(); scheduleForProject('${p.id}')" class="schedule" title="Schedule">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              </button>
              <button onclick="event.stopPropagation(); quickAddProjectTask('${p.id}')" class="task" title="Add Task">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
              </button>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function renderProjectsKanban() {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed', 'on_hold'];
      const filtered = getFilteredProjects();

      statuses.forEach(status => {
        const cardsEl = document.getElementById(`proj-kanban-cards-${status}`);
        const countEl = document.getElementById(`proj-kanban-count-${status}`);
        if (!cardsEl) return;

        const statusProjects = filtered.filter(p => p.status === status);
        if (countEl) countEl.textContent = statusProjects.length;

        if (statusProjects.length === 0) {
          cardsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">No projects</div>';
          return;
        }

        cardsEl.innerHTML = statusProjects.map(p => {
          const value = parseFloat(p.value) || 0;
          const progress = p.progress || 0;
          const priorityColor = PROJECT_PRIORITY_COLORS[p.priority] || '#6b7280';

          return `<div class="kanban-card" draggable="true" ondragstart="onProjectDragStart(event, '${p.id}')" ondragend="onProjectDragEnd(event)" onclick="openProjectDetail('${p.id}')" style="background: var(--dark-card); border: 1px solid ${p.en_route_status === 'en_route' ? '#f59e0b' : 'var(--dark-border)'}; border-radius: 10px; padding: 14px; cursor: pointer; transition: all 0.15s; ${p.en_route_status === 'en_route' ? 'box-shadow: 0 0 0 1px #f59e0b40;' : ''}">
            ${p.en_route_status === 'en_route' ? '<div style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; margin-bottom: 8px; display: inline-flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>EN ROUTE</div>' : ''}
            ${p.en_route_status === 'arrived' ? '<div style="font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; margin-bottom: 8px; display: inline-flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg>ON SITE</div>' : ''}
            <div style="font-weight: 600; font-size: 13px; color: var(--text-primary); margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(p.name)}</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${escapeHtml(p.customer_name || 'No customer')}</div>
            ${p.address ? `<div style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px; display: flex; align-items: center; gap: 4px;"><svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg><span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(p.address)}${p.city ? ', ' + escapeHtml(p.city) : ''}</span></div>` : '<div style="margin-bottom: 8px;"></div>'}
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
              <span style="font-size: 11px; font-weight: 600; padding: 2px 6px; border-radius: 4px; background: ${priorityColor}15; color: ${priorityColor}; text-transform: capitalize;">${p.priority || 'medium'}</span>
              ${value > 0 ? `<span style="font-size: 12px; font-weight: 600; color: var(--gold-primary);">$${value.toLocaleString()}</span>` : ''}
            </div>
            ${progress > 0 ? `<div style="margin-top: 8px; height: 4px; background: var(--dark-border); border-radius: 2px; overflow: hidden;"><div style="width: ${progress}%; height: 100%; background: var(--gold-primary); border-radius: 2px;"></div></div>` : ''}
            <!-- Kanban Quick Actions -->
            <div class="kanban-quick-actions">
              <button onclick="event.stopPropagation(); scheduleForProject('${p.id}')" class="schedule">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Schedule
              </button>
              <button onclick="event.stopPropagation(); quickAddProjectTask('${p.id}')" class="task">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Task
              </button>
            </div>
          </div>`;
        }).join('');
      });
    }

    // Kanban Drag-and-Drop
    var draggedProjectId = null;

    function onProjectDragStart(event, projectId) {
      draggedProjectId = projectId;
      event.dataTransfer.effectAllowed = 'move';
      event.target.style.opacity = '0.5';
      document.querySelectorAll('.kanban-column').forEach(function(col) {
        col.style.outline = '2px dashed rgba(212,175,55,0.3)';
      });
    }

    function onProjectDragOver(event) {
      event.preventDefault();
      event.dataTransfer.dropEffect = 'move';
      event.currentTarget.style.outline = '2px solid var(--gold-primary)';
    }

    function onProjectDragLeave(event) {
      event.currentTarget.style.outline = '2px dashed rgba(212,175,55,0.3)';
    }

    function onProjectDrop(event, newStatus) {
      event.preventDefault();
      document.querySelectorAll('.kanban-column').forEach(function(col) {
        col.style.outline = '';
      });
      if (!draggedProjectId) return;

      var project = allProjects.find(function(p) { return p.id === draggedProjectId; });
      if (!project || project.status === newStatus) {
        draggedProjectId = null;
        return;
      }

      quickUpdateProjectStatus(draggedProjectId, newStatus);
      draggedProjectId = null;
    }

    function onProjectDragEnd(event) {
      event.target.style.opacity = '';
      document.querySelectorAll('.kanban-column').forEach(function(col) {
        col.style.outline = '';
      });
      draggedProjectId = null;
    }

    function setProjectsView(view) {
      currentProjectsView = view;
      const listView = document.getElementById('projects-list-view');
      const boardView = document.getElementById('projects-board-view');
      const listBtn = document.getElementById('projectsListBtn');
      const boardBtn = document.getElementById('projectsBoardBtn');

      if (view === 'list') {
        if (listView) listView.style.display = '';
        if (boardView) boardView.style.display = 'none';
        if (listBtn) { listBtn.style.background = 'var(--gold-primary)'; listBtn.style.color = 'var(--dark-primary)'; }
        if (boardBtn) { boardBtn.style.background = 'transparent'; boardBtn.style.color = 'var(--text-secondary)'; }
      } else {
        if (listView) listView.style.display = 'none';
        if (boardView) boardView.style.display = '';
        if (listBtn) { listBtn.style.background = 'transparent'; listBtn.style.color = 'var(--text-secondary)'; }
        if (boardBtn) { boardBtn.style.background = 'var(--gold-primary)'; boardBtn.style.color = 'var(--dark-primary)'; }
      }
    }

    // Project source data caches
    let projectLeadsCache = [];
    let projectCustomersCache = [];
    let currentProjectSource = 'manual';

    function openNewProjectModal() {
      document.getElementById('project-modal-title').textContent = 'New Project';
      document.getElementById('project-edit-id').value = '';
      document.getElementById('proj-lead-id').value = '';
      document.getElementById('proj-customer-id').value = '';
      document.getElementById('project-form').reset();
      document.getElementById('proj-status').value = 'lead';
      document.getElementById('proj-priority').value = 'medium';

      // Show source selector for new projects
      document.getElementById('project-source-selector').style.display = '';
      selectProjectSource('manual');

      document.getElementById('project-modal').classList.add('active');

      // Pre-load leads and customers for quick selection
      loadLeadsForProjectSelect();
      loadCustomersForProjectSelect();
    }

    function selectProjectSource(source) {
      currentProjectSource = source;

      // Update tab styles
      ['manual', 'lead', 'customer'].forEach(s => {
        const tab = document.getElementById('source-tab-' + s);
        if (tab) {
          if (s === source) {
            tab.style.background = 'var(--gold-primary)';
            tab.style.borderColor = 'var(--gold-primary)';
            tab.style.color = 'var(--dark-primary)';
          } else {
            tab.style.background = 'transparent';
            tab.style.borderColor = 'var(--border-color)';
            tab.style.color = 'var(--text-primary)';
          }
        }
      });

      // Show/hide selectors
      document.getElementById('lead-selector-container').style.display = source === 'lead' ? '' : 'none';
      document.getElementById('customer-selector-container').style.display = source === 'customer' ? '' : 'none';

      // Clear search inputs
      if (source !== 'lead') {
        document.getElementById('lead-search-input').value = '';
        document.getElementById('proj-lead-id').value = '';
      }
      if (source !== 'customer') {
        document.getElementById('customer-search-input').value = '';
      }
    }

    async function loadLeadsForProjectSelect() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: leads, error } = await supabaseClient
          .from('leads')
          .select('id, name, email, phone, address, city, state, zip, status, service_type, notes')
          .eq('user_id', user.id)
          .not('status', 'eq', 'converted')
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;
        projectLeadsCache = leads || [];
        renderLeadDropdown(projectLeadsCache);
      } catch (err) {
        console.error('Error loading leads:', err);
      }
    }

    function renderLeadDropdown(leads) {
      const dropdown = document.getElementById('lead-dropdown');
      if (!dropdown) return;

      if (leads.length === 0) {
        dropdown.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">No leads found</div>';
        return;
      }

      dropdown.innerHTML = leads.map(lead => {
        const statusColor = lead.status === 'new' ? '#10b981' : lead.status === 'contacted' ? '#3b82f6' : '#f59e0b';
        return '<div class="dropdown-item" onclick="selectLeadForProject(\'' + lead.id + '\')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
          '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(lead.name) + '</div>' +
          '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">' + escapeHtml(lead.email || 'No email') + (lead.phone ? ' • ' + escapeHtml(lead.phone) : '') + '</div>' +
          '<div style="display: flex; gap: 8px; margin-top: 4px;">' +
            '<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: ' + statusColor + '22; color: ' + statusColor + '; text-transform: uppercase;">' + lead.status + '</span>' +
            (lead.service_type ? '<span style="font-size: 10px; padding: 2px 6px; border-radius: 4px; background: var(--dark-tertiary); color: var(--text-secondary);">' + escapeHtml(lead.service_type) + '</span>' : '') +
          '</div>' +
        '</div>';
      }).join('');
    }

    function filterLeadsForProject(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderLeadDropdown(projectLeadsCache);
        return;
      }
      const filtered = projectLeadsCache.filter(lead =>
        (lead.name && lead.name.toLowerCase().includes(q)) ||
        (lead.email && lead.email.toLowerCase().includes(q)) ||
        (lead.phone && lead.phone.includes(q))
      );
      renderLeadDropdown(filtered);
    }

    function showLeadDropdown() {
      document.getElementById('lead-dropdown').style.display = '';
      document.getElementById('customer-dropdown').style.display = 'none';
    }

    function selectLeadForProject(leadId) {
      const lead = projectLeadsCache.find(l => l.id === leadId);
      if (!lead) return;

      // Populate form from lead
      document.getElementById('proj-lead-id').value = leadId;
      document.getElementById('lead-search-input').value = lead.name;
      document.getElementById('lead-dropdown').style.display = 'none';

      // Auto-fill project fields
      document.getElementById('proj-name').value = (lead.service_type ? lead.service_type + ' - ' : '') + lead.name;
      document.getElementById('proj-customer-name').value = lead.name || '';
      document.getElementById('proj-customer-email').value = lead.email || '';
      document.getElementById('proj-customer-phone').value = lead.phone || '';
      document.getElementById('proj-address').value = lead.address || '';
      document.getElementById('proj-city').value = lead.city || '';
      document.getElementById('proj-state').value = lead.state || '';
      document.getElementById('proj-zip').value = lead.zip || '';
      if (lead.notes) {
        document.getElementById('proj-notes').value = 'From lead: ' + lead.notes;
      }

      showToast('Lead data loaded', 'success');
    }

    async function loadCustomersForProjectSelect() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state, zip, notes, lead_id')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(100);

        if (error) throw error;
        projectCustomersCache = customers || [];
        renderCustomerDropdown(projectCustomersCache);
      } catch (err) {
        console.error('Error loading customers:', err);
      }
    }

    function renderCustomerDropdown(customers) {
      const dropdown = document.getElementById('customer-dropdown');
      if (!dropdown) return;

      if (customers.length === 0) {
        dropdown.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">No customers found</div>';
        return;
      }

      dropdown.innerHTML = customers.map(customer => {
        return '<div class="dropdown-item" onclick="selectCustomerForProject(\'' + customer.id + '\')" style="padding: 12px 16px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.2s;" onmouseover="this.style.background=\'var(--dark-tertiary)\'" onmouseout="this.style.background=\'transparent\'">' +
          '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(customer.name) + '</div>' +
          '<div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">' + escapeHtml(customer.email || 'No email') + (customer.phone ? ' • ' + escapeHtml(customer.phone) : '') + '</div>' +
          (customer.address ? '<div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">' + escapeHtml(customer.address) + '</div>' : '') +
        '</div>';
      }).join('');
    }

    function filterCustomersForProject(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderCustomerDropdown(projectCustomersCache);
        return;
      }
      const filtered = projectCustomersCache.filter(customer =>
        (customer.name && customer.name.toLowerCase().includes(q)) ||
        (customer.email && customer.email.toLowerCase().includes(q)) ||
        (customer.phone && customer.phone.includes(q))
      );
      renderCustomerDropdown(filtered);
    }

    function showCustomerDropdown() {
      document.getElementById('customer-dropdown').style.display = '';
      document.getElementById('lead-dropdown').style.display = 'none';
    }

    function selectCustomerForProject(customerId) {
      const customer = projectCustomersCache.find(c => c.id === customerId);
      if (!customer) return;

      // Populate form from customer
      document.getElementById('proj-customer-id').value = customerId;
      document.getElementById('proj-lead-id').value = customer.lead_id || '';
      document.getElementById('customer-search-input').value = customer.name;
      document.getElementById('customer-dropdown').style.display = 'none';

      // Auto-fill project fields
      document.getElementById('proj-name').value = 'Project - ' + customer.name;
      document.getElementById('proj-customer-name').value = customer.name || '';
      document.getElementById('proj-customer-email').value = customer.email || '';
      document.getElementById('proj-customer-phone').value = customer.phone || '';
      document.getElementById('proj-address').value = customer.address || '';
      document.getElementById('proj-city').value = customer.city || '';
      document.getElementById('proj-state').value = customer.state || '';
      document.getElementById('proj-zip').value = customer.zip || '';
      if (customer.notes) {
        document.getElementById('proj-notes').value = 'From customer: ' + customer.notes;
      }

      showToast('Customer data loaded', 'success');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#lead-selector-container')) {
        const leadDropdown = document.getElementById('lead-dropdown');
        if (leadDropdown) leadDropdown.style.display = 'none';
      }
      if (!e.target.closest('#customer-selector-container')) {
        const customerDropdown = document.getElementById('customer-dropdown');
        if (customerDropdown) customerDropdown.style.display = 'none';
      }
    });

    function openEditProjectModal(project) {
      document.getElementById('project-modal-title').textContent = 'Edit Project';
      document.getElementById('project-edit-id').value = project.id;
      document.getElementById('proj-lead-id').value = project.lead_id || '';
      document.getElementById('proj-customer-id').value = project.customer_id || '';
      document.getElementById('proj-name').value = project.name || '';
      document.getElementById('proj-description').value = project.description || '';
      document.getElementById('proj-status').value = project.status || 'lead';
      document.getElementById('proj-priority').value = project.priority || 'medium';
      document.getElementById('proj-customer-name').value = project.customer_name || '';
      document.getElementById('proj-customer-email').value = project.customer_email || '';
      document.getElementById('proj-customer-phone').value = project.customer_phone || '';
      document.getElementById('proj-address').value = project.address || '';
      document.getElementById('proj-city').value = project.city || '';
      document.getElementById('proj-state').value = project.state || '';
      document.getElementById('proj-zip').value = project.zip || '';
      document.getElementById('proj-value').value = project.value || '';
      document.getElementById('proj-cost').value = project.cost || '';
      document.getElementById('proj-start-date').value = project.start_date ? project.start_date.split('T')[0] : '';
      document.getElementById('proj-end-date').value = project.end_date ? project.end_date.split('T')[0] : '';
      document.getElementById('proj-duration').value = project.estimated_duration || '';
      document.getElementById('proj-notes').value = project.notes || '';
      document.getElementById('proj-customer-notes').value = project.customer_notes || '';

      // Hide source selector when editing existing projects
      document.getElementById('project-source-selector').style.display = 'none';

      document.getElementById('project-modal').classList.add('active');
    }

    function closeProjectModal() {
      document.getElementById('project-modal').classList.remove('active');
    }

    async function saveProject(event) {
      event.preventDefault();

      const editId = document.getElementById('project-edit-id').value;
      const isEdit = !!editId;

      const leadId = document.getElementById('proj-lead-id').value.trim() || null;
      const customerId = document.getElementById('proj-customer-id').value.trim() || null;

      const projectData = {
        name: document.getElementById('proj-name').value.trim(),
        description: document.getElementById('proj-description').value.trim() || null,
        status: document.getElementById('proj-status').value,
        priority: document.getElementById('proj-priority').value,
        lead_id: leadId,
        customer_id: customerId,
        customer_name: document.getElementById('proj-customer-name').value.trim(),
        customer_email: document.getElementById('proj-customer-email').value.trim() || null,
        customer_phone: document.getElementById('proj-customer-phone').value.trim() || null,
        address: document.getElementById('proj-address').value.trim() || null,
        city: document.getElementById('proj-city').value.trim() || null,
        state: document.getElementById('proj-state').value.trim() || null,
        zip: document.getElementById('proj-zip').value.trim() || null,
        value: parseFloat(document.getElementById('proj-value').value) || 0,
        cost: parseFloat(document.getElementById('proj-cost').value) || 0,
        start_date: document.getElementById('proj-start-date').value || null,
        end_date: document.getElementById('proj-end-date').value || null,
        estimated_duration: parseInt(document.getElementById('proj-duration').value) || null,
        notes: document.getElementById('proj-notes').value.trim() || null,
        customer_notes: document.getElementById('proj-customer-notes').value.trim() || null
      };

      const btn = document.getElementById('save-project-btn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner" style="width: 18px; height: 18px; margin: 0 auto;"></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        let result;
        if (isEdit) {
          result = await supabaseClient
            .from('projects')
            .update(projectData)
            .eq('id', editId)
            .eq('user_id', user.id)
            .select()
            .single();
        } else {
          result = await supabaseClient
            .from('projects')
            .insert({ ...projectData, user_id: user.id })
            .select()
            .single();
        }

        if (result.error) throw result.error;

        closeProjectModal();
        showToast(isEdit ? 'Project updated' : 'Project created', 'success');
        await loadProjects();

        const project = result.data;

        // If created from a lead, update lead status to 'converted' and auto-create customer
        if (!isEdit && leadId) {
          try {
            // Update lead status to converted
            await supabaseClient
              .from('leads')
              .update({ status: 'converted', converted_at: new Date().toISOString() })
              .eq('id', leadId)
              .eq('user_id', user.id);
            console.log('Lead marked as converted:', leadId);

            // Auto-create customer if not already linked
            if (!customerId && projectData.customer_name) {
              // Check if customer with this email already exists
              let existingCustomer = null;
              if (projectData.customer_email) {
                const { data: existing } = await supabaseClient
                  .from('customers')
                  .select('id')
                  .eq('user_id', user.id)
                  .eq('email', projectData.customer_email)
                  .limit(1);
                existingCustomer = existing?.[0];
              }

              if (existingCustomer) {
                // Link existing customer to project
                await supabaseClient
                  .from('projects')
                  .update({ customer_id: existingCustomer.id })
                  .eq('id', project.id);
                console.log('Linked existing customer to project:', existingCustomer.id);
              } else {
                // Create new customer from project data
                const { data: newCustomer, error: custErr } = await supabaseClient
                  .from('customers')
                  .insert({
                    user_id: user.id,
                    lead_id: leadId,
                    name: projectData.customer_name,
                    email: projectData.customer_email,
                    phone: projectData.customer_phone,
                    address: projectData.address,
                    city: projectData.city,
                    state: projectData.state,
                    zip: projectData.zip
                  })
                  .select()
                  .single();

                if (!custErr && newCustomer) {
                  // Link new customer to project
                  await supabaseClient
                    .from('projects')
                    .update({ customer_id: newCustomer.id })
                    .eq('id', project.id);
                  console.log('Auto-created customer from lead:', newCustomer.id);
                }
              }
            }
          } catch (convErr) {
            console.warn('Could not convert lead:', convErr.message);
          }
        }

        // Auto-create calendar event if project has start_date and status is scheduled/in_progress
        if (project && project.start_date && ['scheduled', 'in_progress'].includes(project.status)) {
          try {
            // Check if calendar event already exists for this project
            const { data: existingEvent } = await supabaseClient
              .from('calendar_events')
              .select('id')
              .eq('project_id', project.id)
              .limit(1);

            if (!existingEvent || existingEvent.length === 0) {
              // Create calendar event for project start
              const startDate = new Date(project.start_date + 'T09:00:00');
              const endDate = new Date(startDate.getTime() + 4 * 60 * 60 * 1000); // 4 hours

              await supabaseClient
                .from('calendar_events')
                .insert([{
                  created_by: user.id,
                  title: 'Project: ' + project.name,
                  description: 'Customer: ' + project.customer_name + '\nPhone: ' + (project.customer_phone || 'N/A') + '\nEmail: ' + (project.customer_email || 'N/A') + '\nAddress: ' + (project.address || 'N/A'),
                  event_type: project.status === 'scheduled' ? 'measurement' : 'installation',
                  start_time: startDate.toISOString(),
                  end_time: endDate.toISOString(),
                  location: project.address,
                  location_address: [project.address, project.city, project.state, project.zip].filter(Boolean).join(', '),
                  project_id: project.id,
                  status: 'scheduled',
                  color: '#10b981'
                }]);

              console.log('Calendar event auto-created for project', project.id);
            }
          } catch (calErr) {
            console.warn('Could not auto-create calendar event:', calErr.message);
          }
        }

        // If detail modal is open, refresh it
        if (currentProjectId && isEdit) {
          openProjectDetail(currentProjectId);
        }
      } catch (err) {
        console.error('Error saving project:', err);
        showToast('Error: ' + (err.message || 'Failed to save project'), 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Project';
      }
    }

    async function openProjectDetail(projectId) {
      currentProjectId = projectId;
      const modal = document.getElementById('project-detail-modal');
      const body = document.getElementById('project-detail-body');
      modal.classList.add('active');
      body.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        const { data: project, error } = await supabaseClient
          .from('projects')
          .select('*')
          .eq('id', projectId)
          .single();

        if (error || !project) throw error || new Error('Project not found');

        // Fetch related data in parallel (some tables may not exist yet)
        const [tasksResult, activityResult, contractorsResult, estimatesResult, invoicesResult] = await Promise.all([
          supabaseClient.from('project_tasks').select('*').eq('project_id', projectId).order('sort_order', { ascending: true }).then(r => r).catch(() => ({ data: [] })),
          supabaseClient.from('project_activity').select('*').eq('project_id', projectId).order('created_at', { ascending: false }).limit(20).then(r => r).catch(() => ({ data: [] })),
          supabaseClient.from('project_contractors').select('*').eq('project_id', projectId).then(r => r).catch(() => ({ data: [] })),
          project.customer_email ? supabaseClient.from('estimates').select('id, estimate_number, status, total, created_at').eq('user_id', user.id).eq('customer_email', project.customer_email).order('created_at', { ascending: false }).limit(5) : Promise.resolve({ data: [] }),
          project.customer_email ? supabaseClient.from('invoices').select('id, invoice_number, status, total, created_at').eq('user_id', user.id).eq('customer_email', project.customer_email).order('created_at', { ascending: false }).limit(5) : Promise.resolve({ data: [] })
        ]);

        const tasks = tasksResult.data || [];
        const activity = activityResult.data || [];
        const collaborators = contractorsResult.data || [];
        const linkedEstimates = estimatesResult.data || [];
        const linkedInvoices = invoicesResult.data || [];

        document.getElementById('project-detail-title').textContent = project.name;

        const statusColor = PROJECT_STATUS_COLORS[project.status] || '#6b7280';
        const priorityColor = PROJECT_PRIORITY_COLORS[project.priority] || '#6b7280';
        const value = parseFloat(project.value) || 0;
        const cost = parseFloat(project.cost) || 0;
        const profit = value - cost;
        const progress = project.progress || 0;

        body.innerHTML = `
          <!-- Workflow Status Bar -->
          ${renderWorkflowStatusBar(project)}

          <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
            <span style="font-size: 13px; font-weight: 600; padding: 6px 14px; border-radius: 8px; background: ${statusColor}20; color: ${statusColor};">${PROJECT_STATUS_LABELS[project.status] || project.status}</span>
            <span style="font-size: 13px; font-weight: 600; padding: 6px 14px; border-radius: 8px; background: ${priorityColor}15; color: ${priorityColor}; text-transform: capitalize;">${project.priority || 'medium'} priority</span>
            <select onchange="quickUpdateProjectStatus('${project.id}', this.value)" style="font-size: 12px; padding: 6px 10px; border-radius: 8px; border: 1px solid var(--dark-border); background: var(--dark-elevated); color: var(--text-primary); cursor: pointer;">
              <option value="" disabled selected>Change Status...</option>
              ${Object.entries(PROJECT_STATUS_LABELS).map(([k, v]) => `<option value="${k}" ${project.status === k ? 'disabled' : ''}>${v}</option>`).join('')}
            </select>
          </div>

          <!-- Progress Bar -->
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
              <span>Progress</span><span>${progress}%</span>
            </div>
            <div style="height: 8px; background: var(--dark-border); border-radius: 4px; overflow: hidden;">
              <div style="width: ${progress}%; height: 100%; background: ${progress >= 100 ? '#22c55e' : 'var(--gold-primary)'}; border-radius: 4px; transition: width 0.3s;"></div>
            </div>
          </div>

          <!-- Task Checklist -->
          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="none" stroke="var(--gold-primary)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Tasks</span>
                <span style="font-size: 11px; color: var(--text-muted);">(${tasks.filter(t => t.status === 'completed').length}/${tasks.length})</span>
              </div>
              <div style="display: flex; gap: 6px;">
                <button onclick="showAddTaskTemplates('${project.id}')" class="btn-modern ghost" style="font-size: 11px; padding: 4px 8px;" title="Add from template">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
                </button>
                <button onclick="addProjectTask('${project.id}')" class="btn-modern primary" style="font-size: 11px; padding: 4px 10px;">+ Add Task</button>
              </div>
            </div>
            <div id="project-tasks-list" data-project-id="${project.id}">
              ${tasks.length > 0 ? tasks.map(task => renderProjectTaskItem(task)).join('') : '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">No tasks yet. Add tasks to track progress.</div>'}
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
            <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Customer</div>
              <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(project.customer_name || 'N/A')}</div>
              ${project.customer_email ? `<a href="mailto:${escapeHtml(project.customer_email)}" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; display: block; text-decoration: none;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${escapeHtml(project.customer_email)}</a>` : ''}
              ${project.customer_phone ? `<a href="tel:${escapeHtml(project.customer_phone)}" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px; display: block; text-decoration: none;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${escapeHtml(project.customer_phone)}</a>` : ''}
              ${project.address ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                  <a href="${getNavigationUrl(project.address, project.city, project.state, project.zip)}" target="_blank" style="font-size: 12px; color: #3b82f6; text-decoration: none; display: flex; align-items: flex-start; gap: 6px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    <span>${escapeHtml(project.address)}${project.city ? ', ' + escapeHtml(project.city) : ''}${project.state ? ', ' + escapeHtml(project.state) : ''} ${escapeHtml(project.zip || '')}</span>
                  </a>
                  <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button onclick="openInGoogleMaps('${escapeHtml(project.address)}', '${escapeHtml(project.city || '')}', '${escapeHtml(project.state || '')}', '${escapeHtml(project.zip || '')}')" class="btn-modern ghost" style="font-size: 11px; padding: 6px 10px; flex: 1;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/></svg>
                      Directions
                    </button>
                    <button onclick="shareEnRouteStatus('${project.id}', '${escapeHtml(project.customer_name || '')}', '${escapeHtml(project.address || '')}', '${escapeHtml(project.city || '')}', '${escapeHtml(project.state || '')}', '${escapeHtml(project.zip || '')}')" class="btn-modern primary" style="font-size: 11px; padding: 6px 10px; flex: 1;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                      En Route
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>
            <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Financials</div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Value</span>
                <span style="font-weight: 600; color: var(--gold-primary);">$${value.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Cost</span>
                <span style="font-weight: 600; color: var(--error-color);">$${cost.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; border-top: 1px solid var(--dark-border); padding-top: 4px; margin-top: 4px;">
                <span style="font-size: 12px; color: var(--text-secondary);">Profit</span>
                <span style="font-weight: 600; color: ${profit >= 0 ? '#22c55e' : '#ef4444'};">$${profit.toLocaleString()}</span>
              </div>
            </div>
          </div>

          ${project.start_date || project.end_date ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Schedule</div>
            <div style="display: flex; gap: 24px; flex-wrap: wrap;">
              ${project.start_date ? `<div><span style="font-size: 12px; color: var(--text-secondary);">Start: </span><span style="font-weight: 600; color: var(--text-primary);">${new Date(project.start_date).toLocaleDateString()}</span></div>` : ''}
              ${project.end_date ? `<div><span style="font-size: 12px; color: var(--text-secondary);">End: </span><span style="font-weight: 600; color: var(--text-primary);">${new Date(project.end_date).toLocaleDateString()}</span></div>` : ''}
              ${project.estimated_duration ? `<div><span style="font-size: 12px; color: var(--text-secondary);">Duration: </span><span style="font-weight: 600; color: var(--text-primary);">${project.estimated_duration} days</span></div>` : ''}
            </div>
          </div>` : ''}

          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Estimates & Invoices</div>
              <button class="btn-modern primary small" onclick="createEstimateFromProject('${project.id}')" style="font-size: 11px; padding: 4px 10px;">+ Estimate</button>
            </div>
            ${linkedEstimates.length > 0 ? linkedEstimates.map(function(est) {
              var estColor = est.status === 'approved' ? '#22c55e' : est.status === 'sent' ? '#3b82f6' : est.status === 'draft' ? '#6b7280' : '#f59e0b';
              return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">' +
                '<div><span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">#' + escapeHtml(est.estimate_number || 'Draft') + '</span>' +
                '<span style="font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; background: ' + estColor + '20; color: ' + estColor + ';">' + escapeHtml(est.status || 'draft') + '</span></div>' +
                '<span style="font-weight: 600; color: var(--gold-primary);">$' + (est.total || 0).toLocaleString() + '</span></div>';
            }).join('') : '<div style="font-size: 12px; color: var(--text-muted); padding: 8px 0;">No linked estimates</div>'}
            ${linkedInvoices.length > 0 ? '<div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid var(--dark-border);">' +
              '<div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Invoices</div>' +
              linkedInvoices.map(function(inv) {
                var invColor = inv.status === 'paid' ? '#22c55e' : inv.status === 'open' ? '#3b82f6' : '#6b7280';
                return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">' +
                  '<div><span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">#' + escapeHtml(inv.invoice_number || 'Draft') + '</span>' +
                  '<span style="font-size: 12px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; background: ' + invColor + '20; color: ' + invColor + ';">' + escapeHtml(inv.status || 'draft') + '</span></div>' +
                  '<span style="font-weight: 600; color: var(--gold-primary);">$' + (inv.total || 0).toLocaleString() + '</span></div>';
              }).join('') + '</div>' : ''}
          </div>

          ${project.description ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Description</div>
            <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">${escapeHtml(project.description)}</div>
          </div>` : ''}

          ${project.scope_of_work ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px; border-left: 3px solid var(--gold-primary);">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Scope of Work</div>
            <div style="font-size: 13px; color: var(--text-primary); line-height: 1.6; white-space: pre-wrap;">${escapeHtml(project.scope_of_work)}</div>
          </div>` : ''}

          ${project.notes ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Internal Notes</div>
            <div style="font-size: 13px; color: var(--text-primary); line-height: 1.5;">${escapeHtml(project.notes)}</div>
          </div>` : ''}

          <!-- Team Members (Quick-Assign from Network) -->
          <div id="project-team-section" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Team Members</div>
              <button class="btn-modern primary" style="font-size: 11px; padding: 4px 10px;" onclick="openQuickAssignModal('${project.id}')">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -2px; margin-right: 2px;"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                Assign
              </button>
            </div>
            <div id="project-team-list" data-project-id="${project.id}" style="min-height: 40px;">
              <div style="text-align: center; padding: 8px; color: var(--text-muted); font-size: 12px;">Loading team...</div>
            </div>
          </div>

          ${collaborators.length > 0 ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">External Collaborators (${collaborators.length})</div>
              <button class="btn-modern secondary" style="font-size: 11px; padding: 4px 10px;" onclick="closeProjectDetail(); openInviteToProjectModal('${project.id}');">+ Invite</button>
            </div>
            ${collaborators.map(c => `<div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--gold-primary); color: var(--dark-primary); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">${(c.collaborator_name || c.collaborator_email || '?').charAt(0).toUpperCase()}</div>
              <div style="flex: 1;">
                <div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">${escapeHtml(c.collaborator_name || c.collaborator_email || 'Unknown')}</div>
                <div style="font-size: 11px; color: var(--text-secondary);">${c.role || 'Member'} - ${c.invitation_status || 'pending'}</div>
              </div>
            </div>`).join('')}
          </div>` : ''}

          <div id="project-handoffs-section" data-project-id="${project.id}" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Design Handoffs</div>
              <button class="btn-modern secondary" style="font-size: 11px; padding: 4px 10px; color: #22c55e;" onclick="closeProjectDetail(); openStartHandoffModal(null, '', '${project.id}');">+ New Handoff</button>
            </div>
            <div id="project-handoffs-list" style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 8px;">Loading handoffs...</div>
          </div>

          <div id="project-collab-listings" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Collaborator Marketplace</div>
              <a href="/remnants/" target="_blank" class="btn-modern secondary" style="font-size: 11px; padding: 4px 10px;">Browse All</a>
            </div>
            <div id="project-collab-listings-content" style="font-size: 12px; color: var(--text-muted); text-align: center; padding: 8px;">Loading listings...</div>
          </div>

          <!-- Comments Feed -->
          <div id="project-comments-section" style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="16" height="16" fill="none" stroke="var(--gold-primary)" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Comments</span>
              </div>
            </div>
            <div id="project-comments-list" data-project-id="${project.id}" style="max-height: 300px; overflow-y: auto; margin-bottom: 12px;">
              <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">Loading comments...</div>
            </div>
            <form onsubmit="addProjectComment('${project.id}', this); return false;" style="display: flex; gap: 8px;">
              <input type="text" name="comment" placeholder="Add a comment..." required
                     style="flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--dark-border); background: var(--dark-surface); color: var(--text-primary); font-size: 13px;">
              <button type="submit" class="btn-modern primary" style="padding: 10px 16px;">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
              </button>
            </form>
          </div>

          ${activity.filter(a => a.action !== 'comment').length > 0 ? `<div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 20px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Recent Activity</div>
            ${activity.filter(a => a.action !== 'comment').slice(0, 10).map(a => `<div style="display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--dark-border);">
              <div style="width: 6px; height: 6px; border-radius: 50%; background: var(--gold-primary); margin-top: 6px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="font-size: 12px; color: var(--text-primary);">${escapeHtml(a.description || a.action || 'Activity')}</div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">${a.created_at ? new Date(a.created_at).toLocaleString() : ''}</div>
              </div>
            </div>`).join('')}
          </div>` : ''}

          <div style="display: flex; gap: 12px; margin-top: 20px;">
            <button class="btn-modern secondary" onclick="scheduleForProject('${project.id}')" style="flex: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              Schedule
            </button>
            <button class="btn-modern primary" onclick="editCurrentProject()" style="flex: 1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
              Edit
            </button>
            <button class="btn-modern secondary" onclick="deleteProject('${project.id}')" style="flex: 1; color: var(--error-color);">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              Delete
            </button>
          </div>
        `;

        // Load team members, design handoffs, comments and collaborator listings for this project
        loadProjectTeam(projectId);
        loadProjectHandoffs(projectId);
        loadProjectComments(projectId);
        loadCollaboratorListings(projectId);

      } catch (err) {
        console.error('Error loading project detail:', err);
        body.innerHTML = '<div class="empty-state"><h3>Error loading project</h3><p>' + (err.message || 'Please try again') + '</p></div>';
      }
    }

    function closeProjectDetail() {
      document.getElementById('project-detail-modal').classList.remove('active');
      currentProjectId = null;
    }

    // =============================================
    // PROJECT TASK CHECKLIST
    // =============================================

    // Task templates for quick setup
    const PROJECT_TASK_TEMPLATES = {
      kitchen: [
        { title: 'Initial consultation', sort_order: 1 },
        { title: 'Measure completed', sort_order: 2 },
        { title: 'Material selected', sort_order: 3 },
        { title: 'Estimate approved', sort_order: 4 },
        { title: 'Deposit received', sort_order: 5 },
        { title: 'Material ordered', sort_order: 6 },
        { title: 'Material received', sort_order: 7 },
        { title: 'Template created', sort_order: 8 },
        { title: 'Fabrication complete', sort_order: 9 },
        { title: 'Installation scheduled', sort_order: 10 },
        { title: 'Installation complete', sort_order: 11 },
        { title: 'Final walkthrough', sort_order: 12 }
      ],
      bathroom: [
        { title: 'Initial consultation', sort_order: 1 },
        { title: 'Measure completed', sort_order: 2 },
        { title: 'Material selected', sort_order: 3 },
        { title: 'Estimate approved', sort_order: 4 },
        { title: 'Deposit received', sort_order: 5 },
        { title: 'Material ordered', sort_order: 6 },
        { title: 'Installation scheduled', sort_order: 7 },
        { title: 'Installation complete', sort_order: 8 },
        { title: 'Final inspection', sort_order: 9 }
      ],
      simple: [
        { title: 'Contact customer', sort_order: 1 },
        { title: 'Schedule appointment', sort_order: 2 },
        { title: 'Create estimate', sort_order: 3 },
        { title: 'Get approval', sort_order: 4 },
        { title: 'Complete work', sort_order: 5 },
        { title: 'Collect payment', sort_order: 6 }
      ]
    };

    function renderProjectTaskItem(task) {
      const isCompleted = task.status === 'completed';
      const checkboxStyle = isCompleted
        ? 'background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-color: #22c55e;'
        : 'background: transparent; border-color: var(--border-light);';

      return `
        <div class="task-item" data-task-id="${task.id}" style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); ${isCompleted ? 'opacity: 0.6;' : ''}">
          <button onclick="toggleProjectTask('${task.id}', ${!isCompleted})"
                  style="width: 22px; height: 22px; border-radius: 6px; border: 2px solid; ${checkboxStyle} cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0;">
            ${isCompleted ? '<svg width="14" height="14" fill="none" stroke="#fff" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' : ''}
          </button>
          <span style="flex: 1; font-size: 14px; color: var(--text-primary); ${isCompleted ? 'text-decoration: line-through;' : ''}">${escapeHtml(task.title)}</span>
          ${task.assigned_to ? `<span style="font-size: 11px; color: var(--text-muted); background: var(--dark-surface); padding: 2px 8px; border-radius: 4px;">${escapeHtml(task.assigned_to)}</span>` : ''}
          <button onclick="deleteProjectTask('${task.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'; this.style.color='#ef4444'" onmouseout="this.style.opacity='0.5'; this.style.color='var(--text-muted)'">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
          </button>
        </div>
      `;
    }

    async function toggleProjectTask(taskId, completed) {
      try {
        const newStatus = completed ? 'completed' : 'pending';
        const completedAt = completed ? new Date().toISOString() : null;

        const { error } = await supabaseClient
          .from('project_tasks')
          .update({ status: newStatus, completed_at: completedAt })
          .eq('id', taskId);

        if (error) throw error;

        // Refresh project detail to show updated progress
        if (currentProjectId) {
          openProjectDetail(currentProjectId);
        }
        showToast(completed ? 'Task completed!' : 'Task reopened', 'success');
      } catch (err) {
        console.error('Error toggling task:', err);
        showToast('Failed to update task', 'error');
      }
    }

    async function addProjectTask(projectId, title) {
      if (!title) {
        title = prompt('Enter task name:');
        if (!title || !title.trim()) return;
      }

      try {
        // Get current max sort_order
        const { data: existingTasks } = await supabaseClient
          .from('project_tasks')
          .select('sort_order')
          .eq('project_id', projectId)
          .order('sort_order', { ascending: false })
          .limit(1);

        const sortOrder = (existingTasks && existingTasks[0]?.sort_order || 0) + 1;

        const { error } = await supabaseClient
          .from('project_tasks')
          .insert({
            project_id: projectId,
            title: title.trim(),
            status: 'pending',
            sort_order: sortOrder
          });

        if (error) throw error;

        // Refresh project detail
        openProjectDetail(projectId);
        showToast('Task added', 'success');
      } catch (err) {
        console.error('Error adding task:', err);
        showToast('Failed to add task', 'error');
      }
    }

    async function deleteProjectTask(taskId) {
      if (!confirm('Delete this task?')) return;

      try {
        const { error } = await supabaseClient
          .from('project_tasks')
          .delete()
          .eq('id', taskId);

        if (error) throw error;

        // Refresh project detail
        if (currentProjectId) {
          openProjectDetail(currentProjectId);
        }
        showToast('Task deleted', 'success');
      } catch (err) {
        console.error('Error deleting task:', err);
        showToast('Failed to delete task', 'error');
      }
    }

    function showAddTaskTemplates(projectId) {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'task-templates-modal';
      modal.onclick = function(e) { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 420px;">
          <div class="modal-header">
            <h2 class="modal-title">Add Task Template</h2>
            <button class="modal-close" onclick="document.getElementById('task-templates-modal').remove()">&times;</button>
          </div>
          <div class="modal-body" style="padding: 20px;">
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 13px;">Choose a template to quickly add common tasks:</p>

            <div onclick="applyTaskTemplate('${projectId}', 'kitchen')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--gold-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Kitchen Remodel</div>
                <div style="font-size: 12px; color: var(--text-muted);">12 tasks: consultation to walkthrough</div>
              </div>
            </div>

            <div onclick="applyTaskTemplate('${projectId}', 'bathroom')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--gold-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Bathroom Project</div>
                <div style="font-size: 12px; color: var(--text-muted);">9 tasks: consultation to inspection</div>
              </div>
            </div>

            <div onclick="applyTaskTemplate('${projectId}', 'simple')" style="display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 10px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--gold-primary)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                <svg width="20" height="20" fill="none" stroke="#fff" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">Simple Project</div>
                <div style="font-size: 12px; color: var(--text-muted);">6 tasks: contact to payment</div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function applyTaskTemplate(projectId, templateKey) {
      const template = PROJECT_TASK_TEMPLATES[templateKey];
      if (!template) return;

      document.getElementById('task-templates-modal')?.remove();

      try {
        // Get current max sort_order
        const { data: existingTasks } = await supabaseClient
          .from('project_tasks')
          .select('sort_order')
          .eq('project_id', projectId)
          .order('sort_order', { ascending: false })
          .limit(1);

        const startOrder = (existingTasks && existingTasks[0]?.sort_order || 0) + 1;

        // Insert all template tasks
        const tasks = template.map((t, i) => ({
          project_id: projectId,
          title: t.title,
          status: 'pending',
          sort_order: startOrder + i
        }));

        const { error } = await supabaseClient
          .from('project_tasks')
          .insert(tasks);

        if (error) throw error;

        // Refresh project detail
        openProjectDetail(projectId);
        showToast(`Added ${template.length} tasks from template`, 'success');
      } catch (err) {
        console.error('Error applying template:', err);
        showToast('Failed to apply template', 'error');
      }
    }

    // =============================================
    // PROJECT COMMENTS FEED
    // =============================================

    async function loadProjectComments(projectId) {
      const list = document.getElementById('project-comments-list');
      if (!list || list.dataset.projectId !== projectId) return;

      try {
        const { data: comments, error } = await supabaseClient
          .from('project_activity')
          .select('*')
          .eq('project_id', projectId)
          .eq('action', 'comment')
          .order('created_at', { ascending: true });

        if (error) throw error;

        if (!comments || comments.length === 0) {
          list.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">
              <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="margin-bottom: 8px; opacity: 0.5;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
              <p style="font-size: 13px; margin: 0;">No comments yet. Start the conversation!</p>
            </div>
          `;
          return;
        }

        list.innerHTML = comments.map(comment => renderProjectComment(comment)).join('');

        // Scroll to bottom
        list.scrollTop = list.scrollHeight;

      } catch (err) {
        console.error('Error loading comments:', err);
        list.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--error-color); font-size: 13px;">Failed to load comments</div>';
      }
    }

    function renderProjectComment(comment) {
      const initial = (comment.user_name || 'U').charAt(0).toUpperCase();
      const timeAgo = getTimeAgo(new Date(comment.created_at));
      const isOwnComment = currentUser && comment.user_id === currentUser.id;

      return `
        <div class="comment-item" style="display: flex; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border-subtle); ${isOwnComment ? 'background: rgba(212, 175, 55, 0.05); margin: 0 -12px; padding-left: 12px; padding-right: 12px; border-radius: 6px;' : ''}">
          <div style="width: 32px; height: 32px; border-radius: 50%; background: ${isOwnComment ? 'var(--gold-primary)' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'}; color: ${isOwnComment ? 'var(--dark-primary)' : '#fff'}; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; flex-shrink: 0;">
            ${initial}
          </div>
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <span style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${escapeHtml(comment.user_name || 'Team Member')}</span>
              <span style="font-size: 11px; color: var(--text-muted);">${timeAgo}</span>
            </div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4; word-wrap: break-word;">${escapeHtml(comment.description || '')}</div>
          </div>
        </div>
      `;
    }

    async function addProjectComment(projectId, form) {
      const input = form.querySelector('input[name="comment"]');
      const commentText = input.value.trim();

      if (!commentText) return;

      // Disable form while submitting
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      input.disabled = true;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get user's display name
        const userName = user.user_metadata?.full_name || user.email?.split('@')[0] || 'User';

        const { error } = await supabaseClient
          .from('project_activity')
          .insert({
            project_id: projectId,
            action: 'comment',
            description: commentText,
            user_id: user.id,
            user_name: userName
          });

        if (error) throw error;

        // Clear input and reload comments
        input.value = '';
        await loadProjectComments(projectId);

      } catch (err) {
        console.error('Error adding comment:', err);
        showToast('Failed to add comment', 'error');
      } finally {
        submitBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    // =============================================
    // QUICK-ASSIGN TEAM MEMBERS TO PROJECT
    // =============================================

    let quickAssignNetworkCache = [];
    let selectedQuickAssignCollaborator = null;

    async function openQuickAssignModal(projectId) {
      const modal = document.getElementById('quick-assign-modal');
      if (!modal) return;

      document.getElementById('quick-assign-project-id').value = projectId;
      selectedQuickAssignCollaborator = null;
      document.getElementById('quick-assign-btn').disabled = true;
      document.getElementById('quick-assign-search').value = '';

      modal.classList.add('active');

      // Load network collaborators
      const listEl = document.getElementById('quick-assign-list');
      listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading network...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load collaborators and already-assigned team members
        const [collabResult, assignedResult] = await Promise.all([
          supabaseClient
            .from('general_collaborators')
            .select('id, name, email, phone, role, company, status')
            .eq('invited_by', user.id)
            .eq('status', 'active')
            .order('name', { ascending: true }),
          supabaseClient
            .from('project_contractors')
            .select('contractor_id')
            .eq('project_id', projectId)
        ]);

        if (collabResult.error) throw collabResult.error;

        const assignedIds = new Set((assignedResult.data || []).map(a => a.contractor_id));
        quickAssignNetworkCache = (collabResult.data || []).map(c => ({
          ...c,
          alreadyAssigned: assignedIds.has(c.id)
        }));

        renderQuickAssignList(quickAssignNetworkCache);

      } catch (err) {
        console.error('Error loading network:', err);
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Failed to load network</div>';
      }
    }

    function renderQuickAssignList(collaborators) {
      const listEl = document.getElementById('quick-assign-list');

      if (!collaborators || collaborators.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No collaborators in your network yet.<br><small>Add collaborators from the Collaborators page.</small></div>';
        return;
      }

      const roleColors = {
        contractor: '#3b82f6',
        fabricator: '#8b5cf6',
        installer: '#f59e0b',
        plumber: '#06b6d4',
        designer: '#ec4899',
        measurer: '#84cc16',
        vendor: '#14b8a6',
        other: '#6b7280'
      };

      listEl.innerHTML = collaborators.map(c => {
        const color = roleColors[c.role] || roleColors.other;
        const isSelected = selectedQuickAssignCollaborator === c.id;

        return '<div class="quick-assign-item' + (isSelected ? ' selected' : '') + '" data-id="' + c.id + '" onclick="' + (c.alreadyAssigned ? '' : 'selectQuickAssignCollaborator(\'' + c.id + '\')') + '" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: ' + (c.alreadyAssigned ? 'not-allowed' : 'pointer') + '; background: ' + (isSelected ? 'var(--gold-primary)11' : 'transparent') + '; ' + (c.alreadyAssigned ? 'opacity: 0.5;' : '') + ' transition: background 0.2s;">' +
          '<div style="width: 36px; height: 36px; border-radius: 50%; background: ' + color + '22; color: ' + color + '; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">' + (c.name || '?').charAt(0).toUpperCase() + '</div>' +
          '<div style="flex: 1; min-width: 0;">' +
            '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(c.name) + (c.alreadyAssigned ? ' <span style="font-size: 10px; color: var(--success); background: #22c55e22; padding: 2px 6px; border-radius: 4px;">Assigned</span>' : '') + '</div>' +
            '<div style="font-size: 12px; color: var(--text-secondary);">' + (c.company ? escapeHtml(c.company) + ' • ' : '') + escapeHtml(c.email || 'No email') + '</div>' +
          '</div>' +
          '<span style="font-size: 11px; padding: 3px 8px; border-radius: 12px; background: ' + color + '22; color: ' + color + '; text-transform: uppercase;">' + (c.role || 'other') + '</span>' +
        '</div>';
      }).join('');
    }

    function filterQuickAssignList(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderQuickAssignList(quickAssignNetworkCache);
        return;
      }
      const filtered = quickAssignNetworkCache.filter(c =>
        (c.name && c.name.toLowerCase().includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q)) ||
        (c.role && c.role.toLowerCase().includes(q)) ||
        (c.company && c.company.toLowerCase().includes(q))
      );
      renderQuickAssignList(filtered);
    }

    function selectQuickAssignCollaborator(id) {
      selectedQuickAssignCollaborator = id;
      document.getElementById('quick-assign-btn').disabled = false;
      filterQuickAssignList(document.getElementById('quick-assign-search').value);
    }

    async function confirmQuickAssign() {
      const projectId = document.getElementById('quick-assign-project-id').value;
      const collaboratorId = selectedQuickAssignCollaborator;
      const role = document.querySelector('input[name="quick-assign-role"]:checked')?.value || 'contractor';

      if (!projectId || !collaboratorId) {
        showToast('Please select a collaborator', 'warning');
        return;
      }

      const btn = document.getElementById('quick-assign-btn');
      btn.disabled = true;
      btn.textContent = 'Assigning...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Insert into project_contractors
        const { error } = await supabaseClient
          .from('project_contractors')
          .insert({
            project_id: projectId,
            contractor_id: collaboratorId,
            user_id: user.id,
            role: role,
            status: 'assigned'
          });

        if (error) throw error;

        showToast('Team member assigned successfully', 'success');
        closeQuickAssignModal();

        // Reload project team if detail is open
        loadProjectTeam(projectId);

      } catch (err) {
        console.error('Error assigning collaborator:', err);
        showToast(err.message || 'Failed to assign team member', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Assign Selected';
      }
    }

    function closeQuickAssignModal() {
      const modal = document.getElementById('quick-assign-modal');
      if (modal) modal.classList.remove('active');
    }

    // Load project team members
    async function loadProjectTeam(projectId) {
      const listEl = document.getElementById('project-team-list');
      if (!listEl) return;

      try {
        // Get project contractors
        const { data: contractors, error } = await supabaseClient
          .from('project_contractors')
          .select('id, role, status, contractor_id')
          .eq('project_id', projectId);

        if (error) throw error;

        if (!contractors || contractors.length === 0) {
          listEl.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">No team members assigned yet<br><small>Click "Assign" to add from your network</small></div>';
          return;
        }

        // Get collaborator details separately
        const contractorIds = contractors.map(c => c.contractor_id).filter(Boolean);
        let collaboratorMap = {};

        if (contractorIds.length > 0) {
          const { data: collaborators } = await supabaseClient
            .from('general_collaborators')
            .select('id, name, email, phone, role, company')
            .in('id', contractorIds);

          (collaborators || []).forEach(c => { collaboratorMap[c.id] = c; });
        }

        const roleColors = {
          contractor: '#3b82f6',
          fabricator: '#8b5cf6',
          installer: '#f59e0b',
          plumber: '#06b6d4',
          designer: '#ec4899',
          measurer: '#84cc16',
          other: '#6b7280'
        };

        listEl.innerHTML = contractors.map(pc => {
          const c = collaboratorMap[pc.contractor_id];
          if (!c) return '';
          const color = roleColors[pc.role] || roleColors.other;

          return '<div style="display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--dark-border);">' +
            '<div style="width: 36px; height: 36px; border-radius: 50%; background: ' + color + '22; color: ' + color + '; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px;">' + (c.name || '?').charAt(0).toUpperCase() + '</div>' +
            '<div style="flex: 1; min-width: 0;">' +
              '<div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">' + escapeHtml(c.name || 'Unknown') + '</div>' +
              '<div style="font-size: 11px; color: var(--text-secondary);">' + (c.company ? escapeHtml(c.company) + ' • ' : '') + (c.email || c.phone || '') + '</div>' +
            '</div>' +
            '<span style="font-size: 10px; padding: 3px 8px; border-radius: 10px; background: ' + color + '22; color: ' + color + '; text-transform: uppercase;">' + (pc.role || c.role || 'team') + '</span>' +
            '<button onclick="removeProjectTeamMember(\'' + pc.id + '\', \'' + projectId + '\')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;" title="Remove from team">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
            '</button>' +
          '</div>';
        }).join('');

      } catch (err) {
        console.error('Error loading project team:', err);
        listEl.innerHTML = '<div style="text-align: center; padding: 8px; color: var(--error); font-size: 12px;">Failed to load team</div>';
      }
    }

    async function removeProjectTeamMember(contractorRecordId, projectId) {
      if (!confirm('Remove this team member from the project?')) return;

      try {
        const { error } = await supabaseClient
          .from('project_contractors')
          .delete()
          .eq('id', contractorRecordId);

        if (error) throw error;

        showToast('Team member removed', 'success');
        loadProjectTeam(projectId);

      } catch (err) {
        console.error('Error removing team member:', err);
        showToast('Failed to remove team member', 'error');
      }
    }

    function editCurrentProject() {
      const project = allProjects.find(p => p.id === currentProjectId);
      if (project) {
        closeProjectDetail();
        openEditProjectModal(project);
      }
    }

    async function quickUpdateProjectStatus(id, status) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { error } = await supabaseClient
          .from('projects')
          .update({ status })
          .eq('id', id)
          .eq('user_id', user.id);

        if (error) throw error;

        showToast('Status updated to ' + (PROJECT_STATUS_LABELS[status] || status), 'success');
        await loadProjects();

        // Refresh detail if open
        if (currentProjectId === id) {
          openProjectDetail(id);
        }
      } catch (err) {
        console.error('Error updating status:', err);
        showToast('Error: ' + (err.message || 'Failed to update status'), 'error');
      }
    }

    async function deleteProject(projectId) {
      if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { error } = await supabaseClient
          .from('projects')
          .delete()
          .eq('id', projectId)
          .eq('user_id', user.id);

        if (error) throw error;

        closeProjectDetail();
        showToast('Project deleted', 'success');
        await loadProjects();
      } catch (err) {
        console.error('Error deleting project:', err);
        showToast('Error: ' + (err.message || 'Failed to delete project'), 'error');
      }
    }

    // =============================================
    // JOBS & PROJECT MANAGEMENT
    // =============================================

    let allJobs = [];
    let allCollaborators = [];
    // allCustomers already declared above
    let currentJobId = null;
    let jobFilter = 'all';
    let contractorFilter = 'all';

    async function loadJobs() {
      const jobsList = document.getElementById('jobs-list');
      if (!jobsList) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        jobsList.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        // Load from PROJECTS table (single source of truth)
        const { data: jobs, error } = await supabaseClient
          .from('projects')
          .select(`
            *,
            project_contractors (
              id, contractor_id, role, agreed_rate, status,
              contractors:contractor_id (id, name, email, phone)
            )
          `)
          .eq('user_id', user.id)
          .order('created_at', { ascending: false });

        if (error) throw error;

        allJobs = jobs || [];
        updateJobsCount();
        updateJobStats();
        renderJobs();
        renderKanbanBoard();
      } catch (err) {
        console.error('Load jobs error:', err);
        jobsList.innerHTML = `<div class="empty-state"><p>Error loading jobs: ${escapeHtml(err.message || 'Unknown error')}</p></div>`;
      }
    }

    function updateJobsCount() {
      const badge = document.getElementById('jobs-count');
      if (badge) {
        const activeJobs = allJobs.filter(j => !['completed', 'cancelled'].includes(j.status)).length;
        badge.textContent = activeJobs;
        badge.dataset.count = activeJobs;
      }
    }

    function filterJobs(status) {
      jobFilter = status;
      document.querySelectorAll('[data-job-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.jobStatus === status);
      });
      renderJobs();
      renderKanbanBoard();
    }

    let currentJobsView = 'list';

    function setJobsView(view) {
      currentJobsView = view;
      const listView = document.getElementById('jobs-list-view');
      const kanbanView = document.getElementById('jobs-kanban-view');
      const listBtn = document.getElementById('jobsListBtn');
      const kanbanBtn = document.getElementById('jobsKanbanBtn');

      if (view === 'list') {
        listView.style.display = 'block';
        kanbanView.style.display = 'none';
        listBtn.style.background = 'var(--gold-primary)';
        listBtn.style.color = 'var(--dark-primary)';
        kanbanBtn.style.background = 'transparent';
        kanbanBtn.style.color = 'var(--text-secondary)';
      } else {
        listView.style.display = 'none';
        kanbanView.style.display = 'block';
        kanbanBtn.style.background = 'var(--gold-primary)';
        kanbanBtn.style.color = 'var(--dark-primary)';
        listBtn.style.background = 'transparent';
        listBtn.style.color = 'var(--text-secondary)';
        renderKanbanBoard();
      }
    }

    function renderKanbanBoard() {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed'];

      // Map existing statuses to kanban columns
      const statusMapping = {
        'new': 'lead',
        'reviewing': 'lead',
        'lead': 'lead',
        'approved': 'approved',
        'assigned': 'approved',
        'scheduled': 'scheduled',
        'measured': 'scheduled',
        'material_ordered': 'in_progress',
        'material_received': 'in_progress',
        'in_production': 'in_progress',
        'ready': 'in_progress',
        'installing': 'in_progress',
        'completed': 'completed',
        'on_hold': 'lead',
        'cancelled': 'completed'
      };

      // Clear all columns
      statuses.forEach(status => {
        const container = document.getElementById(`kanban-cards-${status}`);
        if (container) container.innerHTML = '';
      });

      // Group jobs by kanban status
      const grouped = { lead: [], approved: [], scheduled: [], in_progress: [], completed: [] };

      allJobs.forEach(job => {
        const kanbanStatus = statusMapping[job.status] || 'lead';
        grouped[kanbanStatus].push(job);
      });

      // Render cards and update counts
      statuses.forEach(status => {
        const container = document.getElementById(`kanban-cards-${status}`);
        const countEl = document.getElementById(`kanban-count-${status}`);

        if (countEl) countEl.textContent = grouped[status].length;

        if (container) {
          if (grouped[status].length === 0) {
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 13px;">No jobs</div>';
          } else {
            container.innerHTML = grouped[status].map(job => `
              <div class="kanban-card" onclick="openJobDetail('${job.id}')" style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 14px; cursor: pointer; transition: all 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <span style="font-weight: 600; font-size: 13px;">#${job.job_number || job.id.slice(0,8)}</span>
                  <span style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-muted);">${job.status?.replace('_', ' ') || 'new'}</span>
                </div>
                <div style="font-size: 14px; font-weight: 500; margin-bottom: 6px;">${job.customers?.name || job.customer_name || 'Unknown'}</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${job.description || job.project_type || 'No description'}</div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid var(--border-subtle);">
                  <span style="font-size: 13px; font-weight: 600; color: var(--gold-primary);">$${(job.total || job.contract_amount || 0).toLocaleString()}</span>
                  <span style="font-size: 11px; color: var(--text-muted);">${job.created_at ? new Date(job.created_at).toLocaleDateString() : ''}</span>
                </div>
              </div>
            `).join('');
          }
        }
      });

      // Update job stats
      updateJobStats();
    }

    function updateJobStats() {
      const activeJobs = allJobs.filter(j => !['completed', 'cancelled'].includes(j.status)).length;
      const totalRevenue = allJobs.reduce((sum, j) => sum + (j.total || j.contract_amount || 0), 0);
      const totalCosts = allJobs.reduce((sum, j) => sum + (j.total_cost || 0), 0);
      const netProfit = totalRevenue - totalCosts;

      const statActive = document.getElementById('stat-active-jobs');
      const statRevenue = document.getElementById('stat-jobs-revenue');
      const statCosts = document.getElementById('stat-total-costs');
      const statProfit = document.getElementById('stat-net-profit');

      if (statActive) statActive.textContent = activeJobs;
      if (statRevenue) statRevenue.textContent = '$' + totalRevenue.toLocaleString();
      if (statCosts) statCosts.textContent = '$' + totalCosts.toLocaleString();
      if (statProfit) statProfit.textContent = '$' + netProfit.toLocaleString();
    }

    function renderJobs() {
      const jobsList = document.getElementById('jobs-list');
      if (!jobsList) return;

      let filtered = allJobs;
      if (jobFilter !== 'all') {
        filtered = filtered.filter(job => job.status === jobFilter);
      }

      if (filtered.length === 0) {
        jobsList.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
            <h3>${jobFilter !== 'all' ? 'No ' + jobFilter.replace('_', ' ') + ' jobs' : 'No jobs yet'}</h3>
            <p>Jobs are created automatically when invoices are paid.</p>
          </div>`;
        return;
      }

      const statusColors = {
        new: '#f59e0b',
        reviewing: '#f59e0b',
        material_ordered: '#06b6d4',
        material_received: '#06b6d4',
        assigned: '#3b82f6',
        scheduled: '#3b82f6',
        measured: '#8b5cf6',
        in_production: '#8b5cf6',
        ready: '#10b981',
        installing: '#10b981',
        completed: '#22c55e',
        on_hold: '#6b7280',
        cancelled: '#ef4444'
      };

      // Modern card-based list for better mobile experience
      jobsList.innerHTML = `
        <div class="list-modern">
          ${filtered.map(job => `
            <div class="list-item-modern"
                 data-context-menu="job"
                 data-item-id="${job.id}"
                 data-item-data='${JSON.stringify({ job_number: job.job_number, status: job.status, customer_name: job.customers?.name }).replace(/'/g, "&#39;")}'
                 onclick="openJobDetail('${job.id}')">
              <div class="list-item-icon" style="background: ${statusColors[job.status] || '#6b7280'}15;">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="${statusColors[job.status] || '#6b7280'}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              </div>
              <div class="list-item-content">
                <div class="list-item-title">${job.job_number || 'New Job'} · ${job.customers?.name || 'Unknown'}</div>
                <div class="list-item-subtitle">${job.description || 'No description'}</div>
              </div>
              <div class="list-item-meta">
                <div class="list-item-amount">$${(job.contract_amount || 0).toLocaleString()}</div>
                <span class="badge-modern badge-${job.status || 'new'}">${(job.status || 'new').replace('_', ' ')}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function openNewJobModal(customer = null) {
      document.getElementById('new-job-modal').classList.add('active');
      document.getElementById('new-job-form').reset();
      document.getElementById('new-customer-fields').style.display = 'none';
      loadCustomersForSelect().then(() => {
        // Pre-select customer if provided
        if (customer) {
          const select = document.getElementById('job-customer-select');
          if (select && customer.id) {
            select.value = customer.id;
            // Also pre-fill address fields from customer
            const addressField = document.getElementById('job-address');
            const cityField = document.getElementById('job-city');
            const stateField = document.getElementById('job-state');
            const zipField = document.getElementById('job-zip');
            if (addressField && customer.address) addressField.value = customer.address;
            if (cityField && customer.city) cityField.value = customer.city;
            if (stateField && customer.state) stateField.value = customer.state;
            if (zipField && customer.zip) zipField.value = customer.zip;
          }
        }
      });
    }

    function closeNewJobModal() {
      document.getElementById('new-job-modal').classList.remove('active');
    }

    function toggleNewCustomerFields() {
      const select = document.getElementById('job-customer-select');
      const fields = document.getElementById('new-customer-fields');
      fields.style.display = select.value === 'new' ? 'block' : 'none';
    }

    async function loadCustomersForSelect() {
      const select = document.getElementById('job-customer-select');
      if (!select) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state, zip')
          .eq('user_id', user.id)
          .order('name');

        allCustomers = customers || [];

        // Keep first two options and rebuild
        select.innerHTML = `
          <option value="">-- Select Customer --</option>
          <option value="new">+ Add New Customer</option>
          ${(customers || []).map(c => `<option value="${c.id}">${c.name}${c.email ? ' (' + c.email + ')' : ''}</option>`).join('')}
        `;
      } catch (err) {
        console.error('Load customers error:', err);
      }
    }

    async function createJob(event) {
      event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        let customerId = document.getElementById('job-customer-select').value;
        let customerName = '';
        let customerEmail = '';
        let customerPhone = '';
        let customerAddress = '';

        // Create new customer if needed
        if (customerId === 'new') {
          customerName = document.getElementById('job-customer-name').value.trim();
          customerEmail = document.getElementById('job-customer-email').value.trim() || null;
          customerPhone = document.getElementById('job-customer-phone').value.trim() || null;
          const addr = document.getElementById('job-customer-address').value.trim() || '';
          const city = document.getElementById('job-customer-city').value.trim() || '';
          const state = document.getElementById('job-customer-state').value.trim() || '';
          const zip = document.getElementById('job-customer-zip').value.trim() || '';
          customerAddress = [addr, city, state, zip].filter(Boolean).join(', ');

          if (!customerName) throw new Error('Customer name is required');

          const customerData = {
            user_id: user.id,
            name: customerName,
            email: customerEmail,
            phone: customerPhone,
            address: addr || null,
            city: city || null,
            state: state || null,
            zip: zip || null
          };

          const { data: newCustomer, error: custError } = await supabaseClient
            .from('customers')
            .insert([customerData])
            .select()
            .single();

          if (custError) throw custError;
          customerId = newCustomer.id;
        } else {
          // Get existing customer info
          const customer = allCustomers.find(c => c.id === customerId);
          if (customer) {
            customerName = customer.name || '';
            customerEmail = customer.email || '';
            customerPhone = customer.phone || '';
            customerAddress = [customer.address, customer.city, customer.state, customer.zip].filter(Boolean).join(', ');
          }
        }

        if (!customerId) throw new Error('Please select or create a customer');
        if (!customerName) throw new Error('Customer name is required');

        // Get next job number (fallback if RPC not available)
        let jobNumber = null;
        try {
          const { data } = await supabaseClient.rpc('get_next_job_number', { p_user_id: user.id });
          jobNumber = data;
        } catch { /* RPC may not exist yet */ }

        const scheduledDate = document.getElementById('job-scheduled-date').value || null;
        const depositAmount = parseFloat(document.getElementById('job-deposit').value) || 0;

        const jobData = {
          user_id: user.id,
          customer_id: customerId,
          customer_name: customerName,
          customer_email: customerEmail,
          customer_phone: customerPhone,
          customer_address: customerAddress,
          job_number: jobNumber || `JOB-${Date.now()}`,
          description: document.getElementById('job-title').value.trim(),
          project_type: document.getElementById('job-type').value,
          contract_amount: parseFloat(document.getElementById('job-total').value) || 0,
          deposit_amount: depositAmount,
          deposit_paid: depositAmount > 0,
          internal_notes: document.getElementById('job-notes').value.trim() || null,
          estimated_start_date: scheduledDate,
          status: scheduledDate ? 'scheduled' : 'new'
        };

        const { error } = await supabaseClient.from('projects').insert([jobData]);
        if (error) throw error;

        closeNewJobModal();
        showToast('Job created successfully!');
        loadJobs();
      } catch (err) {
        console.error('Create job error:', err);
        alert('Error creating job: ' + err.message);
      }
    }

    async function openJobDetail(jobId) {
      currentJobId = jobId;
      const modal = document.getElementById('job-detail-modal');
      modal.classList.add('active');

      // Find job in allJobs
      const job = allJobs.find(j => j.id === jobId);
      if (!job) {
        alert('Job not found');
        return;
      }

      // Populate job details
      document.getElementById('job-detail-number').textContent = job.job_number || 'N/A';
      document.getElementById('job-detail-status').value = job.status || 'new';
      document.getElementById('job-detail-type').textContent = (job.project_type || 'N/A').replace('_', ' ');
      document.getElementById('job-detail-priority').textContent = job.description || '-';
      document.getElementById('job-detail-total').textContent = '$' + (job.contract_amount || 0).toFixed(2);
      document.getElementById('job-detail-balance').textContent = '$' + ((job.contract_amount || 0) - (job.total_paid || 0)).toFixed(2);
      document.getElementById('job-detail-notes').textContent = job.internal_notes || '-';

      // Customer info - use relation if available, otherwise use denormalized fields
      const customerName = job.customers?.name || job.customer_name || 'Unknown';
      const customerEmail = job.customers?.email || job.customer_email || '';
      const customerPhone = job.customers?.phone || job.customer_phone || '';
      const customerAddr = job.customers
        ? [job.customers.address, job.customers.city, job.customers.state, job.customers.zip].filter(Boolean).join(', ')
        : job.customer_address || '';
      document.getElementById('job-customer-name-display').textContent = customerName;
      document.getElementById('job-customer-email-display').textContent = customerEmail;
      document.getElementById('job-customer-phone-display').textContent = customerPhone;
      document.getElementById('job-customer-address-display').textContent = customerAddr;

      // Assigned collaborators
      const collaboratorsList = document.getElementById('job-collaborators-list');
      if (job.project_contractors && job.project_contractors.length > 0) {
        collaboratorsList.innerHTML = job.project_contractors.map(jc => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 8px;">
            <div style="flex: 1; cursor: pointer;" onclick="openContractorProfile('${jc.contractor_id}')">
              <div style="font-weight: 500;">${jc.collaborators?.name || 'Unknown'}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${jc.role || jc.collaborators?.type || ''} - $${(jc.amount_quoted || 0).toFixed(2)}</div>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
              <button class="action-btn" onclick="sendContractorPortalLink('${jc.contractor_id}')" title="Send Portal Link" style="padding: 4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
              </button>
              <button class="action-btn" onclick="inviteJobContractorAsCollaborator('${jc.contractor_id}')" title="Invite as Collaborator" style="padding: 4px; color: var(--gold-primary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
              </button>
              <span class="status-badge" style="font-size: 10px; background: ${jc.contractor_status === 'accepted' ? 'rgba(34,197,94,0.15)' : jc.contractor_status === 'declined' ? 'rgba(239,68,68,0.15)' : 'rgba(245,158,11,0.15)'}; color: ${jc.contractor_status === 'accepted' ? '#22c55e' : jc.contractor_status === 'declined' ? '#ef4444' : '#f59e0b'};">${jc.contractor_status || 'pending'}</span>
            </div>
          </div>
        `).join('');
      } else {
        collaboratorsList.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No collaborators assigned yet.</div>';
      }

      // Populate schedule fields
      const fieldMeasureInput = document.getElementById('job-field-measure-date');
      const installDateInput = document.getElementById('job-install-date');

      if (fieldMeasureInput) {
        fieldMeasureInput.value = job.field_measure_date ? job.field_measure_date.slice(0, 16) : '';
      }
      if (installDateInput) {
        installDateInput.value = job.install_date ? job.install_date.slice(0, 16) : '';
      }

      // Load files
      loadJobFiles(jobId);

      // Load timeline
      loadJobTimeline(jobId);
    }

    function closeJobDetailModal() {
      document.getElementById('job-detail-modal').classList.remove('active');
      currentJobId = null;
    }

    async function updateJobStatus() {
      if (!currentJobId) return;

      const newStatus = document.getElementById('job-detail-status').value;

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', currentJobId);

        if (error) throw error;

        showToast('Status updated');
        loadJobs();
        // Refresh calendar if it's been loaded
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update status error:', err);
        alert('Error updating status: ' + err.message);
      }
    }

    // Update job status by ID (for context menu)
    async function updateJobStatusById(jobId, newStatus) {
      if (!jobId || !newStatus) return;

      try {
        // Get job details first for notification
        const { data: job } = await supabaseClient
          .from('projects')
          .select('*')
          .eq('id', jobId)
          .single();

        const { error } = await supabaseClient
          .from('projects')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', jobId);

        if (error) throw error;

        // Send status update notification (email + SMS)
        if (job && (job.customer_email || job.customer_phone)) {
          sendNotification('job', 'status_change', job, {
            email: job.customer_email,
            phone: job.customer_phone,
            name: job.customer_name
          }, newStatus);
        }

        showToast(`Job status updated to ${newStatus.replace('_', ' ')}`);
        loadJobs();
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update job status error:', err);
        showToast('Error updating status: ' + err.message, 'error');
      }
    }

    // Archive a job
    async function archiveJob(jobId) {
      if (!jobId) return;

      if (!confirm('Archive this job? It will be moved to archived status.')) return;

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update({ status: 'archived', updated_at: new Date().toISOString() })
          .eq('id', jobId);

        if (error) throw error;

        showToast('Job archived');
        loadJobs();
      } catch (err) {
        console.error('Archive job error:', err);
        showToast('Error archiving job: ' + err.message, 'error');
      }
    }

    // Delete a job
    async function deleteJob(jobId) {
      if (!jobId) return;

      if (!confirm('Delete this job? This action cannot be undone.')) return;

      try {
        // First delete related records
        await supabaseClient.from('project_contractors').delete().eq('project_id', jobId);
        await supabaseClient.from('project_files').delete().eq('project_id', jobId);
        await supabaseClient.from('project_activity').delete().eq('project_id', jobId);

        // Then delete the job
        const { error } = await supabaseClient
          .from('projects')
          .delete()
          .eq('id', jobId);

        if (error) throw error;

        showToast('Job deleted');
        loadJobs();
        closeJobDetailModal();
      } catch (err) {
        console.error('Delete job error:', err);
        showToast('Error deleting job: ' + err.message, 'error');
      }
    }

    async function updateJobSchedule(field) {
      if (!currentJobId) return;

      const fieldMeasureInput = document.getElementById('job-field-measure-date');
      const installDateInput = document.getElementById('job-install-date');

      const updateData = {
        updated_at: new Date().toISOString()
      };

      if (field === 'field_measure_date' && fieldMeasureInput) {
        updateData.field_measure_date = fieldMeasureInput.value ? new Date(fieldMeasureInput.value).toISOString() : null;
      }

      if (field === 'install_date' && installDateInput) {
        updateData.install_date = installDateInput.value ? new Date(installDateInput.value).toISOString() : null;
      }

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update(updateData)
          .eq('id', currentJobId);

        if (error) throw error;

        showToast('Schedule updated');
        loadJobs();
        // Refresh calendar to show the new event
        if (typeof loadCalendarEvents === 'function') loadCalendarEvents();
      } catch (err) {
        console.error('Update schedule error:', err);
        alert('Error updating schedule: ' + err.message);
      }
    }

    async function loadJobFiles(jobId) {
      const container = document.getElementById('job-files-list');
      if (!container) return;

      try {
        const { data: files, error } = await supabaseClient
          .from('project_files')
          .select('*')
          .eq('project_id', jobId)
          .order('uploaded_at', { ascending: false });

        if (error) throw error;

        if (!files || files.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No files uploaded yet.<br>
              <span style="font-size: 12px;">Drop files here or click Upload</span>
            </div>`;
          return;
        }

        container.innerHTML = files.map(file => `
          <div style="display: flex; align-items: center; gap: 12px; padding: 8px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 8px;">
            <div style="width: 40px; height: 40px; background: var(--dark-surface); border-radius: 6px; display: flex; align-items: center; justify-content: center;">
              ${file.file_type?.includes('image') ? `<img src="${file.file_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 6px;">` :
                `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 13px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${file.file_name || 'File'}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${file.category || 'Document'} - ${new Date(file.created_at).toLocaleDateString()}</div>
            </div>
            <a href="${file.file_url}" target="_blank" class="action-btn" title="Download">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
            </a>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load files error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Error loading files</div>';
      }
    }

    async function uploadJobFiles(event) {
      if (!currentJobId) return;

      const files = event.target.files;
      if (!files || files.length === 0) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        showToast('Uploading files...', 'info');

        for (const file of files) {
          const fileExt = file.name.split('.').pop();
          const fileName = `jobs/${currentJobId}/${Date.now()}-${file.name}`;

          // Upload to storage
          const { data, error: uploadError } = await supabaseClient.storage
            .from('lead-images')
            .upload(fileName, file);

          if (uploadError) throw uploadError;

          // Get public URL
          const { data: urlData } = supabaseClient.storage
            .from('lead-images')
            .getPublicUrl(fileName);

          // Save file record
          const { error: dbError } = await supabaseClient
            .from('project_files')
            .insert([{
              project_id: currentJobId,
              user_id: user.id,
              file_name: file.name,
              file_url: urlData.publicUrl,
              file_type: file.type,
              file_size: file.size,
              category: file.type.includes('image') ? 'photo' : 'document'
            }]);

          if (dbError) throw dbError;
        }

        showToast('Files uploaded successfully!');
        loadJobFiles(currentJobId);
        event.target.value = '';
      } catch (err) {
        console.error('Upload error:', err);
        alert('Error uploading files: ' + err.message);
      }
    }

    async function loadJobTimeline(jobId) {
      const container = document.getElementById('job-timeline');
      if (!container) return;

      try {
        const { data: history, error } = await supabaseClient
          .from('project_status_history')
          .select('*')
          .eq('project_id', jobId)
          .order('changed_at', { ascending: false })
          .limit(10);

        // Table may not exist yet - silently fail
        if (error) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No activity yet.</div>';
          return;
        }

        if (!history || history.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No activity yet.</div>';
          return;
        }

        container.innerHTML = history.map(h => `
          <div style="display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
            <div style="width: 8px; height: 8px; background: var(--gold-primary); border-radius: 50%; margin-top: 6px;"></div>
            <div>
              <div style="font-size: 13px;">Status changed from <strong>${h.from_status || 'new'}</strong> to <strong>${h.to_status}</strong></div>
              <div style="font-size: 11px; color: var(--text-muted);">${new Date(h.changed_at).toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load timeline error:', err);
      }
    }

    async function sendCustomerPortalLink() {
      if (!currentJobId) return;

      const job = allJobs.find(j => j.id === currentJobId);
      if (!job || !job.customer_id) {
        alert('No customer associated with this job');
        return;
      }

      try {
        // Get or create customer portal token
        const { data: customer, error: fetchError } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, portal_token')
          .eq('id', job.customer_id)
          .single();

        if (fetchError) throw fetchError;
        if (!customer) throw new Error('Customer not found');

        let token = customer.portal_token;
        if (!token) {
          // Generate new token
          token = btoa(customer.id + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);

          const { error: updateError } = await supabaseClient
            .from('customers')
            .update({ portal_token: token })
            .eq('id', customer.id);

          if (updateError) throw updateError;
        }

        const portalUrl = `${window.location.origin}/customer-portal/?token=${token}`;

        // Show options modal
        const action = prompt(
          `Customer Portal Link for ${customer.name}:\n\n${portalUrl}\n\nOptions:\n1. Copy link (type "copy")\n2. Email link (type "email")\n3. Text link (type "text")\n4. Invite as collaborator (type "collab")`,
          'copy'
        );

        if (action === 'copy') {
          navigator.clipboard.writeText(portalUrl);
          showToast('Portal link copied to clipboard!');
        } else if (action === 'email' && customer.email) {
          try {
            await apiCall('/api/customers/send-portal-link', {
              method: 'POST',
              body: JSON.stringify({
                customer_id: customer.id,
                email: customer.email,
                portal_link: portalUrl,
                job_number: job.job_number
              })
            });
            showToast('Portal link sent via email!');
          } catch (err) {
            navigator.clipboard.writeText(portalUrl);
            showToast('Could not send email. Link copied instead.');
          }
        } else if (action === 'text' && customer.phone) {
          const message = encodeURIComponent(`Track your project with Surprise Granite: ${portalUrl}`);
          window.open(`sms:${customer.phone}?body=${message}`, '_blank');
        } else if (action === 'collab') {
          inviteCustomerAsCollaborator();
        } else if (action) {
          navigator.clipboard.writeText(portalUrl);
          showToast('Link copied to clipboard!');
        }

      } catch (err) {
        console.error('Send portal link error:', err);
        alert('Error generating portal link: ' + err.message);
      }
    }

    async function sendContractorPortalLink(contractorId) {
      try {
        // Get or create contractor portal token
        const { data: contractor, error: fetchError } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, company, email, phone, token_hash')
          .eq('id', contractorId)
          .single();

        if (fetchError) throw fetchError;
        if (!contractor) throw new Error('Contractor not found');

        let token = contractor.token_hash;
        if (!token) {
          token = btoa(contractor.id + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);

          const { error: updateError } = await supabaseClient
            .from('general_collaborators')
            .update({ token_hash: token })
            .eq('id', contractor.id);

          if (updateError) throw updateError;
        }

        const portalUrl = `${window.location.origin}/contractor-portal/?token=${token}`;

        const action = prompt(
          `Contractor Portal Link for ${contractor.company || contractor.name}:\n\n${portalUrl}\n\nOptions:\n1. Copy link (type "copy")\n2. Email link (type "email")\n3. Text link (type "text")\n4. Invite as collaborator (type "collab")`,
          'copy'
        );

        if (action === 'copy') {
          navigator.clipboard.writeText(portalUrl);
          showToast('Portal link copied!');
        } else if (action === 'email' && contractor.email) {
          try {
            await apiCall('/api/collaborators/send-invite', {
              method: 'POST',
              body: JSON.stringify({
                contractor_id: contractor.id,
                email: contractor.email,
                invite_link: portalUrl
              })
            });
            showToast('Portal link sent via email!');
          } catch (err) {
            navigator.clipboard.writeText(portalUrl);
            showToast('Could not send email. Link copied instead.');
          }
        } else if (action === 'text' && contractor.phone) {
          const message = encodeURIComponent(`Access your contractor portal at Surprise Granite: ${portalUrl}`);
          window.open(`sms:${contractor.phone}?body=${message}`, '_blank');
        } else if (action === 'collab') {
          inviteContractorAsCollaborator(contractorId);
        } else if (action) {
          navigator.clipboard.writeText(portalUrl);
          showToast('Link copied!');
        }

      } catch (err) {
        console.error('Send contractor portal link error:', err);
        alert('Error generating portal link: ' + err.message);
      }
    }

    // =============================================
    // COLLABORATION INVITATIONS
    // =============================================

    async function checkForInviteToken() {
      const params = new URLSearchParams(window.location.search);
      const token = params.get('accept_invite');
      if (!token) return;

      // Clean URL
      const cleanUrl = new URL(window.location);
      cleanUrl.searchParams.delete('accept_invite');
      history.replaceState(null, '', cleanUrl.toString());

      // Show modal
      document.getElementById('accept-invite-modal').classList.add('active');
      const body = document.getElementById('accept-invite-body');

      try {
        const verifyResp = await fetch(API_BASE + '/api/collaboration/invite/verify/' + encodeURIComponent(token));
        const verifyData = await verifyResp.json();

        if (!verifyResp.ok || !verifyData.success) {
          body.innerHTML =
            '<div style="text-align: center; padding: 20px 0;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="var(--error)" stroke-width="1.5" style="margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>' +
              '<h3 style="margin-bottom: 8px; color: var(--error);">Invitation Invalid or Expired</h3>' +
              '<p style="color: var(--text-muted); font-size: 14px;">' + escapeHtml(verifyData.error || 'This invitation link is no longer valid.') + '</p>' +
              '<button class="btn-modern secondary" onclick="closeAcceptInviteModal()" style="margin-top: 16px;">Close</button>' +
            '</div>';
          return;
        }

        const inv = verifyData.invitation;
        const roleLabel = inv.role.charAt(0).toUpperCase() + inv.role.slice(1);
        const accessLabel = (inv.access_level || 'read').charAt(0).toUpperCase() + (inv.access_level || 'read').slice(1);

        body.innerHTML =
          '<div style="text-align: center; padding: 12px 0;">' +
            '<div style="width: 64px; height: 64px; background: rgba(249, 203, 0, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; font-size: 28px;">&#x1F91D;</div>' +
            '<h3 style="margin-bottom: 4px;">You\'re invited to collaborate</h3>' +
            '<p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">on <strong style="color: var(--text-primary);">"' + escapeHtmlAttr(inv.projectTitle || 'Untitled Project') + '"</strong></p>' +
          '</div>' +
          '<div style="background: var(--dark-surface); border-radius: 10px; padding: 16px; margin-bottom: 20px;">' +
            '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
              '<span style="color: var(--text-muted); font-size: 13px;">Role</span>' +
              '<span style="font-weight: 600; font-size: 13px;">' + roleLabel + '</span>' +
            '</div>' +
            '<div style="display: flex; justify-content: space-between; margin-bottom: 8px;">' +
              '<span style="color: var(--text-muted); font-size: 13px;">Access</span>' +
              '<span style="font-weight: 600; font-size: 13px;">' + accessLabel + '</span>' +
            '</div>' +
            '<div style="display: flex; justify-content: space-between;">' +
              '<span style="color: var(--text-muted); font-size: 13px;">Invited by</span>' +
              '<span style="font-weight: 600; font-size: 13px;">' + escapeHtmlAttr(inv.inviterName || 'Unknown') + '</span>' +
            '</div>' +
          '</div>' +
          '<div style="display: flex; gap: 12px;">' +
            '<button class="btn-modern secondary" onclick="closeAcceptInviteModal()" style="flex: 1;">Decline</button>' +
            '<button class="btn-modern primary" onclick="acceptInvitation(\'' + token + '\')" id="accept-invite-btn" style="flex: 1;">Accept Invitation</button>' +
          '</div>';

      } catch (err) {
        body.innerHTML =
          '<div style="text-align: center; padding: 20px 0;">' +
            '<p style="color: var(--error);">Failed to load invitation details. Please try again.</p>' +
            '<button class="btn-modern secondary" onclick="closeAcceptInviteModal()" style="margin-top: 16px;">Close</button>' +
          '</div>';
        console.error('Accept invite error:', err);
      }
    }

    async function acceptInvitation(token) {
      const btn = document.getElementById('accept-invite-btn');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-top-color: var(--dark-primary);"></div>';
      }

      try {
        const resp = await apiCall('/api/collaboration/invite/accept', {
          method: 'POST',
          body: JSON.stringify({ token: token })
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to accept invitation');

        const body = document.getElementById('accept-invite-body');
        body.innerHTML =
          '<div style="text-align: center; padding: 20px 0;">' +
            '<div style="width: 64px; height: 64px; background: rgba(16, 185, 129, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="var(--success)" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>' +
            '</div>' +
            '<h3 style="color: var(--success); margin-bottom: 8px;">Invitation Accepted!</h3>' +
            '<p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">You\'re now a collaborator on this project.</p>' +
            '<button class="btn-modern primary" onclick="closeAcceptInviteModal(); showPage(\'collaborations\');">View My Collaborations</button>' +
          '</div>';

        showToast('Invitation accepted successfully!');

      } catch (err) {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'Accept Invitation';
        }
        showToast(err.message || 'Failed to accept invitation');
      }
    }

    // Network (general collaborator) invite handling
    async function checkForNetworkInviteToken() {
      const params = new URLSearchParams(window.location.search);
      // Check URL parameter first, then stored token from signup
      let token = params.get('accept_network');
      let fromStorage = false;

      if (!token) {
        token = sessionStorage.getItem('sg_network_invite_token') || localStorage.getItem('sg_network_invite_token');
        fromStorage = true;
      }

      if (!token) return;

      // Clear stored token
      sessionStorage.removeItem('sg_network_invite_token');
      localStorage.removeItem('sg_network_invite_token');

      // Clean URL
      const cleanUrl = new URL(window.location);
      cleanUrl.searchParams.delete('accept_network');
      history.replaceState(null, '', cleanUrl.toString());

      try {
        // Verify the token first
        const verifyResp = await fetch(API_BASE + '/api/collaboration/network/verify/' + encodeURIComponent(token));
        const verifyData = await verifyResp.json();

        if (!verifyResp.ok || !verifyData.success) {
          showToast(verifyData.error || 'Invalid or expired invitation', 'error');
          return;
        }

        // Auto-accept the network invite
        const acceptResp = await apiCall('/api/collaboration/network/accept', {
          method: 'POST',
          body: JSON.stringify({ token })
        });

        const acceptData = await acceptResp.json();
        if (!acceptResp.ok) throw new Error(acceptData.error || 'Failed to accept');

        showToast(`You're now connected with ${verifyData.invitation.inviterName}!`, 'success');
        showPage('collaborators');
        switchCollabTab('network');

      } catch (err) {
        console.error('Network invite accept error:', err);
        showToast(err.message || 'Failed to accept network invitation', 'error');
      }
    }

    function closeAcceptInviteModal() {
      document.getElementById('accept-invite-modal').classList.remove('active');
    }

    function escapeHtmlAttr(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // ============ INVITE TO PROJECT ============

    function openInviteToProjectModal(projectId, prefillEmail, prefillRole) {
      document.getElementById('invite-collaborator-form').reset();
      document.getElementById('invite-project-id').value = projectId || '';

      // Show/hide project selector
      const projectSelector = document.getElementById('invite-project-selector');
      const projectSelect = document.getElementById('invite-project-select');
      if (projectId) {
        projectSelector.style.display = 'none';
        projectSelect.removeAttribute('required');
      } else {
        projectSelector.style.display = 'block';
        projectSelect.setAttribute('required', 'required');
        loadProjectsForInvite();
      }

      // Pre-fill email
      if (prefillEmail) {
        document.getElementById('invite-email').value = prefillEmail;
      }

      // Pre-fill role
      if (prefillRole) {
        const roleSelect = document.getElementById('invite-role');
        for (let i = 0; i < roleSelect.options.length; i++) {
          if (roleSelect.options[i].value === prefillRole) {
            roleSelect.selectedIndex = i;
            break;
          }
        }
      }

      document.getElementById('invite-to-project-modal').classList.add('active');
      if (projectId) loadPendingInvitations(projectId);
    }

    function onInviteProjectSelected() {
      const projectId = document.getElementById('invite-project-select').value;
      const inlineForm = document.getElementById('inline-create-project-form');
      if (projectId === '__create_new__') {
        document.getElementById('invite-project-id').value = '';
        if (inlineForm) inlineForm.style.display = '';
      } else {
        document.getElementById('invite-project-id').value = projectId;
        if (inlineForm) inlineForm.style.display = 'none';
        if (projectId) loadPendingInvitations(projectId);
      }
    }

    async function loadProjectsForInvite() {
      const select = document.getElementById('invite-project-select');
      select.innerHTML = '<option value="">Loading projects...</option>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        let projects = [];

        // Load owned projects from Supabase
        const { data: ownedProjects } = await supabaseClient
          .from('projects')
          .select('id, name')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        if (ownedProjects) {
          projects = ownedProjects.map(p => ({ project_id: p.id, project: { name: p.name } }));
        }

        // Also add jobs as invitable contexts
        if (allJobs && allJobs.length > 0) {
          allJobs.forEach(function(job) {
            projects.push({ project_id: job.id, project: { title: (job.job_number ? '#' + job.job_number + ' - ' : '') + (job.customer_name || job.title || 'Job') }, isJob: true });
          });
        }

        select.innerHTML = '<option value="">Select a Project</option>';
        if (projects.length === 0) {
          select.innerHTML += '<option value="" disabled>No projects available</option>';
        } else {
          projects.forEach(function(p) {
            const title = (p.project && (p.project.name || p.project.title)) || 'Untitled Project';
            const opt = document.createElement('option');
            opt.value = p.project_id;
            opt.textContent = title;
            select.appendChild(opt);
          });
        }
        // Add "Create New Project" option
        const createOpt = document.createElement('option');
        createOpt.value = '__create_new__';
        createOpt.textContent = '+ Create New Project';
        createOpt.style.fontWeight = '600';
        select.appendChild(createOpt);
      } catch (err) {
        console.error('Error loading projects for invite:', err);
        select.innerHTML = '<option value="">Could not load projects</option>';
      }
    }

    function cancelInlineProjectCreate() {
      const inlineForm = document.getElementById('inline-create-project-form');
      if (inlineForm) inlineForm.style.display = 'none';
      const select = document.getElementById('invite-project-select');
      if (select) select.value = '';
      document.getElementById('invite-project-id').value = '';
    }

    async function submitInlineProjectCreate() {
      const nameInput = document.getElementById('inline-project-name');
      const customerInput = document.getElementById('inline-project-customer');
      const descInput = document.getElementById('inline-project-description');
      const btn = document.getElementById('inline-create-project-btn');

      const name = (nameInput.value || '').trim();
      const customerName = (customerInput.value || '').trim();
      const description = (descInput.value || '').trim();

      if (!name) { nameInput.focus(); showToast('Project name is required', 'warning'); return; }
      if (!customerName) { customerInput.focus(); showToast('Customer name is required', 'warning'); return; }

      btn.disabled = true;
      btn.textContent = 'Creating...';

      try {
        const userData = await supabaseClient.auth.getUser();
        const user = userData.data && userData.data.user;
        if (!user) throw new Error('Not authenticated');

        const result = await supabaseClient.from('projects').insert({
          name: name,
          customer_name: customerName,
          description: description || null,
          user_id: user.id,
          status: 'lead',
          priority: 'medium'
        }).select().single();

        if (result.error) throw result.error;

        const project = result.data;
        console.log('[InlineCreate] Project created:', project.id, project.name);

        // Add new option to select and auto-select it
        const select = document.getElementById('invite-project-select');
        const opt = document.createElement('option');
        opt.value = project.id;
        opt.textContent = name;
        // Insert before the last option (Create New Project)
        const lastOpt = select.querySelector('option[value="__create_new__"]');
        if (lastOpt) {
          select.insertBefore(opt, lastOpt);
        } else {
          select.appendChild(opt);
        }
        select.value = project.id;
        document.getElementById('invite-project-id').value = project.id;

        // Hide inline form and clear inputs
        document.getElementById('inline-create-project-form').style.display = 'none';
        nameInput.value = '';
        customerInput.value = '';
        descInput.value = '';

        showToast('Project created and selected', 'success');

        // Refresh projects list if on that page
        if (typeof allProjects !== 'undefined') {
          allProjects.push(project);
          updateProjectsCount();
        }
      } catch (err) {
        console.error('Error creating inline project:', err);
        showToast('Error: ' + (err.message || 'Failed to create project'), 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create & Select';
      }
    }

    function closeInviteToProjectModal() {
      document.getElementById('invite-to-project-modal').classList.remove('active');
      // Also hide inline form when modal closes
      const inlineForm = document.getElementById('inline-create-project-form');
      if (inlineForm) inlineForm.style.display = 'none';
    }

    async function sendCollaborationInvite(event) {
      event.preventDefault();
      const btn = document.getElementById('send-project-invite-btn');
      const projectId = document.getElementById('invite-project-id').value || document.getElementById('invite-project-select').value;
      const email = document.getElementById('invite-email').value.trim().toLowerCase();
      const role = document.getElementById('invite-role').value;
      const accessLevel = document.getElementById('invite-access-level').value;
      const notes = document.getElementById('invite-notes').value.trim();

      if (!projectId || projectId === '__create_new__') {
        showToast('Please select a project first', 'warning');
        return false;
      }
      if (!email || !role) {
        showToast('Please fill in email and role', 'warning');
        return false;
      }

      // Client-side self-invite check
      if (currentUser && currentUser.email && email === currentUser.email.toLowerCase()) {
        showToast('You cannot invite yourself as a collaborator', 'warning');
        return false;
      }

      console.log('[Invite] Sending:', { projectId, email, role, accessLevel, notes: notes || '(none)' });

      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/invite', {
          method: 'POST',
          body: JSON.stringify({ email: email, role: role, access_level: accessLevel, notes: notes || undefined })
        });

        let data;
        try {
          data = await resp.json();
        } catch (parseErr) {
          console.error('[Invite] Failed to parse response:', parseErr);
          throw new Error('Server returned an invalid response (status ' + resp.status + ')');
        }

        console.log('[Invite] Response:', resp.status, data);
        if (!resp.ok) {
          let errMsg = data.error || 'Failed to send invitation';
          if (data.details && Array.isArray(data.details)) {
            errMsg += ': ' + data.details.map(function(d) { return d.message || d.field; }).join(', ');
          }
          throw new Error(errMsg);
        }

        showToast(data.message || 'Invitation sent successfully!', 'success');
        document.getElementById('invite-collaborator-form').reset();
        closeInviteToProjectModal();

        // Log activity
        logProjectActivity(projectId, 'collaborator_invited', 'Invited ' + email + ' as ' + role);

        // Bridge 6: Show role-specific guidance about what happens next
        var roleGuidance = {
          fabricator: 'They\'ll be guided to set up a vendor profile to list inventory and receive handoffs.',
          designer: 'They\'ll get access to design tools and can collaborate on project layouts.',
          contractor: 'They\'ll be able to view project details and get assigned to installation handoffs.',
          installer: 'They\'ll receive installation scheduling notifications for this project.',
          viewer: 'They\'ll be able to view project progress and updates.'
        };
        var guidance = roleGuidance[role];
        if (guidance) {
          setTimeout(function() { showToast(guidance, 'info'); }, 2000);
        }

      } catch (err) {
        console.error('[Invite] Error:', err);
        showToast(err.message || 'Error sending invitation', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg> Send Invitation';
      }

      return false;
    }

    async function loadPendingInvitations(projectId) {
      const section = document.getElementById('pending-invitations-section');
      const list = document.getElementById('pending-invitations-list');

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/pending-invitations');
        const data = await resp.json();

        if (!resp.ok || !data.invitations || !data.invitations.length) {
          section.style.display = 'none';
          return;
        }

        const pending = data.invitations.filter(function(i) { return i.status === 'pending'; });
        if (!pending.length) {
          section.style.display = 'none';
          return;
        }

        section.style.display = 'block';
        list.innerHTML = pending.map(function(inv) {
          return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--dark-surface); border-radius: 8px; margin-bottom: 8px;">' +
            '<div>' +
              '<div style="font-size: 13px; font-weight: 500;">' + escapeHtmlAttr(inv.email) + '</div>' +
              '<div style="font-size: 11px; color: var(--text-muted);">' + escapeHtmlAttr(inv.role) + ' &middot; ' + escapeHtmlAttr(inv.access_level) + '</div>' +
            '</div>' +
            '<button class="btn-modern secondary" onclick="cancelPendingInvitation(\'' + projectId + '\', \'' + inv.id + '\')" title="Cancel" style="padding: 6px 10px; min-width: auto;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
            '</button>' +
          '</div>';
        }).join('');

      } catch (err) {
        console.error('Error loading pending invitations:', err);
        section.style.display = 'none';
      }
    }

    async function cancelPendingInvitation(projectId, invitationId) {
      if (!confirm('Cancel this invitation?')) return;

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/pending-invitations/' + invitationId, {
          method: 'DELETE'
        });

        if (resp.ok) {
          showToast('Invitation cancelled');
          loadPendingInvitations(projectId);
        } else {
          showToast('Failed to cancel invitation');
        }
      } catch (err) {
        showToast('Error cancelling invitation');
      }
    }

    // ============ MY COLLABORATIONS ============

    async function loadCollaborations() {
      const container = document.getElementById('collaborations-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load project collaborations from Supabase
        // First check if project_collaborators table exists, if not fall back to project_contractors
        let collabs = [];

        // Try to load from project_contractors (contractor assignments to projects)
        const { data: contractorAssignments, error: contractorError } = await supabaseClient
          .from('project_contractors')
          .select('*, projects(id, name, status, customer_name)')
          .eq('contractor_id', user.id);

        if (!contractorError && contractorAssignments) {
          collabs = contractorAssignments.map(a => ({
            project_id: a.project_id,
            project: a.projects,
            role: a.role || 'contractor',
            access_level: 'write',
            accepted_at: a.assigned_at || a.created_at
          }));
        }

        // Update badge
        const badge = document.getElementById('collaborations-count');
        if (badge) {
          badge.textContent = collabs.length;
          badge.dataset.count = collabs.length;
          badge.style.display = collabs.length > 0 ? 'inline-flex' : 'none';
        }

        if (!collabs.length) {
          container.innerHTML = '<div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg><h3>No collaborations yet</h3><p>When you\'re invited to collaborate on projects, they\'ll appear here.</p></div>';
          return;
        }

        container.innerHTML = collabs.map(function(c) {
          const roleLabel = (c.role || 'viewer').charAt(0).toUpperCase() + (c.role || 'viewer').slice(1);
          const accessLabel = (c.access_level || 'read').charAt(0).toUpperCase() + (c.access_level || 'read').slice(1);
          const projectTitle = (c.project && (c.project.name || c.project.title)) || 'Untitled Project';
          const customerName = (c.project && c.project.customer_name) || '';
          const dateStr = c.accepted_at ? new Date(c.accepted_at).toLocaleDateString() : '';
          const pId = c.project_id || '';
          const showHandoff = (c.role === 'designer' || c.role === 'fabricator');
          const isViewer = (c.role === 'viewer');
          const projStatus = (c.project && c.project.status) || '';
          const projStatusLabel = PROJECT_STATUS_LABELS[projStatus] || projStatus;
          const projStatusColor = PROJECT_STATUS_COLORS[projStatus] || '#6b7280';

          return '<div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; gap: 12px;">' +
            '<div style="flex: 1; min-width: 0;">' +
              '<div style="font-size: 15px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + escapeHtmlAttr(projectTitle) + '</div>' +
              '<div style="display: flex; gap: 12px; margin-top: 6px; flex-wrap: wrap;">' +
                '<span style="font-size: 12px; padding: 2px 8px; background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); border-radius: 4px; font-weight: 500;">' + roleLabel + '</span>' +
                '<span style="font-size: 12px; padding: 2px 8px; background: rgba(255, 255, 255, 0.05); color: var(--text-muted); border-radius: 4px;">' + accessLabel + ' access</span>' +
                (projStatus ? '<span style="font-size: 12px; padding: 2px 8px; background: ' + projStatusColor + '15; color: ' + projStatusColor + '; border-radius: 4px; font-weight: 500;">' + projStatusLabel + '</span>' : '') +
                (dateStr ? '<span style="font-size: 12px; color: var(--text-muted);">Joined ' + dateStr + '</span>' : '') +
              '</div>' +
              (customerName ? '<div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Customer: ' + escapeHtmlAttr(customerName) + '</div>' : '') +
            '</div>' +
            '<div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">' +
              (pId ? '<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="' + (isViewer ? 'openCustomerProjectView(\'' + pId + '\')' : 'viewCollaborationProject(\'' + pId + '\')') + '">View Project</button>' : '') +
              (showHandoff && pId ? '<button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px; color: #22c55e;" onclick="openStartHandoffModal(null, \'\', \'' + pId + '\')">Start Handoff</button>' : '') +
            '</div>' +
          '</div>';
        }).join('');

      } catch (err) {
        console.error('Error loading collaborations:', err);
        container.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load collaborations.</p></div>';
      }
    }

    // =============================================
    // MY NETWORK (GENERAL COLLABORATORS)
    // =============================================

    // Track event participants being added
    let eventParticipants = [];
    let networkCollaboratorsCache = [];
    let selectedPickerParticipants = new Set();

    // =============================================
    // ENHANCED PARTICIPANT MANAGEMENT (Group Events)
    // =============================================

    function renderEventParticipantChips() {
      const container = document.getElementById('event-participants-chips');
      const noMsg = document.getElementById('no-participants-msg');
      const countEl = document.getElementById('participant-count');

      if (!container) return;

      if (eventParticipants.length === 0) {
        container.innerHTML = '<span style="color: var(--text-muted); font-size: 12px; padding: 4px 0;" id="no-participants-msg">No participants added</span>';
        if (countEl) countEl.textContent = '0 added';
        return;
      }

      const roleColors = {
        customer: '#10b981',
        contractor: '#3b82f6',
        fabricator: '#8b5cf6',
        installer: '#f59e0b',
        plumber: '#06b6d4',
        designer: '#ec4899',
        other: '#6b7280'
      };

      container.innerHTML = eventParticipants.map((p, i) => {
        const color = roleColors[p.role] || roleColors.other;
        return '<div class="participant-chip" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px 4px 12px; background: ' + color + '22; border: 1px solid ' + color + '44; border-radius: 16px; font-size: 12px;">' +
          '<span style="color: var(--text-primary); font-weight: 500;">' + escapeHtml(p.name || p.email) + '</span>' +
          '<span style="color: ' + color + '; font-size: 10px; text-transform: uppercase;">' + p.role + '</span>' +
          '<button type="button" onclick="removeEventParticipantChip(' + i + ')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px; line-height: 0;" title="Remove">' +
            '<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>' +
          '</button>' +
        '</div>';
      }).join('');

      if (countEl) countEl.textContent = eventParticipants.length + ' added';
    }

    function removeEventParticipantChip(index) {
      eventParticipants.splice(index, 1);
      renderEventParticipantChips();
    }

    function addParticipantToEvent(participant) {
      // Check for duplicates by email
      if (participant.email && eventParticipants.some(p => p.email && p.email.toLowerCase() === participant.email.toLowerCase())) {
        showToast('This participant is already added', 'warning');
        return false;
      }
      eventParticipants.push(participant);
      renderEventParticipantChips();
      return true;
    }

    // Toggle manual participant form
    function toggleManualParticipantForm() {
      const form = document.getElementById('manual-participant-form');
      if (form) {
        form.style.display = form.style.display === 'none' ? '' : 'none';
        if (form.style.display !== 'none') {
          document.getElementById('manual-participant-name').value = '';
          document.getElementById('manual-participant-email').value = '';
          document.getElementById('manual-participant-phone').value = '';
          document.getElementById('manual-participant-role').value = 'customer';
          document.getElementById('manual-participant-name').focus();
        }
      }
    }

    function addManualParticipant() {
      const name = document.getElementById('manual-participant-name').value.trim();
      const email = document.getElementById('manual-participant-email').value.trim();
      const phone = document.getElementById('manual-participant-phone').value.trim();
      const role = document.getElementById('manual-participant-role').value;

      if (!name) {
        showToast('Please enter a name', 'warning');
        return;
      }

      const added = addParticipantToEvent({
        name: name,
        email: email || '',
        phone: phone || '',
        role: role,
        participant_type: 'attendee'
      });

      if (added) {
        toggleManualParticipantForm();
        showToast('Participant added', 'success');
      }
    }

    // Open participant picker modal
    async function openParticipantPicker() {
      const modal = document.getElementById('participant-picker-modal');
      if (!modal) return;

      modal.classList.add('active');
      selectedPickerParticipants.clear();
      document.getElementById('selected-participants-count').textContent = '0';
      document.getElementById('participant-search').value = '';

      // Load network collaborators
      const listEl = document.getElementById('participant-picker-list');
      listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading network...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load general collaborators from Supabase directly
        const { data: collaborators, error } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, email, phone, role, company, status')
          .eq('invited_by', user.id)
          .eq('status', 'active')
          .order('name', { ascending: true });

        if (error) throw error;

        networkCollaboratorsCache = collaborators || [];
        renderParticipantPicker(networkCollaboratorsCache);

      } catch (err) {
        console.error('Error loading network:', err);
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Failed to load network</div>';
      }
    }

    function renderParticipantPicker(collaborators) {
      const listEl = document.getElementById('participant-picker-list');

      if (!collaborators || collaborators.length === 0) {
        listEl.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No collaborators in your network yet.<br><small>Add collaborators from the Collaborators page.</small></div>';
        return;
      }

      const roleColors = {
        contractor: '#3b82f6',
        fabricator: '#8b5cf6',
        installer: '#f59e0b',
        plumber: '#06b6d4',
        designer: '#ec4899',
        vendor: '#84cc16',
        partner: '#14b8a6',
        other: '#6b7280'
      };

      listEl.innerHTML = collaborators.map(c => {
        const isAlreadyAdded = eventParticipants.some(p => p.email && c.email && p.email.toLowerCase() === c.email.toLowerCase());
        const isSelected = selectedPickerParticipants.has(c.id);
        const color = roleColors[c.role] || roleColors.other;

        return '<div class="picker-item" data-id="' + c.id + '" onclick="togglePickerParticipant(\'' + c.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; background: ' + (isSelected ? 'var(--gold-primary)11' : 'transparent') + '; ' + (isAlreadyAdded ? 'opacity: 0.5; pointer-events: none;' : '') + '">' +
          '<input type="checkbox" ' + (isSelected ? 'checked' : '') + ' ' + (isAlreadyAdded ? 'disabled' : '') + ' style="accent-color: var(--gold-primary); width: 18px; height: 18px;" onclick="event.stopPropagation(); togglePickerParticipant(\'' + c.id + '\')" />' +
          '<div style="flex: 1; min-width: 0;">' +
            '<div style="font-weight: 600; color: var(--text-primary);">' + escapeHtml(c.name) + (isAlreadyAdded ? ' <span style="font-size: 10px; color: var(--text-muted);">(already added)</span>' : '') + '</div>' +
            '<div style="font-size: 12px; color: var(--text-secondary);">' + escapeHtml(c.email || 'No email') + (c.company ? ' • ' + escapeHtml(c.company) : '') + '</div>' +
          '</div>' +
          '<span style="font-size: 11px; padding: 3px 8px; border-radius: 12px; background: ' + color + '22; color: ' + color + '; text-transform: uppercase;">' + (c.role || 'other') + '</span>' +
        '</div>';
      }).join('');
    }

    function filterParticipantPicker(query) {
      const q = query.toLowerCase().trim();
      if (!q) {
        renderParticipantPicker(networkCollaboratorsCache);
        return;
      }
      const filtered = networkCollaboratorsCache.filter(c =>
        (c.name && c.name.toLowerCase().includes(q)) ||
        (c.email && c.email.toLowerCase().includes(q)) ||
        (c.role && c.role.toLowerCase().includes(q)) ||
        (c.company && c.company.toLowerCase().includes(q))
      );
      renderParticipantPicker(filtered);
    }

    function togglePickerParticipant(id) {
      if (selectedPickerParticipants.has(id)) {
        selectedPickerParticipants.delete(id);
      } else {
        selectedPickerParticipants.add(id);
      }
      document.getElementById('selected-participants-count').textContent = selectedPickerParticipants.size.toString();
      // Re-render to update checkboxes
      filterParticipantPicker(document.getElementById('participant-search').value);
    }

    function confirmSelectedParticipants() {
      let addedCount = 0;
      selectedPickerParticipants.forEach(id => {
        const collab = networkCollaboratorsCache.find(c => c.id === id);
        if (collab) {
          const added = addParticipantToEvent({
            name: collab.name,
            email: collab.email || '',
            phone: collab.phone || '',
            role: collab.role || 'other',
            participant_type: 'attendee'
          });
          if (added) addedCount++;
        }
      });

      closeParticipantPicker();
      if (addedCount > 0) {
        showToast(addedCount + ' participant' + (addedCount > 1 ? 's' : '') + ' added', 'success');
      }
    }

    function closeParticipantPicker() {
      const modal = document.getElementById('participant-picker-modal');
      if (modal) modal.classList.remove('active');
    }

    // Add all project team members to event
    async function addProjectTeamToEvent() {
      const projectSelect = document.getElementById('cal-event-project-select');
      const projectId = projectSelect?.value;

      if (!projectId) {
        showToast('Please select a project first', 'warning');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Load project contractors
        const { data: contractors, error } = await supabaseClient
          .from('project_contractors')
          .select('contractor_id, role, general_collaborators(id, name, email, phone, role)')
          .eq('project_id', projectId);

        if (error) throw error;

        if (!contractors || contractors.length === 0) {
          showToast('No team members assigned to this project', 'info');
          return;
        }

        let addedCount = 0;
        contractors.forEach(pc => {
          const collab = pc.general_collaborators;
          if (collab && collab.email) {
            const added = addParticipantToEvent({
              name: collab.name,
              email: collab.email,
              phone: collab.phone || '',
              role: pc.role || collab.role || 'contractor',
              participant_type: 'attendee'
            });
            if (added) addedCount++;
          }
        });

        if (addedCount > 0) {
          showToast(addedCount + ' team member' + (addedCount > 1 ? 's' : '') + ' added', 'success');
        } else {
          showToast('All team members already added', 'info');
        }

      } catch (err) {
        console.error('Error loading project team:', err);
        showToast('Failed to load project team', 'error');
      }
    }

    // Enable/disable "Add Project Team" button based on project selection
    function onProjectSelectChange() {
      const projectSelect = document.getElementById('cal-event-project-select');
      const addTeamBtn = document.getElementById('add-project-team-btn');
      if (addTeamBtn) {
        addTeamBtn.disabled = !projectSelect?.value;
      }
    }

    function switchCollabTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.collab-tab').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'var(--dark-surface)';
        btn.style.color = 'var(--text-secondary)';
        btn.style.border = '1px solid var(--border-subtle)';
      });
      const activeTab = document.getElementById('tab-' + tab);
      if (activeTab) {
        activeTab.classList.add('active');
        activeTab.style.background = 'var(--gold-primary)';
        activeTab.style.color = '#1a1a2e';
        activeTab.style.border = 'none';
      }

      // Show/hide content
      document.querySelectorAll('.collab-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      const activeContent = document.getElementById('collab-tab-' + tab);
      if (activeContent) activeContent.style.display = 'block';

      // Load data for the active tab
      if (tab === 'network') loadMyNetwork();
      else if (tab === 'invitations') loadReceivedInvitations();
      else if (tab === 'collaborations') {
        loadCollaborations();
        loadCollaborationActivity();
      }
    }

    async function loadCollaborationActivity() {
      const container = document.getElementById('collaboration-activity-feed');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Get recent activity from projects user is involved in
        // This includes: project updates, new collaborators, messages, status changes
        const activities = [];

        // Get recent project notes (activity)
        const { data: notes } = await supabaseClient
          .from('project_notes')
          .select('id, content, created_at, project_id, user_id, projects(name)')
          .order('created_at', { ascending: false })
          .limit(10);

        if (notes) {
          notes.forEach(note => {
            activities.push({
              type: 'note',
              message: note.content?.substring(0, 100) + (note.content?.length > 100 ? '...' : ''),
              project: note.projects?.name,
              project_id: note.project_id,
              created_at: note.created_at,
              icon: 'M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z'
            });
          });
        }

        // Get recent collaborator joins
        const { data: recentCollabs } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, role, status, created_at, accepted_at')
          .eq('invited_by', user.id)
          .eq('status', 'accepted')
          .order('accepted_at', { ascending: false })
          .limit(5);

        if (recentCollabs) {
          recentCollabs.forEach(collab => {
            if (collab.accepted_at) {
              activities.push({
                type: 'collaborator',
                message: `${collab.name} joined your network as ${collab.role}`,
                created_at: collab.accepted_at,
                icon: 'M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z'
              });
            }
          });
        }

        // Get recent messages
        const { data: recentMessages } = await supabaseClient
          .from('collaborator_messages')
          .select('id, message, created_at, sender_id, recipient_id')
          .or(`sender_id.eq.${user.id},recipient_id.eq.${user.id}`)
          .order('created_at', { ascending: false })
          .limit(5);

        if (recentMessages) {
          recentMessages.forEach(msg => {
            const isIncoming = msg.sender_id !== user.id;
            activities.push({
              type: 'message',
              message: isIncoming ? 'New message received' : 'Message sent',
              created_at: msg.created_at,
              icon: '8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z'
            });
          });
        }

        // Sort by date
        activities.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

        if (activities.length === 0) {
          container.innerHTML = `
            <div style="padding: 24px; text-align: center; color: var(--text-muted); font-size: 13px;">
              No recent activity yet
            </div>`;
          return;
        }

        container.innerHTML = activities.slice(0, 8).map(activity => {
          const timeAgo = getTimeAgo(activity.created_at);
          const typeColors = {
            note: '#3b82f6',
            collaborator: '#10b981',
            message: '#f59e0b',
            project: '#8b5cf6'
          };
          const color = typeColors[activity.type] || '#6b7280';

          return `
            <div style="display: flex; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);" ${activity.project_id ? `onclick="viewCollaborationProject('${activity.project_id}')" style="cursor: pointer;"` : ''}>
              <div style="width: 32px; height: 32px; background: ${color}20; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="${color}" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M${activity.icon}"/></svg>
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 13px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(activity.message)}</div>
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">
                  ${activity.project ? escapeHtml(activity.project) + ' • ' : ''}${timeAgo}
                </div>
              </div>
            </div>`;
        }).join('');

      } catch (err) {
        console.error('Error loading activity:', err);
        container.innerHTML = `
          <div style="padding: 24px; text-align: center; color: var(--text-muted); font-size: 13px;">
            Activity from shared projects will appear here
          </div>`;
      }
    }

    function getTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);

      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }

    function switchTeamTab(tab) {
      // Update tab buttons
      document.querySelectorAll('#page-collaborators .filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      const activeTab = document.getElementById('team-tab-' + tab);
      if (activeTab) activeTab.classList.add('active');

      // Show/hide content
      document.getElementById('team-content-my-team').style.display = tab === 'my-team' ? 'block' : 'none';
      document.getElementById('team-content-invitations').style.display = tab === 'invitations' ? 'block' : 'none';

      // Load data for invitations tab
      if (tab === 'invitations') loadTeamInvitations();
    }

    async function loadTeamInvitations() {
      const container = document.getElementById('team-invitations-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Query project collaborators where user is invited (by email)
        const { data: projectInvites, error } = await supabaseClient
          .from('project_collaborators')
          .select('id, role, status, token_expires_at, created_at, project_id, invited_by')
          .eq('email', user.email.toLowerCase())
          .eq('status', 'pending')
          .order('created_at', { ascending: false });

        if (error) throw error;

        // Filter out expired invitations
        const now = new Date();
        const validInvites = (projectInvites || []).filter(inv => {
          if (!inv.token_expires_at) return true;
          return new Date(inv.token_expires_at) > now;
        });

        if (validInvites.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              <h3>No pending invitations</h3>
              <p>When you're invited to collaborate on projects, they'll appear here.</p>
            </div>`;
          return;
        }

        // Get project and inviter details
        const projectIds = [...new Set(validInvites.map(inv => inv.project_id).filter(Boolean))];
        const inviterIds = [...new Set(validInvites.map(inv => inv.invited_by).filter(Boolean))];

        let projectsMap = {};
        let invitersMap = {};

        if (projectIds.length > 0) {
          const { data: projects } = await supabaseClient
            .from('projects')
            .select('id, name')
            .in('id', projectIds);
          if (projects) {
            projectsMap = Object.fromEntries(projects.map(p => [p.id, p]));
          }
        }

        if (inviterIds.length > 0) {
          const { data: inviters } = await supabaseClient
            .from('profiles')
            .select('id, full_name, email')
            .in('id', inviterIds);
          if (inviters) {
            invitersMap = Object.fromEntries(inviters.map(p => [p.id, p]));
          }
        }

        container.innerHTML = validInvites.map(inv => {
          const project = projectsMap[inv.project_id];
          const inviter = invitersMap[inv.invited_by];
          const expiresStr = inv.token_expires_at ? getExpirationText(inv.token_expires_at) : '';

          return `
            <div class="list-item" style="display: flex; justify-content: space-between; align-items: center; padding: 16px; border: 1px solid var(--border-subtle); border-radius: 8px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600;">${escapeHtml(project?.name || 'Project')}</div>
                <div style="font-size: 13px; color: var(--text-muted);">From: ${escapeHtml(inviter?.full_name || inviter?.email || 'Unknown')}</div>
                <div style="font-size: 12px; color: var(--text-muted);">Role: ${inv.role || 'Collaborator'}</div>
                ${expiresStr ? `<div style="font-size: 11px; color: var(--warning); margin-top: 4px;">${expiresStr}</div>` : ''}
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn-modern primary" onclick="respondToInvitation('${inv.id}', 'accepted', false)">Accept</button>
                <button class="btn-modern ghost" onclick="respondToInvitation('${inv.id}', 'declined', false)">Decline</button>
              </div>
            </div>
          `;
        }).join('');

        // Update badge
        const badge = document.getElementById('team-invites-badge');
        if (badge) {
          badge.textContent = validInvites.length;
          badge.style.display = validInvites.length > 0 ? 'inline' : 'none';
        }
      } catch (err) {
        console.error('Load team invitations error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Error loading invitations</div>';
      }
    }

    // Helper to get expiration text
    function getExpirationText(expiresAt) {
      if (!expiresAt) return '';
      const now = new Date();
      const expiresDate = new Date(expiresAt);
      if (expiresDate < now) return 'Expired';
      const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
      const hoursLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60));
      if (daysLeft <= 1) {
        return hoursLeft <= 1 ? 'Expires in less than an hour' : `Expires in ${hoursLeft} hours`;
      }
      return `Expires in ${daysLeft} days`;
    }

    async function loadMyNetwork() {
      const container = document.getElementById('network-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load collaborators directly from Supabase
        const { data: collaborators, error } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, email, phone, role, company, status, notes, created_at, token_expires_at, viewed_at, view_count, declined_at, resent_at')
          .eq('invited_by', user.id)
          .order('name', { ascending: true });

        if (error) throw error;

        const collabList = collaborators || [];
        const now = new Date();

        // Update badge
        const badge = document.getElementById('network-count-badge');
        if (badge) {
          badge.textContent = collabList.length;
          badge.style.display = collabList.length > 0 ? 'inline' : 'none';
        }

        if (collabList.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
              <h3>No network contacts yet</h3>
              <p>Invite colleagues, vendors, and partners to build your professional network.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = collabList.map(c => {
          const roleLabel = (c.role || 'partner').charAt(0).toUpperCase() + (c.role || 'partner').slice(1);
          const userName = c.name || c.email;
          const dateStr = c.created_at ? new Date(c.created_at).toLocaleDateString() : '';

          // Check expiration for pending invites
          let isExpired = false;
          let expiresStr = '';
          if (c.status === 'pending' && c.token_expires_at) {
            const expiresDate = new Date(c.token_expires_at);
            isExpired = expiresDate < now;
            if (isExpired) {
              expiresStr = 'Expired';
            } else {
              const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
              const hoursLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60));
              if (daysLeft <= 1) {
                expiresStr = hoursLeft <= 1 ? 'Expires in <1 hour' : `Expires in ${hoursLeft}h`;
              } else {
                expiresStr = `Expires in ${daysLeft}d`;
              }
            }
          }

          // Determine status display
          let statusColor, statusLabel, viewedInfo = '';
          if (c.status === 'accepted') {
            statusColor = '#10b981';
            statusLabel = 'Active';
          } else if (c.status === 'declined') {
            statusColor = '#ef4444';
            statusLabel = 'Declined';
            if (c.declined_at) {
              viewedInfo = 'Declined ' + new Date(c.declined_at).toLocaleDateString();
            }
          } else if (isExpired) {
            statusColor = '#ef4444';
            statusLabel = 'Expired';
            if (c.viewed_at) {
              viewedInfo = 'Viewed but not accepted';
            }
          } else if (c.status === 'pending') {
            if (c.viewed_at) {
              statusColor = '#3b82f6';
              statusLabel = 'Viewed';
              viewedInfo = `Opened ${c.view_count || 1}x`;
            } else {
              statusColor = '#f59e0b';
              statusLabel = 'Pending';
            }
          } else {
            statusColor = '#6b7280';
            statusLabel = c.status || 'Unknown';
          }

          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                  <span style="font-size: 15px; font-weight: 600;">${escapeHtml(userName)}</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: rgba(249, 203, 0, 0.15); color: var(--gold-primary); border-radius: 4px; font-weight: 500;">${roleLabel}</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: ${statusColor}20; color: ${statusColor}; border-radius: 4px; font-weight: 500;">${statusLabel}</span>
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${escapeHtml(c.email || '')}${c.phone ? ' • ' + escapeHtml(c.phone) : ''}${dateStr ? ' • ' + dateStr : ''}</div>
                ${viewedInfo ? `<div style="font-size: 11px; color: ${statusColor}; margin-top: 4px;">${viewedInfo}</div>` : ''}
                ${expiresStr && !isExpired ? `<div style="font-size: 11px; color: var(--warning); margin-top: 4px;">${expiresStr}</div>` : ''}
                ${c.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; font-style: italic;">${escapeHtml(c.notes)}</div>` : ''}
              </div>
              <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0;">
                ${c.status === 'accepted' ? `
                  <button class="btn-modern ghost" style="padding: 6px 10px;" onclick="openCollaboratorChat('${c.id}', '${escapeHtml(userName)}', '${escapeHtml(c.email || '')}')" title="Message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                  </button>
                  ${c.email ? `<button class="btn-modern ghost" style="padding: 6px 10px;" onclick="window.open('mailto:${escapeHtml(c.email)}', '_blank')" title="Email">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  </button>` : ''}
                  ${c.phone ? `<button class="btn-modern ghost" style="padding: 6px 10px;" onclick="window.open('tel:${escapeHtml(c.phone)}', '_self')" title="Call">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                  </button>` : ''}
                  <button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="openAssignToProjectModal('${c.id}', '${escapeHtml(userName)}')">
                    Assign
                  </button>
                ` : ''}
                ${isExpired || c.status === 'declined' ? `
                  <button class="btn-modern secondary" style="padding: 6px 12px; font-size: 12px;" onclick="resendNetworkInvite('${c.id}')">
                    Resend
                  </button>
                ` : ''}
                <button class="btn-modern ghost" style="padding: 6px 10px; color: var(--error);" onclick="removeNetworkCollaborator('${c.id}')" title="Remove">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading network:', err);
        container.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load network.</p></div>';
      }
    }

    async function loadReceivedInvitations() {
      const container = document.getElementById('received-invitations-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Query invitations sent to the current user's email that are still pending
        const { data: networkInvites, error: networkError } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, email, role, notes, created_at, token_expires_at, invited_by')
          .eq('email', user.email.toLowerCase())
          .eq('status', 'pending')
          .order('created_at', { ascending: false });

        if (networkError) throw networkError;

        // Filter out expired invitations
        const now = new Date();
        const validInvites = (networkInvites || []).filter(inv => {
          if (!inv.token_expires_at) return true; // No expiration set
          return new Date(inv.token_expires_at) > now;
        });

        // Get inviter details
        const inviterIds = [...new Set(validInvites.map(inv => inv.invited_by).filter(Boolean))];
        let invitersMap = {};
        if (inviterIds.length > 0) {
          const { data: inviters } = await supabaseClient
            .from('profiles')
            .select('id, full_name, email')
            .in('id', inviterIds);
          if (inviters) {
            invitersMap = Object.fromEntries(inviters.map(p => [p.id, p]));
          }
        }

        // Update badge
        const badge = document.getElementById('invitations-count-badge');
        if (badge) {
          badge.textContent = validInvites.length;
          badge.style.display = validInvites.length > 0 ? 'inline' : 'none';
        }

        if (validInvites.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 12px;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
              <h3>No pending invitations</h3>
              <p>When someone invites you to collaborate, it will appear here.</p>
            </div>
          `;
          return;
        }

        container.innerHTML = validInvites.map(inv => {
          const roleLabel = (inv.role || 'collaborator').charAt(0).toUpperCase() + (inv.role || 'collaborator').slice(1);
          const inviter = invitersMap[inv.invited_by];
          const inviterName = inviter?.full_name || inviter?.email || 'Someone';
          const dateStr = inv.created_at ? new Date(inv.created_at).toLocaleDateString() : '';

          // Calculate time remaining
          let expiresStr = '';
          if (inv.token_expires_at) {
            const expiresDate = new Date(inv.token_expires_at);
            const daysLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60 * 24));
            const hoursLeft = Math.ceil((expiresDate - now) / (1000 * 60 * 60));
            if (daysLeft <= 1) {
              expiresStr = hoursLeft <= 1 ? 'Expires in less than an hour' : `Expires in ${hoursLeft} hours`;
            } else {
              expiresStr = `Expires in ${daysLeft} days`;
            }
          }

          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; margin-bottom: 12px; gap: 12px;">
              <div style="flex: 1; min-width: 0;">
                <div style="font-size: 15px; font-weight: 600; margin-bottom: 4px;">
                  Network Invitation
                </div>
                <div style="font-size: 13px; color: var(--text-secondary);">
                  From: ${escapeHtml(inviterName)} • Role: ${roleLabel}
                </div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${dateStr}</div>
                ${expiresStr ? `<div style="font-size: 11px; color: var(--warning); margin-top: 4px;">${expiresStr}</div>` : ''}
                ${inv.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 6px; font-style: italic;">"${escapeHtml(inv.notes)}"</div>` : ''}
              </div>
              <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                <button class="btn-modern primary" style="padding: 8px 16px; font-size: 13px;" onclick="respondToInvitation('${inv.id}', 'accepted', true)">
                  Accept
                </button>
                <button class="btn-modern secondary" style="padding: 8px 16px; font-size: 13px;" onclick="respondToInvitation('${inv.id}', 'declined', true)">
                  Decline
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Error loading invitations:', err);
        container.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load invitations.</p></div>';
      }
    }

    async function respondToInvitation(invitationId, response, isNetwork) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Update invitation status directly in Supabase
        const tableName = isNetwork ? 'general_collaborators' : 'project_collaborators';

        // First verify this invitation is for the current user
        const { data: invitation, error: fetchError } = await supabaseClient
          .from(tableName)
          .select('id, email, status, token_expires_at')
          .eq('id', invitationId)
          .single();

        if (fetchError || !invitation) {
          throw new Error('Invitation not found');
        }

        // Check if invitation has expired
        if (invitation.token_expires_at && new Date(invitation.token_expires_at) < new Date()) {
          throw new Error('This invitation has expired');
        }

        // Check if already responded
        if (invitation.status !== 'pending') {
          throw new Error('This invitation has already been responded to');
        }

        // Update the status
        const updateData = {
          status: response
        };

        // If accepting, link to user account and set accepted_at
        if (response === 'accepted') {
          updateData.user_id = user.id;
          updateData.accepted_at = new Date().toISOString();
        } else if (response === 'declined') {
          updateData.declined_at = new Date().toISOString();
          updateData.user_id = user.id;
        }

        const { error: updateError } = await supabaseClient
          .from(tableName)
          .update(updateData)
          .eq('id', invitationId);

        if (updateError) throw updateError;

        showToast(response === 'accepted' ? 'Invitation accepted!' : 'Invitation declined', 'success');
        loadReceivedInvitations();

        // Refresh the relevant list
        if (response === 'accepted') {
          if (isNetwork) loadMyNetwork();
          else loadCollaborations();
        }
      } catch (err) {
        console.error('Error responding to invitation:', err);
        showToast(err.message || 'Failed to respond to invitation', 'error');
      }
    }

    function openInviteToNetworkModal() {
      document.getElementById('invite-network-form').reset();
      document.getElementById('invite-to-network-modal').classList.add('active');
    }

    function closeInviteToNetworkModal() {
      document.getElementById('invite-to-network-modal').classList.remove('active');
    }

    async function sendNetworkInvite(event) {
      event.preventDefault();
      const btn = document.getElementById('send-network-invite-btn');
      const name = document.getElementById('network-invite-name').value.trim();
      const contact = document.getElementById('network-invite-contact').value.trim();
      const roleInput = document.querySelector('input[name="invite-role"]:checked');
      const role = roleInput ? roleInput.value : '';

      if (!name) {
        showToast('Please enter their name', 'warning');
        return false;
      }

      if (!contact) {
        showToast('Please enter their email or phone', 'warning');
        return false;
      }

      if (!role) {
        showToast('Please select what they do', 'warning');
        return false;
      }

      // Determine if contact is email or phone
      const isEmail = contact.includes('@');
      const email = isEmail ? contact.toLowerCase() : null;
      const phone = !isEmail ? contact : null;

      if (email && currentUser && currentUser.email && email === currentUser.email.toLowerCase()) {
        showToast('You cannot invite yourself', 'warning');
        return false;
      }

      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-small"></span> Adding...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Check if collaborator already exists
        let query = supabaseClient.from('general_collaborators').select('id').eq('invited_by', user.id);
        if (email) query = query.eq('email', email);
        else if (phone) query = query.eq('phone', phone);

        const { data: existing } = await query.maybeSingle();
        if (existing) {
          throw new Error('This person is already in your network');
        }

        // Generate invite token
        const inviteToken = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2) + Date.now().toString(36);

        // Insert new collaborator with invite token (expires in 7 days)
        const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
        const { data: newCollab, error: insertError } = await supabaseClient
          .from('general_collaborators')
          .insert({
            invited_by: user.id,
            name,
            email,
            phone,
            role,
            status: 'pending',
            token_hash: inviteToken,
            token_expires_at: expiresAt
          })
          .select()
          .single();

        if (insertError) throw insertError;

        // Send invite email if email provided
        if (email) {
          const inviterName = userProfile?.full_name || userProfile?.name || user.email?.split('@')[0] || 'A colleague';
          const inviteUrl = `https://www.surprisegranite.com/account/?invite=${inviteToken}`;

          try {
            // Always use production email API (not localhost)
            const { data: { session } } = await supabaseClient.auth.getSession();
            const token = session?.access_token;

            const emailResp = await fetch('https://surprise-granite-email-api.onrender.com/api/send-network-invite', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify({
                to: email,
                inviterName,
                inviteeName: name,
                role,
                inviteUrl,
                companyName: 'Surprise Granite'
              })
            });
            const emailResult = await emailResp.json();
            console.log('[Invite] Email API response:', emailResp.status, emailResult);
          } catch (emailErr) {
            console.warn('[Invite] Email send failed:', emailErr);
          }
        }

        showToast(`Invite sent to ${name}!`, 'success');
        closeInviteToNetworkModal();

        // Reset form
        document.getElementById('invite-network-form').reset();
        document.querySelectorAll('.role-option').forEach(o => o.querySelector('input').checked = false);

        loadMyNetwork();

      } catch (err) {
        console.error('Error sending network invite:', err);
        showToast(err.message || 'Failed to send invitation', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 10px;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg> Send Invite';
      }

      return false;
    }

    async function removeNetworkCollaborator(collaboratorId) {
      if (!confirm('Remove this contact from your network?')) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Delete from Supabase directly
        const { error } = await supabaseClient
          .from('general_collaborators')
          .delete()
          .eq('id', collaboratorId)
          .eq('invited_by', user.id); // Ensure user owns this record

        if (error) throw error;

        showToast('Contact removed from network', 'success');
        loadMyNetwork();
      } catch (err) {
        console.error('Error removing collaborator:', err);
        showToast(err.message || 'Failed to remove contact', 'error');
      }
    }

    async function resendNetworkInvite(collaboratorId) {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get the existing collaborator record
        const { data: collab, error: fetchError } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, email, role')
          .eq('id', collaboratorId)
          .eq('invited_by', user.id)
          .single();

        if (fetchError || !collab) throw new Error('Collaborator not found');

        // Generate new invite token and expiration
        const inviteToken = crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).substring(2) + Date.now().toString(36);
        const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();

        // Update the record with new token, status, and expiration
        const { error: updateError } = await supabaseClient
          .from('general_collaborators')
          .update({
            status: 'pending',
            token_hash: inviteToken,
            token_expires_at: expiresAt,
            accepted_at: null
          })
          .eq('id', collaboratorId);

        if (updateError) throw updateError;

        // Send new invite email if email provided
        if (collab.email) {
          const inviterName = userProfile?.full_name || userProfile?.name || user.email?.split('@')[0] || 'A colleague';
          const inviteUrl = `https://www.surprisegranite.com/account/?invite=${inviteToken}`;

          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            const token = session?.access_token;

            await fetch('https://surprise-granite-email-api.onrender.com/api/send-network-invite', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
              },
              body: JSON.stringify({
                to: collab.email,
                inviterName,
                inviteeName: collab.name,
                role: collab.role,
                inviteUrl,
                companyName: 'Surprise Granite'
              })
            });
          } catch (emailErr) {
            console.warn('[Resend] Email send failed:', emailErr);
          }
        }

        showToast(`Invitation resent to ${collab.name}!`, 'success');
        loadMyNetwork();
      } catch (err) {
        console.error('Error resending invite:', err);
        showToast(err.message || 'Failed to resend invitation', 'error');
      }
    }

    function openAssignToProjectModal(collaboratorId, collaboratorName) {
      document.getElementById('assign-collaborator-id').value = collaboratorId;
      document.getElementById('assign-collaborator-name').textContent = collaboratorName;
      loadProjectsForAssignment();
      document.getElementById('assign-to-project-modal').classList.add('active');
    }

    function closeAssignToProjectModal() {
      document.getElementById('assign-to-project-modal').classList.remove('active');
    }

    async function loadProjectsForAssignment() {
      const select = document.getElementById('assign-project-select');
      select.innerHTML = '<option value="">Loading projects...</option>';

      try {
        // Load owned projects
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: projects } = await supabaseClient
          .from('projects')
          .select('id, name')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        select.innerHTML = '<option value="">-- Select Project --</option>';

        if (projects && projects.length > 0) {
          projects.forEach(p => {
            select.innerHTML += `<option value="${p.id}">${escapeHtml(p.name)}</option>`;
          });
        }

        // Also add jobs
        if (allJobs && allJobs.length > 0) {
          allJobs.forEach(job => {
            const label = (job.job_number || 'Job') + ' - ' + (job.customer_name || job.description || 'Untitled');
            select.innerHTML += `<option value="${job.id}">${escapeHtml(label)}</option>`;
          });
        }

        if (select.options.length === 1) {
          select.innerHTML = '<option value="">No projects available</option>';
        }
      } catch (err) {
        console.error('Error loading projects:', err);
        select.innerHTML = '<option value="">Failed to load projects</option>';
      }
    }

    async function submitAssignToProject(event) {
      event.preventDefault();
      const collaboratorId = document.getElementById('assign-collaborator-id').value;
      const projectId = document.getElementById('assign-project-select').value;
      const accessLevel = document.getElementById('assign-access-level').value;

      if (!collaboratorId || !projectId) {
        showToast('Please select a project', 'warning');
        return false;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get the collaborator details
        const { data: collab, error: collabError } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, email, role, user_id')
          .eq('id', collaboratorId)
          .single();

        if (collabError || !collab) throw new Error('Collaborator not found');

        // Add to project_contractors table
        const { error: insertError } = await supabaseClient
          .from('project_contractors')
          .insert({
            project_id: projectId,
            contractor_id: collab.user_id || collaboratorId,
            role: collab.role || 'contractor',
            status: 'assigned',
            assigned_by: user.id
          });

        if (insertError) {
          // Check if it's a duplicate
          if (insertError.code === '23505') {
            throw new Error('This collaborator is already assigned to this project');
          }
          throw insertError;
        }

        showToast('Collaborator assigned to project!', 'success');
        closeAssignToProjectModal();
        loadCollaborations();
      } catch (err) {
        console.error('Error assigning to project:', err);
        showToast(err.message || 'Failed to assign to project', 'error');
      }

      return false;
    }

    // =============================================
    // COLLABORATOR CHAT SYSTEM
    // =============================================

    let currentChatCollaborator = null;

    function openCollaboratorChat(collaboratorId, name, email) {
      currentChatCollaborator = { id: collaboratorId, name, email };
      document.getElementById('chat-collaborator-id').value = collaboratorId;
      document.getElementById('chat-collaborator-name').textContent = name;
      document.getElementById('chat-collaborator-email').textContent = email;
      document.getElementById('chat-collaborator-avatar').textContent = (name || '?').charAt(0).toUpperCase();
      document.getElementById('collaborator-message-input').value = '';
      document.getElementById('collaborator-chat-modal').classList.add('active');
      loadCollaboratorMessages(collaboratorId);
    }

    function closeCollaboratorChat() {
      document.getElementById('collaborator-chat-modal').classList.remove('active');
      currentChatCollaborator = null;
    }

    async function loadCollaboratorMessages(collaboratorId) {
      const container = document.getElementById('collaborator-chat-messages');
      container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Load messages between current user and collaborator
        const { data: messages, error } = await supabaseClient
          .from('collaborator_messages')
          .select('*')
          .or(`and(sender_id.eq.${user.id},recipient_id.eq.${collaboratorId}),and(sender_id.eq.${collaboratorId},recipient_id.eq.${user.id})`)
          .order('created_at', { ascending: true });

        if (error) {
          // Table might not exist yet, show empty state
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 12px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <p>Start a conversation with ${escapeHtml(currentChatCollaborator?.name || 'this collaborator')}</p>
            </div>`;
          return;
        }

        if (!messages || messages.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" style="margin-bottom: 12px; opacity: 0.5;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
              <p>Start a conversation</p>
            </div>`;
          return;
        }

        container.innerHTML = messages.map(msg => {
          const isOutbound = msg.sender_id === user.id;
          const time = new Date(msg.created_at).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
          return `
            <div style="display: flex; justify-content: ${isOutbound ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
              <div style="max-width: 80%; padding: 10px 14px; border-radius: 16px; background: ${isOutbound ? 'var(--gold-primary)' : 'var(--dark-elevated)'}; color: ${isOutbound ? '#1a1a2e' : 'var(--text-primary)'};">
                <div style="font-size: 14px; line-height: 1.4;">${escapeHtml(msg.message)}</div>
                <div style="font-size: 10px; opacity: 0.7; margin-top: 4px; text-align: right;">${time}</div>
              </div>
            </div>`;
        }).join('');

        // Scroll to bottom
        container.scrollTop = container.scrollHeight;
      } catch (err) {
        console.error('Error loading messages:', err);
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Failed to load messages</div>';
      }
    }

    async function sendCollaboratorMessage() {
      const input = document.getElementById('collaborator-message-input');
      const message = input.value.trim();
      if (!message || !currentChatCollaborator) return;

      const channel = document.querySelector('input[name="collab-msg-channel"]:checked')?.value || 'in_app';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Insert message
        const { error: insertError } = await supabaseClient
          .from('collaborator_messages')
          .insert({
            sender_id: user.id,
            recipient_id: currentChatCollaborator.id,
            message: message,
            channel: channel
          });

        if (insertError) throw insertError;

        // Clear input and reload messages
        input.value = '';
        loadCollaboratorMessages(currentChatCollaborator.id);

        // Send email if channel is email
        if (channel === 'email' && currentChatCollaborator.email) {
          try {
            const { data: { session } } = await supabaseClient.auth.getSession();
            await fetch('https://surprise-granite-email-api.onrender.com/api/send-collaborator-message', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                ...(session?.access_token ? { 'Authorization': `Bearer ${session.access_token}` } : {})
              },
              body: JSON.stringify({
                to: currentChatCollaborator.email,
                senderName: userProfile?.full_name || user.email,
                recipientName: currentChatCollaborator.name,
                message: message
              })
            });
          } catch (emailErr) {
            console.warn('Email delivery failed:', emailErr);
          }
        }

        showToast('Message sent', 'success');
      } catch (err) {
        console.error('Error sending message:', err);
        showToast('Failed to send message', 'error');
      }
    }

    // =============================================
    // UNIVERSAL QUICK SCHEDULE SYSTEM
    // Works from anywhere: leads, jobs, customers, collaborators, projects, estimates
    // =============================================

    function quickSchedule(entityType, entityData = {}) {
      // Build prefill data based on entity type
      let prefillData = {};
      let suggestedTitle = 'Appointment';

      switch (entityType) {
        case 'lead':
          suggestedTitle = `Appointment - ${entityData.full_name || entityData.name || entityData.email || 'Lead'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'appointment',
            contactName: entityData.full_name || entityData.name || '',
            contactEmail: entityData.email || '',
            contactPhone: entityData.phone || '',
            location: entityData.address || '',
            leadId: entityData.id
          };
          break;

        case 'customer':
          suggestedTitle = `Appointment - ${entityData.name || entityData.email || 'Customer'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'appointment',
            contactName: entityData.name || '',
            contactEmail: entityData.email || '',
            contactPhone: entityData.phone || '',
            location: entityData.address || '',
            customerId: entityData.id
          };
          break;

        case 'job':
          suggestedTitle = `${entityData.job_number || 'Job'} - ${entityData.customer_name || entityData.description || ''}`;
          prefillData = {
            title: suggestedTitle,
            type: entityData.eventType || 'measurement',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            contactPhone: entityData.customer_phone || '',
            location: entityData.job_site_address || entityData.address || '',
            jobId: entityData.id,
            customerId: entityData.customer_id
          };
          break;

        case 'contractor':
          suggestedTitle = `Meeting - ${entityData.company_name || entityData.name || 'Contractor'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'meeting',
            contactName: entityData.contact_name || entityData.name || '',
            contactEmail: entityData.email || '',
            contactPhone: entityData.phone || ''
          };
          break;

        case 'project':
          suggestedTitle = `${entityData.name || entityData.title || 'Project'} - Meeting`;
          prefillData = {
            title: suggestedTitle,
            type: 'meeting',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            location: entityData.address || '',
            projectId: entityData.id,
            customerId: entityData.customer_id
          };
          break;

        case 'estimate':
          suggestedTitle = `Follow-up: ${entityData.estimate_number || 'Estimate'} - ${entityData.customer_name || ''}`;
          prefillData = {
            title: suggestedTitle,
            type: 'follow_up',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            contactPhone: entityData.customer_phone || '',
            customerId: entityData.customer_id
          };
          break;

        case 'invoice':
          suggestedTitle = `Payment Follow-up: ${entityData.invoice_number || 'Invoice'}`;
          prefillData = {
            title: suggestedTitle,
            type: 'follow_up',
            contactName: entityData.customer_name || '',
            contactEmail: entityData.customer_email || '',
            contactPhone: entityData.customer_phone || '',
            customerId: entityData.customer_id
          };
          break;

        default:
          // Generic scheduling
          prefillData = {
            title: entityData.title || '',
            type: entityData.type || 'appointment',
            contactName: entityData.contactName || entityData.name || '',
            contactEmail: entityData.contactEmail || entityData.email || '',
            contactPhone: entityData.contactPhone || entityData.phone || '',
            location: entityData.location || entityData.address || ''
          };
      }

      // Open the calendar modal with prefilled data
      openCalendarEventModal(null, null, prefillData);
    }

    // Quick schedule from current context (uses global selected* variables)
    function quickScheduleFromContext() {
      if (selectedLead) {
        quickSchedule('lead', selectedLead);
      } else if (selectedCustomer) {
        quickSchedule('customer', selectedCustomer);
      } else if (selectedJob) {
        quickSchedule('job', selectedJob);
      } else {
        // Just open empty modal
        openCalendarEventModal();
      }
    }

    // Schedule for current job (from job detail modal)
    function scheduleForCurrentJob() {
      const jobData = {
        id: document.getElementById('job-detail-id')?.value,
        job_number: document.getElementById('job-detail-number')?.textContent,
        customer_name: document.getElementById('job-customer-name-display')?.textContent,
        customer_email: document.getElementById('job-customer-email-display')?.textContent,
        customer_phone: document.getElementById('job-customer-phone-display')?.textContent,
        job_site_address: document.getElementById('job-customer-address-display')?.textContent
      };
      quickSchedule('job', jobData);
    }

    // Schedule with contractor
    function scheduleWithContractor(contractorId) {
      const contractor = allCollaborators.find(c => c.id === contractorId);
      if (contractor) {
        quickSchedule('contractor', contractor);
      }
    }

    // Schedule follow-up for estimate
    function scheduleForEstimate(estimateId, estimateNumber, customerName, customerEmail) {
      quickSchedule('estimate', {
        id: estimateId,
        estimate_number: estimateNumber,
        customer_name: customerName,
        customer_email: customerEmail
      });
    }

    // Schedule follow-up for invoice
    function scheduleForInvoice(invoiceId, invoiceNumber, customerName, customerEmail) {
      quickSchedule('invoice', {
        id: invoiceId,
        invoice_number: invoiceNumber,
        customer_name: customerName,
        customer_email: customerEmail
      });
    }

    // Schedule for project
    function scheduleForProject(projectId) {
      const project = allProjects?.find(p => p.id === projectId);
      if (project) {
        quickSchedule('project', project);
      }
    }

    // Quick change project status
    function quickChangeProjectStatus(projectId, currentStatus) {
      const statuses = ['lead', 'approved', 'scheduled', 'in_progress', 'completed', 'on_hold', 'cancelled'];

      const modal = document.createElement('div');
      modal.id = 'quick-project-status-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; min-width: 260px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin: 0 0 16px; font-size: 14px; color: var(--text-primary);">Change Project Status</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${statuses.map(s => {
              const color = PROJECT_STATUS_COLORS[s] || '#6b7280';
              return `
                <button onclick="setProjectStatusQuick('${projectId}', '${s}')"
                        style="display: flex; align-items: center; gap: 10px; padding: 10px 14px; background: ${s === currentStatus ? color + '20' : 'var(--dark-elevated)'}; border: 1px solid ${s === currentStatus ? color : 'var(--border-subtle)'}; border-radius: 8px; cursor: pointer; transition: all 0.15s; color: ${s === currentStatus ? color : 'var(--text-secondary)'};"
                        onmouseover="this.style.borderColor='${color}'"
                        onmouseout="this.style.borderColor='${s === currentStatus ? color : 'var(--border-subtle)'}'"
                >
                  <span style="width: 10px; height: 10px; border-radius: 50%; background: ${color};"></span>
                  <span style="font-weight: 500;">${PROJECT_STATUS_LABELS[s] || s}</span>
                  ${s === currentStatus ? '<span style="margin-left: auto; font-size: 11px;">Current</span>' : ''}
                </button>
              `;
            }).join('')}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function setProjectStatusQuick(projectId, newStatus) {
      document.getElementById('quick-project-status-modal')?.remove();

      try {
        const { error } = await supabaseClient
          .from('projects')
          .update({ status: newStatus, updated_at: new Date().toISOString() })
          .eq('id', projectId);

        if (error) throw error;

        // Update local data
        const project = allProjects?.find(p => p.id === projectId);
        if (project) project.status = newStatus;

        renderProjectsList();
        renderProjectsKanban();
        showToast(`Project status changed to ${PROJECT_STATUS_LABELS[newStatus] || newStatus}`, 'success');
      } catch (err) {
        console.error('Error updating project status:', err);
        showToast('Failed to update status', 'error');
      }
    }

    // Quick add task to project
    function quickAddProjectTask(projectId) {
      const modal = document.createElement('div');
      modal.id = 'quick-add-task-modal';
      modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div style="background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 20px; min-width: 340px; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
          <h3 style="margin: 0 0 16px; font-size: 14px; color: var(--text-primary);">Add Task</h3>
          <form onsubmit="submitQuickTask('${projectId}', this); return false;">
            <input type="text" name="title" placeholder="Task title..." required autofocus
                   style="width: 100%; padding: 10px 14px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark-elevated); color: var(--text-primary); font-size: 14px; margin-bottom: 12px; box-sizing: border-box;">
            <div style="display: flex; gap: 8px;">
              <button type="button" onclick="document.getElementById('quick-add-task-modal').remove()"
                      style="flex: 1; padding: 10px; border: 1px solid var(--border-subtle); border-radius: 8px; background: var(--dark-elevated); color: var(--text-secondary); cursor: pointer; font-size: 13px;">
                Cancel
              </button>
              <button type="submit"
                      style="flex: 1; padding: 10px; border: none; border-radius: 8px; background: var(--gold-primary); color: var(--dark-primary); cursor: pointer; font-weight: 600; font-size: 13px;">
                Add Task
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
      setTimeout(() => modal.querySelector('input')?.focus(), 100);
    }

    async function submitQuickTask(projectId, form) {
      const title = form.querySelector('input[name="title"]').value.trim();
      if (!title) return;

      document.getElementById('quick-add-task-modal')?.remove();

      try {
        // Get max sort order
        const { data: existingTasks } = await supabaseClient
          .from('project_tasks')
          .select('sort_order')
          .eq('project_id', projectId)
          .order('sort_order', { ascending: false })
          .limit(1);

        const sortOrder = (existingTasks?.[0]?.sort_order || 0) + 1;

        const { error } = await supabaseClient
          .from('project_tasks')
          .insert({
            project_id: projectId,
            title,
            status: 'pending',
            sort_order: sortOrder
          });

        if (error) throw error;

        showToast('Task added', 'success');

        // If project detail is open, refresh it
        if (currentProjectId === projectId) {
          openProjectDetail(projectId);
        }

      } catch (err) {
        console.error('Error adding task:', err);
        showToast('Failed to add task', 'error');
      }
    }

    // =============================================
    // CALENDAR EVENTS (MULTI-PARTICIPANT)
    // =============================================

    async function openCalendarEventModal(eventId = null, preselectedDate = null, prefillData = null) {
      const form = document.getElementById('calendar-event-form');
      const title = document.getElementById('calendar-event-modal-title');
      form.reset();

      // Clear hidden ID fields
      document.getElementById('cal-event-id').value = eventId || '';
      document.getElementById('cal-event-lead').value = '';
      document.getElementById('cal-event-customer').value = '';
      document.getElementById('cal-event-job').value = '';
      document.getElementById('cal-event-project').value = '';

      // Reset participants
      eventParticipants = [];
      renderEventParticipantChips();

      // Reset contact search
      clearCalEventContact();

      // Reset meeting format to in_person and initialize location section
      const meetingFormatSelect = document.getElementById('cal-event-meeting-format');
      if (meetingFormatSelect) {
        meetingFormatSelect.value = 'in_person';
      }
      handleMeetingFormatChange();

      // Hide contact address option (will show if contact with address is selected)
      const contactAddressOption = document.getElementById('contact-address-option');
      const useContactCheckbox = document.getElementById('use-contact-address');
      if (contactAddressOption) contactAddressOption.style.display = 'none';
      if (useContactCheckbox) useContactCheckbox.checked = false;

      // Clear video/conference fields
      const videoLink = document.getElementById('cal-event-video-link');
      const videoPlatform = document.getElementById('cal-event-video-platform');
      const confNumber = document.getElementById('cal-event-conference-number');
      const confCode = document.getElementById('cal-event-conference-code');
      const confPin = document.getElementById('cal-event-conference-pin');
      if (videoLink) videoLink.value = '';
      if (videoPlatform) videoPlatform.value = '';
      if (confNumber) confNumber.value = '';
      if (confCode) confCode.value = '';
      if (confPin) confPin.value = '';

      // Hide manual participant form
      const manualForm = document.getElementById('manual-participant-form');
      if (manualForm) manualForm.style.display = 'none';

      // Load contractors if not already loaded
      if (!allContractors || allContractors.length === 0) {
        await loadContractors();
      }

      // Populate dropdowns
      populateEventProjectDropdown();
      populateEventContractorsDropdown();

      // Add project change listener for "Add Project Team" button
      const projectSelect = document.getElementById('cal-event-project-select');
      if (projectSelect) {
        projectSelect.onchange = onProjectSelectChange;
        onProjectSelectChange(); // Initial state
      }

      if (eventId) {
        title.textContent = 'Edit Event';
        loadCalendarEventForEditSimple(eventId);
      } else {
        title.textContent = 'New Event';
        // Set default date/time
        const today = preselectedDate || new Date().toISOString().split('T')[0];
        document.getElementById('cal-event-start-date').value = today;
        document.getElementById('cal-event-end-date').value = today;
        document.getElementById('cal-event-start-time').value = '09:00';
        document.getElementById('cal-event-end-time').value = '10:00';

        // Apply prefill data if provided
        if (prefillData) {
          if (prefillData.title) document.getElementById('cal-event-title').value = prefillData.title;
          if (prefillData.type) document.getElementById('cal-event-type').value = prefillData.type;
          if (prefillData.meetingFormat) {
            document.getElementById('cal-event-meeting-format').value = prefillData.meetingFormat;
            handleMeetingFormatChange();
          }
          // If prefill has contact info, set as selected contact
          if (prefillData.contactName) {
            selectCalEventContact(
              prefillData.contactType || 'lead',
              prefillData.contactId || prefillData.leadId || null,
              prefillData.contactName,
              prefillData.contactEmail || '',
              prefillData.contactPhone || '',
              prefillData.contactAddress || prefillData.location || ''
            );
            // selectCalEventContact already handles showing the contact address option
            // and auto-filling the location field
          }
          if (prefillData.location && !prefillData.contactName) {
            document.getElementById('cal-event-location').value = prefillData.location;
          }
          if (prefillData.leadId) document.getElementById('cal-event-lead').value = prefillData.leadId;
          if (prefillData.customerId) document.getElementById('cal-event-customer').value = prefillData.customerId;
          if (prefillData.jobId) document.getElementById('cal-event-job').value = prefillData.jobId;
          if (prefillData.projectId) document.getElementById('cal-event-project').value = prefillData.projectId;
        }
      }

      document.getElementById('calendar-event-modal').classList.add('active');

      // Initialize Google Places autocomplete on location input
      if (googleMapsReady && !locationAutocomplete) {
        const locationInput = document.getElementById('cal-event-location');
        if (locationInput) {
          initLocationAutocomplete(locationInput);
        }
      }

      // Hide map preview when opening modal (will show when address selected)
      hideLocationMapPreview();
    }

    // ============================================
    // CALENDAR EVENT CONTACT SEARCH
    // Search leads, customers, and contractors for contact auto-fill
    // ============================================
    let calEventContactsCache = [];

    async function loadCalEventContacts() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return [];

        calEventContactsCache = [];

        // Load leads (RLS handles user filtering)
        const { data: leads } = await supabaseClient
          .from('leads')
          .select('id, full_name, email, phone, address, city, state')
          .limit(200);

        (leads || []).forEach(l => {
          const address = [l.address, l.city, l.state].filter(Boolean).join(', ');
          calEventContactsCache.push({
            id: l.id,
            type: 'lead',
            name: l.full_name || l.email || 'Unknown Lead',
            email: l.email || '',
            phone: l.phone || '',
            address: address,
            label: 'Lead'
          });
        });

        // Load customers
        const { data: customers } = await supabaseClient
          .from('customers')
          .select('id, name, email, phone, address, city, state')
          .eq('user_id', user.id)
          .limit(200);

        (customers || []).forEach(c => {
          const address = [c.address, c.city, c.state].filter(Boolean).join(', ');
          calEventContactsCache.push({
            id: c.id,
            type: 'customer',
            name: c.name || c.email || 'Unknown Customer',
            email: c.email || '',
            phone: c.phone || '',
            address: address,
            label: 'Customer'
          });
        });

        // Load collaborators/contractors
        try {
          const { data: collaborators } = await supabaseClient
            .from('general_collaborators')
            .select('id, name, email, phone, company, role')
            .eq('invited_by', user.id)
            .eq('status', 'active')
            .limit(200);

          (collaborators || []).forEach(c => {
            calEventContactsCache.push({
              id: c.id,
              type: 'contractor',
              name: c.name || c.email || 'Unknown',
              email: c.email || '',
              phone: c.phone || '',
              address: c.company || '',
              label: c.role ? c.role.charAt(0).toUpperCase() + c.role.slice(1) : 'Contractor'
            });
          });
        } catch (e) {
          console.warn('[CalEvent] Collaborators table not available');
        }

        return calEventContactsCache;

      } catch (err) {
        console.error('[CalEvent] Failed to load contacts:', err);
        return [];
      }
    }

    async function searchCalEventContacts(query) {
      const suggestionsEl = document.getElementById('cal-event-contact-suggestions');
      if (!suggestionsEl) return;

      // Load contacts if not cached
      if (calEventContactsCache.length === 0) {
        suggestionsEl.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--text-muted);">Loading contacts...</div>';
        suggestionsEl.style.display = 'block';
        await loadCalEventContacts();
      }

      const q = (query || '').toLowerCase().trim();

      // Filter contacts
      let filtered = calEventContactsCache.filter(c => {
        if (!q) return true;
        return (c.name || '').toLowerCase().includes(q) ||
               (c.email || '').toLowerCase().includes(q) ||
               (c.phone || '').includes(q) ||
               (c.label || '').toLowerCase().includes(q);
      }).slice(0, 10);

      // Build suggestions HTML
      let html = '';

      const labelColors = {
        Lead: '#f59e0b',
        Customer: '#10b981',
        Contractor: '#3b82f6',
        Fabricator: '#8b5cf6',
        Installer: '#f97316',
        Plumber: '#06b6d4',
        Designer: '#ec4899'
      };

      if (filtered.length > 0) {
        filtered.forEach(c => {
          const initials = (c.name || '?').split(' ').map(n => n[0]).join('').slice(0, 2).toUpperCase();
          const color = labelColors[c.label] || '#6b7280';
          const addressStr = c.address ? c.address : '';
          html += `
            <div class="cal-contact-suggestion" onclick="selectCalEventContact('${c.type}', '${c.id}', '${escapeHtml(c.name)}', '${escapeHtml(c.email)}', '${escapeHtml(c.phone)}', '${escapeHtml(addressStr)}')" style="display: flex; align-items: center; gap: 10px; padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.15s;" onmouseover="this.style.background='var(--dark-tertiary)'" onmouseout="this.style.background='transparent'">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: ${color}22; color: ${color}; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px;">${initials}</div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(c.name)}</div>
                <div style="font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${c.email || c.phone || 'No contact info'}</div>
              </div>
              <span style="font-size: 10px; padding: 3px 8px; border-radius: 12px; background: ${color}22; color: ${color}; text-transform: uppercase; white-space: nowrap;">${c.label}</span>
            </div>
          `;
        });
      } else if (q) {
        // Allow manual entry
        html = `
          <div style="padding: 12px; text-align: center; color: var(--text-muted);">
            No contacts found matching "${escapeHtml(q)}"<br>
            <small>Type email or phone, or fill fields manually below</small>
          </div>
        `;
      } else {
        html = '<div style="padding: 12px; text-align: center; color: var(--text-muted);">Type to search leads, customers, contractors...</div>';
      }

      suggestionsEl.innerHTML = html;
      suggestionsEl.style.display = 'block';
    }

    // Store selected contact data for location display
    let selectedContactData = {
      name: '',
      email: '',
      phone: '',
      address: ''
    };

    function selectCalEventContact(type, id, name, email, phone, address) {
      // Store contact data
      selectedContactData = { name, email, phone, address };

      // Set hidden fields
      document.getElementById('cal-event-contact-type').value = type || '';
      document.getElementById('cal-event-contact-id').value = id || '';

      // Set visible fields
      document.getElementById('cal-event-contact-email').value = email || '';
      document.getElementById('cal-event-contact-phone').value = phone || '';

      // Update contact address option visibility
      updateContactAddressOption();

      // Auto-fill location if contact has address
      const locationField = document.getElementById('cal-event-location');
      if (address && locationField) {
        locationField.value = address;
        // Check the "use contact address" checkbox
        const useContactCheckbox = document.getElementById('use-contact-address');
        if (useContactCheckbox) useContactCheckbox.checked = true;
        // Show map preview for the address
        if (googleMapsReady) {
          geocodeAndShowMapPreview(address);
        }
      }

      // Update phone call display
      updatePhoneCallDisplay(phone);

      // Show selected contact chip
      const chip = document.getElementById('cal-event-contact-chip');
      const chipName = document.getElementById('cal-event-contact-chip-name');
      const chipBadge = document.getElementById('cal-event-contact-chip-badge');
      const searchInput = document.getElementById('cal-event-contact-search');
      const suggestions = document.getElementById('cal-event-contact-suggestions');

      chipName.textContent = name;
      chipBadge.textContent = type === 'lead' ? 'Lead' : type === 'customer' ? 'Customer' : type === 'contractor' ? 'Contractor' : 'Contact';
      chip.style.display = 'block';
      searchInput.style.display = 'none';
      suggestions.style.display = 'none';

      // Also link to lead/customer if appropriate
      if (type === 'lead' && id) {
        document.getElementById('cal-event-lead').value = id;
      } else if (type === 'customer' && id) {
        document.getElementById('cal-event-customer').value = id;
      }

      console.log('[CalEvent] Selected contact:', { type, id, name, email, phone, address });
    }

    // Handle meeting format change
    function handleMeetingFormatChange() {
      const format = document.getElementById('cal-event-meeting-format').value;

      // Hide all location sections
      document.getElementById('location-in-person').style.display = 'none';
      document.getElementById('location-phone-call').style.display = 'none';
      document.getElementById('location-video-call').style.display = 'none';
      document.getElementById('location-conference-call').style.display = 'none';

      // Show appropriate section
      switch (format) {
        case 'in_person':
          document.getElementById('location-in-person').style.display = 'block';
          break;
        case 'phone_call':
          document.getElementById('location-phone-call').style.display = 'block';
          // Update phone display with current contact phone
          const phoneField = document.getElementById('cal-event-contact-phone');
          updatePhoneCallDisplay(phoneField ? phoneField.value : '');
          break;
        case 'video_call':
          document.getElementById('location-video-call').style.display = 'block';
          break;
        case 'conference_call':
          document.getElementById('location-conference-call').style.display = 'block';
          break;
        default:
          document.getElementById('location-in-person').style.display = 'block';
      }
    }

    // Handle "Use contact address" checkbox change
    function handleUseContactAddress() {
      const checkbox = document.getElementById('use-contact-address');
      const locationField = document.getElementById('cal-event-location');

      if (checkbox && checkbox.checked && selectedContactData.address) {
        // Fill location with contact address
        if (locationField) {
          locationField.value = selectedContactData.address;
        }
        // Show map preview for the address
        if (googleMapsReady) {
          geocodeAndShowMapPreview(selectedContactData.address);
        }
      } else {
        // If unchecked, hide map preview
        hideLocationMapPreview();
      }
    }

    // Geocode address and show map preview
    function geocodeAndShowMapPreview(address) {
      if (!googleMapsReady || !google?.maps) return;

      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: address }, (results, status) => {
        if (status === 'OK' && results[0]) {
          updateLocationMapPreview({
            formatted_address: results[0].formatted_address,
            geometry: { location: results[0].geometry.location }
          });
        }
      });
    }

    // Show/hide contact address option based on whether contact has address
    function updateContactAddressOption() {
      const contactAddressOption = document.getElementById('contact-address-option');
      const contactAddressText = document.getElementById('contact-address-text');
      const useContactCheckbox = document.getElementById('use-contact-address');

      if (selectedContactData.address && contactAddressOption) {
        contactAddressOption.style.display = 'block';
        if (contactAddressText) {
          contactAddressText.textContent = selectedContactData.address;
        }
      } else if (contactAddressOption) {
        contactAddressOption.style.display = 'none';
        if (useContactCheckbox) useContactCheckbox.checked = false;
      }
    }

    // Update phone call display
    function updatePhoneCallDisplay(phone) {
      const phoneDisplay = document.getElementById('phone-call-display');
      const phoneHidden = document.getElementById('cal-event-location-phone');
      if (phoneDisplay) {
        if (phone) {
          phoneDisplay.innerHTML = `<a href="tel:${phone}" style="color: var(--gold-primary); text-decoration: none;">${phone}</a>`;
        } else {
          phoneDisplay.textContent = 'No phone number set - add in contact fields above';
        }
      }
      if (phoneHidden) phoneHidden.value = phone || '';
    }

    // Handle video platform change
    function handleVideoPlatformChange() {
      const platform = document.getElementById('cal-event-video-platform').value;
      const linkField = document.getElementById('cal-event-video-link');
      if (linkField) {
        switch (platform) {
          case 'zoom':
            linkField.placeholder = 'Paste Zoom meeting link';
            break;
          case 'google_meet':
            linkField.placeholder = 'Paste Google Meet link';
            break;
          case 'teams':
            linkField.placeholder = 'Paste Teams meeting link';
            break;
          case 'facetime':
            linkField.placeholder = 'FaceTime will use contact phone/email';
            break;
          default:
            linkField.placeholder = 'Meeting link (optional)';
        }
      }
    }

    // Watch for phone field changes to update phone call display
    document.addEventListener('DOMContentLoaded', function() {
      const phoneField = document.getElementById('cal-event-contact-phone');
      if (phoneField) {
        phoneField.addEventListener('input', function() {
          updatePhoneCallDisplay(this.value);
        });
      }

      // Add meeting format change listener
      const meetingFormatSelect = document.getElementById('cal-event-meeting-format');
      if (meetingFormatSelect) {
        meetingFormatSelect.addEventListener('change', handleMeetingFormatChange);
      }
    });

    function clearCalEventContact() {
      // Clear stored contact data
      selectedContactData = { name: '', email: '', phone: '', address: '' };

      // Clear hidden fields
      const typeField = document.getElementById('cal-event-contact-type');
      const idField = document.getElementById('cal-event-contact-id');
      if (typeField) typeField.value = '';
      if (idField) idField.value = '';

      // Clear visible fields
      const emailField = document.getElementById('cal-event-contact-email');
      const phoneField = document.getElementById('cal-event-contact-phone');
      if (emailField) emailField.value = '';
      if (phoneField) phoneField.value = '';

      // Hide contact address option and uncheck
      const contactAddressOption = document.getElementById('contact-address-option');
      const useContactCheckbox = document.getElementById('use-contact-address');
      if (contactAddressOption) contactAddressOption.style.display = 'none';
      if (useContactCheckbox) useContactCheckbox.checked = false;

      // Clear phone call display
      updatePhoneCallDisplay('');

      // Hide chip, show search
      const chip = document.getElementById('cal-event-contact-chip');
      const searchInput = document.getElementById('cal-event-contact-search');
      const suggestions = document.getElementById('cal-event-contact-suggestions');

      if (chip) chip.style.display = 'none';
      if (searchInput) {
        searchInput.style.display = 'block';
        searchInput.value = '';
      }
      if (suggestions) suggestions.style.display = 'none';
    }

    // Close contact suggestions when clicking outside
    document.addEventListener('click', function(e) {
      const suggestions = document.getElementById('cal-event-contact-suggestions');
      const searchInput = document.getElementById('cal-event-contact-search');
      if (suggestions && searchInput && !suggestions.contains(e.target) && e.target !== searchInput) {
        suggestions.style.display = 'none';
      }
    });

    // Load event for editing (simplified version)
    async function loadCalendarEventForEditSimple(eventId) {
      try {
        const { data: event, error } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('id', eventId)
          .single();

        if (error) throw error;

        document.getElementById('cal-event-title').value = event.title || '';
        document.getElementById('cal-event-type').value = event.event_type || 'appointment';

        if (event.start_time) {
          const start = new Date(event.start_time);
          // Use local date/time (not UTC) for form fields
          const startYear = start.getFullYear();
          const startMonth = String(start.getMonth() + 1).padStart(2, '0');
          const startDay = String(start.getDate()).padStart(2, '0');
          const startHours = String(start.getHours()).padStart(2, '0');
          const startMins = String(start.getMinutes()).padStart(2, '0');
          document.getElementById('cal-event-start-date').value = `${startYear}-${startMonth}-${startDay}`;
          document.getElementById('cal-event-start-time').value = `${startHours}:${startMins}`;
        }
        if (event.end_time) {
          const end = new Date(event.end_time);
          // Use local date/time (not UTC) for form fields
          const endYear = end.getFullYear();
          const endMonth = String(end.getMonth() + 1).padStart(2, '0');
          const endDay = String(end.getDate()).padStart(2, '0');
          const endHours = String(end.getHours()).padStart(2, '0');
          const endMins = String(end.getMinutes()).padStart(2, '0');
          document.getElementById('cal-event-end-date').value = `${endYear}-${endMonth}-${endDay}`;
          document.getElementById('cal-event-end-time').value = `${endHours}:${endMins}`;
        }

        document.getElementById('cal-event-description').value = event.description || '';

        // Load meeting format from metadata and trigger change handler
        const meetingFormat = event.metadata?.meeting_format || 'in_person';
        document.getElementById('cal-event-meeting-format').value = meetingFormat;
        handleMeetingFormatChange();

        // Load meeting details from metadata
        if (event.metadata && event.metadata.meeting_details) {
          const details = event.metadata.meeting_details;
          // Video call details
          if (details.video_platform) {
            const videoPlatform = document.getElementById('cal-event-video-platform');
            if (videoPlatform) videoPlatform.value = details.video_platform;
          }
          if (details.video_link) {
            const videoLink = document.getElementById('cal-event-video-link');
            if (videoLink) videoLink.value = details.video_link;
          }
          // Conference call details
          if (details.conference_number) {
            const confNumber = document.getElementById('cal-event-conference-number');
            if (confNumber) confNumber.value = details.conference_number;
          }
          if (details.conference_code) {
            const confCode = document.getElementById('cal-event-conference-code');
            if (confCode) confCode.value = details.conference_code;
          }
          if (details.conference_pin) {
            const confPin = document.getElementById('cal-event-conference-pin');
            if (confPin) confPin.value = details.conference_pin;
          }
        }

        // Set location for in-person meetings
        document.getElementById('cal-event-location').value = event.location || '';

        // Load contact info from metadata
        if (event.metadata) {
          const contactName = event.metadata.contact_name || '';
          const contactEmail = event.metadata.contact_email || '';
          const contactPhone = event.metadata.contact_phone || '';
          const contactType = event.metadata.contact_type || 'manual';
          const contactId = event.metadata.contact_id || null;

          if (contactName || contactEmail || contactPhone) {
            // Extract address from location for in-person meetings
            const contactAddress = (meetingFormat === 'in_person') ? (event.location || '') : '';
            selectCalEventContact(contactType, contactId, contactName, contactEmail, contactPhone, contactAddress);
          }
        }

        // Set linked entity IDs
        if (event.lead_id) document.getElementById('cal-event-lead').value = event.lead_id;
        if (event.customer_id) document.getElementById('cal-event-customer').value = event.customer_id;
        if (event.job_id) document.getElementById('cal-event-job').value = event.job_id;
        // Use project_id if available, fallback to job_id for backward compatibility
        const projectIdToUse = event.project_id || event.job_id;
        if (projectIdToUse) {
          document.getElementById('cal-event-project').value = projectIdToUse;
          const projectSelect = document.getElementById('cal-event-project-select');
          if (projectSelect) {
            projectSelect.value = projectIdToUse;
            onProjectSelectChange();
          }
        }

        // Load existing participants
        const { data: participants } = await supabaseClient
          .from('calendar_event_participants')
          .select('id, name, email, phone, participant_type, response_status')
          .eq('event_id', eventId);

        if (participants && participants.length > 0) {
          eventParticipants = participants.map(p => ({
            name: p.name || p.email,
            email: p.email,
            phone: p.phone || '',
            role: p.participant_type === 'customer' ? 'customer' : 'contractor',
            participant_type: p.participant_type || 'attendee'
          }));
          renderEventParticipantChips();
        }

      } catch (err) {
        console.error('Error loading event:', err);
        showToast('Failed to load event', 'error');
      }
    }

    // Quick schedule from lead card (without opening lead detail first)
    function openScheduleLeadModal(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const leadName = lead.full_name || lead.homeowner_name || lead.name || lead.email || 'Lead';
      const leadEmail = lead.email || lead.homeowner_email || '';
      const leadPhone = lead.phone || lead.homeowner_phone || '';
      // Build full address from available fields
      const addressParts = [
        lead.address || lead.project_address,
        lead.city,
        lead.state,
        lead.zip
      ].filter(Boolean);
      const leadAddress = addressParts.join(', ');

      openCalendarEventModal(null, null, {
        title: `Appointment - ${leadName}`,
        type: 'appointment',
        meetingFormat: 'in_person',
        contactType: 'lead',
        contactId: leadId,
        contactName: leadName,
        contactEmail: leadEmail,
        contactPhone: leadPhone,
        contactAddress: leadAddress,
        location: leadAddress,
        leadId: leadId
      });
    }

    // Schedule appointment for a specific lead (called from lead modal)
    function scheduleAppointmentForLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'warning');
        return;
      }

      closeLeadModal();

      // Get lead name from various possible field names
      const leadName = selectedLead.full_name || selectedLead.homeowner_name || selectedLead.name || selectedLead.email || 'Lead';
      const leadEmail = selectedLead.email || selectedLead.homeowner_email || '';
      const leadPhone = selectedLead.phone || selectedLead.homeowner_phone || '';
      const leadAddress = formatAddressFromData(selectedLead);

      // Open modal with pre-filled data
      openCalendarEventModal(null, null, {
        title: `Appointment - ${leadName}`,
        type: 'appointment',
        contactName: leadName,
        contactEmail: leadEmail,
        contactPhone: leadPhone,
        location: leadAddress,
        leadId: selectedLead.id
      });
    }

    function closeCalendarEventModal() {
      document.getElementById('calendar-event-modal').classList.remove('active');
    }

    // =============================================
    // WORKFLOW SCHEDULING (Multi-Event)
    // =============================================
    let workflowLeadData = null;
    let workflowSelectedContractors = [];

    async function openWorkflowScheduleModal(leadOrCustomer = null) {
      const modal = document.getElementById('workflow-schedule-modal');
      if (!modal) return;

      // Load contractors if needed
      if (!allContractors || allContractors.length === 0) {
        await loadContractors();
      }

      // Use provided data or selected lead
      workflowLeadData = leadOrCustomer || selectedLead;
      if (!workflowLeadData) {
        showToast('No lead or customer selected', 'warning');
        return;
      }

      // Reset form
      document.getElementById('workflow-schedule-form').reset();
      document.getElementById('workflow-lead-id').value = workflowLeadData.id || '';
      workflowSelectedContractors = [];

      // Populate customer info
      const name = workflowLeadData.full_name || workflowLeadData.name || workflowLeadData.homeowner_name || 'Customer';
      const email = workflowLeadData.email || workflowLeadData.homeowner_email || '';
      const phone = workflowLeadData.phone || workflowLeadData.homeowner_phone || '';
      const address = formatAddressFromData(workflowLeadData);

      document.getElementById('workflow-customer-avatar').textContent = name.charAt(0).toUpperCase();
      document.getElementById('workflow-customer-name').textContent = name;
      document.getElementById('workflow-customer-details').textContent = [email, phone].filter(Boolean).join(' • ') || 'No contact info';
      document.getElementById('workflow-customer-address').textContent = address || 'No address provided';
      document.getElementById('workflow-homeowner-email').textContent = email || 'No email';

      // Setup event toggle listeners
      const eventTypes = ['template', 'demo', 'fabrication', 'installation', 'plumbing', 'sealer'];
      eventTypes.forEach(type => {
        const checkbox = document.getElementById(`workflow-include-${type}`);
        if (checkbox) {
          checkbox.onchange = updateWorkflowDates;
        }
      });

      // Render date inputs
      updateWorkflowDates();

      // Render contractors list
      renderWorkflowContractors();

      // Update summary
      updateWorkflowSummary();

      modal.classList.add('active');
    }

    function closeWorkflowScheduleModal() {
      document.getElementById('workflow-schedule-modal').classList.remove('active');
      workflowLeadData = null;
      workflowSelectedContractors = [];
    }

    function updateWorkflowDates() {
      const container = document.getElementById('workflow-dates-container');
      if (!container) return;

      const events = getSelectedWorkflowEvents();
      const today = new Date();
      let currentDate = new Date(today);

      container.innerHTML = events.map((evt, idx) => {
        // Suggest dates based on typical workflow
        if (idx > 0) {
          if (evt.type === 'fabrication') {
            currentDate.setDate(currentDate.getDate() + 5); // 5 days after template
          } else if (evt.type === 'installation') {
            currentDate.setDate(currentDate.getDate() + 1); // Day after fabrication
          } else {
            currentDate.setDate(currentDate.getDate() + 1);
          }
        }
        const dateStr = currentDate.toISOString().split('T')[0];

        return `
          <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; border: 1px solid var(--border-color);">
            <div style="font-size: 20px;">${evt.icon}</div>
            <div style="flex: 1;">
              <div style="font-weight: 500; font-size: 13px; color: var(--text-primary);">${evt.label}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${evt.description}</div>
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="date" id="workflow-date-${evt.type}" class="input-modern" value="${dateStr}" style="width: 140px; font-size: 13px; padding: 6px 10px;" onchange="updateWorkflowSummary()">
              <input type="time" id="workflow-time-${evt.type}" class="input-modern" value="${evt.defaultTime}" style="width: 100px; font-size: 13px; padding: 6px 10px;">
            </div>
          </div>
        `;
      }).join('');

      updateWorkflowSummary();
    }

    function getSelectedWorkflowEvents() {
      const events = [];

      if (document.getElementById('workflow-include-template')?.checked) {
        events.push({ type: 'template', icon: '📐', label: 'Template/Measure', description: 'On-site measurement', defaultTime: '09:00', eventType: 'template' });
      }
      if (document.getElementById('workflow-include-demo')?.checked) {
        events.push({ type: 'demo', icon: '🔨', label: 'Demo/Tear-out', description: 'Remove existing countertops', defaultTime: '08:00', eventType: 'site_visit' });
      }
      if (document.getElementById('workflow-include-fabrication')?.checked) {
        events.push({ type: 'fabrication', icon: '⚙️', label: 'Fabrication', description: 'Cut & polish at shop', defaultTime: '07:00', eventType: 'fabrication' });
      }
      if (document.getElementById('workflow-include-installation')?.checked) {
        events.push({ type: 'installation', icon: '🔧', label: 'Installation', description: 'Install at customer site', defaultTime: '08:00', eventType: 'installation' });
      }
      if (document.getElementById('workflow-include-plumbing')?.checked) {
        events.push({ type: 'plumbing', icon: '🚿', label: 'Plumbing', description: 'Disconnect & reconnect', defaultTime: '07:30', eventType: 'plumbing_disconnect' });
      }
      if (document.getElementById('workflow-include-sealer')?.checked) {
        events.push({ type: 'sealer', icon: '💧', label: 'Sealer Application', description: 'Apply protective sealer', defaultTime: '10:00', eventType: 'sealer_application' });
      }

      return events;
    }

    function renderWorkflowContractors() {
      const container = document.getElementById('workflow-contractors-list');
      if (!container) return;

      if (!allContractors || allContractors.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">
            <div style="font-size: 12px;">No contractors found</div>
            <button type="button" class="btn-modern ghost" style="margin-top: 8px; font-size: 11px; padding: 6px 12px;" onclick="openAddContractorFromWorkflow()">+ Add Contractor</button>
          </div>
        `;
        return;
      }

      container.innerHTML = allContractors.map(c => {
        const name = c.name || c.company || c.email || 'Unknown';
        const specialty = c.specialty || 'Contractor';
        const email = c.email || '';
        const phone = c.phone || '';

        return `
          <label style="display: flex; align-items: center; gap: 10px; padding: 8px 10px; background: var(--dark-elevated); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border-color)'">
            <input type="checkbox" class="workflow-contractor-checkbox" data-id="${c.id}" data-name="${escapeHtml(name)}" data-email="${escapeHtml(email)}" data-phone="${escapeHtml(phone)}" data-specialty="${escapeHtml(specialty)}" style="width: 16px; height: 16px; accent-color: var(--primary);" onchange="updateWorkflowParticipantCount()">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 500; font-size: 13px; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(email || phone || 'No contact')}</div>
            </div>
            <span style="font-size: 10px; padding: 2px 6px; background: var(--dark-tertiary); color: var(--text-muted); border-radius: 4px;">${escapeHtml(specialty)}</span>
          </label>
        `;
      }).join('');
    }

    function updateWorkflowParticipantCount() {
      const checkboxes = document.querySelectorAll('.workflow-contractor-checkbox:checked');
      const homeownerChecked = document.getElementById('workflow-invite-homeowner')?.checked ? 1 : 0;
      const count = checkboxes.length + homeownerChecked;
      document.getElementById('workflow-participant-count').textContent = `${count} selected`;
    }

    function updateWorkflowSummary() {
      const events = getSelectedWorkflowEvents();
      const summary = document.getElementById('workflow-event-summary');
      if (summary) {
        summary.textContent = `${events.length} event${events.length !== 1 ? 's' : ''} will be created`;
      }
    }

    async function submitWorkflowSchedule(event) {
      event.preventDefault();

      const submitBtn = document.getElementById('workflow-submit-btn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div> Creating events...';

      try {
        const events = getSelectedWorkflowEvents();
        if (events.length === 0) {
          showToast('Please select at least one event type', 'warning');
          return;
        }

        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Get participant info
        const participants = [];
        const homeownerEmail = workflowLeadData.email || workflowLeadData.homeowner_email;
        const homeownerName = workflowLeadData.full_name || workflowLeadData.name || workflowLeadData.homeowner_name || 'Customer';
        const homeownerPhone = workflowLeadData.phone || workflowLeadData.homeowner_phone || '';

        if (document.getElementById('workflow-invite-homeowner')?.checked && homeownerEmail) {
          participants.push({
            email: homeownerEmail,
            name: homeownerName,
            phone: homeownerPhone,
            role: 'customer',
            participant_type: 'attendee'
          });
        }

        // Add selected contractors
        document.querySelectorAll('.workflow-contractor-checkbox:checked').forEach(cb => {
          if (cb.dataset.email) {
            participants.push({
              email: cb.dataset.email,
              name: cb.dataset.name,
              phone: cb.dataset.phone || '',
              role: cb.dataset.specialty || 'contractor',
              participant_type: 'attendee'
            });
          }
        });

        const notes = document.getElementById('workflow-notes')?.value || '';
        const address = workflowLeadData.address || workflowLeadData.project_address || '';
        const sendEmail = document.getElementById('workflow-send-email')?.checked;
        const sendSms = document.getElementById('workflow-send-sms')?.checked;

        const createdEvents = [];

        // Create each event
        for (const evt of events) {
          const dateInput = document.getElementById(`workflow-date-${evt.type}`);
          const timeInput = document.getElementById(`workflow-time-${evt.type}`);
          if (!dateInput?.value) continue;

          const startTime = new Date(`${dateInput.value}T${timeInput?.value || '09:00'}:00`);
          const endTime = new Date(startTime.getTime() + 2 * 60 * 60 * 1000); // 2 hours default

          const eventData = {
            title: `${evt.label} - ${homeownerName}`,
            event_type: evt.eventType,
            start_time: startTime.toISOString(),
            end_time: endTime.toISOString(),
            location: evt.type === 'fabrication' ? 'Shop' : address,
            lead_id: workflowLeadData.id,
            notes: notes,
            status: 'scheduled',
            user_id: user.id,
            metadata: {
              contact_name: homeownerName,
              contact_email: homeownerEmail,
              contact_phone: homeownerPhone,
              workflow_type: evt.type
            }
          };

          // Insert event
          const { data: newEvent, error: eventError } = await supabaseClient
            .from('calendar_events')
            .insert(eventData)
            .select()
            .single();

          if (eventError) {
            console.error('Error creating event:', eventError);
            continue;
          }

          createdEvents.push({ ...newEvent, eventInfo: evt });

          // Add participants
          if (participants.length > 0 && newEvent) {
            const participantRecords = participants.map(p => ({
              event_id: newEvent.id,
              email: p.email,
              name: p.name,
              phone: p.phone,
              role: p.role,
              participant_type: p.participant_type,
              response_status: 'pending'
            }));

            await supabaseClient.from('calendar_event_participants').insert(participantRecords);
          }
        }

        // Send email invites if enabled
        if (sendEmail && createdEvents.length > 0) {
          await sendWorkflowInviteEmails(createdEvents, participants, homeownerName, address);
        }

        // Send SMS if enabled
        if (sendSms && createdEvents.length > 0) {
          await sendWorkflowSmsNotifications(createdEvents, participants);
        }

        showToast(`Created ${createdEvents.length} events and sent invitations!`, 'success');
        closeWorkflowScheduleModal();

        // Refresh calendar if visible
        if (typeof loadCalendarEvents === 'function') {
          loadCalendarEvents();
        }

      } catch (err) {
        console.error('Workflow schedule error:', err);
        showToast('Error creating events: ' + err.message, 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
          Schedule & Send Invites
        `;
      }
    }

    async function sendWorkflowInviteEmails(events, participants, customerName, address) {
      try {
        const API_BASE = window.API_BASE_URL || '';

        // Format events for email
        const eventsList = events.map(e => {
          const date = new Date(e.start_time);
          return {
            type: e.eventInfo.label,
            icon: e.eventInfo.icon,
            date: date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }),
            time: date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
            location: e.location || address
          };
        });

        // Send to each participant
        for (const participant of participants) {
          if (!participant.email) continue;

          const emailData = {
            to: participant.email,
            subject: `📅 Project Schedule - ${customerName}`,
            customerName: participant.name || participant.email,
            projectAddress: address,
            events: eventsList,
            role: participant.role
          };

          await fetch(`${API_BASE}/api/email/workflow-invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(emailData)
          });
        }

      } catch (err) {
        console.error('Error sending workflow emails:', err);
      }
    }

    async function sendWorkflowSmsNotifications(events, participants) {
      try {
        const API_BASE = window.API_BASE_URL || '';

        for (const participant of participants) {
          if (!participant.phone) continue;

          const firstEvent = events[0];
          const date = new Date(firstEvent.start_time);
          const message = `📅 You've been scheduled for ${events.length} event(s) starting ${date.toLocaleDateString()}. Check your email for details.`;

          await fetch(`${API_BASE}/api/sms/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              to: participant.phone,
              message: message
            })
          });
        }

      } catch (err) {
        console.error('Error sending SMS:', err);
      }
    }

    // Update the lead schedule button to use workflow modal
    function scheduleWorkflowForLead() {
      if (!selectedLead) {
        showToast('No lead selected', 'warning');
        return;
      }
      closeLeadModal();
      openJobScheduler(selectedLead);
    }

    // =============================================
    // PROFILE PANEL FUNCTIONS
    // =============================================
    let currentProfileData = null;
    let currentProfileType = 'lead'; // 'lead', 'customer', 'contractor'

    // Helper function to format address from JSON object or string
    function formatAddressFromData(data) {
      if (!data) return '';

      // Check for string addresses first (most common in older leads)
      if (data.project_address && typeof data.project_address === 'string' && data.project_address.trim()) {
        return data.project_address.trim();
      }
      if (data.address && typeof data.address === 'string' && data.address.trim()) {
        return data.address.trim();
      }

      // Check for JSON object addresses (newer leads)
      let addrObj = data.service_address || data.billing_address;

      // If it's a string (could be JSON string), try to parse it
      if (typeof addrObj === 'string' && addrObj.trim()) {
        try {
          addrObj = JSON.parse(addrObj);
        } catch (e) {
          // It's a plain string address, use it directly
          return addrObj.trim();
        }
      }

      // If it's an object, format it
      if (addrObj && typeof addrObj === 'object') {
        const parts = [];
        if (addrObj.street) parts.push(addrObj.street);
        if (addrObj.street2) parts.push(addrObj.street2);
        if (addrObj.city || addrObj.state || addrObj.zip) {
          const cityStateZip = [
            addrObj.city,
            addrObj.state,
            addrObj.zip
          ].filter(Boolean).join(addrObj.city && addrObj.state ? ', ' : ' ');
          if (cityStateZip) parts.push(cityStateZip);
        }
        if (parts.length > 0) return parts.join(', ');
      }

      // Build from individual fields if available (some forms use these)
      if (data.street || data.city) {
        const parts = [];
        if (data.street) parts.push(data.street);
        if (data.city) parts.push(data.city);
        if (data.state) parts.push(data.state);
        if (data.zip || data.zip_code) parts.push(data.zip || data.zip_code);
        if (parts.length > 0) return parts.join(', ');
      }

      return '';
    }

    function openProfilePanel(data, type = 'lead') {
      currentProfileData = data;
      currentProfileType = type;

      const name = data.full_name || data.name || data.homeowner_name || 'Unknown';
      const email = data.email || data.homeowner_email || '';
      const phone = data.phone || data.homeowner_phone || '';
      const address = formatAddressFromData(data);
      const status = data.status || 'new';
      const source = data.source || data.lead_source || '';
      const message = data.message || data.notes || '';


      // Set header info - Avatar with initials
      const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
      document.getElementById('profile-avatar').innerHTML = initials;

      // Show badge for qualified/won leads
      const badge = document.getElementById('profile-avatar-badge');
      if (badge) {
        badge.style.display = (status === 'qualified' || status === 'won') ? 'flex' : 'none';
      }

      document.getElementById('panel-profile-name').textContent = name;

      // Email with clickable link
      const emailLink = document.getElementById('panel-profile-email-link');
      const emailContainer = document.getElementById('panel-profile-email');
      if (email) {
        emailLink.textContent = email;
        emailLink.href = `mailto:${email}`;
        emailContainer.style.display = 'flex';
      } else {
        emailLink.textContent = 'No email';
        emailLink.href = '#';
        emailContainer.style.display = 'flex';
      }

      // Phone with clickable link
      const phoneLink = document.getElementById('panel-profile-phone-link');
      const phoneContainer = document.getElementById('panel-profile-phone');
      if (phone) {
        phoneLink.textContent = phone;
        phoneLink.href = `tel:${phone.replace(/\D/g, '')}`;
        phoneContainer.style.display = 'flex';
      } else {
        phoneLink.textContent = 'No phone';
        phoneLink.href = '#';
        phoneContainer.style.display = 'flex';
      }

      // Set status badge
      const statusEl = document.getElementById('profile-status');
      statusEl.className = 'profile-status-badge ' + status;
      const statusLabels = {
        'new': 'New Lead',
        'contacted': 'Contacted',
        'qualified': 'Qualified',
        'quoted': 'Quoted',
        'won': 'Won',
        'lost': 'Lost',
        'archived': 'Archived'
      };
      statusEl.textContent = statusLabels[status] || status.charAt(0).toUpperCase() + status.slice(1).replace('_', ' ');

      // Source tag
      const sourceTag = document.getElementById('profile-source-tag');
      const sourceText = document.getElementById('profile-source-text');
      if (source && sourceTag && sourceText) {
        sourceTag.style.display = 'inline-flex';
        sourceText.textContent = source;
      } else if (sourceTag) {
        sourceTag.style.display = 'none';
      }

      // Calculate days in pipeline
      const createdDate = data.created_at ? new Date(data.created_at) : new Date();
      const daysInPipeline = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
      document.getElementById('profile-stat-days').textContent = daysInPipeline;

      // Estimate value (from budget or default)
      const budget = data.budget_range || data.budget || '';
      let estValue = '$0';
      if (budget) {
        const match = budget.match(/\$?([\d,]+)/);
        if (match) estValue = '$' + match[1];
        else estValue = budget;
      }
      document.getElementById('profile-stat-value').textContent = estValue;

      // Set detail fields
      document.getElementById('profile-detail-email').textContent = email || '—';
      document.getElementById('profile-detail-phone').textContent = phone || '—';
      document.getElementById('profile-detail-address').textContent = address || '—';

      // Set address link and actions
      const addressLink = document.getElementById('profile-detail-address-link');
      const addressActions = document.getElementById('profile-address-actions');
      if (address && address !== '—') {
        addressLink.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
        addressLink.style.color = '#3b82f6';
        addressActions.style.display = 'flex';
        // Store address data for navigation functions
        window.currentProfileAddress = address;
      } else {
        addressLink.href = '#';
        addressLink.style.color = 'inherit';
        addressActions.style.display = 'none';
        window.currentProfileAddress = null;
      }

      const projectType = data.project_type || data.service_type || '';
      document.getElementById('profile-detail-project-type').textContent = projectType || '—';

      // Format project type nicely
      if (projectType) {
        const projectTypeEl = document.getElementById('profile-detail-project-type');
        const typeLabels = {
          'kitchen': 'Kitchen Countertops',
          'bathroom': 'Bathroom Vanity',
          'flooring': 'Flooring',
          'fireplace': 'Fireplace',
          'outdoor': 'Outdoor Kitchen',
          'commercial': 'Commercial Project'
        };
        projectTypeEl.textContent = typeLabels[projectType] || projectType;
      }

      document.getElementById('profile-detail-budget').textContent = budget || '—';
      document.getElementById('profile-detail-timeline').textContent = data.timeline || data.preferred_timeline || '—';
      document.getElementById('profile-detail-source').textContent = source || '—';

      // Show original message if present
      const messageSection = document.getElementById('profile-message-section');
      const messageEl = document.getElementById('profile-detail-message');
      if (message && messageSection && messageEl) {
        messageSection.style.display = 'block';
        messageEl.textContent = message;
      } else if (messageSection) {
        messageSection.style.display = 'none';
      }

      // Load appointments, notes, etc. and update tab badges
      loadProfileAppointments(data.id);
      loadProfileNotes(data.id);
      loadProfileActivity(data.id);
      loadProfileMessages(data.id);
      loadProfileEstimateCounts(data);
      loadProfileInvoiceCounts(data);

      // Reset tab badges (will be updated by load functions)
      document.getElementById('tab-badge-appointments').textContent = '0';
      document.getElementById('tab-badge-notes').textContent = '0';
      document.getElementById('tab-badge-files').textContent = '0';
      document.getElementById('tab-badge-messages').textContent = '0';
      document.getElementById('tab-badge-estimates').textContent = '0';
      document.getElementById('tab-badge-invoices').textContent = '0';
      document.getElementById('profile-stat-appointments').textContent = '0';
      document.getElementById('profile-stat-messages').textContent = '0';

      // Switch to overview tab
      switchProfileTab('overview');

      // Update archive button based on current status
      updateArchiveButton(status === 'archived');

      // Show panel
      document.getElementById('profile-panel-overlay').classList.add('active');
    }

    // Helper function for copying to clipboard
    function copyToClipboard(text, successMessage) {
      if (!text || text === '—') return;
      navigator.clipboard.writeText(text).then(() => {
        showToast(successMessage || 'Copied to clipboard', 'success');
      }).catch(err => {
        console.error('Copy failed:', err);
      });
    }

    // Copy profile link
    function copyProfileLink() {
      if (currentProfileData) {
        const link = `${window.location.origin}/account/#leads?id=${currentProfileData.id}`;
        copyToClipboard(link, 'Link copied to clipboard');
      }
    }

    // Print profile (simple version)
    function printProfile() {
      showToast('Print feature coming soon', 'info');
    }

    // Load messages for profile
    async function loadProfileMessages(entityId) {
      // Placeholder - will be enhanced with actual email history
      const msgCount = 0;
      document.getElementById('tab-badge-messages').textContent = msgCount;
      document.getElementById('profile-stat-messages').textContent = msgCount;
    }

    function closeProfilePanel() {
      document.getElementById('profile-panel-overlay').classList.remove('active');
      currentProfileData = null;
      window.currentProfileAddress = null;
    }

    // Open directions from profile panel
    function openDirectionsFromProfile() {
      if (!window.currentProfileAddress) {
        showToast('No address available', 'warning');
        return;
      }
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      if (isIOS && confirm('Open in Apple Maps instead of Google Maps?')) {
        window.open(`https://maps.apple.com/?daddr=${encodeURIComponent(window.currentProfileAddress)}`, '_blank');
      } else {
        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(window.currentProfileAddress)}`, '_blank');
      }
    }

    // Share en route status from profile panel (for leads)
    async function shareEnRouteFromProfile() {
      if (!currentProfileData || !window.currentProfileAddress) {
        showToast('No address available', 'warning');
        return;
      }

      const name = currentProfileData.full_name || currentProfileData.name || currentProfileData.homeowner_name || 'Customer';
      const address = window.currentProfileAddress;

      // Simple version for leads - just navigate and optionally notify
      const choice = await showEnRouteOptions(name, address);
      if (!choice) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not authenticated');

        // Log activity for the lead
        if (choice !== 'navigate_only' && currentProfileData.id) {
          await supabaseClient.from('lead_activity').insert({
            lead_id: currentProfileData.id,
            user_id: user.id,
            type: 'en_route',
            message: `${userProfile?.full_name || 'Team member'} is en route to visit`,
            created_at: new Date().toISOString()
          }).then(() => {}).catch(() => {}); // Don't fail if table doesn't exist

          showToast('En Route status logged!', 'success');
        }

        // Open navigation
        if (choice === 'navigate_notify' || choice === 'navigate_only') {
          openDirectionsFromProfile();
        }

        // Send notification to customer if they have email
        if (choice === 'navigate_notify' && currentProfileData.email) {
          try {
            await fetch(`${API_BASE}/api/notifications/en-route`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                customer_email: currentProfileData.email,
                customer_name: name,
                team_member: userProfile?.full_name || 'Our team',
                project_address: address
              })
            });
            showToast('Customer notified!', 'success');
          } catch (e) {
            console.warn('Could not send en route notification:', e);
          }
        }
      } catch (err) {
        console.error('Error with en route:', err);
        showToast('Error updating status', 'error');
      }
    }

    function switchProfileTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });

      // Show/hide content
      document.querySelectorAll('.profile-tab-content').forEach(content => {
        content.style.display = 'none';
      });
      const targetContent = document.getElementById(`profile-tab-${tabName}`);
      if (targetContent) targetContent.style.display = 'block';

      // Load data for specific tabs
      if (currentProfileData) {
        if (tabName === 'estimates') {
          loadProfileEstimates(currentProfileData);
        } else if (tabName === 'invoices') {
          loadProfileInvoices(currentProfileData);
        }
      }
    }

    // Load estimates for profile panel
    async function loadProfileEstimates(lead) {
      const container = document.getElementById('profile-estimates-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const email = lead.email || lead.homeowner_email || '';
        const leadId = lead.id;

        // Query by lead_id or customer_email
        let query = supabaseClient.from('estimates').select('*');
        if (leadId) {
          query = query.or(`lead_id.eq.${leadId}${email ? `,customer_email.ilike.${email}` : ''}`);
        } else if (email) {
          query = query.ilike('customer_email', email);
        }

        const { data: estimates, error } = await query.order('created_at', { ascending: false });

        // Update badge
        const count = estimates?.length || 0;
        const badge = document.getElementById('tab-badge-estimates');
        if (badge) badge.textContent = count;

        if (error || !estimates || estimates.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#f9cb00" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Estimates Yet</div>
              <div style="font-size: 13px;">Create an estimate to send a quote</div>
            </div>
          `;
          return;
        }

        container.innerHTML = estimates.map(est => `
          <div style="background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; color: var(--text-primary);">${est.estimate_number || 'Draft'}</div>
                <div style="font-size: 13px; color: var(--text-muted);">${est.project_name || 'Untitled Project'}</div>
              </div>
              <span class="status-badge status-${est.status}" style="font-size: 11px;">${est.status || 'draft'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="font-size: 20px; font-weight: 700; color: var(--gold-primary);">$${(est.total || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
              <div style="display: flex; gap: 8px;">
                ${est.status !== 'converted' ? `<button onclick="convertToInvoice('${est.id}')" class="btn-modern secondary" style="font-size: 11px; padding: 6px 10px;">Convert to Invoice</button>` : ''}
                <button onclick="viewEstimate && viewEstimate('${est.id}')" class="btn-modern primary" style="font-size: 11px; padding: 6px 10px;">View</button>
              </div>
            </div>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">${new Date(est.created_at).toLocaleDateString()}</div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load profile estimates error:', err);
        container.innerHTML = `<div style="color: var(--error); padding: 20px; text-align: center;">Error loading estimates</div>`;
      }
    }

    // Load invoices for profile panel
    async function loadProfileInvoices(lead) {
      const container = document.getElementById('profile-invoices-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      try {
        const email = lead.email || lead.homeowner_email || '';
        const leadId = lead.id;

        // Query by lead_id or customer_email
        let query = supabaseClient.from('invoices').select('*');
        if (leadId) {
          query = query.or(`lead_id.eq.${leadId}${email ? `,customer_email.ilike.${email}` : ''}`);
        } else if (email) {
          query = query.ilike('customer_email', email);
        }

        const { data: invoices, error } = await query.order('created_at', { ascending: false });

        // Update badge
        const count = invoices?.length || 0;
        const badge = document.getElementById('tab-badge-invoices');
        if (badge) badge.textContent = count;

        if (error || !invoices || invoices.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(16,185,129,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="1.5"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Invoices Yet</div>
              <div style="font-size: 13px;">Create an invoice or convert an estimate</div>
            </div>
          `;
          return;
        }

        container.innerHTML = invoices.map(inv => {
          const statusColors = { paid: '#10b981', unpaid: '#f59e0b', overdue: '#ef4444', draft: '#6b7280' };
          const statusColor = statusColors[inv.status] || '#6b7280';
          return `
            <div style="background: var(--dark-elevated); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 16px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <div>
                  <div style="font-weight: 600; color: var(--text-primary);">${inv.invoice_number || 'Draft'}</div>
                  <div style="font-size: 13px; color: var(--text-muted);">${inv.project_name || 'Invoice'}</div>
                </div>
                <span style="background: ${statusColor}20; color: ${statusColor}; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${inv.status || 'draft'}</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-size: 20px; font-weight: 700; color: var(--gold-primary);">$${(inv.amount_due || inv.total || 0).toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                  ${inv.due_date ? `<div style="font-size: 12px; color: var(--text-muted);">Due: ${new Date(inv.due_date).toLocaleDateString()}</div>` : ''}
                </div>
                <div style="display: flex; gap: 8px;">
                  ${inv.stripe_hosted_url ? `<a href="${inv.stripe_hosted_url}" target="_blank" class="btn-modern secondary" style="font-size: 11px; padding: 6px 10px;">Pay</a>` : ''}
                  ${inv.stripe_pdf_url ? `<a href="${inv.stripe_pdf_url}" target="_blank" class="btn-modern secondary" style="font-size: 11px; padding: 6px 10px;">PDF</a>` : ''}
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Load profile invoices error:', err);
        container.innerHTML = `<div style="color: var(--error); padding: 20px; text-align: center;">Error loading invoices</div>`;
      }
    }

    // Create estimate from profile panel
    function createEstimateFromProfile() {
      if (!currentProfileData) return;
      closeProfilePanel();
      if (currentProfileType === 'lead') {
        startEstimateFromLead(currentProfileData.id);
      } else {
        startEstimateFromCustomer(currentProfileData.id);
      }
    }

    // Create invoice from profile panel
    function createInvoiceFromProfile() {
      if (!currentProfileData) return;

      // Capture data before closing panel (in case it gets cleared)
      const invoiceData = {
        email: currentProfileData.email || currentProfileData.homeowner_email,
        name: currentProfileData.full_name || currentProfileData.name,
        phone: currentProfileData.phone || currentProfileData.homeowner_phone
      };

      // Include lead_id for traceability if this is a lead
      if (currentProfileType === 'lead' && currentProfileData.id) {
        invoiceData.lead_id = currentProfileData.id;
      }

      closeProfilePanel();
      showPage('invoices');

      // Use longer timeout to ensure page is fully rendered
      setTimeout(() => {
        openInvoiceModal(invoiceData);
      }, 300);
    }

    // Load estimate counts for badge
    async function loadProfileEstimateCounts(lead) {
      try {
        const email = lead.email || lead.homeowner_email || '';
        const leadId = lead.id;

        let query = supabaseClient.from('estimates').select('id', { count: 'exact', head: true });
        if (leadId) {
          query = query.or(`lead_id.eq.${leadId}${email ? `,customer_email.ilike.${email}` : ''}`);
        } else if (email) {
          query = query.ilike('customer_email', email);
        }

        const { count } = await query;
        const badge = document.getElementById('tab-badge-estimates');
        if (badge) {
          badge.textContent = count || 0;
          badge.style.display = count > 0 ? 'inline-flex' : 'none';
        }
      } catch (err) {
        console.error('Load estimate counts error:', err);
      }
    }

    // Load invoice counts for badge
    async function loadProfileInvoiceCounts(lead) {
      try {
        const email = lead.email || lead.homeowner_email || '';
        const leadId = lead.id;

        let query = supabaseClient.from('invoices').select('id', { count: 'exact', head: true });
        if (leadId) {
          query = query.or(`lead_id.eq.${leadId}${email ? `,customer_email.ilike.${email}` : ''}`);
        } else if (email) {
          query = query.ilike('customer_email', email);
        }

        const { count } = await query;
        const badge = document.getElementById('tab-badge-invoices');
        if (badge) {
          badge.textContent = count || 0;
          badge.style.display = count > 0 ? 'inline-flex' : 'none';
        }
      } catch (err) {
        console.error('Load invoice counts error:', err);
      }
    }

    async function loadProfileAppointments(entityId) {
      const container = document.getElementById('profile-appointments-list');
      try {
        const { data: events, error } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('lead_id', entityId)
          .order('start_time', { ascending: true });

        // Update badge counts
        const count = events?.length || 0;
        document.getElementById('tab-badge-appointments').textContent = count;
        document.getElementById('tab-badge-appointments').className = count > 0 ? 'tab-badge' : 'tab-badge muted';
        document.getElementById('profile-stat-appointments').textContent = count;

        if (error || !events || events.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
              <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(249,203,0,0.1), rgba(249,203,0,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              </div>
              <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Appointments Yet</div>
              <div style="font-size: 13px; max-width: 280px; margin: 0 auto;">Click "Schedule" to plan job phases like templating, fabrication, and installation</div>
            </div>
          `;
          return;
        }

        const typeIcons = {
          'template': '📐', 'measurement': '📐', 'fabrication': '⚙️',
          'installation': '🔧', 'plumbing_disconnect': '🔌', 'plumbing_reconnect': '🚿',
          'appointment': '📅', 'consultation': '💬', 'sealer_application': '💧',
          'walk_through': '🚶', 'final_inspection': '✅', 'delivery': '🚚', 'demo': '🔨'
        };

        container.innerHTML = events.map(evt => {
          const date = new Date(evt.start_time);
          const endDate = evt.end_time ? new Date(evt.end_time) : null;
          const now = new Date();
          const isPast = date < now;
          const isToday = date.toDateString() === now.toDateString();

          const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

          const statusClass = evt.status === 'completed' ? 'completed' : (evt.status === 'cancelled' ? 'cancelled' : 'scheduled');

          return `
            <div class="appointment-card ${isPast ? 'past' : ''}" style="${isPast ? 'opacity: 0.7;' : ''}">
              <div class="appointment-date-box">
                <div class="appointment-month">${monthNames[date.getMonth()]}</div>
                <div class="appointment-day">${date.getDate()}</div>
                <div class="appointment-weekday">${dayNames[date.getDay()]}</div>
              </div>
              <div class="appointment-info">
                <div class="appointment-title">${typeIcons[evt.event_type] || '📅'} ${escapeHtml(evt.title)}</div>
                <div class="appointment-time">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}${endDate ? ' - ' + endDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : ''}
                  ${isToday ? '<span style="background: var(--primary); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; margin-left: 8px;">TODAY</span>' : ''}
                </div>
                <div class="appointment-meta">
                  ${evt.location ? `<span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ${escapeHtml(evt.location.substring(0, 30))}${evt.location.length > 30 ? '...' : ''}</span>` : ''}
                  <span class="appointment-status ${statusClass}">${evt.status || 'Scheduled'}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error loading appointments:', err);
      }
    }

    async function loadProfileNotes(entityId) {
      const container = document.getElementById('profile-notes-list');
      if (!currentProfileData) return;

      // Check for notes in the lead data (stored as JSON array or string)
      let notes = [];
      try {
        if (currentProfileData.notes_history) {
          notes = typeof currentProfileData.notes_history === 'string'
            ? JSON.parse(currentProfileData.notes_history)
            : currentProfileData.notes_history;
        }
      } catch (e) {
        console.warn('Error parsing notes:', e);
      }

      // Also check for legacy notes field (plain text)
      const legacyNote = currentProfileData.notes || currentProfileData.message;

      // Update badge count
      const noteCount = notes.length + (legacyNote ? 1 : 0);
      document.getElementById('tab-badge-notes').textContent = noteCount;
      document.getElementById('tab-badge-notes').className = noteCount > 0 ? 'tab-badge' : 'tab-badge muted';

      if (notes.length === 0 && !legacyNote) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 40px; color: var(--text-muted);">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
              <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
            <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Notes Yet</div>
            <div style="font-size: 13px;">Add notes to track important details about this lead</div>
          </div>
        `;
        return;
      }

      let html = '';

      // Show structured notes first
      if (Array.isArray(notes) && notes.length > 0) {
        html += notes.map(note => `
          <div class="note-card">
            <div class="note-header">
              <span class="note-author">${escapeHtml(note.author || 'Staff')}</span>
              <span class="note-time">${note.created_at ? new Date(note.created_at).toLocaleString() : 'Unknown date'}</span>
            </div>
            <div class="note-content">${escapeHtml(note.text || note.content || '')}</div>
          </div>
        `).join('');
      }

      // Show legacy notes
      if (legacyNote) {
        html += `
          <div class="note-card" style="border-left-color: #3b82f6;">
            <div class="note-header">
              <span class="note-author">Original Message</span>
              <span class="note-time">${currentProfileData.created_at ? new Date(currentProfileData.created_at).toLocaleString() : ''}</span>
            </div>
            <div class="note-content">${escapeHtml(legacyNote)}</div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    async function loadProfileActivity(entityId) {
      const container = document.getElementById('profile-activity-list');
      try {
        const { data: activities, error } = await supabaseClient
          .from('portal_activity')
          .select('*')
          .eq('lead_id', entityId)
          .order('created_at', { ascending: false })
          .limit(20);

        if (error || !activities || activities.length === 0) {
          return; // Keep placeholder
        }

        const activityIcons = {
          'portal_viewed': '👁️', 'estimate_viewed': '📄', 'estimate_approved': '✅',
          'message_sent': '💬', 'appointment_confirmed': '📅', 'payment_made': '💳'
        };

        container.innerHTML = activities.map(act => `
          <div class="activity-item">
            <div class="activity-icon">${activityIcons[act.action_type] || '📌'}</div>
            <div class="activity-content">
              <div class="activity-text">${escapeHtml(act.action_type.replace(/_/g, ' '))}</div>
              <div class="activity-time">${new Date(act.created_at).toLocaleString()}</div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Error loading activity:', err);
      }
    }

    function addNewNote() {
      document.getElementById('profile-notes-input').style.display = 'block';
      document.getElementById('new-note-text').focus();
    }

    function cancelNewNote() {
      document.getElementById('profile-notes-input').style.display = 'none';
      document.getElementById('new-note-text').value = '';
    }

    async function saveNewNote() {
      const text = document.getElementById('new-note-text').value.trim();
      if (!text || !currentProfileData) {
        showToast('No note text entered', 'warning');
        return;
      }

      try {
        // Get current user
        const { data: { user } } = await supabaseClient.auth.getUser();
        const authorName = user?.email || 'Staff';

        // Get existing notes or create new array
        let notesHistory = [];
        try {
          if (currentProfileData.notes_history) {
            notesHistory = typeof currentProfileData.notes_history === 'string'
              ? JSON.parse(currentProfileData.notes_history)
              : currentProfileData.notes_history;
          }
        } catch (e) {
          notesHistory = [];
        }

        // Add new note
        const newNote = {
          id: Date.now().toString(),
          text: text,
          author: authorName,
          created_at: new Date().toISOString()
        };
        notesHistory.unshift(newNote);

        // Determine table based on profile type
        const table = currentProfileType === 'customer' ? 'customers' : 'leads';

        // Save to database
        const { error } = await supabaseClient
          .from(table)
          .update({ notes_history: notesHistory })
          .eq('id', currentProfileData.id);

        if (error) throw error;

        // Update local data
        currentProfileData.notes_history = notesHistory;

        // Update allLeads array if it's a lead
        if (currentProfileType === 'lead') {
          const leadIndex = allLeads.findIndex(l => l.id === currentProfileData.id);
          if (leadIndex !== -1) {
            allLeads[leadIndex].notes_history = notesHistory;
          }
        }

        showToast('Note saved', 'success');
        cancelNewNote();

        // Refresh notes display
        loadProfileNotes(currentProfileData.id);

      } catch (err) {
        console.error('Error saving note:', err);
        showToast('Error saving note: ' + err.message, 'error');
      }
    }

    // File Upload functionality
    function uploadAttachment() {
      if (!currentProfileData) {
        showToast('No profile selected', 'warning');
        return;
      }

      // Create file input dynamically
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*,.pdf,.doc,.docx,.xls,.xlsx';
      fileInput.multiple = true;
      fileInput.style.display = 'none';

      fileInput.onchange = async (e) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        showToast(`Uploading ${files.length} file(s)...`, 'info');

        for (const file of files) {
          try {
            // Check file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
              showToast(`${file.name} is too large (max 10MB)`, 'error');
              continue;
            }

            const { data: { user } } = await supabaseClient.auth.getUser();
            const fileName = `${currentProfileType}_${currentProfileData.id}/${Date.now()}_${file.name}`;

            // Upload to Supabase Storage
            const { data, error } = await supabaseClient.storage
              .from('attachments')
              .upload(fileName, file);

            if (error) throw error;

            // Get public URL
            const { data: urlData } = supabaseClient.storage
              .from('attachments')
              .getPublicUrl(fileName);

            // Add to attachments display
            addAttachmentToDisplay(file.name, urlData.publicUrl, file.type);

            showToast(`${file.name} uploaded`, 'success');
          } catch (err) {
            console.error('Upload error:', err);
            showToast(`Error uploading ${file.name}: ${err.message}`, 'error');
          }
        }
      };

      document.body.appendChild(fileInput);
      fileInput.click();
      document.body.removeChild(fileInput);
    }

    function addAttachmentToDisplay(name, url, type) {
      const container = document.getElementById('profile-attachments-list');
      const icon = type.includes('image') ? '🖼️' : type.includes('pdf') ? '📄' : '📎';

      const attachmentHtml = `
        <div class="attachment-card" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 8px;">
          <span style="font-size: 24px;">${icon}</span>
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: 500; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(name)}</div>
            <div style="font-size: 12px; color: var(--text-muted);">Just now</div>
          </div>
          <a href="${url}" target="_blank" class="btn-modern ghost" style="padding: 6px 12px; font-size: 12px;">View</a>
        </div>
      `;

      // Remove empty state if present
      if (container.querySelector('svg')) {
        container.innerHTML = attachmentHtml;
      } else {
        container.insertAdjacentHTML('afterbegin', attachmentHtml);
      }
    }

    // Message composer
    function composeMessage() {
      if (!currentProfileData) {
        showToast('No profile selected', 'warning');
        return;
      }

      const email = currentProfileData.email || currentProfileData.homeowner_email;
      if (!email) {
        showToast('No email address available', 'warning');
        return;
      }

      // Save profile data before closing
      const data = currentProfileData;
      closeProfilePanel();

      // Open email modal for the lead
      if (currentProfileType === 'lead') {
        selectedLead = data;
        openLeadEmailModal(data.id);
      } else {
        // For customers, use mailto as fallback
        window.location.href = `mailto:${email}`;
      }
    }

    function openJobSchedulerFromProfile() {
      // Save data before closing (closeProfilePanel sets currentProfileData to null)
      const data = currentProfileData;
      closeProfilePanel();
      if (data) {
        openJobScheduler(data);
      }
    }

    function sendMessageFromProfile() {
      composeMessage();
    }

    function openPortalFromProfile() {
      if (currentProfileData && currentProfileData.portal_token) {
        window.open(`/portal/?token=${currentProfileData.portal_token}`, '_blank');
      } else {
        showToast('No portal access configured', 'warning');
      }
    }

    async function archiveLeadFromProfile() {
      if (!currentProfileData) return;

      const isArchived = currentProfileData.status === 'archived';
      const newStatus = isArchived ? 'new' : 'archived';
      const action = isArchived ? 'restore' : 'archive';

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus })
          .eq('id', currentProfileData.id);

        if (error) throw error;

        // Update local data
        currentProfileData.status = newStatus;
        const index = allLeads.findIndex(l => l.id === currentProfileData.id);
        if (index !== -1) {
          allLeads[index].status = newStatus;
        }

        // Update archive button text
        updateArchiveButton(newStatus === 'archived');

        // Refresh display
        updateStats();
        renderLeads();

        showToast(isArchived ? 'Lead restored successfully' : 'Lead archived successfully', 'success');
      } catch (err) {
        console.error('Error archiving lead:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function updateArchiveButton(isArchived) {
      const titleEl = document.getElementById('archive-btn-title');
      const descEl = document.getElementById('archive-btn-desc');
      if (titleEl) titleEl.textContent = isArchived ? 'Restore Lead' : 'Archive Lead';
      if (descEl) descEl.textContent = isArchived ? 'Move back to active' : 'Hide from active list';
    }

    async function quickArchiveLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const isArchived = lead.status === 'archived';
      const newStatus = isArchived ? 'new' : 'archived';

      try {
        const { error } = await supabaseClient
          .from('leads')
          .update({ status: newStatus })
          .eq('id', leadId);

        if (error) throw error;

        // Update local data
        lead.status = newStatus;

        // Refresh display
        updateStats();
        renderLeads();

        showToast(isArchived ? 'Lead restored' : 'Lead archived', 'success');
      } catch (err) {
        console.error('Error archiving lead:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function quickDeleteLead(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (!lead) return;

      const leadName = lead.full_name || lead.homeowner_name || lead.name || 'this lead';

      // Show confirmation dialog
      if (!confirm(`Are you sure you want to permanently delete "${leadName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('leads')
          .delete()
          .eq('id', leadId);

        if (error) throw error;

        // Remove from local data
        const index = allLeads.findIndex(l => l.id === leadId);
        if (index !== -1) {
          allLeads.splice(index, 1);
        }

        // Close profile panel if this lead was open
        if (currentProfileData && currentProfileData.id === leadId) {
          closeProfilePanel();
        }

        // Refresh display
        updateStats();
        renderLeads();

        showToast('Lead deleted permanently', 'success');
      } catch (err) {
        console.error('Error deleting lead:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }

    function editProfileRecord() {
      // Save data before closing (closeProfilePanel sets currentProfileData to null)
      const data = currentProfileData;
      const type = currentProfileType;
      closeProfilePanel();
      if (type === 'lead' && data) {
        selectedLead = data;
        openEditLeadModal(data);
      }
    }

    function openEditLeadModal(lead) {
      editingLeadId = lead.id;

      // Update modal title for edit mode
      const modalTitle = document.querySelector('#add-lead-modal .modal-title');
      if (modalTitle) modalTitle.textContent = 'Edit Lead';

      // Parse name into first/last
      const fullName = lead.full_name || lead.name || '';
      const nameParts = fullName.trim().split(' ');
      const firstName = nameParts[0] || '';
      const lastName = nameParts.slice(1).join(' ') || '';

      // Populate basic fields
      document.getElementById('new-lead-first-name').value = firstName;
      document.getElementById('new-lead-last-name').value = lastName;
      document.getElementById('new-lead-email').value = lead.email || '';
      document.getElementById('new-lead-phone').value = lead.phone || '';
      document.getElementById('new-lead-project-type').value = lead.project_type || '';
      document.getElementById('new-lead-zip').value = lead.zip_code || '';

      // Populate billing address
      const billing = lead.billing_address || {};
      if (typeof billing === 'object') {
        document.getElementById('new-lead-billing-street').value = billing.street || '';
        document.getElementById('new-lead-billing-street2').value = billing.street2 || '';
        document.getElementById('new-lead-billing-city').value = billing.city || '';
        document.getElementById('new-lead-billing-state').value = billing.state || 'AZ';
        document.getElementById('new-lead-billing-zip').value = billing.zip || '';
      }

      // Handle service address
      const addressSame = lead.address_same !== false;
      document.getElementById('new-lead-address-same').checked = addressSame;
      toggleNewLeadServiceAddress();

      if (!addressSame && lead.service_address) {
        const service = lead.service_address;
        if (typeof service === 'object') {
          document.getElementById('new-lead-service-street').value = service.street || '';
          document.getElementById('new-lead-service-street2').value = service.street2 || '';
          document.getElementById('new-lead-service-city').value = service.city || '';
          document.getElementById('new-lead-service-state').value = service.state || 'AZ';
          document.getElementById('new-lead-service-zip').value = service.zip || '';
        }
      }

      // Populate status and source
      const statusSelect = document.getElementById('new-lead-status');
      const sourceSelect = document.getElementById('new-lead-source');
      if (statusSelect) statusSelect.value = lead.status || 'new';
      if (sourceSelect) sourceSelect.value = lead.source || 'manual';

      // Populate message (strip any appointment info if present)
      let message = lead.message || '';
      const apptInfoIndex = message.indexOf('\n\nSCHEDULED APPOINTMENT:');
      if (apptInfoIndex > -1) message = message.substring(0, apptInfoIndex);
      document.getElementById('new-lead-message').value = message;

      // Open the modal
      document.getElementById('add-lead-modal').classList.add('active');
    }

    // =============================================
    // JOB PHASE SCHEDULER FUNCTIONS
    // =============================================
    let schedulerData = null;
    let jobPhases = [];
    let schedulerContractors = [];

    const DEFAULT_JOB_PHASES = [
      { id: 'template', name: 'Template/Measure', icon: '📐', type: 'template', duration: 60, defaultTime: '09:00', daysBeforeInstall: null, enabled: true },
      { id: 'demo', name: 'Demo/Tear-out', icon: '🔨', type: 'site_visit', duration: 120, defaultTime: '08:00', daysBeforeInstall: 1, enabled: false },
      { id: 'plumbing_disconnect', name: 'Plumbing Disconnect', icon: '🔌', type: 'plumbing_disconnect', duration: 60, defaultTime: '07:30', daysBeforeInstall: 0, enabled: false },
      { id: 'fabrication', name: 'Fabrication', icon: '⚙️', type: 'fabrication', duration: 480, defaultTime: '07:00', daysBeforeInstall: null, enabled: true, isShopWork: true },
      { id: 'installation', name: 'Installation', icon: '🔧', type: 'installation', duration: 240, defaultTime: '08:00', daysBeforeInstall: 0, enabled: true, isAnchor: true },
      { id: 'plumbing_reconnect', name: 'Plumbing Reconnect', icon: '🚿', type: 'plumbing_reconnect', duration: 60, defaultTime: '14:00', daysBeforeInstall: 0, enabled: false },
      { id: 'sealer', name: 'Sealer Application', icon: '💧', type: 'sealer_application', duration: 60, defaultTime: '10:00', daysBeforeInstall: -1, enabled: false },
      { id: 'walkthrough', name: 'Final Walk-through', icon: '✅', type: 'walk_through', duration: 30, defaultTime: '16:00', daysBeforeInstall: -1, enabled: false }
    ];

    function openJobScheduler(data) {
      schedulerData = data;
      jobPhases = JSON.parse(JSON.stringify(DEFAULT_JOB_PHASES));
      schedulerContractors = [];

      const name = data.full_name || data.name || data.homeowner_name || 'Customer';
      const address = formatAddressFromData(data);
      const phone = data.phone || data.homeowner_phone || '';
      const email = data.email || data.homeowner_email || '';

      // Set avatar initials
      const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
      const avatarEl = document.getElementById('scheduler-avatar');
      if (avatarEl) avatarEl.textContent = initials;

      document.getElementById('scheduler-customer-name').textContent = name;
      document.getElementById('scheduler-detail-name').textContent = name;
      document.getElementById('scheduler-detail-address').textContent = address || '—';
      document.getElementById('scheduler-detail-phone').textContent = phone || '—';

      // Set default install date (7 days from now)
      const installDate = new Date();
      installDate.setDate(installDate.getDate() + 7);
      document.getElementById('scheduler-install-date').value = installDate.toISOString().split('T')[0];

      recalculatePhases();
      renderJobPhases();
      renderSchedulerTimeline();

      document.getElementById('job-scheduler-panel').classList.add('active');
    }

    function closeJobScheduler() {
      document.getElementById('job-scheduler-panel').classList.remove('active');
      schedulerData = null;
    }

    function recalculatePhases() {
      const installDateStr = document.getElementById('scheduler-install-date').value;
      if (!installDateStr) return;

      const installDate = new Date(installDateStr + 'T00:00:00');
      const leadTimeFab = parseInt(document.getElementById('lead-time-fab').value) || 3;
      const leadTimeTemplate = parseInt(document.getElementById('lead-time-template').value) || 5;

      jobPhases.forEach(phase => {
        if (phase.id === 'installation') {
          phase.date = new Date(installDate);
        } else if (phase.id === 'fabrication') {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - leadTimeFab);
        } else if (phase.id === 'template') {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - leadTimeFab - leadTimeTemplate);
        } else if (phase.id === 'demo') {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - 1);
        } else if (phase.daysBeforeInstall !== null) {
          phase.date = new Date(installDate);
          phase.date.setDate(phase.date.getDate() - phase.daysBeforeInstall);
        }
      });

      renderJobPhases();
      renderSchedulerTimeline();
    }

    function renderJobPhases() {
      const container = document.getElementById('job-phases-container');
      container.innerHTML = jobPhases.map(phase => `
        <div class="phase-card ${phase.enabled ? 'selected' : ''}" onclick="togglePhase('${phase.id}')">
          <div class="phase-header">
            <div class="phase-icon">${phase.icon}</div>
            <div style="flex: 1;">
              <div class="phase-title">${phase.name}</div>
              <div class="phase-subtitle">${phase.isShopWork ? 'Shop work' : 'On-site'} • ${Math.floor(phase.duration / 60)}h ${phase.duration % 60}m</div>
            </div>
            <label style="display: flex; align-items: center;" onclick="event.stopPropagation()">
              <input type="checkbox" ${phase.enabled ? 'checked' : ''} onchange="togglePhase('${phase.id}')" style="accent-color: var(--primary); width: 18px; height: 18px;">
            </label>
          </div>
          ${phase.enabled ? `
            <div class="phase-date-row">
              <input type="date" value="${phase.date ? phase.date.toISOString().split('T')[0] : ''}"
                onchange="updatePhaseDate('${phase.id}', this.value)"
                onclick="event.stopPropagation()"
                class="input-modern" style="flex: 1; font-size: 13px; padding: 8px;">
              <input type="time" value="${phase.defaultTime}"
                onchange="updatePhaseTime('${phase.id}', this.value)"
                onclick="event.stopPropagation()"
                class="input-modern" style="width: 100px; font-size: 13px; padding: 8px;">
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function togglePhase(phaseId) {
      const phase = jobPhases.find(p => p.id === phaseId);
      if (phase && !phase.isAnchor) {
        phase.enabled = !phase.enabled;
        if (phase.enabled) recalculatePhases();
        renderJobPhases();
        renderSchedulerTimeline();
      }
    }

    function updatePhaseDate(phaseId, dateStr) {
      const phase = jobPhases.find(p => p.id === phaseId);
      if (phase) {
        phase.date = new Date(dateStr + 'T00:00:00');
        renderSchedulerTimeline();
      }
    }

    function updatePhaseTime(phaseId, timeStr) {
      const phase = jobPhases.find(p => p.id === phaseId);
      if (phase) {
        phase.defaultTime = timeStr;
      }
    }

    function renderSchedulerTimeline() {
      const container = document.getElementById('scheduler-timeline-preview');
      const enabledPhases = jobPhases.filter(p => p.enabled && p.date).sort((a, b) => a.date - b.date);

      if (enabledPhases.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 30px 0; color: var(--text-muted);">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity: 0.4; margin-bottom: 10px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            <div style="font-size: 13px;">Enable phases to see timeline</div>
          </div>
        `;
        return;
      }

      container.innerHTML = enabledPhases.map((phase, idx) => {
        const isLast = idx === enabledPhases.length - 1;
        const isInstall = phase.id === 'installation';
        return `
          <div class="timeline-preview-item">
            <div class="timeline-preview-dot ${isInstall ? 'active' : ''}">${phase.icon}</div>
            <div class="timeline-preview-content">
              <div class="timeline-preview-date">${phase.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
              <div class="timeline-preview-title">${phase.name}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function resetPhases() {
      jobPhases = JSON.parse(JSON.stringify(DEFAULT_JOB_PHASES));
      recalculatePhases();
    }

    async function saveJobPhases() {
      const enabledPhases = jobPhases.filter(p => p.enabled && p.date);
      if (enabledPhases.length === 0) {
        showToast('Please enable at least one phase', 'warning');
        return;
      }

      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) {
        showToast('Not authenticated', 'error');
        return;
      }

      const name = schedulerData.full_name || schedulerData.name || schedulerData.homeowner_name || 'Customer';
      const email = schedulerData.email || schedulerData.homeowner_email || '';
      const phone = schedulerData.phone || schedulerData.homeowner_phone || '';
      const address = formatAddressFromData(schedulerData);

      const createdEvents = [];

      for (const phase of enabledPhases) {
        const startTime = new Date(phase.date);
        const [hours, mins] = phase.defaultTime.split(':');
        startTime.setHours(parseInt(hours), parseInt(mins), 0, 0);

        const endTime = new Date(startTime.getTime() + phase.duration * 60 * 1000);

        const eventData = {
          title: `${phase.name} - ${name}`,
          event_type: phase.type,
          start_time: startTime.toISOString(),
          end_time: endTime.toISOString(),
          location: phase.isShopWork ? 'Shop' : address,
          lead_id: schedulerData.id,
          status: 'scheduled',
          user_id: user.id,
          metadata: {
            contact_name: name,
            contact_email: email,
            contact_phone: phone,
            phase_id: phase.id
          }
        };

        const { data: newEvent, error } = await supabaseClient
          .from('calendar_events')
          .insert(eventData)
          .select()
          .single();

        if (!error && newEvent) {
          createdEvents.push({ ...newEvent, phaseInfo: phase });
        }
      }

      // Send notifications
      const notifyCustomer = document.getElementById('scheduler-notify-customer').checked;
      const notifyContractors = document.getElementById('scheduler-notify-contractors').checked;

      if (notifyCustomer && email) {
        await sendWorkflowInviteEmails(createdEvents, [{ email, name, phone, role: 'customer' }], name, address);
      }

      showToast(`Created ${createdEvents.length} job phases!`, 'success');
      closeJobScheduler();

      // Refresh calendar if visible
      if (typeof loadCalendarEvents === 'function') {
        loadCalendarEvents();
      }
    }

    function openContractorPicker() {
      // Create contractor picker modal dynamically
      let modal = document.getElementById('contractor-picker-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'contractor-picker-modal';
        modal.className = 'modal-overlay';
        modal.style.zIndex = '100001';
        modal.innerHTML = `
          <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
              <h2 class="modal-title">Assign Contractor</h2>
              <button class="modal-close" onclick="closeContractorPicker()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
              </button>
            </div>
            <div class="modal-body" id="contractor-picker-list" style="max-height: 400px; overflow-y: auto;">
              <div style="text-align: center; padding: 40px; color: var(--text-muted);">Loading contractors...</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn-modern secondary" onclick="closeContractorPicker()">Cancel</button>
            </div>
          </div>
        `;
        modal.onclick = (e) => { if (e.target === modal) closeContractorPicker(); };
        document.body.appendChild(modal);
      }

      // Populate contractor list
      const listContainer = document.getElementById('contractor-picker-list');
      if (allContractors && allContractors.length > 0) {
        listContainer.innerHTML = allContractors.map(c => {
          const name = c.name || c.company || c.email || 'Unknown';
          const specialty = c.specialty ? c.specialty.replace('_', ' ') : '';
          const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
          const isAssigned = schedulerContractors.some(sc => sc.id === c.id);
          return `
            <div class="contractor-picker-item" style="display: flex; align-items: center; padding: 14px; border-bottom: 1px solid var(--border-subtle); cursor: pointer; ${isAssigned ? 'opacity: 0.5; pointer-events: none;' : ''}" onclick="assignContractorToJob('${c.id}')">
              <div style="width: 42px; height: 42px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #e6b800); display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700; color: #000; margin-right: 14px;">${initials}</div>
              <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(name)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${specialty}${c.email ? ' • ' + c.email : ''}</div>
              </div>
              ${isAssigned ? '<span style="color: var(--success); font-size: 12px; font-weight: 600;">Assigned</span>' : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>'}
            </div>
          `;
        }).join('');
      } else {
        listContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.5;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <div style="font-weight: 600; margin-bottom: 4px;">No Contractors Available</div>
            <div style="font-size: 13px;">Add contractors in the Team section first.</div>
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeContractorPicker() {
      const modal = document.getElementById('contractor-picker-modal');
      if (modal) modal.classList.remove('active');
    }

    function openAddContractorFromWorkflow() {
      // Open the contractor picker from workflow context
      openContractorPicker();
    }

    function assignContractorToJob(contractorId) {
      const contractor = allContractors.find(c => c.id === contractorId);
      if (!contractor) return;

      // Add to scheduler contractors list
      if (!schedulerContractors.some(c => c.id === contractorId)) {
        schedulerContractors.push(contractor);
        updateSchedulerContractorsList();
      }

      closeContractorPicker();
      showToast(`${contractor.name || 'Contractor'} assigned to job`, 'success');
    }

    function removeContractorFromJob(contractorId) {
      schedulerContractors = schedulerContractors.filter(c => c.id !== contractorId);
      updateSchedulerContractorsList();
    }

    function updateSchedulerContractorsList() {
      const container = document.getElementById('scheduler-contractors-list');
      if (!container) return;

      if (schedulerContractors.length === 0) {
        container.innerHTML = `
          <button class="btn-modern ghost" style="width: 100%; font-size: 13px; padding: 14px;" onclick="openContractorPicker()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
            Add Contractor
          </button>
        `;
        return;
      }

      container.innerHTML = schedulerContractors.map(c => {
        const name = c.name || c.company || 'Contractor';
        const initials = name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2).toUpperCase();
        const specialty = c.specialty ? c.specialty.replace('_', ' ') : '';
        return `
          <div style="display: flex; align-items: center; padding: 10px 12px; background: var(--dark-elevated); border-radius: 10px; margin-bottom: 8px;">
            <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #e6b800); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700; color: #000; margin-right: 12px;">${initials}</div>
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${escapeHtml(name)}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${specialty}</div>
            </div>
            <button onclick="removeContractorFromJob('${c.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;" title="Remove">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
          </div>
        `;
      }).join('') + `
        <button class="btn-modern ghost" style="width: 100%; font-size: 12px; padding: 10px; margin-top: 4px;" onclick="openContractorPicker()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add Another
        </button>
      `;
    }

    function showAddPhaseOptions() {
      // TODO: Show custom phase options
      showToast('Custom phases coming soon', 'info');
    }

    // Connect lead row clicks to open profile panel
    function openLeadProfile(leadId) {
      const lead = allLeads.find(l => l.id === leadId);
      if (lead) {
        openProfilePanel(lead, 'lead');
      }
    }

    function populateEventCustomerDropdown() {
      const select = document.getElementById('cal-event-customer');
      select.innerHTML = '<option value="">-- None --</option>';
      if (allCustomers && allCustomers.length > 0) {
        allCustomers.forEach(c => {
          select.innerHTML += `<option value="${c.id}">${escapeHtml(c.name)}${c.email ? ' (' + c.email + ')' : ''}</option>`;
        });
      }
    }

    function populateEventJobDropdown() {
      const select = document.getElementById('cal-event-job');
      select.innerHTML = '<option value="">-- None --</option>';
      if (allJobs && allJobs.length > 0) {
        allJobs.forEach(j => {
          const label = (j.job_number || 'Job') + ' - ' + (j.customer_name || j.description || 'Untitled');
          select.innerHTML += `<option value="${j.id}">${escapeHtml(label)}</option>`;
        });
      }
    }

    function populateEventLeadDropdown() {
      const select = document.getElementById('cal-event-lead');
      if (!select) return;
      select.innerHTML = '<option value="">-- None --</option>';
      if (allLeads && allLeads.length > 0) {
        // Show recent leads first (up to 50)
        const recentLeads = allLeads.slice(0, 50);
        recentLeads.forEach(l => {
          const name = l.full_name || l.email || 'Unknown';
          const statusBadge = l.status ? ` [${l.status}]` : '';
          select.innerHTML += `<option value="${l.id}">${escapeHtml(name)}${statusBadge}</option>`;
        });
      }
    }

    function populateEventProjectDropdown() {
      const select = document.getElementById('cal-event-project-select');
      const hiddenInput = document.getElementById('cal-event-project');
      if (!select) return;
      select.innerHTML = '<option value="">-- None --</option>';
      // allJobs now contains projects (single source of truth)
      if (allJobs && allJobs.length > 0) {
        allJobs.forEach(p => {
          const name = p.customer_name || p.name || p.description || 'Untitled Project';
          const jobNum = p.job_number ? `${p.job_number} - ` : '';
          select.innerHTML += `<option value="${p.id}">${escapeHtml(jobNum + name)}</option>`;
        });
      }
      // Sync with hidden input
      select.addEventListener('change', function() {
        if (hiddenInput) hiddenInput.value = this.value;
      });
      // Set initial value from hidden input
      if (hiddenInput && hiddenInput.value) {
        select.value = hiddenInput.value;
      }
    }

    // Load contractors from database
    async function loadContractors() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Load from general_collaborators table
        const { data: contractors, error } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, company, email, phone, role, status')
          .eq('invited_by', user.id)
          .order('name');

        if (error) {
          console.warn('Could not load contractors:', error.message);
          // Try loading from sg_users with contractor account type as fallback
          const { data: teamUsers, error: teamError } = await supabaseClient
            .from('sg_users')
            .select('id, full_name, email, phone, account_type')
            .in('account_type', ['contractor', 'fabricator', 'installer', 'admin', 'staff']);

          if (!teamError && teamUsers) {
            allContractors = teamUsers.map(u => ({
              id: u.id,
              name: u.full_name || u.email,
              email: u.email,
              phone: u.phone,
              role: u.account_type
            }));
          }
        } else {
          allContractors = contractors || [];
        }

      } catch (err) {
        console.error('Error loading contractors:', err);
        allContractors = [];
      }
    }

    function populateEventContractorsDropdown() {
      const select = document.getElementById('cal-event-contractors');
      if (!select) return;
      select.innerHTML = '';
      // Add contractors from allContractors
      if (allContractors && allContractors.length > 0) {
        allContractors.forEach(c => {
          const name = c.name || c.company || c.email || 'Unknown';
          const specialty = c.specialty ? ` (${c.specialty})` : '';
          select.innerHTML += `<option value="${c.id}" data-email="${c.email || ''}" data-phone="${c.phone || ''}" data-name="${escapeHtml(name)}">${escapeHtml(name)}${specialty}</option>`;
        });
      }
    }

    function getSelectedContractorsAsParticipants() {
      const select = document.getElementById('cal-event-contractors');
      if (!select) return [];
      const participants = [];
      const selectedOptions = Array.from(select.selectedOptions);
      selectedOptions.forEach(opt => {
        participants.push({
          email: opt.dataset.email || '',
          name: opt.dataset.name || opt.text,
          phone: opt.dataset.phone || '',
          role: 'contractor',
          participant_type: 'attendee'
        });
      });
      return participants;
    }

    function addEventParticipant() {
      document.getElementById('add-participant-row').style.display = 'block';
      document.getElementById('participant-source').value = 'manual';
      document.getElementById('participant-preset').style.display = 'none';
      document.getElementById('participant-manual-fields').style.display = 'block';
      // Clear fields
      document.getElementById('participant-name').value = '';
      document.getElementById('participant-email').value = '';
      document.getElementById('participant-phone').value = '';
    }

    function cancelAddParticipant() {
      document.getElementById('add-participant-row').style.display = 'none';
    }

    function onParticipantSourceChange() {
      const source = document.getElementById('participant-source').value;
      const preset = document.getElementById('participant-preset');
      const manualFields = document.getElementById('participant-manual-fields');

      if (source === 'manual') {
        preset.style.display = 'none';
        manualFields.style.display = 'block';
      } else {
        preset.style.display = 'block';
        manualFields.style.display = 'none';
        populateParticipantPreset(source);
      }
    }

    async function populateParticipantPreset(source) {
      const preset = document.getElementById('participant-preset');
      preset.innerHTML = '<option value="">-- Select --</option>';

      if (source === 'customer' && allCustomers) {
        allCustomers.forEach(c => {
          if (c.email) {
            preset.innerHTML += `<option value="${c.id}" data-name="${escapeHtml(c.name || '')}" data-email="${escapeHtml(c.email)}" data-phone="${escapeHtml(c.phone || '')}">${escapeHtml(c.name || c.email)}</option>`;
          }
        });
      } else if (source === 'lead' && allLeads) {
        allLeads.forEach(l => {
          if (l.email) {
            preset.innerHTML += `<option value="${l.id}" data-name="${escapeHtml(l.name || '')}" data-email="${escapeHtml(l.email)}" data-phone="${escapeHtml(l.phone || '')}">${escapeHtml(l.name || l.email)}</option>`;
          }
        });
      } else if (source === 'collaborator') {
        // Load network collaborators
        try {
          const resp = await apiCall('/api/collaboration/my-collaborators');
          const data = await resp.json();
          if (data.collaborators) {
            data.collaborators.filter(c => c.status === 'accepted').forEach(c => {
              const name = c.user?.full_name || c.email;
              preset.innerHTML += `<option value="${c.id}" data-name="${escapeHtml(name)}" data-email="${escapeHtml(c.email)}" data-phone="" data-role="${c.role}">${escapeHtml(name)} (${c.role})</option>`;
            });
          }
        } catch (e) {
          console.error('Error loading collaborators for participant:', e);
        }
      }
    }

    function confirmAddParticipant() {
      const source = document.getElementById('participant-source').value;
      let name, email, phone, role, participantType;

      if (source === 'manual') {
        name = document.getElementById('participant-name').value.trim();
        email = document.getElementById('participant-email').value.trim().toLowerCase();
        phone = document.getElementById('participant-phone').value.trim();
        role = document.getElementById('participant-role').value;
        participantType = document.getElementById('participant-type').value;

        if (!email) {
          showToast('Email is required', 'warning');
          return;
        }
      } else {
        const preset = document.getElementById('participant-preset');
        const option = preset.options[preset.selectedIndex];
        if (!option || !option.value) {
          showToast('Please select a person', 'warning');
          return;
        }
        name = option.dataset.name;
        email = option.dataset.email;
        phone = option.dataset.phone || '';
        role = option.dataset.role || (source === 'customer' ? 'customer' : source === 'lead' ? 'customer' : 'other');
        participantType = 'attendee';
      }

      // Check for duplicates
      if (eventParticipants.some(p => p.email.toLowerCase() === email.toLowerCase())) {
        showToast('This email is already added', 'warning');
        return;
      }

      eventParticipants.push({ name, email, phone, role, participant_type: participantType });
      renderEventParticipants();
      cancelAddParticipant();
    }

    function removeEventParticipant(index) {
      eventParticipants.splice(index, 1);
      renderEventParticipants();
    }

    function renderEventParticipants() {
      const container = document.getElementById('event-participants-list');
      if (eventParticipants.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">No participants added yet</div>';
        return;
      }

      container.innerHTML = eventParticipants.map((p, i) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--dark-elevated); border-radius: 8px; margin-bottom: 6px;">
          <div style="flex: 1; min-width: 0;">
            <div style="font-size: 13px; font-weight: 500;">${escapeHtml(p.name || p.email)}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(p.email)} • ${p.role}${p.participant_type === 'optional' ? ' (optional)' : ''}</div>
          </div>
          <button type="button" class="btn-modern ghost" onclick="removeEventParticipant(${i})" style="padding: 4px 8px; color: var(--error);">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      `).join('');
    }

    async function submitCalendarEvent(event) {
      event.preventDefault();
      const btn = document.getElementById('save-calendar-event-btn');
      const eventId = document.getElementById('cal-event-id').value;

      const title = document.getElementById('cal-event-title').value.trim();
      const eventType = document.getElementById('cal-event-type').value;
      const status = document.getElementById('cal-event-status').value;
      const startDate = document.getElementById('cal-event-start-date').value;
      const startTime = document.getElementById('cal-event-start-time').value;
      const endDate = document.getElementById('cal-event-end-date').value || startDate;
      const endTime = document.getElementById('cal-event-end-time').value || startTime;
      const location = document.getElementById('cal-event-location').value.trim();
      const description = document.getElementById('cal-event-description').value.trim();
      const leadId = document.getElementById('cal-event-lead').value;
      const customerId = document.getElementById('cal-event-customer').value;
      // Get project from visible dropdown (preferred) or hidden input
      const projectId = document.getElementById('cal-event-project-select')?.value ||
                        document.getElementById('cal-event-project').value;

      // Reminders
      const reminders = [];
      if (document.getElementById('cal-reminder-24h').checked) reminders.push(1440);
      if (document.getElementById('cal-reminder-1h').checked) reminders.push(60);
      const notifyParticipants = document.getElementById('cal-notify-participants').checked;

      if (!title || !startDate || !startTime) {
        showToast('Please fill in required fields', 'warning');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        // Create proper ISO timestamps with local timezone
        const startDateTime = new Date(`${startDate}T${startTime}:00`);
        const endDateTime = new Date(`${endDate}T${endTime}:00`);

        const payload = {
          title,
          event_type: eventType,
          status,
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          location: location || undefined,
          description: description || undefined,
          lead_id: leadId || undefined,
          customer_id: customerId || undefined,
          project_id: projectId || undefined,
          reminder_minutes: reminders,
          notify_participants: notifyParticipants,
          participants: eventParticipants
        };

        const url = eventId ? `/api/calendar/events/${eventId}` : '/api/calendar/events';
        const method = eventId ? 'PUT' : 'POST';

        const resp = await apiCall(url, {
          method,
          body: JSON.stringify(payload)
        });

        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to save event');

        showToast(eventId ? 'Event updated!' : 'Event created!', 'success');
        closeCalendarEventModal();
        loadCalendarEvents();
        loadFullCalendarEvents(); // Load the new calendar events

      } catch (err) {
        console.error('Error saving calendar event:', err);
        showToast(err.message || 'Failed to save event', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Event';
      }
    }

    // Simplified calendar event submission (saves directly to Supabase)
    async function submitCalendarEventSimple(event) {
      event.preventDefault();
      const btn = document.getElementById('save-calendar-event-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please sign in to create events');

        const title = document.getElementById('cal-event-title').value.trim();
        const eventType = document.getElementById('cal-event-type').value;
        const meetingFormat = document.getElementById('cal-event-meeting-format')?.value || 'in_person';
        const startDate = document.getElementById('cal-event-start-date').value;
        const startTime = document.getElementById('cal-event-start-time').value || '09:00';
        const endTime = document.getElementById('cal-event-end-time').value || '10:00';
        const description = document.getElementById('cal-event-description').value.trim();

        // Get contact info - from selected contact or manual entry
        const contactType = document.getElementById('cal-event-contact-type')?.value || 'manual';
        const contactId = document.getElementById('cal-event-contact-id')?.value || null;
        const contactName = document.getElementById('cal-event-contact-chip-name')?.textContent?.trim() ||
                           document.getElementById('cal-event-contact-search')?.value?.trim() || '';
        const contactEmail = document.getElementById('cal-event-contact-email')?.value?.trim() || '';
        const contactPhone = document.getElementById('cal-event-contact-phone')?.value?.trim() || '';

        // Get location based on meeting format
        let location = '';
        let meetingDetails = {};

        switch (meetingFormat) {
          case 'in_person':
            location = document.getElementById('cal-event-location').value.trim();
            break;
          case 'phone_call':
            location = contactPhone ? `Phone: ${contactPhone}` : 'Phone Call';
            meetingDetails.phone = contactPhone;
            break;
          case 'video_call':
            const videoPlatform = document.getElementById('cal-event-video-platform')?.value || '';
            const videoLink = document.getElementById('cal-event-video-link')?.value?.trim() || '';
            const platformNames = {
              zoom: 'Zoom',
              google_meet: 'Google Meet',
              teams: 'Microsoft Teams',
              facetime: 'FaceTime',
              other: 'Video Call'
            };
            location = platformNames[videoPlatform] || 'Video Call';
            if (videoLink) location += `: ${videoLink}`;
            meetingDetails.video_platform = videoPlatform;
            meetingDetails.video_link = videoLink;
            break;
          case 'conference_call':
            const confNumber = document.getElementById('cal-event-conference-number')?.value?.trim() || '';
            const confCode = document.getElementById('cal-event-conference-code')?.value?.trim() || '';
            const confPin = document.getElementById('cal-event-conference-pin')?.value?.trim() || '';
            location = confNumber ? `Conference: ${confNumber}` : 'Conference Call';
            if (confCode) location += ` (Code: ${confCode})`;
            meetingDetails.conference_number = confNumber;
            meetingDetails.conference_code = confCode;
            meetingDetails.conference_pin = confPin;
            break;
          default:
            location = document.getElementById('cal-event-location').value.trim();
        }

        if (!title || !startDate) {
          showToast('Please enter a title and date', 'warning');
          btn.disabled = false;
          btn.textContent = 'Save Event';
          return;
        }

        // Create proper ISO timestamps with local timezone
        const startDateTime = new Date(`${startDate}T${startTime}:00`);
        const endDateTime = new Date(`${startDate}T${endTime}:00`);

        // Get contact address from selected contact data
        const contactAddress = selectedContactData?.address || document.getElementById('cal-event-location')?.value?.trim() || '';

        const eventData = {
          created_by: user.id,
          title,
          event_type: eventType,
          status: 'scheduled',
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          location: location || null,
          description: description || null,
          metadata: {
            meeting_format: meetingFormat,
            contact_name: contactName,
            contact_email: contactEmail,
            contact_phone: contactPhone,
            contact_address: contactAddress,
            contact_type: contactType,
            contact_id: contactId,
            meeting_details: meetingDetails
          }
        };

        // Add optional links
        const leadId = document.getElementById('cal-event-lead')?.value;
        const customerId = document.getElementById('cal-event-customer')?.value;
        // Get project from visible dropdown (preferred) or hidden input
        const projectId = document.getElementById('cal-event-project-select')?.value ||
                          document.getElementById('cal-event-project')?.value;
        if (leadId) eventData.lead_id = leadId;
        if (customerId) eventData.customer_id = customerId;
        if (projectId) eventData.project_id = projectId;

        const eventId = document.getElementById('cal-event-id').value;
        let result;

        if (eventId) {
          // Update existing
          result = await supabaseClient
            .from('calendar_events')
            .update(eventData)
            .eq('id', eventId)
            .select();
        } else {
          // Create new
          result = await supabaseClient
            .from('calendar_events')
            .insert(eventData)
            .select();
        }

        if (result.error) throw result.error;

        const savedEvent = result.data?.[0];

        // Add participants to the event
        if (savedEvent) {
          // Combine enhanced eventParticipants with legacy contractor select
          const allParticipants = [...eventParticipants];
          const legacyContractors = getSelectedContractorsAsParticipants();
          legacyContractors.forEach(lc => {
            if (!allParticipants.some(p => p.email && lc.email && p.email.toLowerCase() === lc.email.toLowerCase())) {
              allParticipants.push(lc);
            }
          });

          // Also add customer contact as participant if provided and not already in list
          if (contactEmail && !allParticipants.some(p => p.email && p.email.toLowerCase() === contactEmail.toLowerCase())) {
            allParticipants.push({
              email: contactEmail,
              name: contactName || 'Customer',
              phone: contactPhone || '',
              role: 'customer',
              participant_type: 'attendee'
            });
          }

          // Insert participants
          if (allParticipants.length > 0) {
            const participantRecords = allParticipants
              .filter(p => p.email) // Only add those with emails
              .map(p => ({
                event_id: savedEvent.id,
                email: p.email.toLowerCase(),
                name: p.name,
                phone: p.phone || null,
                participant_type: p.participant_type || 'attendee',
                response_status: 'pending'
              }));
            if (participantRecords.length > 0) {
              // Clear existing participants first if updating
              if (eventId) {
                await supabaseClient
                  .from('calendar_event_participants')
                  .delete()
                  .eq('event_id', savedEvent.id);
              }
              await supabaseClient
                .from('calendar_event_participants')
                .insert(participantRecords);
            }
          }
        }

        // If linked to a lead, update the lead's appointment status
        if (leadId && !eventId) {
          try {
            await supabaseClient
              .from('leads')
              .update({
                appointment_status: 'scheduled',
                appointment_date: startDate,
                appointment_time: startTime,
                updated_at: new Date().toISOString()
              })
              .eq('id', leadId);
          } catch (leadErr) {
            console.warn('Could not update lead status:', leadErr.message);
          }
        }

        showToast(eventId ? 'Event updated!' : 'Event created!', 'success');
        closeCalendarEventModal();
        // IMPORTANT: Load events sequentially to avoid race condition
        // loadCalendarEvents clears the array, then loadAllCalendarEvents adds API events
        await loadCalendarEvents();
        await loadAllCalendarEvents();
        console.log('[Calendar] Events reloaded after save, total:', calendarEvents.length);

      } catch (err) {
        console.error('Error saving event:', err);
        showToast(err.message || 'Failed to save event', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Save Event';
      }
    }

    // Full calendar events from Supabase (faster than API)
    let fullCalendarEvents = [];

    async function loadAllCalendarEvents() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Use global isAdmin variable set by loadUserProfile()
        // Note: Don't create local const - global isAdmin is already set correctly
        console.log('[Calendar] isAdmin check:', isAdmin, 'isSuperAdmin:', isSuperAdmin);

        // Build query - admins see all, others see only their own
        let query = supabaseClient
          .from('calendar_events')
          .select('id, title, event_type, status, start_time, end_time, location, lead_id, customer_id, project_id, metadata, created_by')
          .neq('status', 'cancelled')
          .gte('start_time', new Date(Date.now() - 30*24*60*60*1000).toISOString()) // Last 30 days
          .lte('start_time', new Date(Date.now() + 90*24*60*60*1000).toISOString()) // Next 90 days
          .order('start_time', { ascending: true });

        // Only filter by created_by if NOT admin
        if (!isAdmin) {
          query = query.eq('created_by', user.id);
        }

        const { data: events, error } = await query;

        console.log('[Calendar] Loading events, isAdmin:', isAdmin, 'events found:', events?.length || 0);

        if (error) {
          console.warn('Calendar events load error:', error.message);
          // Just use jobs-based events
          renderCalendar();
          renderUpcomingEvents();
          return;
        }

        if (events && events.length > 0) {
          console.log('[Calendar] Events:', events.map(e => ({ id: e.id, title: e.title, date: e.start_time?.split('T')[0], status: e.status })));
        }

        // IMPORTANT: Remove all API-sourced events first (to handle deletions)
        // Keep only job-based events (those without apiEventId)
        calendarEvents = calendarEvents.filter(e => !e.apiEventId);

        // Add fresh events from database
        (events || []).forEach(event => {
          // Convert to local date (not UTC) for calendar display
          const eventDate = new Date(event.start_time);
          const year = eventDate.getFullYear();
          const month = String(eventDate.getMonth() + 1).padStart(2, '0');
          const day = String(eventDate.getDate()).padStart(2, '0');
          const date = `${year}-${month}-${day}`;

          calendarEvents.push({
            date,
            title: event.title,
            type: event.event_type,
            apiEventId: event.id,
            status: event.status,
            location: event.location,
            metadata: event.metadata
          });
        });

        renderCalendar();
        renderUpcomingEvents();
      } catch (err) {
        console.error('Error loading calendar events:', err);
      }
    }

    // Legacy function for compatibility
    async function loadFullCalendarEvents() {
      return loadAllCalendarEvents();
    }

    function mergeCalendarEvents() {
      renderCalendar();
      renderUpcomingEvents();
    }

    function openCalendarEventDetailModal(eventId) {
      const modal = document.getElementById('calendar-event-detail-modal');
      const content = document.getElementById('event-detail-content');
      const actions = document.getElementById('event-detail-actions');

      modal.classList.add('active');
      content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div></div>';

      loadCalendarEventDetail(eventId, content, actions);
    }

    function closeCalendarEventDetailModal() {
      document.getElementById('calendar-event-detail-modal').classList.remove('active');
    }

    async function loadCalendarEventDetail(eventId, content, actions) {
      try {
        // Load directly from Supabase for speed
        const { data: event, error } = await supabaseClient
          .from('calendar_events')
          .select('*')
          .eq('id', eventId)
          .single();

        if (error) throw error;

        // Try to get full address from metadata or linked records
        let fullAddress = event.location || '';
        let addressForMap = fullAddress;

        // Check metadata for address fields
        if (event.metadata) {
          const meta = event.metadata;
          // Build address from parts if available
          if (meta.address || meta.street_address) {
            const parts = [
              meta.address || meta.street_address,
              meta.city,
              meta.state,
              meta.zip || meta.zip_code || meta.postal_code
            ].filter(Boolean);
            if (parts.length > 1) {
              fullAddress = parts.join(', ');
              addressForMap = fullAddress;
            }
          }
          // Also check for contact_address
          if (meta.contact_address && meta.contact_address.length > fullAddress.length) {
            fullAddress = meta.contact_address;
            addressForMap = fullAddress;
          }
        }

        // If we have a lead_id, try to get the lead's address
        if (event.lead_id && (!fullAddress || fullAddress.length < 10)) {
          const { data: lead } = await supabaseClient
            .from('leads')
            .select('address, city, state, zip, full_name')
            .eq('id', event.lead_id)
            .single();
          if (lead) {
            const parts = [lead.address, lead.city, lead.state, lead.zip].filter(Boolean);
            if (parts.length > 1) {
              fullAddress = parts.join(', ');
              addressForMap = fullAddress;
            }
          }
        }

        // If we have a customer_id, try to get the customer's address
        if (event.customer_id && (!fullAddress || fullAddress.length < 10)) {
          const { data: customer } = await supabaseClient
            .from('customers')
            .select('address, city, state, zip, name')
            .eq('id', event.customer_id)
            .single();
          if (customer) {
            const parts = [customer.address, customer.city, customer.state, customer.zip].filter(Boolean);
            if (parts.length > 1) {
              fullAddress = parts.join(', ');
              addressForMap = fullAddress;
            }
          }
        }

        const typeColors = {
          appointment: '#3b82f6',
          measurement: '#f59e0b',
          installation: '#10b981',
          delivery: '#06b6d4',
          meeting: '#8b5cf6',
          follow_up: '#6b7280',
          consultation: '#ec4899',
          site_visit: '#f97316',
          other: '#6b7280'
        };
        const color = typeColors[event.event_type] || '#6b7280';

        const startTime = new Date(event.start_time);
        const endTime = new Date(event.end_time);
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const timeOptions = { hour: 'numeric', minute: '2-digit' };

        // Status colors
        const statusColors = {
          scheduled: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b', label: 'Pending Confirmation' },
          confirmed: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981', label: 'Confirmed' },
          completed: { bg: 'rgba(99, 102, 241, 0.15)', color: '#6366f1', label: 'Completed' },
          cancelled: { bg: 'rgba(239, 68, 68, 0.15)', color: '#ef4444', label: 'Cancelled' },
          rescheduled: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6', label: 'Rescheduled' },
          no_show: { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280', label: 'No Show' }
        };
        const statusStyle = statusColors[event.status] || statusColors.scheduled;

        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <span style="display: inline-block; padding: 4px 12px; background: ${color}20; color: ${color}; border-radius: 16px; font-size: 12px; font-weight: 600; text-transform: capitalize;">${event.event_type.replace('_', ' ')}</span>
            <span style="display: inline-block; padding: 4px 12px; background: ${statusStyle.bg}; color: ${statusStyle.color}; border-radius: 16px; font-size: 12px; margin-left: 8px; font-weight: 500;">${statusStyle.label}</span>
          </div>

          <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; text-align: center;">${escapeHtml(event.title)}</h3>

          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
              <span style="font-size: 14px;">${startTime.toLocaleDateString('en-US', dateOptions)}</span>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
              <span style="font-size: 14px;">${startTime.toLocaleTimeString('en-US', timeOptions)} - ${endTime.toLocaleTimeString('en-US', timeOptions)}</span>
            </div>
            ${fullAddress ? `
            <div style="display: flex; align-items: flex-start; gap: 10px; margin-top: 10px;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted); flex-shrink: 0; margin-top: 2px;"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
              <span style="font-size: 14px; flex: 1;">${escapeHtml(fullAddress)}</span>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(addressForMap)}" target="_blank" style="color: var(--gold-primary); font-size: 12px; white-space: nowrap; display: flex; align-items: center; gap: 4px;">
                <i class="fa-solid fa-diamond-turn-right"></i> Directions
              </a>
            </div>
            ${addressForMap.length > 10 ? `<div id="event-detail-map" style="margin-top: 10px; border-radius: 8px; overflow: hidden; height: 120px;"></div>` : ''}
            ` : ''}
          </div>

          ${event.description ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Description</div>
            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${escapeHtml(event.description)}</div>
          </div>
          ` : ''}

          ${(event.metadata?.contact_name || event.metadata?.contact_email || event.metadata?.contact_phone) ? `
          <div style="margin-bottom: 16px;">
            <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Contact</div>
            <div style="padding: 12px; background: var(--dark-surface); border-radius: 8px;">
              ${event.metadata.contact_name ? `<div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">${escapeHtml(event.metadata.contact_name)}</div>` : ''}
              ${event.metadata.contact_email ? `
              <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <a href="mailto:${escapeHtml(event.metadata.contact_email)}" style="color: var(--accent);">${escapeHtml(event.metadata.contact_email)}</a>
              </div>
              ` : ''}
              ${event.metadata.contact_phone ? `
              <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="color: var(--text-muted);"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                <a href="tel:${escapeHtml(event.metadata.contact_phone)}" style="color: var(--accent);">${escapeHtml(event.metadata.contact_phone)}</a>
              </div>
              ` : ''}
            </div>
          </div>
          ` : ''}
        `;

        // Store event for Google Calendar link
        window.currentDetailEvent = event;

        // Actions - with confirm button for scheduled events
        const isScheduled = event.status === 'scheduled';
        const isConfirmed = event.status === 'confirmed';

        // Generate Google Calendar URL
        const gcalUrl = generateGoogleCalendarUrl(event);

        actions.innerHTML = `
          <button type="button" class="btn-modern ghost" onclick="deleteCalendarEvent('${event.id}')" style="color: #ef4444;">
            <i class="fa-solid fa-trash" style="margin-right: 4px;"></i>
            Delete
          </button>
          <a href="${gcalUrl}" target="_blank" class="btn-modern ghost" style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
            <i class="fa-brands fa-google" style="color: #4285f4;"></i>
            Add to Calendar
          </a>
          <div style="flex: 1;"></div>
          ${isScheduled ? `
          <button type="button" class="btn-modern" onclick="confirmCalendarEvent('${event.id}')" style="background: #10b981; color: white;">
            <i class="fa-solid fa-check" style="margin-right: 4px;"></i>
            Confirm
          </button>
          ` : ''}
          <button type="button" class="btn-modern secondary" onclick="closeCalendarEventDetailModal()">Close</button>
          <button type="button" class="btn-modern primary" onclick="closeCalendarEventDetailModal(); openCalendarEventModal('${event.id}')">
            <i class="fa-solid fa-pen-to-square" style="margin-right: 4px;"></i>
            Edit
          </button>
        `;

        // Initialize map for location if Google Maps is ready and we have a valid address
        if (addressForMap && addressForMap.length > 10 && googleMapsReady && !googleMapsError) {
          initEventDetailMap(addressForMap);
        }

      } catch (err) {
        console.error('Error loading event detail:', err);
        content.innerHTML = '<div class="empty-state"><p style="color: var(--error);">Failed to load event details</p></div>';
      }
    }

    async function notifyEventParticipants(eventId) {
      try {
        const resp = await apiCall(`/api/calendar/events/${eventId}/notify`, { method: 'POST' });
        const data = await resp.json();

        if (!resp.ok) throw new Error(data.error || 'Failed to send notifications');

        showToast(`Notifications sent to ${data.notified || 0} participants`, 'success');
      } catch (err) {
        console.error('Error notifying participants:', err);
        showToast(err.message || 'Failed to send notifications', 'error');
      }
    }

    async function deleteCalendarEvent(eventId) {
      if (!confirm('Delete this event? This cannot be undone.')) return;

      try {
        const { error } = await supabaseClient
          .from('calendar_events')
          .delete()
          .eq('id', eventId);

        if (error) throw error;

        showToast('Event deleted', 'success');
        closeCalendarEventDetailModal();
        loadAllCalendarEvents();
      } catch (err) {
        console.error('Error deleting event:', err);
        showToast('Failed to delete event', 'error');
      }
    }

    // Confirm a scheduled calendar event
    async function confirmCalendarEvent(eventId) {
      try {
        showToast('Confirming event...', 'info');

        // Update event status to confirmed
        const { data: event, error } = await supabaseClient
          .from('calendar_events')
          .update({
            status: 'confirmed',
            updated_at: new Date().toISOString()
          })
          .eq('id', eventId)
          .select('*, calendar_event_participants(*)')
          .single();

        if (error) throw error;

        // Mark as confirmed in state manager
        if (typeof StateManager !== 'undefined') {
          StateManager.markEventConfirmed(eventId, currentUser?.id, new Date().toISOString());
        }

        // Send confirmation notification to participants
        const participants = event.calendar_event_participants || [];
        const customerParticipant = participants.find(p => p.participant_type === 'attendee');

        if (customerParticipant?.email) {
          try {
            const eventDate = new Date(event.start_time).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const eventTime = new Date(event.start_time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const confirmationMessage = `
              <p>Hi ${customerParticipant.name || 'there'},</p>
              <p>Great news! Your appointment has been <strong>confirmed</strong>.</p>
              <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 16px; margin: 20px 0;">
                <p style="margin: 0 0 8px; font-weight: 600;">${event.title}</p>
                <p style="margin: 0 0 4px;">📅 ${eventDate}</p>
                <p style="margin: 0 0 4px;">🕐 ${eventTime}</p>
                ${event.location ? `<p style="margin: 0;">📍 ${event.location}</p>` : ''}
              </div>
              <p>We look forward to seeing you!</p>
              <p>If you need to reschedule, please call us at <a href="tel:+16028333189">(602) 833-3189</a>.</p>
            `;

            await apiCall('/api/email/notify', {
              method: 'POST',
              body: JSON.stringify({
                to: customerParticipant.email,
                subject: 'Your Appointment is Confirmed - ' + event.title,
                message: confirmationMessage,
                type: 'success',
                rawHtml: true
              })
            });
          } catch (notifyErr) {
            console.warn('Failed to send confirmation notification:', notifyErr);
          }
        }

        // Update participant response status
        if (customerParticipant) {
          await supabaseClient
            .from('calendar_event_participants')
            .update({
              response_status: 'accepted',
              responded_at: new Date().toISOString()
            })
            .eq('id', customerParticipant.id);
        }

        showToast('Event confirmed!', 'success');
        closeCalendarEventDetailModal();
        loadAllCalendarEvents();

        // Also refresh dashboard widgets
        if (typeof loadDashboardWidgets === 'function') {
          loadDashboardWidgets();
        }

      } catch (err) {
        console.error('Error confirming event:', err);
        showToast('Failed to confirm: ' + err.message, 'error');
      }
    }

    async function loadCalendarEventForEdit(eventId) {
      try {
        const resp = await apiCall(`/api/calendar/events/${eventId}`);
        const data = await resp.json();

        if (!resp.ok) throw new Error(data.error || 'Failed to load event');

        const event = data.event;

        document.getElementById('cal-event-title').value = event.title || '';
        document.getElementById('cal-event-type').value = event.event_type || 'appointment';
        document.getElementById('cal-event-status').value = event.status || 'scheduled';

        const startTime = new Date(event.start_time);
        const endTime = new Date(event.end_time);
        // Use local date/time (not UTC) for form fields
        const startYear = startTime.getFullYear();
        const startMonth = String(startTime.getMonth() + 1).padStart(2, '0');
        const startDay = String(startTime.getDate()).padStart(2, '0');
        const startHours = String(startTime.getHours()).padStart(2, '0');
        const startMins = String(startTime.getMinutes()).padStart(2, '0');
        document.getElementById('cal-event-start-date').value = `${startYear}-${startMonth}-${startDay}`;
        document.getElementById('cal-event-start-time').value = `${startHours}:${startMins}`;

        const endYear = endTime.getFullYear();
        const endMonth = String(endTime.getMonth() + 1).padStart(2, '0');
        const endDay = String(endTime.getDate()).padStart(2, '0');
        const endHours = String(endTime.getHours()).padStart(2, '0');
        const endMins = String(endTime.getMinutes()).padStart(2, '0');
        document.getElementById('cal-event-end-date').value = `${endYear}-${endMonth}-${endDay}`;
        document.getElementById('cal-event-end-time').value = `${endHours}:${endMins}`;

        document.getElementById('cal-event-location').value = event.location || '';
        document.getElementById('cal-event-description').value = event.description || '';
        document.getElementById('cal-event-customer').value = event.customer_id || '';
        // Use project_id with fallback to job_id for backward compatibility
        const projectIdToUse = event.project_id || event.job_id || '';
        document.getElementById('cal-event-project').value = projectIdToUse;
        const projectSelect = document.getElementById('cal-event-project-select');
        if (projectSelect) projectSelect.value = projectIdToUse;

        // Load participants
        if (event.participants) {
          eventParticipants = event.participants.map(p => ({
            name: p.name,
            email: p.email,
            phone: p.phone || '',
            role: p.role || 'attendee',
            participant_type: p.participant_type || 'attendee'
          }));
          renderEventParticipants();
        }

        // Reminders
        const reminders = event.reminder_minutes || [];
        document.getElementById('cal-reminder-24h').checked = reminders.includes(1440);
        document.getElementById('cal-reminder-1h').checked = reminders.includes(60);

      } catch (err) {
        console.error('Error loading event for edit:', err);
        showToast('Failed to load event', 'error');
        closeCalendarEventModal();
      }
    }

    // Bridge 3: Navigate to a collaboration project
    function viewCollaborationProject(projectId) {
      if (!projectId) return;
      if (typeof openProjectDetail === 'function') {
        openProjectDetail(projectId);
      } else {
        showPage('projects');
        setTimeout(function() {
          if (typeof openProjectDetail === 'function') {
            openProjectDetail(projectId);
          }
        }, 500);
      }
    }

    // Bridge 3b: Customer/viewer read-only project view
    async function openCustomerProjectView(projectId) {
      var modal = document.getElementById('project-detail-modal');
      var body = document.getElementById('project-detail-body');
      modal.classList.add('active');
      body.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="margin: 0 auto;"></div></div>';

      try {
        var result = await supabaseClient.from('projects').select('*').eq('id', projectId).single();
        var project = result.data;

        if (!project) {
          body.innerHTML = '<div class="empty-state"><h3>Project not accessible</h3><p>You may not have permission to view this project.</p></div>';
          return;
        }

        var statusColor = PROJECT_STATUS_COLORS[project.status] || '#6b7280';
        var statusLabel = PROJECT_STATUS_LABELS[project.status] || project.status;
        var progress = project.progress || 0;

        body.innerHTML =
          '<div style="text-align: center; margin-bottom: 24px;">' +
            '<h2 style="font-size: 20px; font-weight: 700; margin-bottom: 10px;">' + escapeHtml(project.name) + '</h2>' +
            '<span style="display: inline-block; padding: 4px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; background: ' + statusColor + '20; color: ' + statusColor + ';">' + statusLabel + '</span>' +
            (progress > 0 ? '<div style="margin-top: 12px; max-width: 300px; margin-left: auto; margin-right: auto;"><div style="height: 6px; background: var(--dark-surface); border-radius: 3px; overflow: hidden;"><div style="width: ' + progress + '%; height: 100%; background: var(--gold-primary); border-radius: 3px;"></div></div><div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">' + progress + '% complete</div></div>' : '') +
          '</div>' +
          (project.description ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">' + escapeHtml(project.description) + '</div>' : '') +
          '<div id="customer-view-handoffs" style="margin-bottom: 16px;"><div style="text-align: center; padding: 20px; color: var(--text-muted); font-size: 12px;">Loading handoff status...</div></div>' +
          (project.customer_notes ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Notes</div><div style="font-size: 13px; color: var(--text-secondary);">' + escapeHtml(project.customer_notes) + '</div></div>' : '') +
          '<div style="text-align: center; padding: 12px; font-size: 11px; color: var(--text-muted);">Read-only view</div>';

        // Load handoffs for read-only stage display
        loadCustomerViewHandoffs(projectId);
      } catch (err) {
        body.innerHTML = '<div class="empty-state"><h3>Error loading project</h3><p>' + escapeHtml(err.message || 'Unknown error') + '</p></div>';
      }
    }

    async function loadCustomerViewHandoffs(projectId) {
      var container = document.getElementById('customer-view-handoffs');
      if (!container) return;

      try {
        var resp = await apiCall('/api/collaboration/projects/' + projectId + '/handoffs');
        var data = await resp.json();
        if (!resp.ok || !data.handoffs || !data.handoffs.length) {
          container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">No active handoffs</div>';
          return;
        }

        container.innerHTML = '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Handoff Progress</div>' +
          data.handoffs.map(function(h) {
            var stageIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === h.stage; });
            var stageLabel = HANDOFF_STAGES[stageIdx] ? HANDOFF_STAGES[stageIdx].label : h.stage;
            var pct = Math.round(((stageIdx + 1) / HANDOFF_STAGES.length) * 100);
            return '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 12px; margin-bottom: 8px;">' +
              '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
                '<span style="font-size: 13px; font-weight: 600; color: var(--text-primary);">' + escapeHtml(h.title) + '</span>' +
                '<span style="font-size: 11px; color: var(--gold-primary); font-weight: 500;">' + stageLabel + '</span>' +
              '</div>' +
              '<div style="height: 4px; background: var(--dark-surface); border-radius: 2px; overflow: hidden;"><div style="width: ' + pct + '%; height: 100%; background: var(--gold-primary); border-radius: 2px;"></div></div>' +
            '</div>';
          }).join('');
      } catch (err) {
        container.innerHTML = '<div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">Could not load handoffs</div>';
      }
    }

    // =============================================
    // PROJECT ACTIVITY LOGGING
    // =============================================

    async function logProjectActivity(projectId, action, description) {
      if (!projectId || !currentUser) return;
      try {
        await supabaseClient.from('project_activity').insert({
          project_id: projectId,
          action: action,
          description: description,
          user_id: currentUser.id,
          user_name: userProfile ? (userProfile.full_name || userProfile.email) : currentUser.email
        });
      } catch (err) {
        console.warn('[Activity] Failed to log:', err);
      }
    }

    // =============================================
    // COLLABORATION HELPERS (unified invite wiring)
    // =============================================

    /** Open invite modal for the current job context */
    function inviteCollaboratorForJob() {
      if (!currentJobId) {
        showToast('Please open a job first', 'warning');
        return;
      }
      // Use the job ID as the project context
      openInviteToProjectModal(currentJobId);
    }

    /** Invite a contractor (from contractor cards or contractor profile) as collaborator */
    function inviteContractorAsCollaborator(contractorIdParam) {
      const cId = contractorIdParam || currentContractorId;
      const contractor = allCollaborators.find(function(c) { return c.id === cId; });
      if (!contractor) {
        showToast('Contractor not found', 'error');
        return;
      }
      const roleMap = { fabricator: 'fabricator', installer: 'installer', plumber: 'contractor', electrician: 'contractor', template: 'contractor', other: 'contractor' };
      const role = roleMap[contractor.role] || contractor.role || 'contractor';
      openInviteToProjectModal(null, contractor.email || '', role);
    }

    /** Invite a contractor assigned to the current job as collaborator */
    function inviteJobContractorAsCollaborator(contractorId) {
      if (!currentJobId) return;
      let jc = null;
      const job = allJobs.find(function(j) { return j.id === currentJobId; });
      if (job && job.project_contractors) {
        jc = job.project_contractors.find(function(c) { return c.contractor_id === contractorId; });
      }
      const contractor = allCollaborators.find(function(c) { return c.id === contractorId; });
      const email = contractor ? contractor.email : '';
      let role = (jc && jc.role) || (contractor && contractor.role) || 'contractor';
      const roleMap = { fabricator: 'fabricator', installer: 'installer', plumber: 'contractor', electrician: 'contractor', template: 'contractor', other: 'contractor' };
      role = roleMap[role] || 'contractor';
      openInviteToProjectModal(currentJobId, email, role);
    }

    /** Invite the current job's customer as a collaborator (viewer) */
    function inviteCustomerAsCollaborator() {
      if (!currentJobId) return;
      const job = allJobs.find(function(j) { return j.id === currentJobId; });
      if (!job) return;
      const email = (job.customers && job.customers.email) || job.customer_email || '';
      openInviteToProjectModal(currentJobId, email, 'viewer');
    }

    /** Invite a collaborator for a design project */
    function inviteDesignCollaborator(designId) {
      openInviteToProjectModal(designId, '', 'designer');
    }

    /** Invite collaborator from an estimate (pre-fills customer email) */
    function inviteFromEstimate(estimateId) {
      const estimate = allEstimates.find(function(e) { return e.id === estimateId; });
      const email = (estimate && estimate.customer_email) || '';
      openInviteToProjectModal(null, email, 'viewer');
    }

    /** Invite a lead to collaborate on a project */
    function inviteLeadAsCollaborator() {
      if (!selectedLead) {
        showToast('Please open a lead first', 'warning');
        return;
      }
      openInviteToProjectModal(null, selectedLead.email || '', 'viewer');
    }

    /** Invite a customer to collaborate on a project */
    function inviteCustomerToProject() {
      if (!selectedCustomer) {
        showToast('Please open a customer first', 'warning');
        return;
      }
      openInviteToProjectModal(null, selectedCustomer.email || '', 'viewer');
    }

    // =============================================
    // DESIGN HANDOFF FUNCTIONS
    // =============================================

    const HANDOFF_STAGES = [
      { key: 'design_created', label: 'Created' },
      { key: 'design_review', label: 'Review' },
      { key: 'design_approved', label: 'Approved' },
      { key: 'fabrication_quote_requested', label: 'Quote Req' },
      { key: 'fabrication_quote_received', label: 'Quote Recv' },
      { key: 'fabrication_approved', label: 'Fab Approved' },
      { key: 'materials_ordered', label: 'Ordered' },
      { key: 'fabrication_in_progress', label: 'Fabricating' },
      { key: 'fabrication_complete', label: 'Fab Done' },
      { key: 'install_scheduled', label: 'Scheduled' },
      { key: 'install_in_progress', label: 'Installing' },
      { key: 'install_complete', label: 'Installed' },
      { key: 'final_review', label: 'Final Review' }
    ];

    function renderHandoffStages(currentStage) {
      const currentIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === currentStage; });
      return '<div class="handoff-stage-tracker">' + HANDOFF_STAGES.map(function(stage, i) {
        let cls = 'future';
        if (i < currentIdx) cls = 'completed';
        else if (i === currentIdx) cls = 'current';
        return '<div class="handoff-stage ' + cls + '">' + stage.label + '</div>';
      }).join('') + '</div>';
    }

    function openStartHandoffModal(designId, designName, preselectedProjectId) {
      document.getElementById('start-handoff-form').reset();
      document.getElementById('handoff-design-id').value = designId || '';
      if (designName) {
        document.getElementById('handoff-title').value = designName + ' - Fabrication Handoff';
      }
      document.getElementById('start-handoff-modal').classList.add('active');
      loadHandoffProjectOptions(preselectedProjectId);
      loadHandoffParticipants();
    }

    function closeStartHandoffModal() {
      document.getElementById('start-handoff-modal').classList.remove('active');
    }

    async function loadHandoffProjectOptions(preselectedId) {
      const select = document.getElementById('handoff-project-select');
      select.innerHTML = '<option value="">Loading projects...</option>';
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) { select.innerHTML = '<option value="">Not authenticated</option>'; return; }
        const { data: projects } = await supabaseClient
          .from('projects')
          .select('id, name')
          .eq('user_id', user.id)
          .order('created_at', { ascending: false })
          .limit(50);

        select.innerHTML = '<option value="">Select a Project</option>';
        if (projects && projects.length > 0) {
          projects.forEach(function(p) {
            const opt = document.createElement('option');
            opt.value = p.id;
            opt.textContent = p.name || 'Untitled';
            if (preselectedId && p.id === preselectedId) opt.selected = true;
            select.appendChild(opt);
          });
        }
      } catch (err) {
        console.error('Error loading projects for handoff:', err);
        select.innerHTML = '<option value="">Error loading projects</option>';
      }
    }

    async function loadHandoffParticipants() {
      const fabSelect = document.getElementById('handoff-fabricator');
      const conSelect = document.getElementById('handoff-contractor');
      fabSelect.innerHTML = '<option value="">None (assign later)</option>';
      conSelect.innerHTML = '<option value="">None (assign later)</option>';

      try {
        // Use allCollaborators if available, otherwise load
        let collaborators = typeof allCollaborators !== 'undefined' ? allCollaborators : [];
        if (collaborators.length === 0 && typeof loadCollaborators === 'function') {
          await loadCollaborators();
          collaborators = typeof allCollaborators !== 'undefined' ? allCollaborators : [];
        }
        collaborators.forEach(function(c) {
          const name = c.name || c.company || c.email || 'Unknown';
          const cType = (c.role || '').toLowerCase();
          if (cType === 'fabricator' || cType === 'stone_fabricator') {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = name;
            fabSelect.appendChild(opt);
          }
          if (cType === 'installer' || cType === 'general_contractor' || cType === 'contractor') {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = name;
            conSelect.appendChild(opt);
          }
        });
      } catch (err) {
        console.error('Error loading handoff participants:', err);
      }
    }

    async function submitStartHandoff(event) {
      event.preventDefault();
      const btn = document.getElementById('submit-handoff-btn');
      const projectId = document.getElementById('handoff-project-select').value;
      const title = document.getElementById('handoff-title').value.trim();
      const description = document.getElementById('handoff-description').value.trim();
      const fabricatorId = document.getElementById('handoff-fabricator').value;
      const contractorId = document.getElementById('handoff-contractor').value;
      const notes = document.getElementById('handoff-notes').value.trim();

      if (!projectId) {
        showToast('Please select a project', 'warning');
        return false;
      }
      if (!title) {
        showToast('Please enter a handoff title', 'warning');
        return false;
      }

      btn.disabled = true;
      btn.textContent = 'Starting Handoff...';

      try {
        const body = { title: title, description: description || undefined, notes: notes || undefined };
        if (fabricatorId) body.fabricator_id = fabricatorId;
        if (contractorId) body.contractor_id = contractorId;

        const designId = document.getElementById('handoff-design-id').value;
        if (designId) body.design_file_url = '/tools/room-designer/?p=' + designId;

        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/handoffs', {
          method: 'POST',
          body: JSON.stringify(body)
        });

        let data;
        try { data = await resp.json(); } catch (e) {
          throw new Error('Server returned invalid response (status ' + resp.status + ')');
        }

        if (!resp.ok) {
          throw new Error(data.error || 'Failed to create handoff');
        }

        showToast('Design handoff started!', 'success');
        closeStartHandoffModal();

        // Log activity
        logProjectActivity(projectId, 'handoff_created', 'Design handoff "' + title + '" created');

        // If fabricator or contractor was assigned, suggest inviting them
        if (fabricatorId || contractorId) {
          showToast('Tip: Invite your fabricator/contractor as a collaborator so they can track progress', 'info');
        }

      } catch (err) {
        console.error('[Handoff] Error creating:', err);
        showToast(err.message || 'Error starting handoff', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg> Start Handoff';
      }
      return false;
    }

    // Store current handoff for cross-system bridges (e.g., convert to estimate)
    let currentHandoffData = null;

    async function openHandoffDetailModal(handoffId) {
      const modal = document.getElementById('handoff-detail-modal');
      const content = document.getElementById('handoff-detail-content');
      modal.classList.add('active');
      content.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p style="color: var(--text-muted); margin-top: 12px;">Loading handoff...</p></div>';

      try {
        const resp = await apiCall('/api/collaboration/handoffs/' + handoffId);
        let data;
        try { data = await resp.json(); } catch (e) {
          throw new Error('Invalid server response');
        }
        if (!resp.ok) throw new Error(data.error || 'Failed to load handoff');

        const h = data.handoff || data;
        currentHandoffData = h;
        document.getElementById('handoff-detail-title').textContent = h.title || 'Design Handoff';

        const stage = h.stage || 'design_created';
        const stageIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === stage; });
        const stageLabel = HANDOFF_STAGES[stageIdx] ? HANDOFF_STAGES[stageIdx].label : stage;
        const isComplete = stage === 'final_review' && h.completed_at;

        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 16px;">
            <span style="display: inline-block; padding: 6px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; background: ${isComplete ? 'rgba(34,197,94,0.15)' : 'rgba(212,175,55,0.2)'}; color: ${isComplete ? '#22c55e' : 'var(--gold-primary)'};">
              ${isComplete ? 'Completed' : stageLabel}
            </span>
            <div style="font-size: 12px; color: var(--text-muted); margin-top: 6px;">Stage ${stageIdx + 1} of ${HANDOFF_STAGES.length}</div>
          </div>
          ${renderHandoffStages(stage)}
          ${h.description ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); line-height: 1.5;">' + escapeHtml(h.description) + '</div>' : ''}
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <div class="handoff-participant">
              <div class="handoff-participant-avatar">${h.designer_name ? h.designer_name.charAt(0).toUpperCase() : 'D'}</div>
              <div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Designer</div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${escapeHtml(h.designer_name || h.designer_email || 'You')}</div>
              </div>
            </div>
            <div class="handoff-participant">
              <div class="handoff-participant-avatar" style="background: #3b82f6;">${h.fabricator_name ? h.fabricator_name.charAt(0).toUpperCase() : '?'}</div>
              <div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Fabricator</div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${escapeHtml(h.fabricator_name || h.fabricator_email || 'Not assigned')}</div>
              </div>
            </div>
            <div class="handoff-participant">
              <div class="handoff-participant-avatar" style="background: #8b5cf6;">${h.contractor_name ? h.contractor_name.charAt(0).toUpperCase() : '?'}</div>
              <div>
                <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Installer</div>
                <div style="font-size: 12px; font-weight: 600; color: var(--text-primary);">${escapeHtml(h.contractor_name || h.contractor_email || 'Not assigned')}</div>
              </div>
            </div>
          </div>
          ${h.notes ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;"><div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;">Notes</div><div style="font-size: 13px; color: var(--text-secondary);">' + escapeHtml(h.notes) + '</div></div>' : ''}
          ${h.quote_amount
            ? '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
                  '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Fabrication Quote</div>' +
                  '<button class="btn-modern secondary" style="padding: 4px 10px; font-size: 11px;" onclick="document.getElementById(\'handoff-quote-edit-section\').style.display=document.getElementById(\'handoff-quote-edit-section\').style.display===\'none\'?\'block\':\'none\'">Edit Quote</button>' +
                '</div>' +
                '<div style="font-size: 20px; font-weight: 700; color: var(--gold-primary); margin-bottom: 4px;">$' + parseFloat(h.quote_amount).toLocaleString('en-US', {minimumFractionDigits: 2}) + '</div>' +
                (h.scheduled_date ? '<div style="font-size: 12px; color: var(--text-secondary);">Install: ' + new Date(h.scheduled_date).toLocaleDateString() + '</div>' : '') +
                '<div id="handoff-quote-edit-section" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-subtle);">' +
                  '<div style="display: flex; gap: 10px; align-items: flex-end;">' +
                    '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Quote Amount ($)</label><input type="number" id="handoff-quote-input" min="0" step="0.01" value="' + (parseFloat(h.quote_amount) || '') + '" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                    '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Install Date</label><input type="date" id="handoff-date-input" value="' + (h.scheduled_date ? new Date(h.scheduled_date).toISOString().split('T')[0] : '') + '" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                    '<button class="btn-modern primary" style="padding: 8px 16px; white-space: nowrap;" onclick="saveHandoffQuote(\'' + h.id + '\')">Update</button>' +
                  '</div>' +
                '</div>' +
                '<button class="btn-modern secondary" style="margin-top: 10px; font-size: 12px; width: 100%;" onclick="convertHandoffToEstimate()"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Convert to Estimate</button>' +
              '</div>'
            : '<div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;">' +
                '<div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Fabrication Quote</div>' +
                '<div style="display: flex; gap: 10px; align-items: flex-end;">' +
                  '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Quote Amount ($)</label><input type="number" id="handoff-quote-input" min="0" step="0.01" placeholder="0.00" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                  '<div style="flex: 1;"><label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 4px;">Install Date</label><input type="date" id="handoff-date-input" style="width: 100%; padding: 8px 10px; background: var(--dark-surface); border: 1px solid var(--border-subtle); border-radius: 8px; color: var(--text-primary); font-size: 13px;"/></div>' +
                  '<button class="btn-modern primary" style="padding: 8px 16px; white-space: nowrap;" onclick="saveHandoffQuote(\'' + h.id + '\')">Save</button>' +
                '</div>' +
              '</div>'
          }
          <div style="background: var(--dark-elevated); border-radius: 10px; padding: 14px; margin-bottom: 16px;">
            <div style="font-size: 10px; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px;">Design Files</div>
            ${h.design_file_url
              ? '<a href="' + escapeHtml(h.design_file_url) + '" target="_blank" rel="noopener" style="display: flex; align-items: center; gap: 8px; color: var(--gold-primary); text-decoration: none; font-size: 13px; margin-bottom: 10px;">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg> View Design File' +
                '</a>' +
                '<input type="file" id="handoff-file-input" accept="image/*,.pdf,.dxf,.dwg" style="display:none" onchange="handleHandoffFileUpload(\'' + h.id + '\')"/>' +
                '<button onclick="document.getElementById(\'handoff-file-input\').click()" class="btn-modern secondary" style="width: 100%; font-size: 12px;">Replace File</button>'
              : '<input type="file" id="handoff-file-input" accept="image/*,.pdf,.dxf,.dwg" style="display:none" onchange="handleHandoffFileUpload(\'' + h.id + '\')"/>' +
                '<button onclick="document.getElementById(\'handoff-file-input\').click()" class="btn-modern secondary" style="width: 100%; font-size: 12px;">' +
                  '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>' +
                  'Upload Design File</button>'
            }
          </div>
          <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 16px;">
            Created: ${new Date(h.created_at).toLocaleDateString()}
            ${h.scheduled_date ? ' | Install: ' + new Date(h.scheduled_date).toLocaleDateString() : ''}
          </div>
          ${!isComplete ? '<button class="btn-modern primary" style="width: 100%;" onclick="advanceHandoff(\'' + h.id + '\')"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="margin-right: 6px;"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg> Advance to Next Stage</button>' : '<div style="text-align: center; padding: 12px; color: #22c55e; font-weight: 600;">Handoff Complete</div>'}
        `;
      } catch (err) {
        console.error('[Handoff] Error loading detail:', err);
        content.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--error-color);">' + escapeHtml(err.message || 'Error loading handoff') + '</div>';
      }
    }

    function closeHandoffDetailModal() {
      document.getElementById('handoff-detail-modal').classList.remove('active');
    }

    async function advanceHandoff(handoffId) {
      try {
        const resp = await apiCall('/api/collaboration/handoffs/' + handoffId + '/advance', {
          method: 'POST',
          body: JSON.stringify({})
        });
        let data;
        try { data = await resp.json(); } catch (e) {
          throw new Error('Invalid server response');
        }
        if (!resp.ok) throw new Error(data.error || 'Failed to advance stage');

        showToast(data.message || 'Stage advanced!', 'success');
        // Refresh the handoff detail
        openHandoffDetailModal(handoffId);

        // Log activity
        if (currentHandoffData && currentHandoffData.project_id) {
          var newStage = (data.handoff && data.handoff.stage) || 'next stage';
          var stageObj = HANDOFF_STAGES.find(function(s) { return s.key === newStage; });
          logProjectActivity(currentHandoffData.project_id, 'handoff_advanced', 'Handoff "' + (currentHandoffData.title || 'Untitled') + '" advanced to ' + (stageObj ? stageObj.label : newStage));
        }
      } catch (err) {
        console.error('[Handoff] Advance error:', err);
        showToast(err.message || 'Error advancing stage', 'error');
      }
    }

    async function saveHandoffQuote(handoffId) {
      var quoteEl = document.getElementById('handoff-quote-input');
      var dateEl = document.getElementById('handoff-date-input');
      var quote = parseFloat(quoteEl.value);
      var schedDate = dateEl.value || null;

      if (!quote || quote <= 0) {
        showToast('Enter a valid quote amount', 'warning');
        return;
      }

      try {
        var resp = await apiCall('/api/collaboration/handoffs/' + handoffId, {
          method: 'PUT',
          body: JSON.stringify({
            quote_amount: quote,
            scheduled_date: schedDate ? new Date(schedDate).toISOString() : null
          })
        });
        var data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to save quote');

        showToast('Quote saved!', 'success');
        openHandoffDetailModal(handoffId);

        if (currentHandoffData && currentHandoffData.project_id) {
          logProjectActivity(currentHandoffData.project_id, 'quote_submitted', 'Fabrication quote of $' + quote.toFixed(2) + ' submitted');
        }
      } catch (err) {
        showToast(err.message || 'Error saving quote', 'error');
      }
    }

    async function handleHandoffFileUpload(handoffId) {
      var fileInput = document.getElementById('handoff-file-input');
      var file = fileInput && fileInput.files[0];
      if (!file) return;

      if (file.size > 10 * 1024 * 1024) {
        showToast('File must be under 10MB', 'warning');
        return;
      }

      showToast('Uploading file...', 'info');

      try {
        var ext = file.name.split('.').pop();
        var fileName = 'handoff-files/' + handoffId + '-' + Date.now() + '.' + ext;

        var uploadResult = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file, { contentType: file.type, upsert: true });

        if (uploadResult.error) throw uploadResult.error;

        var urlResult = supabaseClient.storage.from('lead-images').getPublicUrl(fileName);
        var publicUrl = urlResult.data.publicUrl;

        var resp = await apiCall('/api/collaboration/handoffs/' + handoffId, {
          method: 'PUT',
          body: JSON.stringify({ design_file_url: publicUrl })
        });
        var data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Failed to update handoff');

        showToast('Design file uploaded!', 'success');
        openHandoffDetailModal(handoffId);

        if (currentHandoffData && currentHandoffData.project_id) {
          logProjectActivity(currentHandoffData.project_id, 'file_uploaded', 'Design file uploaded to handoff');
        }
      } catch (err) {
        showToast('Upload failed: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function loadProjectHandoffs(projectId) {
      const container = document.getElementById('project-handoffs-list');
      if (!container) return;

      try {
        const resp = await apiCall('/api/collaboration/projects/' + projectId + '/handoffs');
        let data;
        try { data = await resp.json(); } catch (e) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">Could not load handoffs</div>';
          return;
        }
        if (!resp.ok) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">No handoffs yet</div>';
          return;
        }

        const handoffs = data.handoffs || data || [];
        if (!Array.isArray(handoffs) || handoffs.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">No handoffs yet. Start one from the My Designs page.</div>';
          return;
        }

        container.innerHTML = handoffs.map(function(h) {
          const stage = h.stage || 'design_created';
          const stageObj = HANDOFF_STAGES.find(function(s) { return s.key === stage; });
          const stageLabel = stageObj ? stageObj.label : stage;
          const stageIdx = HANDOFF_STAGES.findIndex(function(s) { return s.key === stage; });
          const isComplete = stage === 'final_review' && h.completed_at;
          return '<div onclick="closeProjectDetail(); openHandoffDetailModal(\'' + h.id + '\')" style="display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; cursor: pointer; transition: background 0.15s; border-bottom: 1px solid var(--dark-border);" onmouseover="this.style.background=\'var(--dark-card)\'" onmouseout="this.style.background=\'transparent\'">' +
            '<div style="width: 36px; height: 36px; border-radius: 50%; background: ' + (isComplete ? 'rgba(34,197,94,0.15)' : 'rgba(212,175,55,0.2)') + '; display: flex; align-items: center; justify-content: center;">' +
              '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="' + (isComplete ? '#22c55e' : 'var(--gold-primary)') + '" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>' +
            '</div>' +
            '<div style="flex: 1;">' +
              '<div style="font-size: 13px; font-weight: 600; color: var(--text-primary);">' + escapeHtml(h.title || 'Untitled Handoff') + '</div>' +
              '<div style="font-size: 11px; color: var(--text-secondary);">Stage ' + (stageIdx + 1) + '/13: ' + stageLabel + '</div>' +
            '</div>' +
            '<span style="font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 12px; background: ' + (isComplete ? 'rgba(34,197,94,0.15)' : 'rgba(212,175,55,0.15)') + '; color: ' + (isComplete ? '#22c55e' : 'var(--gold-primary)') + ';">' + (isComplete ? 'Done' : stageLabel) + '</span>' +
          '</div>';
        }).join('');
      } catch (err) {
        console.error('[Handoff] Error loading project handoffs:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px; text-align: center;">Error loading handoffs</div>';
      }
    }

    // =============================================
    // BRIDGE 5: Collaborator Marketplace Listings in Project Detail
    // =============================================

    async function loadCollaboratorListings(projectId) {
      var container = document.getElementById('project-collab-listings-content');
      if (!container) return;

      try {
        // Get collaborator user IDs for this project
        var resp = await apiCall('/api/collaboration/projects/' + projectId + '/collaborators');
        var data;
        try { data = await resp.json(); } catch (e) { data = {}; }

        if (!resp.ok || !data.collaborators || !data.collaborators.length) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No collaborator listings yet. Invite fabricators to see their inventory here.</div>';
          return;
        }

        var userIds = data.collaborators.map(function(c) { return c.user_id; }).filter(Boolean);
        if (!userIds.length) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No collaborator listings available.</div>';
          return;
        }

        // Query stone_listings for collaborating users
        var result = await supabaseClient
          .from('stone_listings')
          .select('id, title, stone_name, material_type, price, image_url, city, state')
          .in('user_id', userIds)
          .eq('status', 'active')
          .order('created_at', { ascending: false })
          .limit(6);

        if (result.error || !result.data || !result.data.length) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No active listings from collaborators.</div>';
          return;
        }

        container.innerHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;">' +
          result.data.map(function(l) {
            var name = escapeHtml(l.stone_name || l.title || 'Listing');
            var type = escapeHtml(l.material_type || '');
            var priceStr = l.price ? '<div style="font-size: 11px; color: var(--gold-primary); font-weight: 600;">$' + parseFloat(l.price).toFixed(2) + '</div>' : '<div style="font-size: 10px; color: var(--text-muted);">Contact for pricing</div>';
            var img = l.image_url ? '<img src="' + l.image_url + '" style="width: 100%; height: 80px; object-fit: cover; border-radius: 6px; margin-bottom: 6px;" loading="lazy" alt="' + escapeHtmlAttr(name) + '"/>' : '<div style="width: 100%; height: 80px; background: var(--dark-border); border-radius: 6px; margin-bottom: 6px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 10px;">No Image</div>';
            return '<a href="/remnants/?listing=' + l.id + '" target="_blank" style="background: var(--dark-surface); border-radius: 8px; padding: 8px; text-decoration: none; color: inherit; display: block; border: 1px solid var(--border-subtle); transition: border-color 0.15s;" onmouseover="this.style.borderColor=\'var(--gold-primary)\'" onmouseout="this.style.borderColor=\'var(--border-subtle)\'">' +
              img +
              '<div style="font-size: 11px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">' + name + '</div>' +
              '<div style="font-size: 10px; color: var(--text-muted);">' + type + '</div>' +
              priceStr +
            '</a>';
          }).join('') + '</div>';

      } catch (err) {
        console.error('[CollabListings] Error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">Could not load listings.</div>';
      }
    }

    // =============================================
    // BRIDGE 2: Convert Handoff Quote to Estimate
    // =============================================

    function fillField(id, value) {
      var el = document.getElementById(id);
      if (el && value) el.value = value;
    }

    async function convertHandoffToEstimate() {
      var handoff = currentHandoffData;
      if (!handoff || !handoff.quote_amount) {
        showToast('No handoff quote data available', 'warning');
        return;
      }

      closeHandoffDetailModal();

      // Fetch project details for customer info
      var project = null;
      if (handoff.project_id) {
        try {
          var result = await supabaseClient
            .from('projects')
            .select('*')
            .eq('id', handoff.project_id)
            .single();
          project = result.data;
        } catch (e) {
          console.warn('[Bridge2] Could not fetch project:', e);
        }
      }

      // Navigate to estimates page
      showPage('estimates');

      // Set up estimate modal state
      estimateModalState = {
        customerId: null,
        leadId: null,
        editingEstimateId: null
      };

      // Open modal after page renders
      setTimeout(function() {
        openCreateEstimateModal(false);

        // Pre-fill from project
        if (project) {
          fillField('estimate-customer-name', project.customer_name);
          fillField('estimate-customer-email', project.customer_email);
          fillField('estimate-customer-phone', project.customer_phone);
          fillField('estimate-customer-address', project.address);
          fillField('estimate-customer-city', project.city);
          fillField('estimate-customer-state', project.state);
          fillField('estimate-customer-zip', project.zip);
          fillField('estimate-project-name', project.name);
        }

        fillField('estimate-project-desc', (handoff.title || '') + (handoff.description ? ' - ' + handoff.description : ''));

        // Add the quote as a line item
        if (typeof addEstimateLineItem === 'function') {
          addEstimateLineItem();
          var lastItem = document.querySelector('#estimate-line-items .estimate-line-item:last-child');
          if (lastItem) {
            var nameEl = lastItem.querySelector('.item-name');
            var descEl = lastItem.querySelector('.item-desc');
            var qtyEl = lastItem.querySelector('.item-qty');
            var priceEl = lastItem.querySelector('.item-price');
            if (nameEl) nameEl.value = 'Fabrication & Installation';
            if (descEl) descEl.value = 'Per handoff quote - ' + (handoff.title || 'Design Handoff');
            if (qtyEl) qtyEl.value = '1';
            if (priceEl) priceEl.value = parseFloat(handoff.quote_amount) || 0;
            if (typeof updateEstimateTotals === 'function') updateEstimateTotals();
          }
        }

        fillField('estimate-notes', 'Converted from design handoff' + (handoff.id ? ' #' + handoff.id.substring(0, 8) : ''));

        showToast('Handoff quote loaded into estimate form', 'success');

        // Log activity
        if (handoff.project_id) {
          logProjectActivity(handoff.project_id, 'estimate_from_handoff', 'Created estimate from handoff quote');
        }
      }, 400);
    }

    // =============================================
    // CONTRACTORS
    // =============================================

    async function loadCollaborators() {
      const container = document.getElementById('collaborators-list');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: collaborators, error } = await supabaseClient
          .from('general_collaborators')
          .select('*')
          .eq('invited_by', user.id)
          .order('name');

        if (error) throw error;

        allCollaborators = collaborators || [];
        renderCollaborators();
      } catch (err) {
        console.error('Load collaborators error:', err);
        container.innerHTML = `<div class="empty-state"><p>Error loading collaborators</p></div>`;
      }
    }

    function filterCollaborators(type) {
      contractorFilter = type;
      document.querySelectorAll('[data-collaborator-status]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.contractorStatus === type);
      });
      renderCollaborators();
    }

    function renderCollaborators() {
      const container = document.getElementById('collaborators-list');
      if (!container) return;

      let filtered = allCollaborators;
      if (contractorFilter !== 'all') {
        filtered = filtered.filter(c => c.type === contractorFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            <h3>No collaborators found</h3>
            <p>Add your team members to assign them to jobs.</p>
            <button class="btn-modern primary" style="margin-top: 16px;" onclick="openNewCollaboratorModal()">Add Collaborator</button>
          </div>`;
        return;
      }

      const getTrustBadgeColor = (score) => {
        if (score >= 70) return { bg: 'rgba(34, 197, 94, 0.15)', color: '#22c55e', label: 'Verified' };
        if (score >= 40) return { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b', label: 'Partial' };
        return { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280', label: 'New' };
      };

      container.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
          ${filtered.map(c => {
            const trust = getTrustBadgeColor(c.trust_score || 0);
            const isClaimed = !!c.claimed_by;
            return `
            <div class="contractor-card" onclick="openContractorProfile('${c.id}')" style="background: var(--dark-elevated); border-radius: 12px; padding: 16px; border: 1px solid ${isClaimed ? 'var(--gold-primary)' : 'var(--border-subtle)'}; cursor: pointer; transition: all 0.2s;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-weight: 600; font-size: 15px;">${c.name}</span>
                    ${isClaimed ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="var(--gold-primary)" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>' : ''}
                  </div>
                  <div style="font-size: 12px; color: var(--text-muted);">${c.company || ''}</div>
                </div>
                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
                  <span class="status-badge" style="background: rgba(139, 92, 246, 0.15); color: #8b5cf6; font-size: 10px; padding: 4px 10px;">${c.role || 'contractor'}</span>
                  <div style="display: flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: 10px; background: ${trust.bg};">
                    <span style="font-size: 11px; font-weight: 700; color: ${trust.color};">${c.trust_score || 0}</span>
                    <span style="font-size: 9px; color: ${trust.color};">${trust.label}</span>
                  </div>
                </div>
              </div>
              <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; min-height: 36px;">
                ${c.email ? `<div style="display: flex; align-items: center; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>${c.email}</div>` : ''}
                ${c.phone ? `<div style="display: flex; align-items: center; gap: 6px;"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>${c.phone}</div>` : ''}
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border-subtle);">
                <div style="font-size: 12px; color: var(--text-muted);">
                  ${c.total_jobs || 0} jobs assigned
                </div>
                <div style="display: flex; gap: 6px;" onclick="event.stopPropagation();">
                  <button class="action-btn" onclick="scheduleWithContractor('${c.id}')" title="Schedule Meeting" style="color: var(--accent);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                  </button>
                  <button class="action-btn" onclick="openContractorProfile('${c.id}')" title="View Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                  </button>
                  <button class="action-btn" onclick="quickInviteContractor('${c.id}')" title="Send Portal Invite" style="color: var(--gold-primary);">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                  </button>
                  <button class="action-btn" onclick="inviteContractorAsCollaborator('${c.id}')" title="Invite as Collaborator">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/></svg>
                  </button>
                </div>
              </div>
            </div>
          `}).join('')}
        </div>
      `;
    }

    function openNewCollaboratorModal() {
      document.getElementById('new-collaborator-modal').classList.add('active');
      document.getElementById('new-contractor-form').reset();
    }

    async function quickInviteContractor(contractorId) {
      const contractor = allCollaborators.find(c => c.id === contractorId);
      if (!contractor) return;

      // Generate invite link
      let token = contractor.token_hash;
      if (!token) {
        token = btoa(contractorId + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);
        try {
          await supabaseClient.from('general_collaborators').update({ token_hash: token }).eq('id', contractorId);
        } catch (e) { console.log('Could not save token:', e); }
      }

      const inviteUrl = `${window.location.origin}/contractor-portal/?token=${token}`;

      // Copy to clipboard
      try {
        await navigator.clipboard.writeText(inviteUrl);
        showToast('Invite link copied!');
      } catch (e) {
        // Fallback
        const input = document.createElement('input');
        input.value = inviteUrl;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('Invite link copied!');
      }

      // If they have email, offer to send or invite as collaborator
      if (contractor.email) {
        const action = prompt(
          `Portal link copied for ${contractor.company || contractor.name}!\n\nAdditional actions:\n1. Send email invite (type "email")\n2. Invite as project collaborator (type "collab")\n3. Done (press Enter)`,
          ''
        );
        if (action === 'email') {
          try {
            await apiCall('/api/collaborators/send-invite', {
              method: 'POST',
              body: JSON.stringify({
                contractor_id: contractorId,
                email: contractor.email,
                invite_link: inviteUrl
              })
            });
            showToast('Email sent!');
          } catch (err) {
            console.log('Could not send email:', err);
          }
        } else if (action === 'collab') {
          inviteContractorAsCollaborator(contractorId);
        }
      }
    }

    function closeNewCollaboratorModal() {
      document.getElementById('new-collaborator-modal').classList.remove('active');
    }

    function openInviteCollaboratorModal() {
      document.getElementById('invite-collaborator-modal').classList.add('active');
      document.getElementById('invite-contractor-form').reset();
      // Reset quick share state
      const linkInput = document.getElementById('quick-share-link');
      if (linkInput) linkInput.value = '';
      const qrContainer = document.getElementById('invite-qr-container');
      if (qrContainer) qrContainer.style.display = 'none';
      const copyBtn = document.getElementById('copy-link-btn');
      if (copyBtn) copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Generate Link';
    }

    function closeInviteCollaboratorModal() {
      document.getElementById('invite-collaborator-modal').classList.remove('active');
      // Reset the quick share link
      const linkInput = document.getElementById('quick-share-link');
      if (linkInput) linkInput.value = '';
      const qrContainer = document.getElementById('invite-qr-container');
      if (qrContainer) qrContainer.style.display = 'none';
      const copyBtn = document.getElementById('copy-link-btn');
      if (copyBtn) copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg> Generate Link';
    }

    async function generateAndCopyShareLink() {
      const linkInput = document.getElementById('quick-share-link');
      const copyBtn = document.getElementById('copy-link-btn');
      const originalBtnHtml = copyBtn.innerHTML;

      // If we already have a link, just copy it
      if (linkInput.value && linkInput.value.startsWith('http')) {
        try {
          await navigator.clipboard.writeText(linkInput.value);
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Copied!';
          showToast('Link copied to clipboard!', 'success');
          setTimeout(() => {
            copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy Link';
          }, 2000);
          return;
        } catch (err) {
          showToast('Failed to copy', 'error');
          return;
        }
      }

      // Generate a new link client-side
      copyBtn.disabled = true;
      copyBtn.innerHTML = '<span>Generating...</span>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in first');

        // Generate a unique invite token
        // Generate a unique invite token
        const timestamp = Date.now();
        const randomPart = Math.random().toString(36).substring(2, 12);
        const token = btoa(user.id + '-' + timestamp + '-' + randomPart)
          .replace(/[^a-zA-Z0-9]/g, '')
          .substring(0, 32);

        // Use a unique email with timestamp to avoid conflicts
        const uniqueEmail = `invite-${timestamp}-${randomPart}@pending.local`;

        // Create a pending collaborator invite placeholder
        const { data: invite, error } = await supabaseClient
          .from('general_collaborators')
          .insert([{
            invited_by: user.id,
            email: uniqueEmail,
            name: 'Pending Network Invite',
            role: 'contractor',
            status: 'pending',
            token_hash: token,
            token_expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days
          }])
          .select()
          .single();

        if (error) {
          // If conflict, it means an invite already exists - just generate a new token
          console.warn('Invite creation conflict, generating link anyway:', error);
        }

        // Generate the invite link
        const inviteLink = `${window.location.origin}/contractor-portal/?invite=${token}`;
        linkInput.value = inviteLink;

        // Generate and display QR code
        const qrContainer = document.getElementById('invite-qr-container');
        const qrCode = document.getElementById('invite-qr-code');
        if (qrContainer && qrCode) {
          const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(inviteLink)}`;
          qrCode.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 150px; height: 150px;">`;
          qrContainer.style.display = 'block';
        }

        // Copy to clipboard
        await navigator.clipboard.writeText(inviteLink);
        copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg> Copied!';
        showToast('Link generated and copied!', 'success');
        // Change to "Copy Link" after showing "Copied!"
        setTimeout(() => {
          copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy Link';
        }, 2000);

      } catch (err) {
        console.error('Quick share error:', err);
        showToast(err.message || 'Failed to generate link', 'error');
        copyBtn.innerHTML = originalBtnHtml;
      } finally {
        copyBtn.disabled = false;
      }
    }

    async function sendContractorInvitation(event) {
      event.preventDefault();

      const btn = document.getElementById('send-invite-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span>Sending...</span>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const email = document.getElementById('invite-contractor-email').value.trim();
        const message = document.getElementById('invite-contractor-message').value.trim();

        console.log('[Invite] Sending to:', email);

        // Use unified collaboration invite API - handles email sending properly
        const response = await apiCall('/api/collaboration/invite-general', {
          method: 'POST',
          body: JSON.stringify({
            email: email,
            notes: message || null
          })
        });

        console.log('[Invite] Response status:', response.status);
        const data = await response.json();
        console.log('[Invite] Response data:', data);

        if (!response.ok) {
          throw new Error(data.error || data.message || 'Failed to send invitation');
        }

        closeInviteCollaboratorModal();
        showToast('Invitation sent to ' + email + '!', 'success');

        // Refresh collaborators list
        if (typeof loadMyNetwork === 'function') loadMyNetwork();

      } catch (err) {
        console.error('Send invitation error:', err);
        // User-friendly error messages
        let msg = err.message;
        if (msg.includes('already invited')) {
          msg = 'This person has already been invited';
        }
        showToast(msg, 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }

    async function createContractor(event) {
      event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const contractorData = {
          invited_by: user.id,
          name: document.getElementById('contractor-name').value.trim(),
          email: document.getElementById('contractor-email').value.trim(),
          role: document.getElementById('contractor-type').value || 'contractor',
          phone: document.getElementById('contractor-phone').value.trim() || null,
          company: document.getElementById('contractor-company').value.trim() || null,
          notes: document.getElementById('contractor-notes').value.trim() || null,
          status: 'accepted'
        };

        // Validate required fields
        if (!contractorData.name || !contractorData.email) {
          throw new Error('Name and email are required');
        }

        const { error } = await supabaseClient.from('general_collaborators').insert([contractorData]);
        if (error) throw error;

        closeNewCollaboratorModal();
        showToast('Contractor added!');
        loadCollaborators();
      } catch (err) {
        console.error('Create contractor error:', err);
        alert('Error adding contractor: ' + err.message);
      }
    }

    function openAssignCollaboratorModal(jobId = null) {
      // Use provided jobId or fall back to currentJobId
      if (jobId) {
        currentJobId = jobId;
      }
      if (!currentJobId) {
        showToast('Please select a job first', 'warning');
        return;
      }
      document.getElementById('assign-collaborator-modal').classList.add('active');
      // Reset inline form
      document.getElementById('new-contractor-inline').style.display = 'none';
      document.getElementById('assign-contractor-select').style.display = 'block';
      document.getElementById('assign-contractor-select').removeAttribute('disabled');
      loadCollaboratorsForSelect();
    }

    function closeAssignCollaboratorModal() {
      document.getElementById('assign-collaborator-modal').classList.remove('active');
      cancelNewContractorInline();
    }

    function toggleNewContractorInAssign() {
      const select = document.getElementById('assign-contractor-select');
      const inlineForm = document.getElementById('new-contractor-inline');

      if (select.value === '__new__') {
        inlineForm.style.display = 'block';
        // Clear inline form fields
        document.getElementById('inline-contractor-name').value = '';
        document.getElementById('inline-contractor-company').value = '';
        document.getElementById('inline-contractor-email').value = '';
        document.getElementById('inline-contractor-phone').value = '';
        // Set role based on selection
        const role = document.getElementById('assign-contractor-role').value;
        document.getElementById('inline-contractor-name').focus();
      } else {
        inlineForm.style.display = 'none';
      }
    }

    function cancelNewContractorInline() {
      const select = document.getElementById('assign-contractor-select');
      const inlineForm = document.getElementById('new-contractor-inline');
      inlineForm.style.display = 'none';
      select.value = '';
    }

    async function loadCollaboratorsForSelect() {
      const select = document.getElementById('assign-contractor-select');
      if (!select) return;

      select.innerHTML = `
        <option value="">-- Select Contractor --</option>
        <option value="__new__" style="color: var(--gold-primary); font-weight: 600;">+ Add New Contractor</option>
      `;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: collaborators } = await supabaseClient
          .from('general_collaborators')
          .select('id, name, role, company')
          .eq('invited_by', user.id)
          .order('name');

        if (collaborators && collaborators.length > 0) {
          select.innerHTML += '<option disabled>──────────────</option>';
          (collaborators || []).forEach(c => {
            const displayName = c.company ? `${c.name} - ${c.company}` : c.name;
            select.innerHTML += `<option value="${c.id}">${displayName} (${c.role || 'contractor'})</option>`;
          });
        }
      } catch (err) {
        console.error('Load collaborators for select error:', err);
      }
    }

    async function assignContractor(event) {
      event.preventDefault();

      if (!currentJobId) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        let contractorId = document.getElementById('assign-contractor-select').value;

        // Check if we need to create a new contractor first
        if (contractorId === '__new__') {
          const newName = document.getElementById('inline-contractor-name').value.trim();
          if (!newName) throw new Error('Please enter contractor name');

          const role = document.getElementById('assign-contractor-role').value || 'contractor';
          const email = document.getElementById('inline-contractor-email').value.trim();
          if (!email) throw new Error('Email is required for new contractors');

          const contractorData = {
            invited_by: user.id,
            name: newName,
            email: email,
            role: role,
            company: document.getElementById('inline-contractor-company').value.trim() || null,
            phone: document.getElementById('inline-contractor-phone').value.trim() || null,
            status: 'accepted'
          };

          const { data: newContractor, error: createError } = await supabaseClient
            .from('general_collaborators')
            .insert([contractorData])
            .select()
            .single();

          if (createError) throw createError;
          contractorId = newContractor.id;
          showToast('Contractor created!');
        }

        if (!contractorId || contractorId === '__new__') {
          throw new Error('Please select or create a contractor');
        }

        const assignData = {
          project_id: currentJobId,
          contractor_id: contractorId,
          user_id: user.id,
          role: document.getElementById('assign-contractor-role').value,
          agreed_rate: parseFloat(document.getElementById('assign-contractor-amount').value) || 0,
          status: 'pending'
        };

        const { error } = await supabaseClient.from('project_contractors').insert([assignData]);
        if (error) throw error;

        const shouldNotify = document.getElementById('assign-contractor-notify').checked;
        if (shouldNotify) {
          // Send invite email via API
          try {
            await apiCall(`/api/projects/${currentJobId}/contractors`, {
              method: 'POST',
              body: JSON.stringify({ contractor_id: contractorId, send_invite: true })
            });
          } catch (apiErr) {
            console.log('Could not send invite email:', apiErr);
          }
        }

        closeAssignCollaboratorModal();
        showToast('Contractor assigned!');
        loadJobs();
        loadCollaborators(); // Refresh collaborators list too
        if (currentJobId) {
          const job = allJobs.find(j => j.id === currentJobId);
          if (job) openJobDetail(currentJobId);
        }

        // Offer to also invite as project collaborator
        const assignedContractor = allCollaborators.find(c => c.id === contractorId);
        if (assignedContractor && assignedContractor.email) {
          const alsoCollab = confirm(`Contractor assigned! Also invite ${assignedContractor.email} as a project collaborator?`);
          if (alsoCollab) {
            inviteJobContractorAsCollaborator(contractorId);
          }
        }
      } catch (err) {
        console.error('Assign contractor error:', err);
        alert('Error assigning contractor: ' + err.message);
      }
    }

    // =============================================
    // CALENDAR
    // =============================================

    let currentCalendarDate = new Date();
    let calendarEvents = [];

    async function initCalendar() {
      renderCalendar();
      // Ensure jobs and customers are loaded for scheduling
      if (allJobs.length === 0) await loadJobs();
      if (allCustomers.length === 0) await loadCustomers();
      loadCalendarEvents();
    }

    function changeCalendarMonth(delta) {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
      renderCalendar();
      loadCalendarEvents();
    }

    function goToToday() {
      currentCalendarDate = new Date();
      renderCalendar();
      loadCalendarEvents();
    }

    // Calendar Scheduling Variables
    let selectedScheduleDate = null;

    // Open Quick Schedule Modal
    function openQuickScheduleModal(preselectedDate = null, preselectedJobId = null) {
      const modal = document.getElementById('quick-schedule-modal');
      if (!modal) return;

      // Reset form
      document.getElementById('quick-schedule-form').reset();

      // Populate customers dropdown
      const customerSelect = document.getElementById('schedule-customer-select');
      customerSelect.innerHTML = '<option value="">-- Select Customer --</option>';
      allCustomers.forEach(c => {
        customerSelect.innerHTML += `<option value="${c.id}">${c.name} ${c.email ? '(' + c.email + ')' : ''}</option>`;
      });

      // Populate jobs dropdown
      const jobSelect = document.getElementById('schedule-job-select');
      jobSelect.innerHTML = '<option value="">-- Create New or Select Existing --</option>';
      allJobs.filter(j => j.status !== 'completed' && j.status !== 'cancelled').forEach(j => {
        jobSelect.innerHTML += `<option value="${j.id}">${j.job_number || 'Job'} - ${j.customer_name || j.description}</option>`;
      });

      // Preselect job if provided
      if (preselectedJobId) {
        jobSelect.value = preselectedJobId;
      }

      // Set date if preselected
      if (preselectedDate) {
        document.getElementById('schedule-date').value = preselectedDate;
        selectedScheduleDate = preselectedDate;
      } else {
        // Default to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('schedule-date').value = today;
      }

      toggleScheduleFields();
      modal.classList.add('active');
    }

    function closeQuickScheduleModal() {
      document.getElementById('quick-schedule-modal').classList.remove('active');
      selectedScheduleDate = null;
    }

    function toggleScheduleFields() {
      const jobSelect = document.getElementById('schedule-job-select');
      const newJobFields = document.getElementById('schedule-new-job-fields');
      const descInput = document.getElementById('schedule-description');
      const customerSelect = document.getElementById('schedule-customer-select');

      if (jobSelect.value) {
        // Existing job selected - hide new job fields
        newJobFields.style.display = 'none';
        descInput.removeAttribute('required');
        customerSelect.removeAttribute('required');
      } else {
        // Creating new - show fields
        newJobFields.style.display = 'block';
        descInput.setAttribute('required', 'required');
      }
    }

    async function submitQuickSchedule(e) {
      e.preventDefault();

      const eventType = document.getElementById('schedule-event-type').value;
      const jobId = document.getElementById('schedule-job-select').value;
      const customerId = document.getElementById('schedule-customer-select').value;
      const description = document.getElementById('schedule-description').value;
      const scheduleDate = document.getElementById('schedule-date').value;
      const scheduleTime = document.getElementById('schedule-time').value;
      const duration = document.getElementById('schedule-duration').value;
      const notes = document.getElementById('schedule-notes').value;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Not logged in');

        let targetJobId = jobId;

        // If no existing job selected, create a new one
        if (!jobId) {
          if (!customerId) {
            showToast('Please select a customer', 'error');
            return;
          }

          const customer = allCustomers.find(c => c.id === customerId);

          // Generate job number
          const { count } = await supabaseClient
            .from('projects')
            .select('*', { count: 'exact', head: true })
            .eq('user_id', user.id);

          const jobNumber = `JOB-${String((count || 0) + 1).padStart(4, '0')}`;

          // Create the job
          const { data: newJob, error: jobError } = await supabaseClient
            .from('projects')
            .insert({
              user_id: user.id,
              customer_id: customerId,
              customer_name: customer?.name || 'Customer',
              customer_email: customer?.email || null,
              customer_phone: customer?.phone || null,
              job_number: jobNumber,
              description: description,
              status: 'scheduled',
              estimated_start_date: scheduleDate,
              notes: notes
            })
            .select()
            .single();

          if (jobError) throw jobError;
          targetJobId = newJob.id;

          // Add to local array
          allJobs.unshift(newJob);
        }

        // Update the job with the scheduled date/time based on event type
        const updateData = { updated_at: new Date().toISOString() };

        if (eventType === 'measure') {
          updateData.field_measure_date = scheduleTime ? `${scheduleDate}T${scheduleTime}:00` : scheduleDate;
        } else if (eventType === 'job' || eventType === 'consultation') {
          updateData.estimated_start_date = scheduleDate;
          if (scheduleTime) {
            updateData.scheduled_time = scheduleTime;
          }
        } else {
          updateData.estimated_start_date = scheduleDate;
        }

        if (notes && targetJobId) {
          updateData.notes = notes;
        }

        if (targetJobId) {
          await supabaseClient
            .from('projects')
            .update(updateData)
            .eq('id', targetJobId);

          // Update local array
          const jobIdx = allJobs.findIndex(j => j.id === targetJobId);
          if (jobIdx !== -1) {
            Object.assign(allJobs[jobIdx], updateData);
          }
        }

        showToast('Event scheduled successfully!');
        closeQuickScheduleModal();
        closeDayEventsModal();
        loadCalendarEvents();
        renderCalendar();

      } catch (err) {
        console.error('Schedule error:', err);
        showToast('Error scheduling: ' + err.message, 'error');
      }
    }

    // Day Events Modal
    function showDayEvents(dateStr) {
      selectedScheduleDate = dateStr;
      const modal = document.getElementById('day-events-modal');
      if (!modal) return;

      const date = new Date(dateStr + 'T12:00:00');
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      document.getElementById('day-events-title').textContent = date.toLocaleDateString('en-US', options);

      const dayEvents = calendarEvents.filter(e => e.date === dateStr);
      const content = document.getElementById('day-events-content');

      if (dayEvents.length === 0) {
        content.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-muted);">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="opacity: 0.4; margin-bottom: 12px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            <p>No events scheduled</p>
            <p style="font-size: 13px; margin-top: 8px;">Click "Add Event" to schedule something</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="list-modern">
            ${dayEvents.map(evt => {
              const typeColors = {
                job: '#3b82f6',
                appointment: '#3b82f6',
                measure: '#f59e0b',
                measurement: '#f59e0b',
                install: '#10b981',
                installation: '#10b981',
                consultation: '#ec4899',
                delivery: '#06b6d4',
                meeting: '#8b5cf6',
                follow_up: '#6b7280',
                production: '#8b5cf6',
                other: '#6b7280'
              };
              const statusInfo = {
                scheduled: { color: '#f59e0b', label: 'Pending' },
                confirmed: { color: '#10b981', label: 'Confirmed' },
                completed: { color: '#6366f1', label: 'Completed' },
                cancelled: { color: '#ef4444', label: 'Cancelled' },
                rescheduled: { color: '#3b82f6', label: 'Rescheduled' },
                no_show: { color: '#6b7280', label: 'No Show' }
              };
              const color = typeColors[evt.type] || '#3b82f6';
              const status = statusInfo[evt.status] || { color: '#f59e0b', label: 'Pending' };
              const clickHandler = evt.apiEventId
                ? `openCalendarEventDetailModal('${evt.apiEventId}')`
                : (evt.jobId ? `openJobDetail('${evt.jobId}')` : '');
              const eventData = JSON.stringify({
                title: evt.title,
                type: evt.type,
                date: evt.date,
                apiEventId: evt.apiEventId || null,
                jobId: evt.jobId || null,
                status: evt.status || 'scheduled'
              }).replace(/"/g, '&quot;');
              return `
                <div class="list-item-modern"
                     data-context-menu="calendar_event"
                     data-item-id="${evt.apiEventId || evt.jobId || ''}"
                     data-item-data="${eventData}"
                     onclick="${clickHandler}" style="cursor: pointer;">
                  <div class="list-item-icon" style="background: ${color}20; color: ${color};">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <div class="list-item-content">
                    <div class="list-item-title">${escapeHtml(evt.title)}</div>
                    <div class="list-item-subtitle">${evt.type.charAt(0).toUpperCase() + evt.type.slice(1).replace('_', ' ')}</div>
                  </div>
                  <div class="list-item-meta">
                    <span class="badge-modern" style="background: ${status.color}20; color: ${status.color};">${status.label}</span>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }

      modal.classList.add('active');
    }

    function closeDayEventsModal() {
      document.getElementById('day-events-modal').classList.remove('active');
    }

    function openQuickScheduleForDate() {
      closeDayEventsModal();
      openCalendarEventModal(null, selectedScheduleDate);
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      const monthYearEl = document.getElementById('calendar-month-year');
      if (!grid || !monthYearEl) return;

      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();

      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      monthYearEl.textContent = `${monthNames[month]} ${year}`;

      // Get first day of month and total days
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDayOfWeek = firstDay.getDay();
      const totalDays = lastDay.getDate();

      // Get previous month's days to show
      const prevMonthLastDay = new Date(year, month, 0).getDate();

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

      let html = '';
      let dayCount = 1;
      let nextMonthDay = 1;

      // Generate 6 weeks (42 days)
      for (let i = 0; i < 42; i++) {
        let dayNumber, dateStr, isOtherMonth = false;

        if (i < startDayOfWeek) {
          // Previous month days
          dayNumber = prevMonthLastDay - startDayOfWeek + i + 1;
          const prevMonth = month === 0 ? 12 : month;
          const prevYear = month === 0 ? year - 1 : year;
          dateStr = `${prevYear}-${String(prevMonth).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          isOtherMonth = true;
        } else if (dayCount <= totalDays) {
          // Current month days
          dayNumber = dayCount;
          dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          dayCount++;
        } else {
          // Next month days
          dayNumber = nextMonthDay;
          const nextMonth = month === 11 ? 1 : month + 2;
          const nextYear = month === 11 ? year + 1 : year;
          dateStr = `${nextYear}-${String(nextMonth).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
          nextMonthDay++;
          isOtherMonth = true;
        }

        const isToday = dateStr === todayStr;
        const dayEvents = calendarEvents.filter(e => e.date === dateStr);

        html += `
          <div class="calendar-day ${isOtherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"
               data-date="${dateStr}"
               onclick="showDayEvents('${dateStr}')"
               ondragover="handleCalendarDragOver(event)"
               ondragleave="handleCalendarDragLeave(event)"
               ondrop="handleCalendarDrop(event, '${dateStr}')">
            <div class="calendar-day-number">${dayNumber}</div>
            <div class="calendar-events">
              ${dayEvents.slice(0, 3).map(e => {
                const clickHandler = e.apiEventId
                  ? `openCalendarEventDetailModal('${e.apiEventId}')`
                  : (e.jobId ? `openJobDetail('${e.jobId}')` : `showDayEvents('${dateStr}')`);
                const eventData = JSON.stringify({
                  title: e.title,
                  type: e.type,
                  date: e.date,
                  apiEventId: e.apiEventId || null,
                  jobId: e.jobId || null,
                  status: e.status || 'scheduled'
                }).replace(/"/g, '&quot;');
                return `
                <div class="calendar-event ${e.type}"
                     data-context-menu="calendar_event"
                     data-item-id="${e.apiEventId || e.jobId || ''}"
                     data-item-data="${eventData}"
                     data-event-id="${e.apiEventId || ''}"
                     data-job-id="${e.jobId || ''}"
                     draggable="true"
                     ondragstart="handleCalendarDragStart(event, '${e.apiEventId || ''}', '${e.jobId || ''}', '${e.date}')"
                     ondragend="handleCalendarDragEnd(event)"
                     onclick="event.stopPropagation(); ${clickHandler}">
                  ${escapeHtml(e.title)}
                </div>
              `}).join('')}
              ${dayEvents.length > 3 ? `<div class="calendar-event-more">+${dayEvents.length - 3} more</div>` : ''}
            </div>
          </div>
        `;
      }

      grid.innerHTML = html;
    }

    // ============================================
    // CALENDAR DRAG AND DROP
    // ============================================
    let draggedEventId = null;
    let draggedJobId = null;
    let draggedEventOriginalDate = null;

    function handleCalendarDragStart(event, eventId, jobId, originalDate) {
      draggedEventId = eventId || null;
      draggedJobId = jobId || null;
      draggedEventOriginalDate = originalDate;

      event.target.classList.add('dragging');
      document.body.classList.add('dragging-active');
      event.dataTransfer.effectAllowed = 'move';
      event.dataTransfer.setData('text/plain', JSON.stringify({ eventId, jobId, originalDate }));

      console.log('[DragDrop] handleCalendarDragStart - existing event:', { eventId, jobId, originalDate });

      // Add visual feedback
      setTimeout(() => {
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.add('drop-target-ready');
        });
      }, 0);
    }

    function handleCalendarDragEnd(event) {
      event.target.classList.remove('dragging');
      document.body.classList.remove('dragging-active');
      draggedEventId = null;
      draggedJobId = null;
      draggedEventOriginalDate = null;

      // Remove visual feedback
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('drop-target-ready', 'drag-over');
      });
    }

    function handleCalendarDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      // Check if this is a quick add (copy) or event move
      const effectAllowed = event.dataTransfer.effectAllowed;
      if (effectAllowed === 'copy' || effectAllowed === 'copyMove') {
        event.dataTransfer.dropEffect = 'copy';
      } else {
        event.dataTransfer.dropEffect = 'move';
      }
      event.currentTarget.classList.add('drag-over');
    }

    function handleCalendarDragLeave(event) {
      event.currentTarget.classList.remove('drag-over');
    }

    // ============================================
    // QUICK ADD - DRAG EVENT TYPES TO CALENDAR
    // ============================================
    let quickAddEventType = null;
    let quickAddEventTitle = null;
    let quickAddEventColor = null;

    function handleQuickAddDragStart(event, eventType, eventTitle, eventColor) {
      console.log('[DragDrop] handleQuickAddDragStart called:', eventType);
      quickAddEventType = eventType;
      quickAddEventTitle = eventTitle;
      quickAddEventColor = eventColor;

      event.target.classList.add('dragging');
      document.body.classList.add('dragging-active');
      event.dataTransfer.effectAllowed = 'copyMove';

      // Set data in multiple formats for cross-browser compatibility
      const dragData = JSON.stringify({
        isQuickAdd: true,
        eventType,
        eventTitle,
        eventColor
      });
      event.dataTransfer.setData('application/json', dragData);
      event.dataTransfer.setData('text/plain', dragData); // Fallback for some browsers

      // Add visual feedback to calendar days
      setTimeout(() => {
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.add('drop-target-ready');
        });
      }, 0);
    }

    function handleQuickAddDragEnd(event) {
      event.target.classList.remove('dragging');
      document.body.classList.remove('dragging-active');
      quickAddEventType = null;
      quickAddEventTitle = null;
      quickAddEventColor = null;

      // Remove visual feedback
      document.querySelectorAll('.calendar-day').forEach(day => {
        day.classList.remove('drop-target-ready', 'drag-over', 'drop-new-event');
      });
    }

    // Handle calendar drop - supports both event moves and quick add drops
    async function handleCalendarDrop(event, newDate) {
      console.log('[DragDrop] handleCalendarDrop called:', newDate);
      event.preventDefault();
      event.stopPropagation();

      const targetDay = event.currentTarget;
      targetDay.classList.remove('drag-over', 'drop-new-event');

      // Check if this is a quick add drop - try both data formats
      try {
        let dragData = event.dataTransfer.getData('application/json');
        // Fallback to text/plain for browser compatibility
        if (!dragData) {
          dragData = event.dataTransfer.getData('text/plain');
        }

        if (dragData) {
          const data = JSON.parse(dragData);
          console.log('[DragDrop] Parsed data:', data);
          if (data.isQuickAdd) {
            // Open event modal with prefilled data
            openCalendarEventModal(null, newDate, {
              type: data.eventType,
              title: data.eventTitle
            });

            // Clean up
            document.body.classList.remove('dragging-active');
            document.querySelectorAll('.calendar-day').forEach(day => {
              day.classList.remove('drop-target-ready', 'drag-over', 'drop-new-event');
            });
            return;
          }
        }
      } catch (e) {
        console.log('[DragDrop] Error parsing drag data:', e.message);
        // Not JSON data, continue with regular drop
      }

      // Check if this is a quick add from state
      if (quickAddEventType) {
        openCalendarEventModal(null, newDate, {
          type: quickAddEventType,
          title: quickAddEventTitle
        });

        // Clean up
        quickAddEventType = null;
        quickAddEventTitle = null;
        quickAddEventColor = null;
        document.body.classList.remove('dragging-active');
        document.querySelectorAll('.calendar-day').forEach(day => {
          day.classList.remove('drop-target-ready', 'drag-over', 'drop-new-event');
        });
        return;
      }

      // Otherwise, handle as event move
      // Parse drag data for event move
      let eventId = draggedEventId;
      let jobId = draggedJobId;

      try {
        const plainData = event.dataTransfer.getData('text/plain');
        if (plainData) {
          const parsed = JSON.parse(plainData);
          eventId = parsed.eventId || eventId;
          jobId = parsed.jobId || jobId;
        }
      } catch (e) {
        // Use fallback values
      }

      if (newDate === draggedEventOriginalDate) {
        return;
      }

      // Handle API event (calendar_events table)
      if (eventId) {
        try {
          const { data: original, error: fetchError } = await supabaseClient
            .from('calendar_events')
            .select('start_time, end_time')
            .eq('id', eventId)
            .single();

          if (fetchError) throw fetchError;

          const oldStart = new Date(original.start_time);
          const oldEnd = new Date(original.end_time);
          const duration = oldEnd - oldStart;

          const newStart = new Date(newDate + 'T' + oldStart.toTimeString().slice(0, 8));
          const newEnd = new Date(newStart.getTime() + duration);

          const { error: updateError } = await supabaseClient
            .from('calendar_events')
            .update({
              start_time: newStart.toISOString(),
              end_time: newEnd.toISOString(),
              updated_at: new Date().toISOString()
            })
            .eq('id', eventId);

          if (updateError) throw updateError;

          showToast('Event moved to ' + new Date(newDate).toLocaleDateString(), 'success');
          await loadCalendarEvents();
          await loadAllCalendarEvents();

        } catch (err) {
          console.error('Error moving event:', err);
          showToast('Failed to move event', 'error');
        }
        return;
      }

      // Handle job-based event (projects table)
      if (jobId) {
        const draggedEvent = calendarEvents.find(e => e.jobId === jobId && e.date === draggedEventOriginalDate);

        if (!draggedEvent) {
          showToast('Could not find event to move', 'error');
          return;
        }

        try {
          let updateField = null;
          if (draggedEvent.type === 'measure') {
            updateField = 'field_measure_date';
          } else if (draggedEvent.type === 'install') {
            updateField = 'install_date';
          } else if (draggedEvent.type === 'job') {
            updateField = 'estimated_start_date';
          }

          if (!updateField) {
            showToast('Cannot reschedule this event type', 'warning');
            return;
          }

          const { error: updateError } = await supabaseClient
            .from('projects')
            .update({ [updateField]: newDate })
            .eq('id', jobId);

          if (updateError) throw updateError;

          showToast(`${draggedEvent.type.charAt(0).toUpperCase() + draggedEvent.type.slice(1)} moved to ${new Date(newDate).toLocaleDateString()}`, 'success');
          await loadCalendarEvents();
          await loadAllCalendarEvents();

        } catch (err) {
          console.error('Error moving job event:', err);
          showToast('Failed to move event', 'error');
        }
      }
    };

    async function loadCalendarEvents() {
      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        // Get projects with dates
        const { data: jobs, error } = await supabaseClient
          .from('projects')
          .select('id, job_number, customer_name, name, description, status, estimated_start_date, field_measure_date, install_date')
          .eq('user_id', user.id)
          .not('status', 'in', '("completed","cancelled")');

        if (error) throw error;

        // Keep API events (appointments), clear only job-based events
        // This prevents API appointments from disappearing when this function is called alone
        calendarEvents = calendarEvents.filter(e => e.apiEventId);

        (jobs || []).forEach(job => {
          const title = job.customer_name || job.name || job.description || job.job_number;

          if (job.estimated_start_date) {
            calendarEvents.push({
              date: job.estimated_start_date,
              title: title,
              type: 'job',
              jobId: job.id,
              status: job.status
            });
          }

          if (job.field_measure_date) {
            const measureDate = job.field_measure_date.split('T')[0];
            calendarEvents.push({
              date: measureDate,
              title: `Measure: ${title}`,
              type: 'measure',
              jobId: job.id,
              status: job.status
            });
          }

          if (job.install_date) {
            const installDate = job.install_date.split('T')[0];
            calendarEvents.push({
              date: installDate,
              title: `Install: ${title}`,
              type: 'install',
              jobId: job.id,
              status: job.status
            });
          }
        });

        renderCalendar();
        renderUpcomingEvents();
      } catch (err) {
        console.error('Load calendar events error:', err);
      }
    }

    function renderUpcomingEvents() {
      const container = document.getElementById('upcoming-events-list');
      if (!container) return;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const upcoming = calendarEvents
        .filter(e => new Date(e.date) >= today)
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 10);

      if (upcoming.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 30px;">
            <p style="color: var(--text-muted);">No upcoming events scheduled</p>
          </div>
        `;
        return;
      }

      const typeColors = {
        job: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' },
        appointment: { bg: 'rgba(59, 130, 246, 0.15)', color: '#3b82f6' },
        install: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981' },
        installation: { bg: 'rgba(16, 185, 129, 0.15)', color: '#10b981' },
        measure: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' },
        measurement: { bg: 'rgba(245, 158, 11, 0.15)', color: '#f59e0b' },
        production: { bg: 'rgba(139, 92, 246, 0.15)', color: '#8b5cf6' },
        meeting: { bg: 'rgba(139, 92, 246, 0.15)', color: '#8b5cf6' },
        consultation: { bg: 'rgba(236, 72, 153, 0.15)', color: '#ec4899' },
        delivery: { bg: 'rgba(6, 182, 212, 0.15)', color: '#06b6d4' },
        follow_up: { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280' },
        site_visit: { bg: 'rgba(249, 115, 22, 0.15)', color: '#f97316' },
        other: { bg: 'rgba(107, 114, 128, 0.15)', color: '#6b7280' }
      };

      const typeNames = {
        job: 'Scheduled',
        appointment: 'Appointment',
        install: 'Installation',
        installation: 'Installation',
        measure: 'Field Measure',
        measurement: 'Measurement',
        production: 'In Production',
        meeting: 'Meeting',
        consultation: 'Consultation',
        delivery: 'Delivery',
        follow_up: 'Follow-up',
        site_visit: 'Site Visit',
        other: 'Event'
      };

      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      container.innerHTML = upcoming.map(event => {
        const date = new Date(event.date + 'T00:00:00');
        const colors = typeColors[event.type] || typeColors.job;
        const typeName = typeNames[event.type] || 'Event';

        // Determine click handler based on event source
        const clickHandler = event.apiEventId
          ? `openCalendarEventDetailModal('${event.apiEventId}')`
          : (event.jobId ? `openJobDetail('${event.jobId}')` : '');

        return `
          <div class="upcoming-event-item" onclick="${clickHandler}" style="${clickHandler ? 'cursor: pointer;' : ''}">
            <div class="upcoming-event-date">
              <span class="day">${date.getDate()}</span>
              <span class="month">${monthNames[date.getMonth()]}</span>
            </div>
            <div class="upcoming-event-info">
              <div class="upcoming-event-title">${escapeHtml(event.title)}</div>
              <div class="upcoming-event-details">
                <span class="upcoming-event-type" style="background: ${colors.bg}; color: ${colors.color};">${typeName}</span>
                ${event.hasParticipants ? '<span style="margin-left: 6px; font-size: 11px; color: var(--text-muted);">👥</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // =============================================
    // CUSTOMERS MODAL
    // =============================================

    function openCustomersModal() {
      document.getElementById('customers-modal').classList.add('active');
      loadCustomersModal();
    }

    function closeCustomersModal() {
      document.getElementById('customers-modal').classList.remove('active');
    }

    // Smart paste parser - auto-fills form fields from pasted text block
    function parseContactInfo(text) {
      const result = {
        name: null,
        firstName: null,
        lastName: null,
        address: null,
        city: null,
        state: null,
        zip: null,
        phone: null,
        email: null
      };

      // Split into lines and clean up
      const lines = text.split(/[\n\r]+/).map(l => l.trim()).filter(l => l);
      if (lines.length === 0) return null;

      // Only trigger smart parse if multiple lines or contains patterns
      const hasMultipleLines = lines.length > 1;
      const hasEmail = /@/.test(text);
      const hasPhone = /\d{10}|\d{3}[-.\s]?\d{3}[-.\s]?\d{4}/.test(text);
      const hasAddress = /\d+\s+\w+\s+(st|street|ave|avenue|ln|lane|dr|drive|rd|road|blvd|way|ct|court|pl|place|cir|circle)/i.test(text);

      if (!hasMultipleLines && !hasEmail && !hasPhone && !hasAddress) {
        return null; // Just a normal name paste, don't parse
      }

      for (const line of lines) {
        // Check for email
        const emailMatch = line.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
        if (emailMatch) {
          result.email = emailMatch[1];
          continue;
        }

        // Check for phone (10 digits in various formats)
        const phoneMatch = line.match(/(\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}|\d{10})/);
        if (phoneMatch && !result.phone) {
          result.phone = phoneMatch[1].replace(/\D/g, '');
          // Format as (XXX) XXX-XXXX
          if (result.phone.length === 10) {
            result.phone = `(${result.phone.slice(0,3)}) ${result.phone.slice(3,6)}-${result.phone.slice(6)}`;
          }
          continue;
        }

        // Check for City, State ZIP pattern (require comma OR zip code to avoid false positives)
        // Pattern 1: "City, ST" or "City, ST 85383" (comma required)
        const cityStateComma = line.match(/^([A-Za-z\s]+),\s*([A-Z]{2})\s*(\d{5}(?:-\d{4})?)?$/i);
        if (cityStateComma) {
          result.city = cityStateComma[1].trim();
          result.state = cityStateComma[2].toUpperCase();
          if (cityStateComma[3]) result.zip = cityStateComma[3];
          continue;
        }
        // Pattern 2: "City ST 85383" (no comma but zip required)
        const cityStateZip = line.match(/^([A-Za-z\s]+)\s+([A-Z]{2})\s+(\d{5}(?:-\d{4})?)$/i);
        if (cityStateZip) {
          result.city = cityStateZip[1].trim();
          result.state = cityStateZip[2].toUpperCase();
          result.zip = cityStateZip[3];
          continue;
        }

        // Check for street address (number + street name)
        const addressMatch = line.match(/^(\d+\s+.+)$/);
        if (addressMatch && !result.address) {
          // Make sure it's not a phone or zip
          if (!/^\d{5,}$/.test(line.replace(/\s/g, '')) && !/^\d{10}$/.test(line.replace(/\D/g, ''))) {
            result.address = addressMatch[1];
            continue;
          }
        }

        // First unmatched line is probably the name
        if (!result.name && !result.address) {
          // Check it doesn't look like an address or phone
          if (!/^\d+\s/.test(line) && !/\d{3}[-.\s]?\d{3}/.test(line)) {
            result.name = line;
            // Split into first/last name
            const nameParts = line.split(/\s+/);
            if (nameParts.length >= 2) {
              result.firstName = nameParts[0];
              result.lastName = nameParts.slice(1).join(' ');
            } else {
              result.firstName = line;
              result.lastName = '';
            }
          }
        }
      }

      return result;
    }

    // Setup smart paste on a form
    function setupSmartPaste(nameFieldId, fieldMap) {
      const nameField = document.getElementById(nameFieldId);
      if (!nameField || nameField._smartPasteSetup) return;

      nameField._smartPasteSetup = true;
      nameField.addEventListener('paste', (e) => {
        const pastedText = e.clipboardData?.getData('text');
        if (!pastedText) return;

        const parsed = parseContactInfo(pastedText);
        if (!parsed) return; // Let normal paste happen

        e.preventDefault(); // Stop normal paste

        // Fill in the fields
        if (parsed.name && fieldMap.name) {
          document.getElementById(fieldMap.name).value = parsed.name;
        }
        if (parsed.firstName && fieldMap.firstName) {
          document.getElementById(fieldMap.firstName).value = parsed.firstName;
        }
        if (parsed.lastName && fieldMap.lastName) {
          document.getElementById(fieldMap.lastName).value = parsed.lastName;
        }
        if (parsed.email && fieldMap.email) {
          document.getElementById(fieldMap.email).value = parsed.email;
        }
        if (parsed.phone && fieldMap.phone) {
          document.getElementById(fieldMap.phone).value = parsed.phone;
        }
        if (parsed.address && fieldMap.address) {
          document.getElementById(fieldMap.address).value = parsed.address;
        }
        if (parsed.city && fieldMap.city) {
          document.getElementById(fieldMap.city).value = parsed.city;
        }
        if (parsed.state && fieldMap.state) {
          document.getElementById(fieldMap.state).value = parsed.state;
        }
        if (parsed.zip && fieldMap.zip) {
          document.getElementById(fieldMap.zip).value = parsed.zip;
        }

        showToast('Contact info auto-filled!', 'success');
      });
    }

    function openAddCustomerModal(customerId = null) {
      const modal = document.getElementById('add-customer-modal');
      const form = document.getElementById('add-customer-form');
      const title = document.getElementById('add-customer-modal-title');

      // Reset form
      form.reset();
      document.getElementById('edit-customer-id').value = '';

      if (customerId) {
        // Edit mode - find customer and populate form
        title.textContent = 'Edit Customer';
        const customer = allCustomers?.find(c => c.id === customerId);
        if (customer) {
          document.getElementById('edit-customer-id').value = customer.id;
          document.getElementById('cust-name').value = customer.name || '';
          document.getElementById('cust-email').value = customer.email || '';
          document.getElementById('cust-phone').value = customer.phone || '';
          document.getElementById('cust-company').value = customer.company || '';
          document.getElementById('cust-address').value = customer.address || '';
          document.getElementById('cust-city').value = customer.city || '';
          document.getElementById('cust-state').value = customer.state || 'AZ';
          document.getElementById('cust-zip').value = customer.zip || '';
          const notesField = document.getElementById('cust-notes');
          if (notesField) notesField.value = customer.notes || '';
        }
      } else {
        title.textContent = 'Add New Customer';
      }

      // Setup smart paste for auto-filling from pasted contact info
      setupSmartPaste('cust-name', {
        name: 'cust-name',
        email: 'cust-email',
        phone: 'cust-phone',
        address: 'cust-address',
        city: 'cust-city',
        state: 'cust-state',
        zip: 'cust-zip'
      });

      modal.classList.add('active');
    }

    function closeAddCustomerModal() {
      document.getElementById('add-customer-modal').classList.remove('active');
    }

    async function saveCustomer(event) {
      event.preventDefault();

      const customerId = document.getElementById('edit-customer-id').value;
      const notesField = document.getElementById('cust-notes');
      const customerData = {
        name: document.getElementById('cust-name').value.trim(),
        email: document.getElementById('cust-email').value.trim() || null,
        phone: document.getElementById('cust-phone').value.trim() || null,
        company: document.getElementById('cust-company').value.trim() || null,
        address: document.getElementById('cust-address').value.trim() || null,
        city: document.getElementById('cust-city').value.trim() || null,
        state: document.getElementById('cust-state').value.trim() || null,
        zip: document.getElementById('cust-zip').value.trim() || null,
        notes: notesField ? notesField.value.trim() || null : null,
        source: 'manual',
        created_at: new Date().toISOString()
      };

      console.log('[SaveCustomer] Customer data:', customerData);

      if (!customerData.name) {
        showToast('Customer name is required', 'error');
        return;
      }

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        console.log('[SaveCustomer] User:', user?.id);
        if (!user) {
          showToast('Please log in first', 'error');
          return;
        }

        let result;
        if (customerId) {
          // Update existing customer
          result = await supabaseClient
            .from('customers')
            .update(customerData)
            .eq('id', customerId)
            .eq('user_id', user.id)
            .select()
            .single();
        } else {
          // Create new customer
          result = await supabaseClient
            .from('customers')
            .insert({ ...customerData, user_id: user.id })
            .select()
            .single();
        }

        console.log('[SaveCustomer] Result:', result);
        if (result.error) {
          console.error('[SaveCustomer] Supabase error details:', result.error);
          throw result.error;
        }

        showToast(customerId ? 'Customer updated!' : 'Customer created!');
        closeAddCustomerModal();
        loadCustomersModal(); // Refresh the list
      } catch (err) {
        console.error('Save customer error:', err);
        showToast('Error saving customer: ' + err.message, 'error');
      }
    }

    // UNIFIED: Start estimate from customer - uses centralized state
    async function startEstimateFromCustomer(customerId) {
      // Use helper to fetch customer (handles cache and DB lookup)
      const customer = await getCustomer(customerId) || selectedCustomer;

      if (!customer) {
        showToast('Customer not found. Please select a customer first.', 'error');
        return;
      }

      // Update unified workflow state
      workflowState.currentCustomer = customer;
      selectedCustomer = customer;

      // Close any open modals
      if (typeof closeCustomersModal === 'function') closeCustomersModal();
      if (typeof closeCustomerModal === 'function') closeCustomerModal();

      // Navigate to estimates page
      showPage('estimates');

      // Small delay to ensure page is rendered
      setTimeout(() => {
        // Set modal state with proper customer linkage (no more dataset attributes)
        estimateModalState = {
          customerId: customer.id,
          leadId: null,
          editingEstimateId: null
        };

        // Open estimate modal (preserveState=true since we set estimateModalState above)
        openCreateEstimateModal(true);

        // Pre-fill customer info using helper
        fillEstimateCustomerFields(customer);

        showToast(`Creating estimate for ${customer.name}`);
      }, 100);
    }

    // Backward compatibility alias
    async function createEstimateForCustomer(customerId) {
      // Use selectedCustomer if no ID provided
      const id = customerId || selectedCustomer?.id;
      if (!id) {
        showToast('No customer selected', 'warning');
        return;
      }
      return startEstimateFromCustomer(id);
    }

    // Create invoice for selected customer
    function createInvoiceForCustomer() {
      if (!selectedCustomer) {
        showToast('No customer selected', 'warning');
        return;
      }
      closeCustomerModal();
      showPage('invoices');
      setTimeout(() => {
        openInvoiceModal(selectedCustomer);
      }, 100);
    }

    async function loadCustomersModal() {
      const container = document.getElementById('customers-list-modal');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        container.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';

        const { data: customers, error } = await supabaseClient
          .from('customers')
          .select('*')
          .eq('user_id', user.id)
          .order('name');

        if (error) throw error;

        // Store in global array for other functions
        allCustomers = customers || [];

        if (!customers || customers.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No customers yet. Click "Add Customer" to create one.</div>';
          return;
        }

        container.innerHTML = `
          <table style="width: 100%;">
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Jobs</th>
                <th>Total Spent</th>
                <th style="width: 180px;">Actions</th>
              </tr>
            </thead>
            <tbody>
              ${customers.map(c => `
                <tr>
                  <td>
                    <strong>${c.name}</strong>
                    ${c.company ? `<div style="font-size: 12px; color: var(--text-muted);">${c.company}</div>` : ''}
                  </td>
                  <td>
                    <div style="font-size: 13px;">${c.email || '-'}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">${c.phone || ''}</div>
                  </td>
                  <td>${c.total_jobs || 0}</td>
                  <td style="color: var(--gold-primary); font-weight: 600;">$${(c.total_spent || 0).toFixed(2)}</td>
                  <td>
                    <div style="display: flex; gap: 8px;">
                      <button onclick="createEstimateForCustomer('${c.id}')" class="btn-modern small" style="font-size: 12px; padding: 6px 10px;">
                        <i class="fas fa-file-invoice"></i> Estimate
                      </button>
                      <button onclick="openAddCustomerModal('${c.id}')" class="btn-modern secondary small" style="font-size: 12px; padding: 6px 10px;">
                        <i class="fas fa-edit"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (err) {
        console.error('Load customers error:', err);
        container.innerHTML = '<div style="color: var(--text-muted);">Error loading customers</div>';
      }
    }

    function searchCustomers() {
      // Simple client-side search
      const query = document.getElementById('customer-search').value.toLowerCase();
      const rows = document.querySelectorAll('#customers-list-modal tbody tr');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
      });
    }

    async function sendCustomerUpdate() {
      // Placeholder for sending customer update email
      showToast('Customer update feature coming soon!', 'info');
    }

    async function orderMaterials() {
      // Placeholder for material ordering
      showToast('Material ordering feature coming soon!', 'info');
    }

    function saveJobChanges() {
      showToast('Changes saved!');
      closeJobDetailModal();
    }

    let currentContractorId = null;

    function editContractor(contractorId) {
      openContractorProfile(contractorId);
    }

    async function openContractorProfile(contractorId) {
      currentContractorId = contractorId;
      const modal = document.getElementById('contractor-profile-modal');
      modal.classList.add('active');

      // Find contractor in allCollaborators
      let contractor = allCollaborators.find(c => c.id === contractorId);

      // If not found, fetch from database
      if (!contractor) {
        try {
          const { data, error } = await supabaseClient
            .from('general_collaborators')
            .select('*')
            .eq('id', contractorId)
            .single();
          if (error) throw error;
          contractor = data;
        } catch (err) {
          console.error('Load contractor error:', err);
          alert('Could not load contractor');
          return;
        }
      }

      // Populate profile
      document.getElementById('contractor-profile-name').textContent = contractor.name || 'Unknown';
      document.getElementById('contractor-profile-company').textContent = contractor.company || '';
      document.getElementById('contractor-profile-email').textContent = contractor.email || '-';
      document.getElementById('contractor-profile-phone').textContent = contractor.phone || '-';
      document.getElementById('contractor-profile-type').textContent = (contractor.role || '-').replace('_', ' ');
      document.getElementById('contractor-profile-license').textContent = contractor.license_number || '-';

      // Trust score
      const trustScore = contractor.trust_score || 0;
      document.getElementById('contractor-trust-score').textContent = trustScore;
      const badge = document.getElementById('contractor-trust-badge');
      badge.classList.toggle('verified', trustScore >= 70);

      // Generate invite link
      generateInviteLink(contractorId, contractor);

      // Render verification checklist
      renderVerificationChecklist(contractor);

      // Load documents
      loadContractorDocuments(contractorId);

      // Load job history
      loadContractorJobHistory(contractorId);
    }

    function closeContractorProfileModal() {
      document.getElementById('contractor-profile-modal').classList.remove('active');
      currentContractorId = null;
    }

    // Bridge: Assign contractor to a project
    async function assignContractorToProject(contractorId) {
      if (!contractorId) { showToast('No contractor selected', 'warning'); return; }

      var activeProjects = (allProjects || []).filter(function(p) {
        return p.status !== 'completed' && p.status !== 'cancelled';
      });

      if (!activeProjects.length) { showToast('No active projects available', 'warning'); return; }

      var projectNames = activeProjects.map(function(p, i) {
        return (i + 1) + '. ' + p.name + ' (' + (PROJECT_STATUS_LABELS[p.status] || p.status) + ')';
      }).join('\n');

      var choice = prompt('Assign contractor to project:\n' + projectNames + '\n\nEnter number:');
      if (!choice) return;

      var idx = parseInt(choice) - 1;
      var project = activeProjects[idx];
      if (!project) { showToast('Invalid selection', 'warning'); return; }

      try {
        await supabaseClient.from('project_crew').insert({
          project_id: project.id,
          contractor_id: contractorId,
          role: 'contractor',
          assigned_at: new Date().toISOString()
        });
        showToast('Contractor assigned to ' + project.name, 'success');
        logProjectActivity(project.id, 'contractor_assigned', 'Contractor assigned to project');
      } catch (err) {
        showToast('Error assigning contractor: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function generateInviteLink(contractorId, contractor) {
      const linkInput = document.getElementById('contractor-invite-link');
      const qrContainer = document.getElementById('contractor-qr-code');

      // Generate a simple token if not exists
      let token = contractor.token_hash;
      if (!token) {
        token = btoa(contractorId + '-' + Date.now()).replace(/[^a-zA-Z0-9]/g, '').substring(0, 24);

        // Save token to database
        try {
          await supabaseClient
            .from('general_collaborators')
            .update({ token_hash: token })
            .eq('id', contractorId);
        } catch (err) {
          console.log('Could not save invite token:', err);
        }
      }

      const inviteUrl = `${window.location.origin}/contractor-portal/?token=${token}`;
      linkInput.value = inviteUrl;

      // Generate QR code (using a simple QR code API)
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=${encodeURIComponent(inviteUrl)}`;
      qrContainer.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="width: 100px; height: 100px; border-radius: 4px;">`;
    }

    function copyInviteLink() {
      const linkInput = document.getElementById('contractor-invite-link');
      linkInput.select();
      document.execCommand('copy');
      showToast('Link copied to clipboard!');
    }

    async function sendInviteEmail() {
      if (!currentContractorId) return;

      const contractor = allCollaborators.find(c => c.id === currentContractorId);
      if (!contractor?.email) {
        alert('No email address for this contractor');
        return;
      }

      try {
        const inviteLink = document.getElementById('contractor-invite-link').value;
        await apiCall('/api/collaborators/send-invite', {
          method: 'POST',
          body: JSON.stringify({
            contractor_id: currentContractorId,
            email: contractor.email,
            invite_link: inviteLink
          })
        });
        showToast('Invite email sent!');
      } catch (err) {
        console.error('Send invite error:', err);
        showToast('Could not send email. Link copied instead.');
        copyInviteLink();
      }
    }

    function sendInviteSMS() {
      const contractor = allCollaborators.find(c => c.id === currentContractorId);
      const inviteLink = document.getElementById('contractor-invite-link').value;

      if (contractor?.phone) {
        // Open SMS app with pre-filled message
        const message = encodeURIComponent(`You've been invited to join Surprise Granite's contractor network! Complete your profile here: ${inviteLink}`);
        window.open(`sms:${contractor.phone}?body=${message}`, '_blank');
      } else {
        copyInviteLink();
        showToast('No phone number. Link copied instead.');
      }
    }

    function renderVerificationChecklist(contractor) {
      const container = document.getElementById('contractor-verification-checklist');

      const checklistItems = [
        { key: 'email', label: 'Email Address', subtitle: 'Contact information', points: 5, completed: !!contractor.email },
        { key: 'phone', label: 'Phone Number', subtitle: 'Contact information', points: 5, completed: !!contractor.phone },
        { key: 'company', label: 'Business Name', subtitle: 'Company details', points: 5, completed: !!contractor.company },
        { key: 'license', label: 'License Number', subtitle: 'Trade license', points: 10, completed: !!contractor.license_number },
        { key: 'claimed', label: 'Profile Claimed', subtitle: 'Account linked', points: 10, completed: !!contractor.claimed_by },
        { key: 'insurance', label: 'Insurance Certificate', subtitle: 'General liability', points: 25, completed: false }, // Check docs
        { key: 'w9', label: 'W-9 Form', subtitle: 'Tax documentation', points: 10, completed: false }, // Check docs
      ];

      container.innerHTML = checklistItems.map(item => `
        <div class="verification-item ${item.completed ? 'completed' : 'pending'}">
          <div class="verification-icon ${item.completed ? 'completed' : 'pending'}">
            ${item.completed
              ? '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>'
              : '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>'
            }
          </div>
          <div class="verification-item-text">
            <div class="verification-item-title">${item.label}</div>
            <div class="verification-item-subtitle">${item.subtitle}</div>
          </div>
          <div class="verification-item-points">+${item.points} pts</div>
        </div>
      `).join('');
    }

    async function loadContractorDocuments(contractorId) {
      const container = document.getElementById('contractor-documents-list');

      try {
        const { data: docs, error } = await supabaseClient
          .from('contractor_documents')
          .select('*')
          .eq('contractor_id', contractorId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        if (!docs || docs.length === 0) {
          container.innerHTML = `
            <div style="color: var(--text-muted); font-size: 13px; text-align: center; padding: 20px;">
              No documents uploaded yet.<br>
              <span style="font-size: 12px;">Upload insurance, license, W-9, and other documents.</span>
            </div>
          `;
          return;
        }

        const docTypeLabels = {
          'insurance_general_liability': 'General Liability Insurance',
          'insurance_workers_comp': 'Workers Comp Insurance',
          'insurance_auto': 'Auto Insurance',
          'license_contractor': 'Contractor License',
          'license_trade': 'Trade License',
          'w9': 'W-9 Form',
          'certification': 'Certification',
          'bond': 'Bond',
          'other': 'Other Document'
        };

        container.innerHTML = docs.map(doc => `
          <div class="document-card">
            <div class="doc-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            </div>
            <div class="doc-info">
              <div class="doc-name">${doc.document_name}</div>
              <div class="doc-meta">${docTypeLabels[doc.document_type] || doc.document_type}${doc.expiration_date ? ' | Exp: ' + new Date(doc.expiration_date).toLocaleDateString() : ''}</div>
            </div>
            <span class="doc-status ${doc.status}">${doc.status}</span>
            <a href="${doc.file_url}" target="_blank" class="action-btn" title="View">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>
            </a>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load contractor documents error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">Could not load documents</div>';
      }
    }

    async function loadContractorJobHistory(contractorId) {
      const container = document.getElementById('contractor-job-history');

      try {
        // Query project_contractors joined with projects
        const { data: assignments, error } = await supabaseClient
          .from('project_contractors')
          .select(`
            id, role, notes, status, assigned_at,
            projects (id, name, customer_name, status, address)
          `)
          .eq('contractor_id', contractorId)
          .order('assigned_at', { ascending: false })
          .limit(10);

        if (error) {
          // Table may not exist yet
          console.log('[Job History] project_contractors not available:', error.message);
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No project history available</div>';
          return;
        }

        if (!assignments || assignments.length === 0) {
          container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">No projects assigned yet</div>';
          return;
        }

        container.innerHTML = assignments.map(pc => `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--dark-elevated); border-radius: 6px; margin-bottom: 6px; cursor: pointer;" onclick="openProjectDetail('${pc.projects?.id}')">
            <div>
              <div style="font-weight: 500; font-size: 13px;">${escapeHtml(pc.projects?.name || 'Unknown Project')}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(pc.projects?.customer_name || '')} - ${pc.role || 'contractor'}</div>
            </div>
            <div style="text-align: right;">
              <span class="status-badge" style="font-size: 9px; padding: 2px 8px; background: rgba(139, 92, 246, 0.15); color: #8b5cf6;">${pc.status || 'assigned'}</span>
            </div>
          </div>
        `).join('');
      } catch (err) {
        console.error('Load job history error:', err);
        container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Could not load project history</div>';
      }
    }

    async function uploadContractorDocument(event) {
      const file = event.target.files[0];
      if (!file || !currentContractorId) return;

      // Ask for document type
      const docType = prompt('Document type? (insurance, license, w9, certification, other)', 'insurance');
      if (!docType) return;

      const docTypeMap = {
        'insurance': 'insurance_general_liability',
        'workers comp': 'insurance_workers_comp',
        'license': 'license_contractor',
        'w9': 'w9',
        'certification': 'certification',
        'bond': 'bond',
        'other': 'other'
      };

      const documentType = docTypeMap[docType.toLowerCase()] || 'other';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        // Upload file to storage
        const fileExt = file.name.split('.').pop();
        const fileName = `collaborators/${currentContractorId}/${Date.now()}.${fileExt}`;

        const { data: uploadData, error: uploadError } = await supabaseClient.storage
          .from('lead-images')
          .upload(fileName, file);

        if (uploadError) throw uploadError;

        const { data: urlData } = supabaseClient.storage.from('lead-images').getPublicUrl(fileName);

        // Create document record
        const { error: docError } = await supabaseClient.from('contractor_documents').insert([{
          contractor_id: currentContractorId,
          user_id: user.id,
          document_type: documentType,
          document_name: file.name,
          file_url: urlData.publicUrl,
          file_type: fileExt,
          status: 'pending'
        }]);

        if (docError) throw docError;

        showToast('Document uploaded!');
        loadContractorDocuments(currentContractorId);

        // Recalculate trust score
        try {
          await supabaseClient.rpc('calculate_contractor_trust_score', { contractor_uuid: currentContractorId });
        } catch (e) {
          console.log('Could not update trust score:', e);
        }
      } catch (err) {
        console.error('Upload document error:', err);
        alert('Error uploading document: ' + err.message);
      }

      event.target.value = '';
    }

    function editContractorDetails() {
      showToast('Edit feature coming soon!', 'info');
    }

    function openNewCustomerModal() {
      // Use the job modal's new customer feature
      openNewJobModal();
      document.getElementById('job-customer-select').value = 'new';
      toggleNewCustomerFields();
    }

    // =============================================
    // SERVICE CATALOG
    // =============================================

    function openServiceCatalog() {
      const modal = document.getElementById('service-catalog-modal');
      modal.classList.add('active');
      loadServiceCatalog();
    }

    function closeServiceCatalog() {
      const modal = document.getElementById('service-catalog-modal');
      modal.classList.remove('active');
    }

    async function loadServiceCatalog() {
      const container = document.getElementById('catalog-items-list');
      if (!container) return;

      container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading...</div>';

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: items, error } = await supabaseClient
          .from('service_catalog')
          .select('*')
          .eq('user_id', user.id)
          .order('category', { ascending: true });

        if (error) throw error;

        serviceCatalog = items || [];

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
              <p>No catalog items yet</p>
              <button class="btn-modern primary small" onclick="openAddCatalogItem()" style="margin-top: 12px;">Add First Item</button>
            </div>`;
          return;
        }

        // Group by category
        const grouped = items.reduce((acc, item) => {
          const cat = item.category || 'Uncategorized';
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        container.innerHTML = Object.entries(grouped).map(([category, catItems]) => `
          <div style="margin-bottom: 20px;">
            <h4 style="font-size: 13px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${category}</h4>
            ${catItems.map(item => `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px;">
                <div>
                  <div style="font-weight: 500;">${item.name}</div>
                  ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span style="color: var(--gold-primary); font-weight: 600;">$${item.default_price}/${item.unit}</span>
                  <button onclick="deleteCatalogItem('${item.id}')" style="background: none; border: none; color: #ef4444; cursor: pointer;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (err) {
        console.error('Load catalog error:', err);
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--error);">Error loading catalog</div>';
      }
    }

    function filterCatalog(type) {
      // Update active filter button
      document.querySelectorAll('#service-catalog-modal .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.toLowerCase().includes(type === 'all' ? 'all' : type));
      });

      // Filter catalog items
      const items = document.querySelectorAll('.catalog-item');
      items.forEach(item => {
        if (type === 'all') {
          item.style.display = '';
        } else {
          const itemType = item.dataset.type || '';
          item.style.display = itemType === type ? '' : 'none';
        }
      });
    }

    function openAddCatalogItem() {
      const modal = document.getElementById('add-catalog-item-modal');
      modal.classList.add('active');
      document.getElementById('add-catalog-item-form').reset();
    }

    function closeAddCatalogItem() {
      const modal = document.getElementById('add-catalog-item-modal');
      modal.classList.remove('active');
    }

    async function saveCatalogItem(event) {
      if (event) event.preventDefault();

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) throw new Error('Please log in');

        const itemData = {
          user_id: user.id,
          name: document.getElementById('catalog-item-name').value.trim(),
          description: document.getElementById('catalog-item-desc').value.trim() || null,
          category: document.getElementById('catalog-item-category').value.trim() || 'General',
          unit: document.getElementById('catalog-item-unit').value,
          default_price: parseFloat(document.getElementById('catalog-item-price').value) || 0
        };

        if (!itemData.name) throw new Error('Please enter an item name');

        const { error } = await supabaseClient
          .from('service_catalog')
          .insert([itemData]);

        if (error) throw error;

        closeAddCatalogItem();
        loadServiceCatalog();
        showToast('Catalog item added!');
      } catch (err) {
        console.error('Save catalog item error:', err);
        alert('Error: ' + err.message);
      }

      return false;
    }

    async function deleteCatalogItem(itemId) {
      if (!confirm('Delete this catalog item?')) return;

      try {
        await supabaseClient.from('service_catalog').delete().eq('id', itemId);
        loadServiceCatalog();
        showToast('Item deleted');
      } catch (err) {
        console.error('Delete catalog item error:', err);
        alert('Error deleting item');
      }
    }

    // =============================================
    // CATALOG PICKER FOR ESTIMATES
    // =============================================

    function openCatalogPicker() {
      // Load catalog items and show picker
      const modal = document.createElement('div');
      modal.id = 'catalog-picker-modal';
      modal.className = 'modal-overlay';
      modal.style.display = 'flex';
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div class="modal-header">
            <h2 class="modal-title">Add from Catalog</h2>
            <button class="modal-close" onclick="document.getElementById('catalog-picker-modal').remove()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="modal-body" id="catalog-picker-list">
            <div style="text-align: center; padding: 20px; color: var(--text-muted);">Loading catalog...</div>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      loadCatalogPicker();
    }

    async function loadCatalogPicker() {
      const container = document.getElementById('catalog-picker-list');
      if (!container) return;

      try {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (!user) return;

        const { data: items } = await supabaseClient
          .from('service_catalog')
          .select('*')
          .eq('user_id', user.id)
          .order('category', { ascending: true });

        if (!items || items.length === 0) {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px;">
              <p style="color: var(--text-muted); margin-bottom: 16px;">No catalog items. Add services and materials to your catalog for quick estimate creation.</p>
              <button class="btn-modern primary" onclick="document.getElementById('catalog-picker-modal').remove(); openServiceCatalog();">
                Set Up Catalog
              </button>
            </div>`;
          return;
        }

        const grouped = items.reduce((acc, item) => {
          const cat = item.category || 'Uncategorized';
          if (!acc[cat]) acc[cat] = [];
          acc[cat].push(item);
          return acc;
        }, {});

        container.innerHTML = Object.entries(grouped).map(([category, catItems]) => `
          <div style="margin-bottom: 16px;">
            <h4 style="font-size: 12px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${category}</h4>
            ${catItems.map(item => `
              <div onclick="addCatalogItemToEstimate(${JSON.stringify(item).replace(/"/g, '&quot;')})" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(249,203,0,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                <div>
                  <div style="font-weight: 500;">${item.name}</div>
                  ${item.description ? `<div style="font-size: 12px; color: var(--text-muted);">${item.description}</div>` : ''}
                </div>
                <span style="color: var(--gold-primary); font-weight: 600;">$${item.default_price}/${item.unit}</span>
              </div>
            `).join('')}
          </div>
        `).join('');

      } catch (err) {
        console.error('Load catalog picker error:', err);
        container.innerHTML = '<div style="padding: 20px; color: var(--error);">Error loading catalog</div>';
      }
    }

    function addCatalogItemToEstimate(item) {
      addEstimateLineItem({
        name: item.name,
        description: item.description,
        unit_type: item.unit,
        quantity: 1,
        price: item.default_price
      });
      document.getElementById('catalog-picker-modal')?.remove();
    }

    // ==================== GOD MODE FUNCTIONS ====================
    // Only accessible to joshb@surprisegranite.com

    // GOD MODE state
    let godModeUsers = [];
    let godModeUsersPage = 0;
    let godModeUsersPerPage = 50;
    let godModeAllUsers = [];
    let godModeLogs = [];

    // Initialize GOD MODE page
    async function initGodModePage(page) {
      if (!isGodMode()) {
        showToast('Access denied - GOD MODE only', 'error');
        showPage('dashboard');
        return;
      }

      console.log('⚡ GOD MODE: Initializing page:', page);

      switch(page) {
        case 'god-mode':
          await loadGodModeDashboard();
          break;
        case 'god-users':
          await godRefreshUsers();
          break;
        case 'god-marketplace':
          await godRefreshMarketplace();
          break;
        case 'god-database':
          await loadGodDatabaseStats();
          break;
        case 'god-api':
          initGodApiTester();
          break;
        case 'god-logs':
          await godRefreshLogs();
          break;
        case 'god-analytics':
          await godLoadAnalytics();
          break;
        case 'god-site':
          await godLoadSiteManager();
          break;
        case 'god-config':
          await godLoadConfig();
          break;
        case 'god-designs':
          await godLoadDesigns();
          break;
      }
    }

    // GOD MODE Dashboard
    async function loadGodModeDashboard() {
      // Update environment info
      document.getElementById('god-api-base').textContent = API_BASE || 'Not configured';
      document.getElementById('god-user-agent').textContent = navigator.userAgent.substring(0, 80) + '...';
      document.getElementById('god-session-id').textContent = currentUser?.id?.substring(0, 8) + '...' || 'N/A';
      document.getElementById('god-auth-status').textContent = currentUser ? 'Authenticated' : 'Not authenticated';

      await refreshSystemHealth();
    }

    async function refreshSystemHealth() {
      try {
        // Check API
        document.getElementById('god-api-status').textContent = 'Checking...';
        try {
          const apiRes = await fetch(`${API_BASE}/api/stripe-status`);
          document.getElementById('god-api-status').textContent = apiRes.ok ? 'Online' : 'Error';
          document.getElementById('god-api-status').style.color = apiRes.ok ? 'var(--success)' : 'var(--error)';
        } catch { document.getElementById('god-api-status').textContent = 'Offline'; document.getElementById('god-api-status').style.color = 'var(--error)'; }

        // Check Supabase
        document.getElementById('god-supabase-status').textContent = 'Checking...';
        try {
          const { count } = await supabaseClient.from('sg_users').select('*', { count: 'exact', head: true });
          document.getElementById('god-supabase-status').textContent = 'Connected';
          document.getElementById('god-supabase-status').style.color = 'var(--success)';
          document.getElementById('god-total-users').textContent = count || 0;
        } catch { document.getElementById('god-supabase-status').textContent = 'Error'; document.getElementById('god-supabase-status').style.color = 'var(--error)'; }

        // Check Stripe via API
        document.getElementById('god-stripe-status').textContent = 'Checking...';
        try {
          const stripeRes = await fetch(`${API_BASE}/api/stripe-status`);
          const stripeData = await stripeRes.json();
          document.getElementById('god-stripe-status').textContent = stripeData.connected ? 'Connected' : 'Error';
          document.getElementById('god-stripe-status').style.color = stripeData.connected ? 'var(--success)' : 'var(--error)';
        } catch { document.getElementById('god-stripe-status').textContent = 'Unknown'; }

        // Load counts
        try {
          const { count: subCount } = await supabaseClient.from('sg_users').select('*', { count: 'exact', head: true }).eq('subscription_status', 'active');
          document.getElementById('god-active-subs').textContent = subCount || 0;
        } catch {}

        try {
          const { count: distCount } = await supabaseClient.from('distributor_profiles').select('*', { count: 'exact', head: true });
          document.getElementById('god-total-distributors').textContent = distCount || 0;
        } catch {}

      } catch (error) {
        console.error('GOD MODE health check error:', error);
      }
    }

    // Quick Actions
    async function godClearCache() {
      if (!isGodMode()) return;
      localStorage.clear();
      sessionStorage.clear();
      showToast('Cache cleared successfully', 'success');
    }

    async function godSendTestEmail() {
      if (!isGodMode()) return;
      try {
        const res = await fetch(`${API_BASE}/api/test-email`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to: currentUser.email, subject: 'GOD MODE Test Email', body: 'This is a test email from GOD MODE.' })
        });
        showToast(res.ok ? 'Test email sent' : 'Failed to send email', res.ok ? 'success' : 'error');
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function godSyncShopify() {
      if (!isGodMode()) return;
      showToast('Shopify sync initiated...', 'info');
      // This would trigger a backend sync
      try {
        const res = await fetch(`${API_BASE}/api/shopify/sync`, { method: 'POST' });
        showToast(res.ok ? 'Sync complete' : 'Sync failed', res.ok ? 'success' : 'error');
      } catch { showToast('Sync endpoint not available', 'warning'); }
    }

    async function godBackupDatabase() {
      if (!isGodMode()) return;
      showToast('Generating database export...', 'info');
      // Export key tables as JSON
      try {
        const tables = ['sg_users', 'customers', 'jobs', 'leads', 'estimates'];
        const backup = {};
        for (const table of tables) {
          const { data } = await supabaseClient.from(table).select('*').limit(1000);
          backup[table] = data || [];
        }
        const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sg-backup-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showToast('Backup downloaded', 'success');
      } catch (e) { showToast('Backup failed: ' + e.message, 'error'); }
    }

    async function godToggleMaintenanceMode() {
      if (!isGodMode()) return;
      const inMaintenance = document.body.classList.toggle('maintenance-mode');
      showToast(inMaintenance ? 'Maintenance mode ON' : 'Maintenance mode OFF', 'warning');
    }

    async function godReindexProducts() {
      if (!isGodMode()) return;
      showToast('Reindexing products...', 'info');
      setTimeout(() => showToast('Products reindexed', 'success'), 2000);
    }

    // GOD MODE Users Management
    async function godRefreshUsers() {
      if (!isGodMode()) return;
      try {
        const { data, error, count } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact' })
          .order('created_at', { ascending: false })
          .range(godModeUsersPage * godModeUsersPerPage, (godModeUsersPage + 1) * godModeUsersPerPage - 1);

        if (error) throw error;
        godModeAllUsers = data || [];

        // Update stats
        document.getElementById('god-users-total').textContent = count || 0;

        // Count by role
        const { data: allUsers } = await supabaseClient.from('sg_users').select('account_type, subscription_status');
        const roleCounts = { admin: 0, pro: 0, contractor: 0, vendor: 0, homeowner: 0 };
        (allUsers || []).forEach(u => {
          const type = u.account_type || 'homeowner';
          if (type.includes('admin')) roleCounts.admin++;
          else if (type.includes('contractor') || type.includes('fabricator')) roleCounts.contractor++;
          else if (type.includes('vendor')) roleCounts.vendor++;
          else roleCounts.homeowner++;
          // Count pro separately by subscription status
          if (u.subscription_status === 'active' || u.subscription_status === 'trialing') roleCounts.pro++;
        });
        document.getElementById('god-users-admins').textContent = roleCounts.admin;
        document.getElementById('god-users-pro').textContent = roleCounts.pro;
        document.getElementById('god-users-collaborators').textContent = roleCounts.contractor;

        // Also fetch Shopify and Leads counts for summary
        try {
          const { count: shopifyCount } = await supabaseClient.from('shopify_customers').select('*', { count: 'exact', head: true });
          document.getElementById('god-users-shopify').textContent = shopifyCount || 0;
        } catch (e) {
          document.getElementById('god-users-shopify').textContent = '0';
        }
        try {
          const { count: leadsCount } = await supabaseClient.from('leads').select('*', { count: 'exact', head: true });
          document.getElementById('god-users-leads').textContent = leadsCount || 0;
        } catch (e) {
          document.getElementById('god-users-leads').textContent = '0';
        }

        renderGodUsersTable();
        document.getElementById('god-users-count').textContent = `Showing ${data.length} of ${count} users`;

      } catch (error) {
        console.error('GOD MODE users error:', error);
        showToast('Failed to load users', 'error');
      }
    }

    function renderGodUsersTable() {
      const tbody = document.getElementById('god-users-table-body');
      if (!tbody) return;

      if (!godModeAllUsers.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No users found</td></tr>';
        return;
      }

      tbody.innerHTML = godModeAllUsers.map(user => `
        <tr style="border-bottom: 1px solid var(--border-subtle);">
          <td style="padding: 12px 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">${(user.full_name || user.email || '?')[0].toUpperCase()}</div>
              <div>
                <div style="font-weight: 500;">${escapeHtml(user.full_name || 'No name')}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(user.email || 'No email')}</div>
              </div>
            </div>
          </td>
          <td style="padding: 12px 16px;"><span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #a855f7; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${escapeHtml(user.account_type || 'homeowner')}</span></td>
          <td style="padding: 12px 16px;"><span style="color: ${user.subscription_status === 'active' ? 'var(--success)' : 'var(--text-muted)'};">${user.subscription_status || 'none'}</span></td>
          <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${user.created_at ? new Date(user.created_at).toLocaleDateString() : '-'}</td>
          <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleDateString() : '-'}</td>
          <td style="padding: 12px 16px; text-align: center;">
            <button class="btn-modern secondary" onclick="godEditUser('${user.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
            <button class="btn-modern secondary" onclick="godImpersonateUser('${user.id}')" style="padding: 6px 12px; font-size: 12px; margin-left: 4px;">View As</button>
          </td>
        </tr>
      `).join('');
    }

    function godSearchUsers() {
      const search = document.getElementById('god-users-search')?.value?.toLowerCase() || '';
      const filtered = godModeAllUsers.filter(u =>
        (u.email || '').toLowerCase().includes(search) ||
        (u.full_name || '').toLowerCase().includes(search) ||
        (u.id || '').toLowerCase().includes(search)
      );
      const tbody = document.getElementById('god-users-table-body');
      if (tbody && filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No users match your search</td></tr>';
      } else {
        godModeAllUsers = filtered;
        renderGodUsersTable();
      }
    }

    function godFilterUsers() {
      godModeUsersPage = 0;
      godRefreshUsers();
    }

    async function godEditUser(userId) {
      if (!isGodMode()) return;
      const { data: user, error } = await supabaseClient.from('sg_users').select('*').eq('id', userId).single();
      if (error || !user) { showToast('User not found', 'error'); return; }

      const newRole = prompt(`Edit role for ${user.email}\nCurrent: ${user.account_type}\n\nEnter new role (homeowner, contractor, fabricator, vendor, admin):`, user.account_type);
      if (newRole && newRole !== user.account_type) {
        const { error: updateError } = await supabaseClient.from('sg_users').update({ account_type: newRole }).eq('id', userId);
        if (updateError) { showToast('Failed to update: ' + updateError.message, 'error'); }
        else { showToast('User role updated', 'success'); godRefreshUsers(); }
      }
    }

    function godImpersonateUser(userId) {
      if (!isGodMode()) return;
      showToast('Impersonation not yet implemented', 'warning');
    }

    function godExportUsers() {
      if (!isGodMode() || !godModeAllUsers.length) return;
      const csv = 'Email,Name,Role,Subscription,Created\n' + godModeAllUsers.map(u =>
        `"${u.email || ''}","${u.full_name || ''}","${u.account_type || ''}","${u.subscription_status || ''}","${u.created_at || ''}"`
      ).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'users-export.csv';
      a.click();
    }

    function godUsersPagePrev() { if (godModeUsersPage > 0) { godModeUsersPage--; godRefreshUsers(); } }
    function godUsersPageNext() { godModeUsersPage++; godRefreshUsers(); }

    // GOD MODE Customer Hub Tabs
    let godShopifyPage = 0;
    let godLeadsPage = 0;
    let godProPage = 0;
    let godCollaboratorsPage = 0;
    const godTabPageSize = 25;

    function godShowCustomerTab(tabName) {
      // Hide all customer tabs
      document.querySelectorAll('.god-customer-tab').forEach(el => el.style.display = 'none');
      // Show selected tab
      const selectedTab = document.getElementById('god-customer-tab-' + tabName);
      if (selectedTab) selectedTab.style.display = 'block';
      // Update active tab button
      const tabsContainer = selectedTab?.closest('section')?.querySelector('.tabs-modern');
      if (tabsContainer) {
        tabsContainer.querySelectorAll('.tab-modern').forEach(btn => btn.classList.remove('active'));
        const activeBtn = Array.from(tabsContainer.querySelectorAll('.tab-modern')).find(btn =>
          btn.textContent.toLowerCase().includes(tabName.replace('-', ' ').split(' ')[0])
        );
        if (activeBtn) activeBtn.classList.add('active');
      }
      // Load tab data
      switch(tabName) {
        case 'all-users': godRefreshUsers(); break;
        case 'shopify': godLoadShopifyCustomers(); break;
        case 'leads': godLoadLeads(); break;
        case 'pro': godLoadProUsers(); break;
        case 'collaborators': godLoadCollaborators(); break;
      }
    }

    // Shopify Customers
    async function godLoadShopifyCustomers() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-shopify-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('god-shopify-filter')?.value || 'all';

        let query = supabaseClient.from('shopify_customers').select('*', { count: 'exact' });

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`);
        }
        if (filter === 'with-orders') query = query.gt('orders_count', 0);
        if (filter === 'no-orders') query = query.eq('orders_count', 0);
        if (filter === 'marketing-opted') query = query.eq('accepts_marketing', true);

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godShopifyPage * godTabPageSize, (godShopifyPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-shopify').textContent = count || 0;
        document.getElementById('god-shopify-count').textContent = `Showing ${data?.length || 0} of ${count || 0} customers`;

        const tbody = document.getElementById('god-shopify-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No Shopify customers found</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(c => `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <div style="font-weight: 500;">${escapeHtml((c.first_name || '') + ' ' + (c.last_name || ''))}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(c.email || '')}</div>
            </td>
            <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(c.phone || '-')}</td>
            <td style="padding: 12px 16px;"><span style="font-weight: 600; color: var(--accent);">${c.orders_count || 0}</span></td>
            <td style="padding: 12px 16px; font-weight: 500; color: var(--success);">$${parseFloat(c.total_spent || 0).toFixed(2)}</td>
            <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${c.created_at ? new Date(c.created_at).toLocaleDateString() : '-'}</td>
            <td style="padding: 12px 16px; text-align: center;">
              <button class="btn-modern secondary" onclick="godViewUnifiedProfile('${escapeHtml(c.email)}')" style="padding: 6px 12px; font-size: 12px;">Profile</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('god-shopify-prev').disabled = godShopifyPage === 0;
        document.getElementById('god-shopify-next').disabled = (godShopifyPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading Shopify customers:', error);
        document.getElementById('god-shopify-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading customers</td></tr>';
      }
    }

    function godSearchShopifyCustomers() { godShopifyPage = 0; godLoadShopifyCustomers(); }
    function godFilterShopifyCustomers() { godShopifyPage = 0; godLoadShopifyCustomers(); }
    function godShopifyPagePrev() { if (godShopifyPage > 0) { godShopifyPage--; godLoadShopifyCustomers(); } }
    function godShopifyPageNext() { godShopifyPage++; godLoadShopifyCustomers(); }

    // Leads Management
    async function godLoadLeads() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-leads-search')?.value?.toLowerCase() || '';
        const statusFilter = document.getElementById('god-leads-status')?.value || 'all';
        const sourceFilter = document.getElementById('god-leads-source')?.value || 'all';

        let query = supabaseClient.from('leads').select('*', { count: 'exact' });

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);
        }
        if (statusFilter !== 'all') query = query.eq('status', statusFilter);
        if (sourceFilter !== 'all') query = query.eq('source', sourceFilter);

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godLeadsPage * godTabPageSize, (godLeadsPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-leads').textContent = count || 0;
        document.getElementById('god-leads-count').textContent = `Showing ${data?.length || 0} of ${count || 0} leads`;

        const tbody = document.getElementById('god-leads-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No leads found</td></tr>';
          return;
        }

        const statusColors = {
          'new': { bg: 'rgba(59, 130, 246, 0.2)', color: 'var(--info)' },
          'contacted': { bg: 'rgba(249, 203, 0, 0.2)', color: 'var(--accent)' },
          'qualified': { bg: 'rgba(16, 185, 129, 0.2)', color: 'var(--success)' },
          'converted': { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7' },
          'lost': { bg: 'rgba(239, 68, 68, 0.2)', color: 'var(--error)' }
        };

        tbody.innerHTML = data.map(l => {
          const sc = statusColors[l.status] || statusColors['new'];
          return `
            <tr style="border-bottom: 1px solid var(--border-subtle);">
              <td style="padding: 12px 16px;">
                <div style="font-weight: 500;">${escapeHtml(l.name || 'Unknown')}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(l.email || '')}</div>
              </td>
              <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(l.phone || '-')}</td>
              <td style="padding: 12px 16px;"><span style="background: ${sc.bg}; color: ${sc.color}; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${l.status || 'new'}</span></td>
              <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(l.source || '-')}</td>
              <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${l.created_at ? new Date(l.created_at).toLocaleDateString() : '-'}</td>
              <td style="padding: 12px 16px; text-align: center;">
                <button class="btn-modern secondary" onclick="godEditLead('${l.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
              </td>
            </tr>
          `;
        }).join('');

        document.getElementById('god-leads-prev').disabled = godLeadsPage === 0;
        document.getElementById('god-leads-next').disabled = (godLeadsPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading leads:', error);
        document.getElementById('god-leads-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading leads</td></tr>';
      }
    }

    function godSearchLeads() { godLeadsPage = 0; godLoadLeads(); }
    function godFilterLeads() { godLeadsPage = 0; godLoadLeads(); }
    function godLeadsPagePrev() { if (godLeadsPage > 0) { godLeadsPage--; godLoadLeads(); } }
    function godLeadsPageNext() { godLeadsPage++; godLoadLeads(); }

    async function godEditLead(leadId) {
      const newStatus = prompt('Enter new status (new, contacted, qualified, converted, lost):');
      if (newStatus && ['new', 'contacted', 'qualified', 'converted', 'lost'].includes(newStatus)) {
        const { error } = await supabaseClient.from('leads').update({ status: newStatus }).eq('id', leadId);
        if (error) showToast('Failed to update lead', 'error');
        else { showToast('Lead status updated', 'success'); godLoadLeads(); }
      }
    }

    // Pro Users Management
    async function godLoadProUsers() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-pro-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('god-pro-filter')?.value || 'all';

        // Query sg_users with pro/premium subscription
        let query = supabaseClient.from('sg_users').select('*', { count: 'exact' }).in('subscription_status', ['active', 'trialing', 'cancelled']);

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,full_name.ilike.%${searchTerm}%`);
        }
        if (filter === 'active') query = query.eq('subscription_status', 'active');
        if (filter === 'cancelled') query = query.eq('subscription_status', 'cancelled');
        if (filter === 'trial') query = query.eq('subscription_status', 'trialing');

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godProPage * godTabPageSize, (godProPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-pro').textContent = count || 0;
        document.getElementById('god-pro-count').textContent = `Showing ${data?.length || 0} of ${count || 0} pro users`;

        const tbody = document.getElementById('god-pro-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No pro users found</td></tr>';
          return;
        }

        const statusColors = {
          'active': { bg: 'rgba(16, 185, 129, 0.2)', color: 'var(--success)' },
          'trialing': { bg: 'rgba(59, 130, 246, 0.2)', color: 'var(--info)' },
          'cancelled': { bg: 'rgba(239, 68, 68, 0.2)', color: 'var(--error)' }
        };

        tbody.innerHTML = data.map(u => {
          const sc = statusColors[u.subscription_status] || statusColors['active'];
          return `
            <tr style="border-bottom: 1px solid var(--border-subtle);">
              <td style="padding: 12px 16px;">
                <div style="font-weight: 500;">${escapeHtml(u.full_name || u.email)}</div>
                <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(u.email || '')}</div>
              </td>
              <td style="padding: 12px 16px;"><span style="background: var(--accent); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">PRO</span></td>
              <td style="padding: 12px 16px;"><span style="background: ${sc.bg}; color: ${sc.color}; padding: 4px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${u.subscription_status || 'active'}</span></td>
              <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${u.created_at ? new Date(u.created_at).toLocaleDateString() : '-'}</td>
              <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${u.subscription_end_date ? new Date(u.subscription_end_date).toLocaleDateString() : '-'}</td>
              <td style="padding: 12px 16px; text-align: center;">
                <button class="btn-modern secondary" onclick="godViewUnifiedProfile('${escapeHtml(u.email)}')" style="padding: 6px 12px; font-size: 12px;">Profile</button>
              </td>
            </tr>
          `;
        }).join('');

        document.getElementById('god-pro-prev').disabled = godProPage === 0;
        document.getElementById('god-pro-next').disabled = (godProPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading pro users:', error);
        document.getElementById('god-pro-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading pro users</td></tr>';
      }
    }

    function godSearchProUsers() { godProPage = 0; godLoadProUsers(); }
    function godFilterProUsers() { godProPage = 0; godLoadProUsers(); }
    function godProPagePrev() { if (godProPage > 0) { godProPage--; godLoadProUsers(); } }
    function godProPageNext() { godProPage++; godLoadProUsers(); }

    // Collaborators Management
    async function godLoadCollaborators() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-collaborators-search')?.value?.toLowerCase() || '';
        const filter = document.getElementById('god-collaborators-filter')?.value || 'all';

        // Query sg_users with contractor role
        let query = supabaseClient.from('sg_users').select('*', { count: 'exact' }).eq('account_type', 'contractor');

        if (searchTerm) {
          query = query.or(`email.ilike.%${searchTerm}%,full_name.ilike.%${searchTerm}%,company_name.ilike.%${searchTerm}%`);
        }

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godCollaboratorsPage * godTabPageSize, (godCollaboratorsPage + 1) * godTabPageSize - 1);

        if (error) throw error;

        document.getElementById('god-users-collaborators').textContent = count || 0;
        document.getElementById('god-collaborators-count').textContent = `Showing ${data?.length || 0} of ${count || 0} collaborators`;

        const tbody = document.getElementById('god-collaborators-table-body');
        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--text-muted);">No collaborators found</td></tr>';
          return;
        }

        tbody.innerHTML = data.map(c => `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <div style="font-weight: 500;">${escapeHtml(c.full_name || c.email)}</div>
              <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(c.email || '')}</div>
            </td>
            <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(c.company_name || '-')}</td>
            <td style="padding: 12px 16px; font-size: 13px;">${escapeHtml(c.specialty || 'General')}</td>
            <td style="padding: 12px 16px;"><span style="background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 4px 8px; border-radius: 4px; font-size: 11px;">Active</span></td>
            <td style="padding: 12px 16px; font-weight: 500; color: var(--accent);">-</td>
            <td style="padding: 12px 16px; text-align: center;">
              <button class="btn-modern secondary" onclick="godViewUnifiedProfile('${escapeHtml(c.email)}')" style="padding: 6px 12px; font-size: 12px;">Profile</button>
            </td>
          </tr>
        `).join('');

        document.getElementById('god-collaborators-prev').disabled = godCollaboratorsPage === 0;
        document.getElementById('god-collaborators-next').disabled = (godCollaboratorsPage + 1) * godTabPageSize >= count;

      } catch (error) {
        console.error('Error loading collaborators:', error);
        document.getElementById('god-collaborators-table-body').innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: var(--error);">Error loading collaborators</td></tr>';
      }
    }

    function godSearchCollaborators() { godCollaboratorsPage = 0; godLoadCollaborators(); }
    function godFilterCollaborators() { godCollaboratorsPage = 0; godLoadCollaborators(); }
    function godCollaboratorsPagePrev() { if (godCollaboratorsPage > 0) { godCollaboratorsPage--; godLoadCollaborators(); } }
    function godCollaboratorsPageNext() { godCollaboratorsPage++; godLoadCollaborators(); }

    // Unified Customer Profile Modal
    async function godViewUnifiedProfile(email) {
      if (!email) return;

      showToast('Loading profile...', 'info');

      try {
        // Fetch from all sources - handle errors gracefully
        const safeQuery = async (query) => {
          try { return await query; } catch (e) { return { data: null }; }
        };

        const [sgUser, shopifyCustomer, shopifyOrders, leads] = await Promise.all([
          safeQuery(supabaseClient.from('sg_users').select('*').eq('email', email).single()),
          safeQuery(supabaseClient.from('shopify_customers').select('*').eq('email', email).single()),
          safeQuery(supabaseClient.from('shopify_orders').select('*').eq('email', email).order('created_at', { ascending: false }).limit(5)),
          safeQuery(supabaseClient.from('leads').select('*').eq('email', email))
        ]);

        const profile = {
          sgUser: sgUser.data,
          shopifyCustomer: shopifyCustomer.data,
          shopifyOrders: shopifyOrders.data || [],
          leads: leads.data || []
        };

        // Build modal content
        let modalHtml = `
          <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">
            <div style="background: var(--surface-primary); border-radius: 16px; max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;" onclick="event.stopPropagation()">
              <div style="padding: 24px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h2 style="margin: 0; font-size: 20px;">Unified Customer Profile</h2>
                  <p style="margin: 4px 0 0; color: var(--text-muted);">${escapeHtml(email)}</p>
                </div>
                <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px;">&times;</button>
              </div>
              <div style="padding: 24px;">
        `;

        // SG User Section
        if (profile.sgUser) {
          modalHtml += `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                <span style="background: #a855f7; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px;">SG USER</span>
                Account Details
              </h3>
              <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                  <div><span style="color: var(--text-muted); font-size: 12px;">Name</span><div style="font-weight: 500;">${escapeHtml(profile.sgUser.full_name || '-')}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Role</span><div><span style="background: rgba(168, 85, 247, 0.2); color: #a855f7; padding: 2px 8px; border-radius: 4px; font-size: 12px;">${profile.sgUser.account_type || 'homeowner'}</span></div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Subscription</span><div style="color: ${profile.sgUser.subscription_status === 'active' ? 'var(--success)' : 'var(--text-muted)'}">${profile.sgUser.subscription_status || 'none'}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Created</span><div>${profile.sgUser.created_at ? new Date(profile.sgUser.created_at).toLocaleDateString() : '-'}</div></div>
                </div>
              </div>
            </div>
          `;
        }

        // Shopify Section
        if (profile.shopifyCustomer) {
          modalHtml += `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                <span style="background: #96bf48; color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px;">SHOPIFY</span>
                Customer Data
              </h3>
              <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
                  <div><span style="color: var(--text-muted); font-size: 12px;">Orders</span><div style="font-weight: 600; color: var(--accent);">${profile.shopifyCustomer.orders_count || 0}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Total Spent</span><div style="font-weight: 600; color: var(--success);">$${parseFloat(profile.shopifyCustomer.total_spent || 0).toFixed(2)}</div></div>
                  <div><span style="color: var(--text-muted); font-size: 12px;">Marketing</span><div>${profile.shopifyCustomer.accepts_marketing ? '✓ Opted-in' : 'Not opted-in'}</div></div>
                </div>
                ${profile.shopifyOrders.length > 0 ? `
                  <div style="border-top: 1px solid var(--border-subtle); padding-top: 12px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Recent Orders</div>
                    ${profile.shopifyOrders.slice(0, 3).map(o => `
                      <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                        <span style="font-size: 13px;">${o.name || o.id}</span>
                        <span style="font-weight: 500; color: var(--success);">$${parseFloat(o.total_price || 0).toFixed(2)}</span>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        // Leads Section
        if (profile.leads.length > 0) {
          modalHtml += `
            <div style="margin-bottom: 24px;">
              <h3 style="margin: 0 0 12px; font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
                <span style="background: var(--warning); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 11px;">LEADS</span>
                Lead History (${profile.leads.length})
              </h3>
              <div style="background: rgba(255,255,255,0.03); border-radius: 8px; padding: 16px;">
                ${profile.leads.map(l => `
                  <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-subtle);">
                    <div>
                      <div style="font-size: 13px;">${l.source || 'Direct'}</div>
                      <div style="font-size: 11px; color: var(--text-muted);">${l.created_at ? new Date(l.created_at).toLocaleDateString() : ''}</div>
                    </div>
                    <span style="background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${l.status || 'new'}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }

        // No data found
        if (!profile.sgUser && !profile.shopifyCustomer && profile.leads.length === 0) {
          modalHtml += `<div style="padding: 40px; text-align: center; color: var(--text-muted);">No data found for this email</div>`;
        }

        modalHtml += `
              </div>
              <div style="padding: 16px 24px; border-top: 1px solid var(--border-subtle); display: flex; justify-content: flex-end; gap: 12px;">
                <button class="btn-modern secondary" onclick="this.closest('[style*=\"position: fixed\"]').remove()">Close</button>
              </div>
            </div>
          </div>
        `;

        // Insert modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);

      } catch (error) {
        console.error('Error loading unified profile:', error);
        showToast('Failed to load profile', 'error');
      }
    }

    // GOD MODE Marketplace
    async function godRefreshMarketplace() {
      if (!isGodMode()) return;
      try {
        // Load distributors
        const { data: distributors, count: distCount } = await supabaseClient.from('distributor_profiles').select('*', { count: 'exact' });
        document.getElementById('god-mp-distributors').textContent = distCount || 0;

        // Load listings count (stone_listings is the active table)
        const { count: listingsCount } = await supabaseClient.from('stone_listings').select('*', { count: 'exact', head: true }).eq('status', 'active');
        document.getElementById('god-mp-listings').textContent = listingsCount || 0;

        // Load slabs count (use stone_listings as inventory source)
        const { count: slabsCount } = await supabaseClient.from('stone_listings').select('*', { count: 'exact', head: true });
        document.getElementById('god-mp-slabs').textContent = slabsCount || 0;

        // Load inquiries (use listing_inquiries if it exists)
        let inquiriesCount = 0;
        try {
          const { count } = await supabaseClient.from('listing_inquiries').select('*', { count: 'exact', head: true }).eq('status', 'pending');
          inquiriesCount = count || 0;
        } catch { /* table may not exist yet */ }
        document.getElementById('god-mp-inquiries').textContent = inquiriesCount;

        // Render distributors list
        const distList = document.getElementById('god-distributors-list');
        if (distList && distributors) {
          distList.innerHTML = distributors.map(d => `
            <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="font-weight: 500;">${escapeHtml(d.company_name || 'Unnamed')}</div>
                <div style="font-size: 13px; color: var(--text-muted);">${escapeHtml(d.contact_email || '')} | ${escapeHtml(d.city || '')}, ${escapeHtml(d.state || '')}</div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="badge" style="background: ${d.subscription_status === 'active' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; color: ${d.subscription_status === 'active' ? 'var(--success)' : 'var(--error)'}; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${d.subscription_status || 'inactive'}</span>
                <button class="btn-modern secondary" onclick="godViewDistributor('${d.id}')" style="padding: 6px 12px; font-size: 12px;">View</button>
              </div>
            </div>
          `).join('') || '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No distributors found</div>';
        }

      } catch (error) {
        console.error('GOD MODE marketplace error:', error);
      }
    }

    function godShowMarketplaceTab(tab) {
      document.querySelectorAll('.god-mp-tab').forEach(el => el.style.display = 'none');
      document.querySelectorAll('.tabs-modern .tab-modern').forEach(el => el.classList.remove('active'));
      document.getElementById(`god-mp-tab-${tab}`).style.display = 'block';
      event.target.classList.add('active');
    }

    function godSearchDistributors(query) {
      // Filter distributors by search query
    }

    function godViewDistributor(id) {
      showToast('Distributor details coming soon', 'info');
    }

    // GOD MODE Database
    async function loadGodDatabaseStats() {
      if (!isGodMode()) return;
      try {
        const tables = ['sg_users', 'customers', 'jobs', 'leads', 'estimates', 'shopify_products', 'shopify_orders', 'distributor_profiles'];
        let totalRows = 0;
        for (const table of tables) {
          try {
            const { count } = await supabaseClient.from(table).select('*', { count: 'exact', head: true });
            totalRows += count || 0;
          } catch {}
        }
        document.getElementById('god-db-tables').textContent = tables.length;
        document.getElementById('god-db-rows').textContent = totalRows.toLocaleString();
        document.getElementById('god-db-size').textContent = 'N/A';
      } catch {}
    }

    async function godRunSqlQuery() {
      if (!isGodMode()) return;
      const query = document.getElementById('god-sql-query')?.value;
      if (!query) return;

      try {
        // For safety, we'll use Supabase's RPC or direct table queries
        // This simulates SQL execution
        showToast('Executing query...', 'info');

        // Parse simple SELECT queries
        const selectMatch = query.match(/SELECT\s+\*\s+FROM\s+(\w+)/i);
        if (selectMatch) {
          const table = selectMatch[1];
          const limitMatch = query.match(/LIMIT\s+(\d+)/i);
          const limit = limitMatch ? parseInt(limitMatch[1]) : 100;

          const { data, error } = await supabaseClient.from(table).select('*').limit(limit);
          if (error) throw error;

          const resultsEl = document.getElementById('god-sql-results');
          const preEl = resultsEl.querySelector('pre');
          resultsEl.style.display = 'block';
          preEl.textContent = JSON.stringify(data, null, 2);
          showToast(`Query returned ${data.length} rows`, 'success');
        } else {
          showToast('Only SELECT queries supported in browser', 'warning');
        }
      } catch (e) {
        showToast('Query error: ' + e.message, 'error');
      }
    }

    function godClearQueryResults() {
      const resultsEl = document.getElementById('god-sql-results');
      if (resultsEl) {
        resultsEl.style.display = 'none';
        resultsEl.querySelector('pre').textContent = '';
      }
    }

    function godLoadSqlPreset(preset) {
      const presets = {
        users: 'SELECT * FROM sg_users LIMIT 100',
        admins: 'SELECT * FROM sg_users WHERE account_type = \'admin\'',
        distributors: 'SELECT * FROM distributor_profiles LIMIT 100',
        recent_orders: 'SELECT * FROM shopify_orders ORDER BY created_at DESC LIMIT 50',
        active_subs: 'SELECT * FROM sg_users WHERE subscription_status = \'active\'',
        table_sizes: '-- Table sizes not available via browser'
      };
      if (presets[preset]) {
        document.getElementById('god-sql-query').value = presets[preset];
      }
    }

    async function godBrowseTable(table) {
      if (!isGodMode() || !table) return;
      try {
        const { data, error } = await supabaseClient.from(table).select('*').limit(50);
        if (error) throw error;

        const browser = document.getElementById('god-table-browser');
        if (!data || data.length === 0) {
          browser.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">Table is empty</div>';
          return;
        }

        const columns = Object.keys(data[0]);
        browser.innerHTML = `
          <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
            <thead><tr style="background: rgba(255,255,255,0.03);">${columns.map(c => `<th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border-subtle); white-space: nowrap;">${escapeHtml(c)}</th>`).join('')}</tr></thead>
            <tbody>${data.map(row => `<tr>${columns.map(c => `<td style="padding: 8px; border-bottom: 1px solid var(--border-subtle); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(String(row[c] ?? ''))}</td>`).join('')}</tr>`).join('')}</tbody>
          </table>
        `;
      } catch (e) {
        document.getElementById('god-table-browser').innerHTML = `<div style="padding: 20px; color: var(--error);">Error: ${escapeHtml(e.message)}</div>`;
      }
    }

    // GOD MODE API Tester
    function initGodApiTester() {
      document.getElementById('god-api-endpoint').value = '/api/stripe-status';
    }

    async function godTestApiEndpoint() {
      if (!isGodMode()) return;
      const method = document.getElementById('god-api-method').value;
      const endpoint = document.getElementById('god-api-endpoint').value;
      const body = document.getElementById('god-api-body').value;
      const includeAuth = document.getElementById('god-api-auth').checked;

      if (!endpoint) { showToast('Enter an endpoint', 'warning'); return; }

      const startTime = Date.now();
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (includeAuth && supabaseClient) {
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session?.access_token) {
            headers['Authorization'] = `Bearer ${session.access_token}`;
          }
        }

        const options = { method, headers };
        if (['POST', 'PATCH', 'PUT'].includes(method) && body) {
          options.body = body;
        }

        const fullUrl = endpoint.startsWith('http') ? endpoint : `${API_BASE}${endpoint}`;
        const response = await fetch(fullUrl, options);
        const elapsed = Date.now() - startTime;

        let responseData;
        const contentType = response.headers.get('content-type');
        if (contentType?.includes('application/json')) {
          responseData = await response.json();
        } else {
          responseData = await response.text();
        }

        // Display results
        document.getElementById('god-api-response').style.display = 'block';
        const statusEl = document.getElementById('god-api-status-code');
        statusEl.textContent = response.status;
        statusEl.style.background = response.ok ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
        statusEl.style.color = response.ok ? 'var(--success)' : 'var(--error)';
        document.getElementById('god-api-time').textContent = `${elapsed}ms`;
        document.getElementById('god-api-response-body').textContent = typeof responseData === 'object' ? JSON.stringify(responseData, null, 2) : responseData;

      } catch (e) {
        document.getElementById('god-api-response').style.display = 'block';
        document.getElementById('god-api-status-code').textContent = 'ERR';
        document.getElementById('god-api-status-code').style.background = 'rgba(239, 68, 68, 0.2)';
        document.getElementById('god-api-status-code').style.color = 'var(--error)';
        document.getElementById('god-api-time').textContent = '-';
        document.getElementById('god-api-response-body').textContent = e.message;
      }
    }

    function godLoadApiPreset(preset) {
      const presets = {
        health: { method: 'GET', endpoint: '/api/stripe-status', body: '' },
        users: { method: 'GET', endpoint: '/api/customers-list', body: '' },
        products: { method: 'GET', endpoint: '/api/products', body: '' },
        orders: { method: 'GET', endpoint: '/api/orders', body: '' },
        stripe: { method: 'GET', endpoint: '/api/stripe-status', body: '' },
        distributors: { method: 'GET', endpoint: '/api/marketplace/stone-yards', body: '' }
      };
      if (presets[preset]) {
        document.getElementById('god-api-method').value = presets[preset].method;
        document.getElementById('god-api-endpoint').value = presets[preset].endpoint;
        document.getElementById('god-api-body').value = presets[preset].body;
      }
    }

    // GOD MODE Logs
    async function godRefreshLogs() {
      if (!isGodMode()) return;
      try {
        // Try to load from audit logs table
        const { data: logs } = await supabaseClient
          .from('auth_audit_logs')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(100);

        godModeLogs = logs || [];
        renderGodLogs();
      } catch (e) {
        // Generate mock logs if table doesn't exist
        godModeLogs = [
          { created_at: new Date().toISOString(), event_type: 'login', event_status: 'success', details: { email: currentUser?.email }, ip_address: '127.0.0.1' },
          { created_at: new Date(Date.now() - 60000).toISOString(), event_type: 'api_request', event_status: 'success', details: { endpoint: '/api/products' }, ip_address: '127.0.0.1' }
        ];
        renderGodLogs();
      }
    }

    function renderGodLogs() {
      const container = document.getElementById('god-logs-container');
      if (!container) return;

      if (!godModeLogs.length) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No logs available</div>';
        return;
      }

      container.innerHTML = godModeLogs.map(log => {
        const statusColor = log.event_status === 'success' ? 'var(--success)' : log.event_status === 'failed' ? 'var(--error)' : 'var(--warning)';
        return `
          <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; gap: 16px; align-items: flex-start;">
            <span style="color: var(--text-muted); white-space: nowrap;">${new Date(log.created_at).toLocaleString()}</span>
            <span style="color: ${statusColor}; min-width: 70px;">[${log.event_status || 'INFO'}]</span>
            <span style="color: var(--accent); min-width: 100px;">${log.event_type || 'event'}</span>
            <span style="color: var(--text-secondary); flex: 1;">${JSON.stringify(log.details || {})}</span>
            <span style="color: var(--text-muted);">${log.ip_address || ''}</span>
          </div>
        `;
      }).join('');
    }

    function godFilterLogs() { renderGodLogs(); }
    function godSearchLogs() { renderGodLogs(); }
    function godExportLogs() {
      if (!isGodMode() || !godModeLogs.length) return;
      const blob = new Blob([JSON.stringify(godModeLogs, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'system-logs.json';
      a.click();
    }

    // ==================== ANALYTICS FUNCTIONS ====================

    let godAnalyticsData = { visitors: 0, pageviews: 0, sessions: 0, bounce: 0, duration: 0, conversions: 0 };

    async function godLoadAnalytics() {
      if (!isGodMode()) return;

      const range = document.getElementById('god-analytics-range')?.value || 30;

      // Check for saved GA token and update status
      const savedToken = localStorage.getItem('ga_access_token');
      if (savedToken) {
        gaAccessToken = savedToken;
        updateGAStatus(true);
        // Load GA data
        await godLoadGAData();
      } else {
        updateGAStatus(false);
      }

      // Load local analytics data
      try {
        // Get user activity from database
        const { data: activity, error } = await supabaseClient
          .from('customer_activity_log')
          .select('*')
          .gte('created_at', new Date(Date.now() - range * 24 * 60 * 60 * 1000).toISOString())
          .order('created_at', { ascending: false })
          .limit(1000);

        if (!error && activity) {
          // Calculate stats
          const uniqueUsers = new Set(activity.map(a => a.customer_user_id || a.customer_email)).size;
          const pageViews = activity.filter(a => a.activity_type === 'page_view').length;

          document.getElementById('god-analytics-visitors').textContent = uniqueUsers.toLocaleString();
          document.getElementById('god-analytics-pageviews').textContent = pageViews.toLocaleString();
          document.getElementById('god-analytics-sessions').textContent = Math.round(pageViews / 3).toLocaleString();

          // Render user activity table
          renderGodUserActivity(activity);
        }

        // Get sg_users stats
        const { count: totalUsers } = await supabaseClient.from('sg_users').select('*', { count: 'exact', head: true });
        const { count: activeUsers } = await supabaseClient
          .from('sg_users')
          .select('*', { count: 'exact', head: true })
          .gte('updated_at', new Date(Date.now() - range * 24 * 60 * 60 * 1000).toISOString());

        document.getElementById('god-analytics-conversions').textContent = (activeUsers || 0).toLocaleString();

        // Placeholder for bounce rate and duration (would need GA integration)
        document.getElementById('god-analytics-bounce').textContent = '-';
        document.getElementById('god-analytics-duration').textContent = '-';

        // Load top pages
        await godLoadTopPages();
        // Load traffic sources
        await godLoadTrafficSources();

      } catch (error) {
        console.error('Analytics load error:', error);
        showToast('Failed to load analytics', 'error');
      }
    }

    function renderGodUserActivity(activity) {
      const container = document.getElementById('god-user-activity');
      if (!container || !activity.length) {
        if (container) container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No activity recorded</div>';
        return;
      }

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Time</th>
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">User</th>
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Activity</th>
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Page</th>
            </tr>
          </thead>
          <tbody>
            ${activity.slice(0, 100).map(a => `
              <tr style="border-bottom: 1px solid var(--border-subtle);">
                <td style="padding: 10px 16px; font-size: 12px; color: var(--text-muted);">${new Date(a.created_at).toLocaleString()}</td>
                <td style="padding: 10px 16px; font-size: 13px;">${escapeHtml(a.customer_email || a.customer_user_id?.substring(0,8) || 'Anonymous')}</td>
                <td style="padding: 10px 16px;"><span class="badge" style="background: rgba(139, 92, 246, 0.2); color: #a855f7; padding: 3px 8px; border-radius: 4px; font-size: 11px;">${escapeHtml(a.activity_type || 'view')}</span></td>
                <td style="padding: 10px 16px; font-size: 12px; color: var(--text-secondary); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(a.page_url || '-')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function godLoadTopPages() {
      const container = document.getElementById('god-top-pages');
      if (!container) return;

      // Sample top pages data (would need actual analytics)
      const topPages = [
        { path: '/', views: 12450, title: 'Home' },
        { path: '/countertops/', views: 8234, title: 'Countertops' },
        { path: '/account/', views: 5621, title: 'Account Portal' },
        { path: '/get-a-free-estimate/', views: 4532, title: 'Free Estimate' },
        { path: '/shop/', views: 3421, title: 'Shop' },
        { path: '/vendors/msi-quartz/', views: 2845, title: 'MSI Quartz' },
        { path: '/virtual-designer/', views: 2156, title: 'Virtual Designer' },
        { path: '/collaborators/', views: 1923, title: 'Find Collaborators' }
      ];

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Page</th>
              <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Views</th>
            </tr>
          </thead>
          <tbody>
            ${topPages.map((p, i) => `
              <tr style="border-bottom: 1px solid var(--border-subtle);">
                <td style="padding: 12px 16px;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="width: 24px; height: 24px; border-radius: 4px; background: rgba(139, 92, 246, 0.2); color: #a855f7; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${i + 1}</span>
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(p.title)}</div>
                      <div style="font-size: 12px; color: var(--text-muted);">${escapeHtml(p.path)}</div>
                    </div>
                  </div>
                </td>
                <td style="padding: 12px 16px; text-align: right; font-weight: 600;">${p.views.toLocaleString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function godLoadTrafficSources() {
      const container = document.getElementById('god-traffic-sources');
      if (!container) return;

      // Sample traffic sources (would need actual analytics)
      const sources = [
        { source: 'Google', medium: 'organic', sessions: 8450, percent: 45 },
        { source: 'Direct', medium: 'none', sessions: 4230, percent: 22 },
        { source: 'Facebook', medium: 'social', sessions: 2840, percent: 15 },
        { source: 'Bing', medium: 'organic', sessions: 1520, percent: 8 },
        { source: 'Google', medium: 'cpc', sessions: 980, percent: 5 },
        { source: 'Instagram', medium: 'social', sessions: 560, percent: 3 },
        { source: 'Yelp', medium: 'referral', sessions: 380, percent: 2 }
      ];

      container.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
              <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Source / Medium</th>
              <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Sessions</th>
              <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">%</th>
            </tr>
          </thead>
          <tbody>
            ${sources.map(s => `
              <tr style="border-bottom: 1px solid var(--border-subtle);">
                <td style="padding: 12px 16px;">
                  <span style="font-weight: 500;">${escapeHtml(s.source)}</span>
                  <span style="color: var(--text-muted);"> / ${escapeHtml(s.medium)}</span>
                </td>
                <td style="padding: 12px 16px; text-align: right; font-weight: 500;">${s.sessions.toLocaleString()}</td>
                <td style="padding: 12px 16px; text-align: right;">
                  <div style="display: flex; align-items: center; justify-content: flex-end; gap: 8px;">
                    <div style="width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                      <div style="width: ${s.percent}%; height: 100%; background: var(--accent);"></div>
                    </div>
                    <span style="font-size: 12px; color: var(--text-muted); min-width: 30px;">${s.percent}%</span>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function godShowAnalyticsTab(tab) {
      document.querySelectorAll('.god-analytics-tab').forEach(t => t.style.display = 'none');
      document.querySelectorAll('#page-god-analytics .tab-modern').forEach(t => t.classList.remove('active'));

      const tabEl = document.getElementById(`god-analytics-tab-${tab}`);
      if (tabEl) tabEl.style.display = 'block';

      event.target.classList.add('active');
    }

    // Google Analytics OAuth and API Integration
    let gaAccessToken = null;
    let gaTokenClient = null;

    function godConnectGoogleAnalytics() {
      if (gaAccessToken) {
        // Already connected, refresh data
        godLoadGAData();
        return;
      }

      // Check if Google API is loaded
      if (typeof google === 'undefined' || !google.accounts) {
        showToast('Loading Google API...', 'info');
        loadGoogleAPI().then(() => initGoogleAuth());
        return;
      }

      initGoogleAuth();
    }

    function loadGoogleAPI() {
      return new Promise((resolve) => {
        if (document.getElementById('google-gsi-script')) {
          resolve();
          return;
        }
        const script = document.createElement('script');
        script.id = 'google-gsi-script';
        script.src = 'https://accounts.google.com/gsi/client';
        script.onload = resolve;
        document.head.appendChild(script);
      });
    }

    function initGoogleAuth() {
      const clientId = window.SG_CONFIG?.GOOGLE_CLIENT_ID || '46783393854-3bclu7oh0l6t6fem91mj9jj681aep4cs.apps.googleusercontent.com';

      gaTokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: [
          'https://www.googleapis.com/auth/analytics.readonly',
          'https://www.googleapis.com/auth/webmasters.readonly',
          'https://www.googleapis.com/auth/business.manage'
        ].join(' '),
        callback: (response) => {
          if (response.access_token) {
            gaAccessToken = response.access_token;
            localStorage.setItem('ga_access_token', gaAccessToken);
            updateGAStatus(true);
            showToast('Google Analytics connected!', 'success');
            godLoadGAData();
          } else {
            showToast('Failed to connect to Google Analytics', 'error');
          }
        },
      });

      // Check for existing token
      const savedToken = localStorage.getItem('ga_access_token');
      if (savedToken) {
        gaAccessToken = savedToken;
        updateGAStatus(true);
        godLoadGAData();
      } else {
        gaTokenClient.requestAccessToken();
      }
    }

    function updateGAStatus(connected) {
      const indicator = document.getElementById('god-ga-indicator');
      const text = document.getElementById('god-ga-text');
      const btn = document.getElementById('god-ga-connect-btn');

      if (connected) {
        indicator.style.background = 'var(--success)';
        text.textContent = 'GA4 Connected';
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M9 12l2 2 4-4"/></svg> Refresh GA4';
      } else {
        indicator.style.background = 'var(--warning)';
        text.textContent = 'GA4 Not Connected';
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Connect GA4';
      }
    }

    async function godLoadGAData() {
      if (!gaAccessToken) {
        return;
      }

      const propertyId = window.SG_CONFIG?.GOOGLE_ANALYTICS_PROPERTY || 'properties/495413683';
      const range = document.getElementById('god-analytics-range')?.value || 30;

      const startDate = new Date();
      startDate.setDate(startDate.getDate() - parseInt(range));
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = new Date().toISOString().split('T')[0];

      try {
        // Fetch main metrics
        const metricsResponse = await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gaAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dateRanges: [{ startDate: startDateStr, endDate: endDateStr }],
            metrics: [
              { name: 'activeUsers' },
              { name: 'screenPageViews' },
              { name: 'sessions' },
              { name: 'bounceRate' },
              { name: 'averageSessionDuration' },
              { name: 'conversions' }
            ]
          })
        });

        if (!metricsResponse.ok) {
          if (metricsResponse.status === 401) {
            // Token expired, clear and reconnect
            localStorage.removeItem('ga_access_token');
            gaAccessToken = null;
            updateGAStatus(false);
            showToast('GA4 session expired. Please reconnect.', 'warning');
            return;
          }
          throw new Error('Failed to fetch GA data');
        }

        const metricsData = await metricsResponse.json();
        const row = metricsData.rows?.[0]?.metricValues || [];

        // Update stats
        document.getElementById('god-analytics-visitors').textContent = parseInt(row[0]?.value || 0).toLocaleString();
        document.getElementById('god-analytics-pageviews').textContent = parseInt(row[1]?.value || 0).toLocaleString();
        document.getElementById('god-analytics-sessions').textContent = parseInt(row[2]?.value || 0).toLocaleString();
        document.getElementById('god-analytics-bounce').textContent = (parseFloat(row[3]?.value || 0) * 100).toFixed(1) + '%';

        const avgDuration = parseFloat(row[4]?.value || 0);
        const mins = Math.floor(avgDuration / 60);
        const secs = Math.round(avgDuration % 60);
        document.getElementById('god-analytics-duration').textContent = `${mins}m ${secs}s`;

        document.getElementById('god-analytics-conversions').textContent = parseInt(row[5]?.value || 0).toLocaleString();

        // Fetch top pages
        await godLoadGATopPages(propertyId, startDateStr, endDateStr);
        // Fetch traffic sources
        await godLoadGATrafficSources(propertyId, startDateStr, endDateStr);
        // Fetch Search Console data
        await godLoadSearchConsole();
        // Fetch Google Business data
        await godLoadGoogleBusiness();

        showToast('Analytics data updated from GA4', 'success');

      } catch (error) {
        console.error('GA Data API error:', error);
        showToast('Failed to load GA4 data: ' + error.message, 'error');
      }
    }

    async function godLoadGATopPages(propertyId, startDate, endDate) {
      try {
        const response = await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gaAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dateRanges: [{ startDate, endDate }],
            dimensions: [{ name: 'pagePath' }],
            metrics: [{ name: 'screenPageViews' }, { name: 'activeUsers' }],
            orderBys: [{ metric: { metricName: 'screenPageViews' }, desc: true }],
            limit: 10
          })
        });

        if (!response.ok) return;
        const data = await response.json();

        const container = document.getElementById('god-top-pages');
        if (container && data.rows) {
          container.innerHTML = data.rows.map((row, i) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-subtle);">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="width: 24px; height: 24px; background: rgba(168, 85, 247, 0.2); color: #a855f7; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${i + 1}</span>
                <span style="font-size: 13px; max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(row.dimensionValues[0].value)}</span>
              </div>
              <div style="display: flex; gap: 16px; align-items: center;">
                <span style="font-weight: 600; color: var(--accent);">${parseInt(row.metricValues[0].value).toLocaleString()} views</span>
                <span style="font-size: 12px; color: var(--text-muted);">${parseInt(row.metricValues[1].value).toLocaleString()} users</span>
              </div>
            </div>
          `).join('');
        }
      } catch (error) {
        console.error('Error loading top pages:', error);
      }
    }

    async function godLoadGATrafficSources(propertyId, startDate, endDate) {
      try {
        const response = await fetch(`https://analyticsdata.googleapis.com/v1beta/${propertyId}:runReport`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${gaAccessToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            dateRanges: [{ startDate, endDate }],
            dimensions: [{ name: 'sessionDefaultChannelGroup' }],
            metrics: [{ name: 'sessions' }, { name: 'activeUsers' }],
            orderBys: [{ metric: { metricName: 'sessions' }, desc: true }],
            limit: 8
          })
        });

        if (!response.ok) return;
        const data = await response.json();

        const container = document.getElementById('god-traffic-sources');
        if (container && data.rows) {
          const total = data.rows.reduce((sum, row) => sum + parseInt(row.metricValues[0].value), 0);
          const colors = ['#a855f7', '#f9cb00', '#10b981', '#3b82f6', '#ef4444', '#f97316', '#06b6d4', '#8b5cf6'];

          container.innerHTML = data.rows.map((row, i) => {
            const sessions = parseInt(row.metricValues[0].value);
            const pct = ((sessions / total) * 100).toFixed(1);
            return `
              <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                  <span style="font-size: 13px; font-weight: 500;">${escapeHtml(row.dimensionValues[0].value)}</span>
                  <span style="font-size: 13px; color: var(--text-muted);">${sessions.toLocaleString()} (${pct}%)</span>
                </div>
                <div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                  <div style="height: 100%; width: ${pct}%; background: ${colors[i % colors.length]}; border-radius: 4px;"></div>
                </div>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading traffic sources:', error);
      }
    }

    function godDisconnectGA() {
      localStorage.removeItem('ga_access_token');
      gaAccessToken = null;
      updateGAStatus(false);
      showToast('Disconnected from Google Analytics', 'info');
    }

    // Google Search Console API
    async function godLoadSearchConsole() {
      if (!gaAccessToken) {
        showToast('Please connect Google first', 'warning');
        return;
      }

      // Try different URL formats - Search Console can be verified different ways
      const siteUrls = [
        'https://www.surprisegranite.com/',
        'https://surprisegranite.com/',
        'sc-domain:surprisegranite.com'
      ];
      const range = document.getElementById('god-analytics-range')?.value || 30;
      const startDate = new Date();
      startDate.setDate(startDate.getDate() - parseInt(range));
      const startDateStr = startDate.toISOString().split('T')[0];
      const endDateStr = new Date().toISOString().split('T')[0];

      let data = null;
      let successUrl = null;

      // Try each URL format until one works
      for (const siteUrl of siteUrls) {
        try {
          const response = await fetch(`https://www.googleapis.com/webmasters/v3/sites/${encodeURIComponent(siteUrl)}/searchAnalytics/query`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${gaAccessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              startDate: startDateStr,
              endDate: endDateStr,
              dimensions: ['query'],
              rowLimit: 20
            })
          });

          if (response.ok) {
            data = await response.json();
            successUrl = siteUrl;
            console.log('Search Console connected with:', siteUrl);
            break;
          }
        } catch (e) {
          console.log('Search Console URL failed:', siteUrl);
        }
      }

      if (!data) {
        document.getElementById('god-gsc-queries').innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <p style="color: var(--warning); margin-bottom: 16px;">Search Console access not configured</p>
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Make sure your site is verified in Search Console with the same Google account</p>
            <a href="https://search.google.com/search-console" target="_blank" class="btn-modern secondary">Open Search Console</a>
          </div>
        `;
        return;
      }

      try {

        // Update summary stats
        let totalClicks = 0, totalImpressions = 0, totalCtr = 0, totalPosition = 0;
        if (data.rows) {
          data.rows.forEach(row => {
            totalClicks += row.clicks || 0;
            totalImpressions += row.impressions || 0;
            totalPosition += row.position || 0;
          });
          totalCtr = totalImpressions > 0 ? (totalClicks / totalImpressions * 100) : 0;
        }

        document.getElementById('god-gsc-clicks').textContent = totalClicks.toLocaleString();
        document.getElementById('god-gsc-impressions').textContent = totalImpressions.toLocaleString();
        document.getElementById('god-gsc-ctr').textContent = totalCtr.toFixed(1) + '%';
        document.getElementById('god-gsc-position').textContent = data.rows?.length > 0 ? (totalPosition / data.rows.length).toFixed(1) : '-';

        // Render queries
        const container = document.getElementById('god-gsc-queries');
        if (data.rows && data.rows.length > 0) {
          container.innerHTML = `
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border-subtle);">
                  <th style="padding: 12px 16px; text-align: left; font-size: 12px; color: var(--text-muted);">Query</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Clicks</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Impressions</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">CTR</th>
                  <th style="padding: 12px 16px; text-align: right; font-size: 12px; color: var(--text-muted);">Position</th>
                </tr>
              </thead>
              <tbody>
                ${data.rows.map(row => `
                  <tr style="border-bottom: 1px solid var(--border-subtle);">
                    <td style="padding: 10px 16px; font-size: 13px;">${escapeHtml(row.keys[0])}</td>
                    <td style="padding: 10px 16px; text-align: right; font-weight: 600; color: var(--accent);">${row.clicks}</td>
                    <td style="padding: 10px 16px; text-align: right; color: var(--text-muted);">${row.impressions.toLocaleString()}</td>
                    <td style="padding: 10px 16px; text-align: right; color: var(--success);">${(row.ctr * 100).toFixed(1)}%</td>
                    <td style="padding: 10px 16px; text-align: right;">${row.position.toFixed(1)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No search data found for this period</div>';
        }

      } catch (error) {
        console.error('Search Console error:', error);
        document.getElementById('god-gsc-queries').innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--error);">Failed to load Search Console data</div>
        `;
      }
    }

    // Google Business Profile API
    async function godLoadGoogleBusiness() {
      if (!gaAccessToken) {
        showToast('Please connect Google first', 'warning');
        return;
      }

      try {
        // First, get the list of accounts
        const accountsResponse = await fetch('https://mybusinessaccountmanagement.googleapis.com/v1/accounts', {
          headers: { 'Authorization': `Bearer ${gaAccessToken}` }
        });

        if (!accountsResponse.ok) {
          if (accountsResponse.status === 403) {
            document.getElementById('god-gmb-reviews').innerHTML = `
              <div style="padding: 40px; text-align: center;">
                <p style="color: var(--warning); margin-bottom: 16px;">Google Business Profile access not configured</p>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Enable the Business Profile API in Google Cloud Console</p>
                <a href="https://console.cloud.google.com/apis/library/mybusinessaccountmanagement.googleapis.com" target="_blank" class="btn-modern secondary">Enable API</a>
              </div>
            `;
            return;
          }
          throw new Error('Failed to fetch Business Profile');
        }

        const accountsData = await accountsResponse.json();

        if (!accountsData.accounts || accountsData.accounts.length === 0) {
          document.getElementById('god-gmb-reviews').innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No Google Business Profile found</div>';
          return;
        }

        const accountName = accountsData.accounts[0].name;

        // Get locations
        const locationsResponse = await fetch(`https://mybusinessbusinessinformation.googleapis.com/v1/${accountName}/locations`, {
          headers: { 'Authorization': `Bearer ${gaAccessToken}` }
        });

        if (locationsResponse.ok) {
          const locationsData = await locationsResponse.json();

          if (locationsData.locations && locationsData.locations.length > 0) {
            const locationName = locationsData.locations[0].name;

            // Get reviews
            const reviewsResponse = await fetch(`https://mybusiness.googleapis.com/v4/${locationName}/reviews`, {
              headers: { 'Authorization': `Bearer ${gaAccessToken}` }
            });

            if (reviewsResponse.ok) {
              const reviewsData = await reviewsResponse.json();
              renderGMBReviews(reviewsData.reviews || []);
            }
          }
        }

        // Update with placeholder metrics for now (actual metrics require specific API calls)
        document.getElementById('god-gmb-actions').innerHTML = `
          <div style="display: grid; gap: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
              <span>Website Clicks</span>
              <span style="font-weight: 600; color: var(--accent);">View in GMB</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
              <span>Photo Views</span>
              <span style="font-weight: 600; color: var(--info);">View in GMB</span>
            </div>
            <a href="https://business.google.com" target="_blank" class="btn-modern primary" style="margin-top: 12px; justify-content: center;">Open Google Business Profile</a>
          </div>
        `;

      } catch (error) {
        console.error('Google Business error:', error);
        document.getElementById('god-gmb-reviews').innerHTML = `
          <div style="padding: 40px; text-align: center; color: var(--error);">Failed to load Google Business data</div>
        `;
      }
    }

    function renderGMBReviews(reviews) {
      const container = document.getElementById('god-gmb-reviews');

      if (!reviews || reviews.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No recent reviews</div>';
        return;
      }

      const starColors = { 'FIVE': '#fbbf24', 'FOUR': '#fbbf24', 'THREE': '#9ca3af', 'TWO': '#f87171', 'ONE': '#ef4444' };
      const starCounts = { 'FIVE': 5, 'FOUR': 4, 'THREE': 3, 'TWO': 2, 'ONE': 1 };

      container.innerHTML = reviews.slice(0, 10).map(review => `
        <div style="padding: 16px; border-bottom: 1px solid var(--border-subtle);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
            <div style="font-weight: 500;">${escapeHtml(review.reviewer?.displayName || 'Anonymous')}</div>
            <div style="color: ${starColors[review.starRating] || '#fbbf24'};">
              ${'★'.repeat(starCounts[review.starRating] || 5)}${'☆'.repeat(5 - (starCounts[review.starRating] || 5))}
            </div>
          </div>
          <p style="font-size: 13px; color: var(--text-secondary); margin: 0; line-height: 1.5;">${escapeHtml(review.comment || 'No comment')}</p>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">${new Date(review.createTime).toLocaleDateString()}</div>
        </div>
      `).join('');
    }

    function godExportUserActivity() {
      showToast('Exporting user activity...', 'info');
      // Implementation would export activity data to CSV
    }

    // ==================== SITE MANAGER FUNCTIONS ====================

    async function godLoadSiteManager() {
      if (!isGodMode()) return;

      // Update site stats
      document.getElementById('god-site-status').textContent = 'Online';
      document.getElementById('god-site-status').style.color = 'var(--success)';

      // Count pages (approximate based on sitemap)
      document.getElementById('god-site-pages').textContent = '~150';
      document.getElementById('god-site-images').textContent = '~500';
      document.getElementById('god-site-lighthouse').textContent = '85+';
    }

    function godClearSiteCache() {
      if (!confirm('Clear all browser caches? This will log you out.')) return;
      localStorage.clear();
      sessionStorage.clear();
      showToast('Cache cleared. Reloading...', 'success');
      setTimeout(() => location.reload(), 1500);
    }

    function godTriggerDeploy() {
      showToast('To trigger a deploy, push to main branch or use Netlify dashboard.', 'info');
      window.open('https://app.netlify.com/sites/surprise-granite-site/deploys', '_blank');
    }

    function godCheckSitemap() {
      window.open('/sitemap.xml', '_blank');
    }

    function godRunLighthouse() {
      const url = encodeURIComponent('https://surprisegranite.com');
      window.open(`https://pagespeed.web.dev/analysis?url=${url}`, '_blank');
    }

    // ==================== CONFIG FUNCTIONS ====================

    async function godLoadConfig() {
      if (!isGodMode()) return;

      // Set API URL
      const apiUrl = window.SG_CONFIG?.API_BASE_URL || 'Not configured';
      document.getElementById('god-config-api-url').textContent = apiUrl;

      // Load feature flags from localStorage
      document.getElementById('god-flag-maintenance').checked = localStorage.getItem('sg_maintenance') === 'true';
      document.getElementById('god-flag-debug').checked = localStorage.getItem('sg_debug') === 'true';
      document.getElementById('god-flag-beta').checked = localStorage.getItem('sg_beta') === 'true';
      document.getElementById('god-flag-ai').checked = localStorage.getItem('sg_ai') !== 'false';

      // Check integrations
      godCheckIntegrations();
    }

    async function godCheckIntegrations() {
      // Supabase check
      try {
        const { error } = await supabaseClient.from('sg_users').select('id').limit(1);
        document.getElementById('god-int-supabase').style.background = error ? 'var(--error)' : 'var(--success)';
      } catch {
        document.getElementById('god-int-supabase').style.background = 'var(--error)';
      }

      // Stripe check (via API)
      try {
        const res = await fetch(`${window.SG_CONFIG?.API_BASE_URL || ''}/api/health`);
        document.getElementById('god-int-stripe').style.background = res.ok ? 'var(--success)' : 'var(--warning)';
      } catch {
        document.getElementById('god-int-stripe').style.background = 'var(--warning)';
      }

      // GA check
      document.getElementById('god-int-ga').style.background = typeof gtag === 'function' ? 'var(--success)' : 'var(--warning)';

      // Shopify - check if products exist
      try {
        const { count } = await supabaseClient.from('shopify_products').select('*', { count: 'exact', head: true });
        document.getElementById('god-int-shopify').style.background = count > 0 ? 'var(--success)' : 'var(--warning)';
      } catch {
        document.getElementById('god-int-shopify').style.background = 'var(--warning)';
      }

      // Netlify - assume online if page loads
      document.getElementById('god-int-netlify').style.background = 'var(--success)';

      // Email - can't easily check
      document.getElementById('god-int-email').style.background = 'var(--warning)';
    }

    function godToggleFeature(feature, enabled) {
      localStorage.setItem(`sg_${feature}`, enabled.toString());
      showToast(`${feature} ${enabled ? 'enabled' : 'disabled'}`, 'success');

      if (feature === 'maintenance' && enabled) {
        document.body.classList.add('maintenance-mode');
      } else if (feature === 'maintenance') {
        document.body.classList.remove('maintenance-mode');
      }

      if (feature === 'debug') {
        console.log('Debug mode:', enabled);
      }
    }

    function godPurgeAllData() {
      if (!confirm('⚠️ This will clear ALL local data including saved preferences. Continue?')) return;
      if (!confirm('Are you absolutely sure? This cannot be undone.')) return;

      localStorage.clear();
      sessionStorage.clear();

      // Clear IndexedDB if exists
      if (window.indexedDB) {
        indexedDB.databases().then(dbs => {
          dbs.forEach(db => indexedDB.deleteDatabase(db.name));
        }).catch(() => {});
      }

      showToast('All local data purged. Reloading...', 'success');
      setTimeout(() => location.reload(), 1500);
    }

    function godResetAnalytics() {
      if (!confirm('Reset all local analytics data?')) return;

      // Clear analytics-related localStorage
      Object.keys(localStorage).forEach(key => {
        if (key.includes('analytics') || key.includes('tracking') || key.includes('engagement')) {
          localStorage.removeItem(key);
        }
      });

      showToast('Local analytics reset', 'success');
    }

    // Hook GOD MODE page initialization into showPage
    const originalShowPageForGod = showPage;
    showPage = function(pageId) {
      originalShowPageForGod(pageId);
      if (pageId.startsWith('god-')) {
        initGodModePage(pageId);
      }
    };

    // GOD MODE Designs Management
    let godDesignsPage = 0;
    const godDesignsPageSize = 50;
    let godDesignsSearchTimeout = null;

    async function godLoadDesigns() {
      if (!isGodMode()) return;
      try {
        const searchTerm = document.getElementById('god-designs-search')?.value?.trim().toLowerCase() || '';
        const typeFilter = document.getElementById('god-designs-type-filter')?.value || 'all';
        const statusFilter = document.getElementById('god-designs-status-filter')?.value || 'all';

        // Build query - join with sg_users to get creator info
        let query = supabaseClient
          .from('room_designs')
          .select('*, sg_users(email, full_name)', { count: 'exact' });

        // Apply room type filter
        if (typeFilter !== 'all') {
          query = query.eq('room_type', typeFilter);
        }

        // Apply status filter
        if (statusFilter === 'shared') {
          query = query.not('share_token', 'is', null);
        } else if (statusFilter === 'private') {
          query = query.is('share_token', null);
        }

        // Apply search filter
        if (searchTerm) {
          query = query.or(`name.ilike.%${searchTerm}%,project_name.ilike.%${searchTerm}%`);
        }

        const { data, error, count } = await query
          .order('created_at', { ascending: false })
          .range(godDesignsPage * godDesignsPageSize, (godDesignsPage + 1) * godDesignsPageSize - 1);

        if (error) throw error;

        // Update summary stats
        await godUpdateDesignStats();

        // Update count text
        const total = count || 0;
        document.getElementById('god-designs-count').textContent =
          `Showing ${data?.length || 0} of ${total} designs`;

        // Render table
        godRenderDesignsTable(data || []);

        // Update pagination buttons
        document.getElementById('god-designs-prev').disabled = godDesignsPage === 0;
        document.getElementById('god-designs-next').disabled = (godDesignsPage + 1) * godDesignsPageSize >= total;

      } catch (error) {
        console.error('Error loading designs:', error);
        document.getElementById('god-designs-table-body').innerHTML =
          '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--error);">Error loading designs</td></tr>';
      }
    }

    async function godUpdateDesignStats() {
      try {
        // Total designs
        const { count: totalCount } = await supabaseClient
          .from('room_designs')
          .select('*', { count: 'exact', head: true });

        // Shared designs (have share_token)
        const { count: sharedCount } = await supabaseClient
          .from('room_designs')
          .select('*', { count: 'exact', head: true })
          .not('share_token', 'is', null);

        // Unique users
        const { data: usersData } = await supabaseClient
          .from('room_designs')
          .select('user_id');

        const uniqueUsers = new Set((usersData || []).map(d => d.user_id)).size;

        document.getElementById('god-designs-total').textContent = totalCount || 0;
        document.getElementById('god-designs-shared').textContent = sharedCount || 0;
        document.getElementById('god-designs-private').textContent = (totalCount || 0) - (sharedCount || 0);
        document.getElementById('god-designs-users').textContent = uniqueUsers;
      } catch (err) {
        console.error('Error updating design stats:', err);
      }
    }

    function godRenderDesignsTable(designs) {
      const tbody = document.getElementById('god-designs-table-body');
      if (!designs || designs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);">No designs found</td></tr>';
        return;
      }

      const roomTypeColors = {
        'kitchen': '#3b82f6',
        'bathroom': '#14b8a6',
        'laundry': '#a855f7',
        'outdoor': '#f59e0b',
        'other': '#6b7280'
      };

      tbody.innerHTML = designs.map(d => {
        const name = escapeHtml(d.name || d.project_name || 'Untitled Design');
        const creatorEmail = escapeHtml(d.sg_users?.email || 'Unknown');
        const creatorName = escapeHtml(d.sg_users?.full_name || '');
        const roomType = (d.room_type || 'other').toLowerCase();
        const roomColor = roomTypeColors[roomType] || roomTypeColors['other'];
        const elementsCount = Array.isArray(d.elements) ? d.elements.length : 0;
        const quoteTotal = d.quote_total != null ? `$${parseFloat(d.quote_total).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : '—';
        const isShared = !!d.share_token;
        const createdDate = d.created_at ? new Date(d.created_at).toLocaleDateString() : '—';
        const designLink = d.share_token
          ? `/tools/room-designer/?p=${d.share_token}`
          : `/tools/room-designer/?id=${d.id}`;

        return `
          <tr style="border-bottom: 1px solid var(--border-subtle);">
            <td style="padding: 12px 16px;">
              <div style="font-weight: 500;">${name}</div>
              <div style="font-size: 12px; color: var(--text-muted);">ID: ${escapeHtml(String(d.id).substring(0, 8))}...</div>
            </td>
            <td style="padding: 12px 16px;">
              <div style="font-size: 13px;">${creatorName || creatorEmail}</div>
              ${creatorName ? `<div style="font-size: 12px; color: var(--text-muted);">${creatorEmail}</div>` : ''}
            </td>
            <td style="padding: 12px 16px;">
              <span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${roomColor}22; color: ${roomColor};">${escapeHtml(roomType.charAt(0).toUpperCase() + roomType.slice(1))}</span>
            </td>
            <td style="padding: 12px 16px; font-size: 13px; text-align: center;">${elementsCount}</td>
            <td style="padding: 12px 16px; font-size: 13px; font-weight: 500;">${quoteTotal}</td>
            <td style="padding: 12px 16px;">
              ${isShared
                ? '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; background: rgba(34,197,94,0.15); color: var(--success);">Shared</span>'
                : '<span style="display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; background: rgba(107,114,128,0.15); color: var(--text-muted);">Private</span>'}
            </td>
            <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${createdDate}</td>
            <td style="padding: 12px 16px; text-align: center;">
              <div style="display: flex; gap: 6px; justify-content: center;">
                <a href="${designLink}" target="_blank" class="btn-modern secondary" style="padding: 6px 10px; font-size: 12px;" title="Open design">Open</a>
                <button class="btn-modern secondary" onclick="godCopyDesignLink('${escapeHtml(d.share_token || '')}', '${escapeHtml(String(d.id))}')" style="padding: 6px 10px; font-size: 12px;" title="Copy link">Link</button>
                <button class="btn-modern secondary" onclick="godDeleteDesign('${escapeHtml(String(d.id))}', '${name.replace(/'/g, "\\'")}')" style="padding: 6px 10px; font-size: 12px; color: var(--error);" title="Delete design">Del</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    function godSearchDesigns() {
      clearTimeout(godDesignsSearchTimeout);
      godDesignsSearchTimeout = setTimeout(() => {
        godDesignsPage = 0;
        godLoadDesigns();
      }, 300);
    }

    function godFilterDesignsType() {
      godDesignsPage = 0;
      godLoadDesigns();
    }

    function godFilterDesignsStatus() {
      godDesignsPage = 0;
      godLoadDesigns();
    }

    function godDesignsPagePrev() {
      if (godDesignsPage > 0) {
        godDesignsPage--;
        godLoadDesigns();
      }
    }

    function godDesignsPageNext() {
      godDesignsPage++;
      godLoadDesigns();
    }

    async function godDeleteDesign(id, name) {
      if (!isGodMode()) return;
      if (!confirm(`Delete design "${name}"?\n\nThis action cannot be undone.`)) return;

      try {
        const { error } = await supabaseClient
          .from('room_designs')
          .delete()
          .eq('id', id);

        if (error) throw error;

        showToast('Design deleted successfully', 'success');
        godLoadDesigns();
      } catch (err) {
        console.error('Error deleting design:', err);
        showToast('Error deleting design: ' + err.message, 'error');
      }
    }

    function godCopyDesignLink(token, id) {
      const baseUrl = window.location.origin;
      const url = token
        ? `${baseUrl}/tools/room-designer/?p=${token}`
        : `${baseUrl}/tools/room-designer/?id=${id}`;

      navigator.clipboard.writeText(url).then(() => {
        showToast('Design link copied to clipboard', 'success');
      }).catch(() => {
        // Fallback
        const input = document.createElement('input');
        input.value = url;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        showToast('Design link copied to clipboard', 'success');
      });
    }

    function godExportDesigns() {
      if (!isGodMode()) return;
      showToast('Exporting designs...', 'info');

      supabaseClient
        .from('room_designs')
        .select('*, sg_users(email, full_name)')
        .order('created_at', { ascending: false })
        .then(({ data, error }) => {
          if (error) {
            showToast('Export failed: ' + error.message, 'error');
            return;
          }
          if (!data || data.length === 0) {
            showToast('No designs to export', 'warning');
            return;
          }

          const headers = ['ID', 'Name', 'Creator Email', 'Creator Name', 'Room Type', 'Elements Count', 'Quote Total', 'Status', 'Share Token', 'Created At', 'Updated At'];
          const rows = data.map(d => [
            d.id,
            d.name || d.project_name || '',
            d.sg_users?.email || '',
            d.sg_users?.full_name || '',
            d.room_type || '',
            Array.isArray(d.elements) ? d.elements.length : 0,
            d.quote_total != null ? d.quote_total : '',
            d.share_token ? 'Shared' : 'Private',
            d.share_token || '',
            d.created_at || '',
            d.updated_at || ''
          ]);

          const csv = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `all-designs-${new Date().toISOString().split('T')[0]}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          showToast('Designs exported successfully', 'success');
        });
    }

    // ==================== END GOD MODE FUNCTIONS ====================

